{"remainingRequest":"/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/thread-loader/dist/cjs.js!/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/babel-loader/lib/index.js!/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/vue-plyr/dist/vue-plyr.esm.js","dependencies":[{"path":"/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/vue-plyr/dist/vue-plyr.esm.js","mtime":1604384632000},{"path":"/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/babel-loader/lib/index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:aW1wb3J0IF90eXBlb2YgZnJvbSAiL21lZGlhL2VybnN0LzYzYmNlNDNjLTVlNTEtNGJmMS1hNjExLTNhZmRmMzJhYzZmNi9WdWVKUy9JUFRWLVRvb2xzL25vZGVfbW9kdWxlcy9AYmFiZWwvcnVudGltZS9oZWxwZXJzL2VzbS90eXBlb2YiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5nbG9iYWwtdGhpcy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC50by1zdHJpbmcuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5yZWdleHAudG8tc3RyaW5nLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuZnVuY3Rpb24ubmFtZS5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5leGVjLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLm1hdGNoLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmdldC1vd24tcHJvcGVydHktZGVzY3JpcHRvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNsaWNlLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnNwbGl0LmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuam9pbi5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmNvbmNhdC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC5nZXQtb3duLXByb3BlcnR5LW5hbWVzLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3ltYm9sLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnJlcGxhY2UuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zeW1ib2wuZGVzY3JpcHRpb24uanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zeW1ib2wuaXRlcmF0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuaXRlcmF0b3IuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLml0ZXJhdG9yLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmtleXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLmZvci1lYWNoLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZmlsdGVyLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmdldC1vd24tcHJvcGVydHktZGVzY3JpcHRvcnMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5maW5kLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuZmluZC1pbmRleC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZyb20uanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5pbmNsdWRlcy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5pbmNsdWRlcy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5Lm1hcC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm1hdGguc2lnbi5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5jb25zdHJ1Y3Rvci5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy50cmltLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnJlcGVhdC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm51bWJlci50by1maXhlZC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5mbGFncy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC5nZXQtcHJvdG90eXBlLW9mLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmlzLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnN0YXJ0cy13aXRoLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LmlzLWV4dGVuc2libGUuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QucHJldmVudC1leHRlbnNpb25zLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc3BsaWNlLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvd2ViLnVybC5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LnNvcnQuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuc2VhcmNoLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMubnVtYmVyLmNvbnN0cnVjdG9yLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMubnVtYmVyLmlzLW5hbi5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC5lbnRyaWVzLmpzIjsKaW1wb3J0ICJjb3JlLWpzL21vZHVsZXMvZXMubWF0aC50cnVuYy5qcyI7CmltcG9ydCAiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC52YWx1ZXMuanMiOwppbXBvcnQgImNvcmUtanMvbW9kdWxlcy9lcy53ZWFrLW1hcC5qcyI7Cgp2YXIgZSA9IGZ1bmN0aW9uIGUoX2UyKSB7CiAgdHJ5IHsKICAgIHJldHVybiAhIV9lMigpOwogIH0gY2F0Y2ggKGUpIHsKICAgIHJldHVybiAhMDsKICB9Cn0sCiAgICB0ID0gIWUoZnVuY3Rpb24gKCkgewogIHJldHVybiA3ICE9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh7fSwgMSwgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiA3OwogICAgfQogIH0pWzFdOwp9KSwKICAgIG4gPSAidW5kZWZpbmVkIiAhPSB0eXBlb2YgZ2xvYmFsVGhpcyA/IGdsb2JhbFRoaXMgOiAidW5kZWZpbmVkIiAhPSB0eXBlb2Ygd2luZG93ID8gd2luZG93IDogInVuZGVmaW5lZCIgIT0gdHlwZW9mIGdsb2JhbCA/IGdsb2JhbCA6ICJ1bmRlZmluZWQiICE9IHR5cGVvZiBzZWxmID8gc2VsZiA6IHt9OwoKZnVuY3Rpb24gaShlLCB0LCBuKSB7CiAgcmV0dXJuIGUobiA9IHsKICAgIHBhdGg6IHQsCiAgICBleHBvcnRzOiB7fSwKICAgIHJlcXVpcmU6IGZ1bmN0aW9uIHJlcXVpcmUoZSwgdCkgewogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiRHluYW1pYyByZXF1aXJlcyBhcmUgbm90IGN1cnJlbnRseSBzdXBwb3J0ZWQgYnkgQHJvbGx1cC9wbHVnaW4tY29tbW9uanMiKTsKICAgICAgfShudWxsID09IHQgJiYgbi5wYXRoKTsKICAgIH0KICB9LCBuLmV4cG9ydHMpLCBuLmV4cG9ydHM7Cn0KCnZhciByID0gZnVuY3Rpb24gcihlKSB7CiAgcmV0dXJuIGUgJiYgZS5NYXRoID09IE1hdGggJiYgZTsKfSwKICAgIGEgPSByKCJvYmplY3QiID09ICh0eXBlb2YgZ2xvYmFsVGhpcyA9PT0gInVuZGVmaW5lZCIgPyAidW5kZWZpbmVkIiA6IF90eXBlb2YoZ2xvYmFsVGhpcykpICYmIGdsb2JhbFRoaXMpIHx8IHIoIm9iamVjdCIgPT0gKHR5cGVvZiB3aW5kb3cgPT09ICJ1bmRlZmluZWQiID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKHdpbmRvdykpICYmIHdpbmRvdykgfHwgcigib2JqZWN0IiA9PSAodHlwZW9mIHNlbGYgPT09ICJ1bmRlZmluZWQiID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKHNlbGYpKSAmJiBzZWxmKSB8fCByKCJvYmplY3QiID09IF90eXBlb2YobikgJiYgbikgfHwgRnVuY3Rpb24oInJldHVybiB0aGlzIikoKSwKICAgIG8gPSBmdW5jdGlvbiBvKGUpIHsKICByZXR1cm4gIm9iamVjdCIgPT0gX3R5cGVvZihlKSA/IG51bGwgIT09IGUgOiAiZnVuY3Rpb24iID09IHR5cGVvZiBlOwp9LAogICAgcyA9IGEuZG9jdW1lbnQsCiAgICBsID0gbyhzKSAmJiBvKHMuY3JlYXRlRWxlbWVudCksCiAgICBjID0gZnVuY3Rpb24gYyhlKSB7CiAgcmV0dXJuIGwgPyBzLmNyZWF0ZUVsZW1lbnQoZSkgOiB7fTsKfSwKICAgIHUgPSAhdCAmJiAhZShmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIDcgIT0gT2JqZWN0LmRlZmluZVByb3BlcnR5KGMoImRpdiIpLCAiYSIsIHsKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gNzsKICAgIH0KICB9KS5hOwp9KSwKICAgIGggPSBmdW5jdGlvbiBoKGUpIHsKICBpZiAoIW8oZSkpIHRocm93IFR5cGVFcnJvcihTdHJpbmcoZSkgKyAiIGlzIG5vdCBhbiBvYmplY3QiKTsKICByZXR1cm4gZTsKfSwKICAgIGQgPSBmdW5jdGlvbiBkKGUsIHQpIHsKICBpZiAoIW8oZSkpIHJldHVybiBlOwogIHZhciBuLCBpOwogIGlmICh0ICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIChuID0gZS50b1N0cmluZykgJiYgIW8oaSA9IG4uY2FsbChlKSkpIHJldHVybiBpOwogIGlmICgiZnVuY3Rpb24iID09IHR5cGVvZiAobiA9IGUudmFsdWVPZikgJiYgIW8oaSA9IG4uY2FsbChlKSkpIHJldHVybiBpOwogIGlmICghdCAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiAobiA9IGUudG9TdHJpbmcpICYmICFvKGkgPSBuLmNhbGwoZSkpKSByZXR1cm4gaTsKICB0aHJvdyBUeXBlRXJyb3IoIkNhbid0IGNvbnZlcnQgb2JqZWN0IHRvIHByaW1pdGl2ZSB2YWx1ZSIpOwp9LAogICAgZiA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSwKICAgIHAgPSB7CiAgZjogdCA/IGYgOiBmdW5jdGlvbiAoZSwgdCwgbikgewogICAgaWYgKGgoZSksIHQgPSBkKHQsICEwKSwgaChuKSwgdSkgdHJ5IHsKICAgICAgcmV0dXJuIGYoZSwgdCwgbik7CiAgICB9IGNhdGNoIChlKSB7fQogICAgaWYgKCJnZXQiIGluIG4gfHwgInNldCIgaW4gbikgdGhyb3cgVHlwZUVycm9yKCJBY2Nlc3NvcnMgbm90IHN1cHBvcnRlZCIpOwogICAgcmV0dXJuICJ2YWx1ZSIgaW4gbiAmJiAoZVt0XSA9IG4udmFsdWUpLCBlOwogIH0KfSwKICAgIG0gPSBwLmYsCiAgICBnID0gRnVuY3Rpb24ucHJvdG90eXBlLAogICAgdiA9IGcudG9TdHJpbmcsCiAgICB5ID0gL15ccypmdW5jdGlvbiAoW14gKF0qKS87Cgp0ICYmICEoIm5hbWUiIGluIGcpICYmIG0oZywgIm5hbWUiLCB7CiAgY29uZmlndXJhYmxlOiAhMCwKICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgIHRyeSB7CiAgICAgIHJldHVybiB2LmNhbGwodGhpcykubWF0Y2goeSlbMV07CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiAiIjsKICAgIH0KICB9Cn0pOwoKdmFyIGIgPSB7fS5wcm9wZXJ0eUlzRW51bWVyYWJsZSwKICAgIHcgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yLAogICAgayA9IHsKICBmOiB3ICYmICFiLmNhbGwoewogICAgMTogMgogIH0sIDEpID8gZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gdyh0aGlzLCBlKTsKICAgIHJldHVybiAhIXQgJiYgdC5lbnVtZXJhYmxlOwogIH0gOiBiCn0sCiAgICBUID0gZnVuY3Rpb24gVChlLCB0KSB7CiAgcmV0dXJuIHsKICAgIGVudW1lcmFibGU6ICEoMSAmIGUpLAogICAgY29uZmlndXJhYmxlOiAhKDIgJiBlKSwKICAgIHdyaXRhYmxlOiAhKDQgJiBlKSwKICAgIHZhbHVlOiB0CiAgfTsKfSwKICAgIFMgPSB7fS50b1N0cmluZywKICAgIEUgPSBmdW5jdGlvbiBFKGUpIHsKICByZXR1cm4gUy5jYWxsKGUpLnNsaWNlKDgsIC0xKTsKfSwKICAgIEEgPSAiIi5zcGxpdCwKICAgIHggPSBlKGZ1bmN0aW9uICgpIHsKICByZXR1cm4gIU9iamVjdCgieiIpLnByb3BlcnR5SXNFbnVtZXJhYmxlKDApOwp9KSA/IGZ1bmN0aW9uIChlKSB7CiAgcmV0dXJuICJTdHJpbmciID09IEUoZSkgPyBBLmNhbGwoZSwgIiIpIDogT2JqZWN0KGUpOwp9IDogT2JqZWN0LAogICAgQyA9IGZ1bmN0aW9uIEMoZSkgewogIGlmIChudWxsID09IGUpIHRocm93IFR5cGVFcnJvcigiQ2FuJ3QgY2FsbCBtZXRob2Qgb24gIiArIGUpOwogIHJldHVybiBlOwp9LAogICAgUCA9IGZ1bmN0aW9uIFAoZSkgewogIHJldHVybiB4KEMoZSkpOwp9LAogICAgTyA9IHt9Lmhhc093blByb3BlcnR5LAogICAgSSA9IGZ1bmN0aW9uIEkoZSwgdCkgewogIHJldHVybiBPLmNhbGwoZSwgdCk7Cn0sCiAgICBMID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvciwKICAgIE4gPSB7CiAgZjogdCA/IEwgOiBmdW5jdGlvbiAoZSwgdCkgewogICAgaWYgKGUgPSBQKGUpLCB0ID0gZCh0LCAhMCksIHUpIHRyeSB7CiAgICAgIHJldHVybiBMKGUsIHQpOwogICAgfSBjYXRjaCAoZSkge30KICAgIGlmIChJKGUsIHQpKSByZXR1cm4gVCghay5mLmNhbGwoZSwgdCksIGVbdF0pOwogIH0KfSwKICAgIE0gPSB0ID8gZnVuY3Rpb24gKGUsIHQsIG4pIHsKICByZXR1cm4gcC5mKGUsIHQsIFQoMSwgbikpOwp9IDogZnVuY3Rpb24gKGUsIHQsIG4pIHsKICByZXR1cm4gZVt0XSA9IG4sIGU7Cn0sCiAgICBqID0gZnVuY3Rpb24gaihlLCB0KSB7CiAgdHJ5IHsKICAgIE0oYSwgZSwgdCk7CiAgfSBjYXRjaCAobikgewogICAgYVtlXSA9IHQ7CiAgfQoKICByZXR1cm4gdDsKfSwKICAgIFIgPSBhWyJfX2NvcmUtanNfc2hhcmVkX18iXSB8fCBqKCJfX2NvcmUtanNfc2hhcmVkX18iLCB7fSksCiAgICBfID0gRnVuY3Rpb24udG9TdHJpbmc7CgoiZnVuY3Rpb24iICE9IHR5cGVvZiBSLmluc3BlY3RTb3VyY2UgJiYgKFIuaW5zcGVjdFNvdXJjZSA9IGZ1bmN0aW9uIChlKSB7CiAgcmV0dXJuIF8uY2FsbChlKTsKfSk7Cgp2YXIgRCwKICAgIEYsCiAgICBxLAogICAgVSA9IFIuaW5zcGVjdFNvdXJjZSwKICAgIEggPSBhLldlYWtNYXAsCiAgICBCID0gImZ1bmN0aW9uIiA9PSB0eXBlb2YgSCAmJiAvbmF0aXZlIGNvZGUvLnRlc3QoVShIKSksCiAgICBWID0gaShmdW5jdGlvbiAoZSkgewogIChlLmV4cG9ydHMgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgcmV0dXJuIFJbZV0gfHwgKFJbZV0gPSB2b2lkIDAgIT09IHQgPyB0IDoge30pOwogIH0pKCJ2ZXJzaW9ucyIsIFtdKS5wdXNoKHsKICAgIHZlcnNpb246ICIzLjYuNSIsCiAgICBtb2RlOiAiZ2xvYmFsIiwKICAgIGNvcHlyaWdodDogIsKpIDIwMjAgRGVuaXMgUHVzaGthcmV2ICh6bG9pcm9jay5ydSkiCiAgfSk7Cn0pLAogICAgeiA9IDAsCiAgICBXID0gTWF0aC5yYW5kb20oKSwKICAgICQgPSBmdW5jdGlvbiAkKGUpIHsKICByZXR1cm4gIlN5bWJvbCgiICsgU3RyaW5nKHZvaWQgMCA9PT0gZSA/ICIiIDogZSkgKyAiKV8iICsgKCsreiArIFcpLnRvU3RyaW5nKDM2KTsKfSwKICAgIEsgPSBWKCJrZXlzIiksCiAgICBZID0gZnVuY3Rpb24gWShlKSB7CiAgcmV0dXJuIEtbZV0gfHwgKEtbZV0gPSAkKGUpKTsKfSwKICAgIEcgPSB7fSwKICAgIFggPSBhLldlYWtNYXA7CgppZiAoQikgewogIHZhciBRID0gbmV3IFgoKSwKICAgICAgSiA9IFEuZ2V0LAogICAgICBaID0gUS5oYXMsCiAgICAgIGVlID0gUS5zZXQ7CiAgRCA9IGZ1bmN0aW9uIEQoZSwgdCkgewogICAgcmV0dXJuIGVlLmNhbGwoUSwgZSwgdCksIHQ7CiAgfSwgRiA9IGZ1bmN0aW9uIEYoZSkgewogICAgcmV0dXJuIEouY2FsbChRLCBlKSB8fCB7fTsKICB9LCBxID0gZnVuY3Rpb24gcShlKSB7CiAgICByZXR1cm4gWi5jYWxsKFEsIGUpOwogIH07Cn0gZWxzZSB7CiAgdmFyIHRlID0gWSgic3RhdGUiKTsKICBHW3RlXSA9ICEwLCBEID0gZnVuY3Rpb24gRChlLCB0KSB7CiAgICByZXR1cm4gTShlLCB0ZSwgdCksIHQ7CiAgfSwgRiA9IGZ1bmN0aW9uIEYoZSkgewogICAgcmV0dXJuIEkoZSwgdGUpID8gZVt0ZV0gOiB7fTsKICB9LCBxID0gZnVuY3Rpb24gcShlKSB7CiAgICByZXR1cm4gSShlLCB0ZSk7CiAgfTsKfQoKdmFyIG5lLAogICAgaWUgPSB7CiAgc2V0OiBELAogIGdldDogRiwKICBoYXM6IHEsCiAgZW5mb3JjZTogZnVuY3Rpb24gZW5mb3JjZShlKSB7CiAgICByZXR1cm4gcShlKSA/IEYoZSkgOiBEKGUsIHt9KTsKICB9LAogIGdldHRlckZvcjogZnVuY3Rpb24gZ2V0dGVyRm9yKGUpIHsKICAgIHJldHVybiBmdW5jdGlvbiAodCkgewogICAgICB2YXIgbjsKICAgICAgaWYgKCFvKHQpIHx8IChuID0gRih0KSkudHlwZSAhPT0gZSkgdGhyb3cgVHlwZUVycm9yKCJJbmNvbXBhdGlibGUgcmVjZWl2ZXIsICIgKyBlICsgIiByZXF1aXJlZCIpOwogICAgICByZXR1cm4gbjsKICAgIH07CiAgfQp9LAogICAgcmUgPSBpKGZ1bmN0aW9uIChlKSB7CiAgdmFyIHQgPSBpZS5nZXQsCiAgICAgIG4gPSBpZS5lbmZvcmNlLAogICAgICBpID0gU3RyaW5nKFN0cmluZykuc3BsaXQoIlN0cmluZyIpOwogIChlLmV4cG9ydHMgPSBmdW5jdGlvbiAoZSwgdCwgciwgbykgewogICAgdmFyIHMgPSAhIW8gJiYgISFvLnVuc2FmZSwKICAgICAgICBsID0gISFvICYmICEhby5lbnVtZXJhYmxlLAogICAgICAgIGMgPSAhIW8gJiYgISFvLm5vVGFyZ2V0R2V0OwogICAgImZ1bmN0aW9uIiA9PSB0eXBlb2YgciAmJiAoInN0cmluZyIgIT0gdHlwZW9mIHQgfHwgSShyLCAibmFtZSIpIHx8IE0ociwgIm5hbWUiLCB0KSwgbihyKS5zb3VyY2UgPSBpLmpvaW4oInN0cmluZyIgPT0gdHlwZW9mIHQgPyB0IDogIiIpKSwgZSAhPT0gYSA/IChzID8gIWMgJiYgZVt0XSAmJiAobCA9ICEwKSA6IGRlbGV0ZSBlW3RdLCBsID8gZVt0XSA9IHIgOiBNKGUsIHQsIHIpKSA6IGwgPyBlW3RdID0gciA6IGoodCwgcik7CiAgfSkoRnVuY3Rpb24ucHJvdG90eXBlLCAidG9TdHJpbmciLCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gImZ1bmN0aW9uIiA9PSB0eXBlb2YgdGhpcyAmJiB0KHRoaXMpLnNvdXJjZSB8fCBVKHRoaXMpOwogIH0pOwp9KSwKICAgIGFlID0gYSwKICAgIG9lID0gZnVuY3Rpb24gb2UoZSkgewogIHJldHVybiAiZnVuY3Rpb24iID09IHR5cGVvZiBlID8gZSA6IHZvaWQgMDsKfSwKICAgIHNlID0gZnVuY3Rpb24gc2UoZSwgdCkgewogIHJldHVybiBhcmd1bWVudHMubGVuZ3RoIDwgMiA/IG9lKGFlW2VdKSB8fCBvZShhW2VdKSA6IGFlW2VdICYmIGFlW2VdW3RdIHx8IGFbZV0gJiYgYVtlXVt0XTsKfSwKICAgIGxlID0gTWF0aC5jZWlsLAogICAgY2UgPSBNYXRoLmZsb29yLAogICAgdWUgPSBmdW5jdGlvbiB1ZShlKSB7CiAgcmV0dXJuIGlzTmFOKGUgPSArZSkgPyAwIDogKGUgPiAwID8gY2UgOiBsZSkoZSk7Cn0sCiAgICBoZSA9IE1hdGgubWluLAogICAgZGUgPSBmdW5jdGlvbiBkZShlKSB7CiAgcmV0dXJuIGUgPiAwID8gaGUodWUoZSksIDkwMDcxOTkyNTQ3NDA5OTEpIDogMDsKfSwKICAgIGZlID0gTWF0aC5tYXgsCiAgICBwZSA9IE1hdGgubWluLAogICAgbWUgPSBmdW5jdGlvbiBtZShlLCB0KSB7CiAgdmFyIG4gPSB1ZShlKTsKICByZXR1cm4gbiA8IDAgPyBmZShuICsgdCwgMCkgOiBwZShuLCB0KTsKfSwKICAgIGdlID0gZnVuY3Rpb24gZ2UoZSkgewogIHJldHVybiBmdW5jdGlvbiAodCwgbiwgaSkgewogICAgdmFyIHIsCiAgICAgICAgYSA9IFAodCksCiAgICAgICAgbyA9IGRlKGEubGVuZ3RoKSwKICAgICAgICBzID0gbWUoaSwgbyk7CgogICAgaWYgKGUgJiYgbiAhPSBuKSB7CiAgICAgIGZvciAoOyBvID4gczspIHsKICAgICAgICBpZiAoKHIgPSBhW3MrK10pICE9IHIpIHJldHVybiAhMDsKICAgICAgfQogICAgfSBlbHNlIGZvciAoOyBvID4gczsgcysrKSB7CiAgICAgIGlmICgoZSB8fCBzIGluIGEpICYmIGFbc10gPT09IG4pIHJldHVybiBlIHx8IHMgfHwgMDsKICAgIH0KCiAgICByZXR1cm4gIWUgJiYgLTE7CiAgfTsKfSwKICAgIHZlID0gewogIGluY2x1ZGVzOiBnZSghMCksCiAgaW5kZXhPZjogZ2UoITEpCn0sCiAgICB5ZSA9IHZlLmluZGV4T2YsCiAgICBiZSA9IGZ1bmN0aW9uIGJlKGUsIHQpIHsKICB2YXIgbiwKICAgICAgaSA9IFAoZSksCiAgICAgIHIgPSAwLAogICAgICBhID0gW107CgogIGZvciAobiBpbiBpKSB7CiAgICAhSShHLCBuKSAmJiBJKGksIG4pICYmIGEucHVzaChuKTsKICB9CgogIGZvciAoOyB0Lmxlbmd0aCA+IHI7KSB7CiAgICBJKGksIG4gPSB0W3IrK10pICYmICh+eWUoYSwgbikgfHwgYS5wdXNoKG4pKTsKICB9CgogIHJldHVybiBhOwp9LAogICAgd2UgPSBbImNvbnN0cnVjdG9yIiwgImhhc093blByb3BlcnR5IiwgImlzUHJvdG90eXBlT2YiLCAicHJvcGVydHlJc0VudW1lcmFibGUiLCAidG9Mb2NhbGVTdHJpbmciLCAidG9TdHJpbmciLCAidmFsdWVPZiJdLAogICAga2UgPSB3ZS5jb25jYXQoImxlbmd0aCIsICJwcm90b3R5cGUiKSwKICAgIFRlID0gewogIGY6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzIHx8IGZ1bmN0aW9uIChlKSB7CiAgICByZXR1cm4gYmUoZSwga2UpOwogIH0KfSwKICAgIFNlID0gewogIGY6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMKfSwKICAgIEVlID0gc2UoIlJlZmxlY3QiLCAib3duS2V5cyIpIHx8IGZ1bmN0aW9uIChlKSB7CiAgdmFyIHQgPSBUZS5mKGgoZSkpLAogICAgICBuID0gU2UuZjsKICByZXR1cm4gbiA/IHQuY29uY2F0KG4oZSkpIDogdDsKfSwKICAgIEFlID0gZnVuY3Rpb24gQWUoZSwgdCkgewogIGZvciAodmFyIG4gPSBFZSh0KSwgaSA9IHAuZiwgciA9IE4uZiwgYSA9IDA7IGEgPCBuLmxlbmd0aDsgYSsrKSB7CiAgICB2YXIgbyA9IG5bYV07CiAgICBJKGUsIG8pIHx8IGkoZSwgbywgcih0LCBvKSk7CiAgfQp9LAogICAgeGUgPSAvI3xcLnByb3RvdHlwZVwuLywKICAgIENlID0gZnVuY3Rpb24gQ2UodCwgbikgewogIHZhciBpID0gT2VbUGUodCldOwogIHJldHVybiBpID09IExlIHx8IGkgIT0gSWUgJiYgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIG4gPyBlKG4pIDogISFuKTsKfSwKICAgIFBlID0gQ2Uubm9ybWFsaXplID0gZnVuY3Rpb24gKGUpIHsKICByZXR1cm4gU3RyaW5nKGUpLnJlcGxhY2UoeGUsICIuIikudG9Mb3dlckNhc2UoKTsKfSwKICAgIE9lID0gQ2UuZGF0YSA9IHt9LAogICAgSWUgPSBDZS5OQVRJVkUgPSAiTiIsCiAgICBMZSA9IENlLlBPTFlGSUxMID0gIlAiLAogICAgTmUgPSBDZSwKICAgIE1lID0gTi5mLAogICAgamUgPSBmdW5jdGlvbiBqZShlLCB0KSB7CiAgdmFyIG4sCiAgICAgIGksCiAgICAgIHIsCiAgICAgIG8sCiAgICAgIHMsCiAgICAgIGwgPSBlLnRhcmdldCwKICAgICAgYyA9IGUuZ2xvYmFsLAogICAgICB1ID0gZS5zdGF0OwogIGlmIChuID0gYyA/IGEgOiB1ID8gYVtsXSB8fCBqKGwsIHt9KSA6IChhW2xdIHx8IHt9KS5wcm90b3R5cGUpIGZvciAoaSBpbiB0KSB7CiAgICBpZiAobyA9IHRbaV0sIHIgPSBlLm5vVGFyZ2V0R2V0ID8gKHMgPSBNZShuLCBpKSkgJiYgcy52YWx1ZSA6IG5baV0sICFOZShjID8gaSA6IGwgKyAodSA/ICIuIiA6ICIjIikgKyBpLCBlLmZvcmNlZCkgJiYgdm9pZCAwICE9PSByKSB7CiAgICAgIGlmIChfdHlwZW9mKG8pID09IF90eXBlb2YocikpIGNvbnRpbnVlOwogICAgICBBZShvLCByKTsKICAgIH0KCiAgICAoZS5zaGFtIHx8IHIgJiYgci5zaGFtKSAmJiBNKG8sICJzaGFtIiwgITApLCByZShuLCBpLCBvLCBlKTsKICB9Cn0sCiAgICBSZSA9ICEhT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyAmJiAhZShmdW5jdGlvbiAoKSB7CiAgcmV0dXJuICFTdHJpbmcoU3ltYm9sKCkpOwp9KSwKICAgIF9lID0gUmUgJiYgIVN5bWJvbC5zaGFtICYmICJzeW1ib2wiID09IF90eXBlb2YoU3ltYm9sLml0ZXJhdG9yKSwKICAgIERlID0gQXJyYXkuaXNBcnJheSB8fCBmdW5jdGlvbiAoZSkgewogIHJldHVybiAiQXJyYXkiID09IEUoZSk7Cn0sCiAgICBGZSA9IGZ1bmN0aW9uIEZlKGUpIHsKICByZXR1cm4gT2JqZWN0KEMoZSkpOwp9LAogICAgcWUgPSBPYmplY3Qua2V5cyB8fCBmdW5jdGlvbiAoZSkgewogIHJldHVybiBiZShlLCB3ZSk7Cn0sCiAgICBVZSA9IHQgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyA6IGZ1bmN0aW9uIChlLCB0KSB7CiAgaChlKTsKCiAgZm9yICh2YXIgbiwgaSA9IHFlKHQpLCByID0gaS5sZW5ndGgsIGEgPSAwOyByID4gYTspIHsKICAgIHAuZihlLCBuID0gaVthKytdLCB0W25dKTsKICB9CgogIHJldHVybiBlOwp9LAogICAgSGUgPSBzZSgiZG9jdW1lbnQiLCAiZG9jdW1lbnRFbGVtZW50IiksCiAgICBCZSA9IFkoIklFX1BST1RPIiksCiAgICBWZSA9IGZ1bmN0aW9uIFZlKCkge30sCiAgICB6ZSA9IGZ1bmN0aW9uIHplKGUpIHsKICByZXR1cm4gIjxzY3JpcHQ+IiArIGUgKyAiPFwvc2NyaXB0PiI7Cn0sCiAgICBfV2UgPSBmdW5jdGlvbiBXZSgpIHsKICB0cnkgewogICAgbmUgPSBkb2N1bWVudC5kb21haW4gJiYgbmV3IEFjdGl2ZVhPYmplY3QoImh0bWxmaWxlIik7CiAgfSBjYXRjaCAoZSkge30KCiAgdmFyIGUsIHQ7CiAgX1dlID0gbmUgPyBmdW5jdGlvbiAoZSkgewogICAgZS53cml0ZSh6ZSgiIikpLCBlLmNsb3NlKCk7CiAgICB2YXIgdCA9IGUucGFyZW50V2luZG93Lk9iamVjdDsKICAgIHJldHVybiBlID0gbnVsbCwgdDsKICB9KG5lKSA6ICgodCA9IGMoImlmcmFtZSIpKS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiLCBIZS5hcHBlbmRDaGlsZCh0KSwgdC5zcmMgPSBTdHJpbmcoImphdmFzY3JpcHQ6IiksIChlID0gdC5jb250ZW50V2luZG93LmRvY3VtZW50KS5vcGVuKCksIGUud3JpdGUoemUoImRvY3VtZW50LkY9T2JqZWN0IikpLCBlLmNsb3NlKCksIGUuRik7CgogIGZvciAodmFyIG4gPSB3ZS5sZW5ndGg7IG4tLTspIHsKICAgIGRlbGV0ZSBfV2UucHJvdG90eXBlW3dlW25dXTsKICB9CgogIHJldHVybiBfV2UoKTsKfTsKCkdbQmVdID0gITA7Cgp2YXIgJGUgPSBPYmplY3QuY3JlYXRlIHx8IGZ1bmN0aW9uIChlLCB0KSB7CiAgdmFyIG47CiAgcmV0dXJuIG51bGwgIT09IGUgPyAoVmUucHJvdG90eXBlID0gaChlKSwgbiA9IG5ldyBWZSgpLCBWZS5wcm90b3R5cGUgPSBudWxsLCBuW0JlXSA9IGUpIDogbiA9IF9XZSgpLCB2b2lkIDAgPT09IHQgPyBuIDogVWUobiwgdCk7Cn0sCiAgICBLZSA9IFRlLmYsCiAgICBZZSA9IHt9LnRvU3RyaW5nLAogICAgR2UgPSAib2JqZWN0IiA9PSAodHlwZW9mIHdpbmRvdyA9PT0gInVuZGVmaW5lZCIgPyAidW5kZWZpbmVkIiA6IF90eXBlb2Yod2luZG93KSkgJiYgd2luZG93ICYmIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzID8gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMod2luZG93KSA6IFtdLAogICAgWGUgPSB7CiAgZjogZnVuY3Rpb24gZihlKSB7CiAgICByZXR1cm4gR2UgJiYgIltvYmplY3QgV2luZG93XSIgPT0gWWUuY2FsbChlKSA/IGZ1bmN0aW9uIChlKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIEtlKGUpOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuIEdlLnNsaWNlKCk7CiAgICAgIH0KICAgIH0oZSkgOiBLZShQKGUpKTsKICB9Cn0sCiAgICBRZSA9IFYoIndrcyIpLAogICAgSmUgPSBhLlN5bWJvbCwKICAgIFplID0gX2UgPyBKZSA6IEplICYmIEplLndpdGhvdXRTZXR0ZXIgfHwgJCwKICAgIGV0ID0gZnVuY3Rpb24gZXQoZSkgewogIHJldHVybiBJKFFlLCBlKSB8fCAoUmUgJiYgSShKZSwgZSkgPyBRZVtlXSA9IEplW2VdIDogUWVbZV0gPSBaZSgiU3ltYm9sLiIgKyBlKSksIFFlW2VdOwp9LAogICAgdHQgPSB7CiAgZjogZXQKfSwKICAgIG50ID0gcC5mLAogICAgaXQgPSBmdW5jdGlvbiBpdChlKSB7CiAgdmFyIHQgPSBhZS5TeW1ib2wgfHwgKGFlLlN5bWJvbCA9IHt9KTsKICBJKHQsIGUpIHx8IG50KHQsIGUsIHsKICAgIHZhbHVlOiB0dC5mKGUpCiAgfSk7Cn0sCiAgICBydCA9IHAuZiwKICAgIGF0ID0gZXQoInRvU3RyaW5nVGFnIiksCiAgICBvdCA9IGZ1bmN0aW9uIG90KGUsIHQsIG4pIHsKICBlICYmICFJKGUgPSBuID8gZSA6IGUucHJvdG90eXBlLCBhdCkgJiYgcnQoZSwgYXQsIHsKICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICB2YWx1ZTogdAogIH0pOwp9LAogICAgc3QgPSBmdW5jdGlvbiBzdChlKSB7CiAgaWYgKCJmdW5jdGlvbiIgIT0gdHlwZW9mIGUpIHRocm93IFR5cGVFcnJvcihTdHJpbmcoZSkgKyAiIGlzIG5vdCBhIGZ1bmN0aW9uIik7CiAgcmV0dXJuIGU7Cn0sCiAgICBsdCA9IGZ1bmN0aW9uIGx0KGUsIHQsIG4pIHsKICBpZiAoc3QoZSksIHZvaWQgMCA9PT0gdCkgcmV0dXJuIGU7CgogIHN3aXRjaCAobikgewogICAgY2FzZSAwOgogICAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBlLmNhbGwodCk7CiAgICAgIH07CgogICAgY2FzZSAxOgogICAgICByZXR1cm4gZnVuY3Rpb24gKG4pIHsKICAgICAgICByZXR1cm4gZS5jYWxsKHQsIG4pOwogICAgICB9OwoKICAgIGNhc2UgMjoKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChuLCBpKSB7CiAgICAgICAgcmV0dXJuIGUuY2FsbCh0LCBuLCBpKTsKICAgICAgfTsKCiAgICBjYXNlIDM6CiAgICAgIHJldHVybiBmdW5jdGlvbiAobiwgaSwgcikgewogICAgICAgIHJldHVybiBlLmNhbGwodCwgbiwgaSwgcik7CiAgICAgIH07CiAgfQoKICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIGUuYXBwbHkodCwgYXJndW1lbnRzKTsKICB9Owp9LAogICAgY3QgPSBldCgic3BlY2llcyIpLAogICAgdXQgPSBmdW5jdGlvbiB1dChlLCB0KSB7CiAgdmFyIG47CiAgcmV0dXJuIERlKGUpICYmICgiZnVuY3Rpb24iICE9IHR5cGVvZiAobiA9IGUuY29uc3RydWN0b3IpIHx8IG4gIT09IEFycmF5ICYmICFEZShuLnByb3RvdHlwZSkgPyBvKG4pICYmIG51bGwgPT09IChuID0gbltjdF0pICYmIChuID0gdm9pZCAwKSA6IG4gPSB2b2lkIDApLCBuZXcgKHZvaWQgMCA9PT0gbiA/IEFycmF5IDogbikoMCA9PT0gdCA/IDAgOiB0KTsKfSwKICAgIGh0ID0gW10ucHVzaCwKICAgIGR0ID0gZnVuY3Rpb24gZHQoZSkgewogIHZhciB0ID0gMSA9PSBlLAogICAgICBuID0gMiA9PSBlLAogICAgICBpID0gMyA9PSBlLAogICAgICByID0gNCA9PSBlLAogICAgICBhID0gNiA9PSBlLAogICAgICBvID0gNSA9PSBlIHx8IGE7CiAgcmV0dXJuIGZ1bmN0aW9uIChzLCBsLCBjLCB1KSB7CiAgICBmb3IgKHZhciBoLCBkLCBmID0gRmUocyksIHAgPSB4KGYpLCBtID0gbHQobCwgYywgMyksIGcgPSBkZShwLmxlbmd0aCksIHYgPSAwLCB5ID0gdSB8fCB1dCwgYiA9IHQgPyB5KHMsIGcpIDogbiA/IHkocywgMCkgOiB2b2lkIDA7IGcgPiB2OyB2KyspIHsKICAgICAgaWYgKChvIHx8IHYgaW4gcCkgJiYgKGQgPSBtKGggPSBwW3ZdLCB2LCBmKSwgZSkpIGlmICh0KSBiW3ZdID0gZDtlbHNlIGlmIChkKSBzd2l0Y2ggKGUpIHsKICAgICAgICBjYXNlIDM6CiAgICAgICAgICByZXR1cm4gITA7CgogICAgICAgIGNhc2UgNToKICAgICAgICAgIHJldHVybiBoOwoKICAgICAgICBjYXNlIDY6CiAgICAgICAgICByZXR1cm4gdjsKCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgaHQuY2FsbChiLCBoKTsKICAgICAgfSBlbHNlIGlmIChyKSByZXR1cm4gITE7CiAgICB9CgogICAgcmV0dXJuIGEgPyAtMSA6IGkgfHwgciA/IHIgOiBiOwogIH07Cn0sCiAgICBmdCA9IHsKICBmb3JFYWNoOiBkdCgwKSwKICBtYXA6IGR0KDEpLAogIGZpbHRlcjogZHQoMiksCiAgc29tZTogZHQoMyksCiAgZXZlcnk6IGR0KDQpLAogIGZpbmQ6IGR0KDUpLAogIGZpbmRJbmRleDogZHQoNikKfSwKICAgIHB0ID0gZnQuZm9yRWFjaCwKICAgIG10ID0gWSgiaGlkZGVuIiksCiAgICBndCA9IGV0KCJ0b1ByaW1pdGl2ZSIpLAogICAgdnQgPSBpZS5zZXQsCiAgICB5dCA9IGllLmdldHRlckZvcigiU3ltYm9sIiksCiAgICBidCA9IE9iamVjdC5wcm90b3R5cGUsCiAgICBfd3QgPSBhLlN5bWJvbCwKICAgIGt0ID0gc2UoIkpTT04iLCAic3RyaW5naWZ5IiksCiAgICBUdCA9IE4uZiwKICAgIFN0ID0gcC5mLAogICAgRXQgPSBYZS5mLAogICAgQXQgPSBrLmYsCiAgICB4dCA9IFYoInN5bWJvbHMiKSwKICAgIEN0ID0gVigib3Atc3ltYm9scyIpLAogICAgUHQgPSBWKCJzdHJpbmctdG8tc3ltYm9sLXJlZ2lzdHJ5IiksCiAgICBPdCA9IFYoInN5bWJvbC10by1zdHJpbmctcmVnaXN0cnkiKSwKICAgIEl0ID0gVigid2tzIiksCiAgICBMdCA9IGEuUU9iamVjdCwKICAgIE50ID0gIUx0IHx8ICFMdC5wcm90b3R5cGUgfHwgIUx0LnByb3RvdHlwZS5maW5kQ2hpbGQsCiAgICBNdCA9IHQgJiYgZShmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIDcgIT0gJGUoU3Qoe30sICJhIiwgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBTdCh0aGlzLCAiYSIsIHsKICAgICAgICB2YWx1ZTogNwogICAgICB9KS5hOwogICAgfQogIH0pKS5hOwp9KSA/IGZ1bmN0aW9uIChlLCB0LCBuKSB7CiAgdmFyIGkgPSBUdChidCwgdCk7CiAgaSAmJiBkZWxldGUgYnRbdF0sIFN0KGUsIHQsIG4pLCBpICYmIGUgIT09IGJ0ICYmIFN0KGJ0LCB0LCBpKTsKfSA6IFN0LAogICAganQgPSBmdW5jdGlvbiBqdChlLCBuKSB7CiAgdmFyIGkgPSB4dFtlXSA9ICRlKF93dC5wcm90b3R5cGUpOwogIHJldHVybiB2dChpLCB7CiAgICB0eXBlOiAiU3ltYm9sIiwKICAgIHRhZzogZSwKICAgIGRlc2NyaXB0aW9uOiBuCiAgfSksIHQgfHwgKGkuZGVzY3JpcHRpb24gPSBuKSwgaTsKfSwKICAgIFJ0ID0gX2UgPyBmdW5jdGlvbiAoZSkgewogIHJldHVybiAic3ltYm9sIiA9PSBfdHlwZW9mKGUpOwp9IDogZnVuY3Rpb24gKGUpIHsKICByZXR1cm4gT2JqZWN0KGUpIGluc3RhbmNlb2YgX3d0Owp9LAogICAgX3QgPSBmdW5jdGlvbiBfdChlLCB0LCBuKSB7CiAgZSA9PT0gYnQgJiYgX3QoQ3QsIHQsIG4pLCBoKGUpOwogIHZhciBpID0gZCh0LCAhMCk7CiAgcmV0dXJuIGgobiksIEkoeHQsIGkpID8gKG4uZW51bWVyYWJsZSA/IChJKGUsIG10KSAmJiBlW210XVtpXSAmJiAoZVttdF1baV0gPSAhMSksIG4gPSAkZShuLCB7CiAgICBlbnVtZXJhYmxlOiBUKDAsICExKQogIH0pKSA6IChJKGUsIG10KSB8fCBTdChlLCBtdCwgVCgxLCB7fSkpLCBlW210XVtpXSA9ICEwKSwgTXQoZSwgaSwgbikpIDogU3QoZSwgaSwgbik7Cn0sCiAgICBEdCA9IGZ1bmN0aW9uIER0KGUsIG4pIHsKICBoKGUpOwogIHZhciBpID0gUChuKSwKICAgICAgciA9IHFlKGkpLmNvbmNhdChIdChpKSk7CiAgcmV0dXJuIHB0KHIsIGZ1bmN0aW9uIChuKSB7CiAgICB0ICYmICFGdC5jYWxsKGksIG4pIHx8IF90KGUsIG4sIGlbbl0pOwogIH0pLCBlOwp9LAogICAgRnQgPSBmdW5jdGlvbiBGdChlKSB7CiAgdmFyIHQgPSBkKGUsICEwKSwKICAgICAgbiA9IEF0LmNhbGwodGhpcywgdCk7CiAgcmV0dXJuICEodGhpcyA9PT0gYnQgJiYgSSh4dCwgdCkgJiYgIUkoQ3QsIHQpKSAmJiAoIShuIHx8ICFJKHRoaXMsIHQpIHx8ICFJKHh0LCB0KSB8fCBJKHRoaXMsIG10KSAmJiB0aGlzW210XVt0XSkgfHwgbik7Cn0sCiAgICBxdCA9IGZ1bmN0aW9uIHF0KGUsIHQpIHsKICB2YXIgbiA9IFAoZSksCiAgICAgIGkgPSBkKHQsICEwKTsKCiAgaWYgKG4gIT09IGJ0IHx8ICFJKHh0LCBpKSB8fCBJKEN0LCBpKSkgewogICAgdmFyIHIgPSBUdChuLCBpKTsKICAgIHJldHVybiAhciB8fCAhSSh4dCwgaSkgfHwgSShuLCBtdCkgJiYgblttdF1baV0gfHwgKHIuZW51bWVyYWJsZSA9ICEwKSwgcjsKICB9Cn0sCiAgICBVdCA9IGZ1bmN0aW9uIFV0KGUpIHsKICB2YXIgdCA9IEV0KFAoZSkpLAogICAgICBuID0gW107CiAgcmV0dXJuIHB0KHQsIGZ1bmN0aW9uIChlKSB7CiAgICBJKHh0LCBlKSB8fCBJKEcsIGUpIHx8IG4ucHVzaChlKTsKICB9KSwgbjsKfSwKICAgIEh0ID0gZnVuY3Rpb24gSHQoZSkgewogIHZhciB0ID0gZSA9PT0gYnQsCiAgICAgIG4gPSBFdCh0ID8gQ3QgOiBQKGUpKSwKICAgICAgaSA9IFtdOwogIHJldHVybiBwdChuLCBmdW5jdGlvbiAoZSkgewogICAgIUkoeHQsIGUpIHx8IHQgJiYgIUkoYnQsIGUpIHx8IGkucHVzaCh4dFtlXSk7CiAgfSksIGk7Cn07CgppZiAoUmUgfHwgKHJlKChfd3QgPSBmdW5jdGlvbiB3dCgpIHsKICBpZiAodGhpcyBpbnN0YW5jZW9mIF93dCkgdGhyb3cgVHlwZUVycm9yKCJTeW1ib2wgaXMgbm90IGEgY29uc3RydWN0b3IiKTsKCiAgdmFyIGUgPSBhcmd1bWVudHMubGVuZ3RoICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdID8gU3RyaW5nKGFyZ3VtZW50c1swXSkgOiB2b2lkIDAsCiAgICAgIG4gPSAkKGUpLAogICAgICBpID0gZnVuY3Rpb24gaShlKSB7CiAgICB0aGlzID09PSBidCAmJiBpLmNhbGwoQ3QsIGUpLCBJKHRoaXMsIG10KSAmJiBJKHRoaXNbbXRdLCBuKSAmJiAodGhpc1ttdF1bbl0gPSAhMSksIE10KHRoaXMsIG4sIFQoMSwgZSkpOwogIH07CgogIHJldHVybiB0ICYmIE50ICYmIE10KGJ0LCBuLCB7CiAgICBjb25maWd1cmFibGU6ICEwLAogICAgc2V0OiBpCiAgfSksIGp0KG4sIGUpOwp9KS5wcm90b3R5cGUsICJ0b1N0cmluZyIsIGZ1bmN0aW9uICgpIHsKICByZXR1cm4geXQodGhpcykudGFnOwp9KSwgcmUoX3d0LCAid2l0aG91dFNldHRlciIsIGZ1bmN0aW9uIChlKSB7CiAgcmV0dXJuIGp0KCQoZSksIGUpOwp9KSwgay5mID0gRnQsIHAuZiA9IF90LCBOLmYgPSBxdCwgVGUuZiA9IFhlLmYgPSBVdCwgU2UuZiA9IEh0LCB0dC5mID0gZnVuY3Rpb24gKGUpIHsKICByZXR1cm4ganQoZXQoZSksIGUpOwp9LCB0ICYmIChTdChfd3QucHJvdG90eXBlLCAiZGVzY3JpcHRpb24iLCB7CiAgY29uZmlndXJhYmxlOiAhMCwKICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgIHJldHVybiB5dCh0aGlzKS5kZXNjcmlwdGlvbjsKICB9Cn0pLCByZShidCwgInByb3BlcnR5SXNFbnVtZXJhYmxlIiwgRnQsIHsKICB1bnNhZmU6ICEwCn0pKSksIGplKHsKICBnbG9iYWw6ICEwLAogIHdyYXA6ICEwLAogIGZvcmNlZDogIVJlLAogIHNoYW06ICFSZQp9LCB7CiAgU3ltYm9sOiBfd3QKfSksIHB0KHFlKEl0KSwgZnVuY3Rpb24gKGUpIHsKICBpdChlKTsKfSksIGplKHsKICB0YXJnZXQ6ICJTeW1ib2wiLAogIHN0YXQ6ICEwLAogIGZvcmNlZDogIVJlCn0sIHsKICBmb3I6IGZ1bmN0aW9uIF9mb3IoZSkgewogICAgdmFyIHQgPSBTdHJpbmcoZSk7CiAgICBpZiAoSShQdCwgdCkpIHJldHVybiBQdFt0XTsKCiAgICB2YXIgbiA9IF93dCh0KTsKCiAgICByZXR1cm4gUHRbdF0gPSBuLCBPdFtuXSA9IHQsIG47CiAgfSwKICBrZXlGb3I6IGZ1bmN0aW9uIGtleUZvcihlKSB7CiAgICBpZiAoIVJ0KGUpKSB0aHJvdyBUeXBlRXJyb3IoZSArICIgaXMgbm90IGEgc3ltYm9sIik7CiAgICBpZiAoSShPdCwgZSkpIHJldHVybiBPdFtlXTsKICB9LAogIHVzZVNldHRlcjogZnVuY3Rpb24gdXNlU2V0dGVyKCkgewogICAgTnQgPSAhMDsKICB9LAogIHVzZVNpbXBsZTogZnVuY3Rpb24gdXNlU2ltcGxlKCkgewogICAgTnQgPSAhMTsKICB9Cn0pLCBqZSh7CiAgdGFyZ2V0OiAiT2JqZWN0IiwKICBzdGF0OiAhMCwKICBmb3JjZWQ6ICFSZSwKICBzaGFtOiAhdAp9LCB7CiAgY3JlYXRlOiBmdW5jdGlvbiBjcmVhdGUoZSwgdCkgewogICAgcmV0dXJuIHZvaWQgMCA9PT0gdCA/ICRlKGUpIDogRHQoJGUoZSksIHQpOwogIH0sCiAgZGVmaW5lUHJvcGVydHk6IF90LAogIGRlZmluZVByb3BlcnRpZXM6IER0LAogIGdldE93blByb3BlcnR5RGVzY3JpcHRvcjogcXQKfSksIGplKHsKICB0YXJnZXQ6ICJPYmplY3QiLAogIHN0YXQ6ICEwLAogIGZvcmNlZDogIVJlCn0sIHsKICBnZXRPd25Qcm9wZXJ0eU5hbWVzOiBVdCwKICBnZXRPd25Qcm9wZXJ0eVN5bWJvbHM6IEh0Cn0pLCBqZSh7CiAgdGFyZ2V0OiAiT2JqZWN0IiwKICBzdGF0OiAhMCwKICBmb3JjZWQ6IGUoZnVuY3Rpb24gKCkgewogICAgU2UuZigxKTsKICB9KQp9LCB7CiAgZ2V0T3duUHJvcGVydHlTeW1ib2xzOiBmdW5jdGlvbiBnZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSkgewogICAgcmV0dXJuIFNlLmYoRmUoZSkpOwogIH0KfSksIGt0KSB7CiAgdmFyIEJ0ID0gIVJlIHx8IGUoZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSBfd3QoKTsKCiAgICByZXR1cm4gIltudWxsXSIgIT0ga3QoW2VdKSB8fCAie30iICE9IGt0KHsKICAgICAgYTogZQogICAgfSkgfHwgInt9IiAhPSBrdChPYmplY3QoZSkpOwogIH0pOwogIGplKHsKICAgIHRhcmdldDogIkpTT04iLAogICAgc3RhdDogITAsCiAgICBmb3JjZWQ6IEJ0CiAgfSwgewogICAgc3RyaW5naWZ5OiBmdW5jdGlvbiBzdHJpbmdpZnkoZSwgdCwgbikgewogICAgICBmb3IgKHZhciBpLCByID0gW2VdLCBhID0gMTsgYXJndW1lbnRzLmxlbmd0aCA+IGE7KSB7CiAgICAgICAgci5wdXNoKGFyZ3VtZW50c1thKytdKTsKICAgICAgfQoKICAgICAgaWYgKGkgPSB0LCAobyh0KSB8fCB2b2lkIDAgIT09IGUpICYmICFSdChlKSkgcmV0dXJuIERlKHQpIHx8ICh0ID0gZnVuY3Rpb24gdChlLCBfdDIpIHsKICAgICAgICBpZiAoImZ1bmN0aW9uIiA9PSB0eXBlb2YgaSAmJiAoX3QyID0gaS5jYWxsKHRoaXMsIGUsIF90MikpLCAhUnQoX3QyKSkgcmV0dXJuIF90MjsKICAgICAgfSksIHJbMV0gPSB0LCBrdC5hcHBseShudWxsLCByKTsKICAgIH0KICB9KTsKfQoKX3d0LnByb3RvdHlwZVtndF0gfHwgTShfd3QucHJvdG90eXBlLCBndCwgX3d0LnByb3RvdHlwZS52YWx1ZU9mKSwgb3QoX3d0LCAiU3ltYm9sIiksIEdbbXRdID0gITA7CnZhciBWdCwKICAgIHp0LAogICAgV3QgPSBzZSgibmF2aWdhdG9yIiwgInVzZXJBZ2VudCIpIHx8ICIiLAogICAgJHQgPSBhLnByb2Nlc3MsCiAgICBLdCA9ICR0ICYmICR0LnZlcnNpb25zLAogICAgWXQgPSBLdCAmJiBLdC52ODsKWXQgPyB6dCA9IChWdCA9IFl0LnNwbGl0KCIuIikpWzBdICsgVnRbMV0gOiBXdCAmJiAoIShWdCA9IFd0Lm1hdGNoKC9FZGdlXC8oXGQrKS8pKSB8fCBWdFsxXSA+PSA3NCkgJiYgKFZ0ID0gV3QubWF0Y2goL0Nocm9tZVwvKFxkKykvKSkgJiYgKHp0ID0gVnRbMV0pOwoKdmFyIEd0ID0genQgJiYgK3p0LAogICAgWHQgPSBldCgic3BlY2llcyIpLAogICAgUXQgPSBmdW5jdGlvbiBRdCh0KSB7CiAgcmV0dXJuIEd0ID49IDUxIHx8ICFlKGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gW107CiAgICByZXR1cm4gKGUuY29uc3RydWN0b3IgPSB7fSlbWHRdID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gewogICAgICAgIGZvbzogMQogICAgICB9OwogICAgfSwgMSAhPT0gZVt0XShCb29sZWFuKS5mb287CiAgfSk7Cn0sCiAgICBKdCA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSwKICAgIFp0ID0ge30sCiAgICBlbiA9IGZ1bmN0aW9uIGVuKGUpIHsKICB0aHJvdyBlOwp9LAogICAgdG4gPSBmdW5jdGlvbiB0bihuLCBpKSB7CiAgaWYgKEkoWnQsIG4pKSByZXR1cm4gWnRbbl07CiAgaSB8fCAoaSA9IHt9KTsKICB2YXIgciA9IFtdW25dLAogICAgICBhID0gISFJKGksICJBQ0NFU1NPUlMiKSAmJiBpLkFDQ0VTU09SUywKICAgICAgbyA9IEkoaSwgMCkgPyBpWzBdIDogZW4sCiAgICAgIHMgPSBJKGksIDEpID8gaVsxXSA6IHZvaWQgMDsKICByZXR1cm4gWnRbbl0gPSAhIXIgJiYgIWUoZnVuY3Rpb24gKCkgewogICAgaWYgKGEgJiYgIXQpIHJldHVybiAhMDsKICAgIHZhciBlID0gewogICAgICBsZW5ndGg6IC0xCiAgICB9OwogICAgYSA/IEp0KGUsIDEsIHsKICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgIGdldDogZW4KICAgIH0pIDogZVsxXSA9IDEsIHIuY2FsbChlLCBvLCBzKTsKICB9KTsKfSwKICAgIG5uID0gZnQuZmlsdGVyLAogICAgcm4gPSBRdCgiZmlsdGVyIiksCiAgICBhbiA9IHRuKCJmaWx0ZXIiKTsKCmplKHsKICB0YXJnZXQ6ICJBcnJheSIsCiAgcHJvdG86ICEwLAogIGZvcmNlZDogIXJuIHx8ICFhbgp9LCB7CiAgZmlsdGVyOiBmdW5jdGlvbiBmaWx0ZXIoZSkgewogICAgcmV0dXJuIG5uKHRoaXMsIGUsIGFyZ3VtZW50cy5sZW5ndGggPiAxID8gYXJndW1lbnRzWzFdIDogdm9pZCAwKTsKICB9Cn0pOwoKdmFyIG9uID0gZnVuY3Rpb24gb24odCwgbikgewogIHZhciBpID0gW11bdF07CiAgcmV0dXJuICEhaSAmJiBlKGZ1bmN0aW9uICgpIHsKICAgIGkuY2FsbChudWxsLCBuIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgdGhyb3cgMTsKICAgIH0sIDEpOwogIH0pOwp9LAogICAgc24gPSBmdC5mb3JFYWNoLAogICAgbG4gPSBvbigiZm9yRWFjaCIpLAogICAgY24gPSB0bigiZm9yRWFjaCIpLAogICAgdW4gPSBsbiAmJiBjbiA/IFtdLmZvckVhY2ggOiBmdW5jdGlvbiAoZSkgewogIHJldHVybiBzbih0aGlzLCBlLCBhcmd1bWVudHMubGVuZ3RoID4gMSA/IGFyZ3VtZW50c1sxXSA6IHZvaWQgMCk7Cn07CgpqZSh7CiAgdGFyZ2V0OiAiQXJyYXkiLAogIHByb3RvOiAhMCwKICBmb3JjZWQ6IFtdLmZvckVhY2ggIT0gdW4KfSwgewogIGZvckVhY2g6IHVuCn0pOwp2YXIgaG4gPSBOLmYsCiAgICBkbiA9IGUoZnVuY3Rpb24gKCkgewogIGhuKDEpOwp9KTsKamUoewogIHRhcmdldDogIk9iamVjdCIsCiAgc3RhdDogITAsCiAgZm9yY2VkOiAhdCB8fCBkbiwKICBzaGFtOiAhdAp9LCB7CiAgZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yOiBmdW5jdGlvbiBnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgdCkgewogICAgcmV0dXJuIGhuKFAoZSksIHQpOwogIH0KfSk7Cgp2YXIgZm4gPSBmdW5jdGlvbiBmbihlLCB0LCBuKSB7CiAgdmFyIGkgPSBkKHQpOwogIGkgaW4gZSA/IHAuZihlLCBpLCBUKDAsIG4pKSA6IGVbaV0gPSBuOwp9OwoKamUoewogIHRhcmdldDogIk9iamVjdCIsCiAgc3RhdDogITAsCiAgc2hhbTogIXQKfSwgewogIGdldE93blByb3BlcnR5RGVzY3JpcHRvcnM6IGZ1bmN0aW9uIGdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoZSkgewogICAgZm9yICh2YXIgdCwgbiwgaSA9IFAoZSksIHIgPSBOLmYsIGEgPSBFZShpKSwgbyA9IHt9LCBzID0gMDsgYS5sZW5ndGggPiBzOykgewogICAgICB2b2lkIDAgIT09IChuID0gcihpLCB0ID0gYVtzKytdKSkgJiYgZm4obywgdCwgbik7CiAgICB9CgogICAgcmV0dXJuIG87CiAgfQp9KTsKdmFyIHBuID0gZShmdW5jdGlvbiAoKSB7CiAgcWUoMSk7Cn0pOwpqZSh7CiAgdGFyZ2V0OiAiT2JqZWN0IiwKICBzdGF0OiAhMCwKICBmb3JjZWQ6IHBuCn0sIHsKICBrZXlzOiBmdW5jdGlvbiBrZXlzKGUpIHsKICAgIHJldHVybiBxZShGZShlKSk7CiAgfQp9KTsKdmFyIG1uID0gewogIENTU1J1bGVMaXN0OiAwLAogIENTU1N0eWxlRGVjbGFyYXRpb246IDAsCiAgQ1NTVmFsdWVMaXN0OiAwLAogIENsaWVudFJlY3RMaXN0OiAwLAogIERPTVJlY3RMaXN0OiAwLAogIERPTVN0cmluZ0xpc3Q6IDAsCiAgRE9NVG9rZW5MaXN0OiAxLAogIERhdGFUcmFuc2Zlckl0ZW1MaXN0OiAwLAogIEZpbGVMaXN0OiAwLAogIEhUTUxBbGxDb2xsZWN0aW9uOiAwLAogIEhUTUxDb2xsZWN0aW9uOiAwLAogIEhUTUxGb3JtRWxlbWVudDogMCwKICBIVE1MU2VsZWN0RWxlbWVudDogMCwKICBNZWRpYUxpc3Q6IDAsCiAgTWltZVR5cGVBcnJheTogMCwKICBOYW1lZE5vZGVNYXA6IDAsCiAgTm9kZUxpc3Q6IDEsCiAgUGFpbnRSZXF1ZXN0TGlzdDogMCwKICBQbHVnaW46IDAsCiAgUGx1Z2luQXJyYXk6IDAsCiAgU1ZHTGVuZ3RoTGlzdDogMCwKICBTVkdOdW1iZXJMaXN0OiAwLAogIFNWR1BhdGhTZWdMaXN0OiAwLAogIFNWR1BvaW50TGlzdDogMCwKICBTVkdTdHJpbmdMaXN0OiAwLAogIFNWR1RyYW5zZm9ybUxpc3Q6IDAsCiAgU291cmNlQnVmZmVyTGlzdDogMCwKICBTdHlsZVNoZWV0TGlzdDogMCwKICBUZXh0VHJhY2tDdWVMaXN0OiAwLAogIFRleHRUcmFja0xpc3Q6IDAsCiAgVG91Y2hMaXN0OiAwCn07Cgpmb3IgKHZhciBnbiBpbiBtbikgewogIHZhciB2biA9IGFbZ25dLAogICAgICB5biA9IHZuICYmIHZuLnByb3RvdHlwZTsKICBpZiAoeW4gJiYgeW4uZm9yRWFjaCAhPT0gdW4pIHRyeSB7CiAgICBNKHluLCAiZm9yRWFjaCIsIHVuKTsKICB9IGNhdGNoIChlKSB7CiAgICB5bi5mb3JFYWNoID0gdW47CiAgfQp9CgpmdW5jdGlvbiBibihlLCB0LCBuKSB7CiAgcmV0dXJuIHQgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCB0LCB7CiAgICB2YWx1ZTogbiwKICAgIGVudW1lcmFibGU6ICEwLAogICAgY29uZmlndXJhYmxlOiAhMCwKICAgIHdyaXRhYmxlOiAhMAogIH0pIDogZVt0XSA9IG4sIGU7Cn0KCmZ1bmN0aW9uIHduKGUsIHQpIHsKICB2YXIgbiA9IE9iamVjdC5rZXlzKGUpOwoKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIGkgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgdCAmJiAoaSA9IGkuZmlsdGVyKGZ1bmN0aW9uICh0KSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHQpLmVudW1lcmFibGU7CiAgICB9KSksIG4ucHVzaC5hcHBseShuLCBpKTsKICB9CgogIHJldHVybiBuOwp9CgpmdW5jdGlvbiBrbihlKSB7CiAgZm9yICh2YXIgdCA9IDE7IHQgPCBhcmd1bWVudHMubGVuZ3RoOyB0KyspIHsKICAgIHZhciBuID0gbnVsbCAhPSBhcmd1bWVudHNbdF0gPyBhcmd1bWVudHNbdF0gOiB7fTsKICAgIHQgJSAyID8gd24oT2JqZWN0KG4pLCAhMCkuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICBibihlLCB0LCBuW3RdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhuKSkgOiB3bihPYmplY3QobikpLmZvckVhY2goZnVuY3Rpb24gKHQpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHQsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IobiwgdCkpOwogICAgfSk7CiAgfQoKICByZXR1cm4gZTsKfQoKdmFyIFRuID0gcC5mLAogICAgU24gPSBhLlN5bWJvbDsKCmlmICh0ICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIFNuICYmICghKCJkZXNjcmlwdGlvbiIgaW4gU24ucHJvdG90eXBlKSB8fCB2b2lkIDAgIT09IFNuKCkuZGVzY3JpcHRpb24pKSB7CiAgdmFyIEVuID0ge30sCiAgICAgIEFuID0gZnVuY3Rpb24gQW4oKSB7CiAgICB2YXIgZSA9IGFyZ3VtZW50cy5sZW5ndGggPCAxIHx8IHZvaWQgMCA9PT0gYXJndW1lbnRzWzBdID8gdm9pZCAwIDogU3RyaW5nKGFyZ3VtZW50c1swXSksCiAgICAgICAgdCA9IHRoaXMgaW5zdGFuY2VvZiBBbiA/IG5ldyBTbihlKSA6IHZvaWQgMCA9PT0gZSA/IFNuKCkgOiBTbihlKTsKICAgIHJldHVybiAiIiA9PT0gZSAmJiAoRW5bdF0gPSAhMCksIHQ7CiAgfTsKCiAgQWUoQW4sIFNuKTsKICB2YXIgeG4gPSBBbi5wcm90b3R5cGUgPSBTbi5wcm90b3R5cGU7CiAgeG4uY29uc3RydWN0b3IgPSBBbjsKICB2YXIgQ24gPSB4bi50b1N0cmluZywKICAgICAgUG4gPSAiU3ltYm9sKHRlc3QpIiA9PSBTdHJpbmcoU24oInRlc3QiKSksCiAgICAgIE9uID0gL15TeW1ib2xcKCguKilcKVteKV0rJC87CiAgVG4oeG4sICJkZXNjcmlwdGlvbiIsIHsKICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIGUgPSBvKHRoaXMpID8gdGhpcy52YWx1ZU9mKCkgOiB0aGlzLAogICAgICAgICAgdCA9IENuLmNhbGwoZSk7CiAgICAgIGlmIChJKEVuLCBlKSkgcmV0dXJuICIiOwogICAgICB2YXIgbiA9IFBuID8gdC5zbGljZSg3LCAtMSkgOiB0LnJlcGxhY2UoT24sICIkMSIpOwogICAgICByZXR1cm4gIiIgPT09IG4gPyB2b2lkIDAgOiBuOwogICAgfQogIH0pLCBqZSh7CiAgICBnbG9iYWw6ICEwLAogICAgZm9yY2VkOiAhMAogIH0sIHsKICAgIFN5bWJvbDogQW4KICB9KTsKfQoKaXQoIml0ZXJhdG9yIik7Cgp2YXIgSW4gPSBldCgiaXNDb25jYXRTcHJlYWRhYmxlIiksCiAgICBMbiA9IEd0ID49IDUxIHx8ICFlKGZ1bmN0aW9uICgpIHsKICB2YXIgZSA9IFtdOwogIHJldHVybiBlW0luXSA9ICExLCBlLmNvbmNhdCgpWzBdICE9PSBlOwp9KSwKICAgIE5uID0gUXQoImNvbmNhdCIpLAogICAgTW4gPSBmdW5jdGlvbiBNbihlKSB7CiAgaWYgKCFvKGUpKSByZXR1cm4gITE7CiAgdmFyIHQgPSBlW0luXTsKICByZXR1cm4gdm9pZCAwICE9PSB0ID8gISF0IDogRGUoZSk7Cn07CgpqZSh7CiAgdGFyZ2V0OiAiQXJyYXkiLAogIHByb3RvOiAhMCwKICBmb3JjZWQ6ICFMbiB8fCAhTm4KfSwgewogIGNvbmNhdDogZnVuY3Rpb24gY29uY2F0KGUpIHsKICAgIHZhciB0LAogICAgICAgIG4sCiAgICAgICAgaSwKICAgICAgICByLAogICAgICAgIGEsCiAgICAgICAgbyA9IEZlKHRoaXMpLAogICAgICAgIHMgPSB1dChvLCAwKSwKICAgICAgICBsID0gMDsKCiAgICBmb3IgKHQgPSAtMSwgaSA9IGFyZ3VtZW50cy5sZW5ndGg7IHQgPCBpOyB0KyspIHsKICAgICAgaWYgKE1uKGEgPSAtMSA9PT0gdCA/IG8gOiBhcmd1bWVudHNbdF0pKSB7CiAgICAgICAgaWYgKGwgKyAociA9IGRlKGEubGVuZ3RoKSkgPiA5MDA3MTk5MjU0NzQwOTkxKSB0aHJvdyBUeXBlRXJyb3IoIk1heGltdW0gYWxsb3dlZCBpbmRleCBleGNlZWRlZCIpOwoKICAgICAgICBmb3IgKG4gPSAwOyBuIDwgcjsgbisrLCBsKyspIHsKICAgICAgICAgIG4gaW4gYSAmJiBmbihzLCBsLCBhW25dKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGwgPj0gOTAwNzE5OTI1NDc0MDk5MSkgdGhyb3cgVHlwZUVycm9yKCJNYXhpbXVtIGFsbG93ZWQgaW5kZXggZXhjZWVkZWQiKTsKICAgICAgICBmbihzLCBsKyssIGEpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHMubGVuZ3RoID0gbCwgczsKICB9Cn0pOwoKdmFyIGpuID0gZnQuZXZlcnksCiAgICBSbiA9IG9uKCJldmVyeSIpLAogICAgX24gPSB0bigiZXZlcnkiKTsKCmplKHsKICB0YXJnZXQ6ICJBcnJheSIsCiAgcHJvdG86ICEwLAogIGZvcmNlZDogIVJuIHx8ICFfbgp9LCB7CiAgZXZlcnk6IGZ1bmN0aW9uIGV2ZXJ5KGUpIHsKICAgIHJldHVybiBqbih0aGlzLCBlLCBhcmd1bWVudHMubGVuZ3RoID4gMSA/IGFyZ3VtZW50c1sxXSA6IHZvaWQgMCk7CiAgfQp9KTsKdmFyIERuID0gZXQoInVuc2NvcGFibGVzIiksCiAgICBGbiA9IEFycmF5LnByb3RvdHlwZTsKbnVsbCA9PSBGbltEbl0gJiYgcC5mKEZuLCBEbiwgewogIGNvbmZpZ3VyYWJsZTogITAsCiAgdmFsdWU6ICRlKG51bGwpCn0pOwoKdmFyIHFuID0gZnVuY3Rpb24gcW4oZSkgewogIEZuW0RuXVtlXSA9ICEwOwp9LAogICAgVW4gPSBmdC5maW5kLAogICAgSG4gPSAhMCwKICAgIEJuID0gdG4oImZpbmQiKTsKCiJmaW5kIiBpbiBbXSAmJiBBcnJheSgxKS5maW5kKGZ1bmN0aW9uICgpIHsKICBIbiA9ICExOwp9KSwgamUoewogIHRhcmdldDogIkFycmF5IiwKICBwcm90bzogITAsCiAgZm9yY2VkOiBIbiB8fCAhQm4KfSwgewogIGZpbmQ6IGZ1bmN0aW9uIGZpbmQoZSkgewogICAgcmV0dXJuIFVuKHRoaXMsIGUsIGFyZ3VtZW50cy5sZW5ndGggPiAxID8gYXJndW1lbnRzWzFdIDogdm9pZCAwKTsKICB9Cn0pLCBxbigiZmluZCIpOwp2YXIgVm4gPSBmdC5maW5kSW5kZXgsCiAgICB6biA9ICEwLAogICAgV24gPSB0bigiZmluZEluZGV4Iik7CiJmaW5kSW5kZXgiIGluIFtdICYmIEFycmF5KDEpLmZpbmRJbmRleChmdW5jdGlvbiAoKSB7CiAgem4gPSAhMTsKfSksIGplKHsKICB0YXJnZXQ6ICJBcnJheSIsCiAgcHJvdG86ICEwLAogIGZvcmNlZDogem4gfHwgIVduCn0sIHsKICBmaW5kSW5kZXg6IGZ1bmN0aW9uIGZpbmRJbmRleChlKSB7CiAgICByZXR1cm4gVm4odGhpcywgZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBhcmd1bWVudHNbMV0gOiB2b2lkIDApOwogIH0KfSksIHFuKCJmaW5kSW5kZXgiKTsKCnZhciAkbiA9IGZ1bmN0aW9uICRuKGUsIHQsIG4sIGkpIHsKICB0cnkgewogICAgcmV0dXJuIGkgPyB0KGgobilbMF0sIG5bMV0pIDogdChuKTsKICB9IGNhdGNoICh0KSB7CiAgICB2YXIgciA9IGUucmV0dXJuOwogICAgdGhyb3cgdm9pZCAwICE9PSByICYmIGgoci5jYWxsKGUpKSwgdDsKICB9Cn0sCiAgICBLbiA9IHt9LAogICAgWW4gPSBldCgiaXRlcmF0b3IiKSwKICAgIEduID0gQXJyYXkucHJvdG90eXBlLAogICAgWG4gPSBmdW5jdGlvbiBYbihlKSB7CiAgcmV0dXJuIHZvaWQgMCAhPT0gZSAmJiAoS24uQXJyYXkgPT09IGUgfHwgR25bWW5dID09PSBlKTsKfSwKICAgIFFuID0ge307CgpRbltldCgidG9TdHJpbmdUYWciKV0gPSAieiI7Cgp2YXIgSm4gPSAiW29iamVjdCB6XSIgPT09IFN0cmluZyhRbiksCiAgICBabiA9IGV0KCJ0b1N0cmluZ1RhZyIpLAogICAgZWkgPSAiQXJndW1lbnRzIiA9PSBFKGZ1bmN0aW9uICgpIHsKICByZXR1cm4gYXJndW1lbnRzOwp9KCkpLAogICAgdGkgPSBKbiA/IEUgOiBmdW5jdGlvbiAoZSkgewogIHZhciB0LCBuLCBpOwogIHJldHVybiB2b2lkIDAgPT09IGUgPyAiVW5kZWZpbmVkIiA6IG51bGwgPT09IGUgPyAiTnVsbCIgOiAic3RyaW5nIiA9PSB0eXBlb2YgKG4gPSBmdW5jdGlvbiAoZSwgdCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIGVbdF07CiAgICB9IGNhdGNoIChlKSB7fQogIH0odCA9IE9iamVjdChlKSwgWm4pKSA/IG4gOiBlaSA/IEUodCkgOiAiT2JqZWN0IiA9PSAoaSA9IEUodCkpICYmICJmdW5jdGlvbiIgPT0gdHlwZW9mIHQuY2FsbGVlID8gIkFyZ3VtZW50cyIgOiBpOwp9LAogICAgbmkgPSBldCgiaXRlcmF0b3IiKSwKICAgIGlpID0gZnVuY3Rpb24gaWkoZSkgewogIGlmIChudWxsICE9IGUpIHJldHVybiBlW25pXSB8fCBlWyJAQGl0ZXJhdG9yIl0gfHwgS25bdGkoZSldOwp9LAogICAgcmkgPSBmdW5jdGlvbiByaShlKSB7CiAgdmFyIHQsCiAgICAgIG4sCiAgICAgIGksCiAgICAgIHIsCiAgICAgIGEsCiAgICAgIG8sCiAgICAgIHMgPSBGZShlKSwKICAgICAgbCA9ICJmdW5jdGlvbiIgPT0gdHlwZW9mIHRoaXMgPyB0aGlzIDogQXJyYXksCiAgICAgIGMgPSBhcmd1bWVudHMubGVuZ3RoLAogICAgICB1ID0gYyA+IDEgPyBhcmd1bWVudHNbMV0gOiB2b2lkIDAsCiAgICAgIGggPSB2b2lkIDAgIT09IHUsCiAgICAgIGQgPSBpaShzKSwKICAgICAgZiA9IDA7CiAgaWYgKGggJiYgKHUgPSBsdCh1LCBjID4gMiA/IGFyZ3VtZW50c1syXSA6IHZvaWQgMCwgMikpLCBudWxsID09IGQgfHwgbCA9PSBBcnJheSAmJiBYbihkKSkgZm9yIChuID0gbmV3IGwodCA9IGRlKHMubGVuZ3RoKSk7IHQgPiBmOyBmKyspIHsKICAgIG8gPSBoID8gdShzW2ZdLCBmKSA6IHNbZl0sIGZuKG4sIGYsIG8pOwogIH0gZWxzZSBmb3IgKGEgPSAociA9IGQuY2FsbChzKSkubmV4dCwgbiA9IG5ldyBsKCk7ICEoaSA9IGEuY2FsbChyKSkuZG9uZTsgZisrKSB7CiAgICBvID0gaCA/ICRuKHIsIHUsIFtpLnZhbHVlLCBmXSwgITApIDogaS52YWx1ZSwgZm4obiwgZiwgbyk7CiAgfQogIHJldHVybiBuLmxlbmd0aCA9IGYsIG47Cn0sCiAgICBhaSA9IGV0KCJpdGVyYXRvciIpLAogICAgb2kgPSAhMTsKCnRyeSB7CiAgdmFyIHNpID0gMCwKICAgICAgbGkgPSB7CiAgICBuZXh0OiBmdW5jdGlvbiBuZXh0KCkgewogICAgICByZXR1cm4gewogICAgICAgIGRvbmU6ICEhc2krKwogICAgICB9OwogICAgfSwKICAgIHJldHVybjogZnVuY3Rpb24gX3JldHVybigpIHsKICAgICAgb2kgPSAhMDsKICAgIH0KICB9OwogIGxpW2FpXSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzOwogIH0sIEFycmF5LmZyb20obGksIGZ1bmN0aW9uICgpIHsKICAgIHRocm93IDI7CiAgfSk7Cn0gY2F0Y2ggKGUpIHt9Cgp2YXIgY2kgPSBmdW5jdGlvbiBjaShlLCB0KSB7CiAgaWYgKCF0ICYmICFvaSkgcmV0dXJuICExOwogIHZhciBuID0gITE7CgogIHRyeSB7CiAgICB2YXIgaSA9IHt9OwogICAgaVthaV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgbmV4dDogZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGRvbmU6IG4gPSAhMAogICAgICAgICAgfTsKICAgICAgICB9CiAgICAgIH07CiAgICB9LCBlKGkpOwogIH0gY2F0Y2ggKGUpIHt9CgogIHJldHVybiBuOwp9LAogICAgdWkgPSAhY2koZnVuY3Rpb24gKGUpIHsKICBBcnJheS5mcm9tKGUpOwp9KTsKCmplKHsKICB0YXJnZXQ6ICJBcnJheSIsCiAgc3RhdDogITAsCiAgZm9yY2VkOiB1aQp9LCB7CiAgZnJvbTogcmkKfSk7CnZhciBoaSA9IHZlLmluY2x1ZGVzLAogICAgZGkgPSB0bigiaW5kZXhPZiIsIHsKICBBQ0NFU1NPUlM6ICEwLAogIDE6IDAKfSk7CmplKHsKICB0YXJnZXQ6ICJBcnJheSIsCiAgcHJvdG86ICEwLAogIGZvcmNlZDogIWRpCn0sIHsKICBpbmNsdWRlczogZnVuY3Rpb24gaW5jbHVkZXMoZSkgewogICAgcmV0dXJuIGhpKHRoaXMsIGUsIGFyZ3VtZW50cy5sZW5ndGggPiAxID8gYXJndW1lbnRzWzFdIDogdm9pZCAwKTsKICB9Cn0pLCBxbigiaW5jbHVkZXMiKTsKdmFyIGZpID0gdmUuaW5kZXhPZiwKICAgIHBpID0gW10uaW5kZXhPZiwKICAgIG1pID0gISFwaSAmJiAxIC8gWzFdLmluZGV4T2YoMSwgLTApIDwgMCwKICAgIGdpID0gb24oImluZGV4T2YiKSwKICAgIHZpID0gdG4oImluZGV4T2YiLCB7CiAgQUNDRVNTT1JTOiAhMCwKICAxOiAwCn0pOwpqZSh7CiAgdGFyZ2V0OiAiQXJyYXkiLAogIHByb3RvOiAhMCwKICBmb3JjZWQ6IG1pIHx8ICFnaSB8fCAhdmkKfSwgewogIGluZGV4T2Y6IGZ1bmN0aW9uIGluZGV4T2YoZSkgewogICAgcmV0dXJuIG1pID8gcGkuYXBwbHkodGhpcywgYXJndW1lbnRzKSB8fCAwIDogZmkodGhpcywgZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBhcmd1bWVudHNbMV0gOiB2b2lkIDApOwogIH0KfSk7CnZhciB5aSA9IFtdLmpvaW4sCiAgICBiaSA9IHggIT0gT2JqZWN0LAogICAgd2kgPSBvbigiam9pbiIsICIsIik7CmplKHsKICB0YXJnZXQ6ICJBcnJheSIsCiAgcHJvdG86ICEwLAogIGZvcmNlZDogYmkgfHwgIXdpCn0sIHsKICBqb2luOiBmdW5jdGlvbiBqb2luKGUpIHsKICAgIHJldHVybiB5aS5jYWxsKFAodGhpcyksIHZvaWQgMCA9PT0gZSA/ICIsIiA6IGUpOwogIH0KfSk7CnZhciBraSA9IE1hdGgubWluLAogICAgVGkgPSBbXS5sYXN0SW5kZXhPZiwKICAgIFNpID0gISFUaSAmJiAxIC8gWzFdLmxhc3RJbmRleE9mKDEsIC0wKSA8IDAsCiAgICBFaSA9IG9uKCJsYXN0SW5kZXhPZiIpLAogICAgQWkgPSB0bigiaW5kZXhPZiIsIHsKICBBQ0NFU1NPUlM6ICEwLAogIDE6IDAKfSksCiAgICB4aSA9IFNpIHx8ICFFaSB8fCAhQWkgPyBmdW5jdGlvbiAoZSkgewogIGlmIChTaSkgcmV0dXJuIFRpLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykgfHwgMDsKICB2YXIgdCA9IFAodGhpcyksCiAgICAgIG4gPSBkZSh0Lmxlbmd0aCksCiAgICAgIGkgPSBuIC0gMTsKCiAgZm9yIChhcmd1bWVudHMubGVuZ3RoID4gMSAmJiAoaSA9IGtpKGksIHVlKGFyZ3VtZW50c1sxXSkpKSwgaSA8IDAgJiYgKGkgPSBuICsgaSk7IGkgPj0gMDsgaS0tKSB7CiAgICBpZiAoaSBpbiB0ICYmIHRbaV0gPT09IGUpIHJldHVybiBpIHx8IDA7CiAgfQoKICByZXR1cm4gLTE7Cn0gOiBUaTsKamUoewogIHRhcmdldDogIkFycmF5IiwKICBwcm90bzogITAsCiAgZm9yY2VkOiB4aSAhPT0gW10ubGFzdEluZGV4T2YKfSwgewogIGxhc3RJbmRleE9mOiB4aQp9KTsKdmFyIENpID0gZnQubWFwLAogICAgUGkgPSBRdCgibWFwIiksCiAgICBPaSA9IHRuKCJtYXAiKTsKamUoewogIHRhcmdldDogIkFycmF5IiwKICBwcm90bzogITAsCiAgZm9yY2VkOiAhUGkgfHwgIU9pCn0sIHsKICBtYXA6IGZ1bmN0aW9uIG1hcChlKSB7CiAgICByZXR1cm4gQ2kodGhpcywgZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBhcmd1bWVudHNbMV0gOiB2b2lkIDApOwogIH0KfSk7Cgp2YXIgSWkgPSBmdW5jdGlvbiBJaShlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uICh0LCBuLCBpLCByKSB7CiAgICBzdChuKTsKICAgIHZhciBhID0gRmUodCksCiAgICAgICAgbyA9IHgoYSksCiAgICAgICAgcyA9IGRlKGEubGVuZ3RoKSwKICAgICAgICBsID0gZSA/IHMgLSAxIDogMCwKICAgICAgICBjID0gZSA/IC0xIDogMTsKICAgIGlmIChpIDwgMikgZm9yICg7OykgewogICAgICBpZiAobCBpbiBvKSB7CiAgICAgICAgciA9IG9bbF0sIGwgKz0gYzsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgaWYgKGwgKz0gYywgZSA/IGwgPCAwIDogcyA8PSBsKSB0aHJvdyBUeXBlRXJyb3IoIlJlZHVjZSBvZiBlbXB0eSBhcnJheSB3aXRoIG5vIGluaXRpYWwgdmFsdWUiKTsKICAgIH0KCiAgICBmb3IgKDsgZSA/IGwgPj0gMCA6IHMgPiBsOyBsICs9IGMpIHsKICAgICAgbCBpbiBvICYmIChyID0gbihyLCBvW2xdLCBsLCBhKSk7CiAgICB9CgogICAgcmV0dXJuIHI7CiAgfTsKfSwKICAgIExpID0gewogIGxlZnQ6IElpKCExKSwKICByaWdodDogSWkoITApCn0ubGVmdCwKICAgIE5pID0gb24oInJlZHVjZSIpLAogICAgTWkgPSB0bigicmVkdWNlIiwgewogIDE6IDAKfSk7CgpqZSh7CiAgdGFyZ2V0OiAiQXJyYXkiLAogIHByb3RvOiAhMCwKICBmb3JjZWQ6ICFOaSB8fCAhTWkKfSwgewogIHJlZHVjZTogZnVuY3Rpb24gcmVkdWNlKGUpIHsKICAgIHJldHVybiBMaSh0aGlzLCBlLCBhcmd1bWVudHMubGVuZ3RoLCBhcmd1bWVudHMubGVuZ3RoID4gMSA/IGFyZ3VtZW50c1sxXSA6IHZvaWQgMCk7CiAgfQp9KTsKCnZhciBqaSA9IFF0KCJzbGljZSIpLAogICAgUmkgPSB0bigic2xpY2UiLCB7CiAgQUNDRVNTT1JTOiAhMCwKICAwOiAwLAogIDE6IDIKfSksCiAgICBfaSA9IGV0KCJzcGVjaWVzIiksCiAgICBEaSA9IFtdLnNsaWNlLAogICAgRmkgPSBNYXRoLm1heDsKCmplKHsKICB0YXJnZXQ6ICJBcnJheSIsCiAgcHJvdG86ICEwLAogIGZvcmNlZDogIWppIHx8ICFSaQp9LCB7CiAgc2xpY2U6IGZ1bmN0aW9uIHNsaWNlKGUsIHQpIHsKICAgIHZhciBuLAogICAgICAgIGksCiAgICAgICAgciwKICAgICAgICBhID0gUCh0aGlzKSwKICAgICAgICBzID0gZGUoYS5sZW5ndGgpLAogICAgICAgIGwgPSBtZShlLCBzKSwKICAgICAgICBjID0gbWUodm9pZCAwID09PSB0ID8gcyA6IHQsIHMpOwogICAgaWYgKERlKGEpICYmICgiZnVuY3Rpb24iICE9IHR5cGVvZiAobiA9IGEuY29uc3RydWN0b3IpIHx8IG4gIT09IEFycmF5ICYmICFEZShuLnByb3RvdHlwZSkgPyBvKG4pICYmIG51bGwgPT09IChuID0gbltfaV0pICYmIChuID0gdm9pZCAwKSA6IG4gPSB2b2lkIDAsIG4gPT09IEFycmF5IHx8IHZvaWQgMCA9PT0gbikpIHJldHVybiBEaS5jYWxsKGEsIGwsIGMpOwoKICAgIGZvciAoaSA9IG5ldyAodm9pZCAwID09PSBuID8gQXJyYXkgOiBuKShGaShjIC0gbCwgMCkpLCByID0gMDsgbCA8IGM7IGwrKywgcisrKSB7CiAgICAgIGwgaW4gYSAmJiBmbihpLCByLCBhW2xdKTsKICAgIH0KCiAgICByZXR1cm4gaS5sZW5ndGggPSByLCBpOwogIH0KfSk7CnZhciBxaSA9IGZ0LnNvbWUsCiAgICBVaSA9IG9uKCJzb21lIiksCiAgICBIaSA9IHRuKCJzb21lIik7CmplKHsKICB0YXJnZXQ6ICJBcnJheSIsCiAgcHJvdG86ICEwLAogIGZvcmNlZDogIVVpIHx8ICFIaQp9LCB7CiAgc29tZTogZnVuY3Rpb24gc29tZShlKSB7CiAgICByZXR1cm4gcWkodGhpcywgZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBhcmd1bWVudHNbMV0gOiB2b2lkIDApOwogIH0KfSk7CnZhciBCaSA9IFF0KCJzcGxpY2UiKSwKICAgIFZpID0gdG4oInNwbGljZSIsIHsKICBBQ0NFU1NPUlM6ICEwLAogIDA6IDAsCiAgMTogMgp9KSwKICAgIHppID0gTWF0aC5tYXgsCiAgICBXaSA9IE1hdGgubWluOwpqZSh7CiAgdGFyZ2V0OiAiQXJyYXkiLAogIHByb3RvOiAhMCwKICBmb3JjZWQ6ICFCaSB8fCAhVmkKfSwgewogIHNwbGljZTogZnVuY3Rpb24gc3BsaWNlKGUsIHQpIHsKICAgIHZhciBuLAogICAgICAgIGksCiAgICAgICAgciwKICAgICAgICBhLAogICAgICAgIG8sCiAgICAgICAgcywKICAgICAgICBsID0gRmUodGhpcyksCiAgICAgICAgYyA9IGRlKGwubGVuZ3RoKSwKICAgICAgICB1ID0gbWUoZSwgYyksCiAgICAgICAgaCA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICBpZiAoMCA9PT0gaCA/IG4gPSBpID0gMCA6IDEgPT09IGggPyAobiA9IDAsIGkgPSBjIC0gdSkgOiAobiA9IGggLSAyLCBpID0gV2koemkodWUodCksIDApLCBjIC0gdSkpLCBjICsgbiAtIGkgPiA5MDA3MTk5MjU0NzQwOTkxKSB0aHJvdyBUeXBlRXJyb3IoIk1heGltdW0gYWxsb3dlZCBsZW5ndGggZXhjZWVkZWQiKTsKCiAgICBmb3IgKHIgPSB1dChsLCBpKSwgYSA9IDA7IGEgPCBpOyBhKyspIHsKICAgICAgKG8gPSB1ICsgYSkgaW4gbCAmJiBmbihyLCBhLCBsW29dKTsKICAgIH0KCiAgICBpZiAoci5sZW5ndGggPSBpLCBuIDwgaSkgewogICAgICBmb3IgKGEgPSB1OyBhIDwgYyAtIGk7IGErKykgewogICAgICAgIHMgPSBhICsgbiwgKG8gPSBhICsgaSkgaW4gbCA/IGxbc10gPSBsW29dIDogZGVsZXRlIGxbc107CiAgICAgIH0KCiAgICAgIGZvciAoYSA9IGM7IGEgPiBjIC0gaSArIG47IGEtLSkgewogICAgICAgIGRlbGV0ZSBsW2EgLSAxXTsKICAgICAgfQogICAgfSBlbHNlIGlmIChuID4gaSkgZm9yIChhID0gYyAtIGk7IGEgPiB1OyBhLS0pIHsKICAgICAgcyA9IGEgKyBuIC0gMSwgKG8gPSBhICsgaSAtIDEpIGluIGwgPyBsW3NdID0gbFtvXSA6IGRlbGV0ZSBsW3NdOwogICAgfQoKICAgIGZvciAoYSA9IDA7IGEgPCBuOyBhKyspIHsKICAgICAgbFthICsgdV0gPSBhcmd1bWVudHNbYSArIDJdOwogICAgfQoKICAgIHJldHVybiBsLmxlbmd0aCA9IGMgLSBpICsgbiwgcjsKICB9Cn0pLCBqZSh7CiAgZ2xvYmFsOiAhMAp9LCB7CiAgZ2xvYmFsVGhpczogYQp9KTsKCnZhciAkaSA9IE1hdGguc2lnbiB8fCBmdW5jdGlvbiAoZSkgewogIHJldHVybiAwID09IChlID0gK2UpIHx8IGUgIT0gZSA/IGUgOiBlIDwgMCA/IC0xIDogMTsKfTsKCmplKHsKICB0YXJnZXQ6ICJNYXRoIiwKICBzdGF0OiAhMAp9LCB7CiAgc2lnbjogJGkKfSk7CnZhciBLaSA9IE1hdGguY2VpbCwKICAgIFlpID0gTWF0aC5mbG9vcjsKamUoewogIHRhcmdldDogIk1hdGgiLAogIHN0YXQ6ICEwCn0sIHsKICB0cnVuYzogZnVuY3Rpb24gdHJ1bmMoZSkgewogICAgcmV0dXJuIChlID4gMCA/IFlpIDogS2kpKGUpOwogIH0KfSk7Cgp2YXIgR2kgPSBPYmplY3Quc2V0UHJvdG90eXBlT2YgfHwgKCJfX3Byb3RvX18iIGluIHt9ID8gZnVuY3Rpb24gKCkgewogIHZhciBlLAogICAgICB0ID0gITEsCiAgICAgIG4gPSB7fTsKCiAgdHJ5IHsKICAgIChlID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihPYmplY3QucHJvdG90eXBlLCAiX19wcm90b19fIikuc2V0KS5jYWxsKG4sIFtdKSwgdCA9IG4gaW5zdGFuY2VvZiBBcnJheTsKICB9IGNhdGNoIChlKSB7fQoKICByZXR1cm4gZnVuY3Rpb24gKG4sIGkpIHsKICAgIHJldHVybiBoKG4pLCBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoIW8oZSkgJiYgbnVsbCAhPT0gZSkgdGhyb3cgVHlwZUVycm9yKCJDYW4ndCBzZXQgIiArIFN0cmluZyhlKSArICIgYXMgYSBwcm90b3R5cGUiKTsKICAgIH0oaSksIHQgPyBlLmNhbGwobiwgaSkgOiBuLl9fcHJvdG9fXyA9IGksIG47CiAgfTsKfSgpIDogdm9pZCAwKSwKICAgIFhpID0gZnVuY3Rpb24gWGkoZSwgdCwgbikgewogIHZhciBpLCByOwogIHJldHVybiBHaSAmJiAiZnVuY3Rpb24iID09IHR5cGVvZiAoaSA9IHQuY29uc3RydWN0b3IpICYmIGkgIT09IG4gJiYgbyhyID0gaS5wcm90b3R5cGUpICYmIHIgIT09IG4ucHJvdG90eXBlICYmIEdpKGUsIHIpLCBlOwp9LAogICAgUWkgPSAiXHRcblx4MEJcZlxyIFx4QTBcdTE2ODBcdTIwMDBcdTIwMDFcdTIwMDJcdTIwMDNcdTIwMDRcdTIwMDVcdTIwMDZcdTIwMDdcdTIwMDhcdTIwMDlcdTIwMEFcdTIwMkZcdTIwNUZcdTMwMDBcdTIwMjhcdTIwMjlcdUZFRkYiLAogICAgSmkgPSAiWyIgKyBRaSArICJdIiwKICAgIFppID0gUmVnRXhwKCJeIiArIEppICsgSmkgKyAiKiIpLAogICAgZXIgPSBSZWdFeHAoSmkgKyBKaSArICIqJCIpLAogICAgdHIgPSBmdW5jdGlvbiB0cihlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uICh0KSB7CiAgICB2YXIgbiA9IFN0cmluZyhDKHQpKTsKICAgIHJldHVybiAxICYgZSAmJiAobiA9IG4ucmVwbGFjZShaaSwgIiIpKSwgMiAmIGUgJiYgKG4gPSBuLnJlcGxhY2UoZXIsICIiKSksIG47CiAgfTsKfSwKICAgIG5yID0gewogIHN0YXJ0OiB0cigxKSwKICBlbmQ6IHRyKDIpLAogIHRyaW06IHRyKDMpCn0sCiAgICBpciA9IFRlLmYsCiAgICByciA9IE4uZiwKICAgIGFyID0gcC5mLAogICAgb3IgPSBuci50cmltLAogICAgc3IgPSBhLk51bWJlciwKICAgIGxyID0gc3IucHJvdG90eXBlLAogICAgY3IgPSAiTnVtYmVyIiA9PSBFKCRlKGxyKSksCiAgICB1ciA9IGZ1bmN0aW9uIHVyKGUpIHsKICB2YXIgdCwKICAgICAgbiwKICAgICAgaSwKICAgICAgciwKICAgICAgYSwKICAgICAgbywKICAgICAgcywKICAgICAgbCwKICAgICAgYyA9IGQoZSwgITEpOwogIGlmICgic3RyaW5nIiA9PSB0eXBlb2YgYyAmJiBjLmxlbmd0aCA+IDIpIGlmICg0MyA9PT0gKHQgPSAoYyA9IG9yKGMpKS5jaGFyQ29kZUF0KDApKSB8fCA0NSA9PT0gdCkgewogICAgaWYgKDg4ID09PSAobiA9IGMuY2hhckNvZGVBdCgyKSkgfHwgMTIwID09PSBuKSByZXR1cm4gTmFOOwogIH0gZWxzZSBpZiAoNDggPT09IHQpIHsKICAgIHN3aXRjaCAoYy5jaGFyQ29kZUF0KDEpKSB7CiAgICAgIGNhc2UgNjY6CiAgICAgIGNhc2UgOTg6CiAgICAgICAgaSA9IDIsIHIgPSA0OTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgNzk6CiAgICAgIGNhc2UgMTExOgogICAgICAgIGkgPSA4LCByID0gNTU7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiArYzsKICAgIH0KCiAgICBmb3IgKG8gPSAoYSA9IGMuc2xpY2UoMikpLmxlbmd0aCwgcyA9IDA7IHMgPCBvOyBzKyspIHsKICAgICAgaWYgKChsID0gYS5jaGFyQ29kZUF0KHMpKSA8IDQ4IHx8IGwgPiByKSByZXR1cm4gTmFOOwogICAgfQoKICAgIHJldHVybiBwYXJzZUludChhLCBpKTsKICB9CiAgcmV0dXJuICtjOwp9OwoKaWYgKE5lKCJOdW1iZXIiLCAhc3IoIiAwbzEiKSB8fCAhc3IoIjBiMSIpIHx8IHNyKCIrMHgxIikpKSB7CiAgZm9yICh2YXIgaHIsIGRyID0gZnVuY3Rpb24gZHIodCkgewogICAgdmFyIG4gPSBhcmd1bWVudHMubGVuZ3RoIDwgMSA/IDAgOiB0LAogICAgICAgIGkgPSB0aGlzOwogICAgcmV0dXJuIGkgaW5zdGFuY2VvZiBkciAmJiAoY3IgPyBlKGZ1bmN0aW9uICgpIHsKICAgICAgbHIudmFsdWVPZi5jYWxsKGkpOwogICAgfSkgOiAiTnVtYmVyIiAhPSBFKGkpKSA/IFhpKG5ldyBzcih1cihuKSksIGksIGRyKSA6IHVyKG4pOwogIH0sIGZyID0gdCA/IGlyKHNyKSA6ICJNQVhfVkFMVUUsTUlOX1ZBTFVFLE5hTixORUdBVElWRV9JTkZJTklUWSxQT1NJVElWRV9JTkZJTklUWSxFUFNJTE9OLGlzRmluaXRlLGlzSW50ZWdlcixpc05hTixpc1NhZmVJbnRlZ2VyLE1BWF9TQUZFX0lOVEVHRVIsTUlOX1NBRkVfSU5URUdFUixwYXJzZUZsb2F0LHBhcnNlSW50LGlzSW50ZWdlciIuc3BsaXQoIiwiKSwgcHIgPSAwOyBmci5sZW5ndGggPiBwcjsgcHIrKykgewogICAgSShzciwgaHIgPSBmcltwcl0pICYmICFJKGRyLCBocikgJiYgYXIoZHIsIGhyLCBycihzciwgaHIpKTsKICB9CgogIGRyLnByb3RvdHlwZSA9IGxyLCBsci5jb25zdHJ1Y3RvciA9IGRyLCByZShhLCAiTnVtYmVyIiwgZHIpOwp9CgpqZSh7CiAgdGFyZ2V0OiAiTnVtYmVyIiwKICBzdGF0OiAhMAp9LCB7CiAgaXNOYU46IGZ1bmN0aW9uIGlzTmFOKGUpIHsKICAgIHJldHVybiBlICE9IGU7CiAgfQp9KTsKCnZhciBtciA9ICIiLnJlcGVhdCB8fCBmdW5jdGlvbiAoZSkgewogIHZhciB0ID0gU3RyaW5nKEModGhpcykpLAogICAgICBuID0gIiIsCiAgICAgIGkgPSB1ZShlKTsKICBpZiAoaSA8IDAgfHwgaSA9PSAxIC8gMCkgdGhyb3cgUmFuZ2VFcnJvcigiV3JvbmcgbnVtYmVyIG9mIHJlcGV0aXRpb25zIik7CgogIGZvciAoOyBpID4gMDsgKGkgPj4+PSAxKSAmJiAodCArPSB0KSkgewogICAgMSAmIGkgJiYgKG4gKz0gdCk7CiAgfQoKICByZXR1cm4gbjsKfSwKICAgIGdyID0gMS4udG9GaXhlZCwKICAgIHZyID0gTWF0aC5mbG9vciwKICAgIHlyID0gZnVuY3Rpb24geXIoZSwgdCwgbikgewogIHJldHVybiAwID09PSB0ID8gbiA6IHQgJSAyID09IDEgPyB5cihlLCB0IC0gMSwgbiAqIGUpIDogeXIoZSAqIGUsIHQgLyAyLCBuKTsKfSwKICAgIGJyID0gZ3IgJiYgKCIwLjAwMCIgIT09IDhlLTUudG9GaXhlZCgzKSB8fCAiMSIgIT09IC45LnRvRml4ZWQoMCkgfHwgIjEuMjUiICE9PSAxLjI1NS50b0ZpeGVkKDIpIHx8ICIxMDAwMDAwMDAwMDAwMDAwMTI4IiAhPT0gMHhkZTBiNmIzYTc2NDAwODAudG9GaXhlZCgwKSkgfHwgIWUoZnVuY3Rpb24gKCkgewogIGdyLmNhbGwoe30pOwp9KTsKCmplKHsKICB0YXJnZXQ6ICJOdW1iZXIiLAogIHByb3RvOiAhMCwKICBmb3JjZWQ6IGJyCn0sIHsKICB0b0ZpeGVkOiBmdW5jdGlvbiB0b0ZpeGVkKGUpIHsKICAgIHZhciB0LAogICAgICAgIG4sCiAgICAgICAgaSwKICAgICAgICByLAogICAgICAgIGEgPSBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoIm51bWJlciIgIT0gdHlwZW9mIGUgJiYgIk51bWJlciIgIT0gRShlKSkgdGhyb3cgVHlwZUVycm9yKCJJbmNvcnJlY3QgaW52b2NhdGlvbiIpOwogICAgICByZXR1cm4gK2U7CiAgICB9KHRoaXMpLAogICAgICAgIG8gPSB1ZShlKSwKICAgICAgICBzID0gWzAsIDAsIDAsIDAsIDAsIDBdLAogICAgICAgIGwgPSAiIiwKICAgICAgICBjID0gIjAiLAogICAgICAgIHUgPSBmdW5jdGlvbiB1KGUsIHQpIHsKICAgICAgZm9yICh2YXIgbiA9IC0xLCBpID0gdDsgKytuIDwgNjspIHsKICAgICAgICBpICs9IGUgKiBzW25dLCBzW25dID0gaSAlIDFlNywgaSA9IHZyKGkgLyAxZTcpOwogICAgICB9CiAgICB9LAogICAgICAgIGggPSBmdW5jdGlvbiBoKGUpIHsKICAgICAgZm9yICh2YXIgdCA9IDYsIG4gPSAwOyAtLXQgPj0gMDspIHsKICAgICAgICBuICs9IHNbdF0sIHNbdF0gPSB2cihuIC8gZSksIG4gPSBuICUgZSAqIDFlNzsKICAgICAgfQogICAgfSwKICAgICAgICBkID0gZnVuY3Rpb24gZCgpIHsKICAgICAgZm9yICh2YXIgZSA9IDYsIHQgPSAiIjsgLS1lID49IDA7KSB7CiAgICAgICAgaWYgKCIiICE9PSB0IHx8IDAgPT09IGUgfHwgMCAhPT0gc1tlXSkgewogICAgICAgICAgdmFyIG4gPSBTdHJpbmcoc1tlXSk7CiAgICAgICAgICB0ID0gIiIgPT09IHQgPyBuIDogdCArIG1yLmNhbGwoIjAiLCA3IC0gbi5sZW5ndGgpICsgbjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0OwogICAgfTsKCiAgICBpZiAobyA8IDAgfHwgbyA+IDIwKSB0aHJvdyBSYW5nZUVycm9yKCJJbmNvcnJlY3QgZnJhY3Rpb24gZGlnaXRzIik7CiAgICBpZiAoYSAhPSBhKSByZXR1cm4gIk5hTiI7CiAgICBpZiAoYSA8PSAtMWUyMSB8fCBhID49IDFlMjEpIHJldHVybiBTdHJpbmcoYSk7CiAgICBpZiAoYSA8IDAgJiYgKGwgPSAiLSIsIGEgPSAtYSksIGEgPiAxZS0yMSkgaWYgKG4gPSAodCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIGZvciAodmFyIHQgPSAwLCBuID0gZTsgbiA+PSA0MDk2OykgewogICAgICAgIHQgKz0gMTIsIG4gLz0gNDA5NjsKICAgICAgfQoKICAgICAgZm9yICg7IG4gPj0gMjspIHsKICAgICAgICB0ICs9IDEsIG4gLz0gMjsKICAgICAgfQoKICAgICAgcmV0dXJuIHQ7CiAgICB9KGEgKiB5cigyLCA2OSwgMSkpIC0gNjkpIDwgMCA/IGEgKiB5cigyLCAtdCwgMSkgOiBhIC8geXIoMiwgdCwgMSksIG4gKj0gNDUwMzU5OTYyNzM3MDQ5NiwgKHQgPSA1MiAtIHQpID4gMCkgewogICAgICBmb3IgKHUoMCwgbiksIGkgPSBvOyBpID49IDc7KSB7CiAgICAgICAgdSgxZTcsIDApLCBpIC09IDc7CiAgICAgIH0KCiAgICAgIGZvciAodSh5cigxMCwgaSwgMSksIDApLCBpID0gdCAtIDE7IGkgPj0gMjM7KSB7CiAgICAgICAgaCgxIDw8IDIzKSwgaSAtPSAyMzsKICAgICAgfQoKICAgICAgaCgxIDw8IGkpLCB1KDEsIDEpLCBoKDIpLCBjID0gZCgpOwogICAgfSBlbHNlIHUoMCwgbiksIHUoMSA8PCAtdCwgMCksIGMgPSBkKCkgKyBtci5jYWxsKCIwIiwgbyk7CiAgICByZXR1cm4gYyA9IG8gPiAwID8gbCArICgociA9IGMubGVuZ3RoKSA8PSBvID8gIjAuIiArIG1yLmNhbGwoIjAiLCBvIC0gcikgKyBjIDogYy5zbGljZSgwLCByIC0gbykgKyAiLiIgKyBjLnNsaWNlKHIgLSBvKSkgOiBsICsgYzsKICB9Cn0pOwoKdmFyIHdyID0gay5mLAogICAga3IgPSBmdW5jdGlvbiBrcihlKSB7CiAgcmV0dXJuIGZ1bmN0aW9uIChuKSB7CiAgICBmb3IgKHZhciBpLCByID0gUChuKSwgYSA9IHFlKHIpLCBvID0gYS5sZW5ndGgsIHMgPSAwLCBsID0gW107IG8gPiBzOykgewogICAgICBpID0gYVtzKytdLCB0ICYmICF3ci5jYWxsKHIsIGkpIHx8IGwucHVzaChlID8gW2ksIHJbaV1dIDogcltpXSk7CiAgICB9CgogICAgcmV0dXJuIGw7CiAgfTsKfSwKICAgIFRyID0gewogIGVudHJpZXM6IGtyKCEwKSwKICB2YWx1ZXM6IGtyKCExKQp9LAogICAgU3IgPSBUci5lbnRyaWVzOwoKamUoewogIHRhcmdldDogIk9iamVjdCIsCiAgc3RhdDogITAKfSwgewogIGVudHJpZXM6IGZ1bmN0aW9uIGVudHJpZXMoZSkgewogICAgcmV0dXJuIFNyKGUpOwogIH0KfSk7CnZhciBFciA9IEpuID8ge30udG9TdHJpbmcgOiBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuICJbb2JqZWN0ICIgKyB0aSh0aGlzKSArICJdIjsKfTsKSm4gfHwgcmUoT2JqZWN0LnByb3RvdHlwZSwgInRvU3RyaW5nIiwgRXIsIHsKICB1bnNhZmU6ICEwCn0pOwp2YXIgQXIgPSBUci52YWx1ZXM7CmplKHsKICB0YXJnZXQ6ICJPYmplY3QiLAogIHN0YXQ6ICEwCn0sIHsKICB2YWx1ZXM6IGZ1bmN0aW9uIHZhbHVlcyhlKSB7CiAgICByZXR1cm4gQXIoZSk7CiAgfQp9KTsKCnZhciB4ciA9IGV0KCJtYXRjaCIpLAogICAgQ3IgPSBmdW5jdGlvbiBDcihlKSB7CiAgdmFyIHQ7CiAgcmV0dXJuIG8oZSkgJiYgKHZvaWQgMCAhPT0gKHQgPSBlW3hyXSkgPyAhIXQgOiAiUmVnRXhwIiA9PSBFKGUpKTsKfSwKICAgIFByID0gZnVuY3Rpb24gUHIoKSB7CiAgdmFyIGUgPSBoKHRoaXMpLAogICAgICB0ID0gIiI7CiAgcmV0dXJuIGUuZ2xvYmFsICYmICh0ICs9ICJnIiksIGUuaWdub3JlQ2FzZSAmJiAodCArPSAiaSIpLCBlLm11bHRpbGluZSAmJiAodCArPSAibSIpLCBlLmRvdEFsbCAmJiAodCArPSAicyIpLCBlLnVuaWNvZGUgJiYgKHQgKz0gInUiKSwgZS5zdGlja3kgJiYgKHQgKz0gInkiKSwgdDsKfTsKCmZ1bmN0aW9uIE9yKGUsIHQpIHsKICByZXR1cm4gUmVnRXhwKGUsIHQpOwp9Cgp2YXIgSXIgPSB7CiAgVU5TVVBQT1JURURfWTogZShmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IE9yKCJhIiwgInkiKTsKICAgIHJldHVybiBlLmxhc3RJbmRleCA9IDIsIG51bGwgIT0gZS5leGVjKCJhYmNkIik7CiAgfSksCiAgQlJPS0VOX0NBUkVUOiBlKGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gT3IoIl5yIiwgImd5Iik7CiAgICByZXR1cm4gZS5sYXN0SW5kZXggPSAyLCBudWxsICE9IGUuZXhlYygic3RyIik7CiAgfSkKfSwKICAgIExyID0gZXQoInNwZWNpZXMiKSwKICAgIE5yID0gcC5mLAogICAgTXIgPSBUZS5mLAogICAganIgPSBpZS5zZXQsCiAgICBSciA9IGV0KCJtYXRjaCIpLAogICAgX3IgPSBhLlJlZ0V4cCwKICAgIERyID0gX3IucHJvdG90eXBlLAogICAgRnIgPSAvYS9nLAogICAgcXIgPSAvYS9nLAogICAgVXIgPSBuZXcgX3IoRnIpICE9PSBGciwKICAgIEhyID0gSXIuVU5TVVBQT1JURURfWTsKCmlmICh0ICYmIE5lKCJSZWdFeHAiLCAhVXIgfHwgSHIgfHwgZShmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHFyW1JyXSA9ICExLCBfcihGcikgIT0gRnIgfHwgX3IocXIpID09IHFyIHx8ICIvYS9pIiAhPSBfcihGciwgImkiKTsKfSkpKSB7CiAgZm9yICh2YXIgQnIgPSBmdW5jdGlvbiBCcihlLCB0KSB7CiAgICB2YXIgbiwKICAgICAgICBpID0gdGhpcyBpbnN0YW5jZW9mIEJyLAogICAgICAgIHIgPSBDcihlKSwKICAgICAgICBhID0gdm9pZCAwID09PSB0OwogICAgaWYgKCFpICYmIHIgJiYgZS5jb25zdHJ1Y3RvciA9PT0gQnIgJiYgYSkgcmV0dXJuIGU7CiAgICBVciA/IHIgJiYgIWEgJiYgKGUgPSBlLnNvdXJjZSkgOiBlIGluc3RhbmNlb2YgQnIgJiYgKGEgJiYgKHQgPSBQci5jYWxsKGUpKSwgZSA9IGUuc291cmNlKSwgSHIgJiYgKG4gPSAhIXQgJiYgdC5pbmRleE9mKCJ5IikgPiAtMSkgJiYgKHQgPSB0LnJlcGxhY2UoL3kvZywgIiIpKTsKICAgIHZhciBvID0gWGkoVXIgPyBuZXcgX3IoZSwgdCkgOiBfcihlLCB0KSwgaSA/IHRoaXMgOiBEciwgQnIpOwogICAgcmV0dXJuIEhyICYmIG4gJiYganIobywgewogICAgICBzdGlja3k6IG4KICAgIH0pLCBvOwogIH0sIFZyID0gZnVuY3Rpb24gVnIoZSkgewogICAgKGUgaW4gQnIpIHx8IE5yKEJyLCBlLCB7CiAgICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiBfcltlXTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodCkgewogICAgICAgIF9yW2VdID0gdDsKICAgICAgfQogICAgfSk7CiAgfSwgenIgPSBNcihfciksIFdyID0gMDsgenIubGVuZ3RoID4gV3I7KSB7CiAgICBWcih6cltXcisrXSk7CiAgfQoKICBEci5jb25zdHJ1Y3RvciA9IEJyLCBCci5wcm90b3R5cGUgPSBEciwgcmUoYSwgIlJlZ0V4cCIsIEJyKTsKfQoKIWZ1bmN0aW9uIChlKSB7CiAgdmFyIG4gPSBzZShlKSwKICAgICAgaSA9IHAuZjsKICB0ICYmIG4gJiYgIW5bTHJdICYmIGkobiwgTHIsIHsKICAgIGNvbmZpZ3VyYWJsZTogITAsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgfSk7Cn0oIlJlZ0V4cCIpOwoKdmFyICRyID0gUmVnRXhwLnByb3RvdHlwZS5leGVjLAogICAgS3IgPSBTdHJpbmcucHJvdG90eXBlLnJlcGxhY2UsCiAgICBZciA9ICRyLAogICAgR3IgPSBmdW5jdGlvbiAoKSB7CiAgdmFyIGUgPSAvYS8sCiAgICAgIHQgPSAvYiovZzsKICByZXR1cm4gJHIuY2FsbChlLCAiYSIpLCAkci5jYWxsKHQsICJhIiksIDAgIT09IGUubGFzdEluZGV4IHx8IDAgIT09IHQubGFzdEluZGV4Owp9KCksCiAgICBYciA9IElyLlVOU1VQUE9SVEVEX1kgfHwgSXIuQlJPS0VOX0NBUkVULAogICAgUXIgPSB2b2lkIDAgIT09IC8oKT8/Ly5leGVjKCIiKVsxXTsKCihHciB8fCBRciB8fCBYcikgJiYgKFlyID0gZnVuY3Rpb24gWXIoZSkgewogIHZhciB0LAogICAgICBuLAogICAgICBpLAogICAgICByLAogICAgICBhID0gdGhpcywKICAgICAgbyA9IFhyICYmIGEuc3RpY2t5LAogICAgICBzID0gUHIuY2FsbChhKSwKICAgICAgbCA9IGEuc291cmNlLAogICAgICBjID0gMCwKICAgICAgdSA9IGU7CiAgcmV0dXJuIG8gJiYgKC0xID09PSAocyA9IHMucmVwbGFjZSgieSIsICIiKSkuaW5kZXhPZigiZyIpICYmIChzICs9ICJnIiksIHUgPSBTdHJpbmcoZSkuc2xpY2UoYS5sYXN0SW5kZXgpLCBhLmxhc3RJbmRleCA+IDAgJiYgKCFhLm11bHRpbGluZSB8fCBhLm11bHRpbGluZSAmJiAiXG4iICE9PSBlW2EubGFzdEluZGV4IC0gMV0pICYmIChsID0gIig/OiAiICsgbCArICIpIiwgdSA9ICIgIiArIHUsIGMrKyksIG4gPSBuZXcgUmVnRXhwKCJeKD86IiArIGwgKyAiKSIsIHMpKSwgUXIgJiYgKG4gPSBuZXcgUmVnRXhwKCJeIiArIGwgKyAiJCg/IVxccykiLCBzKSksIEdyICYmICh0ID0gYS5sYXN0SW5kZXgpLCBpID0gJHIuY2FsbChvID8gbiA6IGEsIHUpLCBvID8gaSA/IChpLmlucHV0ID0gaS5pbnB1dC5zbGljZShjKSwgaVswXSA9IGlbMF0uc2xpY2UoYyksIGkuaW5kZXggPSBhLmxhc3RJbmRleCwgYS5sYXN0SW5kZXggKz0gaVswXS5sZW5ndGgpIDogYS5sYXN0SW5kZXggPSAwIDogR3IgJiYgaSAmJiAoYS5sYXN0SW5kZXggPSBhLmdsb2JhbCA/IGkuaW5kZXggKyBpWzBdLmxlbmd0aCA6IHQpLCBRciAmJiBpICYmIGkubGVuZ3RoID4gMSAmJiBLci5jYWxsKGlbMF0sIG4sIGZ1bmN0aW9uICgpIHsKICAgIGZvciAociA9IDE7IHIgPCBhcmd1bWVudHMubGVuZ3RoIC0gMjsgcisrKSB7CiAgICAgIHZvaWQgMCA9PT0gYXJndW1lbnRzW3JdICYmIChpW3JdID0gdm9pZCAwKTsKICAgIH0KICB9KSwgaTsKfSk7CnZhciBKciA9IFlyOwpqZSh7CiAgdGFyZ2V0OiAiUmVnRXhwIiwKICBwcm90bzogITAsCiAgZm9yY2VkOiAvLi8uZXhlYyAhPT0gSnIKfSwgewogIGV4ZWM6IEpyCn0pOwp2YXIgWnIgPSBSZWdFeHAucHJvdG90eXBlLAogICAgZWEgPSBaci50b1N0cmluZywKICAgIHRhID0gZShmdW5jdGlvbiAoKSB7CiAgcmV0dXJuICIvYS9iIiAhPSBlYS5jYWxsKHsKICAgIHNvdXJjZTogImEiLAogICAgZmxhZ3M6ICJiIgogIH0pOwp9KSwKICAgIG5hID0gInRvU3RyaW5nIiAhPSBlYS5uYW1lOwoodGEgfHwgbmEpICYmIHJlKFJlZ0V4cC5wcm90b3R5cGUsICJ0b1N0cmluZyIsIGZ1bmN0aW9uICgpIHsKICB2YXIgZSA9IGgodGhpcyksCiAgICAgIHQgPSBTdHJpbmcoZS5zb3VyY2UpLAogICAgICBuID0gZS5mbGFnczsKICByZXR1cm4gIi8iICsgdCArICIvIiArIFN0cmluZyh2b2lkIDAgPT09IG4gJiYgZSBpbnN0YW5jZW9mIFJlZ0V4cCAmJiAhKCJmbGFncyIgaW4gWnIpID8gUHIuY2FsbChlKSA6IG4pOwp9LCB7CiAgdW5zYWZlOiAhMAp9KTsKCnZhciBpYSA9IGZ1bmN0aW9uIGlhKGUpIHsKICBpZiAoQ3IoZSkpIHRocm93IFR5cGVFcnJvcigiVGhlIG1ldGhvZCBkb2Vzbid0IGFjY2VwdCByZWd1bGFyIGV4cHJlc3Npb25zIik7CiAgcmV0dXJuIGU7Cn0sCiAgICByYSA9IGV0KCJtYXRjaCIpLAogICAgYWEgPSBmdW5jdGlvbiBhYShlKSB7CiAgdmFyIHQgPSAvLi87CgogIHRyeSB7CiAgICAiLy4vIltlXSh0KTsKICB9IGNhdGNoIChuKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gdFtyYV0gPSAhMSwgIi8uLyJbZV0odCk7CiAgICB9IGNhdGNoIChlKSB7fQogIH0KCiAgcmV0dXJuICExOwp9OwoKamUoewogIHRhcmdldDogIlN0cmluZyIsCiAgcHJvdG86ICEwLAogIGZvcmNlZDogIWFhKCJpbmNsdWRlcyIpCn0sIHsKICBpbmNsdWRlczogZnVuY3Rpb24gaW5jbHVkZXMoZSkgewogICAgcmV0dXJuICEhflN0cmluZyhDKHRoaXMpKS5pbmRleE9mKGlhKGUpLCBhcmd1bWVudHMubGVuZ3RoID4gMSA/IGFyZ3VtZW50c1sxXSA6IHZvaWQgMCk7CiAgfQp9KTsKCnZhciBvYSwKICAgIHNhLAogICAgbGEsCiAgICBjYSA9IGZ1bmN0aW9uIGNhKGUpIHsKICByZXR1cm4gZnVuY3Rpb24gKHQsIG4pIHsKICAgIHZhciBpLAogICAgICAgIHIsCiAgICAgICAgYSA9IFN0cmluZyhDKHQpKSwKICAgICAgICBvID0gdWUobiksCiAgICAgICAgcyA9IGEubGVuZ3RoOwogICAgcmV0dXJuIG8gPCAwIHx8IG8gPj0gcyA/IGUgPyAiIiA6IHZvaWQgMCA6IChpID0gYS5jaGFyQ29kZUF0KG8pKSA8IDU1Mjk2IHx8IGkgPiA1NjMxOSB8fCBvICsgMSA9PT0gcyB8fCAociA9IGEuY2hhckNvZGVBdChvICsgMSkpIDwgNTYzMjAgfHwgciA+IDU3MzQzID8gZSA/IGEuY2hhckF0KG8pIDogaSA6IGUgPyBhLnNsaWNlKG8sIG8gKyAyKSA6IHIgLSA1NjMyMCArIChpIC0gNTUyOTYgPDwgMTApICsgNjU1MzY7CiAgfTsKfSwKICAgIHVhID0gewogIGNvZGVBdDogY2EoITEpLAogIGNoYXJBdDogY2EoITApCn0sCiAgICBoYSA9ICFlKGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBlKCkge30KCiAgcmV0dXJuIGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gbnVsbCwgT2JqZWN0LmdldFByb3RvdHlwZU9mKG5ldyBlKCkpICE9PSBlLnByb3RvdHlwZTsKfSksCiAgICBkYSA9IFkoIklFX1BST1RPIiksCiAgICBmYSA9IE9iamVjdC5wcm90b3R5cGUsCiAgICBwYSA9IGhhID8gT2JqZWN0LmdldFByb3RvdHlwZU9mIDogZnVuY3Rpb24gKGUpIHsKICByZXR1cm4gZSA9IEZlKGUpLCBJKGUsIGRhKSA/IGVbZGFdIDogImZ1bmN0aW9uIiA9PSB0eXBlb2YgZS5jb25zdHJ1Y3RvciAmJiBlIGluc3RhbmNlb2YgZS5jb25zdHJ1Y3RvciA/IGUuY29uc3RydWN0b3IucHJvdG90eXBlIDogZSBpbnN0YW5jZW9mIE9iamVjdCA/IGZhIDogbnVsbDsKfSwKICAgIG1hID0gZXQoIml0ZXJhdG9yIiksCiAgICBnYSA9ICExOwoKW10ua2V5cyAmJiAoIm5leHQiIGluIChsYSA9IFtdLmtleXMoKSkgPyAoc2EgPSBwYShwYShsYSkpKSAhPT0gT2JqZWN0LnByb3RvdHlwZSAmJiAob2EgPSBzYSkgOiBnYSA9ICEwKSwgbnVsbCA9PSBvYSAmJiAob2EgPSB7fSksIEkob2EsIG1hKSB8fCBNKG9hLCBtYSwgZnVuY3Rpb24gKCkgewogIHJldHVybiB0aGlzOwp9KTsKCnZhciB2YSA9IHsKICBJdGVyYXRvclByb3RvdHlwZTogb2EsCiAgQlVHR1lfU0FGQVJJX0lURVJBVE9SUzogZ2EKfSwKICAgIHlhID0gdmEuSXRlcmF0b3JQcm90b3R5cGUsCiAgICBiYSA9IGZ1bmN0aW9uIGJhKCkgewogIHJldHVybiB0aGlzOwp9LAogICAgd2EgPSBmdW5jdGlvbiB3YShlLCB0LCBuKSB7CiAgdmFyIGkgPSB0ICsgIiBJdGVyYXRvciI7CiAgcmV0dXJuIGUucHJvdG90eXBlID0gJGUoeWEsIHsKICAgIG5leHQ6IFQoMSwgbikKICB9KSwgb3QoZSwgaSwgITEpLCBLbltpXSA9IGJhLCBlOwp9LAogICAga2EgPSB2YS5JdGVyYXRvclByb3RvdHlwZSwKICAgIFRhID0gdmEuQlVHR1lfU0FGQVJJX0lURVJBVE9SUywKICAgIFNhID0gZXQoIml0ZXJhdG9yIiksCiAgICBFYSA9IGZ1bmN0aW9uIEVhKCkgewogIHJldHVybiB0aGlzOwp9LAogICAgQWEgPSBmdW5jdGlvbiBBYShlLCB0LCBuLCBpLCByLCBhLCBvKSB7CiAgd2EobiwgdCwgaSk7CgogIHZhciBzLAogICAgICBsLAogICAgICBjLAogICAgICB1ID0gZnVuY3Rpb24gdShlKSB7CiAgICBpZiAoZSA9PT0gciAmJiBtKSByZXR1cm4gbTsKICAgIGlmICghVGEgJiYgZSBpbiBmKSByZXR1cm4gZltlXTsKCiAgICBzd2l0Y2ggKGUpIHsKICAgICAgY2FzZSAia2V5cyI6CiAgICAgIGNhc2UgInZhbHVlcyI6CiAgICAgIGNhc2UgImVudHJpZXMiOgogICAgICAgIHJldHVybiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gbmV3IG4odGhpcywgZSk7CiAgICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gbmV3IG4odGhpcyk7CiAgICB9OwogIH0sCiAgICAgIGggPSB0ICsgIiBJdGVyYXRvciIsCiAgICAgIGQgPSAhMSwKICAgICAgZiA9IGUucHJvdG90eXBlLAogICAgICBwID0gZltTYV0gfHwgZlsiQEBpdGVyYXRvciJdIHx8IHIgJiYgZltyXSwKICAgICAgbSA9ICFUYSAmJiBwIHx8IHUociksCiAgICAgIGcgPSAiQXJyYXkiID09IHQgJiYgZi5lbnRyaWVzIHx8IHA7CgogIGlmIChnICYmIChzID0gcGEoZy5jYWxsKG5ldyBlKCkpKSwga2EgIT09IE9iamVjdC5wcm90b3R5cGUgJiYgcy5uZXh0ICYmIChwYShzKSAhPT0ga2EgJiYgKEdpID8gR2kocywga2EpIDogImZ1bmN0aW9uIiAhPSB0eXBlb2Ygc1tTYV0gJiYgTShzLCBTYSwgRWEpKSwgb3QocywgaCwgITApKSksICJ2YWx1ZXMiID09IHIgJiYgcCAmJiAidmFsdWVzIiAhPT0gcC5uYW1lICYmIChkID0gITAsIG0gPSBmdW5jdGlvbiBtKCkgewogICAgcmV0dXJuIHAuY2FsbCh0aGlzKTsKICB9KSwgZltTYV0gIT09IG0gJiYgTShmLCBTYSwgbSksIEtuW3RdID0gbSwgcikgaWYgKGwgPSB7CiAgICB2YWx1ZXM6IHUoInZhbHVlcyIpLAogICAga2V5czogYSA/IG0gOiB1KCJrZXlzIiksCiAgICBlbnRyaWVzOiB1KCJlbnRyaWVzIikKICB9LCBvKSBmb3IgKGMgaW4gbCkgewogICAgKFRhIHx8IGQgfHwgIShjIGluIGYpKSAmJiByZShmLCBjLCBsW2NdKTsKICB9IGVsc2UgamUoewogICAgdGFyZ2V0OiB0LAogICAgcHJvdG86ICEwLAogICAgZm9yY2VkOiBUYSB8fCBkCiAgfSwgbCk7CiAgcmV0dXJuIGw7Cn0sCiAgICB4YSA9IHVhLmNoYXJBdCwKICAgIENhID0gaWUuc2V0LAogICAgUGEgPSBpZS5nZXR0ZXJGb3IoIlN0cmluZyBJdGVyYXRvciIpOwoKQWEoU3RyaW5nLCAiU3RyaW5nIiwgZnVuY3Rpb24gKGUpIHsKICBDYSh0aGlzLCB7CiAgICB0eXBlOiAiU3RyaW5nIEl0ZXJhdG9yIiwKICAgIHN0cmluZzogU3RyaW5nKGUpLAogICAgaW5kZXg6IDAKICB9KTsKfSwgZnVuY3Rpb24gKCkgewogIHZhciBlLAogICAgICB0ID0gUGEodGhpcyksCiAgICAgIG4gPSB0LnN0cmluZywKICAgICAgaSA9IHQuaW5kZXg7CiAgcmV0dXJuIGkgPj0gbi5sZW5ndGggPyB7CiAgICB2YWx1ZTogdm9pZCAwLAogICAgZG9uZTogITAKICB9IDogKGUgPSB4YShuLCBpKSwgdC5pbmRleCArPSBlLmxlbmd0aCwgewogICAgdmFsdWU6IGUsCiAgICBkb25lOiAhMQogIH0pOwp9KTsKCnZhciBPYSA9IGV0KCJzcGVjaWVzIiksCiAgICBJYSA9ICFlKGZ1bmN0aW9uICgpIHsKICB2YXIgZSA9IC8uLzsKICByZXR1cm4gZS5leGVjID0gZnVuY3Rpb24gKCkgewogICAgdmFyIGUgPSBbXTsKICAgIHJldHVybiBlLmdyb3VwcyA9IHsKICAgICAgYTogIjciCiAgICB9LCBlOwogIH0sICI3IiAhPT0gIiIucmVwbGFjZShlLCAiJDxhPiIpOwp9KSwKICAgIExhID0gIiQwIiA9PT0gImEiLnJlcGxhY2UoLy4vLCAiJDAiKSwKICAgIE5hID0gZXQoInJlcGxhY2UiKSwKICAgIE1hID0gISEvLi9bTmFdICYmICIiID09PSAvLi9bTmFdKCJhIiwgIiQwIiksCiAgICBqYSA9ICFlKGZ1bmN0aW9uICgpIHsKICB2YXIgZSA9IC8oPzopLywKICAgICAgdCA9IGUuZXhlYzsKCiAgZS5leGVjID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICB2YXIgbiA9ICJhYiIuc3BsaXQoZSk7CiAgcmV0dXJuIDIgIT09IG4ubGVuZ3RoIHx8ICJhIiAhPT0gblswXSB8fCAiYiIgIT09IG5bMV07Cn0pLAogICAgUmEgPSBmdW5jdGlvbiBSYSh0LCBuLCBpLCByKSB7CiAgdmFyIGEgPSBldCh0KSwKICAgICAgbyA9ICFlKGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0ge307CiAgICByZXR1cm4gZVthXSA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIDc7CiAgICB9LCA3ICE9ICIiW3RdKGUpOwogIH0pLAogICAgICBzID0gbyAmJiAhZShmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9ICExLAogICAgICAgIG4gPSAvYS87CiAgICByZXR1cm4gInNwbGl0IiA9PT0gdCAmJiAoKG4gPSB7fSkuY29uc3RydWN0b3IgPSB7fSwgbi5jb25zdHJ1Y3RvcltPYV0gPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuOwogICAgfSwgbi5mbGFncyA9ICIiLCBuW2FdID0gLy4vW2FdKSwgbi5leGVjID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gZSA9ICEwLCBudWxsOwogICAgfSwgblthXSgiIiksICFlOwogIH0pOwoKICBpZiAoIW8gfHwgIXMgfHwgInJlcGxhY2UiID09PSB0ICYmICghSWEgfHwgIUxhIHx8IE1hKSB8fCAic3BsaXQiID09PSB0ICYmICFqYSkgewogICAgdmFyIGwgPSAvLi9bYV0sCiAgICAgICAgYyA9IGkoYSwgIiJbdF0sIGZ1bmN0aW9uIChlLCB0LCBuLCBpLCByKSB7CiAgICAgIHJldHVybiB0LmV4ZWMgPT09IEpyID8gbyAmJiAhciA/IHsKICAgICAgICBkb25lOiAhMCwKICAgICAgICB2YWx1ZTogbC5jYWxsKHQsIG4sIGkpCiAgICAgIH0gOiB7CiAgICAgICAgZG9uZTogITAsCiAgICAgICAgdmFsdWU6IGUuY2FsbChuLCB0LCBpKQogICAgICB9IDogewogICAgICAgIGRvbmU6ICExCiAgICAgIH07CiAgICB9LCB7CiAgICAgIFJFUExBQ0VfS0VFUFNfJDA6IExhLAogICAgICBSRUdFWFBfUkVQTEFDRV9TVUJTVElUVVRFU19VTkRFRklORURfQ0FQVFVSRTogTWEKICAgIH0pLAogICAgICAgIHUgPSBjWzBdLAogICAgICAgIGggPSBjWzFdOwogICAgcmUoU3RyaW5nLnByb3RvdHlwZSwgdCwgdSksIHJlKFJlZ0V4cC5wcm90b3R5cGUsIGEsIDIgPT0gbiA/IGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgIHJldHVybiBoLmNhbGwoZSwgdGhpcywgdCk7CiAgICB9IDogZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIGguY2FsbChlLCB0aGlzKTsKICAgIH0pOwogIH0KCiAgciAmJiBNKFJlZ0V4cC5wcm90b3R5cGVbYV0sICJzaGFtIiwgITApOwp9LAogICAgX2EgPSB1YS5jaGFyQXQsCiAgICBEYSA9IGZ1bmN0aW9uIERhKGUsIHQsIG4pIHsKICByZXR1cm4gdCArIChuID8gX2EoZSwgdCkubGVuZ3RoIDogMSk7Cn0sCiAgICBGYSA9IGZ1bmN0aW9uIEZhKGUsIHQpIHsKICB2YXIgbiA9IGUuZXhlYzsKCiAgaWYgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIG4pIHsKICAgIHZhciBpID0gbi5jYWxsKGUsIHQpOwogICAgaWYgKCJvYmplY3QiICE9IF90eXBlb2YoaSkpIHRocm93IFR5cGVFcnJvcigiUmVnRXhwIGV4ZWMgbWV0aG9kIHJldHVybmVkIHNvbWV0aGluZyBvdGhlciB0aGFuIGFuIE9iamVjdCBvciBudWxsIik7CiAgICByZXR1cm4gaTsKICB9CgogIGlmICgiUmVnRXhwIiAhPT0gRShlKSkgdGhyb3cgVHlwZUVycm9yKCJSZWdFeHAjZXhlYyBjYWxsZWQgb24gaW5jb21wYXRpYmxlIHJlY2VpdmVyIik7CiAgcmV0dXJuIEpyLmNhbGwoZSwgdCk7Cn07CgpSYSgibWF0Y2giLCAxLCBmdW5jdGlvbiAoZSwgdCwgbikgewogIHJldHVybiBbZnVuY3Rpb24gKHQpIHsKICAgIHZhciBuID0gQyh0aGlzKSwKICAgICAgICBpID0gbnVsbCA9PSB0ID8gdm9pZCAwIDogdFtlXTsKICAgIHJldHVybiB2b2lkIDAgIT09IGkgPyBpLmNhbGwodCwgbikgOiBuZXcgUmVnRXhwKHQpW2VdKFN0cmluZyhuKSk7CiAgfSwgZnVuY3Rpb24gKGUpIHsKICAgIHZhciBpID0gbih0LCBlLCB0aGlzKTsKICAgIGlmIChpLmRvbmUpIHJldHVybiBpLnZhbHVlOwogICAgdmFyIHIgPSBoKGUpLAogICAgICAgIGEgPSBTdHJpbmcodGhpcyk7CiAgICBpZiAoIXIuZ2xvYmFsKSByZXR1cm4gRmEociwgYSk7CiAgICB2YXIgbyA9IHIudW5pY29kZTsKICAgIHIubGFzdEluZGV4ID0gMDsKCiAgICBmb3IgKHZhciBzLCBsID0gW10sIGMgPSAwOyBudWxsICE9PSAocyA9IEZhKHIsIGEpKTspIHsKICAgICAgdmFyIHUgPSBTdHJpbmcoc1swXSk7CiAgICAgIGxbY10gPSB1LCAiIiA9PT0gdSAmJiAoci5sYXN0SW5kZXggPSBEYShhLCBkZShyLmxhc3RJbmRleCksIG8pKSwgYysrOwogICAgfQoKICAgIHJldHVybiAwID09PSBjID8gbnVsbCA6IGw7CiAgfV07Cn0pOwp2YXIgcWEgPSBNYXRoLm1heCwKICAgIFVhID0gTWF0aC5taW4sCiAgICBIYSA9IE1hdGguZmxvb3IsCiAgICBCYSA9IC9cJChbJCYnYF18XGRcZD98PFtePl0qPikvZywKICAgIFZhID0gL1wkKFskJidgXXxcZFxkPykvZzsKUmEoInJlcGxhY2UiLCAyLCBmdW5jdGlvbiAoZSwgdCwgbiwgaSkgewogIHZhciByID0gaS5SRUdFWFBfUkVQTEFDRV9TVUJTVElUVVRFU19VTkRFRklORURfQ0FQVFVSRSwKICAgICAgYSA9IGkuUkVQTEFDRV9LRUVQU18kMCwKICAgICAgbyA9IHIgPyAiJCIgOiAiJDAiOwogIHJldHVybiBbZnVuY3Rpb24gKG4sIGkpIHsKICAgIHZhciByID0gQyh0aGlzKSwKICAgICAgICBhID0gbnVsbCA9PSBuID8gdm9pZCAwIDogbltlXTsKICAgIHJldHVybiB2b2lkIDAgIT09IGEgPyBhLmNhbGwobiwgciwgaSkgOiB0LmNhbGwoU3RyaW5nKHIpLCBuLCBpKTsKICB9LCBmdW5jdGlvbiAoZSwgaSkgewogICAgaWYgKCFyICYmIGEgfHwgInN0cmluZyIgPT0gdHlwZW9mIGkgJiYgLTEgPT09IGkuaW5kZXhPZihvKSkgewogICAgICB2YXIgbCA9IG4odCwgZSwgdGhpcywgaSk7CiAgICAgIGlmIChsLmRvbmUpIHJldHVybiBsLnZhbHVlOwogICAgfQoKICAgIHZhciBjID0gaChlKSwKICAgICAgICB1ID0gU3RyaW5nKHRoaXMpLAogICAgICAgIGQgPSAiZnVuY3Rpb24iID09IHR5cGVvZiBpOwogICAgZCB8fCAoaSA9IFN0cmluZyhpKSk7CiAgICB2YXIgZiA9IGMuZ2xvYmFsOwoKICAgIGlmIChmKSB7CiAgICAgIHZhciBwID0gYy51bmljb2RlOwogICAgICBjLmxhc3RJbmRleCA9IDA7CiAgICB9CgogICAgZm9yICh2YXIgbSA9IFtdOzspIHsKICAgICAgdmFyIGcgPSBGYShjLCB1KTsKICAgICAgaWYgKG51bGwgPT09IGcpIGJyZWFrOwogICAgICBpZiAobS5wdXNoKGcpLCAhZikgYnJlYWs7CiAgICAgICIiID09PSBTdHJpbmcoZ1swXSkgJiYgKGMubGFzdEluZGV4ID0gRGEodSwgZGUoYy5sYXN0SW5kZXgpLCBwKSk7CiAgICB9CgogICAgZm9yICh2YXIgdiwgeSA9ICIiLCBiID0gMCwgdyA9IDA7IHcgPCBtLmxlbmd0aDsgdysrKSB7CiAgICAgIGcgPSBtW3ddOwoKICAgICAgZm9yICh2YXIgayA9IFN0cmluZyhnWzBdKSwgVCA9IHFhKFVhKHVlKGcuaW5kZXgpLCB1Lmxlbmd0aCksIDApLCBTID0gW10sIEUgPSAxOyBFIDwgZy5sZW5ndGg7IEUrKykgewogICAgICAgIFMucHVzaCh2b2lkIDAgPT09ICh2ID0gZ1tFXSkgPyB2IDogU3RyaW5nKHYpKTsKICAgICAgfQoKICAgICAgdmFyIEEgPSBnLmdyb3VwczsKCiAgICAgIGlmIChkKSB7CiAgICAgICAgdmFyIHggPSBba10uY29uY2F0KFMsIFQsIHUpOwogICAgICAgIHZvaWQgMCAhPT0gQSAmJiB4LnB1c2goQSk7CiAgICAgICAgdmFyIEMgPSBTdHJpbmcoaS5hcHBseSh2b2lkIDAsIHgpKTsKICAgICAgfSBlbHNlIEMgPSBzKGssIHUsIFQsIFMsIEEsIGkpOwoKICAgICAgVCA+PSBiICYmICh5ICs9IHUuc2xpY2UoYiwgVCkgKyBDLCBiID0gVCArIGsubGVuZ3RoKTsKICAgIH0KCiAgICByZXR1cm4geSArIHUuc2xpY2UoYik7CiAgfV07CgogIGZ1bmN0aW9uIHMoZSwgbiwgaSwgciwgYSwgbykgewogICAgdmFyIHMgPSBpICsgZS5sZW5ndGgsCiAgICAgICAgbCA9IHIubGVuZ3RoLAogICAgICAgIGMgPSBWYTsKICAgIHJldHVybiB2b2lkIDAgIT09IGEgJiYgKGEgPSBGZShhKSwgYyA9IEJhKSwgdC5jYWxsKG8sIGMsIGZ1bmN0aW9uICh0LCBvKSB7CiAgICAgIHZhciBjOwoKICAgICAgc3dpdGNoIChvLmNoYXJBdCgwKSkgewogICAgICAgIGNhc2UgIiQiOgogICAgICAgICAgcmV0dXJuICIkIjsKCiAgICAgICAgY2FzZSAiJiI6CiAgICAgICAgICByZXR1cm4gZTsKCiAgICAgICAgY2FzZSAiYCI6CiAgICAgICAgICByZXR1cm4gbi5zbGljZSgwLCBpKTsKCiAgICAgICAgY2FzZSAiJyI6CiAgICAgICAgICByZXR1cm4gbi5zbGljZShzKTsKCiAgICAgICAgY2FzZSAiPCI6CiAgICAgICAgICBjID0gYVtvLnNsaWNlKDEsIC0xKV07CiAgICAgICAgICBicmVhazsKCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIHZhciB1ID0gK287CiAgICAgICAgICBpZiAoMCA9PT0gdSkgcmV0dXJuIHQ7CgogICAgICAgICAgaWYgKHUgPiBsKSB7CiAgICAgICAgICAgIHZhciBoID0gSGEodSAvIDEwKTsKICAgICAgICAgICAgcmV0dXJuIDAgPT09IGggPyB0IDogaCA8PSBsID8gdm9pZCAwID09PSByW2ggLSAxXSA/IG8uY2hhckF0KDEpIDogcltoIC0gMV0gKyBvLmNoYXJBdCgxKSA6IHQ7CiAgICAgICAgICB9CgogICAgICAgICAgYyA9IHJbdSAtIDFdOwogICAgICB9CgogICAgICByZXR1cm4gdm9pZCAwID09PSBjID8gIiIgOiBjOwogICAgfSk7CiAgfQp9KTsKCnZhciB6YSA9IE9iamVjdC5pcyB8fCBmdW5jdGlvbiAoZSwgdCkgewogIHJldHVybiBlID09PSB0ID8gMCAhPT0gZSB8fCAxIC8gZSA9PSAxIC8gdCA6IGUgIT0gZSAmJiB0ICE9IHQ7Cn07CgpSYSgic2VhcmNoIiwgMSwgZnVuY3Rpb24gKGUsIHQsIG4pIHsKICByZXR1cm4gW2Z1bmN0aW9uICh0KSB7CiAgICB2YXIgbiA9IEModGhpcyksCiAgICAgICAgaSA9IG51bGwgPT0gdCA/IHZvaWQgMCA6IHRbZV07CiAgICByZXR1cm4gdm9pZCAwICE9PSBpID8gaS5jYWxsKHQsIG4pIDogbmV3IFJlZ0V4cCh0KVtlXShTdHJpbmcobikpOwogIH0sIGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgaSA9IG4odCwgZSwgdGhpcyk7CiAgICBpZiAoaS5kb25lKSByZXR1cm4gaS52YWx1ZTsKICAgIHZhciByID0gaChlKSwKICAgICAgICBhID0gU3RyaW5nKHRoaXMpLAogICAgICAgIG8gPSByLmxhc3RJbmRleDsKICAgIHphKG8sIDApIHx8IChyLmxhc3RJbmRleCA9IDApOwogICAgdmFyIHMgPSBGYShyLCBhKTsKICAgIHJldHVybiB6YShyLmxhc3RJbmRleCwgbykgfHwgKHIubGFzdEluZGV4ID0gbyksIG51bGwgPT09IHMgPyAtMSA6IHMuaW5kZXg7CiAgfV07Cn0pOwp2YXIgV2EgPSBldCgic3BlY2llcyIpLAogICAgJGEgPSBbXS5wdXNoLAogICAgS2EgPSBNYXRoLm1pbiwKICAgIFlhID0gIWUoZnVuY3Rpb24gKCkgewogIHJldHVybiAhUmVnRXhwKDQyOTQ5NjcyOTUsICJ5Iik7Cn0pOwpSYSgic3BsaXQiLCAyLCBmdW5jdGlvbiAoZSwgdCwgbikgewogIHZhciBpOwogIHJldHVybiBpID0gImMiID09ICJhYmJjIi5zcGxpdCgvKGIpKi8pWzFdIHx8IDQgIT0gInRlc3QiLnNwbGl0KC8oPzopLywgLTEpLmxlbmd0aCB8fCAyICE9ICJhYiIuc3BsaXQoLyg/OmFiKSovKS5sZW5ndGggfHwgNCAhPSAiLiIuc3BsaXQoLyguPykoLj8pLykubGVuZ3RoIHx8ICIuIi5zcGxpdCgvKCkoKS8pLmxlbmd0aCA+IDEgfHwgIiIuc3BsaXQoLy4/LykubGVuZ3RoID8gZnVuY3Rpb24gKGUsIG4pIHsKICAgIHZhciBpID0gU3RyaW5nKEModGhpcykpLAogICAgICAgIHIgPSB2b2lkIDAgPT09IG4gPyA0Mjk0OTY3Mjk1IDogbiA+Pj4gMDsKICAgIGlmICgwID09PSByKSByZXR1cm4gW107CiAgICBpZiAodm9pZCAwID09PSBlKSByZXR1cm4gW2ldOwogICAgaWYgKCFDcihlKSkgcmV0dXJuIHQuY2FsbChpLCBlLCByKTsKCiAgICBmb3IgKHZhciBhLCBvLCBzLCBsID0gW10sIGMgPSAoZS5pZ25vcmVDYXNlID8gImkiIDogIiIpICsgKGUubXVsdGlsaW5lID8gIm0iIDogIiIpICsgKGUudW5pY29kZSA/ICJ1IiA6ICIiKSArIChlLnN0aWNreSA/ICJ5IiA6ICIiKSwgdSA9IDAsIGggPSBuZXcgUmVnRXhwKGUuc291cmNlLCBjICsgImciKTsgKGEgPSBKci5jYWxsKGgsIGkpKSAmJiAhKChvID0gaC5sYXN0SW5kZXgpID4gdSAmJiAobC5wdXNoKGkuc2xpY2UodSwgYS5pbmRleCkpLCBhLmxlbmd0aCA+IDEgJiYgYS5pbmRleCA8IGkubGVuZ3RoICYmICRhLmFwcGx5KGwsIGEuc2xpY2UoMSkpLCBzID0gYVswXS5sZW5ndGgsIHUgPSBvLCBsLmxlbmd0aCA+PSByKSk7KSB7CiAgICAgIGgubGFzdEluZGV4ID09PSBhLmluZGV4ICYmIGgubGFzdEluZGV4Kys7CiAgICB9CgogICAgcmV0dXJuIHUgPT09IGkubGVuZ3RoID8gIXMgJiYgaC50ZXN0KCIiKSB8fCBsLnB1c2goIiIpIDogbC5wdXNoKGkuc2xpY2UodSkpLCBsLmxlbmd0aCA+IHIgPyBsLnNsaWNlKDAsIHIpIDogbDsKICB9IDogIjAiLnNwbGl0KHZvaWQgMCwgMCkubGVuZ3RoID8gZnVuY3Rpb24gKGUsIG4pIHsKICAgIHJldHVybiB2b2lkIDAgPT09IGUgJiYgMCA9PT0gbiA/IFtdIDogdC5jYWxsKHRoaXMsIGUsIG4pOwogIH0gOiB0LCBbZnVuY3Rpb24gKHQsIG4pIHsKICAgIHZhciByID0gQyh0aGlzKSwKICAgICAgICBhID0gbnVsbCA9PSB0ID8gdm9pZCAwIDogdFtlXTsKICAgIHJldHVybiB2b2lkIDAgIT09IGEgPyBhLmNhbGwodCwgciwgbikgOiBpLmNhbGwoU3RyaW5nKHIpLCB0LCBuKTsKICB9LCBmdW5jdGlvbiAoZSwgcikgewogICAgdmFyIGEgPSBuKGksIGUsIHRoaXMsIHIsIGkgIT09IHQpOwogICAgaWYgKGEuZG9uZSkgcmV0dXJuIGEudmFsdWU7CgogICAgdmFyIG8gPSBoKGUpLAogICAgICAgIHMgPSBTdHJpbmcodGhpcyksCiAgICAgICAgbCA9IGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgIHZhciBuLAogICAgICAgICAgaSA9IGgoZSkuY29uc3RydWN0b3I7CiAgICAgIHJldHVybiB2b2lkIDAgPT09IGkgfHwgbnVsbCA9PSAobiA9IGgoaSlbV2FdKSA/IHQgOiBzdChuKTsKICAgIH0obywgUmVnRXhwKSwKICAgICAgICBjID0gby51bmljb2RlLAogICAgICAgIHUgPSAoby5pZ25vcmVDYXNlID8gImkiIDogIiIpICsgKG8ubXVsdGlsaW5lID8gIm0iIDogIiIpICsgKG8udW5pY29kZSA/ICJ1IiA6ICIiKSArIChZYSA/ICJ5IiA6ICJnIiksCiAgICAgICAgZCA9IG5ldyBsKFlhID8gbyA6ICJeKD86IiArIG8uc291cmNlICsgIikiLCB1KSwKICAgICAgICBmID0gdm9pZCAwID09PSByID8gNDI5NDk2NzI5NSA6IHIgPj4+IDA7CgogICAgaWYgKDAgPT09IGYpIHJldHVybiBbXTsKICAgIGlmICgwID09PSBzLmxlbmd0aCkgcmV0dXJuIG51bGwgPT09IEZhKGQsIHMpID8gW3NdIDogW107CgogICAgZm9yICh2YXIgcCA9IDAsIG0gPSAwLCBnID0gW107IG0gPCBzLmxlbmd0aDspIHsKICAgICAgZC5sYXN0SW5kZXggPSBZYSA/IG0gOiAwOwogICAgICB2YXIgdiwKICAgICAgICAgIHkgPSBGYShkLCBZYSA/IHMgOiBzLnNsaWNlKG0pKTsKICAgICAgaWYgKG51bGwgPT09IHkgfHwgKHYgPSBLYShkZShkLmxhc3RJbmRleCArIChZYSA/IDAgOiBtKSksIHMubGVuZ3RoKSkgPT09IHApIG0gPSBEYShzLCBtLCBjKTtlbHNlIHsKICAgICAgICBpZiAoZy5wdXNoKHMuc2xpY2UocCwgbSkpLCBnLmxlbmd0aCA9PT0gZikgcmV0dXJuIGc7CgogICAgICAgIGZvciAodmFyIGIgPSAxOyBiIDw9IHkubGVuZ3RoIC0gMTsgYisrKSB7CiAgICAgICAgICBpZiAoZy5wdXNoKHlbYl0pLCBnLmxlbmd0aCA9PT0gZikgcmV0dXJuIGc7CiAgICAgICAgfQoKICAgICAgICBtID0gcCA9IHY7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZy5wdXNoKHMuc2xpY2UocCkpLCBnOwogIH1dOwp9LCAhWWEpOwp2YXIgR2EsCiAgICBYYSA9IE4uZiwKICAgIFFhID0gIiIuc3RhcnRzV2l0aCwKICAgIEphID0gTWF0aC5taW4sCiAgICBaYSA9IGFhKCJzdGFydHNXaXRoIiksCiAgICBlbyA9ICEoWmEgfHwgKEdhID0gWGEoU3RyaW5nLnByb3RvdHlwZSwgInN0YXJ0c1dpdGgiKSwgIUdhIHx8IEdhLndyaXRhYmxlKSk7CmplKHsKICB0YXJnZXQ6ICJTdHJpbmciLAogIHByb3RvOiAhMCwKICBmb3JjZWQ6ICFlbyAmJiAhWmEKfSwgewogIHN0YXJ0c1dpdGg6IGZ1bmN0aW9uIHN0YXJ0c1dpdGgoZSkgewogICAgdmFyIHQgPSBTdHJpbmcoQyh0aGlzKSk7CiAgICBpYShlKTsKICAgIHZhciBuID0gZGUoSmEoYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBhcmd1bWVudHNbMV0gOiB2b2lkIDAsIHQubGVuZ3RoKSksCiAgICAgICAgaSA9IFN0cmluZyhlKTsKICAgIHJldHVybiBRYSA/IFFhLmNhbGwodCwgaSwgbikgOiB0LnNsaWNlKG4sIG4gKyBpLmxlbmd0aCkgPT09IGk7CiAgfQp9KTsKdmFyIHRvID0gbnIudHJpbTsKamUoewogIHRhcmdldDogIlN0cmluZyIsCiAgcHJvdG86ICEwLAogIGZvcmNlZDogZnVuY3Rpb24gKHQpIHsKICAgIHJldHVybiBlKGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuICEhUWlbdF0oKSB8fCAi4oCLwoXhoI4iICE9ICLigIvCheGgjiJbdF0oKSB8fCBRaVt0XS5uYW1lICE9PSB0OwogICAgfSk7CiAgfSgidHJpbSIpCn0sIHsKICB0cmltOiBmdW5jdGlvbiB0cmltKCkgewogICAgcmV0dXJuIHRvKHRoaXMpOwogIH0KfSk7Cgp2YXIgbm8gPSBmdW5jdGlvbiBubyhlLCB0LCBuKSB7CiAgZm9yICh2YXIgaSBpbiB0KSB7CiAgICByZShlLCBpLCB0W2ldLCBuKTsKICB9CgogIHJldHVybiBlOwp9LAogICAgaW8gPSAhZShmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIE9iamVjdC5pc0V4dGVuc2libGUoT2JqZWN0LnByZXZlbnRFeHRlbnNpb25zKHt9KSk7Cn0pLAogICAgcm8gPSBpKGZ1bmN0aW9uIChlKSB7CiAgdmFyIHQgPSBwLmYsCiAgICAgIG4gPSAkKCJtZXRhIiksCiAgICAgIGkgPSAwLAogICAgICByID0gT2JqZWN0LmlzRXh0ZW5zaWJsZSB8fCBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gITA7CiAgfSwKICAgICAgYSA9IGZ1bmN0aW9uIGEoZSkgewogICAgdChlLCBuLCB7CiAgICAgIHZhbHVlOiB7CiAgICAgICAgb2JqZWN0SUQ6ICJPIiArICsraSwKICAgICAgICB3ZWFrRGF0YToge30KICAgICAgfQogICAgfSk7CiAgfSwKICAgICAgcyA9IGUuZXhwb3J0cyA9IHsKICAgIFJFUVVJUkVEOiAhMSwKICAgIGZhc3RLZXk6IGZ1bmN0aW9uIGZhc3RLZXkoZSwgdCkgewogICAgICBpZiAoIW8oZSkpIHJldHVybiAic3ltYm9sIiA9PSBfdHlwZW9mKGUpID8gZSA6ICgic3RyaW5nIiA9PSB0eXBlb2YgZSA/ICJTIiA6ICJQIikgKyBlOwoKICAgICAgaWYgKCFJKGUsIG4pKSB7CiAgICAgICAgaWYgKCFyKGUpKSByZXR1cm4gIkYiOwogICAgICAgIGlmICghdCkgcmV0dXJuICJFIjsKICAgICAgICBhKGUpOwogICAgICB9CgogICAgICByZXR1cm4gZVtuXS5vYmplY3RJRDsKICAgIH0sCiAgICBnZXRXZWFrRGF0YTogZnVuY3Rpb24gZ2V0V2Vha0RhdGEoZSwgdCkgewogICAgICBpZiAoIUkoZSwgbikpIHsKICAgICAgICBpZiAoIXIoZSkpIHJldHVybiAhMDsKICAgICAgICBpZiAoIXQpIHJldHVybiAhMTsKICAgICAgICBhKGUpOwogICAgICB9CgogICAgICByZXR1cm4gZVtuXS53ZWFrRGF0YTsKICAgIH0sCiAgICBvbkZyZWV6ZTogZnVuY3Rpb24gb25GcmVlemUoZSkgewogICAgICByZXR1cm4gaW8gJiYgcy5SRVFVSVJFRCAmJiByKGUpICYmICFJKGUsIG4pICYmIGEoZSksIGU7CiAgICB9CiAgfTsKCiAgR1tuXSA9ICEwOwp9KSwKICAgIGFvID0gaShmdW5jdGlvbiAoZSkgewogIHZhciB0ID0gZnVuY3Rpb24gdChlLCBfdDMpIHsKICAgIHRoaXMuc3RvcHBlZCA9IGUsIHRoaXMucmVzdWx0ID0gX3QzOwogIH07CgogIChlLmV4cG9ydHMgPSBmdW5jdGlvbiAoZSwgbiwgaSwgciwgYSkgewogICAgdmFyIG8sCiAgICAgICAgcywKICAgICAgICBsLAogICAgICAgIGMsCiAgICAgICAgdSwKICAgICAgICBkLAogICAgICAgIGYsCiAgICAgICAgcCA9IGx0KG4sIGksIHIgPyAyIDogMSk7CiAgICBpZiAoYSkgbyA9IGU7ZWxzZSB7CiAgICAgIGlmICgiZnVuY3Rpb24iICE9IHR5cGVvZiAocyA9IGlpKGUpKSkgdGhyb3cgVHlwZUVycm9yKCJUYXJnZXQgaXMgbm90IGl0ZXJhYmxlIik7CgogICAgICBpZiAoWG4ocykpIHsKICAgICAgICBmb3IgKGwgPSAwLCBjID0gZGUoZS5sZW5ndGgpOyBjID4gbDsgbCsrKSB7CiAgICAgICAgICBpZiAoKHUgPSByID8gcChoKGYgPSBlW2xdKVswXSwgZlsxXSkgOiBwKGVbbF0pKSAmJiB1IGluc3RhbmNlb2YgdCkgcmV0dXJuIHU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbmV3IHQoITEpOwogICAgICB9CgogICAgICBvID0gcy5jYWxsKGUpOwogICAgfQoKICAgIGZvciAoZCA9IG8ubmV4dDsgIShmID0gZC5jYWxsKG8pKS5kb25lOykgewogICAgICBpZiAoIm9iamVjdCIgPT0gX3R5cGVvZih1ID0gJG4obywgcCwgZi52YWx1ZSwgcikpICYmIHUgJiYgdSBpbnN0YW5jZW9mIHQpIHJldHVybiB1OwogICAgfQoKICAgIHJldHVybiBuZXcgdCghMSk7CiAgfSkuc3RvcCA9IGZ1bmN0aW9uIChlKSB7CiAgICByZXR1cm4gbmV3IHQoITAsIGUpOwogIH07Cn0pLAogICAgb28gPSBmdW5jdGlvbiBvbyhlLCB0LCBuKSB7CiAgaWYgKCEoZSBpbnN0YW5jZW9mIHQpKSB0aHJvdyBUeXBlRXJyb3IoIkluY29ycmVjdCAiICsgKG4gPyBuICsgIiAiIDogIiIpICsgImludm9jYXRpb24iKTsKICByZXR1cm4gZTsKfSwKICAgIHNvID0gcm8uZ2V0V2Vha0RhdGEsCiAgICBsbyA9IGllLnNldCwKICAgIGNvID0gaWUuZ2V0dGVyRm9yLAogICAgdW8gPSBmdC5maW5kLAogICAgaG8gPSBmdC5maW5kSW5kZXgsCiAgICBmbyA9IDAsCiAgICBwbyA9IGZ1bmN0aW9uIHBvKGUpIHsKICByZXR1cm4gZS5mcm96ZW4gfHwgKGUuZnJvemVuID0gbmV3IG1vKCkpOwp9LAogICAgbW8gPSBmdW5jdGlvbiBtbygpIHsKICB0aGlzLmVudHJpZXMgPSBbXTsKfSwKICAgIGdvID0gZnVuY3Rpb24gZ28oZSwgdCkgewogIHJldHVybiB1byhlLmVudHJpZXMsIGZ1bmN0aW9uIChlKSB7CiAgICByZXR1cm4gZVswXSA9PT0gdDsKICB9KTsKfTsKCm1vLnByb3RvdHlwZSA9IHsKICBnZXQ6IGZ1bmN0aW9uIGdldChlKSB7CiAgICB2YXIgdCA9IGdvKHRoaXMsIGUpOwogICAgaWYgKHQpIHJldHVybiB0WzFdOwogIH0sCiAgaGFzOiBmdW5jdGlvbiBoYXMoZSkgewogICAgcmV0dXJuICEhZ28odGhpcywgZSk7CiAgfSwKICBzZXQ6IGZ1bmN0aW9uIHNldChlLCB0KSB7CiAgICB2YXIgbiA9IGdvKHRoaXMsIGUpOwogICAgbiA/IG5bMV0gPSB0IDogdGhpcy5lbnRyaWVzLnB1c2goW2UsIHRdKTsKICB9LAogIGRlbGV0ZTogZnVuY3Rpb24gX2RlbGV0ZShlKSB7CiAgICB2YXIgdCA9IGhvKHRoaXMuZW50cmllcywgZnVuY3Rpb24gKHQpIHsKICAgICAgcmV0dXJuIHRbMF0gPT09IGU7CiAgICB9KTsKICAgIHJldHVybiB+dCAmJiB0aGlzLmVudHJpZXMuc3BsaWNlKHQsIDEpLCAhIX50OwogIH0KfTsKdmFyIHZvID0gewogIGdldENvbnN0cnVjdG9yOiBmdW5jdGlvbiBnZXRDb25zdHJ1Y3RvcihlLCB0LCBuLCBpKSB7CiAgICB2YXIgciA9IGUoZnVuY3Rpb24gKGUsIGEpIHsKICAgICAgb28oZSwgciwgdCksIGxvKGUsIHsKICAgICAgICB0eXBlOiB0LAogICAgICAgIGlkOiBmbysrLAogICAgICAgIGZyb3plbjogdm9pZCAwCiAgICAgIH0pLCBudWxsICE9IGEgJiYgYW8oYSwgZVtpXSwgZSwgbik7CiAgICB9KSwKICAgICAgICBhID0gY28odCksCiAgICAgICAgcyA9IGZ1bmN0aW9uIHMoZSwgdCwgbikgewogICAgICB2YXIgaSA9IGEoZSksCiAgICAgICAgICByID0gc28oaCh0KSwgITApOwogICAgICByZXR1cm4gITAgPT09IHIgPyBwbyhpKS5zZXQodCwgbikgOiByW2kuaWRdID0gbiwgZTsKICAgIH07CgogICAgcmV0dXJuIG5vKHIucHJvdG90eXBlLCB7CiAgICAgIGRlbGV0ZTogZnVuY3Rpb24gX2RlbGV0ZShlKSB7CiAgICAgICAgdmFyIHQgPSBhKHRoaXMpOwogICAgICAgIGlmICghbyhlKSkgcmV0dXJuICExOwogICAgICAgIHZhciBuID0gc28oZSk7CiAgICAgICAgcmV0dXJuICEwID09PSBuID8gcG8odCkuZGVsZXRlKGUpIDogbiAmJiBJKG4sIHQuaWQpICYmIGRlbGV0ZSBuW3QuaWRdOwogICAgICB9LAogICAgICBoYXM6IGZ1bmN0aW9uIGhhcyhlKSB7CiAgICAgICAgdmFyIHQgPSBhKHRoaXMpOwogICAgICAgIGlmICghbyhlKSkgcmV0dXJuICExOwogICAgICAgIHZhciBuID0gc28oZSk7CiAgICAgICAgcmV0dXJuICEwID09PSBuID8gcG8odCkuaGFzKGUpIDogbiAmJiBJKG4sIHQuaWQpOwogICAgICB9CiAgICB9KSwgbm8oci5wcm90b3R5cGUsIG4gPyB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KGUpIHsKICAgICAgICB2YXIgdCA9IGEodGhpcyk7CgogICAgICAgIGlmIChvKGUpKSB7CiAgICAgICAgICB2YXIgbiA9IHNvKGUpOwogICAgICAgICAgcmV0dXJuICEwID09PSBuID8gcG8odCkuZ2V0KGUpIDogbiA/IG5bdC5pZF0gOiB2b2lkIDA7CiAgICAgICAgfQogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChlLCB0KSB7CiAgICAgICAgcmV0dXJuIHModGhpcywgZSwgdCk7CiAgICAgIH0KICAgIH0gOiB7CiAgICAgIGFkZDogZnVuY3Rpb24gYWRkKGUpIHsKICAgICAgICByZXR1cm4gcyh0aGlzLCBlLCAhMCk7CiAgICAgIH0KICAgIH0pLCByOwogIH0KfSwKICAgIHlvID0gKGkoZnVuY3Rpb24gKHQpIHsKICB2YXIgbiwKICAgICAgaSA9IGllLmVuZm9yY2UsCiAgICAgIHIgPSAhYS5BY3RpdmVYT2JqZWN0ICYmICJBY3RpdmVYT2JqZWN0IiBpbiBhLAogICAgICBzID0gT2JqZWN0LmlzRXh0ZW5zaWJsZSwKICAgICAgbCA9IGZ1bmN0aW9uIGwoZSkgewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGUodGhpcywgYXJndW1lbnRzLmxlbmd0aCA/IGFyZ3VtZW50c1swXSA6IHZvaWQgMCk7CiAgICB9OwogIH0sCiAgICAgIGMgPSB0LmV4cG9ydHMgPSBmdW5jdGlvbiAodCwgbiwgaSkgewogICAgdmFyIHIgPSAtMSAhPT0gdC5pbmRleE9mKCJNYXAiKSwKICAgICAgICBzID0gLTEgIT09IHQuaW5kZXhPZigiV2VhayIpLAogICAgICAgIGwgPSByID8gInNldCIgOiAiYWRkIiwKICAgICAgICBjID0gYVt0XSwKICAgICAgICB1ID0gYyAmJiBjLnByb3RvdHlwZSwKICAgICAgICBoID0gYywKICAgICAgICBkID0ge30sCiAgICAgICAgZiA9IGZ1bmN0aW9uIGYoZSkgewogICAgICB2YXIgdCA9IHVbZV07CiAgICAgIHJlKHUsIGUsICJhZGQiID09IGUgPyBmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiB0LmNhbGwodGhpcywgMCA9PT0gZSA/IDAgOiBlKSwgdGhpczsKICAgICAgfSA6ICJkZWxldGUiID09IGUgPyBmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiAhKHMgJiYgIW8oZSkpICYmIHQuY2FsbCh0aGlzLCAwID09PSBlID8gMCA6IGUpOwogICAgICB9IDogImdldCIgPT0gZSA/IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuIHMgJiYgIW8oZSkgPyB2b2lkIDAgOiB0LmNhbGwodGhpcywgMCA9PT0gZSA/IDAgOiBlKTsKICAgICAgfSA6ICJoYXMiID09IGUgPyBmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiAhKHMgJiYgIW8oZSkpICYmIHQuY2FsbCh0aGlzLCAwID09PSBlID8gMCA6IGUpOwogICAgICB9IDogZnVuY3Rpb24gKGUsIG4pIHsKICAgICAgICByZXR1cm4gdC5jYWxsKHRoaXMsIDAgPT09IGUgPyAwIDogZSwgbiksIHRoaXM7CiAgICAgIH0pOwogICAgfTsKCiAgICBpZiAoTmUodCwgImZ1bmN0aW9uIiAhPSB0eXBlb2YgYyB8fCAhKHMgfHwgdS5mb3JFYWNoICYmICFlKGZ1bmN0aW9uICgpIHsKICAgICAgbmV3IGMoKS5lbnRyaWVzKCkubmV4dCgpOwogICAgfSkpKSkgaCA9IGkuZ2V0Q29uc3RydWN0b3IobiwgdCwgciwgbCksIHJvLlJFUVVJUkVEID0gITA7ZWxzZSBpZiAoTmUodCwgITApKSB7CiAgICAgIHZhciBwID0gbmV3IGgoKSwKICAgICAgICAgIG0gPSBwW2xdKHMgPyB7fSA6IC0wLCAxKSAhPSBwLAogICAgICAgICAgZyA9IGUoZnVuY3Rpb24gKCkgewogICAgICAgIHAuaGFzKDEpOwogICAgICB9KSwKICAgICAgICAgIHYgPSBjaShmdW5jdGlvbiAoZSkgewogICAgICAgIG5ldyBjKGUpOwogICAgICB9KSwKICAgICAgICAgIHkgPSAhcyAmJiBlKGZ1bmN0aW9uICgpIHsKICAgICAgICBmb3IgKHZhciBlID0gbmV3IGMoKSwgdCA9IDU7IHQtLTspIHsKICAgICAgICAgIGVbbF0odCwgdCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gIWUuaGFzKC0wKTsKICAgICAgfSk7CiAgICAgIHYgfHwgKChoID0gbihmdW5jdGlvbiAoZSwgbikgewogICAgICAgIG9vKGUsIGgsIHQpOwogICAgICAgIHZhciBpID0gWGkobmV3IGMoKSwgZSwgaCk7CiAgICAgICAgcmV0dXJuIG51bGwgIT0gbiAmJiBhbyhuLCBpW2xdLCBpLCByKSwgaTsKICAgICAgfSkpLnByb3RvdHlwZSA9IHUsIHUuY29uc3RydWN0b3IgPSBoKSwgKGcgfHwgeSkgJiYgKGYoImRlbGV0ZSIpLCBmKCJoYXMiKSwgciAmJiBmKCJnZXQiKSksICh5IHx8IG0pICYmIGYobCksIHMgJiYgdS5jbGVhciAmJiBkZWxldGUgdS5jbGVhcjsKICAgIH0KICAgIHJldHVybiBkW3RdID0gaCwgamUoewogICAgICBnbG9iYWw6ICEwLAogICAgICBmb3JjZWQ6IGggIT0gYwogICAgfSwgZCksIG90KGgsIHQpLCBzIHx8IGkuc2V0U3Ryb25nKGgsIHQsIHIpLCBoOwogIH0oIldlYWtNYXAiLCBsLCB2byk7CgogIGlmIChCICYmIHIpIHsKICAgIG4gPSB2by5nZXRDb25zdHJ1Y3RvcihsLCAiV2Vha01hcCIsICEwKSwgcm8uUkVRVUlSRUQgPSAhMDsKICAgIHZhciB1ID0gYy5wcm90b3R5cGUsCiAgICAgICAgaCA9IHUuZGVsZXRlLAogICAgICAgIGQgPSB1LmhhcywKICAgICAgICBmID0gdS5nZXQsCiAgICAgICAgcCA9IHUuc2V0OwogICAgbm8odSwgewogICAgICBkZWxldGU6IGZ1bmN0aW9uIF9kZWxldGUoZSkgewogICAgICAgIGlmIChvKGUpICYmICFzKGUpKSB7CiAgICAgICAgICB2YXIgdCA9IGkodGhpcyk7CiAgICAgICAgICByZXR1cm4gdC5mcm96ZW4gfHwgKHQuZnJvemVuID0gbmV3IG4oKSksIGguY2FsbCh0aGlzLCBlKSB8fCB0LmZyb3plbi5kZWxldGUoZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gaC5jYWxsKHRoaXMsIGUpOwogICAgICB9LAogICAgICBoYXM6IGZ1bmN0aW9uIGhhcyhlKSB7CiAgICAgICAgaWYgKG8oZSkgJiYgIXMoZSkpIHsKICAgICAgICAgIHZhciB0ID0gaSh0aGlzKTsKICAgICAgICAgIHJldHVybiB0LmZyb3plbiB8fCAodC5mcm96ZW4gPSBuZXcgbigpKSwgZC5jYWxsKHRoaXMsIGUpIHx8IHQuZnJvemVuLmhhcyhlKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBkLmNhbGwodGhpcywgZSk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KGUpIHsKICAgICAgICBpZiAobyhlKSAmJiAhcyhlKSkgewogICAgICAgICAgdmFyIHQgPSBpKHRoaXMpOwogICAgICAgICAgcmV0dXJuIHQuZnJvemVuIHx8ICh0LmZyb3plbiA9IG5ldyBuKCkpLCBkLmNhbGwodGhpcywgZSkgPyBmLmNhbGwodGhpcywgZSkgOiB0LmZyb3plbi5nZXQoZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZi5jYWxsKHRoaXMsIGUpOwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChlLCB0KSB7CiAgICAgICAgaWYgKG8oZSkgJiYgIXMoZSkpIHsKICAgICAgICAgIHZhciByID0gaSh0aGlzKTsKICAgICAgICAgIHIuZnJvemVuIHx8IChyLmZyb3plbiA9IG5ldyBuKCkpLCBkLmNhbGwodGhpcywgZSkgPyBwLmNhbGwodGhpcywgZSwgdCkgOiByLmZyb3plbi5zZXQoZSwgdCk7CiAgICAgICAgfSBlbHNlIHAuY2FsbCh0aGlzLCBlLCB0KTsKCiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH0pOwogIH0KfSksIGllLnNldCksCiAgICBibyA9IGllLmdldHRlckZvcigiQXJyYXkgSXRlcmF0b3IiKSwKICAgIHdvID0gQWEoQXJyYXksICJBcnJheSIsIGZ1bmN0aW9uIChlLCB0KSB7CiAgeW8odGhpcywgewogICAgdHlwZTogIkFycmF5IEl0ZXJhdG9yIiwKICAgIHRhcmdldDogUChlKSwKICAgIGluZGV4OiAwLAogICAga2luZDogdAogIH0pOwp9LCBmdW5jdGlvbiAoKSB7CiAgdmFyIGUgPSBibyh0aGlzKSwKICAgICAgdCA9IGUudGFyZ2V0LAogICAgICBuID0gZS5raW5kLAogICAgICBpID0gZS5pbmRleCsrOwogIHJldHVybiAhdCB8fCBpID49IHQubGVuZ3RoID8gKGUudGFyZ2V0ID0gdm9pZCAwLCB7CiAgICB2YWx1ZTogdm9pZCAwLAogICAgZG9uZTogITAKICB9KSA6ICJrZXlzIiA9PSBuID8gewogICAgdmFsdWU6IGksCiAgICBkb25lOiAhMQogIH0gOiAidmFsdWVzIiA9PSBuID8gewogICAgdmFsdWU6IHRbaV0sCiAgICBkb25lOiAhMQogIH0gOiB7CiAgICB2YWx1ZTogW2ksIHRbaV1dLAogICAgZG9uZTogITEKICB9Owp9LCAidmFsdWVzIik7CktuLkFyZ3VtZW50cyA9IEtuLkFycmF5LCBxbigia2V5cyIpLCBxbigidmFsdWVzIiksIHFuKCJlbnRyaWVzIik7CnZhciBrbyA9IGV0KCJpdGVyYXRvciIpLAogICAgVG8gPSBldCgidG9TdHJpbmdUYWciKSwKICAgIFNvID0gd28udmFsdWVzOwoKZm9yICh2YXIgRW8gaW4gbW4pIHsKICB2YXIgQW8gPSBhW0VvXSwKICAgICAgeG8gPSBBbyAmJiBBby5wcm90b3R5cGU7CgogIGlmICh4bykgewogICAgaWYgKHhvW2tvXSAhPT0gU28pIHRyeSB7CiAgICAgIE0oeG8sIGtvLCBTbyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHhvW2tvXSA9IFNvOwogICAgfQogICAgaWYgKHhvW1RvXSB8fCBNKHhvLCBUbywgRW8pLCBtbltFb10pIGZvciAodmFyIENvIGluIHdvKSB7CiAgICAgIGlmICh4b1tDb10gIT09IHdvW0NvXSkgdHJ5IHsKICAgICAgICBNKHhvLCBDbywgd29bQ29dKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHhvW0NvXSA9IHdvW0NvXTsKICAgICAgfQogICAgfQogIH0KfQoKdmFyIFBvID0gZXQoIml0ZXJhdG9yIiksCiAgICBPbyA9ICFlKGZ1bmN0aW9uICgpIHsKICB2YXIgZSA9IG5ldyBVUkwoImI/YT0xJmI9MiZjPTMiLCAiaHR0cDovL2EiKSwKICAgICAgdCA9IGUuc2VhcmNoUGFyYW1zLAogICAgICBuID0gIiI7CiAgcmV0dXJuIGUucGF0aG5hbWUgPSAiYyUyMGQiLCB0LmZvckVhY2goZnVuY3Rpb24gKGUsIGkpIHsKICAgIHQuZGVsZXRlKCJiIiksIG4gKz0gaSArIGU7CiAgfSksICF0LnNvcnQgfHwgImh0dHA6Ly9hL2MlMjBkP2E9MSZjPTMiICE9PSBlLmhyZWYgfHwgIjMiICE9PSB0LmdldCgiYyIpIHx8ICJhPTEiICE9PSBTdHJpbmcobmV3IFVSTFNlYXJjaFBhcmFtcygiP2E9MSIpKSB8fCAhdFtQb10gfHwgImEiICE9PSBuZXcgVVJMKCJodHRwczovL2FAYiIpLnVzZXJuYW1lIHx8ICJiIiAhPT0gbmV3IFVSTFNlYXJjaFBhcmFtcyhuZXcgVVJMU2VhcmNoUGFyYW1zKCJhPWIiKSkuZ2V0KCJhIikgfHwgInhuLS1lMWF5YmMiICE9PSBuZXcgVVJMKCJodHRwOi8v0YLQtdGB0YIiKS5ob3N0IHx8ICIjJUQwJUIxIiAhPT0gbmV3IFVSTCgiaHR0cDovL2Ej0LEiKS5oYXNoIHx8ICJhMWMzIiAhPT0gbiB8fCAieCIgIT09IG5ldyBVUkwoImh0dHA6Ly94Iiwgdm9pZCAwKS5ob3N0Owp9KSwKICAgIElvID0gT2JqZWN0LmFzc2lnbiwKICAgIExvID0gT2JqZWN0LmRlZmluZVByb3BlcnR5LAogICAgTm8gPSAhSW8gfHwgZShmdW5jdGlvbiAoKSB7CiAgaWYgKHQgJiYgMSAhPT0gSW8oewogICAgYjogMQogIH0sIElvKExvKHt9LCAiYSIsIHsKICAgIGVudW1lcmFibGU6ICEwLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIExvKHRoaXMsICJiIiwgewogICAgICAgIHZhbHVlOiAzLAogICAgICAgIGVudW1lcmFibGU6ICExCiAgICAgIH0pOwogICAgfQogIH0pLCB7CiAgICBiOiAyCiAgfSkpLmIpIHJldHVybiAhMDsKICB2YXIgZSA9IHt9LAogICAgICBuID0ge30sCiAgICAgIGkgPSBTeW1ib2woKSwKICAgICAgciA9ICJhYmNkZWZnaGlqa2xtbm9wcXJzdCI7CiAgcmV0dXJuIGVbaV0gPSA3LCByLnNwbGl0KCIiKS5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICBuW2VdID0gZTsKICB9KSwgNyAhPSBJbyh7fSwgZSlbaV0gfHwgcWUoSW8oe30sIG4pKS5qb2luKCIiKSAhPSByOwp9KSA/IGZ1bmN0aW9uIChlLCBuKSB7CiAgZm9yICh2YXIgaSA9IEZlKGUpLCByID0gYXJndW1lbnRzLmxlbmd0aCwgYSA9IDEsIG8gPSBTZS5mLCBzID0gay5mOyByID4gYTspIHsKICAgIGZvciAodmFyIGwsIGMgPSB4KGFyZ3VtZW50c1thKytdKSwgdSA9IG8gPyBxZShjKS5jb25jYXQobyhjKSkgOiBxZShjKSwgaCA9IHUubGVuZ3RoLCBkID0gMDsgaCA+IGQ7KSB7CiAgICAgIGwgPSB1W2QrK10sIHQgJiYgIXMuY2FsbChjLCBsKSB8fCAoaVtsXSA9IGNbbF0pOwogICAgfQogIH0KCiAgcmV0dXJuIGk7Cn0gOiBJbywKICAgIE1vID0gL1teXDAtXHUwMDdFXS8sCiAgICBqbyA9IC9bLlx1MzAwMlx1RkYwRVx1RkY2MV0vZywKICAgIFJvID0gIk92ZXJmbG93OiBpbnB1dCBuZWVkcyB3aWRlciBpbnRlZ2VycyB0byBwcm9jZXNzIiwKICAgIF9vID0gTWF0aC5mbG9vciwKICAgIERvID0gU3RyaW5nLmZyb21DaGFyQ29kZSwKICAgIEZvID0gZnVuY3Rpb24gRm8oZSkgewogIHJldHVybiBlICsgMjIgKyA3NSAqIChlIDwgMjYpOwp9LAogICAgcW8gPSBmdW5jdGlvbiBxbyhlLCB0LCBuKSB7CiAgdmFyIGkgPSAwOwoKICBmb3IgKGUgPSBuID8gX28oZSAvIDcwMCkgOiBlID4+IDEsIGUgKz0gX28oZSAvIHQpOyBlID4gNDU1OyBpICs9IDM2KSB7CiAgICBlID0gX28oZSAvIDM1KTsKICB9CgogIHJldHVybiBfbyhpICsgMzYgKiBlIC8gKGUgKyAzOCkpOwp9LAogICAgVW8gPSBmdW5jdGlvbiBVbyhlKSB7CiAgdmFyIHQsCiAgICAgIG4sCiAgICAgIGkgPSBbXSwKICAgICAgciA9IChlID0gZnVuY3Rpb24gKGUpIHsKICAgIGZvciAodmFyIHQgPSBbXSwgbiA9IDAsIGkgPSBlLmxlbmd0aDsgbiA8IGk7KSB7CiAgICAgIHZhciByID0gZS5jaGFyQ29kZUF0KG4rKyk7CgogICAgICBpZiAociA+PSA1NTI5NiAmJiByIDw9IDU2MzE5ICYmIG4gPCBpKSB7CiAgICAgICAgdmFyIGEgPSBlLmNoYXJDb2RlQXQobisrKTsKICAgICAgICA1NjMyMCA9PSAoNjQ1MTIgJiBhKSA/IHQucHVzaCgoKDEwMjMgJiByKSA8PCAxMCkgKyAoMTAyMyAmIGEpICsgNjU1MzYpIDogKHQucHVzaChyKSwgbi0tKTsKICAgICAgfSBlbHNlIHQucHVzaChyKTsKICAgIH0KCiAgICByZXR1cm4gdDsKICB9KGUpKS5sZW5ndGgsCiAgICAgIGEgPSAxMjgsCiAgICAgIG8gPSAwLAogICAgICBzID0gNzI7CgogIGZvciAodCA9IDA7IHQgPCBlLmxlbmd0aDsgdCsrKSB7CiAgICAobiA9IGVbdF0pIDwgMTI4ICYmIGkucHVzaChEbyhuKSk7CiAgfQoKICB2YXIgbCA9IGkubGVuZ3RoLAogICAgICBjID0gbDsKCiAgZm9yIChsICYmIGkucHVzaCgiLSIpOyBjIDwgcjspIHsKICAgIHZhciB1ID0gMjE0NzQ4MzY0NzsKCiAgICBmb3IgKHQgPSAwOyB0IDwgZS5sZW5ndGg7IHQrKykgewogICAgICAobiA9IGVbdF0pID49IGEgJiYgbiA8IHUgJiYgKHUgPSBuKTsKICAgIH0KCiAgICB2YXIgaCA9IGMgKyAxOwogICAgaWYgKHUgLSBhID4gX28oKDIxNDc0ODM2NDcgLSBvKSAvIGgpKSB0aHJvdyBSYW5nZUVycm9yKFJvKTsKCiAgICBmb3IgKG8gKz0gKHUgLSBhKSAqIGgsIGEgPSB1LCB0ID0gMDsgdCA8IGUubGVuZ3RoOyB0KyspIHsKICAgICAgaWYgKChuID0gZVt0XSkgPCBhICYmICsrbyA+IDIxNDc0ODM2NDcpIHRocm93IFJhbmdlRXJyb3IoUm8pOwoKICAgICAgaWYgKG4gPT0gYSkgewogICAgICAgIGZvciAodmFyIGQgPSBvLCBmID0gMzY7OyBmICs9IDM2KSB7CiAgICAgICAgICB2YXIgcCA9IGYgPD0gcyA/IDEgOiBmID49IHMgKyAyNiA/IDI2IDogZiAtIHM7CiAgICAgICAgICBpZiAoZCA8IHApIGJyZWFrOwogICAgICAgICAgdmFyIG0gPSBkIC0gcCwKICAgICAgICAgICAgICBnID0gMzYgLSBwOwogICAgICAgICAgaS5wdXNoKERvKEZvKHAgKyBtICUgZykpKSwgZCA9IF9vKG0gLyBnKTsKICAgICAgICB9CgogICAgICAgIGkucHVzaChEbyhGbyhkKSkpLCBzID0gcW8obywgaCwgYyA9PSBsKSwgbyA9IDAsICsrYzsKICAgICAgfQogICAgfQoKICAgICsrbywgKythOwogIH0KCiAgcmV0dXJuIGkuam9pbigiIik7Cn0sCiAgICBIbyA9IGZ1bmN0aW9uIEhvKGUpIHsKICB2YXIgdCA9IGlpKGUpOwogIGlmICgiZnVuY3Rpb24iICE9IHR5cGVvZiB0KSB0aHJvdyBUeXBlRXJyb3IoU3RyaW5nKGUpICsgIiBpcyBub3QgaXRlcmFibGUiKTsKICByZXR1cm4gaCh0LmNhbGwoZSkpOwp9LAogICAgQm8gPSBzZSgiZmV0Y2giKSwKICAgIFZvID0gc2UoIkhlYWRlcnMiKSwKICAgIHpvID0gZXQoIml0ZXJhdG9yIiksCiAgICBXbyA9IGllLnNldCwKICAgICRvID0gaWUuZ2V0dGVyRm9yKCJVUkxTZWFyY2hQYXJhbXMiKSwKICAgIEtvID0gaWUuZ2V0dGVyRm9yKCJVUkxTZWFyY2hQYXJhbXNJdGVyYXRvciIpLAogICAgWW8gPSAvXCsvZywKICAgIEdvID0gQXJyYXkoNCksCiAgICBYbyA9IGZ1bmN0aW9uIFhvKGUpIHsKICByZXR1cm4gR29bZSAtIDFdIHx8IChHb1tlIC0gMV0gPSBSZWdFeHAoIigoPzolW1xcZGEtZl17Mn0peyIgKyBlICsgIn0pIiwgImdpIikpOwp9LAogICAgUW8gPSBmdW5jdGlvbiBRbyhlKSB7CiAgdHJ5IHsKICAgIHJldHVybiBkZWNvZGVVUklDb21wb25lbnQoZSk7CiAgfSBjYXRjaCAodCkgewogICAgcmV0dXJuIGU7CiAgfQp9LAogICAgSm8gPSBmdW5jdGlvbiBKbyhlKSB7CiAgdmFyIHQgPSBlLnJlcGxhY2UoWW8sICIgIiksCiAgICAgIG4gPSA0OwoKICB0cnkgewogICAgcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudCh0KTsKICB9IGNhdGNoIChlKSB7CiAgICBmb3IgKDsgbjspIHsKICAgICAgdCA9IHQucmVwbGFjZShYbyhuLS0pLCBRbyk7CiAgICB9CgogICAgcmV0dXJuIHQ7CiAgfQp9LAogICAgWm8gPSAvWyEnKCl+XXwlMjAvZywKICAgIGVzID0gewogICIhIjogIiUyMSIsCiAgIiciOiAiJTI3IiwKICAiKCI6ICIlMjgiLAogICIpIjogIiUyOSIsCiAgIn4iOiAiJTdFIiwKICAiJTIwIjogIisiCn0sCiAgICB0cyA9IGZ1bmN0aW9uIHRzKGUpIHsKICByZXR1cm4gZXNbZV07Cn0sCiAgICBucyA9IGZ1bmN0aW9uIG5zKGUpIHsKICByZXR1cm4gZW5jb2RlVVJJQ29tcG9uZW50KGUpLnJlcGxhY2UoWm8sIHRzKTsKfSwKICAgIGlzID0gZnVuY3Rpb24gaXMoZSwgdCkgewogIGlmICh0KSBmb3IgKHZhciBuLCBpLCByID0gdC5zcGxpdCgiJiIpLCBhID0gMDsgYSA8IHIubGVuZ3RoOykgewogICAgKG4gPSByW2ErK10pLmxlbmd0aCAmJiAoaSA9IG4uc3BsaXQoIj0iKSwgZS5wdXNoKHsKICAgICAga2V5OiBKbyhpLnNoaWZ0KCkpLAogICAgICB2YWx1ZTogSm8oaS5qb2luKCI9IikpCiAgICB9KSk7CiAgfQp9LAogICAgcnMgPSBmdW5jdGlvbiBycyhlKSB7CiAgdGhpcy5lbnRyaWVzLmxlbmd0aCA9IDAsIGlzKHRoaXMuZW50cmllcywgZSk7Cn0sCiAgICBhcyA9IGZ1bmN0aW9uIGFzKGUsIHQpIHsKICBpZiAoZSA8IHQpIHRocm93IFR5cGVFcnJvcigiTm90IGVub3VnaCBhcmd1bWVudHMiKTsKfSwKICAgIG9zID0gd2EoZnVuY3Rpb24gKGUsIHQpIHsKICBXbyh0aGlzLCB7CiAgICB0eXBlOiAiVVJMU2VhcmNoUGFyYW1zSXRlcmF0b3IiLAogICAgaXRlcmF0b3I6IEhvKCRvKGUpLmVudHJpZXMpLAogICAga2luZDogdAogIH0pOwp9LCAiSXRlcmF0b3IiLCBmdW5jdGlvbiAoKSB7CiAgdmFyIGUgPSBLbyh0aGlzKSwKICAgICAgdCA9IGUua2luZCwKICAgICAgbiA9IGUuaXRlcmF0b3IubmV4dCgpLAogICAgICBpID0gbi52YWx1ZTsKICByZXR1cm4gbi5kb25lIHx8IChuLnZhbHVlID0gImtleXMiID09PSB0ID8gaS5rZXkgOiAidmFsdWVzIiA9PT0gdCA/IGkudmFsdWUgOiBbaS5rZXksIGkudmFsdWVdKSwgbjsKfSksCiAgICBzcyA9IGZ1bmN0aW9uIHNzKCkgewogIG9vKHRoaXMsIHNzLCAiVVJMU2VhcmNoUGFyYW1zIik7CiAgdmFyIGUsCiAgICAgIHQsCiAgICAgIG4sCiAgICAgIGksCiAgICAgIHIsCiAgICAgIGEsCiAgICAgIHMsCiAgICAgIGwsCiAgICAgIGMsCiAgICAgIHUgPSBhcmd1bWVudHMubGVuZ3RoID4gMCA/IGFyZ3VtZW50c1swXSA6IHZvaWQgMCwKICAgICAgZCA9IHRoaXMsCiAgICAgIGYgPSBbXTsKICBpZiAoV28oZCwgewogICAgdHlwZTogIlVSTFNlYXJjaFBhcmFtcyIsCiAgICBlbnRyaWVzOiBmLAogICAgdXBkYXRlVVJMOiBmdW5jdGlvbiB1cGRhdGVVUkwoKSB7fSwKICAgIHVwZGF0ZVNlYXJjaFBhcmFtczogcnMKICB9KSwgdm9pZCAwICE9PSB1KSBpZiAobyh1KSkgewogICAgaWYgKCJmdW5jdGlvbiIgPT0gdHlwZW9mIChlID0gaWkodSkpKSBmb3IgKG4gPSAodCA9IGUuY2FsbCh1KSkubmV4dDsgIShpID0gbi5jYWxsKHQpKS5kb25lOykgewogICAgICBpZiAoKHMgPSAoYSA9IChyID0gSG8oaChpLnZhbHVlKSkpLm5leHQpLmNhbGwocikpLmRvbmUgfHwgKGwgPSBhLmNhbGwocikpLmRvbmUgfHwgIWEuY2FsbChyKS5kb25lKSB0aHJvdyBUeXBlRXJyb3IoIkV4cGVjdGVkIHNlcXVlbmNlIHdpdGggbGVuZ3RoIDIiKTsKICAgICAgZi5wdXNoKHsKICAgICAgICBrZXk6IHMudmFsdWUgKyAiIiwKICAgICAgICB2YWx1ZTogbC52YWx1ZSArICIiCiAgICAgIH0pOwogICAgfSBlbHNlIGZvciAoYyBpbiB1KSB7CiAgICAgIEkodSwgYykgJiYgZi5wdXNoKHsKICAgICAgICBrZXk6IGMsCiAgICAgICAgdmFsdWU6IHVbY10gKyAiIgogICAgICB9KTsKICAgIH0KICB9IGVsc2UgaXMoZiwgInN0cmluZyIgPT0gdHlwZW9mIHUgPyAiPyIgPT09IHUuY2hhckF0KDApID8gdS5zbGljZSgxKSA6IHUgOiB1ICsgIiIpOwp9LAogICAgbHMgPSBzcy5wcm90b3R5cGU7CgpubyhscywgewogIGFwcGVuZDogZnVuY3Rpb24gYXBwZW5kKGUsIHQpIHsKICAgIGFzKGFyZ3VtZW50cy5sZW5ndGgsIDIpOwogICAgdmFyIG4gPSAkbyh0aGlzKTsKICAgIG4uZW50cmllcy5wdXNoKHsKICAgICAga2V5OiBlICsgIiIsCiAgICAgIHZhbHVlOiB0ICsgIiIKICAgIH0pLCBuLnVwZGF0ZVVSTCgpOwogIH0sCiAgZGVsZXRlOiBmdW5jdGlvbiBfZGVsZXRlKGUpIHsKICAgIGFzKGFyZ3VtZW50cy5sZW5ndGgsIDEpOwoKICAgIGZvciAodmFyIHQgPSAkbyh0aGlzKSwgbiA9IHQuZW50cmllcywgaSA9IGUgKyAiIiwgciA9IDA7IHIgPCBuLmxlbmd0aDspIHsKICAgICAgbltyXS5rZXkgPT09IGkgPyBuLnNwbGljZShyLCAxKSA6IHIrKzsKICAgIH0KCiAgICB0LnVwZGF0ZVVSTCgpOwogIH0sCiAgZ2V0OiBmdW5jdGlvbiBnZXQoZSkgewogICAgYXMoYXJndW1lbnRzLmxlbmd0aCwgMSk7CgogICAgZm9yICh2YXIgdCA9ICRvKHRoaXMpLmVudHJpZXMsIG4gPSBlICsgIiIsIGkgPSAwOyBpIDwgdC5sZW5ndGg7IGkrKykgewogICAgICBpZiAodFtpXS5rZXkgPT09IG4pIHJldHVybiB0W2ldLnZhbHVlOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0sCiAgZ2V0QWxsOiBmdW5jdGlvbiBnZXRBbGwoZSkgewogICAgYXMoYXJndW1lbnRzLmxlbmd0aCwgMSk7CgogICAgZm9yICh2YXIgdCA9ICRvKHRoaXMpLmVudHJpZXMsIG4gPSBlICsgIiIsIGkgPSBbXSwgciA9IDA7IHIgPCB0Lmxlbmd0aDsgcisrKSB7CiAgICAgIHRbcl0ua2V5ID09PSBuICYmIGkucHVzaCh0W3JdLnZhbHVlKTsKICAgIH0KCiAgICByZXR1cm4gaTsKICB9LAogIGhhczogZnVuY3Rpb24gaGFzKGUpIHsKICAgIGFzKGFyZ3VtZW50cy5sZW5ndGgsIDEpOwoKICAgIGZvciAodmFyIHQgPSAkbyh0aGlzKS5lbnRyaWVzLCBuID0gZSArICIiLCBpID0gMDsgaSA8IHQubGVuZ3RoOykgewogICAgICBpZiAodFtpKytdLmtleSA9PT0gbikgcmV0dXJuICEwOwogICAgfQoKICAgIHJldHVybiAhMTsKICB9LAogIHNldDogZnVuY3Rpb24gc2V0KGUsIHQpIHsKICAgIGFzKGFyZ3VtZW50cy5sZW5ndGgsIDEpOwoKICAgIGZvciAodmFyIG4sIGkgPSAkbyh0aGlzKSwgciA9IGkuZW50cmllcywgYSA9ICExLCBvID0gZSArICIiLCBzID0gdCArICIiLCBsID0gMDsgbCA8IHIubGVuZ3RoOyBsKyspIHsKICAgICAgKG4gPSByW2xdKS5rZXkgPT09IG8gJiYgKGEgPyByLnNwbGljZShsLS0sIDEpIDogKGEgPSAhMCwgbi52YWx1ZSA9IHMpKTsKICAgIH0KCiAgICBhIHx8IHIucHVzaCh7CiAgICAgIGtleTogbywKICAgICAgdmFsdWU6IHMKICAgIH0pLCBpLnVwZGF0ZVVSTCgpOwogIH0sCiAgc29ydDogZnVuY3Rpb24gc29ydCgpIHsKICAgIHZhciBlLAogICAgICAgIHQsCiAgICAgICAgbiwKICAgICAgICBpID0gJG8odGhpcyksCiAgICAgICAgciA9IGkuZW50cmllcywKICAgICAgICBhID0gci5zbGljZSgpOwoKICAgIGZvciAoci5sZW5ndGggPSAwLCBuID0gMDsgbiA8IGEubGVuZ3RoOyBuKyspIHsKICAgICAgZm9yIChlID0gYVtuXSwgdCA9IDA7IHQgPCBuOyB0KyspIHsKICAgICAgICBpZiAoclt0XS5rZXkgPiBlLmtleSkgewogICAgICAgICAgci5zcGxpY2UodCwgMCwgZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHQgPT09IG4gJiYgci5wdXNoKGUpOwogICAgfQoKICAgIGkudXBkYXRlVVJMKCk7CiAgfSwKICBmb3JFYWNoOiBmdW5jdGlvbiBmb3JFYWNoKGUpIHsKICAgIGZvciAodmFyIHQsIG4gPSAkbyh0aGlzKS5lbnRyaWVzLCBpID0gbHQoZSwgYXJndW1lbnRzLmxlbmd0aCA+IDEgPyBhcmd1bWVudHNbMV0gOiB2b2lkIDAsIDMpLCByID0gMDsgciA8IG4ubGVuZ3RoOykgewogICAgICBpKCh0ID0gbltyKytdKS52YWx1ZSwgdC5rZXksIHRoaXMpOwogICAgfQogIH0sCiAga2V5czogZnVuY3Rpb24ga2V5cygpIHsKICAgIHJldHVybiBuZXcgb3ModGhpcywgImtleXMiKTsKICB9LAogIHZhbHVlczogZnVuY3Rpb24gdmFsdWVzKCkgewogICAgcmV0dXJuIG5ldyBvcyh0aGlzLCAidmFsdWVzIik7CiAgfSwKICBlbnRyaWVzOiBmdW5jdGlvbiBlbnRyaWVzKCkgewogICAgcmV0dXJuIG5ldyBvcyh0aGlzLCAiZW50cmllcyIpOwogIH0KfSwgewogIGVudW1lcmFibGU6ICEwCn0pLCByZShscywgem8sIGxzLmVudHJpZXMpLCByZShscywgInRvU3RyaW5nIiwgZnVuY3Rpb24gKCkgewogIGZvciAodmFyIGUsIHQgPSAkbyh0aGlzKS5lbnRyaWVzLCBuID0gW10sIGkgPSAwOyBpIDwgdC5sZW5ndGg7KSB7CiAgICBlID0gdFtpKytdLCBuLnB1c2gobnMoZS5rZXkpICsgIj0iICsgbnMoZS52YWx1ZSkpOwogIH0KCiAgcmV0dXJuIG4uam9pbigiJiIpOwp9LCB7CiAgZW51bWVyYWJsZTogITAKfSksIG90KHNzLCAiVVJMU2VhcmNoUGFyYW1zIiksIGplKHsKICBnbG9iYWw6ICEwLAogIGZvcmNlZDogIU9vCn0sIHsKICBVUkxTZWFyY2hQYXJhbXM6IHNzCn0pLCBPbyB8fCAiZnVuY3Rpb24iICE9IHR5cGVvZiBCbyB8fCAiZnVuY3Rpb24iICE9IHR5cGVvZiBWbyB8fCBqZSh7CiAgZ2xvYmFsOiAhMCwKICBlbnVtZXJhYmxlOiAhMCwKICBmb3JjZWQ6ICEwCn0sIHsKICBmZXRjaDogZnVuY3Rpb24gZmV0Y2goZSkgewogICAgdmFyIHQsCiAgICAgICAgbiwKICAgICAgICBpLAogICAgICAgIHIgPSBbZV07CiAgICByZXR1cm4gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgKG8odCA9IGFyZ3VtZW50c1sxXSkgJiYgKG4gPSB0LmJvZHksICJVUkxTZWFyY2hQYXJhbXMiID09PSB0aShuKSAmJiAoKGkgPSB0LmhlYWRlcnMgPyBuZXcgVm8odC5oZWFkZXJzKSA6IG5ldyBWbygpKS5oYXMoImNvbnRlbnQtdHlwZSIpIHx8IGkuc2V0KCJjb250ZW50LXR5cGUiLCAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkO2NoYXJzZXQ9VVRGLTgiKSwgdCA9ICRlKHQsIHsKICAgICAgYm9keTogVCgwLCBTdHJpbmcobikpLAogICAgICBoZWFkZXJzOiBUKDAsIGkpCiAgICB9KSkpLCByLnB1c2godCkpLCBCby5hcHBseSh0aGlzLCByKTsKICB9Cn0pOwoKdmFyIGNzLAogICAgdXMgPSB7CiAgVVJMU2VhcmNoUGFyYW1zOiBzcywKICBnZXRTdGF0ZTogJG8KfSwKICAgIGhzID0gdWEuY29kZUF0LAogICAgZHMgPSBhLlVSTCwKICAgIGZzID0gdXMuVVJMU2VhcmNoUGFyYW1zLAogICAgcHMgPSB1cy5nZXRTdGF0ZSwKICAgIG1zID0gaWUuc2V0LAogICAgZ3MgPSBpZS5nZXR0ZXJGb3IoIlVSTCIpLAogICAgdnMgPSBNYXRoLmZsb29yLAogICAgeXMgPSBNYXRoLnBvdywKICAgIGJzID0gL1tBLVphLXpdLywKICAgIHdzID0gL1tcZCstLkEtWmEtel0vLAogICAga3MgPSAvXGQvLAogICAgVHMgPSAvXigweHwwWCkvLAogICAgU3MgPSAvXlswLTddKyQvLAogICAgRXMgPSAvXlxkKyQvLAogICAgQXMgPSAvXltcZEEtRmEtZl0rJC8sCiAgICB4cyA9IC9bXHUwMDAwXHUwMDA5XHUwMDBBXHUwMDBEICMlLzo/QFtcXF1dLywKICAgIENzID0gL1tcdTAwMDBcdTAwMDlcdTAwMEFcdTAwMEQgIy86P0BbXFxdXS8sCiAgICBQcyA9IC9eW1x1MDAwMC1cdTAwMUYgXSt8W1x1MDAwMC1cdTAwMUYgXSskL2csCiAgICBPcyA9IC9bXHUwMDA5XHUwMDBBXHUwMDBEXS9nLAogICAgSXMgPSBmdW5jdGlvbiBJcyhlLCB0KSB7CiAgdmFyIG4sIGksIHI7CgogIGlmICgiWyIgPT0gdC5jaGFyQXQoMCkpIHsKICAgIGlmICgiXSIgIT0gdC5jaGFyQXQodC5sZW5ndGggLSAxKSkgcmV0dXJuICJJbnZhbGlkIGhvc3QiOwogICAgaWYgKCEobiA9IE5zKHQuc2xpY2UoMSwgLTEpKSkpIHJldHVybiAiSW52YWxpZCBob3N0IjsKICAgIGUuaG9zdCA9IG47CiAgfSBlbHNlIGlmIChVcyhlKSkgewogICAgaWYgKHQgPSBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgdCwKICAgICAgICAgIG4sCiAgICAgICAgICBpID0gW10sCiAgICAgICAgICByID0gZS50b0xvd2VyQ2FzZSgpLnJlcGxhY2Uoam8sICIuIikuc3BsaXQoIi4iKTsKCiAgICAgIGZvciAodCA9IDA7IHQgPCByLmxlbmd0aDsgdCsrKSB7CiAgICAgICAgbiA9IHJbdF0sIGkucHVzaChNby50ZXN0KG4pID8gInhuLS0iICsgVW8obikgOiBuKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGkuam9pbigiLiIpOwogICAgfSh0KSwgeHMudGVzdCh0KSkgcmV0dXJuICJJbnZhbGlkIGhvc3QiOwogICAgaWYgKG51bGwgPT09IChuID0gTHModCkpKSByZXR1cm4gIkludmFsaWQgaG9zdCI7CiAgICBlLmhvc3QgPSBuOwogIH0gZWxzZSB7CiAgICBpZiAoQ3MudGVzdCh0KSkgcmV0dXJuICJJbnZhbGlkIGhvc3QiOwoKICAgIGZvciAobiA9ICIiLCBpID0gcmkodCksIHIgPSAwOyByIDwgaS5sZW5ndGg7IHIrKykgewogICAgICBuICs9IEZzKGlbcl0sIGpzKTsKICAgIH0KCiAgICBlLmhvc3QgPSBuOwogIH0KfSwKICAgIExzID0gZnVuY3Rpb24gTHMoZSkgewogIHZhciB0LAogICAgICBuLAogICAgICBpLAogICAgICByLAogICAgICBhLAogICAgICBvLAogICAgICBzLAogICAgICBsID0gZS5zcGxpdCgiLiIpOwogIGlmIChsLmxlbmd0aCAmJiAiIiA9PSBsW2wubGVuZ3RoIC0gMV0gJiYgbC5wb3AoKSwgKHQgPSBsLmxlbmd0aCkgPiA0KSByZXR1cm4gZTsKCiAgZm9yIChuID0gW10sIGkgPSAwOyBpIDwgdDsgaSsrKSB7CiAgICBpZiAoIiIgPT0gKHIgPSBsW2ldKSkgcmV0dXJuIGU7CiAgICBpZiAoYSA9IDEwLCByLmxlbmd0aCA+IDEgJiYgIjAiID09IHIuY2hhckF0KDApICYmIChhID0gVHMudGVzdChyKSA/IDE2IDogOCwgciA9IHIuc2xpY2UoOCA9PSBhID8gMSA6IDIpKSwgIiIgPT09IHIpIG8gPSAwO2Vsc2UgewogICAgICBpZiAoISgxMCA9PSBhID8gRXMgOiA4ID09IGEgPyBTcyA6IEFzKS50ZXN0KHIpKSByZXR1cm4gZTsKICAgICAgbyA9IHBhcnNlSW50KHIsIGEpOwogICAgfQogICAgbi5wdXNoKG8pOwogIH0KCiAgZm9yIChpID0gMDsgaSA8IHQ7IGkrKykgewogICAgaWYgKG8gPSBuW2ldLCBpID09IHQgLSAxKSB7CiAgICAgIGlmIChvID49IHlzKDI1NiwgNSAtIHQpKSByZXR1cm4gbnVsbDsKICAgIH0gZWxzZSBpZiAobyA+IDI1NSkgcmV0dXJuIG51bGw7CiAgfQoKICBmb3IgKHMgPSBuLnBvcCgpLCBpID0gMDsgaSA8IG4ubGVuZ3RoOyBpKyspIHsKICAgIHMgKz0gbltpXSAqIHlzKDI1NiwgMyAtIGkpOwogIH0KCiAgcmV0dXJuIHM7Cn0sCiAgICBOcyA9IGZ1bmN0aW9uIE5zKGUpIHsKICB2YXIgdCwKICAgICAgbiwKICAgICAgaSwKICAgICAgciwKICAgICAgYSwKICAgICAgbywKICAgICAgcywKICAgICAgbCA9IFswLCAwLCAwLCAwLCAwLCAwLCAwLCAwXSwKICAgICAgYyA9IDAsCiAgICAgIHUgPSBudWxsLAogICAgICBoID0gMCwKICAgICAgZCA9IGZ1bmN0aW9uIGQoKSB7CiAgICByZXR1cm4gZS5jaGFyQXQoaCk7CiAgfTsKCiAgaWYgKCI6IiA9PSBkKCkpIHsKICAgIGlmICgiOiIgIT0gZS5jaGFyQXQoMSkpIHJldHVybjsKICAgIGggKz0gMiwgdSA9ICsrYzsKICB9CgogIGZvciAoOyBkKCk7KSB7CiAgICBpZiAoOCA9PSBjKSByZXR1cm47CgogICAgaWYgKCI6IiAhPSBkKCkpIHsKICAgICAgZm9yICh0ID0gbiA9IDA7IG4gPCA0ICYmIEFzLnRlc3QoZCgpKTspIHsKICAgICAgICB0ID0gMTYgKiB0ICsgcGFyc2VJbnQoZCgpLCAxNiksIGgrKywgbisrOwogICAgICB9CgogICAgICBpZiAoIi4iID09IGQoKSkgewogICAgICAgIGlmICgwID09IG4pIHJldHVybjsKICAgICAgICBpZiAoaCAtPSBuLCBjID4gNikgcmV0dXJuOwoKICAgICAgICBmb3IgKGkgPSAwOyBkKCk7KSB7CiAgICAgICAgICBpZiAociA9IG51bGwsIGkgPiAwKSB7CiAgICAgICAgICAgIGlmICghKCIuIiA9PSBkKCkgJiYgaSA8IDQpKSByZXR1cm47CiAgICAgICAgICAgIGgrKzsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIWtzLnRlc3QoZCgpKSkgcmV0dXJuOwoKICAgICAgICAgIGZvciAoOyBrcy50ZXN0KGQoKSk7KSB7CiAgICAgICAgICAgIGlmIChhID0gcGFyc2VJbnQoZCgpLCAxMCksIG51bGwgPT09IHIpIHIgPSBhO2Vsc2UgewogICAgICAgICAgICAgIGlmICgwID09IHIpIHJldHVybjsKICAgICAgICAgICAgICByID0gMTAgKiByICsgYTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAociA+IDI1NSkgcmV0dXJuOwogICAgICAgICAgICBoKys7CiAgICAgICAgICB9CgogICAgICAgICAgbFtjXSA9IDI1NiAqIGxbY10gKyByLCAyICE9ICsraSAmJiA0ICE9IGkgfHwgYysrOwogICAgICAgIH0KCiAgICAgICAgaWYgKDQgIT0gaSkgcmV0dXJuOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBpZiAoIjoiID09IGQoKSkgewogICAgICAgIGlmIChoKyssICFkKCkpIHJldHVybjsKICAgICAgfSBlbHNlIGlmIChkKCkpIHJldHVybjsKCiAgICAgIGxbYysrXSA9IHQ7CiAgICB9IGVsc2UgewogICAgICBpZiAobnVsbCAhPT0gdSkgcmV0dXJuOwogICAgICBoKyssIHUgPSArK2M7CiAgICB9CiAgfQoKICBpZiAobnVsbCAhPT0gdSkgZm9yIChvID0gYyAtIHUsIGMgPSA3OyAwICE9IGMgJiYgbyA+IDA7KSB7CiAgICBzID0gbFtjXSwgbFtjLS1dID0gbFt1ICsgbyAtIDFdLCBsW3UgKyAtLW9dID0gczsKICB9IGVsc2UgaWYgKDggIT0gYykgcmV0dXJuOwogIHJldHVybiBsOwp9LAogICAgTXMgPSBmdW5jdGlvbiBNcyhlKSB7CiAgdmFyIHQsIG4sIGksIHI7CgogIGlmICgibnVtYmVyIiA9PSB0eXBlb2YgZSkgewogICAgZm9yICh0ID0gW10sIG4gPSAwOyBuIDwgNDsgbisrKSB7CiAgICAgIHQudW5zaGlmdChlICUgMjU2KSwgZSA9IHZzKGUgLyAyNTYpOwogICAgfQoKICAgIHJldHVybiB0LmpvaW4oIi4iKTsKICB9CgogIGlmICgib2JqZWN0IiA9PSBfdHlwZW9mKGUpKSB7CiAgICBmb3IgKHQgPSAiIiwgaSA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIGZvciAodmFyIHQgPSBudWxsLCBuID0gMSwgaSA9IG51bGwsIHIgPSAwLCBhID0gMDsgYSA8IDg7IGErKykgewogICAgICAgIDAgIT09IGVbYV0gPyAociA+IG4gJiYgKHQgPSBpLCBuID0gciksIGkgPSBudWxsLCByID0gMCkgOiAobnVsbCA9PT0gaSAmJiAoaSA9IGEpLCArK3IpOwogICAgICB9CgogICAgICByZXR1cm4gciA+IG4gJiYgKHQgPSBpLCBuID0gciksIHQ7CiAgICB9KGUpLCBuID0gMDsgbiA8IDg7IG4rKykgewogICAgICByICYmIDAgPT09IGVbbl0gfHwgKHIgJiYgKHIgPSAhMSksIGkgPT09IG4gPyAodCArPSBuID8gIjoiIDogIjo6IiwgciA9ICEwKSA6ICh0ICs9IGVbbl0udG9TdHJpbmcoMTYpLCBuIDwgNyAmJiAodCArPSAiOiIpKSk7CiAgICB9CgogICAgcmV0dXJuICJbIiArIHQgKyAiXSI7CiAgfQoKICByZXR1cm4gZTsKfSwKICAgIGpzID0ge30sCiAgICBScyA9IE5vKHt9LCBqcywgewogICIgIjogMSwKICAnIic6IDEsCiAgIjwiOiAxLAogICI+IjogMSwKICAiYCI6IDEKfSksCiAgICBfcyA9IE5vKHt9LCBScywgewogICIjIjogMSwKICAiPyI6IDEsCiAgInsiOiAxLAogICJ9IjogMQp9KSwKICAgIERzID0gTm8oe30sIF9zLCB7CiAgIi8iOiAxLAogICI6IjogMSwKICAiOyI6IDEsCiAgIj0iOiAxLAogICJAIjogMSwKICAiWyI6IDEsCiAgIlxcIjogMSwKICAiXSI6IDEsCiAgIl4iOiAxLAogICJ8IjogMQp9KSwKICAgIEZzID0gZnVuY3Rpb24gRnMoZSwgdCkgewogIHZhciBuID0gaHMoZSwgMCk7CiAgcmV0dXJuIG4gPiAzMiAmJiBuIDwgMTI3ICYmICFJKHQsIGUpID8gZSA6IGVuY29kZVVSSUNvbXBvbmVudChlKTsKfSwKICAgIHFzID0gewogIGZ0cDogMjEsCiAgZmlsZTogbnVsbCwKICBodHRwOiA4MCwKICBodHRwczogNDQzLAogIHdzOiA4MCwKICB3c3M6IDQ0Mwp9LAogICAgVXMgPSBmdW5jdGlvbiBVcyhlKSB7CiAgcmV0dXJuIEkocXMsIGUuc2NoZW1lKTsKfSwKICAgIEhzID0gZnVuY3Rpb24gSHMoZSkgewogIHJldHVybiAiIiAhPSBlLnVzZXJuYW1lIHx8ICIiICE9IGUucGFzc3dvcmQ7Cn0sCiAgICBCcyA9IGZ1bmN0aW9uIEJzKGUpIHsKICByZXR1cm4gIWUuaG9zdCB8fCBlLmNhbm5vdEJlQUJhc2VVUkwgfHwgImZpbGUiID09IGUuc2NoZW1lOwp9LAogICAgVnMgPSBmdW5jdGlvbiBWcyhlLCB0KSB7CiAgdmFyIG47CiAgcmV0dXJuIDIgPT0gZS5sZW5ndGggJiYgYnMudGVzdChlLmNoYXJBdCgwKSkgJiYgKCI6IiA9PSAobiA9IGUuY2hhckF0KDEpKSB8fCAhdCAmJiAifCIgPT0gbik7Cn0sCiAgICB6cyA9IGZ1bmN0aW9uIHpzKGUpIHsKICB2YXIgdDsKICByZXR1cm4gZS5sZW5ndGggPiAxICYmIFZzKGUuc2xpY2UoMCwgMikpICYmICgyID09IGUubGVuZ3RoIHx8ICIvIiA9PT0gKHQgPSBlLmNoYXJBdCgyKSkgfHwgIlxcIiA9PT0gdCB8fCAiPyIgPT09IHQgfHwgIiMiID09PSB0KTsKfSwKICAgIFdzID0gZnVuY3Rpb24gV3MoZSkgewogIHZhciB0ID0gZS5wYXRoLAogICAgICBuID0gdC5sZW5ndGg7CiAgIW4gfHwgImZpbGUiID09IGUuc2NoZW1lICYmIDEgPT0gbiAmJiBWcyh0WzBdLCAhMCkgfHwgdC5wb3AoKTsKfSwKICAgICRzID0gZnVuY3Rpb24gJHMoZSkgewogIHJldHVybiAiLiIgPT09IGUgfHwgIiUyZSIgPT09IGUudG9Mb3dlckNhc2UoKTsKfSwKICAgIEtzID0ge30sCiAgICBZcyA9IHt9LAogICAgR3MgPSB7fSwKICAgIFhzID0ge30sCiAgICBRcyA9IHt9LAogICAgSnMgPSB7fSwKICAgIFpzID0ge30sCiAgICBlbCA9IHt9LAogICAgdGwgPSB7fSwKICAgIG5sID0ge30sCiAgICBpbCA9IHt9LAogICAgcmwgPSB7fSwKICAgIGFsID0ge30sCiAgICBvbCA9IHt9LAogICAgc2wgPSB7fSwKICAgIGxsID0ge30sCiAgICBjbCA9IHt9LAogICAgdWwgPSB7fSwKICAgIGhsID0ge30sCiAgICBkbCA9IHt9LAogICAgZmwgPSB7fSwKICAgIHBsID0gZnVuY3Rpb24gcGwoZSwgdCwgbiwgaSkgewogIHZhciByLAogICAgICBhLAogICAgICBvLAogICAgICBzLAogICAgICBsLAogICAgICBjID0gbiB8fCBLcywKICAgICAgdSA9IDAsCiAgICAgIGggPSAiIiwKICAgICAgZCA9ICExLAogICAgICBmID0gITEsCiAgICAgIHAgPSAhMTsKCiAgZm9yIChuIHx8IChlLnNjaGVtZSA9ICIiLCBlLnVzZXJuYW1lID0gIiIsIGUucGFzc3dvcmQgPSAiIiwgZS5ob3N0ID0gbnVsbCwgZS5wb3J0ID0gbnVsbCwgZS5wYXRoID0gW10sIGUucXVlcnkgPSBudWxsLCBlLmZyYWdtZW50ID0gbnVsbCwgZS5jYW5ub3RCZUFCYXNlVVJMID0gITEsIHQgPSB0LnJlcGxhY2UoUHMsICIiKSksIHQgPSB0LnJlcGxhY2UoT3MsICIiKSwgciA9IHJpKHQpOyB1IDw9IHIubGVuZ3RoOykgewogICAgc3dpdGNoIChhID0gclt1XSwgYykgewogICAgICBjYXNlIEtzOgogICAgICAgIGlmICghYSB8fCAhYnMudGVzdChhKSkgewogICAgICAgICAgaWYgKG4pIHJldHVybiAiSW52YWxpZCBzY2hlbWUiOwogICAgICAgICAgYyA9IEdzOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBoICs9IGEudG9Mb3dlckNhc2UoKSwgYyA9IFlzOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSBZczoKICAgICAgICBpZiAoYSAmJiAod3MudGVzdChhKSB8fCAiKyIgPT0gYSB8fCAiLSIgPT0gYSB8fCAiLiIgPT0gYSkpIGggKz0gYS50b0xvd2VyQ2FzZSgpO2Vsc2UgewogICAgICAgICAgaWYgKCI6IiAhPSBhKSB7CiAgICAgICAgICAgIGlmIChuKSByZXR1cm4gIkludmFsaWQgc2NoZW1lIjsKICAgICAgICAgICAgaCA9ICIiLCBjID0gR3MsIHUgPSAwOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAobiAmJiAoVXMoZSkgIT0gSShxcywgaCkgfHwgImZpbGUiID09IGggJiYgKEhzKGUpIHx8IG51bGwgIT09IGUucG9ydCkgfHwgImZpbGUiID09IGUuc2NoZW1lICYmICFlLmhvc3QpKSByZXR1cm47CiAgICAgICAgICBpZiAoZS5zY2hlbWUgPSBoLCBuKSByZXR1cm4gdm9pZCAoVXMoZSkgJiYgcXNbZS5zY2hlbWVdID09IGUucG9ydCAmJiAoZS5wb3J0ID0gbnVsbCkpOwogICAgICAgICAgaCA9ICIiLCAiZmlsZSIgPT0gZS5zY2hlbWUgPyBjID0gb2wgOiBVcyhlKSAmJiBpICYmIGkuc2NoZW1lID09IGUuc2NoZW1lID8gYyA9IFhzIDogVXMoZSkgPyBjID0gZWwgOiAiLyIgPT0gclt1ICsgMV0gPyAoYyA9IFFzLCB1KyspIDogKGUuY2Fubm90QmVBQmFzZVVSTCA9ICEwLCBlLnBhdGgucHVzaCgiIiksIGMgPSBobCk7CiAgICAgICAgfQogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSBHczoKICAgICAgICBpZiAoIWkgfHwgaS5jYW5ub3RCZUFCYXNlVVJMICYmICIjIiAhPSBhKSByZXR1cm4gIkludmFsaWQgc2NoZW1lIjsKCiAgICAgICAgaWYgKGkuY2Fubm90QmVBQmFzZVVSTCAmJiAiIyIgPT0gYSkgewogICAgICAgICAgZS5zY2hlbWUgPSBpLnNjaGVtZSwgZS5wYXRoID0gaS5wYXRoLnNsaWNlKCksIGUucXVlcnkgPSBpLnF1ZXJ5LCBlLmZyYWdtZW50ID0gIiIsIGUuY2Fubm90QmVBQmFzZVVSTCA9ICEwLCBjID0gZmw7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGMgPSAiZmlsZSIgPT0gaS5zY2hlbWUgPyBvbCA6IEpzOwogICAgICAgIGNvbnRpbnVlOwoKICAgICAgY2FzZSBYczoKICAgICAgICBpZiAoIi8iICE9IGEgfHwgIi8iICE9IHJbdSArIDFdKSB7CiAgICAgICAgICBjID0gSnM7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGMgPSB0bCwgdSsrOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSBRczoKICAgICAgICBpZiAoIi8iID09IGEpIHsKICAgICAgICAgIGMgPSBubDsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgYyA9IHVsOwogICAgICAgIGNvbnRpbnVlOwoKICAgICAgY2FzZSBKczoKICAgICAgICBpZiAoZS5zY2hlbWUgPSBpLnNjaGVtZSwgYSA9PSBjcykgZS51c2VybmFtZSA9IGkudXNlcm5hbWUsIGUucGFzc3dvcmQgPSBpLnBhc3N3b3JkLCBlLmhvc3QgPSBpLmhvc3QsIGUucG9ydCA9IGkucG9ydCwgZS5wYXRoID0gaS5wYXRoLnNsaWNlKCksIGUucXVlcnkgPSBpLnF1ZXJ5O2Vsc2UgaWYgKCIvIiA9PSBhIHx8ICJcXCIgPT0gYSAmJiBVcyhlKSkgYyA9IFpzO2Vsc2UgaWYgKCI/IiA9PSBhKSBlLnVzZXJuYW1lID0gaS51c2VybmFtZSwgZS5wYXNzd29yZCA9IGkucGFzc3dvcmQsIGUuaG9zdCA9IGkuaG9zdCwgZS5wb3J0ID0gaS5wb3J0LCBlLnBhdGggPSBpLnBhdGguc2xpY2UoKSwgZS5xdWVyeSA9ICIiLCBjID0gZGw7ZWxzZSB7CiAgICAgICAgICBpZiAoIiMiICE9IGEpIHsKICAgICAgICAgICAgZS51c2VybmFtZSA9IGkudXNlcm5hbWUsIGUucGFzc3dvcmQgPSBpLnBhc3N3b3JkLCBlLmhvc3QgPSBpLmhvc3QsIGUucG9ydCA9IGkucG9ydCwgZS5wYXRoID0gaS5wYXRoLnNsaWNlKCksIGUucGF0aC5wb3AoKSwgYyA9IHVsOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICBlLnVzZXJuYW1lID0gaS51c2VybmFtZSwgZS5wYXNzd29yZCA9IGkucGFzc3dvcmQsIGUuaG9zdCA9IGkuaG9zdCwgZS5wb3J0ID0gaS5wb3J0LCBlLnBhdGggPSBpLnBhdGguc2xpY2UoKSwgZS5xdWVyeSA9IGkucXVlcnksIGUuZnJhZ21lbnQgPSAiIiwgYyA9IGZsOwogICAgICAgIH0KICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgWnM6CiAgICAgICAgaWYgKCFVcyhlKSB8fCAiLyIgIT0gYSAmJiAiXFwiICE9IGEpIHsKICAgICAgICAgIGlmICgiLyIgIT0gYSkgewogICAgICAgICAgICBlLnVzZXJuYW1lID0gaS51c2VybmFtZSwgZS5wYXNzd29yZCA9IGkucGFzc3dvcmQsIGUuaG9zdCA9IGkuaG9zdCwgZS5wb3J0ID0gaS5wb3J0LCBjID0gdWw7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgfQoKICAgICAgICAgIGMgPSBubDsKICAgICAgICB9IGVsc2UgYyA9IHRsOwoKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgZWw6CiAgICAgICAgaWYgKGMgPSB0bCwgIi8iICE9IGEgfHwgIi8iICE9IGguY2hhckF0KHUgKyAxKSkgY29udGludWU7CiAgICAgICAgdSsrOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSB0bDoKICAgICAgICBpZiAoIi8iICE9IGEgJiYgIlxcIiAhPSBhKSB7CiAgICAgICAgICBjID0gbmw7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSBubDoKICAgICAgICBpZiAoIkAiID09IGEpIHsKICAgICAgICAgIGQgJiYgKGggPSAiJTQwIiArIGgpLCBkID0gITAsIG8gPSByaShoKTsKCiAgICAgICAgICBmb3IgKHZhciBtID0gMDsgbSA8IG8ubGVuZ3RoOyBtKyspIHsKICAgICAgICAgICAgdmFyIGcgPSBvW21dOwoKICAgICAgICAgICAgaWYgKCI6IiAhPSBnIHx8IHApIHsKICAgICAgICAgICAgICB2YXIgdiA9IEZzKGcsIERzKTsKICAgICAgICAgICAgICBwID8gZS5wYXNzd29yZCArPSB2IDogZS51c2VybmFtZSArPSB2OwogICAgICAgICAgICB9IGVsc2UgcCA9ICEwOwogICAgICAgICAgfQoKICAgICAgICAgIGggPSAiIjsKICAgICAgICB9IGVsc2UgaWYgKGEgPT0gY3MgfHwgIi8iID09IGEgfHwgIj8iID09IGEgfHwgIiMiID09IGEgfHwgIlxcIiA9PSBhICYmIFVzKGUpKSB7CiAgICAgICAgICBpZiAoZCAmJiAiIiA9PSBoKSByZXR1cm4gIkludmFsaWQgYXV0aG9yaXR5IjsKICAgICAgICAgIHUgLT0gcmkoaCkubGVuZ3RoICsgMSwgaCA9ICIiLCBjID0gaWw7CiAgICAgICAgfSBlbHNlIGggKz0gYTsKCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIGlsOgogICAgICBjYXNlIHJsOgogICAgICAgIGlmIChuICYmICJmaWxlIiA9PSBlLnNjaGVtZSkgewogICAgICAgICAgYyA9IGxsOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoIjoiICE9IGEgfHwgZikgewogICAgICAgICAgaWYgKGEgPT0gY3MgfHwgIi8iID09IGEgfHwgIj8iID09IGEgfHwgIiMiID09IGEgfHwgIlxcIiA9PSBhICYmIFVzKGUpKSB7CiAgICAgICAgICAgIGlmIChVcyhlKSAmJiAiIiA9PSBoKSByZXR1cm4gIkludmFsaWQgaG9zdCI7CiAgICAgICAgICAgIGlmIChuICYmICIiID09IGggJiYgKEhzKGUpIHx8IG51bGwgIT09IGUucG9ydCkpIHJldHVybjsKICAgICAgICAgICAgaWYgKHMgPSBJcyhlLCBoKSkgcmV0dXJuIHM7CiAgICAgICAgICAgIGlmIChoID0gIiIsIGMgPSBjbCwgbikgcmV0dXJuOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICAiWyIgPT0gYSA/IGYgPSAhMCA6ICJdIiA9PSBhICYmIChmID0gITEpLCBoICs9IGE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICgiIiA9PSBoKSByZXR1cm4gIkludmFsaWQgaG9zdCI7CiAgICAgICAgICBpZiAocyA9IElzKGUsIGgpKSByZXR1cm4gczsKICAgICAgICAgIGlmIChoID0gIiIsIGMgPSBhbCwgbiA9PSBybCkgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIGFsOgogICAgICAgIGlmICgha3MudGVzdChhKSkgewogICAgICAgICAgaWYgKGEgPT0gY3MgfHwgIi8iID09IGEgfHwgIj8iID09IGEgfHwgIiMiID09IGEgfHwgIlxcIiA9PSBhICYmIFVzKGUpIHx8IG4pIHsKICAgICAgICAgICAgaWYgKCIiICE9IGgpIHsKICAgICAgICAgICAgICB2YXIgeSA9IHBhcnNlSW50KGgsIDEwKTsKICAgICAgICAgICAgICBpZiAoeSA+IDY1NTM1KSByZXR1cm4gIkludmFsaWQgcG9ydCI7CiAgICAgICAgICAgICAgZS5wb3J0ID0gVXMoZSkgJiYgeSA9PT0gcXNbZS5zY2hlbWVdID8gbnVsbCA6IHksIGggPSAiIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG4pIHJldHVybjsKICAgICAgICAgICAgYyA9IGNsOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gIkludmFsaWQgcG9ydCI7CiAgICAgICAgfQoKICAgICAgICBoICs9IGE7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlIG9sOgogICAgICAgIGlmIChlLnNjaGVtZSA9ICJmaWxlIiwgIi8iID09IGEgfHwgIlxcIiA9PSBhKSBjID0gc2w7ZWxzZSB7CiAgICAgICAgICBpZiAoIWkgfHwgImZpbGUiICE9IGkuc2NoZW1lKSB7CiAgICAgICAgICAgIGMgPSB1bDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGEgPT0gY3MpIGUuaG9zdCA9IGkuaG9zdCwgZS5wYXRoID0gaS5wYXRoLnNsaWNlKCksIGUucXVlcnkgPSBpLnF1ZXJ5O2Vsc2UgaWYgKCI/IiA9PSBhKSBlLmhvc3QgPSBpLmhvc3QsIGUucGF0aCA9IGkucGF0aC5zbGljZSgpLCBlLnF1ZXJ5ID0gIiIsIGMgPSBkbDtlbHNlIHsKICAgICAgICAgICAgaWYgKCIjIiAhPSBhKSB7CiAgICAgICAgICAgICAgenMoci5zbGljZSh1KS5qb2luKCIiKSkgfHwgKGUuaG9zdCA9IGkuaG9zdCwgZS5wYXRoID0gaS5wYXRoLnNsaWNlKCksIFdzKGUpKSwgYyA9IHVsOwogICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBlLmhvc3QgPSBpLmhvc3QsIGUucGF0aCA9IGkucGF0aC5zbGljZSgpLCBlLnF1ZXJ5ID0gaS5xdWVyeSwgZS5mcmFnbWVudCA9ICIiLCBjID0gZmw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSBzbDoKICAgICAgICBpZiAoIi8iID09IGEgfHwgIlxcIiA9PSBhKSB7CiAgICAgICAgICBjID0gbGw7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIGkgJiYgImZpbGUiID09IGkuc2NoZW1lICYmICF6cyhyLnNsaWNlKHUpLmpvaW4oIiIpKSAmJiAoVnMoaS5wYXRoWzBdLCAhMCkgPyBlLnBhdGgucHVzaChpLnBhdGhbMF0pIDogZS5ob3N0ID0gaS5ob3N0KSwgYyA9IHVsOwogICAgICAgIGNvbnRpbnVlOwoKICAgICAgY2FzZSBsbDoKICAgICAgICBpZiAoYSA9PSBjcyB8fCAiLyIgPT0gYSB8fCAiXFwiID09IGEgfHwgIj8iID09IGEgfHwgIiMiID09IGEpIHsKICAgICAgICAgIGlmICghbiAmJiBWcyhoKSkgYyA9IHVsO2Vsc2UgaWYgKCIiID09IGgpIHsKICAgICAgICAgICAgaWYgKGUuaG9zdCA9ICIiLCBuKSByZXR1cm47CiAgICAgICAgICAgIGMgPSBjbDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChzID0gSXMoZSwgaCkpIHJldHVybiBzOwogICAgICAgICAgICBpZiAoImxvY2FsaG9zdCIgPT0gZS5ob3N0ICYmIChlLmhvc3QgPSAiIiksIG4pIHJldHVybjsKICAgICAgICAgICAgaCA9ICIiLCBjID0gY2w7CiAgICAgICAgICB9CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGggKz0gYTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgY2w6CiAgICAgICAgaWYgKFVzKGUpKSB7CiAgICAgICAgICBpZiAoYyA9IHVsLCAiLyIgIT0gYSAmJiAiXFwiICE9IGEpIGNvbnRpbnVlOwogICAgICAgIH0gZWxzZSBpZiAobiB8fCAiPyIgIT0gYSkgewogICAgICAgICAgaWYgKG4gfHwgIiMiICE9IGEpIHsKICAgICAgICAgICAgaWYgKGEgIT0gY3MgJiYgKGMgPSB1bCwgIi8iICE9IGEpKSBjb250aW51ZTsKICAgICAgICAgIH0gZWxzZSBlLmZyYWdtZW50ID0gIiIsIGMgPSBmbDsKICAgICAgICB9IGVsc2UgZS5xdWVyeSA9ICIiLCBjID0gZGw7CgogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSB1bDoKICAgICAgICBpZiAoYSA9PSBjcyB8fCAiLyIgPT0gYSB8fCAiXFwiID09IGEgJiYgVXMoZSkgfHwgIW4gJiYgKCI/IiA9PSBhIHx8ICIjIiA9PSBhKSkgewogICAgICAgICAgaWYgKCIuLiIgPT09IChsID0gKGwgPSBoKS50b0xvd2VyQ2FzZSgpKSB8fCAiJTJlLiIgPT09IGwgfHwgIi4lMmUiID09PSBsIHx8ICIlMmUlMmUiID09PSBsID8gKFdzKGUpLCAiLyIgPT0gYSB8fCAiXFwiID09IGEgJiYgVXMoZSkgfHwgZS5wYXRoLnB1c2goIiIpKSA6ICRzKGgpID8gIi8iID09IGEgfHwgIlxcIiA9PSBhICYmIFVzKGUpIHx8IGUucGF0aC5wdXNoKCIiKSA6ICgiZmlsZSIgPT0gZS5zY2hlbWUgJiYgIWUucGF0aC5sZW5ndGggJiYgVnMoaCkgJiYgKGUuaG9zdCAmJiAoZS5ob3N0ID0gIiIpLCBoID0gaC5jaGFyQXQoMCkgKyAiOiIpLCBlLnBhdGgucHVzaChoKSksIGggPSAiIiwgImZpbGUiID09IGUuc2NoZW1lICYmIChhID09IGNzIHx8ICI/IiA9PSBhIHx8ICIjIiA9PSBhKSkgZm9yICg7IGUucGF0aC5sZW5ndGggPiAxICYmICIiID09PSBlLnBhdGhbMF07KSB7CiAgICAgICAgICAgIGUucGF0aC5zaGlmdCgpOwogICAgICAgICAgfQogICAgICAgICAgIj8iID09IGEgPyAoZS5xdWVyeSA9ICIiLCBjID0gZGwpIDogIiMiID09IGEgJiYgKGUuZnJhZ21lbnQgPSAiIiwgYyA9IGZsKTsKICAgICAgICB9IGVsc2UgaCArPSBGcyhhLCBfcyk7CgogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSBobDoKICAgICAgICAiPyIgPT0gYSA/IChlLnF1ZXJ5ID0gIiIsIGMgPSBkbCkgOiAiIyIgPT0gYSA/IChlLmZyYWdtZW50ID0gIiIsIGMgPSBmbCkgOiBhICE9IGNzICYmIChlLnBhdGhbMF0gKz0gRnMoYSwganMpKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgZGw6CiAgICAgICAgbiB8fCAiIyIgIT0gYSA/IGEgIT0gY3MgJiYgKCInIiA9PSBhICYmIFVzKGUpID8gZS5xdWVyeSArPSAiJTI3IiA6IGUucXVlcnkgKz0gIiMiID09IGEgPyAiJTIzIiA6IEZzKGEsIGpzKSkgOiAoZS5mcmFnbWVudCA9ICIiLCBjID0gZmwpOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSBmbDoKICAgICAgICBhICE9IGNzICYmIChlLmZyYWdtZW50ICs9IEZzKGEsIFJzKSk7CiAgICB9CgogICAgdSsrOwogIH0KfSwKICAgIG1sID0gZnVuY3Rpb24gbWwoZSkgewogIHZhciBuLAogICAgICBpLAogICAgICByID0gb28odGhpcywgbWwsICJVUkwiKSwKICAgICAgYSA9IGFyZ3VtZW50cy5sZW5ndGggPiAxID8gYXJndW1lbnRzWzFdIDogdm9pZCAwLAogICAgICBvID0gU3RyaW5nKGUpLAogICAgICBzID0gbXMociwgewogICAgdHlwZTogIlVSTCIKICB9KTsKICBpZiAodm9pZCAwICE9PSBhKSBpZiAoYSBpbnN0YW5jZW9mIG1sKSBuID0gZ3MoYSk7ZWxzZSBpZiAoaSA9IHBsKG4gPSB7fSwgU3RyaW5nKGEpKSkgdGhyb3cgVHlwZUVycm9yKGkpOwogIGlmIChpID0gcGwocywgbywgbnVsbCwgbikpIHRocm93IFR5cGVFcnJvcihpKTsKICB2YXIgbCA9IHMuc2VhcmNoUGFyYW1zID0gbmV3IGZzKCksCiAgICAgIGMgPSBwcyhsKTsKICBjLnVwZGF0ZVNlYXJjaFBhcmFtcyhzLnF1ZXJ5KSwgYy51cGRhdGVVUkwgPSBmdW5jdGlvbiAoKSB7CiAgICBzLnF1ZXJ5ID0gU3RyaW5nKGwpIHx8IG51bGw7CiAgfSwgdCB8fCAoci5ocmVmID0gdmwuY2FsbChyKSwgci5vcmlnaW4gPSB5bC5jYWxsKHIpLCByLnByb3RvY29sID0gYmwuY2FsbChyKSwgci51c2VybmFtZSA9IHdsLmNhbGwociksIHIucGFzc3dvcmQgPSBrbC5jYWxsKHIpLCByLmhvc3QgPSBUbC5jYWxsKHIpLCByLmhvc3RuYW1lID0gU2wuY2FsbChyKSwgci5wb3J0ID0gRWwuY2FsbChyKSwgci5wYXRobmFtZSA9IEFsLmNhbGwociksIHIuc2VhcmNoID0geGwuY2FsbChyKSwgci5zZWFyY2hQYXJhbXMgPSBDbC5jYWxsKHIpLCByLmhhc2ggPSBQbC5jYWxsKHIpKTsKfSwKICAgIGdsID0gbWwucHJvdG90eXBlLAogICAgdmwgPSBmdW5jdGlvbiB2bCgpIHsKICB2YXIgZSA9IGdzKHRoaXMpLAogICAgICB0ID0gZS5zY2hlbWUsCiAgICAgIG4gPSBlLnVzZXJuYW1lLAogICAgICBpID0gZS5wYXNzd29yZCwKICAgICAgciA9IGUuaG9zdCwKICAgICAgYSA9IGUucG9ydCwKICAgICAgbyA9IGUucGF0aCwKICAgICAgcyA9IGUucXVlcnksCiAgICAgIGwgPSBlLmZyYWdtZW50LAogICAgICBjID0gdCArICI6IjsKICByZXR1cm4gbnVsbCAhPT0gciA/IChjICs9ICIvLyIsIEhzKGUpICYmIChjICs9IG4gKyAoaSA/ICI6IiArIGkgOiAiIikgKyAiQCIpLCBjICs9IE1zKHIpLCBudWxsICE9PSBhICYmIChjICs9ICI6IiArIGEpKSA6ICJmaWxlIiA9PSB0ICYmIChjICs9ICIvLyIpLCBjICs9IGUuY2Fubm90QmVBQmFzZVVSTCA/IG9bMF0gOiBvLmxlbmd0aCA/ICIvIiArIG8uam9pbigiLyIpIDogIiIsIG51bGwgIT09IHMgJiYgKGMgKz0gIj8iICsgcyksIG51bGwgIT09IGwgJiYgKGMgKz0gIiMiICsgbCksIGM7Cn0sCiAgICB5bCA9IGZ1bmN0aW9uIHlsKCkgewogIHZhciBlID0gZ3ModGhpcyksCiAgICAgIHQgPSBlLnNjaGVtZSwKICAgICAgbiA9IGUucG9ydDsKICBpZiAoImJsb2IiID09IHQpIHRyeSB7CiAgICByZXR1cm4gbmV3IFVSTCh0LnBhdGhbMF0pLm9yaWdpbjsKICB9IGNhdGNoIChlKSB7CiAgICByZXR1cm4gIm51bGwiOwogIH0KICByZXR1cm4gImZpbGUiICE9IHQgJiYgVXMoZSkgPyB0ICsgIjovLyIgKyBNcyhlLmhvc3QpICsgKG51bGwgIT09IG4gPyAiOiIgKyBuIDogIiIpIDogIm51bGwiOwp9LAogICAgYmwgPSBmdW5jdGlvbiBibCgpIHsKICByZXR1cm4gZ3ModGhpcykuc2NoZW1lICsgIjoiOwp9LAogICAgd2wgPSBmdW5jdGlvbiB3bCgpIHsKICByZXR1cm4gZ3ModGhpcykudXNlcm5hbWU7Cn0sCiAgICBrbCA9IGZ1bmN0aW9uIGtsKCkgewogIHJldHVybiBncyh0aGlzKS5wYXNzd29yZDsKfSwKICAgIFRsID0gZnVuY3Rpb24gVGwoKSB7CiAgdmFyIGUgPSBncyh0aGlzKSwKICAgICAgdCA9IGUuaG9zdCwKICAgICAgbiA9IGUucG9ydDsKICByZXR1cm4gbnVsbCA9PT0gdCA/ICIiIDogbnVsbCA9PT0gbiA/IE1zKHQpIDogTXModCkgKyAiOiIgKyBuOwp9LAogICAgU2wgPSBmdW5jdGlvbiBTbCgpIHsKICB2YXIgZSA9IGdzKHRoaXMpLmhvc3Q7CiAgcmV0dXJuIG51bGwgPT09IGUgPyAiIiA6IE1zKGUpOwp9LAogICAgRWwgPSBmdW5jdGlvbiBFbCgpIHsKICB2YXIgZSA9IGdzKHRoaXMpLnBvcnQ7CiAgcmV0dXJuIG51bGwgPT09IGUgPyAiIiA6IFN0cmluZyhlKTsKfSwKICAgIEFsID0gZnVuY3Rpb24gQWwoKSB7CiAgdmFyIGUgPSBncyh0aGlzKSwKICAgICAgdCA9IGUucGF0aDsKICByZXR1cm4gZS5jYW5ub3RCZUFCYXNlVVJMID8gdFswXSA6IHQubGVuZ3RoID8gIi8iICsgdC5qb2luKCIvIikgOiAiIjsKfSwKICAgIHhsID0gZnVuY3Rpb24geGwoKSB7CiAgdmFyIGUgPSBncyh0aGlzKS5xdWVyeTsKICByZXR1cm4gZSA/ICI/IiArIGUgOiAiIjsKfSwKICAgIENsID0gZnVuY3Rpb24gQ2woKSB7CiAgcmV0dXJuIGdzKHRoaXMpLnNlYXJjaFBhcmFtczsKfSwKICAgIFBsID0gZnVuY3Rpb24gUGwoKSB7CiAgdmFyIGUgPSBncyh0aGlzKS5mcmFnbWVudDsKICByZXR1cm4gZSA/ICIjIiArIGUgOiAiIjsKfSwKICAgIE9sID0gZnVuY3Rpb24gT2woZSwgdCkgewogIHJldHVybiB7CiAgICBnZXQ6IGUsCiAgICBzZXQ6IHQsCiAgICBjb25maWd1cmFibGU6ICEwLAogICAgZW51bWVyYWJsZTogITAKICB9Owp9OwoKaWYgKHQgJiYgVWUoZ2wsIHsKICBocmVmOiBPbCh2bCwgZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gZ3ModGhpcyksCiAgICAgICAgbiA9IFN0cmluZyhlKSwKICAgICAgICBpID0gcGwodCwgbik7CiAgICBpZiAoaSkgdGhyb3cgVHlwZUVycm9yKGkpOwogICAgcHModC5zZWFyY2hQYXJhbXMpLnVwZGF0ZVNlYXJjaFBhcmFtcyh0LnF1ZXJ5KTsKICB9KSwKICBvcmlnaW46IE9sKHlsKSwKICBwcm90b2NvbDogT2woYmwsIGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IGdzKHRoaXMpOwogICAgcGwodCwgU3RyaW5nKGUpICsgIjoiLCBLcyk7CiAgfSksCiAgdXNlcm5hbWU6IE9sKHdsLCBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSBncyh0aGlzKSwKICAgICAgICBuID0gcmkoU3RyaW5nKGUpKTsKCiAgICBpZiAoIUJzKHQpKSB7CiAgICAgIHQudXNlcm5hbWUgPSAiIjsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbi5sZW5ndGg7IGkrKykgewogICAgICAgIHQudXNlcm5hbWUgKz0gRnMobltpXSwgRHMpOwogICAgICB9CiAgICB9CiAgfSksCiAgcGFzc3dvcmQ6IE9sKGtsLCBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSBncyh0aGlzKSwKICAgICAgICBuID0gcmkoU3RyaW5nKGUpKTsKCiAgICBpZiAoIUJzKHQpKSB7CiAgICAgIHQucGFzc3dvcmQgPSAiIjsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbi5sZW5ndGg7IGkrKykgewogICAgICAgIHQucGFzc3dvcmQgKz0gRnMobltpXSwgRHMpOwogICAgICB9CiAgICB9CiAgfSksCiAgaG9zdDogT2woVGwsIGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IGdzKHRoaXMpOwogICAgdC5jYW5ub3RCZUFCYXNlVVJMIHx8IHBsKHQsIFN0cmluZyhlKSwgaWwpOwogIH0pLAogIGhvc3RuYW1lOiBPbChTbCwgZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gZ3ModGhpcyk7CiAgICB0LmNhbm5vdEJlQUJhc2VVUkwgfHwgcGwodCwgU3RyaW5nKGUpLCBybCk7CiAgfSksCiAgcG9ydDogT2woRWwsIGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IGdzKHRoaXMpOwogICAgQnModCkgfHwgKCIiID09IChlID0gU3RyaW5nKGUpKSA/IHQucG9ydCA9IG51bGwgOiBwbCh0LCBlLCBhbCkpOwogIH0pLAogIHBhdGhuYW1lOiBPbChBbCwgZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gZ3ModGhpcyk7CiAgICB0LmNhbm5vdEJlQUJhc2VVUkwgfHwgKHQucGF0aCA9IFtdLCBwbCh0LCBlICsgIiIsIGNsKSk7CiAgfSksCiAgc2VhcmNoOiBPbCh4bCwgZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gZ3ModGhpcyk7CiAgICAiIiA9PSAoZSA9IFN0cmluZyhlKSkgPyB0LnF1ZXJ5ID0gbnVsbCA6ICgiPyIgPT0gZS5jaGFyQXQoMCkgJiYgKGUgPSBlLnNsaWNlKDEpKSwgdC5xdWVyeSA9ICIiLCBwbCh0LCBlLCBkbCkpLCBwcyh0LnNlYXJjaFBhcmFtcykudXBkYXRlU2VhcmNoUGFyYW1zKHQucXVlcnkpOwogIH0pLAogIHNlYXJjaFBhcmFtczogT2woQ2wpLAogIGhhc2g6IE9sKFBsLCBmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSBncyh0aGlzKTsKICAgICIiICE9IChlID0gU3RyaW5nKGUpKSA/ICgiIyIgPT0gZS5jaGFyQXQoMCkgJiYgKGUgPSBlLnNsaWNlKDEpKSwgdC5mcmFnbWVudCA9ICIiLCBwbCh0LCBlLCBmbCkpIDogdC5mcmFnbWVudCA9IG51bGw7CiAgfSkKfSksIHJlKGdsLCAidG9KU09OIiwgZnVuY3Rpb24gKCkgewogIHJldHVybiB2bC5jYWxsKHRoaXMpOwp9LCB7CiAgZW51bWVyYWJsZTogITAKfSksIHJlKGdsLCAidG9TdHJpbmciLCBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIHZsLmNhbGwodGhpcyk7Cn0sIHsKICBlbnVtZXJhYmxlOiAhMAp9KSwgZHMpIHsKICB2YXIgSWwgPSBkcy5jcmVhdGVPYmplY3RVUkwsCiAgICAgIExsID0gZHMucmV2b2tlT2JqZWN0VVJMOwogIElsICYmIHJlKG1sLCAiY3JlYXRlT2JqZWN0VVJMIiwgZnVuY3Rpb24gKGUpIHsKICAgIHJldHVybiBJbC5hcHBseShkcywgYXJndW1lbnRzKTsKICB9KSwgTGwgJiYgcmUobWwsICJyZXZva2VPYmplY3RVUkwiLCBmdW5jdGlvbiAoZSkgewogICAgcmV0dXJuIExsLmFwcGx5KGRzLCBhcmd1bWVudHMpOwogIH0pOwp9CgpmdW5jdGlvbiBObChlLCB0KSB7CiAgaWYgKCEoZSBpbnN0YW5jZW9mIHQpKSB0aHJvdyBuZXcgVHlwZUVycm9yKCJDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24iKTsKfQoKZnVuY3Rpb24gTWwoZSwgdCkgewogIGZvciAodmFyIG4gPSAwOyBuIDwgdC5sZW5ndGg7IG4rKykgewogICAgdmFyIGkgPSB0W25dOwogICAgaS5lbnVtZXJhYmxlID0gaS5lbnVtZXJhYmxlIHx8ICExLCBpLmNvbmZpZ3VyYWJsZSA9ICEwLCAidmFsdWUiIGluIGkgJiYgKGkud3JpdGFibGUgPSAhMCksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCBpLmtleSwgaSk7CiAgfQp9CgpmdW5jdGlvbiBqbChlLCB0LCBuKSB7CiAgcmV0dXJuIHQgJiYgTWwoZS5wcm90b3R5cGUsIHQpLCBuICYmIE1sKGUsIG4pLCBlOwp9CgpmdW5jdGlvbiBSbChlLCB0LCBuKSB7CiAgcmV0dXJuIHQgaW4gZSA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLCB0LCB7CiAgICB2YWx1ZTogbiwKICAgIGVudW1lcmFibGU6ICEwLAogICAgY29uZmlndXJhYmxlOiAhMCwKICAgIHdyaXRhYmxlOiAhMAogIH0pIDogZVt0XSA9IG4sIGU7Cn0KCmZ1bmN0aW9uIF9sKGUsIHQpIHsKICB2YXIgbiA9IE9iamVjdC5rZXlzKGUpOwoKICBpZiAoT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scykgewogICAgdmFyIGkgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKGUpOwogICAgdCAmJiAoaSA9IGkuZmlsdGVyKGZ1bmN0aW9uICh0KSB7CiAgICAgIHJldHVybiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGUsIHQpLmVudW1lcmFibGU7CiAgICB9KSksIG4ucHVzaC5hcHBseShuLCBpKTsKICB9CgogIHJldHVybiBuOwp9CgpmdW5jdGlvbiBEbChlKSB7CiAgZm9yICh2YXIgdCA9IDE7IHQgPCBhcmd1bWVudHMubGVuZ3RoOyB0KyspIHsKICAgIHZhciBuID0gbnVsbCAhPSBhcmd1bWVudHNbdF0gPyBhcmd1bWVudHNbdF0gOiB7fTsKICAgIHQgJSAyID8gX2woT2JqZWN0KG4pLCAhMCkuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICBSbChlLCB0LCBuW3RdKTsKICAgIH0pIDogT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMgPyBPYmplY3QuZGVmaW5lUHJvcGVydGllcyhlLCBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhuKSkgOiBfbChPYmplY3QobikpLmZvckVhY2goZnVuY3Rpb24gKHQpIHsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHQsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IobiwgdCkpOwogICAgfSk7CiAgfQoKICByZXR1cm4gZTsKfQoKZnVuY3Rpb24gRmwoZSwgdCkgewogIGlmIChudWxsID09IGUpIHJldHVybiB7fTsKCiAgdmFyIG4sCiAgICAgIGksCiAgICAgIHIgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgaWYgKG51bGwgPT0gZSkgcmV0dXJuIHt9OwogICAgdmFyIG4sCiAgICAgICAgaSwKICAgICAgICByID0ge30sCiAgICAgICAgYSA9IE9iamVjdC5rZXlzKGUpOwoKICAgIGZvciAoaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7CiAgICAgIG4gPSBhW2ldLCB0LmluZGV4T2YobikgPj0gMCB8fCAocltuXSA9IGVbbl0pOwogICAgfQoKICAgIHJldHVybiByOwogIH0oZSwgdCk7CgogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgYSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CgogICAgZm9yIChpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHsKICAgICAgbiA9IGFbaV0sIHQuaW5kZXhPZihuKSA+PSAwIHx8IE9iamVjdC5wcm90b3R5cGUucHJvcGVydHlJc0VudW1lcmFibGUuY2FsbChlLCBuKSAmJiAocltuXSA9IGVbbl0pOwogICAgfQogIH0KCiAgcmV0dXJuIHI7Cn0KCmZ1bmN0aW9uIHFsKGUsIHQpIHsKICByZXR1cm4gZnVuY3Rpb24gKGUpIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGUpKSByZXR1cm4gZTsKICB9KGUpIHx8IGZ1bmN0aW9uIChlLCB0KSB7CiAgICBpZiAoInVuZGVmaW5lZCIgIT0gdHlwZW9mIFN5bWJvbCAmJiBTeW1ib2wuaXRlcmF0b3IgaW4gT2JqZWN0KGUpKSB7CiAgICAgIHZhciBuID0gW10sCiAgICAgICAgICBpID0gITAsCiAgICAgICAgICByID0gITEsCiAgICAgICAgICBhID0gdm9pZCAwOwoKICAgICAgdHJ5IHsKICAgICAgICBmb3IgKHZhciBvLCBzID0gZVtTeW1ib2wuaXRlcmF0b3JdKCk7ICEoaSA9IChvID0gcy5uZXh0KCkpLmRvbmUpICYmIChuLnB1c2goby52YWx1ZSksICF0IHx8IG4ubGVuZ3RoICE9PSB0KTsgaSA9ICEwKSB7CiAgICAgICAgICA7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgciA9ICEwLCBhID0gZTsKICAgICAgfSBmaW5hbGx5IHsKICAgICAgICB0cnkgewogICAgICAgICAgaSB8fCBudWxsID09IHMucmV0dXJuIHx8IHMucmV0dXJuKCk7CiAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgIGlmIChyKSB0aHJvdyBhOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG47CiAgICB9CiAgfShlLCB0KSB8fCBIbChlLCB0KSB8fCBmdW5jdGlvbiAoKSB7CiAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJJbnZhbGlkIGF0dGVtcHQgdG8gZGVzdHJ1Y3R1cmUgbm9uLWl0ZXJhYmxlIGluc3RhbmNlLlxuSW4gb3JkZXIgdG8gYmUgaXRlcmFibGUsIG5vbi1hcnJheSBvYmplY3RzIG11c3QgaGF2ZSBhIFtTeW1ib2wuaXRlcmF0b3JdKCkgbWV0aG9kLiIpOwogIH0oKTsKfQoKZnVuY3Rpb24gVWwoZSkgewogIHJldHVybiBmdW5jdGlvbiAoZSkgewogICAgaWYgKEFycmF5LmlzQXJyYXkoZSkpIHJldHVybiBCbChlKTsKICB9KGUpIHx8IGZ1bmN0aW9uIChlKSB7CiAgICBpZiAoInVuZGVmaW5lZCIgIT0gdHlwZW9mIFN5bWJvbCAmJiBTeW1ib2wuaXRlcmF0b3IgaW4gT2JqZWN0KGUpKSByZXR1cm4gQXJyYXkuZnJvbShlKTsKICB9KGUpIHx8IEhsKGUpIHx8IGZ1bmN0aW9uICgpIHsKICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkludmFsaWQgYXR0ZW1wdCB0byBzcHJlYWQgbm9uLWl0ZXJhYmxlIGluc3RhbmNlLlxuSW4gb3JkZXIgdG8gYmUgaXRlcmFibGUsIG5vbi1hcnJheSBvYmplY3RzIG11c3QgaGF2ZSBhIFtTeW1ib2wuaXRlcmF0b3JdKCkgbWV0aG9kLiIpOwogIH0oKTsKfQoKZnVuY3Rpb24gSGwoZSwgdCkgewogIGlmIChlKSB7CiAgICBpZiAoInN0cmluZyIgPT0gdHlwZW9mIGUpIHJldHVybiBCbChlLCB0KTsKICAgIHZhciBuID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKGUpLnNsaWNlKDgsIC0xKTsKICAgIHJldHVybiAiT2JqZWN0IiA9PT0gbiAmJiBlLmNvbnN0cnVjdG9yICYmIChuID0gZS5jb25zdHJ1Y3Rvci5uYW1lKSwgIk1hcCIgPT09IG4gfHwgIlNldCIgPT09IG4gPyBBcnJheS5mcm9tKGUpIDogIkFyZ3VtZW50cyIgPT09IG4gfHwgL14oPzpVaXxJKW50KD86OHwxNnwzMikoPzpDbGFtcGVkKT9BcnJheSQvLnRlc3QobikgPyBCbChlLCB0KSA6IHZvaWQgMDsKICB9Cn0KCmZ1bmN0aW9uIEJsKGUsIHQpIHsKICAobnVsbCA9PSB0IHx8IHQgPiBlLmxlbmd0aCkgJiYgKHQgPSBlLmxlbmd0aCk7CgogIGZvciAodmFyIG4gPSAwLCBpID0gbmV3IEFycmF5KHQpOyBuIDwgdDsgbisrKSB7CiAgICBpW25dID0gZVtuXTsKICB9CgogIHJldHVybiBpOwp9CgpmdW5jdGlvbiBWbChlLCB0KSB7CiAgZm9yICh2YXIgbiA9IDA7IG4gPCB0Lmxlbmd0aDsgbisrKSB7CiAgICB2YXIgaSA9IHRbbl07CiAgICBpLmVudW1lcmFibGUgPSBpLmVudW1lcmFibGUgfHwgITEsIGkuY29uZmlndXJhYmxlID0gITAsICJ2YWx1ZSIgaW4gaSAmJiAoaS53cml0YWJsZSA9ICEwKSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIGkua2V5LCBpKTsKICB9Cn0KCmZ1bmN0aW9uIHpsKGUsIHQsIG4pIHsKICByZXR1cm4gdCBpbiBlID8gT2JqZWN0LmRlZmluZVByb3BlcnR5KGUsIHQsIHsKICAgIHZhbHVlOiBuLAogICAgZW51bWVyYWJsZTogITAsCiAgICBjb25maWd1cmFibGU6ICEwLAogICAgd3JpdGFibGU6ICEwCiAgfSkgOiBlW3RdID0gbiwgZTsKfQoKZnVuY3Rpb24gV2woZSwgdCkgewogIHZhciBuID0gT2JqZWN0LmtleXMoZSk7CgogIGlmIChPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKSB7CiAgICB2YXIgaSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoZSk7CiAgICB0ICYmIChpID0gaS5maWx0ZXIoZnVuY3Rpb24gKHQpIHsKICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoZSwgdCkuZW51bWVyYWJsZTsKICAgIH0pKSwgbi5wdXNoLmFwcGx5KG4sIGkpOwogIH0KCiAgcmV0dXJuIG47Cn0KCmZ1bmN0aW9uICRsKGUpIHsKICBmb3IgKHZhciB0ID0gMTsgdCA8IGFyZ3VtZW50cy5sZW5ndGg7IHQrKykgewogICAgdmFyIG4gPSBudWxsICE9IGFyZ3VtZW50c1t0XSA/IGFyZ3VtZW50c1t0XSA6IHt9OwogICAgdCAlIDIgPyBXbChPYmplY3QobiksICEwKS5mb3JFYWNoKGZ1bmN0aW9uICh0KSB7CiAgICAgIHpsKGUsIHQsIG5bdF0pOwogICAgfSkgOiBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyA/IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKGUsIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKG4pKSA6IFdsKE9iamVjdChuKSkuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZSwgdCwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihuLCB0KSk7CiAgICB9KTsKICB9CgogIHJldHVybiBlOwp9CgpvdChtbCwgIlVSTCIpLCBqZSh7CiAgZ2xvYmFsOiAhMCwKICBmb3JjZWQ6ICFPbywKICBzaGFtOiAhdAp9LCB7CiAgVVJMOiBtbAp9KTsKdmFyIEtsID0gewogIGFkZENTUzogITAsCiAgdGh1bWJXaWR0aDogMTUsCiAgd2F0Y2g6ICEwCn07CgpmdW5jdGlvbiBZbChlLCB0KSB7CiAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodCkpLmluY2x1ZGVzKHRoaXMpOwogIH0uY2FsbChlLCB0KTsKfQoKdmFyIEdsID0gZnVuY3Rpb24gR2woZSkgewogIHJldHVybiBudWxsICE9IGUgPyBlLmNvbnN0cnVjdG9yIDogbnVsbDsKfSwKICAgIFhsID0gZnVuY3Rpb24gWGwoZSwgdCkgewogIHJldHVybiAhIShlICYmIHQgJiYgZSBpbnN0YW5jZW9mIHQpOwp9LAogICAgUWwgPSBmdW5jdGlvbiBRbChlKSB7CiAgcmV0dXJuIG51bGwgPT0gZTsKfSwKICAgIEpsID0gZnVuY3Rpb24gSmwoZSkgewogIHJldHVybiBHbChlKSA9PT0gT2JqZWN0Owp9LAogICAgWmwgPSBmdW5jdGlvbiBabChlKSB7CiAgcmV0dXJuIEdsKGUpID09PSBTdHJpbmc7Cn0sCiAgICBlYyA9IGZ1bmN0aW9uIGVjKGUpIHsKICByZXR1cm4gQXJyYXkuaXNBcnJheShlKTsKfSwKICAgIHRjID0gZnVuY3Rpb24gdGMoZSkgewogIHJldHVybiBYbChlLCBOb2RlTGlzdCk7Cn0sCiAgICBuYyA9IFpsLAogICAgaWMgPSBlYywKICAgIHJjID0gdGMsCiAgICBhYyA9IGZ1bmN0aW9uIGFjKGUpIHsKICByZXR1cm4gWGwoZSwgRWxlbWVudCk7Cn0sCiAgICBvYyA9IGZ1bmN0aW9uIG9jKGUpIHsKICByZXR1cm4gWGwoZSwgRXZlbnQpOwp9LAogICAgc2MgPSBmdW5jdGlvbiBzYyhlKSB7CiAgcmV0dXJuIFFsKGUpIHx8IChabChlKSB8fCBlYyhlKSB8fCB0YyhlKSkgJiYgIWUubGVuZ3RoIHx8IEpsKGUpICYmICFPYmplY3Qua2V5cyhlKS5sZW5ndGg7Cn07CgpmdW5jdGlvbiBsYyhlLCB0KSB7CiAgaWYgKDEgPiB0KSB7CiAgICB2YXIgbiA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciB0ID0gIiIuY29uY2F0KGUpLm1hdGNoKC8oPzpcLihcZCspKT8oPzpbZUVdKFsrLV0/XGQrKSk/JC8pOwogICAgICByZXR1cm4gdCA/IE1hdGgubWF4KDAsICh0WzFdID8gdFsxXS5sZW5ndGggOiAwKSAtICh0WzJdID8gK3RbMl0gOiAwKSkgOiAwOwogICAgfSh0KTsKCiAgICByZXR1cm4gcGFyc2VGbG9hdChlLnRvRml4ZWQobikpOwogIH0KCiAgcmV0dXJuIE1hdGgucm91bmQoZSAvIHQpICogdDsKfQoKdmFyIGNjLAogICAgdWMsCiAgICBoYywKICAgIGRjID0gZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIGUodCwgbikgewogICAgKGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgIGlmICghKGUgaW5zdGFuY2VvZiB0KSkgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7CiAgICB9KSh0aGlzLCBlKSwgYWModCkgPyB0aGlzLmVsZW1lbnQgPSB0IDogbmModCkgJiYgKHRoaXMuZWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IodCkpLCBhYyh0aGlzLmVsZW1lbnQpICYmIHNjKHRoaXMuZWxlbWVudC5yYW5nZVRvdWNoKSAmJiAodGhpcy5jb25maWcgPSAkbCh7fSwgS2wsIHt9LCBuKSwgdGhpcy5pbml0KCkpOwogIH0KCiAgcmV0dXJuIGZ1bmN0aW9uIChlLCB0LCBuKSB7CiAgICB0ICYmIFZsKGUucHJvdG90eXBlLCB0KSwgbiAmJiBWbChlLCBuKTsKICB9KGUsIFt7CiAgICBrZXk6ICJpbml0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgZS5lbmFibGVkICYmICh0aGlzLmNvbmZpZy5hZGRDU1MgJiYgKHRoaXMuZWxlbWVudC5zdHlsZS51c2VyU2VsZWN0ID0gIm5vbmUiLCB0aGlzLmVsZW1lbnQuc3R5bGUud2ViS2l0VXNlclNlbGVjdCA9ICJub25lIiwgdGhpcy5lbGVtZW50LnN0eWxlLnRvdWNoQWN0aW9uID0gIm1hbmlwdWxhdGlvbiIpLCB0aGlzLmxpc3RlbmVycyghMCksIHRoaXMuZWxlbWVudC5yYW5nZVRvdWNoID0gdGhpcyk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZGVzdHJveSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIGUuZW5hYmxlZCAmJiAodGhpcy5jb25maWcuYWRkQ1NTICYmICh0aGlzLmVsZW1lbnQuc3R5bGUudXNlclNlbGVjdCA9ICIiLCB0aGlzLmVsZW1lbnQuc3R5bGUud2ViS2l0VXNlclNlbGVjdCA9ICIiLCB0aGlzLmVsZW1lbnQuc3R5bGUudG91Y2hBY3Rpb24gPSAiIiksIHRoaXMubGlzdGVuZXJzKCExKSwgdGhpcy5lbGVtZW50LnJhbmdlVG91Y2ggPSBudWxsKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJsaXN0ZW5lcnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGUpIHsKICAgICAgdmFyIHQgPSB0aGlzLAogICAgICAgICAgbiA9IGUgPyAiYWRkRXZlbnRMaXN0ZW5lciIgOiAicmVtb3ZlRXZlbnRMaXN0ZW5lciI7CiAgICAgIFsidG91Y2hzdGFydCIsICJ0b3VjaG1vdmUiLCAidG91Y2hlbmQiXS5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdC5lbGVtZW50W25dKGUsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICByZXR1cm4gdC5zZXQoZSk7CiAgICAgICAgfSwgITEpOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJnZXQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKHQpIHsKICAgICAgaWYgKCFlLmVuYWJsZWQgfHwgIW9jKHQpKSByZXR1cm4gbnVsbDsKICAgICAgdmFyIG4sCiAgICAgICAgICBpID0gdC50YXJnZXQsCiAgICAgICAgICByID0gdC5jaGFuZ2VkVG91Y2hlc1swXSwKICAgICAgICAgIGEgPSBwYXJzZUZsb2F0KGkuZ2V0QXR0cmlidXRlKCJtaW4iKSkgfHwgMCwKICAgICAgICAgIG8gPSBwYXJzZUZsb2F0KGkuZ2V0QXR0cmlidXRlKCJtYXgiKSkgfHwgMTAwLAogICAgICAgICAgcyA9IHBhcnNlRmxvYXQoaS5nZXRBdHRyaWJ1dGUoInN0ZXAiKSkgfHwgMSwKICAgICAgICAgIGwgPSBpLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLAogICAgICAgICAgYyA9IDEwMCAvIGwud2lkdGggKiAodGhpcy5jb25maWcudGh1bWJXaWR0aCAvIDIpIC8gMTAwOwogICAgICByZXR1cm4gMCA+IChuID0gMTAwIC8gbC53aWR0aCAqIChyLmNsaWVudFggLSBsLmxlZnQpKSA/IG4gPSAwIDogMTAwIDwgbiAmJiAobiA9IDEwMCksIDUwID4gbiA/IG4gLT0gKDEwMCAtIDIgKiBuKSAqIGMgOiA1MCA8IG4gJiYgKG4gKz0gMiAqIChuIC0gNTApICogYyksIGEgKyBsYyhuIC8gMTAwICogKG8gLSBhKSwgcyk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSh0KSB7CiAgICAgIGUuZW5hYmxlZCAmJiBvYyh0KSAmJiAhdC50YXJnZXQuZGlzYWJsZWQgJiYgKHQucHJldmVudERlZmF1bHQoKSwgdC50YXJnZXQudmFsdWUgPSB0aGlzLmdldCh0KSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICBpZiAoZSAmJiB0KSB7CiAgICAgICAgICB2YXIgbiA9IG5ldyBFdmVudCh0LCB7CiAgICAgICAgICAgIGJ1YmJsZXM6ICEwCiAgICAgICAgICB9KTsKICAgICAgICAgIGUuZGlzcGF0Y2hFdmVudChuKTsKICAgICAgICB9CiAgICAgIH0odC50YXJnZXQsICJ0b3VjaGVuZCIgPT09IHQudHlwZSA/ICJjaGFuZ2UiIDogImlucHV0IikpOwogICAgfQogIH1dLCBbewogICAga2V5OiAic2V0dXAiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKHQpIHsKICAgICAgdmFyIG4gPSAxIDwgYXJndW1lbnRzLmxlbmd0aCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSA/IGFyZ3VtZW50c1sxXSA6IHt9LAogICAgICAgICAgaSA9IG51bGw7CiAgICAgIGlmIChzYyh0KSB8fCBuYyh0KSA/IGkgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwobmModCkgPyB0IDogJ2lucHV0W3R5cGU9InJhbmdlIl0nKSkgOiBhYyh0KSA/IGkgPSBbdF0gOiByYyh0KSA/IGkgPSBBcnJheS5mcm9tKHQpIDogaWModCkgJiYgKGkgPSB0LmZpbHRlcihhYykpLCBzYyhpKSkgcmV0dXJuIG51bGw7CiAgICAgIHZhciByID0gJGwoe30sIEtsLCB7fSwgbik7CgogICAgICBpZiAobmModCkgJiYgci53YXRjaCkgewogICAgICAgIHZhciBhID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24gKG4pIHsKICAgICAgICAgIEFycmF5LmZyb20obikuZm9yRWFjaChmdW5jdGlvbiAobikgewogICAgICAgICAgICBBcnJheS5mcm9tKG4uYWRkZWROb2RlcykuZm9yRWFjaChmdW5jdGlvbiAobikgewogICAgICAgICAgICAgIGFjKG4pICYmIFlsKG4sIHQpICYmIG5ldyBlKG4sIHIpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgICAgIGEub2JzZXJ2ZShkb2N1bWVudC5ib2R5LCB7CiAgICAgICAgICBjaGlsZExpc3Q6ICEwLAogICAgICAgICAgc3VidHJlZTogITAKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgcmV0dXJuIGkubWFwKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgcmV0dXJuIG5ldyBlKHQsIG4pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJlbmFibGVkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gIm9udG91Y2hzdGFydCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgfQogIH1dKSwgZTsKfSgpLAogICAgZmMgPSBmdW5jdGlvbiBmYyhlKSB7CiAgcmV0dXJuIG51bGwgIT0gZSA/IGUuY29uc3RydWN0b3IgOiBudWxsOwp9LAogICAgcGMgPSBmdW5jdGlvbiBwYyhlLCB0KSB7CiAgcmV0dXJuIEJvb2xlYW4oZSAmJiB0ICYmIGUgaW5zdGFuY2VvZiB0KTsKfSwKICAgIG1jID0gZnVuY3Rpb24gbWMoZSkgewogIHJldHVybiBudWxsID09IGU7Cn0sCiAgICBnYyA9IGZ1bmN0aW9uIGdjKGUpIHsKICByZXR1cm4gZmMoZSkgPT09IE9iamVjdDsKfSwKICAgIHZjID0gZnVuY3Rpb24gdmMoZSkgewogIHJldHVybiBmYyhlKSA9PT0gU3RyaW5nOwp9LAogICAgeWMgPSBmdW5jdGlvbiB5YyhlKSB7CiAgcmV0dXJuIGZjKGUpID09PSBGdW5jdGlvbjsKfSwKICAgIGJjID0gZnVuY3Rpb24gYmMoZSkgewogIHJldHVybiBBcnJheS5pc0FycmF5KGUpOwp9LAogICAgd2MgPSBmdW5jdGlvbiB3YyhlKSB7CiAgcmV0dXJuIHBjKGUsIE5vZGVMaXN0KTsKfSwKICAgIGtjID0gZnVuY3Rpb24ga2MoZSkgewogIHJldHVybiBtYyhlKSB8fCAodmMoZSkgfHwgYmMoZSkgfHwgd2MoZSkpICYmICFlLmxlbmd0aCB8fCBnYyhlKSAmJiAhT2JqZWN0LmtleXMoZSkubGVuZ3RoOwp9LAogICAgVGMgPSBtYywKICAgIFNjID0gZ2MsCiAgICBFYyA9IGZ1bmN0aW9uIEVjKGUpIHsKICByZXR1cm4gZmMoZSkgPT09IE51bWJlciAmJiAhTnVtYmVyLmlzTmFOKGUpOwp9LAogICAgQWMgPSB2YywKICAgIHhjID0gZnVuY3Rpb24geGMoZSkgewogIHJldHVybiBmYyhlKSA9PT0gQm9vbGVhbjsKfSwKICAgIENjID0geWMsCiAgICBQYyA9IGJjLAogICAgT2MgPSB3YywKICAgIEljID0gZnVuY3Rpb24gSWMoZSkgewogIHJldHVybiBwYyhlLCBFbGVtZW50KTsKfSwKICAgIExjID0gZnVuY3Rpb24gTGMoZSkgewogIHJldHVybiBwYyhlLCBFdmVudCk7Cn0sCiAgICBOYyA9IGZ1bmN0aW9uIE5jKGUpIHsKICByZXR1cm4gcGMoZSwgS2V5Ym9hcmRFdmVudCk7Cn0sCiAgICBNYyA9IGZ1bmN0aW9uIE1jKGUpIHsKICByZXR1cm4gcGMoZSwgVGV4dFRyYWNrKSB8fCAhbWMoZSkgJiYgdmMoZS5raW5kKTsKfSwKICAgIGpjID0gZnVuY3Rpb24gamMoZSkgewogIHJldHVybiBwYyhlLCBQcm9taXNlKSAmJiB5YyhlLnRoZW4pOwp9LAogICAgUmMgPSBmdW5jdGlvbiBSYyhlKSB7CiAgaWYgKHBjKGUsIHdpbmRvdy5VUkwpKSByZXR1cm4gITA7CiAgaWYgKCF2YyhlKSkgcmV0dXJuICExOwogIHZhciB0ID0gZTsKICBlLnN0YXJ0c1dpdGgoImh0dHA6Ly8iKSAmJiBlLnN0YXJ0c1dpdGgoImh0dHBzOi8vIikgfHwgKHQgPSAiaHR0cDovLyIuY29uY2F0KGUpKTsKCiAgdHJ5IHsKICAgIHJldHVybiAha2MobmV3IFVSTCh0KS5ob3N0bmFtZSk7CiAgfSBjYXRjaCAoZSkgewogICAgcmV0dXJuICExOwogIH0KfSwKICAgIF9jID0ga2MsCiAgICBEYyA9IChjYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNwYW4iKSwgdWMgPSB7CiAgV2Via2l0VHJhbnNpdGlvbjogIndlYmtpdFRyYW5zaXRpb25FbmQiLAogIE1velRyYW5zaXRpb246ICJ0cmFuc2l0aW9uZW5kIiwKICBPVHJhbnNpdGlvbjogIm9UcmFuc2l0aW9uRW5kIG90cmFuc2l0aW9uZW5kIiwKICB0cmFuc2l0aW9uOiAidHJhbnNpdGlvbmVuZCIKfSwgaGMgPSBPYmplY3Qua2V5cyh1YykuZmluZChmdW5jdGlvbiAoZSkgewogIHJldHVybiB2b2lkIDAgIT09IGNjLnN0eWxlW2VdOwp9KSwgISFBYyhoYykgJiYgdWNbaGNdKTsKCmZ1bmN0aW9uIEZjKGUsIHQpIHsKICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgIHRyeSB7CiAgICAgIGUuaGlkZGVuID0gITAsIGUub2Zmc2V0SGVpZ2h0LCBlLmhpZGRlbiA9ICExOwogICAgfSBjYXRjaCAoZSkge30KICB9LCB0KTsKfQoKdmFyIHFjID0gewogIGlzSUU6CiAgLyogQGNjX29uIUAgKi8KICAhIWRvY3VtZW50LmRvY3VtZW50TW9kZSwKICBpc0VkZ2U6IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluY2x1ZGVzKCJFZGdlIiksCiAgaXNXZWJraXQ6ICJXZWJraXRBcHBlYXJhbmNlIiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUgJiYgIS9FZGdlLy50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpLAogIGlzSVBob25lOiAvKGlQaG9uZXxpUG9kKS9naS50ZXN0KG5hdmlnYXRvci5wbGF0Zm9ybSksCiAgaXNJb3M6IC8oaVBhZHxpUGhvbmV8aVBvZCkvZ2kudGVzdChuYXZpZ2F0b3IucGxhdGZvcm0pCn07CgpmdW5jdGlvbiBVYyhlLCB0KSB7CiAgcmV0dXJuIHQuc3BsaXQoIi4iKS5yZWR1Y2UoZnVuY3Rpb24gKGUsIHQpIHsKICAgIHJldHVybiBlICYmIGVbdF07CiAgfSwgZSk7Cn0KCmZ1bmN0aW9uIEhjKCkgewogIGZvciAodmFyIGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1swXSA/IGFyZ3VtZW50c1swXSA6IHt9LCB0ID0gYXJndW1lbnRzLmxlbmd0aCwgbiA9IG5ldyBBcnJheSh0ID4gMSA/IHQgLSAxIDogMCksIGkgPSAxOyBpIDwgdDsgaSsrKSB7CiAgICBuW2kgLSAxXSA9IGFyZ3VtZW50c1tpXTsKICB9CgogIGlmICghbi5sZW5ndGgpIHJldHVybiBlOwogIHZhciByID0gbi5zaGlmdCgpOwogIHJldHVybiBTYyhyKSA/IChPYmplY3Qua2V5cyhyKS5mb3JFYWNoKGZ1bmN0aW9uICh0KSB7CiAgICBTYyhyW3RdKSA/IChPYmplY3Qua2V5cyhlKS5pbmNsdWRlcyh0KSB8fCBPYmplY3QuYXNzaWduKGUsIFJsKHt9LCB0LCB7fSkpLCBIYyhlW3RdLCByW3RdKSkgOiBPYmplY3QuYXNzaWduKGUsIFJsKHt9LCB0LCByW3RdKSk7CiAgfSksIEhjLmFwcGx5KHZvaWQgMCwgW2VdLmNvbmNhdChuKSkpIDogZTsKfQoKZnVuY3Rpb24gQmMoZSwgdCkgewogIHZhciBuID0gZS5sZW5ndGggPyBlIDogW2VdOwogIEFycmF5LmZyb20obikucmV2ZXJzZSgpLmZvckVhY2goZnVuY3Rpb24gKGUsIG4pIHsKICAgIHZhciBpID0gbiA+IDAgPyB0LmNsb25lTm9kZSghMCkgOiB0LAogICAgICAgIHIgPSBlLnBhcmVudE5vZGUsCiAgICAgICAgYSA9IGUubmV4dFNpYmxpbmc7CiAgICBpLmFwcGVuZENoaWxkKGUpLCBhID8gci5pbnNlcnRCZWZvcmUoaSwgYSkgOiByLmFwcGVuZENoaWxkKGkpOwogIH0pOwp9CgpmdW5jdGlvbiBWYyhlLCB0KSB7CiAgSWMoZSkgJiYgIV9jKHQpICYmIE9iamVjdC5lbnRyaWVzKHQpLmZpbHRlcihmdW5jdGlvbiAoZSkgewogICAgdmFyIHQgPSBxbChlLCAyKVsxXTsKICAgIHJldHVybiAhVGModCk7CiAgfSkuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgdmFyIG4gPSBxbCh0LCAyKSwKICAgICAgICBpID0gblswXSwKICAgICAgICByID0gblsxXTsKICAgIHJldHVybiBlLnNldEF0dHJpYnV0ZShpLCByKTsKICB9KTsKfQoKZnVuY3Rpb24gemMoZSwgdCwgbikgewogIHZhciBpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChlKTsKICByZXR1cm4gU2ModCkgJiYgVmMoaSwgdCksIEFjKG4pICYmIChpLmlubmVyVGV4dCA9IG4pLCBpOwp9CgpmdW5jdGlvbiBXYyhlLCB0LCBuLCBpKSB7CiAgSWModCkgJiYgdC5hcHBlbmRDaGlsZCh6YyhlLCBuLCBpKSk7Cn0KCmZ1bmN0aW9uICRjKGUpIHsKICBPYyhlKSB8fCBQYyhlKSA/IEFycmF5LmZyb20oZSkuZm9yRWFjaCgkYykgOiBJYyhlKSAmJiBJYyhlLnBhcmVudE5vZGUpICYmIGUucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChlKTsKfQoKZnVuY3Rpb24gS2MoZSkgewogIGlmIChJYyhlKSkgZm9yICh2YXIgdCA9IGUuY2hpbGROb2Rlcy5sZW5ndGg7IHQgPiAwOykgewogICAgZS5yZW1vdmVDaGlsZChlLmxhc3RDaGlsZCksIHQgLT0gMTsKICB9Cn0KCmZ1bmN0aW9uIFljKGUsIHQpIHsKICByZXR1cm4gSWModCkgJiYgSWModC5wYXJlbnROb2RlKSAmJiBJYyhlKSA/ICh0LnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKGUsIHQpLCBlKSA6IG51bGw7Cn0KCmZ1bmN0aW9uIEdjKGUsIHQpIHsKICBpZiAoIUFjKGUpIHx8IF9jKGUpKSByZXR1cm4ge307CiAgdmFyIG4gPSB7fSwKICAgICAgaSA9IEhjKHt9LCB0KTsKICByZXR1cm4gZS5zcGxpdCgiLCIpLmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gZS50cmltKCksCiAgICAgICAgciA9IHQucmVwbGFjZSgiLiIsICIiKSwKICAgICAgICBhID0gdC5yZXBsYWNlKC9bW1xdXS9nLCAiIikuc3BsaXQoIj0iKSwKICAgICAgICBvID0gcWwoYSwgMSlbMF0sCiAgICAgICAgcyA9IGEubGVuZ3RoID4gMSA/IGFbMV0ucmVwbGFjZSgvWyInXS9nLCAiIikgOiAiIjsKCiAgICBzd2l0Y2ggKHQuY2hhckF0KDApKSB7CiAgICAgIGNhc2UgIi4iOgogICAgICAgIEFjKGkuY2xhc3MpID8gbi5jbGFzcyA9ICIiLmNvbmNhdChpLmNsYXNzLCAiICIpLmNvbmNhdChyKSA6IG4uY2xhc3MgPSByOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAiIyI6CiAgICAgICAgbi5pZCA9IHQucmVwbGFjZSgiIyIsICIiKTsKICAgICAgICBicmVhazsKCiAgICAgIGNhc2UgIlsiOgogICAgICAgIG5bb10gPSBzOwogICAgfQogIH0pLCBIYyhpLCBuKTsKfQoKZnVuY3Rpb24gWGMoZSwgdCkgewogIGlmIChJYyhlKSkgewogICAgdmFyIG4gPSB0OwogICAgeGMobikgfHwgKG4gPSAhZS5oaWRkZW4pLCBlLmhpZGRlbiA9IG47CiAgfQp9CgpmdW5jdGlvbiBRYyhlLCB0LCBuKSB7CiAgaWYgKE9jKGUpKSByZXR1cm4gQXJyYXkuZnJvbShlKS5tYXAoZnVuY3Rpb24gKGUpIHsKICAgIHJldHVybiBRYyhlLCB0LCBuKTsKICB9KTsKCiAgaWYgKEljKGUpKSB7CiAgICB2YXIgaSA9ICJ0b2dnbGUiOwogICAgcmV0dXJuIHZvaWQgMCAhPT0gbiAmJiAoaSA9IG4gPyAiYWRkIiA6ICJyZW1vdmUiKSwgZS5jbGFzc0xpc3RbaV0odCksIGUuY2xhc3NMaXN0LmNvbnRhaW5zKHQpOwogIH0KCiAgcmV0dXJuICExOwp9CgpmdW5jdGlvbiBKYyhlLCB0KSB7CiAgcmV0dXJuIEljKGUpICYmIGUuY2xhc3NMaXN0LmNvbnRhaW5zKHQpOwp9CgpmdW5jdGlvbiBaYyhlLCB0KSB7CiAgdmFyIG4gPSBFbGVtZW50LnByb3RvdHlwZTsKICByZXR1cm4gKG4ubWF0Y2hlcyB8fCBuLndlYmtpdE1hdGNoZXNTZWxlY3RvciB8fCBuLm1vek1hdGNoZXNTZWxlY3RvciB8fCBuLm1zTWF0Y2hlc1NlbGVjdG9yIHx8IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodCkpLmluY2x1ZGVzKHRoaXMpOwogIH0pLmNhbGwoZSwgdCk7Cn0KCmZ1bmN0aW9uIGV1KGUpIHsKICByZXR1cm4gdGhpcy5lbGVtZW50cy5jb250YWluZXIucXVlcnlTZWxlY3RvckFsbChlKTsKfQoKZnVuY3Rpb24gdHUoZSkgewogIHJldHVybiB0aGlzLmVsZW1lbnRzLmNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKGUpOwp9CgpmdW5jdGlvbiBudSgpIHsKICB2YXIgZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdID8gYXJndW1lbnRzWzBdIDogbnVsbCwKICAgICAgdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzFdICYmIGFyZ3VtZW50c1sxXTsKICBJYyhlKSAmJiAoZS5mb2N1cyh7CiAgICBwcmV2ZW50U2Nyb2xsOiAhMAogIH0pLCB0ICYmIFFjKGUsIHRoaXMuY29uZmlnLmNsYXNzTmFtZXMudGFiRm9jdXMpKTsKfQoKdmFyIGl1ID0gewogICJhdWRpby9vZ2ciOiAidm9yYmlzIiwKICAiYXVkaW8vd2F2IjogIjEiLAogICJ2aWRlby93ZWJtIjogInZwOCwgdm9yYmlzIiwKICAidmlkZW8vbXA0IjogImF2YzEuNDJFMDFFLCBtcDRhLjQwLjIiLAogICJ2aWRlby9vZ2ciOiAidGhlb3JhIgp9LAogICAgcnUgPSB7CiAgYXVkaW86ICJjYW5QbGF5VHlwZSIgaW4gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYXVkaW8iKSwKICB2aWRlbzogImNhblBsYXlUeXBlIiBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ2aWRlbyIpLAogIGNoZWNrOiBmdW5jdGlvbiBjaGVjayhlLCB0LCBuKSB7CiAgICB2YXIgaSA9IHFjLmlzSVBob25lICYmIG4gJiYgcnUucGxheXNpbmxpbmUsCiAgICAgICAgciA9IHJ1W2VdIHx8ICJodG1sNSIgIT09IHQ7CiAgICByZXR1cm4gewogICAgICBhcGk6IHIsCiAgICAgIHVpOiByICYmIHJ1LnJhbmdlSW5wdXQgJiYgKCJ2aWRlbyIgIT09IGUgfHwgIXFjLmlzSVBob25lIHx8IGkpCiAgICB9OwogIH0sCiAgcGlwOiAhKHFjLmlzSVBob25lIHx8ICFDYyh6YygidmlkZW8iKS53ZWJraXRTZXRQcmVzZW50YXRpb25Nb2RlKSAmJiAoIWRvY3VtZW50LnBpY3R1cmVJblBpY3R1cmVFbmFibGVkIHx8IHpjKCJ2aWRlbyIpLmRpc2FibGVQaWN0dXJlSW5QaWN0dXJlKSksCiAgYWlycGxheTogQ2Mod2luZG93LldlYktpdFBsYXliYWNrVGFyZ2V0QXZhaWxhYmlsaXR5RXZlbnQpLAogIHBsYXlzaW5saW5lOiAicGxheXNJbmxpbmUiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInZpZGVvIiksCiAgbWltZTogZnVuY3Rpb24gbWltZShlKSB7CiAgICBpZiAoX2MoZSkpIHJldHVybiAhMTsKICAgIHZhciB0ID0gcWwoZS5zcGxpdCgiLyIpLCAxKVswXSwKICAgICAgICBuID0gZTsKICAgIGlmICghdGhpcy5pc0hUTUw1IHx8IHQgIT09IHRoaXMudHlwZSkgcmV0dXJuICExOwogICAgT2JqZWN0LmtleXMoaXUpLmluY2x1ZGVzKG4pICYmIChuICs9ICc7IGNvZGVjcz0iJy5jb25jYXQoaXVbZV0sICciJykpOwoKICAgIHRyeSB7CiAgICAgIHJldHVybiBCb29sZWFuKG4gJiYgdGhpcy5tZWRpYS5jYW5QbGF5VHlwZShuKS5yZXBsYWNlKC9uby8sICIiKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiAhMTsKICAgIH0KICB9LAogIHRleHRUcmFja3M6ICJ0ZXh0VHJhY2tzIiBpbiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJ2aWRlbyIpLAogIHJhbmdlSW5wdXQ6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKICAgIHJldHVybiBlLnR5cGUgPSAicmFuZ2UiLCAicmFuZ2UiID09PSBlLnR5cGU7CiAgfSgpLAogIHRvdWNoOiAib250b3VjaHN0YXJ0IiBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCiAgdHJhbnNpdGlvbnM6ICExICE9PSBEYywKICByZWR1Y2VkTW90aW9uOiAibWF0Y2hNZWRpYSIgaW4gd2luZG93ICYmIHdpbmRvdy5tYXRjaE1lZGlhKCIocHJlZmVycy1yZWR1Y2VkLW1vdGlvbikiKS5tYXRjaGVzCn0sCiAgICBhdSA9IGZ1bmN0aW9uICgpIHsKICB2YXIgZSA9ICExOwoKICB0cnkgewogICAgdmFyIHQgPSBPYmplY3QuZGVmaW5lUHJvcGVydHkoe30sICJwYXNzaXZlIiwgewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gZSA9ICEwLCBudWxsOwogICAgICB9CiAgICB9KTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0IiwgbnVsbCwgdCksIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJ0ZXN0IiwgbnVsbCwgdCk7CiAgfSBjYXRjaCAoZSkge30KCiAgcmV0dXJuIGU7Cn0oKTsKCmZ1bmN0aW9uIG91KGUsIHQsIG4pIHsKICB2YXIgaSA9IHRoaXMsCiAgICAgIHIgPSBhcmd1bWVudHMubGVuZ3RoID4gMyAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1szXSAmJiBhcmd1bWVudHNbM10sCiAgICAgIGEgPSAhKGFyZ3VtZW50cy5sZW5ndGggPiA0ICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzRdKSB8fCBhcmd1bWVudHNbNF0sCiAgICAgIG8gPSBhcmd1bWVudHMubGVuZ3RoID4gNSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1s1XSAmJiBhcmd1bWVudHNbNV07CgogIGlmIChlICYmICJhZGRFdmVudExpc3RlbmVyIiBpbiBlICYmICFfYyh0KSAmJiBDYyhuKSkgewogICAgdmFyIHMgPSB0LnNwbGl0KCIgIiksCiAgICAgICAgbCA9IG87CiAgICBhdSAmJiAobCA9IHsKICAgICAgcGFzc2l2ZTogYSwKICAgICAgY2FwdHVyZTogbwogICAgfSksIHMuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICBpICYmIGkuZXZlbnRMaXN0ZW5lcnMgJiYgciAmJiBpLmV2ZW50TGlzdGVuZXJzLnB1c2goewogICAgICAgIGVsZW1lbnQ6IGUsCiAgICAgICAgdHlwZTogdCwKICAgICAgICBjYWxsYmFjazogbiwKICAgICAgICBvcHRpb25zOiBsCiAgICAgIH0pLCBlW3IgPyAiYWRkRXZlbnRMaXN0ZW5lciIgOiAicmVtb3ZlRXZlbnRMaXN0ZW5lciJdKHQsIG4sIGwpOwogICAgfSk7CiAgfQp9CgpmdW5jdGlvbiBzdShlKSB7CiAgdmFyIHQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSA/IGFyZ3VtZW50c1sxXSA6ICIiLAogICAgICBuID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBhcmd1bWVudHNbMl0gOiB2b2lkIDAsCiAgICAgIGkgPSAhKGFyZ3VtZW50cy5sZW5ndGggPiAzICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzNdKSB8fCBhcmd1bWVudHNbM10sCiAgICAgIHIgPSBhcmd1bWVudHMubGVuZ3RoID4gNCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1s0XSAmJiBhcmd1bWVudHNbNF07CiAgb3UuY2FsbCh0aGlzLCBlLCB0LCBuLCAhMCwgaSwgcik7Cn0KCmZ1bmN0aW9uIGx1KGUpIHsKICB2YXIgdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzFdID8gYXJndW1lbnRzWzFdIDogIiIsCiAgICAgIG4gPSBhcmd1bWVudHMubGVuZ3RoID4gMiA/IGFyZ3VtZW50c1syXSA6IHZvaWQgMCwKICAgICAgaSA9ICEoYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbM10pIHx8IGFyZ3VtZW50c1szXSwKICAgICAgciA9IGFyZ3VtZW50cy5sZW5ndGggPiA0ICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzRdICYmIGFyZ3VtZW50c1s0XTsKICBvdS5jYWxsKHRoaXMsIGUsIHQsIG4sICExLCBpLCByKTsKfQoKZnVuY3Rpb24gY3UoZSkgewogIHZhciB0ID0gdGhpcywKICAgICAgbiA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzFdID8gYXJndW1lbnRzWzFdIDogIiIsCiAgICAgIGkgPSBhcmd1bWVudHMubGVuZ3RoID4gMiA/IGFyZ3VtZW50c1syXSA6IHZvaWQgMCwKICAgICAgciA9ICEoYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbM10pIHx8IGFyZ3VtZW50c1szXSwKICAgICAgYSA9IGFyZ3VtZW50cy5sZW5ndGggPiA0ICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzRdICYmIGFyZ3VtZW50c1s0XSwKICAgICAgbyA9IGZ1bmN0aW9uIG8oKSB7CiAgICBsdShlLCBuLCBvLCByLCBhKTsKCiAgICBmb3IgKHZhciBzID0gYXJndW1lbnRzLmxlbmd0aCwgbCA9IG5ldyBBcnJheShzKSwgYyA9IDA7IGMgPCBzOyBjKyspIHsKICAgICAgbFtjXSA9IGFyZ3VtZW50c1tjXTsKICAgIH0KCiAgICBpLmFwcGx5KHQsIGwpOwogIH07CgogIG91LmNhbGwodGhpcywgZSwgbiwgbywgITAsIHIsIGEpOwp9CgpmdW5jdGlvbiB1dShlKSB7CiAgdmFyIHQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSA/IGFyZ3VtZW50c1sxXSA6ICIiLAogICAgICBuID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbMl0gJiYgYXJndW1lbnRzWzJdLAogICAgICBpID0gYXJndW1lbnRzLmxlbmd0aCA+IDMgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbM10gPyBhcmd1bWVudHNbM10gOiB7fTsKCiAgaWYgKEljKGUpICYmICFfYyh0KSkgewogICAgdmFyIHIgPSBuZXcgQ3VzdG9tRXZlbnQodCwgewogICAgICBidWJibGVzOiBuLAogICAgICBkZXRhaWw6IERsKERsKHt9LCBpKSwge30sIHsKICAgICAgICBwbHlyOiB0aGlzCiAgICAgIH0pCiAgICB9KTsKICAgIGUuZGlzcGF0Y2hFdmVudChyKTsKICB9Cn0KCmZ1bmN0aW9uIGh1KCkgewogIHRoaXMgJiYgdGhpcy5ldmVudExpc3RlbmVycyAmJiAodGhpcy5ldmVudExpc3RlbmVycy5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdCA9IGUuZWxlbWVudCwKICAgICAgICBuID0gZS50eXBlLAogICAgICAgIGkgPSBlLmNhbGxiYWNrLAogICAgICAgIHIgPSBlLm9wdGlvbnM7CiAgICB0LnJlbW92ZUV2ZW50TGlzdGVuZXIobiwgaSwgcik7CiAgfSksIHRoaXMuZXZlbnRMaXN0ZW5lcnMgPSBbXSk7Cn0KCmZ1bmN0aW9uIGR1KCkgewogIHZhciBlID0gdGhpczsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHQpIHsKICAgIHJldHVybiBlLnJlYWR5ID8gc2V0VGltZW91dCh0LCAwKSA6IHN1LmNhbGwoZSwgZS5lbGVtZW50cy5jb250YWluZXIsICJyZWFkeSIsIHQpOwogIH0pLnRoZW4oZnVuY3Rpb24gKCkge30pOwp9CgpmdW5jdGlvbiBmdShlKSB7CiAgamMoZSkgJiYgZS50aGVuKG51bGwsIGZ1bmN0aW9uICgpIHt9KTsKfQoKZnVuY3Rpb24gcHUoZSkgewogIHJldHVybiAhIShQYyhlKSB8fCBBYyhlKSAmJiBlLmluY2x1ZGVzKCI6IikpICYmIChQYyhlKSA/IGUgOiBlLnNwbGl0KCI6IikpLm1hcChOdW1iZXIpLmV2ZXJ5KEVjKTsKfQoKZnVuY3Rpb24gbXUoZSkgewogIGlmICghUGMoZSkgfHwgIWUuZXZlcnkoRWMpKSByZXR1cm4gbnVsbDsKCiAgdmFyIHQgPSBxbChlLCAyKSwKICAgICAgbiA9IHRbMF0sCiAgICAgIGkgPSB0WzFdLAogICAgICByID0gZnVuY3Rpb24gZSh0LCBuKSB7CiAgICByZXR1cm4gMCA9PT0gbiA/IHQgOiBlKG4sIHQgJSBuKTsKICB9KG4sIGkpOwoKICByZXR1cm4gW24gLyByLCBpIC8gcl07Cn0KCmZ1bmN0aW9uIGd1KGUpIHsKICB2YXIgdCA9IGZ1bmN0aW9uIHQoZSkgewogICAgcmV0dXJuIHB1KGUpID8gZS5zcGxpdCgiOiIpLm1hcChOdW1iZXIpIDogbnVsbDsKICB9LAogICAgICBuID0gdChlKTsKCiAgaWYgKG51bGwgPT09IG4gJiYgKG4gPSB0KHRoaXMuY29uZmlnLnJhdGlvKSksIG51bGwgPT09IG4gJiYgIV9jKHRoaXMuZW1iZWQpICYmIFBjKHRoaXMuZW1iZWQucmF0aW8pICYmIChuID0gdGhpcy5lbWJlZC5yYXRpbyksIG51bGwgPT09IG4gJiYgdGhpcy5pc0hUTUw1KSB7CiAgICB2YXIgaSA9IHRoaXMubWVkaWE7CiAgICBuID0gbXUoW2kudmlkZW9XaWR0aCwgaS52aWRlb0hlaWdodF0pOwogIH0KCiAgcmV0dXJuIG47Cn0KCmZ1bmN0aW9uIHZ1KGUpIHsKICBpZiAoIXRoaXMuaXNWaWRlbykgcmV0dXJuIHt9OwogIHZhciB0ID0gdGhpcy5lbGVtZW50cy53cmFwcGVyLAogICAgICBuID0gZ3UuY2FsbCh0aGlzLCBlKSwKICAgICAgaSA9IHFsKFBjKG4pID8gbiA6IFswLCAwXSwgMiksCiAgICAgIHIgPSAxMDAgLyBpWzBdICogaVsxXTsKCiAgaWYgKHQuc3R5bGUucGFkZGluZ0JvdHRvbSA9ICIiLmNvbmNhdChyLCAiJSIpLCB0aGlzLmlzVmltZW8gJiYgIXRoaXMuY29uZmlnLnZpbWVvLnByZW1pdW0gJiYgdGhpcy5zdXBwb3J0ZWQudWkpIHsKICAgIHZhciBhID0gMTAwIC8gdGhpcy5tZWRpYS5vZmZzZXRXaWR0aCAqIHBhcnNlSW50KHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHRoaXMubWVkaWEpLnBhZGRpbmdCb3R0b20sIDEwKSwKICAgICAgICBvID0gKGEgLSByKSAvIChhIC8gNTApOwogICAgdGhpcy5mdWxsc2NyZWVuLmFjdGl2ZSA/IHQuc3R5bGUucGFkZGluZ0JvdHRvbSA9IG51bGwgOiB0aGlzLm1lZGlhLnN0eWxlLnRyYW5zZm9ybSA9ICJ0cmFuc2xhdGVZKC0iLmNvbmNhdChvLCAiJSkiKTsKICB9IGVsc2UgdGhpcy5pc0hUTUw1ICYmIHQuY2xhc3NMaXN0LnRvZ2dsZSh0aGlzLmNvbmZpZy5jbGFzc05hbWVzLnZpZGVvRml4ZWRSYXRpbywgbnVsbCAhPT0gbik7CgogIHJldHVybiB7CiAgICBwYWRkaW5nOiByLAogICAgcmF0aW86IG4KICB9Owp9Cgp2YXIgeXUgPSB7CiAgZ2V0U291cmNlczogZnVuY3Rpb24gZ2V0U291cmNlcygpIHsKICAgIHZhciBlID0gdGhpczsKICAgIHJldHVybiB0aGlzLmlzSFRNTDUgPyBBcnJheS5mcm9tKHRoaXMubWVkaWEucXVlcnlTZWxlY3RvckFsbCgic291cmNlIikpLmZpbHRlcihmdW5jdGlvbiAodCkgewogICAgICB2YXIgbiA9IHQuZ2V0QXR0cmlidXRlKCJ0eXBlIik7CiAgICAgIHJldHVybiAhIV9jKG4pIHx8IHJ1Lm1pbWUuY2FsbChlLCBuKTsKICAgIH0pIDogW107CiAgfSwKICBnZXRRdWFsaXR5T3B0aW9uczogZnVuY3Rpb24gZ2V0UXVhbGl0eU9wdGlvbnMoKSB7CiAgICByZXR1cm4gdGhpcy5jb25maWcucXVhbGl0eS5mb3JjZWQgPyB0aGlzLmNvbmZpZy5xdWFsaXR5Lm9wdGlvbnMgOiB5dS5nZXRTb3VyY2VzLmNhbGwodGhpcykubWFwKGZ1bmN0aW9uIChlKSB7CiAgICAgIHJldHVybiBOdW1iZXIoZS5nZXRBdHRyaWJ1dGUoInNpemUiKSk7CiAgICB9KS5maWx0ZXIoQm9vbGVhbik7CiAgfSwKICBzZXR1cDogZnVuY3Rpb24gc2V0dXAoKSB7CiAgICBpZiAodGhpcy5pc0hUTUw1KSB7CiAgICAgIHZhciBlID0gdGhpczsKICAgICAgZS5vcHRpb25zLnNwZWVkID0gZS5jb25maWcuc3BlZWQub3B0aW9ucywgX2ModGhpcy5jb25maWcucmF0aW8pIHx8IHZ1LmNhbGwoZSksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLm1lZGlhLCAicXVhbGl0eSIsIHsKICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHZhciB0ID0geXUuZ2V0U291cmNlcy5jYWxsKGUpLmZpbmQoZnVuY3Rpb24gKHQpIHsKICAgICAgICAgICAgcmV0dXJuIHQuZ2V0QXR0cmlidXRlKCJzcmMiKSA9PT0gZS5zb3VyY2U7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiB0ICYmIE51bWJlcih0LmdldEF0dHJpYnV0ZSgic2l6ZSIpKTsKICAgICAgICB9LAogICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHQpIHsKICAgICAgICAgIGlmIChlLnF1YWxpdHkgIT09IHQpIHsKICAgICAgICAgICAgaWYgKGUuY29uZmlnLnF1YWxpdHkuZm9yY2VkICYmIENjKGUuY29uZmlnLnF1YWxpdHkub25DaGFuZ2UpKSBlLmNvbmZpZy5xdWFsaXR5Lm9uQ2hhbmdlKHQpO2Vsc2UgewogICAgICAgICAgICAgIHZhciBuID0geXUuZ2V0U291cmNlcy5jYWxsKGUpLmZpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBOdW1iZXIoZS5nZXRBdHRyaWJ1dGUoInNpemUiKSkgPT09IHQ7CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgaWYgKCFuKSByZXR1cm47CiAgICAgICAgICAgICAgdmFyIGkgPSBlLm1lZGlhLAogICAgICAgICAgICAgICAgICByID0gaS5jdXJyZW50VGltZSwKICAgICAgICAgICAgICAgICAgYSA9IGkucGF1c2VkLAogICAgICAgICAgICAgICAgICBvID0gaS5wcmVsb2FkLAogICAgICAgICAgICAgICAgICBzID0gaS5yZWFkeVN0YXRlLAogICAgICAgICAgICAgICAgICBsID0gaS5wbGF5YmFja1JhdGU7CiAgICAgICAgICAgICAgZS5tZWRpYS5zcmMgPSBuLmdldEF0dHJpYnV0ZSgic3JjIiksICgibm9uZSIgIT09IG8gfHwgcykgJiYgKGUub25jZSgibG9hZGVkbWV0YWRhdGEiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBlLnNwZWVkID0gbCwgZS5jdXJyZW50VGltZSA9IHIsIGEgfHwgZnUoZS5wbGF5KCkpOwogICAgICAgICAgICAgIH0pLCBlLm1lZGlhLmxvYWQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdXUuY2FsbChlLCBlLm1lZGlhLCAicXVhbGl0eWNoYW5nZSIsICExLCB7CiAgICAgICAgICAgICAgcXVhbGl0eTogdAogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sCiAgY2FuY2VsUmVxdWVzdHM6IGZ1bmN0aW9uIGNhbmNlbFJlcXVlc3RzKCkgewogICAgdGhpcy5pc0hUTUw1ICYmICgkYyh5dS5nZXRTb3VyY2VzLmNhbGwodGhpcykpLCB0aGlzLm1lZGlhLnNldEF0dHJpYnV0ZSgic3JjIiwgdGhpcy5jb25maWcuYmxhbmtWaWRlbyksIHRoaXMubWVkaWEubG9hZCgpLCB0aGlzLmRlYnVnLmxvZygiQ2FuY2VsbGVkIG5ldHdvcmsgcmVxdWVzdHMiKSk7CiAgfQp9OwoKZnVuY3Rpb24gYnUoZSkgewogIHJldHVybiBQYyhlKSA/IGUuZmlsdGVyKGZ1bmN0aW9uICh0LCBuKSB7CiAgICByZXR1cm4gZS5pbmRleE9mKHQpID09PSBuOwogIH0pIDogZTsKfQoKZnVuY3Rpb24gd3UoZSkgewogIGZvciAodmFyIHQgPSBhcmd1bWVudHMubGVuZ3RoLCBuID0gbmV3IEFycmF5KHQgPiAxID8gdCAtIDEgOiAwKSwgaSA9IDE7IGkgPCB0OyBpKyspIHsKICAgIG5baSAtIDFdID0gYXJndW1lbnRzW2ldOwogIH0KCiAgcmV0dXJuIF9jKGUpID8gZSA6IGUudG9TdHJpbmcoKS5yZXBsYWNlKC97KFxkKyl9L2csIGZ1bmN0aW9uIChlLCB0KSB7CiAgICByZXR1cm4gblt0XS50b1N0cmluZygpOwogIH0pOwp9Cgp2YXIga3UgPSBmdW5jdGlvbiBrdSgpIHsKICB2YXIgZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdID8gYXJndW1lbnRzWzBdIDogIiIsCiAgICAgIHQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSA/IGFyZ3VtZW50c1sxXSA6ICIiLAogICAgICBuID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbMl0gPyBhcmd1bWVudHNbMl0gOiAiIjsKICByZXR1cm4gZS5yZXBsYWNlKG5ldyBSZWdFeHAodC50b1N0cmluZygpLnJlcGxhY2UoLyhbLiorP149IToke30oKXxbXF0vXFxdKS9nLCAiXFwkMSIpLCAiZyIpLCBuLnRvU3RyaW5nKCkpOwp9LAogICAgVHUgPSBmdW5jdGlvbiBUdSgpIHsKICB2YXIgZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdID8gYXJndW1lbnRzWzBdIDogIiI7CiAgcmV0dXJuIGUudG9TdHJpbmcoKS5yZXBsYWNlKC9cd1xTKi9nLCBmdW5jdGlvbiAoZSkgewogICAgcmV0dXJuIGUuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBlLnN1YnN0cigxKS50b0xvd2VyQ2FzZSgpOwogIH0pOwp9OwoKZnVuY3Rpb24gU3UoKSB7CiAgdmFyIGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1swXSA/IGFyZ3VtZW50c1swXSA6ICIiLAogICAgICB0ID0gZS50b1N0cmluZygpOwogIHJldHVybiB0ID0ga3UodCwgIi0iLCAiICIpLCB0ID0ga3UodCwgIl8iLCAiICIpLCB0ID0gVHUodCksIGt1KHQsICIgIiwgIiIpOwp9CgpmdW5jdGlvbiBFdShlKSB7CiAgdmFyIHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICByZXR1cm4gdC5hcHBlbmRDaGlsZChlKSwgdC5pbm5lckhUTUw7Cn0KCnZhciBBdSA9IHsKICBwaXA6ICJQSVAiLAogIGFpcnBsYXk6ICJBaXJQbGF5IiwKICBodG1sNTogIkhUTUw1IiwKICB2aW1lbzogIlZpbWVvIiwKICB5b3V0dWJlOiAiWW91VHViZSIKfSwKICAgIHh1ID0gZnVuY3Rpb24geHUoKSB7CiAgdmFyIGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1swXSA/IGFyZ3VtZW50c1swXSA6ICIiLAogICAgICB0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbMV0gPyBhcmd1bWVudHNbMV0gOiB7fTsKICBpZiAoX2MoZSkgfHwgX2ModCkpIHJldHVybiAiIjsKICB2YXIgbiA9IFVjKHQuaTE4biwgZSk7CiAgaWYgKF9jKG4pKSByZXR1cm4gT2JqZWN0LmtleXMoQXUpLmluY2x1ZGVzKGUpID8gQXVbZV0gOiAiIjsKICB2YXIgaSA9IHsKICAgICJ7c2Vla3RpbWV9IjogdC5zZWVrVGltZSwKICAgICJ7dGl0bGV9IjogdC50aXRsZQogIH07CiAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKGkpLmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0ID0gcWwoZSwgMiksCiAgICAgICAgaSA9IHRbMF0sCiAgICAgICAgciA9IHRbMV07CiAgICBuID0ga3UobiwgaSwgcik7CiAgfSksIG47Cn0sCiAgICBDdSA9IGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBlKHQpIHsKICAgIE5sKHRoaXMsIGUpLCB0aGlzLmVuYWJsZWQgPSB0LmNvbmZpZy5zdG9yYWdlLmVuYWJsZWQsIHRoaXMua2V5ID0gdC5jb25maWcuc3RvcmFnZS5rZXk7CiAgfQoKICByZXR1cm4gamwoZSwgW3sKICAgIGtleTogImdldCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUodCkgewogICAgICBpZiAoIWUuc3VwcG9ydGVkIHx8ICF0aGlzLmVuYWJsZWQpIHJldHVybiBudWxsOwogICAgICB2YXIgbiA9IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSh0aGlzLmtleSk7CiAgICAgIGlmIChfYyhuKSkgcmV0dXJuIG51bGw7CiAgICAgIHZhciBpID0gSlNPTi5wYXJzZShuKTsKICAgICAgcmV0dXJuIEFjKHQpICYmIHQubGVuZ3RoID8gaVt0XSA6IGk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSh0KSB7CiAgICAgIGlmIChlLnN1cHBvcnRlZCAmJiB0aGlzLmVuYWJsZWQgJiYgU2ModCkpIHsKICAgICAgICB2YXIgbiA9IHRoaXMuZ2V0KCk7CiAgICAgICAgX2MobikgJiYgKG4gPSB7fSksIEhjKG4sIHQpLCB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5rZXksIEpTT04uc3RyaW5naWZ5KG4pKTsKICAgICAgfQogICAgfQogIH1dLCBbewogICAga2V5OiAic3VwcG9ydGVkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB0cnkgewogICAgICAgIGlmICghKCJsb2NhbFN0b3JhZ2UiIGluIHdpbmRvdykpIHJldHVybiAhMTsKICAgICAgICB2YXIgZSA9ICJfX190ZXN0IjsKICAgICAgICByZXR1cm4gd2luZG93LmxvY2FsU3RvcmFnZS5zZXRJdGVtKGUsIGUpLCB3aW5kb3cubG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oZSksICEwOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmV0dXJuICExOwogICAgICB9CiAgICB9CiAgfV0pLCBlOwp9KCk7CgpmdW5jdGlvbiBQdShlKSB7CiAgdmFyIHQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSA/IGFyZ3VtZW50c1sxXSA6ICJ0ZXh0IjsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKG4sIGkpIHsKICAgIHRyeSB7CiAgICAgIHZhciByID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgIGlmICghKCJ3aXRoQ3JlZGVudGlhbHMiIGluIHIpKSByZXR1cm47CiAgICAgIHIuYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAoInRleHQiID09PSB0KSB0cnkgewogICAgICAgICAgbihKU09OLnBhcnNlKHIucmVzcG9uc2VUZXh0KSk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgbihyLnJlc3BvbnNlVGV4dCk7CiAgICAgICAgfSBlbHNlIG4oci5yZXNwb25zZSk7CiAgICAgIH0pLCByLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgZnVuY3Rpb24gKCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihyLnN0YXR1cyk7CiAgICAgIH0pLCByLm9wZW4oIkdFVCIsIGUsICEwKSwgci5yZXNwb25zZVR5cGUgPSB0LCByLnNlbmQoKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgaShlKTsKICAgIH0KICB9KTsKfQoKZnVuY3Rpb24gT3UoZSwgdCkgewogIGlmIChBYyhlKSkgewogICAgdmFyIG4gPSAiY2FjaGUiLAogICAgICAgIGkgPSBBYyh0KSwKICAgICAgICByID0gZnVuY3Rpb24gcigpIHsKICAgICAgcmV0dXJuIG51bGwgIT09IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHQpOwogICAgfSwKICAgICAgICBhID0gZnVuY3Rpb24gYShlLCB0KSB7CiAgICAgIGUuaW5uZXJIVE1MID0gdCwgaSAmJiByKCkgfHwgZG9jdW1lbnQuYm9keS5pbnNlcnRBZGphY2VudEVsZW1lbnQoImFmdGVyYmVnaW4iLCBlKTsKICAgIH07CgogICAgaWYgKCFpIHx8ICFyKCkpIHsKICAgICAgdmFyIG8gPSBDdS5zdXBwb3J0ZWQsCiAgICAgICAgICBzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CgogICAgICBpZiAocy5zZXRBdHRyaWJ1dGUoImhpZGRlbiIsICIiKSwgaSAmJiBzLnNldEF0dHJpYnV0ZSgiaWQiLCB0KSwgbykgewogICAgICAgIHZhciBsID0gd2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKCIiLmNvbmNhdChuLCAiLSIpLmNvbmNhdCh0KSk7CgogICAgICAgIGlmIChudWxsICE9PSBsKSB7CiAgICAgICAgICB2YXIgYyA9IEpTT04ucGFyc2UobCk7CiAgICAgICAgICBhKHMsIGMuY29udGVudCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBQdShlKS50aGVuKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgX2MoZSkgfHwgKG8gJiYgd2luZG93LmxvY2FsU3RvcmFnZS5zZXRJdGVtKCIiLmNvbmNhdChuLCAiLSIpLmNvbmNhdCh0KSwgSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgY29udGVudDogZQogICAgICAgIH0pKSwgYShzLCBlKSk7CiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uICgpIHt9KTsKICAgIH0KICB9Cn0KCnZhciBJdSA9IGZ1bmN0aW9uIEl1KGUpIHsKICByZXR1cm4gTWF0aC50cnVuYyhlIC8gNjAgLyA2MCAlIDYwLCAxMCk7Cn0sCiAgICBMdSA9IGZ1bmN0aW9uIEx1KGUpIHsKICByZXR1cm4gTWF0aC50cnVuYyhlIC8gNjAgJSA2MCwgMTApOwp9LAogICAgTnUgPSBmdW5jdGlvbiBOdShlKSB7CiAgcmV0dXJuIE1hdGgudHJ1bmMoZSAlIDYwLCAxMCk7Cn07CgpmdW5jdGlvbiBNdSgpIHsKICB2YXIgZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdID8gYXJndW1lbnRzWzBdIDogMCwKICAgICAgdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzFdICYmIGFyZ3VtZW50c1sxXSwKICAgICAgbiA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzJdICYmIGFyZ3VtZW50c1syXTsKICBpZiAoIUVjKGUpKSByZXR1cm4gTXUodm9pZCAwLCB0LCBuKTsKCiAgdmFyIGkgPSBmdW5jdGlvbiBpKGUpIHsKICAgIHJldHVybiAiMCIuY29uY2F0KGUpLnNsaWNlKC0yKTsKICB9LAogICAgICByID0gSXUoZSksCiAgICAgIGEgPSBMdShlKSwKICAgICAgbyA9IE51KGUpOwoKICByZXR1cm4gciA9IHQgfHwgciA+IDAgPyAiIi5jb25jYXQociwgIjoiKSA6ICIiLCAiIi5jb25jYXQobiAmJiBlID4gMCA/ICItIiA6ICIiKS5jb25jYXQocikuY29uY2F0KGkoYSksICI6IikuY29uY2F0KGkobykpOwp9Cgp2YXIganUgPSB7CiAgZ2V0SWNvblVybDogZnVuY3Rpb24gZ2V0SWNvblVybCgpIHsKICAgIHZhciBlID0gbmV3IFVSTCh0aGlzLmNvbmZpZy5pY29uVXJsLCB3aW5kb3cubG9jYXRpb24pLmhvc3QgIT09IHdpbmRvdy5sb2NhdGlvbi5ob3N0IHx8IHFjLmlzSUUgJiYgIXdpbmRvdy5zdmc0ZXZlcnlib2R5OwogICAgcmV0dXJuIHsKICAgICAgdXJsOiB0aGlzLmNvbmZpZy5pY29uVXJsLAogICAgICBjb3JzOiBlCiAgICB9OwogIH0sCiAgZmluZEVsZW1lbnRzOiBmdW5jdGlvbiBmaW5kRWxlbWVudHMoKSB7CiAgICB0cnkgewogICAgICByZXR1cm4gdGhpcy5lbGVtZW50cy5jb250cm9scyA9IHR1LmNhbGwodGhpcywgdGhpcy5jb25maWcuc2VsZWN0b3JzLmNvbnRyb2xzLndyYXBwZXIpLCB0aGlzLmVsZW1lbnRzLmJ1dHRvbnMgPSB7CiAgICAgICAgcGxheTogZXUuY2FsbCh0aGlzLCB0aGlzLmNvbmZpZy5zZWxlY3RvcnMuYnV0dG9ucy5wbGF5KSwKICAgICAgICBwYXVzZTogdHUuY2FsbCh0aGlzLCB0aGlzLmNvbmZpZy5zZWxlY3RvcnMuYnV0dG9ucy5wYXVzZSksCiAgICAgICAgcmVzdGFydDogdHUuY2FsbCh0aGlzLCB0aGlzLmNvbmZpZy5zZWxlY3RvcnMuYnV0dG9ucy5yZXN0YXJ0KSwKICAgICAgICByZXdpbmQ6IHR1LmNhbGwodGhpcywgdGhpcy5jb25maWcuc2VsZWN0b3JzLmJ1dHRvbnMucmV3aW5kKSwKICAgICAgICBmYXN0Rm9yd2FyZDogdHUuY2FsbCh0aGlzLCB0aGlzLmNvbmZpZy5zZWxlY3RvcnMuYnV0dG9ucy5mYXN0Rm9yd2FyZCksCiAgICAgICAgbXV0ZTogdHUuY2FsbCh0aGlzLCB0aGlzLmNvbmZpZy5zZWxlY3RvcnMuYnV0dG9ucy5tdXRlKSwKICAgICAgICBwaXA6IHR1LmNhbGwodGhpcywgdGhpcy5jb25maWcuc2VsZWN0b3JzLmJ1dHRvbnMucGlwKSwKICAgICAgICBhaXJwbGF5OiB0dS5jYWxsKHRoaXMsIHRoaXMuY29uZmlnLnNlbGVjdG9ycy5idXR0b25zLmFpcnBsYXkpLAogICAgICAgIHNldHRpbmdzOiB0dS5jYWxsKHRoaXMsIHRoaXMuY29uZmlnLnNlbGVjdG9ycy5idXR0b25zLnNldHRpbmdzKSwKICAgICAgICBjYXB0aW9uczogdHUuY2FsbCh0aGlzLCB0aGlzLmNvbmZpZy5zZWxlY3RvcnMuYnV0dG9ucy5jYXB0aW9ucyksCiAgICAgICAgZnVsbHNjcmVlbjogdHUuY2FsbCh0aGlzLCB0aGlzLmNvbmZpZy5zZWxlY3RvcnMuYnV0dG9ucy5mdWxsc2NyZWVuKQogICAgICB9LCB0aGlzLmVsZW1lbnRzLnByb2dyZXNzID0gdHUuY2FsbCh0aGlzLCB0aGlzLmNvbmZpZy5zZWxlY3RvcnMucHJvZ3Jlc3MpLCB0aGlzLmVsZW1lbnRzLmlucHV0cyA9IHsKICAgICAgICBzZWVrOiB0dS5jYWxsKHRoaXMsIHRoaXMuY29uZmlnLnNlbGVjdG9ycy5pbnB1dHMuc2VlayksCiAgICAgICAgdm9sdW1lOiB0dS5jYWxsKHRoaXMsIHRoaXMuY29uZmlnLnNlbGVjdG9ycy5pbnB1dHMudm9sdW1lKQogICAgICB9LCB0aGlzLmVsZW1lbnRzLmRpc3BsYXkgPSB7CiAgICAgICAgYnVmZmVyOiB0dS5jYWxsKHRoaXMsIHRoaXMuY29uZmlnLnNlbGVjdG9ycy5kaXNwbGF5LmJ1ZmZlciksCiAgICAgICAgY3VycmVudFRpbWU6IHR1LmNhbGwodGhpcywgdGhpcy5jb25maWcuc2VsZWN0b3JzLmRpc3BsYXkuY3VycmVudFRpbWUpLAogICAgICAgIGR1cmF0aW9uOiB0dS5jYWxsKHRoaXMsIHRoaXMuY29uZmlnLnNlbGVjdG9ycy5kaXNwbGF5LmR1cmF0aW9uKQogICAgICB9LCBJYyh0aGlzLmVsZW1lbnRzLnByb2dyZXNzKSAmJiAodGhpcy5lbGVtZW50cy5kaXNwbGF5LnNlZWtUb29sdGlwID0gdGhpcy5lbGVtZW50cy5wcm9ncmVzcy5xdWVyeVNlbGVjdG9yKCIuIi5jb25jYXQodGhpcy5jb25maWcuY2xhc3NOYW1lcy50b29sdGlwKSkpLCAhMDsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgcmV0dXJuIHRoaXMuZGVidWcud2FybigiSXQgbG9va3MgbGlrZSB0aGVyZSBpcyBhIHByb2JsZW0gd2l0aCB5b3VyIGN1c3RvbSBjb250cm9scyBIVE1MIiwgZSksIHRoaXMudG9nZ2xlTmF0aXZlQ29udHJvbHMoITApLCAhMTsKICAgIH0KICB9LAogIGNyZWF0ZUljb246IGZ1bmN0aW9uIGNyZWF0ZUljb24oZSwgdCkgewogICAgdmFyIG4gPSAiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciLAogICAgICAgIGkgPSBqdS5nZXRJY29uVXJsLmNhbGwodGhpcyksCiAgICAgICAgciA9ICIiLmNvbmNhdChpLmNvcnMgPyAiIiA6IGkudXJsLCAiIyIpLmNvbmNhdCh0aGlzLmNvbmZpZy5pY29uUHJlZml4KSwKICAgICAgICBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG4sICJzdmciKTsKICAgIFZjKGEsIEhjKHQsIHsKICAgICAgImFyaWEtaGlkZGVuIjogInRydWUiLAogICAgICBmb2N1c2FibGU6ICJmYWxzZSIKICAgIH0pKTsKICAgIHZhciBvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKG4sICJ1c2UiKSwKICAgICAgICBzID0gIiIuY29uY2F0KHIsICItIikuY29uY2F0KGUpOwogICAgcmV0dXJuICJocmVmIiBpbiBvICYmIG8uc2V0QXR0cmlidXRlTlMoImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiLCAiaHJlZiIsIHMpLCBvLnNldEF0dHJpYnV0ZU5TKCJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiwgInhsaW5rOmhyZWYiLCBzKSwgYS5hcHBlbmRDaGlsZChvKSwgYTsKICB9LAogIGNyZWF0ZUxhYmVsOiBmdW5jdGlvbiBjcmVhdGVMYWJlbChlKSB7CiAgICB2YXIgdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzFdID8gYXJndW1lbnRzWzFdIDoge30sCiAgICAgICAgbiA9IHh1KGUsIHRoaXMuY29uZmlnKSwKICAgICAgICBpID0gRGwoRGwoe30sIHQpLCB7fSwgewogICAgICBjbGFzczogW3QuY2xhc3MsIHRoaXMuY29uZmlnLmNsYXNzTmFtZXMuaGlkZGVuXS5maWx0ZXIoQm9vbGVhbikuam9pbigiICIpCiAgICB9KTsKICAgIHJldHVybiB6Yygic3BhbiIsIGksIG4pOwogIH0sCiAgY3JlYXRlQmFkZ2U6IGZ1bmN0aW9uIGNyZWF0ZUJhZGdlKGUpIHsKICAgIGlmIChfYyhlKSkgcmV0dXJuIG51bGw7CiAgICB2YXIgdCA9IHpjKCJzcGFuIiwgewogICAgICBjbGFzczogdGhpcy5jb25maWcuY2xhc3NOYW1lcy5tZW51LnZhbHVlCiAgICB9KTsKICAgIHJldHVybiB0LmFwcGVuZENoaWxkKHpjKCJzcGFuIiwgewogICAgICBjbGFzczogdGhpcy5jb25maWcuY2xhc3NOYW1lcy5tZW51LmJhZGdlCiAgICB9LCBlKSksIHQ7CiAgfSwKICBjcmVhdGVCdXR0b246IGZ1bmN0aW9uIGNyZWF0ZUJ1dHRvbihlLCB0KSB7CiAgICB2YXIgbiA9IHRoaXMsCiAgICAgICAgaSA9IEhjKHt9LCB0KSwKICAgICAgICByID0gZnVuY3Rpb24gKCkgewogICAgICB2YXIgZSA9IChhcmd1bWVudHMubGVuZ3RoID4gMCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1swXSA/IGFyZ3VtZW50c1swXSA6ICIiKS50b1N0cmluZygpOwogICAgICByZXR1cm4gKGUgPSBTdShlKSkuY2hhckF0KDApLnRvTG93ZXJDYXNlKCkgKyBlLnNsaWNlKDEpOwogICAgfShlKSwKICAgICAgICBhID0gewogICAgICBlbGVtZW50OiAiYnV0dG9uIiwKICAgICAgdG9nZ2xlOiAhMSwKICAgICAgbGFiZWw6IG51bGwsCiAgICAgIGljb246IG51bGwsCiAgICAgIGxhYmVsUHJlc3NlZDogbnVsbCwKICAgICAgaWNvblByZXNzZWQ6IG51bGwKICAgIH07CgogICAgc3dpdGNoIChbImVsZW1lbnQiLCAiaWNvbiIsICJsYWJlbCJdLmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgT2JqZWN0LmtleXMoaSkuaW5jbHVkZXMoZSkgJiYgKGFbZV0gPSBpW2VdLCBkZWxldGUgaVtlXSk7CiAgICB9KSwgImJ1dHRvbiIgIT09IGEuZWxlbWVudCB8fCBPYmplY3Qua2V5cyhpKS5pbmNsdWRlcygidHlwZSIpIHx8IChpLnR5cGUgPSAiYnV0dG9uIiksIE9iamVjdC5rZXlzKGkpLmluY2x1ZGVzKCJjbGFzcyIpID8gaS5jbGFzcy5zcGxpdCgiICIpLnNvbWUoZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIGUgPT09IG4uY29uZmlnLmNsYXNzTmFtZXMuY29udHJvbDsKICAgIH0pIHx8IEhjKGksIHsKICAgICAgY2xhc3M6ICIiLmNvbmNhdChpLmNsYXNzLCAiICIpLmNvbmNhdCh0aGlzLmNvbmZpZy5jbGFzc05hbWVzLmNvbnRyb2wpCiAgICB9KSA6IGkuY2xhc3MgPSB0aGlzLmNvbmZpZy5jbGFzc05hbWVzLmNvbnRyb2wsIGUpIHsKICAgICAgY2FzZSAicGxheSI6CiAgICAgICAgYS50b2dnbGUgPSAhMCwgYS5sYWJlbCA9ICJwbGF5IiwgYS5sYWJlbFByZXNzZWQgPSAicGF1c2UiLCBhLmljb24gPSAicGxheSIsIGEuaWNvblByZXNzZWQgPSAicGF1c2UiOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAibXV0ZSI6CiAgICAgICAgYS50b2dnbGUgPSAhMCwgYS5sYWJlbCA9ICJtdXRlIiwgYS5sYWJlbFByZXNzZWQgPSAidW5tdXRlIiwgYS5pY29uID0gInZvbHVtZSIsIGEuaWNvblByZXNzZWQgPSAibXV0ZWQiOwogICAgICAgIGJyZWFrOwoKICAgICAgY2FzZSAiY2FwdGlvbnMiOgogICAgICAgIGEudG9nZ2xlID0gITAsIGEubGFiZWwgPSAiZW5hYmxlQ2FwdGlvbnMiLCBhLmxhYmVsUHJlc3NlZCA9ICJkaXNhYmxlQ2FwdGlvbnMiLCBhLmljb24gPSAiY2FwdGlvbnMtb2ZmIiwgYS5pY29uUHJlc3NlZCA9ICJjYXB0aW9ucy1vbiI7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJmdWxsc2NyZWVuIjoKICAgICAgICBhLnRvZ2dsZSA9ICEwLCBhLmxhYmVsID0gImVudGVyRnVsbHNjcmVlbiIsIGEubGFiZWxQcmVzc2VkID0gImV4aXRGdWxsc2NyZWVuIiwgYS5pY29uID0gImVudGVyLWZ1bGxzY3JlZW4iLCBhLmljb25QcmVzc2VkID0gImV4aXQtZnVsbHNjcmVlbiI7CiAgICAgICAgYnJlYWs7CgogICAgICBjYXNlICJwbGF5LWxhcmdlIjoKICAgICAgICBpLmNsYXNzICs9ICIgIi5jb25jYXQodGhpcy5jb25maWcuY2xhc3NOYW1lcy5jb250cm9sLCAiLS1vdmVybGFpZCIpLCByID0gInBsYXkiLCBhLmxhYmVsID0gInBsYXkiLCBhLmljb24gPSAicGxheSI7CiAgICAgICAgYnJlYWs7CgogICAgICBkZWZhdWx0OgogICAgICAgIF9jKGEubGFiZWwpICYmIChhLmxhYmVsID0gciksIF9jKGEuaWNvbikgJiYgKGEuaWNvbiA9IGUpOwogICAgfQoKICAgIHZhciBvID0gemMoYS5lbGVtZW50KTsKICAgIHJldHVybiBhLnRvZ2dsZSA/IChvLmFwcGVuZENoaWxkKGp1LmNyZWF0ZUljb24uY2FsbCh0aGlzLCBhLmljb25QcmVzc2VkLCB7CiAgICAgIGNsYXNzOiAiaWNvbi0tcHJlc3NlZCIKICAgIH0pKSwgby5hcHBlbmRDaGlsZChqdS5jcmVhdGVJY29uLmNhbGwodGhpcywgYS5pY29uLCB7CiAgICAgIGNsYXNzOiAiaWNvbi0tbm90LXByZXNzZWQiCiAgICB9KSksIG8uYXBwZW5kQ2hpbGQoanUuY3JlYXRlTGFiZWwuY2FsbCh0aGlzLCBhLmxhYmVsUHJlc3NlZCwgewogICAgICBjbGFzczogImxhYmVsLS1wcmVzc2VkIgogICAgfSkpLCBvLmFwcGVuZENoaWxkKGp1LmNyZWF0ZUxhYmVsLmNhbGwodGhpcywgYS5sYWJlbCwgewogICAgICBjbGFzczogImxhYmVsLS1ub3QtcHJlc3NlZCIKICAgIH0pKSkgOiAoby5hcHBlbmRDaGlsZChqdS5jcmVhdGVJY29uLmNhbGwodGhpcywgYS5pY29uKSksIG8uYXBwZW5kQ2hpbGQoanUuY3JlYXRlTGFiZWwuY2FsbCh0aGlzLCBhLmxhYmVsKSkpLCBIYyhpLCBHYyh0aGlzLmNvbmZpZy5zZWxlY3RvcnMuYnV0dG9uc1tyXSwgaSkpLCBWYyhvLCBpKSwgInBsYXkiID09PSByID8gKFBjKHRoaXMuZWxlbWVudHMuYnV0dG9uc1tyXSkgfHwgKHRoaXMuZWxlbWVudHMuYnV0dG9uc1tyXSA9IFtdKSwgdGhpcy5lbGVtZW50cy5idXR0b25zW3JdLnB1c2gobykpIDogdGhpcy5lbGVtZW50cy5idXR0b25zW3JdID0gbywgbzsKICB9LAogIGNyZWF0ZVJhbmdlOiBmdW5jdGlvbiBjcmVhdGVSYW5nZShlLCB0KSB7CiAgICB2YXIgbiA9IHpjKCJpbnB1dCIsIEhjKEdjKHRoaXMuY29uZmlnLnNlbGVjdG9ycy5pbnB1dHNbZV0pLCB7CiAgICAgIHR5cGU6ICJyYW5nZSIsCiAgICAgIG1pbjogMCwKICAgICAgbWF4OiAxMDAsCiAgICAgIHN0ZXA6IC4wMSwKICAgICAgdmFsdWU6IDAsCiAgICAgIGF1dG9jb21wbGV0ZTogIm9mZiIsCiAgICAgIHJvbGU6ICJzbGlkZXIiLAogICAgICAiYXJpYS1sYWJlbCI6IHh1KGUsIHRoaXMuY29uZmlnKSwKICAgICAgImFyaWEtdmFsdWVtaW4iOiAwLAogICAgICAiYXJpYS12YWx1ZW1heCI6IDEwMCwKICAgICAgImFyaWEtdmFsdWVub3ciOiAwCiAgICB9LCB0KSk7CiAgICByZXR1cm4gdGhpcy5lbGVtZW50cy5pbnB1dHNbZV0gPSBuLCBqdS51cGRhdGVSYW5nZUZpbGwuY2FsbCh0aGlzLCBuKSwgZGMuc2V0dXAobiksIG47CiAgfSwKICBjcmVhdGVQcm9ncmVzczogZnVuY3Rpb24gY3JlYXRlUHJvZ3Jlc3MoZSwgdCkgewogICAgdmFyIG4gPSB6YygicHJvZ3Jlc3MiLCBIYyhHYyh0aGlzLmNvbmZpZy5zZWxlY3RvcnMuZGlzcGxheVtlXSksIHsKICAgICAgbWluOiAwLAogICAgICBtYXg6IDEwMCwKICAgICAgdmFsdWU6IDAsCiAgICAgIHJvbGU6ICJwcm9ncmVzc2JhciIsCiAgICAgICJhcmlhLWhpZGRlbiI6ICEwCiAgICB9LCB0KSk7CgogICAgaWYgKCJ2b2x1bWUiICE9PSBlKSB7CiAgICAgIG4uYXBwZW5kQ2hpbGQoemMoInNwYW4iLCBudWxsLCAiMCIpKTsKICAgICAgdmFyIGkgPSB7CiAgICAgICAgcGxheWVkOiAicGxheWVkIiwKICAgICAgICBidWZmZXI6ICJidWZmZXJlZCIKICAgICAgfVtlXSwKICAgICAgICAgIHIgPSBpID8geHUoaSwgdGhpcy5jb25maWcpIDogIiI7CiAgICAgIG4uaW5uZXJUZXh0ID0gIiUgIi5jb25jYXQoci50b0xvd2VyQ2FzZSgpKTsKICAgIH0KCiAgICByZXR1cm4gdGhpcy5lbGVtZW50cy5kaXNwbGF5W2VdID0gbiwgbjsKICB9LAogIGNyZWF0ZVRpbWU6IGZ1bmN0aW9uIGNyZWF0ZVRpbWUoZSwgdCkgewogICAgdmFyIG4gPSBHYyh0aGlzLmNvbmZpZy5zZWxlY3RvcnMuZGlzcGxheVtlXSwgdCksCiAgICAgICAgaSA9IHpjKCJkaXYiLCBIYyhuLCB7CiAgICAgIGNsYXNzOiAiIi5jb25jYXQobi5jbGFzcyA/IG4uY2xhc3MgOiAiIiwgIiAiKS5jb25jYXQodGhpcy5jb25maWcuY2xhc3NOYW1lcy5kaXNwbGF5LnRpbWUsICIgIikudHJpbSgpLAogICAgICAiYXJpYS1sYWJlbCI6IHh1KGUsIHRoaXMuY29uZmlnKQogICAgfSksICIwMDowMCIpOwogICAgcmV0dXJuIHRoaXMuZWxlbWVudHMuZGlzcGxheVtlXSA9IGksIGk7CiAgfSwKICBiaW5kTWVudUl0ZW1TaG9ydGN1dHM6IGZ1bmN0aW9uIGJpbmRNZW51SXRlbVNob3J0Y3V0cyhlLCB0KSB7CiAgICB2YXIgbiA9IHRoaXM7CiAgICBzdS5jYWxsKHRoaXMsIGUsICJrZXlkb3duIGtleXVwIiwgZnVuY3Rpb24gKGkpIHsKICAgICAgaWYgKFszMiwgMzgsIDM5LCA0MF0uaW5jbHVkZXMoaS53aGljaCkgJiYgKGkucHJldmVudERlZmF1bHQoKSwgaS5zdG9wUHJvcGFnYXRpb24oKSwgImtleWRvd24iICE9PSBpLnR5cGUpKSB7CiAgICAgICAgdmFyIHIsCiAgICAgICAgICAgIGEgPSBaYyhlLCAnW3JvbGU9Im1lbnVpdGVtcmFkaW8iXScpOwogICAgICAgICFhICYmIFszMiwgMzldLmluY2x1ZGVzKGkud2hpY2gpID8ganUuc2hvd01lbnVQYW5lbC5jYWxsKG4sIHQsICEwKSA6IDMyICE9PSBpLndoaWNoICYmICg0MCA9PT0gaS53aGljaCB8fCBhICYmIDM5ID09PSBpLndoaWNoID8gKHIgPSBlLm5leHRFbGVtZW50U2libGluZywgSWMocikgfHwgKHIgPSBlLnBhcmVudE5vZGUuZmlyc3RFbGVtZW50Q2hpbGQpKSA6IChyID0gZS5wcmV2aW91c0VsZW1lbnRTaWJsaW5nLCBJYyhyKSB8fCAociA9IGUucGFyZW50Tm9kZS5sYXN0RWxlbWVudENoaWxkKSksIG51LmNhbGwobiwgciwgITApKTsKICAgICAgfQogICAgfSwgITEpLCBzdS5jYWxsKHRoaXMsIGUsICJrZXl1cCIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIDEzID09PSBlLndoaWNoICYmIGp1LmZvY3VzRmlyc3RNZW51SXRlbS5jYWxsKG4sIG51bGwsICEwKTsKICAgIH0pOwogIH0sCiAgY3JlYXRlTWVudUl0ZW06IGZ1bmN0aW9uIGNyZWF0ZU1lbnVJdGVtKGUpIHsKICAgIHZhciB0ID0gdGhpcywKICAgICAgICBuID0gZS52YWx1ZSwKICAgICAgICBpID0gZS5saXN0LAogICAgICAgIHIgPSBlLnR5cGUsCiAgICAgICAgYSA9IGUudGl0bGUsCiAgICAgICAgbyA9IGUuYmFkZ2UsCiAgICAgICAgcyA9IHZvaWQgMCA9PT0gbyA/IG51bGwgOiBvLAogICAgICAgIGwgPSBlLmNoZWNrZWQsCiAgICAgICAgYyA9IHZvaWQgMCAhPT0gbCAmJiBsLAogICAgICAgIHUgPSBHYyh0aGlzLmNvbmZpZy5zZWxlY3RvcnMuaW5wdXRzW3JdKSwKICAgICAgICBoID0gemMoImJ1dHRvbiIsIEhjKHUsIHsKICAgICAgdHlwZTogImJ1dHRvbiIsCiAgICAgIHJvbGU6ICJtZW51aXRlbXJhZGlvIiwKICAgICAgY2xhc3M6ICIiLmNvbmNhdCh0aGlzLmNvbmZpZy5jbGFzc05hbWVzLmNvbnRyb2wsICIgIikuY29uY2F0KHUuY2xhc3MgPyB1LmNsYXNzIDogIiIpLnRyaW0oKSwKICAgICAgImFyaWEtY2hlY2tlZCI6IGMsCiAgICAgIHZhbHVlOiBuCiAgICB9KSksCiAgICAgICAgZCA9IHpjKCJzcGFuIik7CiAgICBkLmlubmVySFRNTCA9IGEsIEljKHMpICYmIGQuYXBwZW5kQ2hpbGQocyksIGguYXBwZW5kQ2hpbGQoZCksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShoLCAiY2hlY2tlZCIsIHsKICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiAidHJ1ZSIgPT09IGguZ2V0QXR0cmlidXRlKCJhcmlhLWNoZWNrZWQiKTsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoZSkgewogICAgICAgIGUgJiYgQXJyYXkuZnJvbShoLnBhcmVudE5vZGUuY2hpbGRyZW4pLmZpbHRlcihmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmV0dXJuIFpjKGUsICdbcm9sZT0ibWVudWl0ZW1yYWRpbyJdJyk7CiAgICAgICAgfSkuZm9yRWFjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmV0dXJuIGUuc2V0QXR0cmlidXRlKCJhcmlhLWNoZWNrZWQiLCAiZmFsc2UiKTsKICAgICAgICB9KSwgaC5zZXRBdHRyaWJ1dGUoImFyaWEtY2hlY2tlZCIsIGUgPyAidHJ1ZSIgOiAiZmFsc2UiKTsKICAgICAgfQogICAgfSksIHRoaXMubGlzdGVuZXJzLmJpbmQoaCwgImNsaWNrIGtleXVwIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKCFOYyhlKSB8fCAzMiA9PT0gZS53aGljaCkgewogICAgICAgIHN3aXRjaCAoZS5wcmV2ZW50RGVmYXVsdCgpLCBlLnN0b3BQcm9wYWdhdGlvbigpLCBoLmNoZWNrZWQgPSAhMCwgcikgewogICAgICAgICAgY2FzZSAibGFuZ3VhZ2UiOgogICAgICAgICAgICB0LmN1cnJlbnRUcmFjayA9IE51bWJlcihuKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAicXVhbGl0eSI6CiAgICAgICAgICAgIHQucXVhbGl0eSA9IG47CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgInNwZWVkIjoKICAgICAgICAgICAgdC5zcGVlZCA9IHBhcnNlRmxvYXQobik7CiAgICAgICAgfQoKICAgICAgICBqdS5zaG93TWVudVBhbmVsLmNhbGwodCwgImhvbWUiLCBOYyhlKSk7CiAgICAgIH0KICAgIH0sIHIsICExKSwganUuYmluZE1lbnVJdGVtU2hvcnRjdXRzLmNhbGwodGhpcywgaCwgciksIGkuYXBwZW5kQ2hpbGQoaCk7CiAgfSwKICBmb3JtYXRUaW1lOiBmdW5jdGlvbiBmb3JtYXRUaW1lKCkgewogICAgdmFyIGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1swXSA/IGFyZ3VtZW50c1swXSA6IDAsCiAgICAgICAgdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzFdICYmIGFyZ3VtZW50c1sxXTsKICAgIGlmICghRWMoZSkpIHJldHVybiBlOwogICAgdmFyIG4gPSBJdSh0aGlzLmR1cmF0aW9uKSA+IDA7CiAgICByZXR1cm4gTXUoZSwgbiwgdCk7CiAgfSwKICB1cGRhdGVUaW1lRGlzcGxheTogZnVuY3Rpb24gdXBkYXRlVGltZURpc3BsYXkoKSB7CiAgICB2YXIgZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdID8gYXJndW1lbnRzWzBdIDogbnVsbCwKICAgICAgICB0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbMV0gPyBhcmd1bWVudHNbMV0gOiAwLAogICAgICAgIG4gPSBhcmd1bWVudHMubGVuZ3RoID4gMiAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1syXSAmJiBhcmd1bWVudHNbMl07CiAgICBJYyhlKSAmJiBFYyh0KSAmJiAoZS5pbm5lclRleHQgPSBqdS5mb3JtYXRUaW1lKHQsIG4pKTsKICB9LAogIHVwZGF0ZVZvbHVtZTogZnVuY3Rpb24gdXBkYXRlVm9sdW1lKCkgewogICAgdGhpcy5zdXBwb3J0ZWQudWkgJiYgKEljKHRoaXMuZWxlbWVudHMuaW5wdXRzLnZvbHVtZSkgJiYganUuc2V0UmFuZ2UuY2FsbCh0aGlzLCB0aGlzLmVsZW1lbnRzLmlucHV0cy52b2x1bWUsIHRoaXMubXV0ZWQgPyAwIDogdGhpcy52b2x1bWUpLCBJYyh0aGlzLmVsZW1lbnRzLmJ1dHRvbnMubXV0ZSkgJiYgKHRoaXMuZWxlbWVudHMuYnV0dG9ucy5tdXRlLnByZXNzZWQgPSB0aGlzLm11dGVkIHx8IDAgPT09IHRoaXMudm9sdW1lKSk7CiAgfSwKICBzZXRSYW5nZTogZnVuY3Rpb24gc2V0UmFuZ2UoZSkgewogICAgdmFyIHQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSA/IGFyZ3VtZW50c1sxXSA6IDA7CiAgICBJYyhlKSAmJiAoZS52YWx1ZSA9IHQsIGp1LnVwZGF0ZVJhbmdlRmlsbC5jYWxsKHRoaXMsIGUpKTsKICB9LAogIHVwZGF0ZVByb2dyZXNzOiBmdW5jdGlvbiB1cGRhdGVQcm9ncmVzcyhlKSB7CiAgICB2YXIgdCA9IHRoaXM7CgogICAgaWYgKHRoaXMuc3VwcG9ydGVkLnVpICYmIExjKGUpKSB7CiAgICAgIHZhciBuID0gMDsKICAgICAgaWYgKGUpIHN3aXRjaCAoZS50eXBlKSB7CiAgICAgICAgY2FzZSAidGltZXVwZGF0ZSI6CiAgICAgICAgY2FzZSAic2Vla2luZyI6CiAgICAgICAgY2FzZSAic2Vla2VkIjoKICAgICAgICAgIG4gPSBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgICByZXR1cm4gMCA9PT0gZSB8fCAwID09PSB0IHx8IE51bWJlci5pc05hTihlKSB8fCBOdW1iZXIuaXNOYU4odCkgPyAwIDogKGUgLyB0ICogMTAwKS50b0ZpeGVkKDIpOwogICAgICAgICAgfSh0aGlzLmN1cnJlbnRUaW1lLCB0aGlzLmR1cmF0aW9uKSwgInRpbWV1cGRhdGUiID09PSBlLnR5cGUgJiYganUuc2V0UmFuZ2UuY2FsbCh0aGlzLCB0aGlzLmVsZW1lbnRzLmlucHV0cy5zZWVrLCBuKTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICJwbGF5aW5nIjoKICAgICAgICBjYXNlICJwcm9ncmVzcyI6CiAgICAgICAgICAhZnVuY3Rpb24gKGUsIG4pIHsKICAgICAgICAgICAgdmFyIGkgPSBFYyhuKSA/IG4gOiAwLAogICAgICAgICAgICAgICAgciA9IEljKGUpID8gZSA6IHQuZWxlbWVudHMuZGlzcGxheS5idWZmZXI7CgogICAgICAgICAgICBpZiAoSWMocikpIHsKICAgICAgICAgICAgICByLnZhbHVlID0gaTsKICAgICAgICAgICAgICB2YXIgYSA9IHIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInNwYW4iKVswXTsKICAgICAgICAgICAgICBJYyhhKSAmJiAoYS5jaGlsZE5vZGVzWzBdLm5vZGVWYWx1ZSA9IGkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KHRoaXMuZWxlbWVudHMuZGlzcGxheS5idWZmZXIsIDEwMCAqIHRoaXMuYnVmZmVyZWQpOwogICAgICB9CiAgICB9CiAgfSwKICB1cGRhdGVSYW5nZUZpbGw6IGZ1bmN0aW9uIHVwZGF0ZVJhbmdlRmlsbChlKSB7CiAgICB2YXIgdCA9IExjKGUpID8gZS50YXJnZXQgOiBlOwoKICAgIGlmIChJYyh0KSAmJiAicmFuZ2UiID09PSB0LmdldEF0dHJpYnV0ZSgidHlwZSIpKSB7CiAgICAgIGlmIChaYyh0LCB0aGlzLmNvbmZpZy5zZWxlY3RvcnMuaW5wdXRzLnNlZWspKSB7CiAgICAgICAgdC5zZXRBdHRyaWJ1dGUoImFyaWEtdmFsdWVub3ciLCB0aGlzLmN1cnJlbnRUaW1lKTsKICAgICAgICB2YXIgbiA9IGp1LmZvcm1hdFRpbWUodGhpcy5jdXJyZW50VGltZSksCiAgICAgICAgICAgIGkgPSBqdS5mb3JtYXRUaW1lKHRoaXMuZHVyYXRpb24pLAogICAgICAgICAgICByID0geHUoInNlZWtMYWJlbCIsIHRoaXMuY29uZmlnKTsKICAgICAgICB0LnNldEF0dHJpYnV0ZSgiYXJpYS12YWx1ZXRleHQiLCByLnJlcGxhY2UoIntjdXJyZW50VGltZX0iLCBuKS5yZXBsYWNlKCJ7ZHVyYXRpb259IiwgaSkpOwogICAgICB9IGVsc2UgaWYgKFpjKHQsIHRoaXMuY29uZmlnLnNlbGVjdG9ycy5pbnB1dHMudm9sdW1lKSkgewogICAgICAgIHZhciBhID0gMTAwICogdC52YWx1ZTsKICAgICAgICB0LnNldEF0dHJpYnV0ZSgiYXJpYS12YWx1ZW5vdyIsIGEpLCB0LnNldEF0dHJpYnV0ZSgiYXJpYS12YWx1ZXRleHQiLCAiIi5jb25jYXQoYS50b0ZpeGVkKDEpLCAiJSIpKTsKICAgICAgfSBlbHNlIHQuc2V0QXR0cmlidXRlKCJhcmlhLXZhbHVlbm93IiwgdC52YWx1ZSk7CgogICAgICBxYy5pc1dlYmtpdCAmJiB0LnN0eWxlLnNldFByb3BlcnR5KCItLXZhbHVlIiwgIiIuY29uY2F0KHQudmFsdWUgLyB0Lm1heCAqIDEwMCwgIiUiKSk7CiAgICB9CiAgfSwKICB1cGRhdGVTZWVrVG9vbHRpcDogZnVuY3Rpb24gdXBkYXRlU2Vla1Rvb2x0aXAoZSkgewogICAgdmFyIHQgPSB0aGlzOwoKICAgIGlmICh0aGlzLmNvbmZpZy50b29sdGlwcy5zZWVrICYmIEljKHRoaXMuZWxlbWVudHMuaW5wdXRzLnNlZWspICYmIEljKHRoaXMuZWxlbWVudHMuZGlzcGxheS5zZWVrVG9vbHRpcCkgJiYgMCAhPT0gdGhpcy5kdXJhdGlvbikgewogICAgICB2YXIgbiA9ICIiLmNvbmNhdCh0aGlzLmNvbmZpZy5jbGFzc05hbWVzLnRvb2x0aXAsICItLXZpc2libGUiKSwKICAgICAgICAgIGkgPSBmdW5jdGlvbiBpKGUpIHsKICAgICAgICByZXR1cm4gUWModC5lbGVtZW50cy5kaXNwbGF5LnNlZWtUb29sdGlwLCBuLCBlKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLnRvdWNoKSBpKCExKTtlbHNlIHsKICAgICAgICB2YXIgciA9IDAsCiAgICAgICAgICAgIGEgPSB0aGlzLmVsZW1lbnRzLnByb2dyZXNzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIGlmIChMYyhlKSkgciA9IDEwMCAvIGEud2lkdGggKiAoZS5wYWdlWCAtIGEubGVmdCk7ZWxzZSB7CiAgICAgICAgICBpZiAoIUpjKHRoaXMuZWxlbWVudHMuZGlzcGxheS5zZWVrVG9vbHRpcCwgbikpIHJldHVybjsKICAgICAgICAgIHIgPSBwYXJzZUZsb2F0KHRoaXMuZWxlbWVudHMuZGlzcGxheS5zZWVrVG9vbHRpcC5zdHlsZS5sZWZ0LCAxMCk7CiAgICAgICAgfQogICAgICAgIHIgPCAwID8gciA9IDAgOiByID4gMTAwICYmIChyID0gMTAwKSwganUudXBkYXRlVGltZURpc3BsYXkuY2FsbCh0aGlzLCB0aGlzLmVsZW1lbnRzLmRpc3BsYXkuc2Vla1Rvb2x0aXAsIHRoaXMuZHVyYXRpb24gLyAxMDAgKiByKSwgdGhpcy5lbGVtZW50cy5kaXNwbGF5LnNlZWtUb29sdGlwLnN0eWxlLmxlZnQgPSAiIi5jb25jYXQociwgIiUiKSwgTGMoZSkgJiYgWyJtb3VzZWVudGVyIiwgIm1vdXNlbGVhdmUiXS5pbmNsdWRlcyhlLnR5cGUpICYmIGkoIm1vdXNlZW50ZXIiID09PSBlLnR5cGUpOwogICAgICB9CiAgICB9CiAgfSwKICB0aW1lVXBkYXRlOiBmdW5jdGlvbiB0aW1lVXBkYXRlKGUpIHsKICAgIHZhciB0ID0gIUljKHRoaXMuZWxlbWVudHMuZGlzcGxheS5kdXJhdGlvbikgJiYgdGhpcy5jb25maWcuaW52ZXJ0VGltZTsKICAgIGp1LnVwZGF0ZVRpbWVEaXNwbGF5LmNhbGwodGhpcywgdGhpcy5lbGVtZW50cy5kaXNwbGF5LmN1cnJlbnRUaW1lLCB0ID8gdGhpcy5kdXJhdGlvbiAtIHRoaXMuY3VycmVudFRpbWUgOiB0aGlzLmN1cnJlbnRUaW1lLCB0KSwgZSAmJiAidGltZXVwZGF0ZSIgPT09IGUudHlwZSAmJiB0aGlzLm1lZGlhLnNlZWtpbmcgfHwganUudXBkYXRlUHJvZ3Jlc3MuY2FsbCh0aGlzLCBlKTsKICB9LAogIGR1cmF0aW9uVXBkYXRlOiBmdW5jdGlvbiBkdXJhdGlvblVwZGF0ZSgpIHsKICAgIGlmICh0aGlzLnN1cHBvcnRlZC51aSAmJiAodGhpcy5jb25maWcuaW52ZXJ0VGltZSB8fCAhdGhpcy5jdXJyZW50VGltZSkpIHsKICAgICAgaWYgKHRoaXMuZHVyYXRpb24gPj0gTWF0aC5wb3coMiwgMzIpKSByZXR1cm4gWGModGhpcy5lbGVtZW50cy5kaXNwbGF5LmN1cnJlbnRUaW1lLCAhMCksIHZvaWQgWGModGhpcy5lbGVtZW50cy5wcm9ncmVzcywgITApOwogICAgICBJYyh0aGlzLmVsZW1lbnRzLmlucHV0cy5zZWVrKSAmJiB0aGlzLmVsZW1lbnRzLmlucHV0cy5zZWVrLnNldEF0dHJpYnV0ZSgiYXJpYS12YWx1ZW1heCIsIHRoaXMuZHVyYXRpb24pOwogICAgICB2YXIgZSA9IEljKHRoaXMuZWxlbWVudHMuZGlzcGxheS5kdXJhdGlvbik7CiAgICAgICFlICYmIHRoaXMuY29uZmlnLmRpc3BsYXlEdXJhdGlvbiAmJiB0aGlzLnBhdXNlZCAmJiBqdS51cGRhdGVUaW1lRGlzcGxheS5jYWxsKHRoaXMsIHRoaXMuZWxlbWVudHMuZGlzcGxheS5jdXJyZW50VGltZSwgdGhpcy5kdXJhdGlvbiksIGUgJiYganUudXBkYXRlVGltZURpc3BsYXkuY2FsbCh0aGlzLCB0aGlzLmVsZW1lbnRzLmRpc3BsYXkuZHVyYXRpb24sIHRoaXMuZHVyYXRpb24pLCBqdS51cGRhdGVTZWVrVG9vbHRpcC5jYWxsKHRoaXMpOwogICAgfQogIH0sCiAgdG9nZ2xlTWVudUJ1dHRvbjogZnVuY3Rpb24gdG9nZ2xlTWVudUJ1dHRvbihlLCB0KSB7CiAgICBYYyh0aGlzLmVsZW1lbnRzLnNldHRpbmdzLmJ1dHRvbnNbZV0sICF0KTsKICB9LAogIHVwZGF0ZVNldHRpbmc6IGZ1bmN0aW9uIHVwZGF0ZVNldHRpbmcoZSwgdCwgbikgewogICAgdmFyIGkgPSB0aGlzLmVsZW1lbnRzLnNldHRpbmdzLnBhbmVsc1tlXSwKICAgICAgICByID0gbnVsbCwKICAgICAgICBhID0gdDsKICAgIGlmICgiY2FwdGlvbnMiID09PSBlKSByID0gdGhpcy5jdXJyZW50VHJhY2s7ZWxzZSB7CiAgICAgIGlmIChyID0gX2MobikgPyB0aGlzW2VdIDogbiwgX2MocikgJiYgKHIgPSB0aGlzLmNvbmZpZ1tlXS5kZWZhdWx0KSwgIV9jKHRoaXMub3B0aW9uc1tlXSkgJiYgIXRoaXMub3B0aW9uc1tlXS5pbmNsdWRlcyhyKSkgcmV0dXJuIHZvaWQgdGhpcy5kZWJ1Zy53YXJuKCJVbnN1cHBvcnRlZCB2YWx1ZSBvZiAnIi5jb25jYXQociwgIicgZm9yICIpLmNvbmNhdChlKSk7CiAgICAgIGlmICghdGhpcy5jb25maWdbZV0ub3B0aW9ucy5pbmNsdWRlcyhyKSkgcmV0dXJuIHZvaWQgdGhpcy5kZWJ1Zy53YXJuKCJEaXNhYmxlZCB2YWx1ZSBvZiAnIi5jb25jYXQociwgIicgZm9yICIpLmNvbmNhdChlKSk7CiAgICB9CgogICAgaWYgKEljKGEpIHx8IChhID0gaSAmJiBpLnF1ZXJ5U2VsZWN0b3IoJ1tyb2xlPSJtZW51Il0nKSksIEljKGEpKSB7CiAgICAgIHRoaXMuZWxlbWVudHMuc2V0dGluZ3MuYnV0dG9uc1tlXS5xdWVyeVNlbGVjdG9yKCIuIi5jb25jYXQodGhpcy5jb25maWcuY2xhc3NOYW1lcy5tZW51LnZhbHVlKSkuaW5uZXJIVE1MID0ganUuZ2V0TGFiZWwuY2FsbCh0aGlzLCBlLCByKTsKICAgICAgdmFyIG8gPSBhICYmIGEucXVlcnlTZWxlY3RvcignW3ZhbHVlPSInLmNvbmNhdChyLCAnIl0nKSk7CiAgICAgIEljKG8pICYmIChvLmNoZWNrZWQgPSAhMCk7CiAgICB9CiAgfSwKICBnZXRMYWJlbDogZnVuY3Rpb24gZ2V0TGFiZWwoZSwgdCkgewogICAgc3dpdGNoIChlKSB7CiAgICAgIGNhc2UgInNwZWVkIjoKICAgICAgICByZXR1cm4gMSA9PT0gdCA/IHh1KCJub3JtYWwiLCB0aGlzLmNvbmZpZykgOiAiIi5jb25jYXQodCwgIiZ0aW1lczsiKTsKCiAgICAgIGNhc2UgInF1YWxpdHkiOgogICAgICAgIGlmIChFYyh0KSkgewogICAgICAgICAgdmFyIG4gPSB4dSgicXVhbGl0eUxhYmVsLiIuY29uY2F0KHQpLCB0aGlzLmNvbmZpZyk7CiAgICAgICAgICByZXR1cm4gbi5sZW5ndGggPyBuIDogIiIuY29uY2F0KHQsICJwIik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gVHUodCk7CgogICAgICBjYXNlICJjYXB0aW9ucyI6CiAgICAgICAgcmV0dXJuIER1LmdldExhYmVsLmNhbGwodGhpcyk7CgogICAgICBkZWZhdWx0OgogICAgICAgIHJldHVybiBudWxsOwogICAgfQogIH0sCiAgc2V0UXVhbGl0eU1lbnU6IGZ1bmN0aW9uIHNldFF1YWxpdHlNZW51KGUpIHsKICAgIHZhciB0ID0gdGhpczsKCiAgICBpZiAoSWModGhpcy5lbGVtZW50cy5zZXR0aW5ncy5wYW5lbHMucXVhbGl0eSkpIHsKICAgICAgdmFyIG4gPSAicXVhbGl0eSIsCiAgICAgICAgICBpID0gdGhpcy5lbGVtZW50cy5zZXR0aW5ncy5wYW5lbHMucXVhbGl0eS5xdWVyeVNlbGVjdG9yKCdbcm9sZT0ibWVudSJdJyk7CiAgICAgIFBjKGUpICYmICh0aGlzLm9wdGlvbnMucXVhbGl0eSA9IGJ1KGUpLmZpbHRlcihmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiB0LmNvbmZpZy5xdWFsaXR5Lm9wdGlvbnMuaW5jbHVkZXMoZSk7CiAgICAgIH0pKTsKICAgICAgdmFyIHIgPSAhX2ModGhpcy5vcHRpb25zLnF1YWxpdHkpICYmIHRoaXMub3B0aW9ucy5xdWFsaXR5Lmxlbmd0aCA+IDE7CgogICAgICBpZiAoanUudG9nZ2xlTWVudUJ1dHRvbi5jYWxsKHRoaXMsIG4sIHIpLCBLYyhpKSwganUuY2hlY2tNZW51LmNhbGwodGhpcyksIHIpIHsKICAgICAgICB2YXIgYSA9IGZ1bmN0aW9uIGEoZSkgewogICAgICAgICAgdmFyIG4gPSB4dSgicXVhbGl0eUJhZGdlLiIuY29uY2F0KGUpLCB0LmNvbmZpZyk7CiAgICAgICAgICByZXR1cm4gbi5sZW5ndGggPyBqdS5jcmVhdGVCYWRnZS5jYWxsKHQsIG4pIDogbnVsbDsKICAgICAgICB9OwoKICAgICAgICB0aGlzLm9wdGlvbnMucXVhbGl0eS5zb3J0KGZ1bmN0aW9uIChlLCBuKSB7CiAgICAgICAgICB2YXIgaSA9IHQuY29uZmlnLnF1YWxpdHkub3B0aW9uczsKICAgICAgICAgIHJldHVybiBpLmluZGV4T2YoZSkgPiBpLmluZGV4T2YobikgPyAxIDogLTE7CiAgICAgICAgfSkuZm9yRWFjaChmdW5jdGlvbiAoZSkgewogICAgICAgICAganUuY3JlYXRlTWVudUl0ZW0uY2FsbCh0LCB7CiAgICAgICAgICAgIHZhbHVlOiBlLAogICAgICAgICAgICBsaXN0OiBpLAogICAgICAgICAgICB0eXBlOiBuLAogICAgICAgICAgICB0aXRsZToganUuZ2V0TGFiZWwuY2FsbCh0LCAicXVhbGl0eSIsIGUpLAogICAgICAgICAgICBiYWRnZTogYShlKQogICAgICAgICAgfSk7CiAgICAgICAgfSksIGp1LnVwZGF0ZVNldHRpbmcuY2FsbCh0aGlzLCBuLCBpKTsKICAgICAgfQogICAgfQogIH0sCiAgc2V0Q2FwdGlvbnNNZW51OiBmdW5jdGlvbiBzZXRDYXB0aW9uc01lbnUoKSB7CiAgICB2YXIgZSA9IHRoaXM7CgogICAgaWYgKEljKHRoaXMuZWxlbWVudHMuc2V0dGluZ3MucGFuZWxzLmNhcHRpb25zKSkgewogICAgICB2YXIgdCA9ICJjYXB0aW9ucyIsCiAgICAgICAgICBuID0gdGhpcy5lbGVtZW50cy5zZXR0aW5ncy5wYW5lbHMuY2FwdGlvbnMucXVlcnlTZWxlY3RvcignW3JvbGU9Im1lbnUiXScpLAogICAgICAgICAgaSA9IER1LmdldFRyYWNrcy5jYWxsKHRoaXMpLAogICAgICAgICAgciA9IEJvb2xlYW4oaS5sZW5ndGgpOwoKICAgICAgaWYgKGp1LnRvZ2dsZU1lbnVCdXR0b24uY2FsbCh0aGlzLCB0LCByKSwgS2MobiksIGp1LmNoZWNrTWVudS5jYWxsKHRoaXMpLCByKSB7CiAgICAgICAgdmFyIGEgPSBpLm1hcChmdW5jdGlvbiAodCwgaSkgewogICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdmFsdWU6IGksCiAgICAgICAgICAgIGNoZWNrZWQ6IGUuY2FwdGlvbnMudG9nZ2xlZCAmJiBlLmN1cnJlbnRUcmFjayA9PT0gaSwKICAgICAgICAgICAgdGl0bGU6IER1LmdldExhYmVsLmNhbGwoZSwgdCksCiAgICAgICAgICAgIGJhZGdlOiB0Lmxhbmd1YWdlICYmIGp1LmNyZWF0ZUJhZGdlLmNhbGwoZSwgdC5sYW5ndWFnZS50b1VwcGVyQ2FzZSgpKSwKICAgICAgICAgICAgbGlzdDogbiwKICAgICAgICAgICAgdHlwZTogImxhbmd1YWdlIgogICAgICAgICAgfTsKICAgICAgICB9KTsKICAgICAgICBhLnVuc2hpZnQoewogICAgICAgICAgdmFsdWU6IC0xLAogICAgICAgICAgY2hlY2tlZDogIXRoaXMuY2FwdGlvbnMudG9nZ2xlZCwKICAgICAgICAgIHRpdGxlOiB4dSgiZGlzYWJsZWQiLCB0aGlzLmNvbmZpZyksCiAgICAgICAgICBsaXN0OiBuLAogICAgICAgICAgdHlwZTogImxhbmd1YWdlIgogICAgICAgIH0pLCBhLmZvckVhY2goanUuY3JlYXRlTWVudUl0ZW0uYmluZCh0aGlzKSksIGp1LnVwZGF0ZVNldHRpbmcuY2FsbCh0aGlzLCB0LCBuKTsKICAgICAgfQogICAgfQogIH0sCiAgc2V0U3BlZWRNZW51OiBmdW5jdGlvbiBzZXRTcGVlZE1lbnUoKSB7CiAgICB2YXIgZSA9IHRoaXM7CgogICAgaWYgKEljKHRoaXMuZWxlbWVudHMuc2V0dGluZ3MucGFuZWxzLnNwZWVkKSkgewogICAgICB2YXIgdCA9ICJzcGVlZCIsCiAgICAgICAgICBuID0gdGhpcy5lbGVtZW50cy5zZXR0aW5ncy5wYW5lbHMuc3BlZWQucXVlcnlTZWxlY3RvcignW3JvbGU9Im1lbnUiXScpOwogICAgICB0aGlzLm9wdGlvbnMuc3BlZWQgPSB0aGlzLm9wdGlvbnMuc3BlZWQuZmlsdGVyKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgcmV0dXJuIHQgPj0gZS5taW5pbXVtU3BlZWQgJiYgdCA8PSBlLm1heGltdW1TcGVlZDsKICAgICAgfSk7CiAgICAgIHZhciBpID0gIV9jKHRoaXMub3B0aW9ucy5zcGVlZCkgJiYgdGhpcy5vcHRpb25zLnNwZWVkLmxlbmd0aCA+IDE7CiAgICAgIGp1LnRvZ2dsZU1lbnVCdXR0b24uY2FsbCh0aGlzLCB0LCBpKSwgS2MobiksIGp1LmNoZWNrTWVudS5jYWxsKHRoaXMpLCBpICYmICh0aGlzLm9wdGlvbnMuc3BlZWQuZm9yRWFjaChmdW5jdGlvbiAoaSkgewogICAgICAgIGp1LmNyZWF0ZU1lbnVJdGVtLmNhbGwoZSwgewogICAgICAgICAgdmFsdWU6IGksCiAgICAgICAgICBsaXN0OiBuLAogICAgICAgICAgdHlwZTogdCwKICAgICAgICAgIHRpdGxlOiBqdS5nZXRMYWJlbC5jYWxsKGUsICJzcGVlZCIsIGkpCiAgICAgICAgfSk7CiAgICAgIH0pLCBqdS51cGRhdGVTZXR0aW5nLmNhbGwodGhpcywgdCwgbikpOwogICAgfQogIH0sCiAgY2hlY2tNZW51OiBmdW5jdGlvbiBjaGVja01lbnUoKSB7CiAgICB2YXIgZSA9IHRoaXMuZWxlbWVudHMuc2V0dGluZ3MuYnV0dG9ucywKICAgICAgICB0ID0gIV9jKGUpICYmIE9iamVjdC52YWx1ZXMoZSkuc29tZShmdW5jdGlvbiAoZSkgewogICAgICByZXR1cm4gIWUuaGlkZGVuOwogICAgfSk7CiAgICBYYyh0aGlzLmVsZW1lbnRzLnNldHRpbmdzLm1lbnUsICF0KTsKICB9LAogIGZvY3VzRmlyc3RNZW51SXRlbTogZnVuY3Rpb24gZm9jdXNGaXJzdE1lbnVJdGVtKGUpIHsKICAgIHZhciB0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbMV0gJiYgYXJndW1lbnRzWzFdOwoKICAgIGlmICghdGhpcy5lbGVtZW50cy5zZXR0aW5ncy5wb3B1cC5oaWRkZW4pIHsKICAgICAgdmFyIG4gPSBlOwogICAgICBJYyhuKSB8fCAobiA9IE9iamVjdC52YWx1ZXModGhpcy5lbGVtZW50cy5zZXR0aW5ncy5wYW5lbHMpLmZpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gIWUuaGlkZGVuOwogICAgICB9KSk7CiAgICAgIHZhciBpID0gbi5xdWVyeVNlbGVjdG9yKCdbcm9sZV49Im1lbnVpdGVtIl0nKTsKICAgICAgbnUuY2FsbCh0aGlzLCBpLCB0KTsKICAgIH0KICB9LAogIHRvZ2dsZU1lbnU6IGZ1bmN0aW9uIHRvZ2dsZU1lbnUoZSkgewogICAgdmFyIHQgPSB0aGlzLmVsZW1lbnRzLnNldHRpbmdzLnBvcHVwLAogICAgICAgIG4gPSB0aGlzLmVsZW1lbnRzLmJ1dHRvbnMuc2V0dGluZ3M7CgogICAgaWYgKEljKHQpICYmIEljKG4pKSB7CiAgICAgIHZhciBpID0gdC5oaWRkZW4sCiAgICAgICAgICByID0gaTsKICAgICAgaWYgKHhjKGUpKSByID0gZTtlbHNlIGlmIChOYyhlKSAmJiAyNyA9PT0gZS53aGljaCkgciA9ICExO2Vsc2UgaWYgKExjKGUpKSB7CiAgICAgICAgdmFyIGEgPSBDYyhlLmNvbXBvc2VkUGF0aCkgPyBlLmNvbXBvc2VkUGF0aCgpWzBdIDogZS50YXJnZXQsCiAgICAgICAgICAgIG8gPSB0LmNvbnRhaW5zKGEpOwogICAgICAgIGlmIChvIHx8ICFvICYmIGUudGFyZ2V0ICE9PSBuICYmIHIpIHJldHVybjsKICAgICAgfQogICAgICBuLnNldEF0dHJpYnV0ZSgiYXJpYS1leHBhbmRlZCIsIHIpLCBYYyh0LCAhciksIFFjKHRoaXMuZWxlbWVudHMuY29udGFpbmVyLCB0aGlzLmNvbmZpZy5jbGFzc05hbWVzLm1lbnUub3BlbiwgciksIHIgJiYgTmMoZSkgPyBqdS5mb2N1c0ZpcnN0TWVudUl0ZW0uY2FsbCh0aGlzLCBudWxsLCAhMCkgOiByIHx8IGkgfHwgbnUuY2FsbCh0aGlzLCBuLCBOYyhlKSk7CiAgICB9CiAgfSwKICBnZXRNZW51U2l6ZTogZnVuY3Rpb24gZ2V0TWVudVNpemUoZSkgewogICAgdmFyIHQgPSBlLmNsb25lTm9kZSghMCk7CiAgICB0LnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIiwgdC5zdHlsZS5vcGFjaXR5ID0gMCwgdC5yZW1vdmVBdHRyaWJ1dGUoImhpZGRlbiIpLCBlLnBhcmVudE5vZGUuYXBwZW5kQ2hpbGQodCk7CiAgICB2YXIgbiA9IHQuc2Nyb2xsV2lkdGgsCiAgICAgICAgaSA9IHQuc2Nyb2xsSGVpZ2h0OwogICAgcmV0dXJuICRjKHQpLCB7CiAgICAgIHdpZHRoOiBuLAogICAgICBoZWlnaHQ6IGkKICAgIH07CiAgfSwKICBzaG93TWVudVBhbmVsOiBmdW5jdGlvbiBzaG93TWVudVBhbmVsKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIHQgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1swXSA/IGFyZ3VtZW50c1swXSA6ICIiLAogICAgICAgIG4gPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSAmJiBhcmd1bWVudHNbMV0sCiAgICAgICAgaSA9IHRoaXMuZWxlbWVudHMuY29udGFpbmVyLnF1ZXJ5U2VsZWN0b3IoIiNwbHlyLXNldHRpbmdzLSIuY29uY2F0KHRoaXMuaWQsICItIikuY29uY2F0KHQpKTsKCiAgICBpZiAoSWMoaSkpIHsKICAgICAgdmFyIHIgPSBpLnBhcmVudE5vZGUsCiAgICAgICAgICBhID0gQXJyYXkuZnJvbShyLmNoaWxkcmVuKS5maW5kKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuICFlLmhpZGRlbjsKICAgICAgfSk7CgogICAgICBpZiAocnUudHJhbnNpdGlvbnMgJiYgIXJ1LnJlZHVjZWRNb3Rpb24pIHsKICAgICAgICByLnN0eWxlLndpZHRoID0gIiIuY29uY2F0KGEuc2Nyb2xsV2lkdGgsICJweCIpLCByLnN0eWxlLmhlaWdodCA9ICIiLmNvbmNhdChhLnNjcm9sbEhlaWdodCwgInB4Iik7CgogICAgICAgIHZhciBvID0ganUuZ2V0TWVudVNpemUuY2FsbCh0aGlzLCBpKSwKICAgICAgICAgICAgcyA9IGZ1bmN0aW9uIHQobikgewogICAgICAgICAgbi50YXJnZXQgPT09IHIgJiYgWyJ3aWR0aCIsICJoZWlnaHQiXS5pbmNsdWRlcyhuLnByb3BlcnR5TmFtZSkgJiYgKHIuc3R5bGUud2lkdGggPSAiIiwgci5zdHlsZS5oZWlnaHQgPSAiIiwgbHUuY2FsbChlLCByLCBEYywgdCkpOwogICAgICAgIH07CgogICAgICAgIHN1LmNhbGwodGhpcywgciwgRGMsIHMpLCByLnN0eWxlLndpZHRoID0gIiIuY29uY2F0KG8ud2lkdGgsICJweCIpLCByLnN0eWxlLmhlaWdodCA9ICIiLmNvbmNhdChvLmhlaWdodCwgInB4Iik7CiAgICAgIH0KCiAgICAgIFhjKGEsICEwKSwgWGMoaSwgITEpLCBqdS5mb2N1c0ZpcnN0TWVudUl0ZW0uY2FsbCh0aGlzLCBpLCBuKTsKICAgIH0KICB9LAogIHNldERvd25sb2FkVXJsOiBmdW5jdGlvbiBzZXREb3dubG9hZFVybCgpIHsKICAgIHZhciBlID0gdGhpcy5lbGVtZW50cy5idXR0b25zLmRvd25sb2FkOwogICAgSWMoZSkgJiYgZS5zZXRBdHRyaWJ1dGUoImhyZWYiLCB0aGlzLmRvd25sb2FkKTsKICB9LAogIGNyZWF0ZTogZnVuY3Rpb24gY3JlYXRlKGUpIHsKICAgIHZhciB0ID0gdGhpcywKICAgICAgICBuID0ganUuYmluZE1lbnVJdGVtU2hvcnRjdXRzLAogICAgICAgIGkgPSBqdS5jcmVhdGVCdXR0b24sCiAgICAgICAgciA9IGp1LmNyZWF0ZVByb2dyZXNzLAogICAgICAgIGEgPSBqdS5jcmVhdGVSYW5nZSwKICAgICAgICBvID0ganUuY3JlYXRlVGltZSwKICAgICAgICBzID0ganUuc2V0UXVhbGl0eU1lbnUsCiAgICAgICAgbCA9IGp1LnNldFNwZWVkTWVudSwKICAgICAgICBjID0ganUuc2hvd01lbnVQYW5lbDsKICAgIHRoaXMuZWxlbWVudHMuY29udHJvbHMgPSBudWxsLCBQYyh0aGlzLmNvbmZpZy5jb250cm9scykgJiYgdGhpcy5jb25maWcuY29udHJvbHMuaW5jbHVkZXMoInBsYXktbGFyZ2UiKSAmJiB0aGlzLmVsZW1lbnRzLmNvbnRhaW5lci5hcHBlbmRDaGlsZChpLmNhbGwodGhpcywgInBsYXktbGFyZ2UiKSk7CiAgICB2YXIgdSA9IHpjKCJkaXYiLCBHYyh0aGlzLmNvbmZpZy5zZWxlY3RvcnMuY29udHJvbHMud3JhcHBlcikpOwogICAgdGhpcy5lbGVtZW50cy5jb250cm9scyA9IHU7CiAgICB2YXIgaCA9IHsKICAgICAgY2xhc3M6ICJwbHlyX19jb250cm9sc19faXRlbSIKICAgIH07CiAgICByZXR1cm4gYnUoUGModGhpcy5jb25maWcuY29udHJvbHMpID8gdGhpcy5jb25maWcuY29udHJvbHMgOiBbXSkuZm9yRWFjaChmdW5jdGlvbiAocykgewogICAgICBpZiAoInJlc3RhcnQiID09PSBzICYmIHUuYXBwZW5kQ2hpbGQoaS5jYWxsKHQsICJyZXN0YXJ0IiwgaCkpLCAicmV3aW5kIiA9PT0gcyAmJiB1LmFwcGVuZENoaWxkKGkuY2FsbCh0LCAicmV3aW5kIiwgaCkpLCAicGxheSIgPT09IHMgJiYgdS5hcHBlbmRDaGlsZChpLmNhbGwodCwgInBsYXkiLCBoKSksICJmYXN0LWZvcndhcmQiID09PSBzICYmIHUuYXBwZW5kQ2hpbGQoaS5jYWxsKHQsICJmYXN0LWZvcndhcmQiLCBoKSksICJwcm9ncmVzcyIgPT09IHMpIHsKICAgICAgICB2YXIgbCA9IHpjKCJkaXYiLCB7CiAgICAgICAgICBjbGFzczogIiIuY29uY2F0KGguY2xhc3MsICIgcGx5cl9fcHJvZ3Jlc3NfX2NvbnRhaW5lciIpCiAgICAgICAgfSksCiAgICAgICAgICAgIGQgPSB6YygiZGl2IiwgR2ModC5jb25maWcuc2VsZWN0b3JzLnByb2dyZXNzKSk7CgogICAgICAgIGlmIChkLmFwcGVuZENoaWxkKGEuY2FsbCh0LCAic2VlayIsIHsKICAgICAgICAgIGlkOiAicGx5ci1zZWVrLSIuY29uY2F0KGUuaWQpCiAgICAgICAgfSkpLCBkLmFwcGVuZENoaWxkKHIuY2FsbCh0LCAiYnVmZmVyIikpLCB0LmNvbmZpZy50b29sdGlwcy5zZWVrKSB7CiAgICAgICAgICB2YXIgZiA9IHpjKCJzcGFuIiwgewogICAgICAgICAgICBjbGFzczogdC5jb25maWcuY2xhc3NOYW1lcy50b29sdGlwCiAgICAgICAgICB9LCAiMDA6MDAiKTsKICAgICAgICAgIGQuYXBwZW5kQ2hpbGQoZiksIHQuZWxlbWVudHMuZGlzcGxheS5zZWVrVG9vbHRpcCA9IGY7CiAgICAgICAgfQoKICAgICAgICB0LmVsZW1lbnRzLnByb2dyZXNzID0gZCwgbC5hcHBlbmRDaGlsZCh0LmVsZW1lbnRzLnByb2dyZXNzKSwgdS5hcHBlbmRDaGlsZChsKTsKICAgICAgfQoKICAgICAgaWYgKCJjdXJyZW50LXRpbWUiID09PSBzICYmIHUuYXBwZW5kQ2hpbGQoby5jYWxsKHQsICJjdXJyZW50VGltZSIsIGgpKSwgImR1cmF0aW9uIiA9PT0gcyAmJiB1LmFwcGVuZENoaWxkKG8uY2FsbCh0LCAiZHVyYXRpb24iLCBoKSksICJtdXRlIiA9PT0gcyB8fCAidm9sdW1lIiA9PT0gcykgewogICAgICAgIHZhciBwID0gdC5lbGVtZW50cy52b2x1bWU7CgogICAgICAgIGlmIChJYyhwKSAmJiB1LmNvbnRhaW5zKHApIHx8IChwID0gemMoImRpdiIsIEhjKHt9LCBoLCB7CiAgICAgICAgICBjbGFzczogIiIuY29uY2F0KGguY2xhc3MsICIgcGx5cl9fdm9sdW1lIikudHJpbSgpCiAgICAgICAgfSkpLCB0LmVsZW1lbnRzLnZvbHVtZSA9IHAsIHUuYXBwZW5kQ2hpbGQocCkpLCAibXV0ZSIgPT09IHMgJiYgcC5hcHBlbmRDaGlsZChpLmNhbGwodCwgIm11dGUiKSksICJ2b2x1bWUiID09PSBzICYmICFxYy5pc0lvcykgewogICAgICAgICAgdmFyIG0gPSB7CiAgICAgICAgICAgIG1heDogMSwKICAgICAgICAgICAgc3RlcDogLjA1LAogICAgICAgICAgICB2YWx1ZTogdC5jb25maWcudm9sdW1lCiAgICAgICAgICB9OwogICAgICAgICAgcC5hcHBlbmRDaGlsZChhLmNhbGwodCwgInZvbHVtZSIsIEhjKG0sIHsKICAgICAgICAgICAgaWQ6ICJwbHlyLXZvbHVtZS0iLmNvbmNhdChlLmlkKQogICAgICAgICAgfSkpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICgiY2FwdGlvbnMiID09PSBzICYmIHUuYXBwZW5kQ2hpbGQoaS5jYWxsKHQsICJjYXB0aW9ucyIsIGgpKSwgInNldHRpbmdzIiA9PT0gcyAmJiAhX2ModC5jb25maWcuc2V0dGluZ3MpKSB7CiAgICAgICAgdmFyIGcgPSB6YygiZGl2IiwgSGMoe30sIGgsIHsKICAgICAgICAgIGNsYXNzOiAiIi5jb25jYXQoaC5jbGFzcywgIiBwbHlyX19tZW51IikudHJpbSgpLAogICAgICAgICAgaGlkZGVuOiAiIgogICAgICAgIH0pKTsKICAgICAgICBnLmFwcGVuZENoaWxkKGkuY2FsbCh0LCAic2V0dGluZ3MiLCB7CiAgICAgICAgICAiYXJpYS1oYXNwb3B1cCI6ICEwLAogICAgICAgICAgImFyaWEtY29udHJvbHMiOiAicGx5ci1zZXR0aW5ncy0iLmNvbmNhdChlLmlkKSwKICAgICAgICAgICJhcmlhLWV4cGFuZGVkIjogITEKICAgICAgICB9KSk7CiAgICAgICAgdmFyIHYgPSB6YygiZGl2IiwgewogICAgICAgICAgY2xhc3M6ICJwbHlyX19tZW51X19jb250YWluZXIiLAogICAgICAgICAgaWQ6ICJwbHlyLXNldHRpbmdzLSIuY29uY2F0KGUuaWQpLAogICAgICAgICAgaGlkZGVuOiAiIgogICAgICAgIH0pLAogICAgICAgICAgICB5ID0gemMoImRpdiIpLAogICAgICAgICAgICBiID0gemMoImRpdiIsIHsKICAgICAgICAgIGlkOiAicGx5ci1zZXR0aW5ncy0iLmNvbmNhdChlLmlkLCAiLWhvbWUiKQogICAgICAgIH0pLAogICAgICAgICAgICB3ID0gemMoImRpdiIsIHsKICAgICAgICAgIHJvbGU6ICJtZW51IgogICAgICAgIH0pOwogICAgICAgIGIuYXBwZW5kQ2hpbGQodyksIHkuYXBwZW5kQ2hpbGQoYiksIHQuZWxlbWVudHMuc2V0dGluZ3MucGFuZWxzLmhvbWUgPSBiLCB0LmNvbmZpZy5zZXR0aW5ncy5mb3JFYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICB2YXIgciA9IHpjKCJidXR0b24iLCBIYyhHYyh0LmNvbmZpZy5zZWxlY3RvcnMuYnV0dG9ucy5zZXR0aW5ncyksIHsKICAgICAgICAgICAgdHlwZTogImJ1dHRvbiIsCiAgICAgICAgICAgIGNsYXNzOiAiIi5jb25jYXQodC5jb25maWcuY2xhc3NOYW1lcy5jb250cm9sLCAiICIpLmNvbmNhdCh0LmNvbmZpZy5jbGFzc05hbWVzLmNvbnRyb2wsICItLWZvcndhcmQiKSwKICAgICAgICAgICAgcm9sZTogIm1lbnVpdGVtIiwKICAgICAgICAgICAgImFyaWEtaGFzcG9wdXAiOiAhMCwKICAgICAgICAgICAgaGlkZGVuOiAiIgogICAgICAgICAgfSkpOwogICAgICAgICAgbi5jYWxsKHQsIHIsIGkpLCBzdS5jYWxsKHQsIHIsICJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgYy5jYWxsKHQsIGksICExKTsKICAgICAgICAgIH0pOwogICAgICAgICAgdmFyIGEgPSB6Yygic3BhbiIsIG51bGwsIHh1KGksIHQuY29uZmlnKSksCiAgICAgICAgICAgICAgbyA9IHpjKCJzcGFuIiwgewogICAgICAgICAgICBjbGFzczogdC5jb25maWcuY2xhc3NOYW1lcy5tZW51LnZhbHVlCiAgICAgICAgICB9KTsKICAgICAgICAgIG8uaW5uZXJIVE1MID0gZVtpXSwgYS5hcHBlbmRDaGlsZChvKSwgci5hcHBlbmRDaGlsZChhKSwgdy5hcHBlbmRDaGlsZChyKTsKICAgICAgICAgIHZhciBzID0gemMoImRpdiIsIHsKICAgICAgICAgICAgaWQ6ICJwbHlyLXNldHRpbmdzLSIuY29uY2F0KGUuaWQsICItIikuY29uY2F0KGkpLAogICAgICAgICAgICBoaWRkZW46ICIiCiAgICAgICAgICB9KSwKICAgICAgICAgICAgICBsID0gemMoImJ1dHRvbiIsIHsKICAgICAgICAgICAgdHlwZTogImJ1dHRvbiIsCiAgICAgICAgICAgIGNsYXNzOiAiIi5jb25jYXQodC5jb25maWcuY2xhc3NOYW1lcy5jb250cm9sLCAiICIpLmNvbmNhdCh0LmNvbmZpZy5jbGFzc05hbWVzLmNvbnRyb2wsICItLWJhY2siKQogICAgICAgICAgfSk7CiAgICAgICAgICBsLmFwcGVuZENoaWxkKHpjKCJzcGFuIiwgewogICAgICAgICAgICAiYXJpYS1oaWRkZW4iOiAhMAogICAgICAgICAgfSwgeHUoaSwgdC5jb25maWcpKSksIGwuYXBwZW5kQ2hpbGQoemMoInNwYW4iLCB7CiAgICAgICAgICAgIGNsYXNzOiB0LmNvbmZpZy5jbGFzc05hbWVzLmhpZGRlbgogICAgICAgICAgfSwgeHUoIm1lbnVCYWNrIiwgdC5jb25maWcpKSksIHN1LmNhbGwodCwgcywgImtleWRvd24iLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAzNyA9PT0gZS53aGljaCAmJiAoZS5wcmV2ZW50RGVmYXVsdCgpLCBlLnN0b3BQcm9wYWdhdGlvbigpLCBjLmNhbGwodCwgImhvbWUiLCAhMCkpOwogICAgICAgICAgfSwgITEpLCBzdS5jYWxsKHQsIGwsICJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgYy5jYWxsKHQsICJob21lIiwgITEpOwogICAgICAgICAgfSksIHMuYXBwZW5kQ2hpbGQobCksIHMuYXBwZW5kQ2hpbGQoemMoImRpdiIsIHsKICAgICAgICAgICAgcm9sZTogIm1lbnUiCiAgICAgICAgICB9KSksIHkuYXBwZW5kQ2hpbGQocyksIHQuZWxlbWVudHMuc2V0dGluZ3MuYnV0dG9uc1tpXSA9IHIsIHQuZWxlbWVudHMuc2V0dGluZ3MucGFuZWxzW2ldID0gczsKICAgICAgICB9KSwgdi5hcHBlbmRDaGlsZCh5KSwgZy5hcHBlbmRDaGlsZCh2KSwgdS5hcHBlbmRDaGlsZChnKSwgdC5lbGVtZW50cy5zZXR0aW5ncy5wb3B1cCA9IHYsIHQuZWxlbWVudHMuc2V0dGluZ3MubWVudSA9IGc7CiAgICAgIH0KCiAgICAgIGlmICgicGlwIiA9PT0gcyAmJiBydS5waXAgJiYgdS5hcHBlbmRDaGlsZChpLmNhbGwodCwgInBpcCIsIGgpKSwgImFpcnBsYXkiID09PSBzICYmIHJ1LmFpcnBsYXkgJiYgdS5hcHBlbmRDaGlsZChpLmNhbGwodCwgImFpcnBsYXkiLCBoKSksICJkb3dubG9hZCIgPT09IHMpIHsKICAgICAgICB2YXIgayA9IEhjKHt9LCBoLCB7CiAgICAgICAgICBlbGVtZW50OiAiYSIsCiAgICAgICAgICBocmVmOiB0LmRvd25sb2FkLAogICAgICAgICAgdGFyZ2V0OiAiX2JsYW5rIgogICAgICAgIH0pOwogICAgICAgIHQuaXNIVE1MNSAmJiAoay5kb3dubG9hZCA9ICIiKTsKICAgICAgICB2YXIgVCA9IHQuY29uZmlnLnVybHMuZG93bmxvYWQ7CiAgICAgICAgIVJjKFQpICYmIHQuaXNFbWJlZCAmJiBIYyhrLCB7CiAgICAgICAgICBpY29uOiAibG9nby0iLmNvbmNhdCh0LnByb3ZpZGVyKSwKICAgICAgICAgIGxhYmVsOiB0LnByb3ZpZGVyCiAgICAgICAgfSksIHUuYXBwZW5kQ2hpbGQoaS5jYWxsKHQsICJkb3dubG9hZCIsIGspKTsKICAgICAgfQoKICAgICAgImZ1bGxzY3JlZW4iID09PSBzICYmIHUuYXBwZW5kQ2hpbGQoaS5jYWxsKHQsICJmdWxsc2NyZWVuIiwgaCkpOwogICAgfSksIHRoaXMuaXNIVE1MNSAmJiBzLmNhbGwodGhpcywgeXUuZ2V0UXVhbGl0eU9wdGlvbnMuY2FsbCh0aGlzKSksIGwuY2FsbCh0aGlzKSwgdTsKICB9LAogIGluamVjdDogZnVuY3Rpb24gaW5qZWN0KCkgewogICAgdmFyIGUgPSB0aGlzOwoKICAgIGlmICh0aGlzLmNvbmZpZy5sb2FkU3ByaXRlKSB7CiAgICAgIHZhciB0ID0ganUuZ2V0SWNvblVybC5jYWxsKHRoaXMpOwogICAgICB0LmNvcnMgJiYgT3UodC51cmwsICJzcHJpdGUtcGx5ciIpOwogICAgfQoKICAgIHRoaXMuaWQgPSBNYXRoLmZsb29yKDFlNCAqIE1hdGgucmFuZG9tKCkpOwogICAgdmFyIG4gPSBudWxsOwogICAgdGhpcy5lbGVtZW50cy5jb250cm9scyA9IG51bGw7CiAgICB2YXIgaSwKICAgICAgICByLAogICAgICAgIGEgPSB7CiAgICAgIGlkOiB0aGlzLmlkLAogICAgICBzZWVrdGltZTogdGhpcy5jb25maWcuc2Vla1RpbWUsCiAgICAgIHRpdGxlOiB0aGlzLmNvbmZpZy50aXRsZQogICAgfSwKICAgICAgICBvID0gITA7CgogICAgaWYgKENjKHRoaXMuY29uZmlnLmNvbnRyb2xzKSAmJiAodGhpcy5jb25maWcuY29udHJvbHMgPSB0aGlzLmNvbmZpZy5jb250cm9scy5jYWxsKHRoaXMsIGEpKSwgdGhpcy5jb25maWcuY29udHJvbHMgfHwgKHRoaXMuY29uZmlnLmNvbnRyb2xzID0gW10pLCBJYyh0aGlzLmNvbmZpZy5jb250cm9scykgfHwgQWModGhpcy5jb25maWcuY29udHJvbHMpID8gbiA9IHRoaXMuY29uZmlnLmNvbnRyb2xzIDogKG4gPSBqdS5jcmVhdGUuY2FsbCh0aGlzLCB7CiAgICAgIGlkOiB0aGlzLmlkLAogICAgICBzZWVrdGltZTogdGhpcy5jb25maWcuc2Vla1RpbWUsCiAgICAgIHNwZWVkOiB0aGlzLnNwZWVkLAogICAgICBxdWFsaXR5OiB0aGlzLnF1YWxpdHksCiAgICAgIGNhcHRpb25zOiBEdS5nZXRMYWJlbC5jYWxsKHRoaXMpCiAgICB9KSwgbyA9ICExKSwgbyAmJiBBYyh0aGlzLmNvbmZpZy5jb250cm9scykgJiYgKGkgPSBuLCBPYmplY3QuZW50cmllcyhhKS5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgIHZhciB0ID0gcWwoZSwgMiksCiAgICAgICAgICBuID0gdFswXSwKICAgICAgICAgIHIgPSB0WzFdOwogICAgICBpID0ga3UoaSwgInsiLmNvbmNhdChuLCAifSIpLCByKTsKICAgIH0pLCBuID0gaSksIEFjKHRoaXMuY29uZmlnLnNlbGVjdG9ycy5jb250cm9scy5jb250YWluZXIpICYmIChyID0gZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0aGlzLmNvbmZpZy5zZWxlY3RvcnMuY29udHJvbHMuY29udGFpbmVyKSksIEljKHIpIHx8IChyID0gdGhpcy5lbGVtZW50cy5jb250YWluZXIpLCByW0ljKG4pID8gImluc2VydEFkamFjZW50RWxlbWVudCIgOiAiaW5zZXJ0QWRqYWNlbnRIVE1MIl0oImFmdGVyYmVnaW4iLCBuKSwgSWModGhpcy5lbGVtZW50cy5jb250cm9scykgfHwganUuZmluZEVsZW1lbnRzLmNhbGwodGhpcyksICFfYyh0aGlzLmVsZW1lbnRzLmJ1dHRvbnMpKSB7CiAgICAgIHZhciBzID0gZnVuY3Rpb24gcyh0KSB7CiAgICAgICAgdmFyIG4gPSBlLmNvbmZpZy5jbGFzc05hbWVzLmNvbnRyb2xQcmVzc2VkOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0LCAicHJlc3NlZCIsIHsKICAgICAgICAgIGVudW1lcmFibGU6ICEwLAogICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgIHJldHVybiBKYyh0LCBuKTsKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldCgpIHsKICAgICAgICAgICAgdmFyIGUgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1swXSAmJiBhcmd1bWVudHNbMF07CiAgICAgICAgICAgIFFjKHQsIG4sIGUpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgT2JqZWN0LnZhbHVlcyh0aGlzLmVsZW1lbnRzLmJ1dHRvbnMpLmZpbHRlcihCb29sZWFuKS5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgUGMoZSkgfHwgT2MoZSkgPyBBcnJheS5mcm9tKGUpLmZpbHRlcihCb29sZWFuKS5mb3JFYWNoKHMpIDogcyhlKTsKICAgICAgfSk7CiAgICB9CgogICAgaWYgKHFjLmlzRWRnZSAmJiBGYyhyKSwgdGhpcy5jb25maWcudG9vbHRpcHMuY29udHJvbHMpIHsKICAgICAgdmFyIGwgPSB0aGlzLmNvbmZpZywKICAgICAgICAgIGMgPSBsLmNsYXNzTmFtZXMsCiAgICAgICAgICB1ID0gbC5zZWxlY3RvcnMsCiAgICAgICAgICBoID0gIiIuY29uY2F0KHUuY29udHJvbHMud3JhcHBlciwgIiAiKS5jb25jYXQodS5sYWJlbHMsICIgLiIpLmNvbmNhdChjLmhpZGRlbiksCiAgICAgICAgICBkID0gZXUuY2FsbCh0aGlzLCBoKTsKICAgICAgQXJyYXkuZnJvbShkKS5mb3JFYWNoKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgUWModCwgZS5jb25maWcuY2xhc3NOYW1lcy5oaWRkZW4sICExKSwgUWModCwgZS5jb25maWcuY2xhc3NOYW1lcy50b29sdGlwLCAhMCk7CiAgICAgIH0pOwogICAgfQogIH0KfTsKCmZ1bmN0aW9uIFJ1KGUpIHsKICB2YXIgdCA9ICEoYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbMV0pIHx8IGFyZ3VtZW50c1sxXSwKICAgICAgbiA9IGU7CgogIGlmICh0KSB7CiAgICB2YXIgaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgIGkuaHJlZiA9IG4sIG4gPSBpLmhyZWY7CiAgfQoKICB0cnkgewogICAgcmV0dXJuIG5ldyBVUkwobik7CiAgfSBjYXRjaCAoZSkgewogICAgcmV0dXJuIG51bGw7CiAgfQp9CgpmdW5jdGlvbiBfdShlKSB7CiAgdmFyIHQgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKCk7CiAgcmV0dXJuIFNjKGUpICYmIE9iamVjdC5lbnRyaWVzKGUpLmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgIHZhciBuID0gcWwoZSwgMiksCiAgICAgICAgaSA9IG5bMF0sCiAgICAgICAgciA9IG5bMV07CiAgICB0LnNldChpLCByKTsKICB9KSwgdDsKfQoKdmFyIER1ID0gewogIHNldHVwOiBmdW5jdGlvbiBzZXR1cCgpIHsKICAgIGlmICh0aGlzLnN1cHBvcnRlZC51aSkgaWYgKCF0aGlzLmlzVmlkZW8gfHwgdGhpcy5pc1lvdVR1YmUgfHwgdGhpcy5pc0hUTUw1ICYmICFydS50ZXh0VHJhY2tzKSBQYyh0aGlzLmNvbmZpZy5jb250cm9scykgJiYgdGhpcy5jb25maWcuY29udHJvbHMuaW5jbHVkZXMoInNldHRpbmdzIikgJiYgdGhpcy5jb25maWcuc2V0dGluZ3MuaW5jbHVkZXMoImNhcHRpb25zIikgJiYganUuc2V0Q2FwdGlvbnNNZW51LmNhbGwodGhpcyk7ZWxzZSB7CiAgICAgIGlmIChJYyh0aGlzLmVsZW1lbnRzLmNhcHRpb25zKSB8fCAodGhpcy5lbGVtZW50cy5jYXB0aW9ucyA9IHpjKCJkaXYiLCBHYyh0aGlzLmNvbmZpZy5zZWxlY3RvcnMuY2FwdGlvbnMpKSwgZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICBJYyhlKSAmJiBJYyh0KSAmJiB0LnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKGUsIHQubmV4dFNpYmxpbmcpOwogICAgICB9KHRoaXMuZWxlbWVudHMuY2FwdGlvbnMsIHRoaXMuZWxlbWVudHMud3JhcHBlcikpLCBxYy5pc0lFICYmIHdpbmRvdy5VUkwpIHsKICAgICAgICB2YXIgZSA9IHRoaXMubWVkaWEucXVlcnlTZWxlY3RvckFsbCgidHJhY2siKTsKICAgICAgICBBcnJheS5mcm9tKGUpLmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIHZhciB0ID0gZS5nZXRBdHRyaWJ1dGUoInNyYyIpLAogICAgICAgICAgICAgIG4gPSBSdSh0KTsKICAgICAgICAgIG51bGwgIT09IG4gJiYgbi5ob3N0bmFtZSAhPT0gd2luZG93LmxvY2F0aW9uLmhyZWYuaG9zdG5hbWUgJiYgWyJodHRwOiIsICJodHRwczoiXS5pbmNsdWRlcyhuLnByb3RvY29sKSAmJiBQdSh0LCAiYmxvYiIpLnRoZW4oZnVuY3Rpb24gKHQpIHsKICAgICAgICAgICAgZS5zZXRBdHRyaWJ1dGUoInNyYyIsIHdpbmRvdy5VUkwuY3JlYXRlT2JqZWN0VVJMKHQpKTsKICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgJGMoZSk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdmFyIHQgPSBidSgobmF2aWdhdG9yLmxhbmd1YWdlcyB8fCBbbmF2aWdhdG9yLmxhbmd1YWdlIHx8IG5hdmlnYXRvci51c2VyTGFuZ3VhZ2UgfHwgImVuIl0pLm1hcChmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiBlLnNwbGl0KCItIilbMF07CiAgICAgIH0pKSwKICAgICAgICAgIG4gPSAodGhpcy5zdG9yYWdlLmdldCgibGFuZ3VhZ2UiKSB8fCB0aGlzLmNvbmZpZy5jYXB0aW9ucy5sYW5ndWFnZSB8fCAiYXV0byIpLnRvTG93ZXJDYXNlKCk7CiAgICAgICJhdXRvIiA9PT0gbiAmJiAobiA9IHFsKHQsIDEpWzBdKTsKICAgICAgdmFyIGkgPSB0aGlzLnN0b3JhZ2UuZ2V0KCJjYXB0aW9ucyIpOwoKICAgICAgaWYgKHhjKGkpIHx8IChpID0gdGhpcy5jb25maWcuY2FwdGlvbnMuYWN0aXZlKSwgT2JqZWN0LmFzc2lnbih0aGlzLmNhcHRpb25zLCB7CiAgICAgICAgdG9nZ2xlZDogITEsCiAgICAgICAgYWN0aXZlOiBpLAogICAgICAgIGxhbmd1YWdlOiBuLAogICAgICAgIGxhbmd1YWdlczogdAogICAgICB9KSwgdGhpcy5pc0hUTUw1KSB7CiAgICAgICAgdmFyIHIgPSB0aGlzLmNvbmZpZy5jYXB0aW9ucy51cGRhdGUgPyAiYWRkdHJhY2sgcmVtb3ZldHJhY2siIDogInJlbW92ZXRyYWNrIjsKICAgICAgICBzdS5jYWxsKHRoaXMsIHRoaXMubWVkaWEudGV4dFRyYWNrcywgciwgRHUudXBkYXRlLmJpbmQodGhpcykpOwogICAgICB9CgogICAgICBzZXRUaW1lb3V0KER1LnVwZGF0ZS5iaW5kKHRoaXMpLCAwKTsKICAgIH0KICB9LAogIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIHQgPSBEdS5nZXRUcmFja3MuY2FsbCh0aGlzLCAhMCksCiAgICAgICAgbiA9IHRoaXMuY2FwdGlvbnMsCiAgICAgICAgaSA9IG4uYWN0aXZlLAogICAgICAgIHIgPSBuLmxhbmd1YWdlLAogICAgICAgIGEgPSBuLm1ldGEsCiAgICAgICAgbyA9IG4uY3VycmVudFRyYWNrTm9kZSwKICAgICAgICBzID0gQm9vbGVhbih0LmZpbmQoZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIGUubGFuZ3VhZ2UgPT09IHI7CiAgICB9KSk7CiAgICB0aGlzLmlzSFRNTDUgJiYgdGhpcy5pc1ZpZGVvICYmIHQuZmlsdGVyKGZ1bmN0aW9uIChlKSB7CiAgICAgIHJldHVybiAhYS5nZXQoZSk7CiAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uICh0KSB7CiAgICAgIGUuZGVidWcubG9nKCJUcmFjayBhZGRlZCIsIHQpLCBhLnNldCh0LCB7CiAgICAgICAgZGVmYXVsdDogInNob3dpbmciID09PSB0Lm1vZGUKICAgICAgfSksICJzaG93aW5nIiA9PT0gdC5tb2RlICYmICh0Lm1vZGUgPSAiaGlkZGVuIiksIHN1LmNhbGwoZSwgdCwgImN1ZWNoYW5nZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gRHUudXBkYXRlQ3Vlcy5jYWxsKGUpOwogICAgICB9KTsKICAgIH0pLCAocyAmJiB0aGlzLmxhbmd1YWdlICE9PSByIHx8ICF0LmluY2x1ZGVzKG8pKSAmJiAoRHUuc2V0TGFuZ3VhZ2UuY2FsbCh0aGlzLCByKSwgRHUudG9nZ2xlLmNhbGwodGhpcywgaSAmJiBzKSksIFFjKHRoaXMuZWxlbWVudHMuY29udGFpbmVyLCB0aGlzLmNvbmZpZy5jbGFzc05hbWVzLmNhcHRpb25zLmVuYWJsZWQsICFfYyh0KSksIFBjKHRoaXMuY29uZmlnLmNvbnRyb2xzKSAmJiB0aGlzLmNvbmZpZy5jb250cm9scy5pbmNsdWRlcygic2V0dGluZ3MiKSAmJiB0aGlzLmNvbmZpZy5zZXR0aW5ncy5pbmNsdWRlcygiY2FwdGlvbnMiKSAmJiBqdS5zZXRDYXB0aW9uc01lbnUuY2FsbCh0aGlzKTsKICB9LAogIHRvZ2dsZTogZnVuY3Rpb24gdG9nZ2xlKGUpIHsKICAgIHZhciB0ID0gdGhpcywKICAgICAgICBuID0gIShhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSkgfHwgYXJndW1lbnRzWzFdOwoKICAgIGlmICh0aGlzLnN1cHBvcnRlZC51aSkgewogICAgICB2YXIgaSA9IHRoaXMuY2FwdGlvbnMudG9nZ2xlZCwKICAgICAgICAgIHIgPSB0aGlzLmNvbmZpZy5jbGFzc05hbWVzLmNhcHRpb25zLmFjdGl2ZSwKICAgICAgICAgIGEgPSBUYyhlKSA/ICFpIDogZTsKCiAgICAgIGlmIChhICE9PSBpKSB7CiAgICAgICAgaWYgKG4gfHwgKHRoaXMuY2FwdGlvbnMuYWN0aXZlID0gYSwgdGhpcy5zdG9yYWdlLnNldCh7CiAgICAgICAgICBjYXB0aW9uczogYQogICAgICAgIH0pKSwgIXRoaXMubGFuZ3VhZ2UgJiYgYSAmJiAhbikgewogICAgICAgICAgdmFyIG8gPSBEdS5nZXRUcmFja3MuY2FsbCh0aGlzKSwKICAgICAgICAgICAgICBzID0gRHUuZmluZFRyYWNrLmNhbGwodGhpcywgW3RoaXMuY2FwdGlvbnMubGFuZ3VhZ2VdLmNvbmNhdChVbCh0aGlzLmNhcHRpb25zLmxhbmd1YWdlcykpLCAhMCk7CiAgICAgICAgICByZXR1cm4gdGhpcy5jYXB0aW9ucy5sYW5ndWFnZSA9IHMubGFuZ3VhZ2UsIHZvaWQgRHUuc2V0LmNhbGwodGhpcywgby5pbmRleE9mKHMpKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZWxlbWVudHMuYnV0dG9ucy5jYXB0aW9ucyAmJiAodGhpcy5lbGVtZW50cy5idXR0b25zLmNhcHRpb25zLnByZXNzZWQgPSBhKSwgUWModGhpcy5lbGVtZW50cy5jb250YWluZXIsIHIsIGEpLCB0aGlzLmNhcHRpb25zLnRvZ2dsZWQgPSBhLCBqdS51cGRhdGVTZXR0aW5nLmNhbGwodGhpcywgImNhcHRpb25zIiksIHV1LmNhbGwodGhpcywgdGhpcy5tZWRpYSwgYSA/ICJjYXB0aW9uc2VuYWJsZWQiIDogImNhcHRpb25zZGlzYWJsZWQiKTsKICAgICAgfQoKICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgYSAmJiB0LmNhcHRpb25zLnRvZ2dsZWQgJiYgKHQuY2FwdGlvbnMuY3VycmVudFRyYWNrTm9kZS5tb2RlID0gImhpZGRlbiIpOwogICAgICB9KTsKICAgIH0KICB9LAogIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgIHZhciB0ID0gIShhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSkgfHwgYXJndW1lbnRzWzFdLAogICAgICAgIG4gPSBEdS5nZXRUcmFja3MuY2FsbCh0aGlzKTsKICAgIGlmICgtMSAhPT0gZSkgewogICAgICBpZiAoRWMoZSkpIHsKICAgICAgICBpZiAoZSBpbiBuKSB7CiAgICAgICAgICBpZiAodGhpcy5jYXB0aW9ucy5jdXJyZW50VHJhY2sgIT09IGUpIHsKICAgICAgICAgICAgdGhpcy5jYXB0aW9ucy5jdXJyZW50VHJhY2sgPSBlOwogICAgICAgICAgICB2YXIgaSA9IG5bZV0sCiAgICAgICAgICAgICAgICByID0gaSB8fCB7fSwKICAgICAgICAgICAgICAgIGEgPSByLmxhbmd1YWdlOwogICAgICAgICAgICB0aGlzLmNhcHRpb25zLmN1cnJlbnRUcmFja05vZGUgPSBpLCBqdS51cGRhdGVTZXR0aW5nLmNhbGwodGhpcywgImNhcHRpb25zIiksIHQgfHwgKHRoaXMuY2FwdGlvbnMubGFuZ3VhZ2UgPSBhLCB0aGlzLnN0b3JhZ2Uuc2V0KHsKICAgICAgICAgICAgICBsYW5ndWFnZTogYQogICAgICAgICAgICB9KSksIHRoaXMuaXNWaW1lbyAmJiB0aGlzLmVtYmVkLmVuYWJsZVRleHRUcmFjayhhKSwgdXUuY2FsbCh0aGlzLCB0aGlzLm1lZGlhLCAibGFuZ3VhZ2VjaGFuZ2UiKTsKICAgICAgICAgIH0KCiAgICAgICAgICBEdS50b2dnbGUuY2FsbCh0aGlzLCAhMCwgdCksIHRoaXMuaXNIVE1MNSAmJiB0aGlzLmlzVmlkZW8gJiYgRHUudXBkYXRlQ3Vlcy5jYWxsKHRoaXMpOwogICAgICAgIH0gZWxzZSB0aGlzLmRlYnVnLndhcm4oIlRyYWNrIG5vdCBmb3VuZCIsIGUpOwogICAgICB9IGVsc2UgdGhpcy5kZWJ1Zy53YXJuKCJJbnZhbGlkIGNhcHRpb24gYXJndW1lbnQiLCBlKTsKICAgIH0gZWxzZSBEdS50b2dnbGUuY2FsbCh0aGlzLCAhMSwgdCk7CiAgfSwKICBzZXRMYW5ndWFnZTogZnVuY3Rpb24gc2V0TGFuZ3VhZ2UoZSkgewogICAgdmFyIHQgPSAhKGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzFdKSB8fCBhcmd1bWVudHNbMV07CgogICAgaWYgKEFjKGUpKSB7CiAgICAgIHZhciBuID0gZS50b0xvd2VyQ2FzZSgpOwogICAgICB0aGlzLmNhcHRpb25zLmxhbmd1YWdlID0gbjsKICAgICAgdmFyIGkgPSBEdS5nZXRUcmFja3MuY2FsbCh0aGlzKSwKICAgICAgICAgIHIgPSBEdS5maW5kVHJhY2suY2FsbCh0aGlzLCBbbl0pOwogICAgICBEdS5zZXQuY2FsbCh0aGlzLCBpLmluZGV4T2YociksIHQpOwogICAgfSBlbHNlIHRoaXMuZGVidWcud2FybigiSW52YWxpZCBsYW5ndWFnZSBhcmd1bWVudCIsIGUpOwogIH0sCiAgZ2V0VHJhY2tzOiBmdW5jdGlvbiBnZXRUcmFja3MoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdICYmIGFyZ3VtZW50c1swXSwKICAgICAgICBuID0gQXJyYXkuZnJvbSgodGhpcy5tZWRpYSB8fCB7fSkudGV4dFRyYWNrcyB8fCBbXSk7CiAgICByZXR1cm4gbi5maWx0ZXIoZnVuY3Rpb24gKG4pIHsKICAgICAgcmV0dXJuICFlLmlzSFRNTDUgfHwgdCB8fCBlLmNhcHRpb25zLm1ldGEuaGFzKG4pOwogICAgfSkuZmlsdGVyKGZ1bmN0aW9uIChlKSB7CiAgICAgIHJldHVybiBbImNhcHRpb25zIiwgInN1YnRpdGxlcyJdLmluY2x1ZGVzKGUua2luZCk7CiAgICB9KTsKICB9LAogIGZpbmRUcmFjazogZnVuY3Rpb24gZmluZFRyYWNrKGUpIHsKICAgIHZhciB0LAogICAgICAgIG4gPSB0aGlzLAogICAgICAgIGkgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSAmJiBhcmd1bWVudHNbMV0sCiAgICAgICAgciA9IER1LmdldFRyYWNrcy5jYWxsKHRoaXMpLAogICAgICAgIGEgPSBmdW5jdGlvbiBhKGUpIHsKICAgICAgcmV0dXJuIE51bWJlcigobi5jYXB0aW9ucy5tZXRhLmdldChlKSB8fCB7fSkuZGVmYXVsdCk7CiAgICB9LAogICAgICAgIG8gPSBBcnJheS5mcm9tKHIpLnNvcnQoZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgcmV0dXJuIGEodCkgLSBhKGUpOwogICAgfSk7CgogICAgcmV0dXJuIGUuZXZlcnkoZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuICEodCA9IG8uZmluZChmdW5jdGlvbiAodCkgewogICAgICAgIHJldHVybiB0Lmxhbmd1YWdlID09PSBlOwogICAgICB9KSk7CiAgICB9KSwgdCB8fCAoaSA/IG9bMF0gOiB2b2lkIDApOwogIH0sCiAgZ2V0Q3VycmVudFRyYWNrOiBmdW5jdGlvbiBnZXRDdXJyZW50VHJhY2soKSB7CiAgICByZXR1cm4gRHUuZ2V0VHJhY2tzLmNhbGwodGhpcylbdGhpcy5jdXJyZW50VHJhY2tdOwogIH0sCiAgZ2V0TGFiZWw6IGZ1bmN0aW9uIGdldExhYmVsKGUpIHsKICAgIHZhciB0ID0gZTsKICAgIHJldHVybiAhTWModCkgJiYgcnUudGV4dFRyYWNrcyAmJiB0aGlzLmNhcHRpb25zLnRvZ2dsZWQgJiYgKHQgPSBEdS5nZXRDdXJyZW50VHJhY2suY2FsbCh0aGlzKSksIE1jKHQpID8gX2ModC5sYWJlbCkgPyBfYyh0Lmxhbmd1YWdlKSA/IHh1KCJlbmFibGVkIiwgdGhpcy5jb25maWcpIDogZS5sYW5ndWFnZS50b1VwcGVyQ2FzZSgpIDogdC5sYWJlbCA6IHh1KCJkaXNhYmxlZCIsIHRoaXMuY29uZmlnKTsKICB9LAogIHVwZGF0ZUN1ZXM6IGZ1bmN0aW9uIHVwZGF0ZUN1ZXMoZSkgewogICAgaWYgKHRoaXMuc3VwcG9ydGVkLnVpKSBpZiAoSWModGhpcy5lbGVtZW50cy5jYXB0aW9ucykpIHsKICAgICAgaWYgKFRjKGUpIHx8IEFycmF5LmlzQXJyYXkoZSkpIHsKICAgICAgICB2YXIgdCA9IGU7CgogICAgICAgIGlmICghdCkgewogICAgICAgICAgdmFyIG4gPSBEdS5nZXRDdXJyZW50VHJhY2suY2FsbCh0aGlzKTsKICAgICAgICAgIHQgPSBBcnJheS5mcm9tKChuIHx8IHt9KS5hY3RpdmVDdWVzIHx8IFtdKS5tYXAoZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgcmV0dXJuIGUuZ2V0Q3VlQXNIVE1MKCk7CiAgICAgICAgICB9KS5tYXAoRXUpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGkgPSB0Lm1hcChmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmV0dXJuIGUudHJpbSgpOwogICAgICAgIH0pLmpvaW4oIlxuIik7CgogICAgICAgIGlmIChpICE9PSB0aGlzLmVsZW1lbnRzLmNhcHRpb25zLmlubmVySFRNTCkgewogICAgICAgICAgS2ModGhpcy5lbGVtZW50cy5jYXB0aW9ucyk7CiAgICAgICAgICB2YXIgciA9IHpjKCJzcGFuIiwgR2ModGhpcy5jb25maWcuc2VsZWN0b3JzLmNhcHRpb24pKTsKICAgICAgICAgIHIuaW5uZXJIVE1MID0gaSwgdGhpcy5lbGVtZW50cy5jYXB0aW9ucy5hcHBlbmRDaGlsZChyKSwgdXUuY2FsbCh0aGlzLCB0aGlzLm1lZGlhLCAiY3VlY2hhbmdlIik7CiAgICAgICAgfQogICAgICB9IGVsc2UgdGhpcy5kZWJ1Zy53YXJuKCJ1cGRhdGVDdWVzOiBJbnZhbGlkIGlucHV0IiwgZSk7CiAgICB9IGVsc2UgdGhpcy5kZWJ1Zy53YXJuKCJObyBjYXB0aW9ucyBlbGVtZW50IHRvIHJlbmRlciB0byIpOwogIH0KfSwKICAgIEZ1ID0gewogIGVuYWJsZWQ6ICEwLAogIHRpdGxlOiAiIiwKICBkZWJ1ZzogITEsCiAgYXV0b3BsYXk6ICExLAogIGF1dG9wYXVzZTogITAsCiAgcGxheXNpbmxpbmU6ICEwLAogIHNlZWtUaW1lOiAxMCwKICB2b2x1bWU6IDEsCiAgbXV0ZWQ6ICExLAogIGR1cmF0aW9uOiBudWxsLAogIGRpc3BsYXlEdXJhdGlvbjogITAsCiAgaW52ZXJ0VGltZTogITAsCiAgdG9nZ2xlSW52ZXJ0OiAhMCwKICByYXRpbzogbnVsbCwKICBjbGlja1RvUGxheTogITAsCiAgaGlkZUNvbnRyb2xzOiAhMCwKICByZXNldE9uRW5kOiAhMSwKICBkaXNhYmxlQ29udGV4dE1lbnU6ICEwLAogIGxvYWRTcHJpdGU6ICEwLAogIGljb25QcmVmaXg6ICJwbHlyIiwKICBpY29uVXJsOiAiaHR0cHM6Ly9jZG4ucGx5ci5pby8zLjYuMS9wbHlyLnN2ZyIsCiAgYmxhbmtWaWRlbzogImh0dHBzOi8vY2RuLnBseXIuaW8vc3RhdGljL2JsYW5rLm1wNCIsCiAgcXVhbGl0eTogewogICAgZGVmYXVsdDogNTc2LAogICAgb3B0aW9uczogWzQzMjAsIDI4ODAsIDIxNjAsIDE0NDAsIDEwODAsIDcyMCwgNTc2LCA0ODAsIDM2MCwgMjQwXSwKICAgIGZvcmNlZDogITEsCiAgICBvbkNoYW5nZTogbnVsbAogIH0sCiAgbG9vcDogewogICAgYWN0aXZlOiAhMQogIH0sCiAgc3BlZWQ6IHsKICAgIHNlbGVjdGVkOiAxLAogICAgb3B0aW9uczogWy41LCAuNzUsIDEsIDEuMjUsIDEuNSwgMS43NSwgMiwgNF0KICB9LAogIGtleWJvYXJkOiB7CiAgICBmb2N1c2VkOiAhMCwKICAgIGdsb2JhbDogITEKICB9LAogIHRvb2x0aXBzOiB7CiAgICBjb250cm9sczogITEsCiAgICBzZWVrOiAhMAogIH0sCiAgY2FwdGlvbnM6IHsKICAgIGFjdGl2ZTogITEsCiAgICBsYW5ndWFnZTogImF1dG8iLAogICAgdXBkYXRlOiAhMQogIH0sCiAgZnVsbHNjcmVlbjogewogICAgZW5hYmxlZDogITAsCiAgICBmYWxsYmFjazogITAsCiAgICBpb3NOYXRpdmU6ICExCiAgfSwKICBzdG9yYWdlOiB7CiAgICBlbmFibGVkOiAhMCwKICAgIGtleTogInBseXIiCiAgfSwKICBjb250cm9sczogWyJwbGF5LWxhcmdlIiwgInBsYXkiLCAicHJvZ3Jlc3MiLCAiY3VycmVudC10aW1lIiwgIm11dGUiLCAidm9sdW1lIiwgImNhcHRpb25zIiwgInNldHRpbmdzIiwgInBpcCIsICJhaXJwbGF5IiwgImZ1bGxzY3JlZW4iXSwKICBzZXR0aW5nczogWyJjYXB0aW9ucyIsICJxdWFsaXR5IiwgInNwZWVkIl0sCiAgaTE4bjogewogICAgcmVzdGFydDogIlJlc3RhcnQiLAogICAgcmV3aW5kOiAiUmV3aW5kIHtzZWVrdGltZX1zIiwKICAgIHBsYXk6ICJQbGF5IiwKICAgIHBhdXNlOiAiUGF1c2UiLAogICAgZmFzdEZvcndhcmQ6ICJGb3J3YXJkIHtzZWVrdGltZX1zIiwKICAgIHNlZWs6ICJTZWVrIiwKICAgIHNlZWtMYWJlbDogIntjdXJyZW50VGltZX0gb2Yge2R1cmF0aW9ufSIsCiAgICBwbGF5ZWQ6ICJQbGF5ZWQiLAogICAgYnVmZmVyZWQ6ICJCdWZmZXJlZCIsCiAgICBjdXJyZW50VGltZTogIkN1cnJlbnQgdGltZSIsCiAgICBkdXJhdGlvbjogIkR1cmF0aW9uIiwKICAgIHZvbHVtZTogIlZvbHVtZSIsCiAgICBtdXRlOiAiTXV0ZSIsCiAgICB1bm11dGU6ICJVbm11dGUiLAogICAgZW5hYmxlQ2FwdGlvbnM6ICJFbmFibGUgY2FwdGlvbnMiLAogICAgZGlzYWJsZUNhcHRpb25zOiAiRGlzYWJsZSBjYXB0aW9ucyIsCiAgICBkb3dubG9hZDogIkRvd25sb2FkIiwKICAgIGVudGVyRnVsbHNjcmVlbjogIkVudGVyIGZ1bGxzY3JlZW4iLAogICAgZXhpdEZ1bGxzY3JlZW46ICJFeGl0IGZ1bGxzY3JlZW4iLAogICAgZnJhbWVUaXRsZTogIlBsYXllciBmb3Ige3RpdGxlfSIsCiAgICBjYXB0aW9uczogIkNhcHRpb25zIiwKICAgIHNldHRpbmdzOiAiU2V0dGluZ3MiLAogICAgcGlwOiAiUElQIiwKICAgIG1lbnVCYWNrOiAiR28gYmFjayB0byBwcmV2aW91cyBtZW51IiwKICAgIHNwZWVkOiAiU3BlZWQiLAogICAgbm9ybWFsOiAiTm9ybWFsIiwKICAgIHF1YWxpdHk6ICJRdWFsaXR5IiwKICAgIGxvb3A6ICJMb29wIiwKICAgIHN0YXJ0OiAiU3RhcnQiLAogICAgZW5kOiAiRW5kIiwKICAgIGFsbDogIkFsbCIsCiAgICByZXNldDogIlJlc2V0IiwKICAgIGRpc2FibGVkOiAiRGlzYWJsZWQiLAogICAgZW5hYmxlZDogIkVuYWJsZWQiLAogICAgYWR2ZXJ0aXNlbWVudDogIkFkIiwKICAgIHF1YWxpdHlCYWRnZTogewogICAgICAyMTYwOiAiNEsiLAogICAgICAxNDQwOiAiSEQiLAogICAgICAxMDgwOiAiSEQiLAogICAgICA3MjA6ICJIRCIsCiAgICAgIDU3NjogIlNEIiwKICAgICAgNDgwOiAiU0QiCiAgICB9CiAgfSwKICB1cmxzOiB7CiAgICBkb3dubG9hZDogbnVsbCwKICAgIHZpbWVvOiB7CiAgICAgIHNkazogImh0dHBzOi8vcGxheWVyLnZpbWVvLmNvbS9hcGkvcGxheWVyLmpzIiwKICAgICAgaWZyYW1lOiAiaHR0cHM6Ly9wbGF5ZXIudmltZW8uY29tL3ZpZGVvL3swfT97MX0iLAogICAgICBhcGk6ICJodHRwczovL3ZpbWVvLmNvbS9hcGkvdjIvdmlkZW8vezB9Lmpzb24iCiAgICB9LAogICAgeW91dHViZTogewogICAgICBzZGs6ICJodHRwczovL3d3dy55b3V0dWJlLmNvbS9pZnJhbWVfYXBpIiwKICAgICAgYXBpOiAiaHR0cHM6Ly9ub2VtYmVkLmNvbS9lbWJlZD91cmw9aHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj17MH0iCiAgICB9LAogICAgZ29vZ2xlSU1BOiB7CiAgICAgIHNkazogImh0dHBzOi8vaW1hc2RrLmdvb2dsZWFwaXMuY29tL2pzL3Nka2xvYWRlci9pbWEzLmpzIgogICAgfQogIH0sCiAgbGlzdGVuZXJzOiB7CiAgICBzZWVrOiBudWxsLAogICAgcGxheTogbnVsbCwKICAgIHBhdXNlOiBudWxsLAogICAgcmVzdGFydDogbnVsbCwKICAgIHJld2luZDogbnVsbCwKICAgIGZhc3RGb3J3YXJkOiBudWxsLAogICAgbXV0ZTogbnVsbCwKICAgIHZvbHVtZTogbnVsbCwKICAgIGNhcHRpb25zOiBudWxsLAogICAgZG93bmxvYWQ6IG51bGwsCiAgICBmdWxsc2NyZWVuOiBudWxsLAogICAgcGlwOiBudWxsLAogICAgYWlycGxheTogbnVsbCwKICAgIHNwZWVkOiBudWxsLAogICAgcXVhbGl0eTogbnVsbCwKICAgIGxvb3A6IG51bGwsCiAgICBsYW5ndWFnZTogbnVsbAogIH0sCiAgZXZlbnRzOiBbImVuZGVkIiwgInByb2dyZXNzIiwgInN0YWxsZWQiLCAicGxheWluZyIsICJ3YWl0aW5nIiwgImNhbnBsYXkiLCAiY2FucGxheXRocm91Z2giLCAibG9hZHN0YXJ0IiwgImxvYWRlZGRhdGEiLCAibG9hZGVkbWV0YWRhdGEiLCAidGltZXVwZGF0ZSIsICJ2b2x1bWVjaGFuZ2UiLCAicGxheSIsICJwYXVzZSIsICJlcnJvciIsICJzZWVraW5nIiwgInNlZWtlZCIsICJlbXB0aWVkIiwgInJhdGVjaGFuZ2UiLCAiY3VlY2hhbmdlIiwgImRvd25sb2FkIiwgImVudGVyZnVsbHNjcmVlbiIsICJleGl0ZnVsbHNjcmVlbiIsICJjYXB0aW9uc2VuYWJsZWQiLCAiY2FwdGlvbnNkaXNhYmxlZCIsICJsYW5ndWFnZWNoYW5nZSIsICJjb250cm9sc2hpZGRlbiIsICJjb250cm9sc3Nob3duIiwgInJlYWR5IiwgInN0YXRlY2hhbmdlIiwgInF1YWxpdHljaGFuZ2UiLCAiYWRzbG9hZGVkIiwgImFkc2NvbnRlbnRwYXVzZSIsICJhZHNjb250ZW50cmVzdW1lIiwgImFkc3RhcnRlZCIsICJhZHNtaWRwb2ludCIsICJhZHNjb21wbGV0ZSIsICJhZHNhbGxjb21wbGV0ZSIsICJhZHNpbXByZXNzaW9uIiwgImFkc2NsaWNrIl0sCiAgc2VsZWN0b3JzOiB7CiAgICBlZGl0YWJsZTogImlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0LCBbY29udGVudGVkaXRhYmxlXSIsCiAgICBjb250YWluZXI6ICIucGx5ciIsCiAgICBjb250cm9sczogewogICAgICBjb250YWluZXI6IG51bGwsCiAgICAgIHdyYXBwZXI6ICIucGx5cl9fY29udHJvbHMiCiAgICB9LAogICAgbGFiZWxzOiAiW2RhdGEtcGx5cl0iLAogICAgYnV0dG9uczogewogICAgICBwbGF5OiAnW2RhdGEtcGx5cj0icGxheSJdJywKICAgICAgcGF1c2U6ICdbZGF0YS1wbHlyPSJwYXVzZSJdJywKICAgICAgcmVzdGFydDogJ1tkYXRhLXBseXI9InJlc3RhcnQiXScsCiAgICAgIHJld2luZDogJ1tkYXRhLXBseXI9InJld2luZCJdJywKICAgICAgZmFzdEZvcndhcmQ6ICdbZGF0YS1wbHlyPSJmYXN0LWZvcndhcmQiXScsCiAgICAgIG11dGU6ICdbZGF0YS1wbHlyPSJtdXRlIl0nLAogICAgICBjYXB0aW9uczogJ1tkYXRhLXBseXI9ImNhcHRpb25zIl0nLAogICAgICBkb3dubG9hZDogJ1tkYXRhLXBseXI9ImRvd25sb2FkIl0nLAogICAgICBmdWxsc2NyZWVuOiAnW2RhdGEtcGx5cj0iZnVsbHNjcmVlbiJdJywKICAgICAgcGlwOiAnW2RhdGEtcGx5cj0icGlwIl0nLAogICAgICBhaXJwbGF5OiAnW2RhdGEtcGx5cj0iYWlycGxheSJdJywKICAgICAgc2V0dGluZ3M6ICdbZGF0YS1wbHlyPSJzZXR0aW5ncyJdJywKICAgICAgbG9vcDogJ1tkYXRhLXBseXI9Imxvb3AiXScKICAgIH0sCiAgICBpbnB1dHM6IHsKICAgICAgc2VlazogJ1tkYXRhLXBseXI9InNlZWsiXScsCiAgICAgIHZvbHVtZTogJ1tkYXRhLXBseXI9InZvbHVtZSJdJywKICAgICAgc3BlZWQ6ICdbZGF0YS1wbHlyPSJzcGVlZCJdJywKICAgICAgbGFuZ3VhZ2U6ICdbZGF0YS1wbHlyPSJsYW5ndWFnZSJdJywKICAgICAgcXVhbGl0eTogJ1tkYXRhLXBseXI9InF1YWxpdHkiXScKICAgIH0sCiAgICBkaXNwbGF5OiB7CiAgICAgIGN1cnJlbnRUaW1lOiAiLnBseXJfX3RpbWUtLWN1cnJlbnQiLAogICAgICBkdXJhdGlvbjogIi5wbHlyX190aW1lLS1kdXJhdGlvbiIsCiAgICAgIGJ1ZmZlcjogIi5wbHlyX19wcm9ncmVzc19fYnVmZmVyIiwKICAgICAgbG9vcDogIi5wbHlyX19wcm9ncmVzc19fbG9vcCIsCiAgICAgIHZvbHVtZTogIi5wbHlyX192b2x1bWUtLWRpc3BsYXkiCiAgICB9LAogICAgcHJvZ3Jlc3M6ICIucGx5cl9fcHJvZ3Jlc3MiLAogICAgY2FwdGlvbnM6ICIucGx5cl9fY2FwdGlvbnMiLAogICAgY2FwdGlvbjogIi5wbHlyX19jYXB0aW9uIgogIH0sCiAgY2xhc3NOYW1lczogewogICAgdHlwZTogInBseXItLXswfSIsCiAgICBwcm92aWRlcjogInBseXItLXswfSIsCiAgICB2aWRlbzogInBseXJfX3ZpZGVvLXdyYXBwZXIiLAogICAgZW1iZWQ6ICJwbHlyX192aWRlby1lbWJlZCIsCiAgICB2aWRlb0ZpeGVkUmF0aW86ICJwbHlyX192aWRlby13cmFwcGVyLS1maXhlZC1yYXRpbyIsCiAgICBlbWJlZENvbnRhaW5lcjogInBseXJfX3ZpZGVvLWVtYmVkX19jb250YWluZXIiLAogICAgcG9zdGVyOiAicGx5cl9fcG9zdGVyIiwKICAgIHBvc3RlckVuYWJsZWQ6ICJwbHlyX19wb3N0ZXItZW5hYmxlZCIsCiAgICBhZHM6ICJwbHlyX19hZHMiLAogICAgY29udHJvbDogInBseXJfX2NvbnRyb2wiLAogICAgY29udHJvbFByZXNzZWQ6ICJwbHlyX19jb250cm9sLS1wcmVzc2VkIiwKICAgIHBsYXlpbmc6ICJwbHlyLS1wbGF5aW5nIiwKICAgIHBhdXNlZDogInBseXItLXBhdXNlZCIsCiAgICBzdG9wcGVkOiAicGx5ci0tc3RvcHBlZCIsCiAgICBsb2FkaW5nOiAicGx5ci0tbG9hZGluZyIsCiAgICBob3ZlcjogInBseXItLWhvdmVyIiwKICAgIHRvb2x0aXA6ICJwbHlyX190b29sdGlwIiwKICAgIGN1ZXM6ICJwbHlyX19jdWVzIiwKICAgIGhpZGRlbjogInBseXJfX3NyLW9ubHkiLAogICAgaGlkZUNvbnRyb2xzOiAicGx5ci0taGlkZS1jb250cm9scyIsCiAgICBpc0lvczogInBseXItLWlzLWlvcyIsCiAgICBpc1RvdWNoOiAicGx5ci0taXMtdG91Y2giLAogICAgdWlTdXBwb3J0ZWQ6ICJwbHlyLS1mdWxsLXVpIiwKICAgIG5vVHJhbnNpdGlvbjogInBseXItLW5vLXRyYW5zaXRpb24iLAogICAgZGlzcGxheTogewogICAgICB0aW1lOiAicGx5cl9fdGltZSIKICAgIH0sCiAgICBtZW51OiB7CiAgICAgIHZhbHVlOiAicGx5cl9fbWVudV9fdmFsdWUiLAogICAgICBiYWRnZTogInBseXJfX2JhZGdlIiwKICAgICAgb3BlbjogInBseXItLW1lbnUtb3BlbiIKICAgIH0sCiAgICBjYXB0aW9uczogewogICAgICBlbmFibGVkOiAicGx5ci0tY2FwdGlvbnMtZW5hYmxlZCIsCiAgICAgIGFjdGl2ZTogInBseXItLWNhcHRpb25zLWFjdGl2ZSIKICAgIH0sCiAgICBmdWxsc2NyZWVuOiB7CiAgICAgIGVuYWJsZWQ6ICJwbHlyLS1mdWxsc2NyZWVuLWVuYWJsZWQiLAogICAgICBmYWxsYmFjazogInBseXItLWZ1bGxzY3JlZW4tZmFsbGJhY2siCiAgICB9LAogICAgcGlwOiB7CiAgICAgIHN1cHBvcnRlZDogInBseXItLXBpcC1zdXBwb3J0ZWQiLAogICAgICBhY3RpdmU6ICJwbHlyLS1waXAtYWN0aXZlIgogICAgfSwKICAgIGFpcnBsYXk6IHsKICAgICAgc3VwcG9ydGVkOiAicGx5ci0tYWlycGxheS1zdXBwb3J0ZWQiLAogICAgICBhY3RpdmU6ICJwbHlyLS1haXJwbGF5LWFjdGl2ZSIKICAgIH0sCiAgICB0YWJGb2N1czogInBseXJfX3RhYi1mb2N1cyIsCiAgICBwcmV2aWV3VGh1bWJuYWlsczogewogICAgICB0aHVtYkNvbnRhaW5lcjogInBseXJfX3ByZXZpZXctdGh1bWIiLAogICAgICB0aHVtYkNvbnRhaW5lclNob3duOiAicGx5cl9fcHJldmlldy10aHVtYi0taXMtc2hvd24iLAogICAgICBpbWFnZUNvbnRhaW5lcjogInBseXJfX3ByZXZpZXctdGh1bWJfX2ltYWdlLWNvbnRhaW5lciIsCiAgICAgIHRpbWVDb250YWluZXI6ICJwbHlyX19wcmV2aWV3LXRodW1iX190aW1lLWNvbnRhaW5lciIsCiAgICAgIHNjcnViYmluZ0NvbnRhaW5lcjogInBseXJfX3ByZXZpZXctc2NydWJiaW5nIiwKICAgICAgc2NydWJiaW5nQ29udGFpbmVyU2hvd246ICJwbHlyX19wcmV2aWV3LXNjcnViYmluZy0taXMtc2hvd24iCiAgICB9CiAgfSwKICBhdHRyaWJ1dGVzOiB7CiAgICBlbWJlZDogewogICAgICBwcm92aWRlcjogImRhdGEtcGx5ci1wcm92aWRlciIsCiAgICAgIGlkOiAiZGF0YS1wbHlyLWVtYmVkLWlkIgogICAgfQogIH0sCiAgYWRzOiB7CiAgICBlbmFibGVkOiAhMSwKICAgIHB1Ymxpc2hlcklkOiAiIiwKICAgIHRhZ1VybDogIiIKICB9LAogIHByZXZpZXdUaHVtYm5haWxzOiB7CiAgICBlbmFibGVkOiAhMSwKICAgIHNyYzogIiIKICB9LAogIHZpbWVvOiB7CiAgICBieWxpbmU6ICExLAogICAgcG9ydHJhaXQ6ICExLAogICAgdGl0bGU6ICExLAogICAgc3BlZWQ6ICEwLAogICAgdHJhbnNwYXJlbnQ6ICExLAogICAgcHJlbWl1bTogITEsCiAgICByZWZlcnJlclBvbGljeTogbnVsbAogIH0sCiAgeW91dHViZTogewogICAgbm9Db29raWU6ICEwLAogICAgcmVsOiAwLAogICAgc2hvd2luZm86IDAsCiAgICBpdl9sb2FkX3BvbGljeTogMywKICAgIG1vZGVzdGJyYW5kaW5nOiAxCiAgfQp9LAogICAgcXUgPSAicGljdHVyZS1pbi1waWN0dXJlIiwKICAgIFV1ID0gImlubGluZSIsCiAgICBIdSA9IHsKICBodG1sNTogImh0bWw1IiwKICB5b3V0dWJlOiAieW91dHViZSIsCiAgdmltZW86ICJ2aW1lbyIKfSwKICAgIEJ1ID0gImF1ZGlvIiwKICAgIFZ1ID0gInZpZGVvIjsKCnZhciB6dSA9IGZ1bmN0aW9uIHp1KCkge30sCiAgICBXdSA9IGZ1bmN0aW9uICgpIHsKICBmdW5jdGlvbiBlKCkgewogICAgdmFyIHQgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1swXSAmJiBhcmd1bWVudHNbMF07CiAgICBObCh0aGlzLCBlKSwgdGhpcy5lbmFibGVkID0gd2luZG93LmNvbnNvbGUgJiYgdCwgdGhpcy5lbmFibGVkICYmIHRoaXMubG9nKCJEZWJ1Z2dpbmcgZW5hYmxlZCIpOwogIH0KCiAgcmV0dXJuIGpsKGUsIFt7CiAgICBrZXk6ICJsb2ciLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLmVuYWJsZWQgPyBGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKGNvbnNvbGUubG9nLCBjb25zb2xlKSA6IHp1OwogICAgfQogIH0sIHsKICAgIGtleTogIndhcm4iLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLmVuYWJsZWQgPyBGdW5jdGlvbi5wcm90b3R5cGUuYmluZC5jYWxsKGNvbnNvbGUud2FybiwgY29uc29sZSkgOiB6dTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJlcnJvciIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuZW5hYmxlZCA/IEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kLmNhbGwoY29uc29sZS5lcnJvciwgY29uc29sZSkgOiB6dTsKICAgIH0KICB9XSksIGU7Cn0oKSwKICAgICR1ID0gZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIGUodCkgewogICAgdmFyIG4gPSB0aGlzOwogICAgTmwodGhpcywgZSksIHRoaXMucGxheWVyID0gdCwgdGhpcy5wcmVmaXggPSBlLnByZWZpeCwgdGhpcy5wcm9wZXJ0eSA9IGUucHJvcGVydHksIHRoaXMuc2Nyb2xsUG9zaXRpb24gPSB7CiAgICAgIHg6IDAsCiAgICAgIHk6IDAKICAgIH0sIHRoaXMuZm9yY2VGYWxsYmFjayA9ICJmb3JjZSIgPT09IHQuY29uZmlnLmZ1bGxzY3JlZW4uZmFsbGJhY2ssIHRoaXMucGxheWVyLmVsZW1lbnRzLmZ1bGxzY3JlZW4gPSB0LmNvbmZpZy5mdWxsc2NyZWVuLmNvbnRhaW5lciAmJiBmdW5jdGlvbiAoZSwgdCkgewogICAgICByZXR1cm4gKEVsZW1lbnQucHJvdG90eXBlLmNsb3Nlc3QgfHwgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBlID0gdGhpczsKCiAgICAgICAgZG8gewogICAgICAgICAgaWYgKFpjLm1hdGNoZXMoZSwgdCkpIHJldHVybiBlOwogICAgICAgICAgZSA9IGUucGFyZW50RWxlbWVudCB8fCBlLnBhcmVudE5vZGU7CiAgICAgICAgfSB3aGlsZSAobnVsbCAhPT0gZSAmJiAxID09PSBlLm5vZGVUeXBlKTsKCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0pLmNhbGwoZSwgdCk7CiAgICB9KHRoaXMucGxheWVyLmVsZW1lbnRzLmNvbnRhaW5lciwgdC5jb25maWcuZnVsbHNjcmVlbi5jb250YWluZXIpLCBzdS5jYWxsKHRoaXMucGxheWVyLCBkb2N1bWVudCwgIm1zIiA9PT0gdGhpcy5wcmVmaXggPyAiTVNGdWxsc2NyZWVuQ2hhbmdlIiA6ICIiLmNvbmNhdCh0aGlzLnByZWZpeCwgImZ1bGxzY3JlZW5jaGFuZ2UiKSwgZnVuY3Rpb24gKCkgewogICAgICBuLm9uQ2hhbmdlKCk7CiAgICB9KSwgc3UuY2FsbCh0aGlzLnBsYXllciwgdGhpcy5wbGF5ZXIuZWxlbWVudHMuY29udGFpbmVyLCAiZGJsY2xpY2siLCBmdW5jdGlvbiAoZSkgewogICAgICBJYyhuLnBsYXllci5lbGVtZW50cy5jb250cm9scykgJiYgbi5wbGF5ZXIuZWxlbWVudHMuY29udHJvbHMuY29udGFpbnMoZS50YXJnZXQpIHx8IG4udG9nZ2xlKCk7CiAgICB9KSwgc3UuY2FsbCh0aGlzLCB0aGlzLnBsYXllci5lbGVtZW50cy5jb250YWluZXIsICJrZXlkb3duIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIG4udHJhcEZvY3VzKGUpOwogICAgfSksIHRoaXMudXBkYXRlKCk7CiAgfQoKICByZXR1cm4gamwoZSwgW3sKICAgIGtleTogIm9uQ2hhbmdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgaWYgKHRoaXMuZW5hYmxlZCkgewogICAgICAgIHZhciBlID0gdGhpcy5wbGF5ZXIuZWxlbWVudHMuYnV0dG9ucy5mdWxsc2NyZWVuOwogICAgICAgIEljKGUpICYmIChlLnByZXNzZWQgPSB0aGlzLmFjdGl2ZSk7CiAgICAgICAgdmFyIHQgPSB0aGlzLnRhcmdldCA9PT0gdGhpcy5wbGF5ZXIubWVkaWEgPyB0aGlzLnRhcmdldCA6IHRoaXMucGxheWVyLmVsZW1lbnRzLmNvbnRhaW5lcjsKICAgICAgICB1dS5jYWxsKHRoaXMucGxheWVyLCB0LCB0aGlzLmFjdGl2ZSA/ICJlbnRlcmZ1bGxzY3JlZW4iIDogImV4aXRmdWxsc2NyZWVuIiwgITApOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAidG9nZ2xlRmFsbGJhY2siLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdICYmIGFyZ3VtZW50c1swXTsKCiAgICAgIGlmIChlID8gdGhpcy5zY3JvbGxQb3NpdGlvbiA9IHsKICAgICAgICB4OiB3aW5kb3cuc2Nyb2xsWCB8fCAwLAogICAgICAgIHk6IHdpbmRvdy5zY3JvbGxZIHx8IDAKICAgICAgfSA6IHdpbmRvdy5zY3JvbGxUbyh0aGlzLnNjcm9sbFBvc2l0aW9uLngsIHRoaXMuc2Nyb2xsUG9zaXRpb24ueSksIGRvY3VtZW50LmJvZHkuc3R5bGUub3ZlcmZsb3cgPSBlID8gImhpZGRlbiIgOiAiIiwgUWModGhpcy50YXJnZXQsIHRoaXMucGxheWVyLmNvbmZpZy5jbGFzc05hbWVzLmZ1bGxzY3JlZW4uZmFsbGJhY2ssIGUpLCBxYy5pc0lvcykgewogICAgICAgIHZhciB0ID0gZG9jdW1lbnQuaGVhZC5xdWVyeVNlbGVjdG9yKCdtZXRhW25hbWU9InZpZXdwb3J0Il0nKSwKICAgICAgICAgICAgbiA9ICJ2aWV3cG9ydC1maXQ9Y292ZXIiOwogICAgICAgIHQgfHwgKHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJtZXRhIikpLnNldEF0dHJpYnV0ZSgibmFtZSIsICJ2aWV3cG9ydCIpOwogICAgICAgIHZhciBpID0gQWModC5jb250ZW50KSAmJiB0LmNvbnRlbnQuaW5jbHVkZXMobik7CiAgICAgICAgZSA/ICh0aGlzLmNsZWFudXBWaWV3cG9ydCA9ICFpLCBpIHx8ICh0LmNvbnRlbnQgKz0gIiwiLmNvbmNhdChuKSkpIDogdGhpcy5jbGVhbnVwVmlld3BvcnQgJiYgKHQuY29udGVudCA9IHQuY29udGVudC5zcGxpdCgiLCIpLmZpbHRlcihmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmV0dXJuIGUudHJpbSgpICE9PSBuOwogICAgICAgIH0pLmpvaW4oIiwiKSk7CiAgICAgIH0KCiAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ0cmFwRm9jdXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGUpIHsKICAgICAgaWYgKCFxYy5pc0lvcyAmJiB0aGlzLmFjdGl2ZSAmJiAiVGFiIiA9PT0gZS5rZXkgJiYgOSA9PT0gZS5rZXlDb2RlKSB7CiAgICAgICAgdmFyIHQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50LAogICAgICAgICAgICBuID0gZXUuY2FsbCh0aGlzLnBsYXllciwgImFbaHJlZl0sIGJ1dHRvbjpub3QoOmRpc2FibGVkKSwgaW5wdXQ6bm90KDpkaXNhYmxlZCksIFt0YWJpbmRleF0iKSwKICAgICAgICAgICAgaSA9IHFsKG4sIDEpWzBdLAogICAgICAgICAgICByID0gbltuLmxlbmd0aCAtIDFdOwogICAgICAgIHQgIT09IHIgfHwgZS5zaGlmdEtleSA/IHQgPT09IGkgJiYgZS5zaGlmdEtleSAmJiAoci5mb2N1cygpLCBlLnByZXZlbnREZWZhdWx0KCkpIDogKGkuZm9jdXMoKSwgZS5wcmV2ZW50RGVmYXVsdCgpKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogInVwZGF0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciB0OwogICAgICB0aGlzLmVuYWJsZWQgPyAodCA9IHRoaXMuZm9yY2VGYWxsYmFjayA/ICJGYWxsYmFjayAoZm9yY2VkKSIgOiBlLm5hdGl2ZSA/ICJOYXRpdmUiIDogIkZhbGxiYWNrIiwgdGhpcy5wbGF5ZXIuZGVidWcubG9nKCIiLmNvbmNhdCh0LCAiIGZ1bGxzY3JlZW4gZW5hYmxlZCIpKSkgOiB0aGlzLnBsYXllci5kZWJ1Zy5sb2coIkZ1bGxzY3JlZW4gbm90IHN1cHBvcnRlZCBhbmQgZmFsbGJhY2sgZGlzYWJsZWQiKSwgUWModGhpcy5wbGF5ZXIuZWxlbWVudHMuY29udGFpbmVyLCB0aGlzLnBsYXllci5jb25maWcuY2xhc3NOYW1lcy5mdWxsc2NyZWVuLmVuYWJsZWQsIHRoaXMuZW5hYmxlZCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZW50ZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB0aGlzLmVuYWJsZWQgJiYgKHFjLmlzSW9zICYmIHRoaXMucGxheWVyLmNvbmZpZy5mdWxsc2NyZWVuLmlvc05hdGl2ZSA/IHRoaXMudGFyZ2V0LndlYmtpdEVudGVyRnVsbHNjcmVlbigpIDogIWUubmF0aXZlIHx8IHRoaXMuZm9yY2VGYWxsYmFjayA/IHRoaXMudG9nZ2xlRmFsbGJhY2soITApIDogdGhpcy5wcmVmaXggPyBfYyh0aGlzLnByZWZpeCkgfHwgdGhpcy50YXJnZXRbIiIuY29uY2F0KHRoaXMucHJlZml4LCAiUmVxdWVzdCIpLmNvbmNhdCh0aGlzLnByb3BlcnR5KV0oKSA6IHRoaXMudGFyZ2V0LnJlcXVlc3RGdWxsc2NyZWVuKHsKICAgICAgICBuYXZpZ2F0aW9uVUk6ICJoaWRlIgogICAgICB9KSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZXhpdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIGlmICh0aGlzLmVuYWJsZWQpIGlmIChxYy5pc0lvcyAmJiB0aGlzLnBsYXllci5jb25maWcuZnVsbHNjcmVlbi5pb3NOYXRpdmUpIHRoaXMudGFyZ2V0LndlYmtpdEV4aXRGdWxsc2NyZWVuKCksIGZ1KHRoaXMucGxheWVyLnBsYXkoKSk7ZWxzZSBpZiAoIWUubmF0aXZlIHx8IHRoaXMuZm9yY2VGYWxsYmFjaykgdGhpcy50b2dnbGVGYWxsYmFjayghMSk7ZWxzZSBpZiAodGhpcy5wcmVmaXgpIHsKICAgICAgICBpZiAoIV9jKHRoaXMucHJlZml4KSkgewogICAgICAgICAgdmFyIHQgPSAibW96IiA9PT0gdGhpcy5wcmVmaXggPyAiQ2FuY2VsIiA6ICJFeGl0IjsKICAgICAgICAgIGRvY3VtZW50WyIiLmNvbmNhdCh0aGlzLnByZWZpeCkuY29uY2F0KHQpLmNvbmNhdCh0aGlzLnByb3BlcnR5KV0oKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSAoZG9jdW1lbnQuY2FuY2VsRnVsbFNjcmVlbiB8fCBkb2N1bWVudC5leGl0RnVsbHNjcmVlbikuY2FsbChkb2N1bWVudCk7CiAgICB9CiAgfSwgewogICAga2V5OiAidG9nZ2xlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdGhpcy5hY3RpdmUgPyB0aGlzLmV4aXQoKSA6IHRoaXMuZW50ZXIoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ1c2luZ05hdGl2ZSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIGUubmF0aXZlICYmICF0aGlzLmZvcmNlRmFsbGJhY2s7CiAgICB9CiAgfSwgewogICAga2V5OiAiZW5hYmxlZCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIChlLm5hdGl2ZSB8fCB0aGlzLnBsYXllci5jb25maWcuZnVsbHNjcmVlbi5mYWxsYmFjaykgJiYgdGhpcy5wbGF5ZXIuY29uZmlnLmZ1bGxzY3JlZW4uZW5hYmxlZCAmJiB0aGlzLnBsYXllci5zdXBwb3J0ZWQudWkgJiYgdGhpcy5wbGF5ZXIuaXNWaWRlbzsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJhY3RpdmUiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIGlmICghdGhpcy5lbmFibGVkKSByZXR1cm4gITE7CiAgICAgIGlmICghZS5uYXRpdmUgfHwgdGhpcy5mb3JjZUZhbGxiYWNrKSByZXR1cm4gSmModGhpcy50YXJnZXQsIHRoaXMucGxheWVyLmNvbmZpZy5jbGFzc05hbWVzLmZ1bGxzY3JlZW4uZmFsbGJhY2spOwogICAgICB2YXIgdCA9IHRoaXMucHJlZml4ID8gZG9jdW1lbnRbIiIuY29uY2F0KHRoaXMucHJlZml4KS5jb25jYXQodGhpcy5wcm9wZXJ0eSwgIkVsZW1lbnQiKV0gOiBkb2N1bWVudC5mdWxsc2NyZWVuRWxlbWVudDsKICAgICAgcmV0dXJuIHQgJiYgdC5zaGFkb3dSb290ID8gdCA9PT0gdGhpcy50YXJnZXQuZ2V0Um9vdE5vZGUoKS5ob3N0IDogdCA9PT0gdGhpcy50YXJnZXQ7CiAgICB9CiAgfSwgewogICAga2V5OiAidGFyZ2V0IiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gcWMuaXNJb3MgJiYgdGhpcy5wbGF5ZXIuY29uZmlnLmZ1bGxzY3JlZW4uaW9zTmF0aXZlID8gdGhpcy5wbGF5ZXIubWVkaWEgOiB0aGlzLnBsYXllci5lbGVtZW50cy5mdWxsc2NyZWVuIHx8IHRoaXMucGxheWVyLmVsZW1lbnRzLmNvbnRhaW5lcjsKICAgIH0KICB9XSwgW3sKICAgIGtleTogIm5hdGl2ZSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuICEhKGRvY3VtZW50LmZ1bGxzY3JlZW5FbmFibGVkIHx8IGRvY3VtZW50LndlYmtpdEZ1bGxzY3JlZW5FbmFibGVkIHx8IGRvY3VtZW50Lm1vekZ1bGxTY3JlZW5FbmFibGVkIHx8IGRvY3VtZW50Lm1zRnVsbHNjcmVlbkVuYWJsZWQpOwogICAgfQogIH0sIHsKICAgIGtleTogInByZWZpeCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgaWYgKENjKGRvY3VtZW50LmV4aXRGdWxsc2NyZWVuKSkgcmV0dXJuICIiOwogICAgICB2YXIgZSA9ICIiOwogICAgICByZXR1cm4gWyJ3ZWJraXQiLCAibW96IiwgIm1zIl0uc29tZShmdW5jdGlvbiAodCkgewogICAgICAgIHJldHVybiAhKCFDYyhkb2N1bWVudFsiIi5jb25jYXQodCwgIkV4aXRGdWxsc2NyZWVuIildKSAmJiAhQ2MoZG9jdW1lbnRbIiIuY29uY2F0KHQsICJDYW5jZWxGdWxsU2NyZWVuIildKSB8fCAoZSA9IHQsIDApKTsKICAgICAgfSksIGU7CiAgICB9CiAgfSwgewogICAga2V5OiAicHJvcGVydHkiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiAibW96IiA9PT0gdGhpcy5wcmVmaXggPyAiRnVsbFNjcmVlbiIgOiAiRnVsbHNjcmVlbiI7CiAgICB9CiAgfV0pLCBlOwp9KCk7CgpmdW5jdGlvbiBLdShlKSB7CiAgdmFyIHQgPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSA/IGFyZ3VtZW50c1sxXSA6IDE7CiAgcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uIChuLCBpKSB7CiAgICB2YXIgciA9IG5ldyBJbWFnZSgpLAogICAgICAgIGEgPSBmdW5jdGlvbiBhKCkgewogICAgICBkZWxldGUgci5vbmxvYWQsIGRlbGV0ZSByLm9uZXJyb3IsIChyLm5hdHVyYWxXaWR0aCA+PSB0ID8gbiA6IGkpKHIpOwogICAgfTsKCiAgICBPYmplY3QuYXNzaWduKHIsIHsKICAgICAgb25sb2FkOiBhLAogICAgICBvbmVycm9yOiBhLAogICAgICBzcmM6IGUKICAgIH0pOwogIH0pOwp9Cgp2YXIgWXUgPSB7CiAgYWRkU3R5bGVIb29rOiBmdW5jdGlvbiBhZGRTdHlsZUhvb2soKSB7CiAgICBRYyh0aGlzLmVsZW1lbnRzLmNvbnRhaW5lciwgdGhpcy5jb25maWcuc2VsZWN0b3JzLmNvbnRhaW5lci5yZXBsYWNlKCIuIiwgIiIpLCAhMCksIFFjKHRoaXMuZWxlbWVudHMuY29udGFpbmVyLCB0aGlzLmNvbmZpZy5jbGFzc05hbWVzLnVpU3VwcG9ydGVkLCB0aGlzLnN1cHBvcnRlZC51aSk7CiAgfSwKICB0b2dnbGVOYXRpdmVDb250cm9sczogZnVuY3Rpb24gdG9nZ2xlTmF0aXZlQ29udHJvbHMoKSB7CiAgICB2YXIgZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdICYmIGFyZ3VtZW50c1swXTsKICAgIGUgJiYgdGhpcy5pc0hUTUw1ID8gdGhpcy5tZWRpYS5zZXRBdHRyaWJ1dGUoImNvbnRyb2xzIiwgIiIpIDogdGhpcy5tZWRpYS5yZW1vdmVBdHRyaWJ1dGUoImNvbnRyb2xzIik7CiAgfSwKICBidWlsZDogZnVuY3Rpb24gYnVpbGQoKSB7CiAgICB2YXIgZSA9IHRoaXM7CiAgICBpZiAodGhpcy5saXN0ZW5lcnMubWVkaWEoKSwgIXRoaXMuc3VwcG9ydGVkLnVpKSByZXR1cm4gdGhpcy5kZWJ1Zy53YXJuKCJCYXNpYyBzdXBwb3J0IG9ubHkgZm9yICIuY29uY2F0KHRoaXMucHJvdmlkZXIsICIgIikuY29uY2F0KHRoaXMudHlwZSkpLCB2b2lkIFl1LnRvZ2dsZU5hdGl2ZUNvbnRyb2xzLmNhbGwodGhpcywgITApOwogICAgSWModGhpcy5lbGVtZW50cy5jb250cm9scykgfHwgKGp1LmluamVjdC5jYWxsKHRoaXMpLCB0aGlzLmxpc3RlbmVycy5jb250cm9scygpKSwgWXUudG9nZ2xlTmF0aXZlQ29udHJvbHMuY2FsbCh0aGlzKSwgdGhpcy5pc0hUTUw1ICYmIER1LnNldHVwLmNhbGwodGhpcyksIHRoaXMudm9sdW1lID0gbnVsbCwgdGhpcy5tdXRlZCA9IG51bGwsIHRoaXMubG9vcCA9IG51bGwsIHRoaXMucXVhbGl0eSA9IG51bGwsIHRoaXMuc3BlZWQgPSBudWxsLCBqdS51cGRhdGVWb2x1bWUuY2FsbCh0aGlzKSwganUudGltZVVwZGF0ZS5jYWxsKHRoaXMpLCBZdS5jaGVja1BsYXlpbmcuY2FsbCh0aGlzKSwgUWModGhpcy5lbGVtZW50cy5jb250YWluZXIsIHRoaXMuY29uZmlnLmNsYXNzTmFtZXMucGlwLnN1cHBvcnRlZCwgcnUucGlwICYmIHRoaXMuaXNIVE1MNSAmJiB0aGlzLmlzVmlkZW8pLCBRYyh0aGlzLmVsZW1lbnRzLmNvbnRhaW5lciwgdGhpcy5jb25maWcuY2xhc3NOYW1lcy5haXJwbGF5LnN1cHBvcnRlZCwgcnUuYWlycGxheSAmJiB0aGlzLmlzSFRNTDUpLCBRYyh0aGlzLmVsZW1lbnRzLmNvbnRhaW5lciwgdGhpcy5jb25maWcuY2xhc3NOYW1lcy5pc0lvcywgcWMuaXNJb3MpLCBRYyh0aGlzLmVsZW1lbnRzLmNvbnRhaW5lciwgdGhpcy5jb25maWcuY2xhc3NOYW1lcy5pc1RvdWNoLCB0aGlzLnRvdWNoKSwgdGhpcy5yZWFkeSA9ICEwLCBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgdXUuY2FsbChlLCBlLm1lZGlhLCAicmVhZHkiKTsKICAgIH0sIDApLCBZdS5zZXRUaXRsZS5jYWxsKHRoaXMpLCB0aGlzLnBvc3RlciAmJiBZdS5zZXRQb3N0ZXIuY2FsbCh0aGlzLCB0aGlzLnBvc3RlciwgITEpLmNhdGNoKGZ1bmN0aW9uICgpIHt9KSwgdGhpcy5jb25maWcuZHVyYXRpb24gJiYganUuZHVyYXRpb25VcGRhdGUuY2FsbCh0aGlzKTsKICB9LAogIHNldFRpdGxlOiBmdW5jdGlvbiBzZXRUaXRsZSgpIHsKICAgIHZhciBlID0geHUoInBsYXkiLCB0aGlzLmNvbmZpZyk7CgogICAgaWYgKEFjKHRoaXMuY29uZmlnLnRpdGxlKSAmJiAhX2ModGhpcy5jb25maWcudGl0bGUpICYmIChlICs9ICIsICIuY29uY2F0KHRoaXMuY29uZmlnLnRpdGxlKSksIEFycmF5LmZyb20odGhpcy5lbGVtZW50cy5idXR0b25zLnBsYXkgfHwgW10pLmZvckVhY2goZnVuY3Rpb24gKHQpIHsKICAgICAgdC5zZXRBdHRyaWJ1dGUoImFyaWEtbGFiZWwiLCBlKTsKICAgIH0pLCB0aGlzLmlzRW1iZWQpIHsKICAgICAgdmFyIHQgPSB0dS5jYWxsKHRoaXMsICJpZnJhbWUiKTsKICAgICAgaWYgKCFJYyh0KSkgcmV0dXJuOwogICAgICB2YXIgbiA9IF9jKHRoaXMuY29uZmlnLnRpdGxlKSA/ICJ2aWRlbyIgOiB0aGlzLmNvbmZpZy50aXRsZSwKICAgICAgICAgIGkgPSB4dSgiZnJhbWVUaXRsZSIsIHRoaXMuY29uZmlnKTsKICAgICAgdC5zZXRBdHRyaWJ1dGUoInRpdGxlIiwgaS5yZXBsYWNlKCJ7dGl0bGV9IiwgbikpOwogICAgfQogIH0sCiAgdG9nZ2xlUG9zdGVyOiBmdW5jdGlvbiB0b2dnbGVQb3N0ZXIoZSkgewogICAgUWModGhpcy5lbGVtZW50cy5jb250YWluZXIsIHRoaXMuY29uZmlnLmNsYXNzTmFtZXMucG9zdGVyRW5hYmxlZCwgZSk7CiAgfSwKICBzZXRQb3N0ZXI6IGZ1bmN0aW9uIHNldFBvc3RlcihlKSB7CiAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgbiA9ICEoYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbMV0pIHx8IGFyZ3VtZW50c1sxXTsKICAgIHJldHVybiBuICYmIHRoaXMucG9zdGVyID8gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCJQb3N0ZXIgYWxyZWFkeSBzZXQiKSkgOiAodGhpcy5tZWRpYS5zZXRBdHRyaWJ1dGUoImRhdGEtcG9zdGVyIiwgZSksIGR1LmNhbGwodGhpcykudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBLdShlKTsKICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChuKSB7CiAgICAgIHRocm93IGUgPT09IHQucG9zdGVyICYmIFl1LnRvZ2dsZVBvc3Rlci5jYWxsKHQsICExKSwgbjsKICAgIH0pLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICBpZiAoZSAhPT0gdC5wb3N0ZXIpIHRocm93IG5ldyBFcnJvcigic2V0UG9zdGVyIGNhbmNlbGxlZCBieSBsYXRlciBjYWxsIHRvIHNldFBvc3RlciIpOwogICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHQuZWxlbWVudHMucG9zdGVyLnN0eWxlLCB7CiAgICAgICAgYmFja2dyb3VuZEltYWdlOiAidXJsKCciLmNvbmNhdChlLCAiJykiKSwKICAgICAgICBiYWNrZ3JvdW5kU2l6ZTogIiIKICAgICAgfSksIFl1LnRvZ2dsZVBvc3Rlci5jYWxsKHQsICEwKSwgZTsKICAgIH0pKTsKICB9LAogIGNoZWNrUGxheWluZzogZnVuY3Rpb24gY2hlY2tQbGF5aW5nKGUpIHsKICAgIHZhciB0ID0gdGhpczsKICAgIFFjKHRoaXMuZWxlbWVudHMuY29udGFpbmVyLCB0aGlzLmNvbmZpZy5jbGFzc05hbWVzLnBsYXlpbmcsIHRoaXMucGxheWluZyksIFFjKHRoaXMuZWxlbWVudHMuY29udGFpbmVyLCB0aGlzLmNvbmZpZy5jbGFzc05hbWVzLnBhdXNlZCwgdGhpcy5wYXVzZWQpLCBRYyh0aGlzLmVsZW1lbnRzLmNvbnRhaW5lciwgdGhpcy5jb25maWcuY2xhc3NOYW1lcy5zdG9wcGVkLCB0aGlzLnN0b3BwZWQpLCBBcnJheS5mcm9tKHRoaXMuZWxlbWVudHMuYnV0dG9ucy5wbGF5IHx8IFtdKS5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgIE9iamVjdC5hc3NpZ24oZSwgewogICAgICAgIHByZXNzZWQ6IHQucGxheWluZwogICAgICB9KSwgZS5zZXRBdHRyaWJ1dGUoImFyaWEtbGFiZWwiLCB4dSh0LnBsYXlpbmcgPyAicGF1c2UiIDogInBsYXkiLCB0LmNvbmZpZykpOwogICAgfSksIExjKGUpICYmICJ0aW1ldXBkYXRlIiA9PT0gZS50eXBlIHx8IFl1LnRvZ2dsZUNvbnRyb2xzLmNhbGwodGhpcyk7CiAgfSwKICBjaGVja0xvYWRpbmc6IGZ1bmN0aW9uIGNoZWNrTG9hZGluZyhlKSB7CiAgICB2YXIgdCA9IHRoaXM7CiAgICB0aGlzLmxvYWRpbmcgPSBbInN0YWxsZWQiLCAid2FpdGluZyJdLmluY2x1ZGVzKGUudHlwZSksIGNsZWFyVGltZW91dCh0aGlzLnRpbWVycy5sb2FkaW5nKSwgdGhpcy50aW1lcnMubG9hZGluZyA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICBRYyh0LmVsZW1lbnRzLmNvbnRhaW5lciwgdC5jb25maWcuY2xhc3NOYW1lcy5sb2FkaW5nLCB0LmxvYWRpbmcpLCBZdS50b2dnbGVDb250cm9scy5jYWxsKHQpOwogICAgfSwgdGhpcy5sb2FkaW5nID8gMjUwIDogMCk7CiAgfSwKICB0b2dnbGVDb250cm9sczogZnVuY3Rpb24gdG9nZ2xlQ29udHJvbHMoZSkgewogICAgdmFyIHQgPSB0aGlzLmVsZW1lbnRzLmNvbnRyb2xzOwoKICAgIGlmICh0ICYmIHRoaXMuY29uZmlnLmhpZGVDb250cm9scykgewogICAgICB2YXIgbiA9IHRoaXMudG91Y2ggJiYgdGhpcy5sYXN0U2Vla1RpbWUgKyAyZTMgPiBEYXRlLm5vdygpOwogICAgICB0aGlzLnRvZ2dsZUNvbnRyb2xzKEJvb2xlYW4oZSB8fCB0aGlzLmxvYWRpbmcgfHwgdGhpcy5wYXVzZWQgfHwgdC5wcmVzc2VkIHx8IHQuaG92ZXIgfHwgbikpOwogICAgfQogIH0sCiAgbWlncmF0ZVN0eWxlczogZnVuY3Rpb24gbWlncmF0ZVN0eWxlcygpIHsKICAgIHZhciBlID0gdGhpczsKICAgIE9iamVjdC52YWx1ZXMoRGwoe30sIHRoaXMubWVkaWEuc3R5bGUpKS5maWx0ZXIoZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuICFfYyhlKSAmJiBBYyhlKSAmJiBlLnN0YXJ0c1dpdGgoIi0tcGx5ciIpOwogICAgfSkuZm9yRWFjaChmdW5jdGlvbiAodCkgewogICAgICBlLmVsZW1lbnRzLmNvbnRhaW5lci5zdHlsZS5zZXRQcm9wZXJ0eSh0LCBlLm1lZGlhLnN0eWxlLmdldFByb3BlcnR5VmFsdWUodCkpLCBlLm1lZGlhLnN0eWxlLnJlbW92ZVByb3BlcnR5KHQpOwogICAgfSksIF9jKHRoaXMubWVkaWEuc3R5bGUpICYmIHRoaXMubWVkaWEucmVtb3ZlQXR0cmlidXRlKCJzdHlsZSIpOwogIH0KfSwKICAgIEd1ID0gZnVuY3Rpb24gKCkgewogIGZ1bmN0aW9uIGUodCkgewogICAgTmwodGhpcywgZSksIHRoaXMucGxheWVyID0gdCwgdGhpcy5sYXN0S2V5ID0gbnVsbCwgdGhpcy5mb2N1c1RpbWVyID0gbnVsbCwgdGhpcy5sYXN0S2V5RG93biA9IG51bGwsIHRoaXMuaGFuZGxlS2V5ID0gdGhpcy5oYW5kbGVLZXkuYmluZCh0aGlzKSwgdGhpcy50b2dnbGVNZW51ID0gdGhpcy50b2dnbGVNZW51LmJpbmQodGhpcyksIHRoaXMuc2V0VGFiRm9jdXMgPSB0aGlzLnNldFRhYkZvY3VzLmJpbmQodGhpcyksIHRoaXMuZmlyc3RUb3VjaCA9IHRoaXMuZmlyc3RUb3VjaC5iaW5kKHRoaXMpOwogIH0KCiAgcmV0dXJuIGpsKGUsIFt7CiAgICBrZXk6ICJoYW5kbGVLZXkiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGUpIHsKICAgICAgdmFyIHQgPSB0aGlzLnBsYXllciwKICAgICAgICAgIG4gPSB0LmVsZW1lbnRzLAogICAgICAgICAgaSA9IGUua2V5Q29kZSA/IGUua2V5Q29kZSA6IGUud2hpY2gsCiAgICAgICAgICByID0gImtleWRvd24iID09PSBlLnR5cGUsCiAgICAgICAgICBhID0gciAmJiBpID09PSB0aGlzLmxhc3RLZXk7CiAgICAgIGlmICghKGUuYWx0S2V5IHx8IGUuY3RybEtleSB8fCBlLm1ldGFLZXkgfHwgZS5zaGlmdEtleSkgJiYgRWMoaSkpIGlmIChyKSB7CiAgICAgICAgdmFyIG8gPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwoKICAgICAgICBpZiAoSWMobykpIHsKICAgICAgICAgIHZhciBzID0gdC5jb25maWcuc2VsZWN0b3JzLmVkaXRhYmxlOwogICAgICAgICAgaWYgKG8gIT09IG4uaW5wdXRzLnNlZWsgJiYgWmMobywgcykpIHJldHVybjsKICAgICAgICAgIGlmICgzMiA9PT0gZS53aGljaCAmJiBaYyhvLCAnYnV0dG9uLCBbcm9sZV49Im1lbnVpdGVtIl0nKSkgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgc3dpdGNoIChbMzIsIDM3LCAzOCwgMzksIDQwLCA0OCwgNDksIDUwLCA1MSwgNTIsIDUzLCA1NCwgNTYsIDU3LCA2NywgNzAsIDczLCA3NSwgNzYsIDc3LCA3OV0uaW5jbHVkZXMoaSkgJiYgKGUucHJldmVudERlZmF1bHQoKSwgZS5zdG9wUHJvcGFnYXRpb24oKSksIGkpIHsKICAgICAgICAgIGNhc2UgNDg6CiAgICAgICAgICBjYXNlIDQ5OgogICAgICAgICAgY2FzZSA1MDoKICAgICAgICAgIGNhc2UgNTE6CiAgICAgICAgICBjYXNlIDUyOgogICAgICAgICAgY2FzZSA1MzoKICAgICAgICAgIGNhc2UgNTQ6CiAgICAgICAgICBjYXNlIDU1OgogICAgICAgICAgY2FzZSA1NjoKICAgICAgICAgIGNhc2UgNTc6CiAgICAgICAgICAgIGEgfHwgKHQuY3VycmVudFRpbWUgPSB0LmR1cmF0aW9uIC8gMTAgKiAoaSAtIDQ4KSk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgMzI6CiAgICAgICAgICBjYXNlIDc1OgogICAgICAgICAgICBhIHx8IGZ1KHQudG9nZ2xlUGxheSgpKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAzODoKICAgICAgICAgICAgdC5pbmNyZWFzZVZvbHVtZSguMSk7CiAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgIGNhc2UgNDA6CiAgICAgICAgICAgIHQuZGVjcmVhc2VWb2x1bWUoLjEpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDc3OgogICAgICAgICAgICBhIHx8ICh0Lm11dGVkID0gIXQubXV0ZWQpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDM5OgogICAgICAgICAgICB0LmZvcndhcmQoKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSAzNzoKICAgICAgICAgICAgdC5yZXdpbmQoKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSA3MDoKICAgICAgICAgICAgdC5mdWxsc2NyZWVuLnRvZ2dsZSgpOwogICAgICAgICAgICBicmVhazsKCiAgICAgICAgICBjYXNlIDY3OgogICAgICAgICAgICBhIHx8IHQudG9nZ2xlQ2FwdGlvbnMoKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgY2FzZSA3NjoKICAgICAgICAgICAgdC5sb29wID0gIXQubG9vcDsKICAgICAgICB9CgogICAgICAgIDI3ID09PSBpICYmICF0LmZ1bGxzY3JlZW4udXNpbmdOYXRpdmUgJiYgdC5mdWxsc2NyZWVuLmFjdGl2ZSAmJiB0LmZ1bGxzY3JlZW4udG9nZ2xlKCksIHRoaXMubGFzdEtleSA9IGk7CiAgICAgIH0gZWxzZSB0aGlzLmxhc3RLZXkgPSBudWxsOwogICAgfQogIH0sIHsKICAgIGtleTogInRvZ2dsZU1lbnUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGUpIHsKICAgICAganUudG9nZ2xlTWVudS5jYWxsKHRoaXMucGxheWVyLCBlKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJmaXJzdFRvdWNoIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIGUgPSB0aGlzLnBsYXllciwKICAgICAgICAgIHQgPSBlLmVsZW1lbnRzOwogICAgICBlLnRvdWNoID0gITAsIFFjKHQuY29udGFpbmVyLCBlLmNvbmZpZy5jbGFzc05hbWVzLmlzVG91Y2gsICEwKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRUYWJGb2N1cyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICB2YXIgdCA9IHRoaXMucGxheWVyLAogICAgICAgICAgbiA9IHQuZWxlbWVudHM7CgogICAgICBpZiAoY2xlYXJUaW1lb3V0KHRoaXMuZm9jdXNUaW1lciksICJrZXlkb3duIiAhPT0gZS50eXBlIHx8IDkgPT09IGUud2hpY2gpIHsKICAgICAgICAia2V5ZG93biIgPT09IGUudHlwZSAmJiAodGhpcy5sYXN0S2V5RG93biA9IGUudGltZVN0YW1wKTsKICAgICAgICB2YXIgaSwKICAgICAgICAgICAgciA9IGUudGltZVN0YW1wIC0gdGhpcy5sYXN0S2V5RG93biA8PSAyMDsKICAgICAgICAoImZvY3VzIiAhPT0gZS50eXBlIHx8IHIpICYmIChpID0gdC5jb25maWcuY2xhc3NOYW1lcy50YWJGb2N1cywgUWMoZXUuY2FsbCh0LCAiLiIuY29uY2F0KGkpKSwgaSwgITEpLCAiZm9jdXNvdXQiICE9PSBlLnR5cGUgJiYgKHRoaXMuZm9jdXNUaW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgdmFyIGUgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwogICAgICAgICAgbi5jb250YWluZXIuY29udGFpbnMoZSkgJiYgUWMoZG9jdW1lbnQuYWN0aXZlRWxlbWVudCwgdC5jb25maWcuY2xhc3NOYW1lcy50YWJGb2N1cywgITApOwogICAgICAgIH0sIDEwKSkpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2xvYmFsIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIGUgPSAhKGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdKSB8fCBhcmd1bWVudHNbMF0sCiAgICAgICAgICB0ID0gdGhpcy5wbGF5ZXI7CiAgICAgIHQuY29uZmlnLmtleWJvYXJkLmdsb2JhbCAmJiBvdS5jYWxsKHQsIHdpbmRvdywgImtleWRvd24ga2V5dXAiLCB0aGlzLmhhbmRsZUtleSwgZSwgITEpLCBvdS5jYWxsKHQsIGRvY3VtZW50LmJvZHksICJjbGljayIsIHRoaXMudG9nZ2xlTWVudSwgZSksIGN1LmNhbGwodCwgZG9jdW1lbnQuYm9keSwgInRvdWNoc3RhcnQiLCB0aGlzLmZpcnN0VG91Y2gpLCBvdS5jYWxsKHQsIGRvY3VtZW50LmJvZHksICJrZXlkb3duIGZvY3VzIGJsdXIgZm9jdXNvdXQiLCB0aGlzLnNldFRhYkZvY3VzLCBlLCAhMSwgITApOwogICAgfQogIH0sIHsKICAgIGtleTogImNvbnRhaW5lciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBlID0gdGhpcy5wbGF5ZXIsCiAgICAgICAgICB0ID0gZS5jb25maWcsCiAgICAgICAgICBuID0gZS5lbGVtZW50cywKICAgICAgICAgIGkgPSBlLnRpbWVyczsKICAgICAgIXQua2V5Ym9hcmQuZ2xvYmFsICYmIHQua2V5Ym9hcmQuZm9jdXNlZCAmJiBzdS5jYWxsKGUsIG4uY29udGFpbmVyLCAia2V5ZG93biBrZXl1cCIsIHRoaXMuaGFuZGxlS2V5LCAhMSksIHN1LmNhbGwoZSwgbi5jb250YWluZXIsICJtb3VzZW1vdmUgbW91c2VsZWF2ZSB0b3VjaHN0YXJ0IHRvdWNobW92ZSBlbnRlcmZ1bGxzY3JlZW4gZXhpdGZ1bGxzY3JlZW4iLCBmdW5jdGlvbiAodCkgewogICAgICAgIHZhciByID0gbi5jb250cm9sczsKICAgICAgICByICYmICJlbnRlcmZ1bGxzY3JlZW4iID09PSB0LnR5cGUgJiYgKHIucHJlc3NlZCA9ICExLCByLmhvdmVyID0gITEpOwogICAgICAgIHZhciBhID0gMDsKICAgICAgICBbInRvdWNoc3RhcnQiLCAidG91Y2htb3ZlIiwgIm1vdXNlbW92ZSJdLmluY2x1ZGVzKHQudHlwZSkgJiYgKFl1LnRvZ2dsZUNvbnRyb2xzLmNhbGwoZSwgITApLCBhID0gZS50b3VjaCA/IDNlMyA6IDJlMyksIGNsZWFyVGltZW91dChpLmNvbnRyb2xzKSwgaS5jb250cm9scyA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIFl1LnRvZ2dsZUNvbnRyb2xzLmNhbGwoZSwgITEpOwogICAgICAgIH0sIGEpOwogICAgICB9KTsKCiAgICAgIHZhciByID0gZnVuY3Rpb24gcih0KSB7CiAgICAgICAgaWYgKCF0KSByZXR1cm4gdnUuY2FsbChlKTsKICAgICAgICB2YXIgaSA9IG4uY29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLAogICAgICAgICAgICByID0gaS53aWR0aCwKICAgICAgICAgICAgYSA9IGkuaGVpZ2h0OwogICAgICAgIHJldHVybiB2dS5jYWxsKGUsICIiLmNvbmNhdChyLCAiOiIpLmNvbmNhdChhKSk7CiAgICAgIH0sCiAgICAgICAgICBhID0gZnVuY3Rpb24gYSgpIHsKICAgICAgICBjbGVhclRpbWVvdXQoaS5yZXNpemVkKSwgaS5yZXNpemVkID0gc2V0VGltZW91dChyLCA1MCk7CiAgICAgIH07CgogICAgICBzdS5jYWxsKGUsIG4uY29udGFpbmVyLCAiZW50ZXJmdWxsc2NyZWVuIGV4aXRmdWxsc2NyZWVuIiwgZnVuY3Rpb24gKHQpIHsKICAgICAgICB2YXIgaSA9IGUuZnVsbHNjcmVlbiwKICAgICAgICAgICAgbyA9IGkudGFyZ2V0LAogICAgICAgICAgICBzID0gaS51c2luZ05hdGl2ZTsKCiAgICAgICAgaWYgKG8gPT09IG4uY29udGFpbmVyICYmIChlLmlzRW1iZWQgfHwgIV9jKGUuY29uZmlnLnJhdGlvKSkpIHsKICAgICAgICAgIHZhciBsID0gImVudGVyZnVsbHNjcmVlbiIgPT09IHQudHlwZSwKICAgICAgICAgICAgICBjID0gcihsKTsKICAgICAgICAgIGMucGFkZGluZywgIWZ1bmN0aW9uICh0LCBuLCBpKSB7CiAgICAgICAgICAgIGlmIChlLmlzVmltZW8gJiYgIWUuY29uZmlnLnZpbWVvLnByZW1pdW0pIHsKICAgICAgICAgICAgICB2YXIgciA9IGUuZWxlbWVudHMud3JhcHBlci5maXJzdENoaWxkLAogICAgICAgICAgICAgICAgICBhID0gcWwodCwgMilbMV0sCiAgICAgICAgICAgICAgICAgIG8gPSBxbChndS5jYWxsKGUpLCAyKSwKICAgICAgICAgICAgICAgICAgcyA9IG9bMF0sCiAgICAgICAgICAgICAgICAgIGwgPSBvWzFdOwogICAgICAgICAgICAgIHIuc3R5bGUubWF4V2lkdGggPSBpID8gIiIuY29uY2F0KGEgLyBsICogcywgInB4IikgOiBudWxsLCByLnN0eWxlLm1hcmdpbiA9IGkgPyAiMCBhdXRvIiA6IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0oYy5yYXRpbywgMCwgbCksIHMgfHwgKGwgPyBzdS5jYWxsKGUsIHdpbmRvdywgInJlc2l6ZSIsIGEpIDogbHUuY2FsbChlLCB3aW5kb3csICJyZXNpemUiLCBhKSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJtZWRpYSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBlID0gdGhpcywKICAgICAgICAgIHQgPSB0aGlzLnBsYXllciwKICAgICAgICAgIG4gPSB0LmVsZW1lbnRzOwoKICAgICAgaWYgKHN1LmNhbGwodCwgdC5tZWRpYSwgInRpbWV1cGRhdGUgc2Vla2luZyBzZWVrZWQiLCBmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiBqdS50aW1lVXBkYXRlLmNhbGwodCwgZSk7CiAgICAgIH0pLCBzdS5jYWxsKHQsIHQubWVkaWEsICJkdXJhdGlvbmNoYW5nZSBsb2FkZWRkYXRhIGxvYWRlZG1ldGFkYXRhIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4ganUuZHVyYXRpb25VcGRhdGUuY2FsbCh0LCBlKTsKICAgICAgfSksIHN1LmNhbGwodCwgdC5tZWRpYSwgImVuZGVkIiwgZnVuY3Rpb24gKCkgewogICAgICAgIHQuaXNIVE1MNSAmJiB0LmlzVmlkZW8gJiYgdC5jb25maWcucmVzZXRPbkVuZCAmJiAodC5yZXN0YXJ0KCksIHQucGF1c2UoKSk7CiAgICAgIH0pLCBzdS5jYWxsKHQsIHQubWVkaWEsICJwcm9ncmVzcyBwbGF5aW5nIHNlZWtpbmcgc2Vla2VkIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4ganUudXBkYXRlUHJvZ3Jlc3MuY2FsbCh0LCBlKTsKICAgICAgfSksIHN1LmNhbGwodCwgdC5tZWRpYSwgInZvbHVtZWNoYW5nZSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuIGp1LnVwZGF0ZVZvbHVtZS5jYWxsKHQsIGUpOwogICAgICB9KSwgc3UuY2FsbCh0LCB0Lm1lZGlhLCAicGxheWluZyBwbGF5IHBhdXNlIGVuZGVkIGVtcHRpZWQgdGltZXVwZGF0ZSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgcmV0dXJuIFl1LmNoZWNrUGxheWluZy5jYWxsKHQsIGUpOwogICAgICB9KSwgc3UuY2FsbCh0LCB0Lm1lZGlhLCAid2FpdGluZyBjYW5wbGF5IHNlZWtlZCBwbGF5aW5nIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gWXUuY2hlY2tMb2FkaW5nLmNhbGwodCwgZSk7CiAgICAgIH0pLCB0LnN1cHBvcnRlZC51aSAmJiB0LmNvbmZpZy5jbGlja1RvUGxheSAmJiAhdC5pc0F1ZGlvKSB7CiAgICAgICAgdmFyIGkgPSB0dS5jYWxsKHQsICIuIi5jb25jYXQodC5jb25maWcuY2xhc3NOYW1lcy52aWRlbykpOwogICAgICAgIGlmICghSWMoaSkpIHJldHVybjsKICAgICAgICBzdS5jYWxsKHQsIG4uY29udGFpbmVyLCAiY2xpY2siLCBmdW5jdGlvbiAocikgewogICAgICAgICAgKFtuLmNvbnRhaW5lciwgaV0uaW5jbHVkZXMoci50YXJnZXQpIHx8IGkuY29udGFpbnMoci50YXJnZXQpKSAmJiAodC50b3VjaCAmJiB0LmNvbmZpZy5oaWRlQ29udHJvbHMgfHwgKHQuZW5kZWQgPyAoZS5wcm94eShyLCB0LnJlc3RhcnQsICJyZXN0YXJ0IiksIGUucHJveHkociwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdSh0LnBsYXkoKSk7CiAgICAgICAgICB9LCAicGxheSIpKSA6IGUucHJveHkociwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICBmdSh0LnRvZ2dsZVBsYXkoKSk7CiAgICAgICAgICB9LCAicGxheSIpKSk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHQuc3VwcG9ydGVkLnVpICYmIHQuY29uZmlnLmRpc2FibGVDb250ZXh0TWVudSAmJiBzdS5jYWxsKHQsIG4ud3JhcHBlciwgImNvbnRleHRtZW51IiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgIH0sICExKSwgc3UuY2FsbCh0LCB0Lm1lZGlhLCAidm9sdW1lY2hhbmdlIiwgZnVuY3Rpb24gKCkgewogICAgICAgIHQuc3RvcmFnZS5zZXQoewogICAgICAgICAgdm9sdW1lOiB0LnZvbHVtZSwKICAgICAgICAgIG11dGVkOiB0Lm11dGVkCiAgICAgICAgfSk7CiAgICAgIH0pLCBzdS5jYWxsKHQsIHQubWVkaWEsICJyYXRlY2hhbmdlIiwgZnVuY3Rpb24gKCkgewogICAgICAgIGp1LnVwZGF0ZVNldHRpbmcuY2FsbCh0LCAic3BlZWQiKSwgdC5zdG9yYWdlLnNldCh7CiAgICAgICAgICBzcGVlZDogdC5zcGVlZAogICAgICAgIH0pOwogICAgICB9KSwgc3UuY2FsbCh0LCB0Lm1lZGlhLCAicXVhbGl0eWNoYW5nZSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAganUudXBkYXRlU2V0dGluZy5jYWxsKHQsICJxdWFsaXR5IiwgbnVsbCwgZS5kZXRhaWwucXVhbGl0eSk7CiAgICAgIH0pLCBzdS5jYWxsKHQsIHQubWVkaWEsICJyZWFkeSBxdWFsaXR5Y2hhbmdlIiwgZnVuY3Rpb24gKCkgewogICAgICAgIGp1LnNldERvd25sb2FkVXJsLmNhbGwodCk7CiAgICAgIH0pOwogICAgICB2YXIgciA9IHQuY29uZmlnLmV2ZW50cy5jb25jYXQoWyJrZXl1cCIsICJrZXlkb3duIl0pLmpvaW4oIiAiKTsKICAgICAgc3UuY2FsbCh0LCB0Lm1lZGlhLCByLCBmdW5jdGlvbiAoZSkgewogICAgICAgIHZhciBpID0gZS5kZXRhaWwsCiAgICAgICAgICAgIHIgPSB2b2lkIDAgPT09IGkgPyB7fSA6IGk7CiAgICAgICAgImVycm9yIiA9PT0gZS50eXBlICYmIChyID0gdC5tZWRpYS5lcnJvciksIHV1LmNhbGwodCwgbi5jb250YWluZXIsIGUudHlwZSwgITAsIHIpOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJwcm94eSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSwgdCwgbikgewogICAgICB2YXIgaSA9IHRoaXMucGxheWVyLAogICAgICAgICAgciA9IGkuY29uZmlnLmxpc3RlbmVyc1tuXSwKICAgICAgICAgIGEgPSAhMDsKICAgICAgQ2MocikgJiYgKGEgPSByLmNhbGwoaSwgZSkpLCAhMSAhPT0gYSAmJiBDYyh0KSAmJiB0LmNhbGwoaSwgZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiYmluZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSwgdCwgbiwgaSkgewogICAgICB2YXIgciA9IHRoaXMsCiAgICAgICAgICBhID0gIShhcmd1bWVudHMubGVuZ3RoID4gNCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1s0XSkgfHwgYXJndW1lbnRzWzRdLAogICAgICAgICAgbyA9IHRoaXMucGxheWVyLAogICAgICAgICAgcyA9IG8uY29uZmlnLmxpc3RlbmVyc1tpXSwKICAgICAgICAgIGwgPSBDYyhzKTsKICAgICAgc3UuY2FsbChvLCBlLCB0LCBmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiByLnByb3h5KGUsIG4sIGkpOwogICAgICB9LCBhICYmICFsKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjb250cm9scyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBlID0gdGhpcywKICAgICAgICAgIHQgPSB0aGlzLnBsYXllciwKICAgICAgICAgIG4gPSB0LmVsZW1lbnRzLAogICAgICAgICAgaSA9IHFjLmlzSUUgPyAiY2hhbmdlIiA6ICJpbnB1dCI7CgogICAgICBpZiAobi5idXR0b25zLnBsYXkgJiYgQXJyYXkuZnJvbShuLmJ1dHRvbnMucGxheSkuZm9yRWFjaChmdW5jdGlvbiAobikgewogICAgICAgIGUuYmluZChuLCAiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICBmdSh0LnRvZ2dsZVBsYXkoKSk7CiAgICAgICAgfSwgInBsYXkiKTsKICAgICAgfSksIHRoaXMuYmluZChuLmJ1dHRvbnMucmVzdGFydCwgImNsaWNrIiwgdC5yZXN0YXJ0LCAicmVzdGFydCIpLCB0aGlzLmJpbmQobi5idXR0b25zLnJld2luZCwgImNsaWNrIiwgdC5yZXdpbmQsICJyZXdpbmQiKSwgdGhpcy5iaW5kKG4uYnV0dG9ucy5mYXN0Rm9yd2FyZCwgImNsaWNrIiwgdC5mb3J3YXJkLCAiZmFzdEZvcndhcmQiKSwgdGhpcy5iaW5kKG4uYnV0dG9ucy5tdXRlLCAiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdC5tdXRlZCA9ICF0Lm11dGVkOwogICAgICB9LCAibXV0ZSIpLCB0aGlzLmJpbmQobi5idXR0b25zLmNhcHRpb25zLCAiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHQudG9nZ2xlQ2FwdGlvbnMoKTsKICAgICAgfSksIHRoaXMuYmluZChuLmJ1dHRvbnMuZG93bmxvYWQsICJjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICB1dS5jYWxsKHQsIHQubWVkaWEsICJkb3dubG9hZCIpOwogICAgICB9LCAiZG93bmxvYWQiKSwgdGhpcy5iaW5kKG4uYnV0dG9ucy5mdWxsc2NyZWVuLCAiY2xpY2siLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdC5mdWxsc2NyZWVuLnRvZ2dsZSgpOwogICAgICB9LCAiZnVsbHNjcmVlbiIpLCB0aGlzLmJpbmQobi5idXR0b25zLnBpcCwgImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgIHQucGlwID0gInRvZ2dsZSI7CiAgICAgIH0sICJwaXAiKSwgdGhpcy5iaW5kKG4uYnV0dG9ucy5haXJwbGF5LCAiY2xpY2siLCB0LmFpcnBsYXksICJhaXJwbGF5IiksIHRoaXMuYmluZChuLmJ1dHRvbnMuc2V0dGluZ3MsICJjbGljayIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKSwgZS5wcmV2ZW50RGVmYXVsdCgpLCBqdS50b2dnbGVNZW51LmNhbGwodCwgZSk7CiAgICAgIH0sIG51bGwsICExKSwgdGhpcy5iaW5kKG4uYnV0dG9ucy5zZXR0aW5ncywgImtleXVwIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICB2YXIgbiA9IGUud2hpY2g7CiAgICAgICAgWzEzLCAzMl0uaW5jbHVkZXMobikgJiYgKDEzICE9PSBuID8gKGUucHJldmVudERlZmF1bHQoKSwgZS5zdG9wUHJvcGFnYXRpb24oKSwganUudG9nZ2xlTWVudS5jYWxsKHQsIGUpKSA6IGp1LmZvY3VzRmlyc3RNZW51SXRlbS5jYWxsKHQsIG51bGwsICEwKSk7CiAgICAgIH0sIG51bGwsICExKSwgdGhpcy5iaW5kKG4uc2V0dGluZ3MubWVudSwgImtleWRvd24iLCBmdW5jdGlvbiAoZSkgewogICAgICAgIDI3ID09PSBlLndoaWNoICYmIGp1LnRvZ2dsZU1lbnUuY2FsbCh0LCBlKTsKICAgICAgfSksIHRoaXMuYmluZChuLmlucHV0cy5zZWVrLCAibW91c2Vkb3duIG1vdXNlbW92ZSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIHQgPSBuLnByb2dyZXNzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLAogICAgICAgICAgICBpID0gMTAwIC8gdC53aWR0aCAqIChlLnBhZ2VYIC0gdC5sZWZ0KTsKICAgICAgICBlLmN1cnJlbnRUYXJnZXQuc2V0QXR0cmlidXRlKCJzZWVrLXZhbHVlIiwgaSk7CiAgICAgIH0pLCB0aGlzLmJpbmQobi5pbnB1dHMuc2VlaywgIm1vdXNlZG93biBtb3VzZXVwIGtleWRvd24ga2V5dXAgdG91Y2hzdGFydCB0b3VjaGVuZCIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIG4gPSBlLmN1cnJlbnRUYXJnZXQsCiAgICAgICAgICAgIGkgPSBlLmtleUNvZGUgPyBlLmtleUNvZGUgOiBlLndoaWNoLAogICAgICAgICAgICByID0gInBsYXktb24tc2Vla2VkIjsKCiAgICAgICAgaWYgKCFOYyhlKSB8fCAzOSA9PT0gaSB8fCAzNyA9PT0gaSkgewogICAgICAgICAgdC5sYXN0U2Vla1RpbWUgPSBEYXRlLm5vdygpOwogICAgICAgICAgdmFyIGEgPSBuLmhhc0F0dHJpYnV0ZShyKSwKICAgICAgICAgICAgICBvID0gWyJtb3VzZXVwIiwgInRvdWNoZW5kIiwgImtleXVwIl0uaW5jbHVkZXMoZS50eXBlKTsKICAgICAgICAgIGEgJiYgbyA/IChuLnJlbW92ZUF0dHJpYnV0ZShyKSwgZnUodC5wbGF5KCkpKSA6ICFvICYmIHQucGxheWluZyAmJiAobi5zZXRBdHRyaWJ1dGUociwgIiIpLCB0LnBhdXNlKCkpOwogICAgICAgIH0KICAgICAgfSksIHFjLmlzSW9zKSB7CiAgICAgICAgdmFyIHIgPSBldS5jYWxsKHQsICdpbnB1dFt0eXBlPSJyYW5nZSJdJyk7CiAgICAgICAgQXJyYXkuZnJvbShyKS5mb3JFYWNoKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICByZXR1cm4gZS5iaW5kKHQsIGksIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgIHJldHVybiBGYyhlLnRhcmdldCk7CiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhpcy5iaW5kKG4uaW5wdXRzLnNlZWssIGksIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIG4gPSBlLmN1cnJlbnRUYXJnZXQsCiAgICAgICAgICAgIGkgPSBuLmdldEF0dHJpYnV0ZSgic2Vlay12YWx1ZSIpOwogICAgICAgIF9jKGkpICYmIChpID0gbi52YWx1ZSksIG4ucmVtb3ZlQXR0cmlidXRlKCJzZWVrLXZhbHVlIiksIHQuY3VycmVudFRpbWUgPSBpIC8gbi5tYXggKiB0LmR1cmF0aW9uOwogICAgICB9LCAic2VlayIpLCB0aGlzLmJpbmQobi5wcm9ncmVzcywgIm1vdXNlZW50ZXIgbW91c2VsZWF2ZSBtb3VzZW1vdmUiLCBmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiBqdS51cGRhdGVTZWVrVG9vbHRpcC5jYWxsKHQsIGUpOwogICAgICB9KSwgdGhpcy5iaW5kKG4ucHJvZ3Jlc3MsICJtb3VzZW1vdmUgdG91Y2htb3ZlIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICB2YXIgbiA9IHQucHJldmlld1RodW1ibmFpbHM7CiAgICAgICAgbiAmJiBuLmxvYWRlZCAmJiBuLnN0YXJ0TW92ZShlKTsKICAgICAgfSksIHRoaXMuYmluZChuLnByb2dyZXNzLCAibW91c2VsZWF2ZSB0b3VjaGVuZCBjbGljayIsIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IHQucHJldmlld1RodW1ibmFpbHM7CiAgICAgICAgZSAmJiBlLmxvYWRlZCAmJiBlLmVuZE1vdmUoITEsICEwKTsKICAgICAgfSksIHRoaXMuYmluZChuLnByb2dyZXNzLCAibW91c2Vkb3duIHRvdWNoc3RhcnQiLCBmdW5jdGlvbiAoZSkgewogICAgICAgIHZhciBuID0gdC5wcmV2aWV3VGh1bWJuYWlsczsKICAgICAgICBuICYmIG4ubG9hZGVkICYmIG4uc3RhcnRTY3J1YmJpbmcoZSk7CiAgICAgIH0pLCB0aGlzLmJpbmQobi5wcm9ncmVzcywgIm1vdXNldXAgdG91Y2hlbmQiLCBmdW5jdGlvbiAoZSkgewogICAgICAgIHZhciBuID0gdC5wcmV2aWV3VGh1bWJuYWlsczsKICAgICAgICBuICYmIG4ubG9hZGVkICYmIG4uZW5kU2NydWJiaW5nKGUpOwogICAgICB9KSwgcWMuaXNXZWJraXQgJiYgQXJyYXkuZnJvbShldS5jYWxsKHQsICdpbnB1dFt0eXBlPSJyYW5nZSJdJykpLmZvckVhY2goZnVuY3Rpb24gKG4pIHsKICAgICAgICBlLmJpbmQobiwgImlucHV0IiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIHJldHVybiBqdS51cGRhdGVSYW5nZUZpbGwuY2FsbCh0LCBlLnRhcmdldCk7CiAgICAgICAgfSk7CiAgICAgIH0pLCB0LmNvbmZpZy50b2dnbGVJbnZlcnQgJiYgIUljKG4uZGlzcGxheS5kdXJhdGlvbikgJiYgdGhpcy5iaW5kKG4uZGlzcGxheS5jdXJyZW50VGltZSwgImNsaWNrIiwgZnVuY3Rpb24gKCkgewogICAgICAgIDAgIT09IHQuY3VycmVudFRpbWUgJiYgKHQuY29uZmlnLmludmVydFRpbWUgPSAhdC5jb25maWcuaW52ZXJ0VGltZSwganUudGltZVVwZGF0ZS5jYWxsKHQpKTsKICAgICAgfSksIHRoaXMuYmluZChuLmlucHV0cy52b2x1bWUsIGksIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdC52b2x1bWUgPSBlLnRhcmdldC52YWx1ZTsKICAgICAgfSwgInZvbHVtZSIpLCB0aGlzLmJpbmQobi5jb250cm9scywgIm1vdXNlZW50ZXIgbW91c2VsZWF2ZSIsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgbi5jb250cm9scy5ob3ZlciA9ICF0LnRvdWNoICYmICJtb3VzZWVudGVyIiA9PT0gZS50eXBlOwogICAgICB9KSwgbi5mdWxsc2NyZWVuICYmIEFycmF5LmZyb20obi5mdWxsc2NyZWVuLmNoaWxkcmVuKS5maWx0ZXIoZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gIWUuY29udGFpbnMobi5jb250YWluZXIpOwogICAgICB9KS5mb3JFYWNoKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgZS5iaW5kKGksICJtb3VzZWVudGVyIG1vdXNlbGVhdmUiLCBmdW5jdGlvbiAoZSkgewogICAgICAgICAgbi5jb250cm9scy5ob3ZlciA9ICF0LnRvdWNoICYmICJtb3VzZWVudGVyIiA9PT0gZS50eXBlOwogICAgICAgIH0pOwogICAgICB9KSwgdGhpcy5iaW5kKG4uY29udHJvbHMsICJtb3VzZWRvd24gbW91c2V1cCB0b3VjaHN0YXJ0IHRvdWNoZW5kIHRvdWNoY2FuY2VsIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICBuLmNvbnRyb2xzLnByZXNzZWQgPSBbIm1vdXNlZG93biIsICJ0b3VjaHN0YXJ0Il0uaW5jbHVkZXMoZS50eXBlKTsKICAgICAgfSksIHRoaXMuYmluZChuLmNvbnRyb2xzLCAiZm9jdXNpbiIsIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgaSA9IHQuY29uZmlnLAogICAgICAgICAgICByID0gdC50aW1lcnM7CiAgICAgICAgUWMobi5jb250cm9scywgaS5jbGFzc05hbWVzLm5vVHJhbnNpdGlvbiwgITApLCBZdS50b2dnbGVDb250cm9scy5jYWxsKHQsICEwKSwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICBRYyhuLmNvbnRyb2xzLCBpLmNsYXNzTmFtZXMubm9UcmFuc2l0aW9uLCAhMSk7CiAgICAgICAgfSwgMCk7CiAgICAgICAgdmFyIGEgPSBlLnRvdWNoID8gM2UzIDogNGUzOwogICAgICAgIGNsZWFyVGltZW91dChyLmNvbnRyb2xzKSwgci5jb250cm9scyA9IHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIFl1LnRvZ2dsZUNvbnRyb2xzLmNhbGwodCwgITEpOwogICAgICAgIH0sIGEpOwogICAgICB9KSwgdGhpcy5iaW5kKG4uaW5wdXRzLnZvbHVtZSwgIndoZWVsIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgICB2YXIgbiA9IGUud2Via2l0RGlyZWN0aW9uSW52ZXJ0ZWRGcm9tRGV2aWNlLAogICAgICAgICAgICBpID0gcWwoW2UuZGVsdGFYLCAtZS5kZWx0YVldLm1hcChmdW5jdGlvbiAoZSkgewogICAgICAgICAgcmV0dXJuIG4gPyAtZSA6IGU7CiAgICAgICAgfSksIDIpLAogICAgICAgICAgICByID0gaVswXSwKICAgICAgICAgICAgYSA9IGlbMV0sCiAgICAgICAgICAgIG8gPSBNYXRoLnNpZ24oTWF0aC5hYnMocikgPiBNYXRoLmFicyhhKSA/IHIgOiBhKTsKICAgICAgICB0LmluY3JlYXNlVm9sdW1lKG8gLyA1MCk7CiAgICAgICAgdmFyIHMgPSB0Lm1lZGlhLnZvbHVtZTsKICAgICAgICAoMSA9PT0gbyAmJiBzIDwgMSB8fCAtMSA9PT0gbyAmJiBzID4gMCkgJiYgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB9LCAidm9sdW1lIiwgITEpOwogICAgfQogIH1dKSwgZTsKfSgpOwoKdmFyIFh1ID0gZnVuY3Rpb24gKGUsIHQpIHsKICByZXR1cm4gZSh0ID0gewogICAgZXhwb3J0czoge30KICB9LCB0LmV4cG9ydHMpLCB0LmV4cG9ydHM7Cn0oZnVuY3Rpb24gKGUsIHQpIHsKICBlLmV4cG9ydHMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZSA9IGZ1bmN0aW9uIGUoKSB7fSwKICAgICAgICB0ID0ge30sCiAgICAgICAgbiA9IHt9LAogICAgICAgIGkgPSB7fTsKCiAgICBmdW5jdGlvbiByKGUsIHQpIHsKICAgICAgaWYgKGUpIHsKICAgICAgICB2YXIgciA9IGlbZV07CiAgICAgICAgaWYgKG5bZV0gPSB0LCByKSBmb3IgKDsgci5sZW5ndGg7KSB7CiAgICAgICAgICByWzBdKGUsIHQpLCByLnNwbGljZSgwLCAxKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBhKHQsIG4pIHsKICAgICAgdC5jYWxsICYmICh0ID0gewogICAgICAgIHN1Y2Nlc3M6IHQKICAgICAgfSksIG4ubGVuZ3RoID8gKHQuZXJyb3IgfHwgZSkobikgOiAodC5zdWNjZXNzIHx8IGUpKHQpOwogICAgfQoKICAgIGZ1bmN0aW9uIG8odCwgbiwgaSwgcikgewogICAgICB2YXIgYSwKICAgICAgICAgIHMsCiAgICAgICAgICBsID0gZG9jdW1lbnQsCiAgICAgICAgICBjID0gaS5hc3luYywKICAgICAgICAgIHUgPSAoaS5udW1SZXRyaWVzIHx8IDApICsgMSwKICAgICAgICAgIGggPSBpLmJlZm9yZSB8fCBlLAogICAgICAgICAgZCA9IHQucmVwbGFjZSgvW1w/fCNdLiokLywgIiIpLAogICAgICAgICAgZiA9IHQucmVwbGFjZSgvXihjc3N8aW1nKSEvLCAiIik7CiAgICAgIHIgPSByIHx8IDAsIC8oXmNzcyF8XC5jc3MkKS8udGVzdChkKSA/ICgocyA9IGwuY3JlYXRlRWxlbWVudCgibGluayIpKS5yZWwgPSAic3R5bGVzaGVldCIsIHMuaHJlZiA9IGYsIChhID0gImhpZGVGb2N1cyIgaW4gcykgJiYgcy5yZWxMaXN0ICYmIChhID0gMCwgcy5yZWwgPSAicHJlbG9hZCIsIHMuYXMgPSAic3R5bGUiKSkgOiAvKF5pbWchfFwuKHBuZ3xnaWZ8anBnfHN2Z3x3ZWJwKSQpLy50ZXN0KGQpID8gKHMgPSBsLmNyZWF0ZUVsZW1lbnQoImltZyIpKS5zcmMgPSBmIDogKChzID0gbC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKSkuc3JjID0gdCwgcy5hc3luYyA9IHZvaWQgMCA9PT0gYyB8fCBjKSwgcy5vbmxvYWQgPSBzLm9uZXJyb3IgPSBzLm9uYmVmb3JlbG9hZCA9IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgdmFyIGwgPSBlLnR5cGVbMF07CiAgICAgICAgaWYgKGEpIHRyeSB7CiAgICAgICAgICBzLnNoZWV0LmNzc1RleHQubGVuZ3RoIHx8IChsID0gImUiKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAxOCAhPSBlLmNvZGUgJiYgKGwgPSAiZSIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCJlIiA9PSBsKSB7CiAgICAgICAgICBpZiAoKHIgKz0gMSkgPCB1KSByZXR1cm4gbyh0LCBuLCBpLCByKTsKICAgICAgICB9IGVsc2UgaWYgKCJwcmVsb2FkIiA9PSBzLnJlbCAmJiAic3R5bGUiID09IHMuYXMpIHJldHVybiBzLnJlbCA9ICJzdHlsZXNoZWV0IjsKCiAgICAgICAgbih0LCBsLCBlLmRlZmF1bHRQcmV2ZW50ZWQpOwogICAgICB9LCAhMSAhPT0gaCh0LCBzKSAmJiBsLmhlYWQuYXBwZW5kQ2hpbGQocyk7CiAgICB9CgogICAgZnVuY3Rpb24gcyhlLCB0LCBuKSB7CiAgICAgIHZhciBpLAogICAgICAgICAgciwKICAgICAgICAgIGEgPSAoZSA9IGUucHVzaCA/IGUgOiBbZV0pLmxlbmd0aCwKICAgICAgICAgIHMgPSBhLAogICAgICAgICAgbCA9IFtdOwoKICAgICAgZm9yIChpID0gZnVuY3Rpb24gaShlLCBuLCBfaTIpIHsKICAgICAgICBpZiAoImUiID09IG4gJiYgbC5wdXNoKGUpLCAiYiIgPT0gbikgewogICAgICAgICAgaWYgKCFfaTIpIHJldHVybjsKICAgICAgICAgIGwucHVzaChlKTsKICAgICAgICB9CgogICAgICAgIC0tYSB8fCB0KGwpOwogICAgICB9LCByID0gMDsgciA8IHM7IHIrKykgewogICAgICAgIG8oZVtyXSwgaSwgbik7CiAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBsKGUsIG4sIGkpIHsKICAgICAgdmFyIG8sIGw7CgogICAgICBpZiAobiAmJiBuLnRyaW0gJiYgKG8gPSBuKSwgbCA9IChvID8gaSA6IG4pIHx8IHt9LCBvKSB7CiAgICAgICAgaWYgKG8gaW4gdCkgdGhyb3cgIkxvYWRKUyI7CiAgICAgICAgdFtvXSA9ICEwOwogICAgICB9CgogICAgICBmdW5jdGlvbiBjKHQsIG4pIHsKICAgICAgICBzKGUsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICBhKGwsIGUpLCB0ICYmIGEoewogICAgICAgICAgICBzdWNjZXNzOiB0LAogICAgICAgICAgICBlcnJvcjogbgogICAgICAgICAgfSwgZSksIHIobywgZSk7CiAgICAgICAgfSwgbCk7CiAgICAgIH0KCiAgICAgIGlmIChsLnJldHVyblByb21pc2UpIHJldHVybiBuZXcgUHJvbWlzZShjKTsKICAgICAgYygpOwogICAgfQoKICAgIHJldHVybiBsLnJlYWR5ID0gZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlLCB0KSB7CiAgICAgICAgZSA9IGUucHVzaCA/IGUgOiBbZV07CiAgICAgICAgdmFyIHIsCiAgICAgICAgICAgIGEsCiAgICAgICAgICAgIG8sCiAgICAgICAgICAgIHMgPSBbXSwKICAgICAgICAgICAgbCA9IGUubGVuZ3RoLAogICAgICAgICAgICBjID0gbDsKCiAgICAgICAgZm9yIChyID0gZnVuY3Rpb24gcihlLCBuKSB7CiAgICAgICAgICBuLmxlbmd0aCAmJiBzLnB1c2goZSksIC0tYyB8fCB0KHMpOwogICAgICAgIH07IGwtLTspIHsKICAgICAgICAgIGEgPSBlW2xdLCAobyA9IG5bYV0pID8gcihhLCBvKSA6IChpW2FdID0gaVthXSB8fCBbXSkucHVzaChyKTsKICAgICAgICB9CiAgICAgIH0oZSwgZnVuY3Rpb24gKGUpIHsKICAgICAgICBhKHQsIGUpOwogICAgICB9KSwgbDsKICAgIH0sIGwuZG9uZSA9IGZ1bmN0aW9uIChlKSB7CiAgICAgIHIoZSwgW10pOwogICAgfSwgbC5yZXNldCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdCA9IHt9LCBuID0ge30sIGkgPSB7fTsKICAgIH0sIGwuaXNEZWZpbmVkID0gZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIGUgaW4gdDsKICAgIH0sIGw7CiAgfSgpOwp9KTsKCmZ1bmN0aW9uIFF1KGUpIHsKICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHQsIG4pIHsKICAgIFh1KGUsIHsKICAgICAgc3VjY2VzczogdCwKICAgICAgZXJyb3I6IG4KICAgIH0pOwogIH0pOwp9CgpmdW5jdGlvbiBKdShlKSB7CiAgZSAmJiAhdGhpcy5lbWJlZC5oYXNQbGF5ZWQgJiYgKHRoaXMuZW1iZWQuaGFzUGxheWVkID0gITApLCB0aGlzLm1lZGlhLnBhdXNlZCA9PT0gZSAmJiAodGhpcy5tZWRpYS5wYXVzZWQgPSAhZSwgdXUuY2FsbCh0aGlzLCB0aGlzLm1lZGlhLCBlID8gInBsYXkiIDogInBhdXNlIikpOwp9Cgp2YXIgWnUgPSB7CiAgc2V0dXA6IGZ1bmN0aW9uIHNldHVwKCkgewogICAgdmFyIGUgPSB0aGlzOwogICAgUWMoZS5lbGVtZW50cy53cmFwcGVyLCBlLmNvbmZpZy5jbGFzc05hbWVzLmVtYmVkLCAhMCksIGUub3B0aW9ucy5zcGVlZCA9IGUuY29uZmlnLnNwZWVkLm9wdGlvbnMsIHZ1LmNhbGwoZSksIFNjKHdpbmRvdy5WaW1lbykgPyBadS5yZWFkeS5jYWxsKGUpIDogUXUoZS5jb25maWcudXJscy52aW1lby5zZGspLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICBadS5yZWFkeS5jYWxsKGUpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKHQpIHsKICAgICAgZS5kZWJ1Zy53YXJuKCJWaW1lbyBTREsgKHBsYXllci5qcykgZmFpbGVkIHRvIGxvYWQiLCB0KTsKICAgIH0pOwogIH0sCiAgcmVhZHk6IGZ1bmN0aW9uIHJlYWR5KCkgewogICAgdmFyIGUgPSB0aGlzLAogICAgICAgIHQgPSB0aGlzLAogICAgICAgIG4gPSB0LmNvbmZpZy52aW1lbywKICAgICAgICBpID0gbi5wcmVtaXVtLAogICAgICAgIHIgPSBuLnJlZmVycmVyUG9saWN5LAogICAgICAgIGEgPSBGbChuLCBbInByZW1pdW0iLCAicmVmZXJyZXJQb2xpY3kiXSk7CiAgICBpICYmIE9iamVjdC5hc3NpZ24oYSwgewogICAgICBjb250cm9sczogITEsCiAgICAgIHNpZGVkb2NrOiAhMQogICAgfSk7CgogICAgdmFyIG8gPSBfdShEbCh7CiAgICAgIGxvb3A6IHQuY29uZmlnLmxvb3AuYWN0aXZlLAogICAgICBhdXRvcGxheTogdC5hdXRvcGxheSwKICAgICAgbXV0ZWQ6IHQubXV0ZWQsCiAgICAgIGdlc3R1cmU6ICJtZWRpYSIsCiAgICAgIHBsYXlzaW5saW5lOiAhdGhpcy5jb25maWcuZnVsbHNjcmVlbi5pb3NOYXRpdmUKICAgIH0sIGEpKSwKICAgICAgICBzID0gdC5tZWRpYS5nZXRBdHRyaWJ1dGUoInNyYyIpOwoKICAgIF9jKHMpICYmIChzID0gdC5tZWRpYS5nZXRBdHRyaWJ1dGUodC5jb25maWcuYXR0cmlidXRlcy5lbWJlZC5pZCkpOwoKICAgIHZhciBsID0gZnVuY3Rpb24gKGUpIHsKICAgICAgcmV0dXJuIF9jKGUpID8gbnVsbCA6IEVjKE51bWJlcihlKSkgPyBlIDogZS5tYXRjaCgvXi4qKHZpbWVvLmNvbVwvfHZpZGVvXC8pKFxkKykuKi8pID8gUmVnRXhwLiQyIDogZTsKICAgIH0ocyksCiAgICAgICAgYyA9IHpjKCJpZnJhbWUiKSwKICAgICAgICB1ID0gd3UodC5jb25maWcudXJscy52aW1lby5pZnJhbWUsIGwsIG8pOwoKICAgIGMuc2V0QXR0cmlidXRlKCJzcmMiLCB1KSwgYy5zZXRBdHRyaWJ1dGUoImFsbG93ZnVsbHNjcmVlbiIsICIiKSwgYy5zZXRBdHRyaWJ1dGUoImFsbG93IiwgImF1dG9wbGF5LGZ1bGxzY3JlZW4scGljdHVyZS1pbi1waWN0dXJlIiksIF9jKHIpIHx8IGMuc2V0QXR0cmlidXRlKCJyZWZlcnJlclBvbGljeSIsIHIpOwogICAgdmFyIGggPSB0LnBvc3RlcjsKICAgIGlmIChpKSBjLnNldEF0dHJpYnV0ZSgiZGF0YS1wb3N0ZXIiLCBoKSwgdC5tZWRpYSA9IFljKGMsIHQubWVkaWEpO2Vsc2UgewogICAgICB2YXIgZCA9IHpjKCJkaXYiLCB7CiAgICAgICAgY2xhc3M6IHQuY29uZmlnLmNsYXNzTmFtZXMuZW1iZWRDb250YWluZXIsCiAgICAgICAgImRhdGEtcG9zdGVyIjogaAogICAgICB9KTsKICAgICAgZC5hcHBlbmRDaGlsZChjKSwgdC5tZWRpYSA9IFljKGQsIHQubWVkaWEpOwogICAgfQogICAgUHUod3UodC5jb25maWcudXJscy52aW1lby5hcGksIGwpLCAianNvbiIpLnRoZW4oZnVuY3Rpb24gKGUpIHsKICAgICAgaWYgKCFfYyhlKSkgewogICAgICAgIHZhciBuID0gbmV3IFVSTChlWzBdLnRodW1ibmFpbF9sYXJnZSk7CiAgICAgICAgbi5wYXRobmFtZSA9ICIiLmNvbmNhdChuLnBhdGhuYW1lLnNwbGl0KCJfIilbMF0sICIuanBnIiksIFl1LnNldFBvc3Rlci5jYWxsKHQsIG4uaHJlZikuY2F0Y2goZnVuY3Rpb24gKCkge30pOwogICAgICB9CiAgICB9KSwgdC5lbWJlZCA9IG5ldyB3aW5kb3cuVmltZW8uUGxheWVyKGMsIHsKICAgICAgYXV0b3BhdXNlOiB0LmNvbmZpZy5hdXRvcGF1c2UsCiAgICAgIG11dGVkOiB0Lm11dGVkCiAgICB9KSwgdC5tZWRpYS5wYXVzZWQgPSAhMCwgdC5tZWRpYS5jdXJyZW50VGltZSA9IDAsIHQuc3VwcG9ydGVkLnVpICYmIHQuZW1iZWQuZGlzYWJsZVRleHRUcmFjaygpLCB0Lm1lZGlhLnBsYXkgPSBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBKdS5jYWxsKHQsICEwKSwgdC5lbWJlZC5wbGF5KCk7CiAgICB9LCB0Lm1lZGlhLnBhdXNlID0gZnVuY3Rpb24gKCkgewogICAgICByZXR1cm4gSnUuY2FsbCh0LCAhMSksIHQuZW1iZWQucGF1c2UoKTsKICAgIH0sIHQubWVkaWEuc3RvcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgdC5wYXVzZSgpLCB0LmN1cnJlbnRUaW1lID0gMDsKICAgIH07CiAgICB2YXIgZiA9IHQubWVkaWEuY3VycmVudFRpbWU7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodC5tZWRpYSwgImN1cnJlbnRUaW1lIiwgewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gZjsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoZSkgewogICAgICAgIHZhciBuID0gdC5lbWJlZCwKICAgICAgICAgICAgaSA9IHQubWVkaWEsCiAgICAgICAgICAgIHIgPSB0LnBhdXNlZCwKICAgICAgICAgICAgYSA9IHQudm9sdW1lLAogICAgICAgICAgICBvID0gciAmJiAhbi5oYXNQbGF5ZWQ7CiAgICAgICAgaS5zZWVraW5nID0gITAsIHV1LmNhbGwodCwgaSwgInNlZWtpbmciKSwgUHJvbWlzZS5yZXNvbHZlKG8gJiYgbi5zZXRWb2x1bWUoMCkpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgcmV0dXJuIG4uc2V0Q3VycmVudFRpbWUoZSk7CiAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gbyAmJiBuLnBhdXNlKCk7CiAgICAgICAgfSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gbyAmJiBuLnNldFZvbHVtZShhKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoKSB7fSk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHAgPSB0LmNvbmZpZy5zcGVlZC5zZWxlY3RlZDsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0Lm1lZGlhLCAicGxheWJhY2tSYXRlIiwgewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gcDsKICAgICAgfSwKICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoZSkgewogICAgICAgIHQuZW1iZWQuc2V0UGxheWJhY2tSYXRlKGUpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgICAgcCA9IGUsIHV1LmNhbGwodCwgdC5tZWRpYSwgInJhdGVjaGFuZ2UiKTsKICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgICB0Lm9wdGlvbnMuc3BlZWQgPSBbMV07CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIG0gPSB0LmNvbmZpZy52b2x1bWU7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodC5tZWRpYSwgInZvbHVtZSIsIHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIG07CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgICB0LmVtYmVkLnNldFZvbHVtZShlKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgIG0gPSBlLCB1dS5jYWxsKHQsIHQubWVkaWEsICJ2b2x1bWVjaGFuZ2UiKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CiAgICB2YXIgZyA9IHQuY29uZmlnLm11dGVkOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHQubWVkaWEsICJtdXRlZCIsIHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIGc7CiAgICAgIH0sCiAgICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgICB2YXIgbiA9ICEheGMoZSkgJiYgZTsKICAgICAgICB0LmVtYmVkLnNldFZvbHVtZShuID8gMCA6IHQuY29uZmlnLnZvbHVtZSkudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICBnID0gbiwgdXUuY2FsbCh0LCB0Lm1lZGlhLCAidm9sdW1lY2hhbmdlIik7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgdmFyIHYsCiAgICAgICAgeSA9IHQuY29uZmlnLmxvb3A7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodC5tZWRpYSwgImxvb3AiLCB7CiAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgIHJldHVybiB5OwogICAgICB9LAogICAgICBzZXQ6IGZ1bmN0aW9uIHNldChlKSB7CiAgICAgICAgdmFyIG4gPSB4YyhlKSA/IGUgOiB0LmNvbmZpZy5sb29wLmFjdGl2ZTsKICAgICAgICB0LmVtYmVkLnNldExvb3AobikudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgICB5ID0gbjsKICAgICAgICB9KTsKICAgICAgfQogICAgfSksIHQuZW1iZWQuZ2V0VmlkZW9VcmwoKS50aGVuKGZ1bmN0aW9uIChlKSB7CiAgICAgIHYgPSBlLCBqdS5zZXREb3dubG9hZFVybC5jYWxsKHQpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKHQpIHsKICAgICAgZS5kZWJ1Zy53YXJuKHQpOwogICAgfSksIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0Lm1lZGlhLCAiY3VycmVudFNyYyIsIHsKICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgcmV0dXJuIHY7CiAgICAgIH0KICAgIH0pLCBPYmplY3QuZGVmaW5lUHJvcGVydHkodC5tZWRpYSwgImVuZGVkIiwgewogICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICByZXR1cm4gdC5jdXJyZW50VGltZSA9PT0gdC5kdXJhdGlvbjsKICAgICAgfQogICAgfSksIFByb21pc2UuYWxsKFt0LmVtYmVkLmdldFZpZGVvV2lkdGgoKSwgdC5lbWJlZC5nZXRWaWRlb0hlaWdodCgpXSkudGhlbihmdW5jdGlvbiAobikgewogICAgICB2YXIgaSA9IHFsKG4sIDIpLAogICAgICAgICAgciA9IGlbMF0sCiAgICAgICAgICBhID0gaVsxXTsKICAgICAgdC5lbWJlZC5yYXRpbyA9IFtyLCBhXSwgdnUuY2FsbChlKTsKICAgIH0pLCB0LmVtYmVkLnNldEF1dG9wYXVzZSh0LmNvbmZpZy5hdXRvcGF1c2UpLnRoZW4oZnVuY3Rpb24gKGUpIHsKICAgICAgdC5jb25maWcuYXV0b3BhdXNlID0gZTsKICAgIH0pLCB0LmVtYmVkLmdldFZpZGVvVGl0bGUoKS50aGVuKGZ1bmN0aW9uIChuKSB7CiAgICAgIHQuY29uZmlnLnRpdGxlID0gbiwgWXUuc2V0VGl0bGUuY2FsbChlKTsKICAgIH0pLCB0LmVtYmVkLmdldEN1cnJlbnRUaW1lKCkudGhlbihmdW5jdGlvbiAoZSkgewogICAgICBmID0gZSwgdXUuY2FsbCh0LCB0Lm1lZGlhLCAidGltZXVwZGF0ZSIpOwogICAgfSksIHQuZW1iZWQuZ2V0RHVyYXRpb24oKS50aGVuKGZ1bmN0aW9uIChlKSB7CiAgICAgIHQubWVkaWEuZHVyYXRpb24gPSBlLCB1dS5jYWxsKHQsIHQubWVkaWEsICJkdXJhdGlvbmNoYW5nZSIpOwogICAgfSksIHQuZW1iZWQuZ2V0VGV4dFRyYWNrcygpLnRoZW4oZnVuY3Rpb24gKGUpIHsKICAgICAgdC5tZWRpYS50ZXh0VHJhY2tzID0gZSwgRHUuc2V0dXAuY2FsbCh0KTsKICAgIH0pLCB0LmVtYmVkLm9uKCJjdWVjaGFuZ2UiLCBmdW5jdGlvbiAoZSkgewogICAgICB2YXIgbiA9IGUuY3VlcywKICAgICAgICAgIGkgPSAodm9pZCAwID09PSBuID8gW10gOiBuKS5tYXAoZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgIHZhciB0ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpLAogICAgICAgICAgICAgIG4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgICAgICAgIHJldHVybiB0LmFwcGVuZENoaWxkKG4pLCBuLmlubmVySFRNTCA9IGUsIHQuZmlyc3RDaGlsZC5pbm5lclRleHQ7CiAgICAgICAgfShlLnRleHQpOwogICAgICB9KTsKICAgICAgRHUudXBkYXRlQ3Vlcy5jYWxsKHQsIGkpOwogICAgfSksIHQuZW1iZWQub24oImxvYWRlZCIsIGZ1bmN0aW9uICgpIHsKICAgICAgdC5lbWJlZC5nZXRQYXVzZWQoKS50aGVuKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgSnUuY2FsbCh0LCAhZSksIGUgfHwgdXUuY2FsbCh0LCB0Lm1lZGlhLCAicGxheWluZyIpOwogICAgICB9KSwgSWModC5lbWJlZC5lbGVtZW50KSAmJiB0LnN1cHBvcnRlZC51aSAmJiB0LmVtYmVkLmVsZW1lbnQuc2V0QXR0cmlidXRlKCJ0YWJpbmRleCIsIC0xKTsKICAgIH0pLCB0LmVtYmVkLm9uKCJidWZmZXJzdGFydCIsIGZ1bmN0aW9uICgpIHsKICAgICAgdXUuY2FsbCh0LCB0Lm1lZGlhLCAid2FpdGluZyIpOwogICAgfSksIHQuZW1iZWQub24oImJ1ZmZlcmVuZCIsIGZ1bmN0aW9uICgpIHsKICAgICAgdXUuY2FsbCh0LCB0Lm1lZGlhLCAicGxheWluZyIpOwogICAgfSksIHQuZW1iZWQub24oInBsYXkiLCBmdW5jdGlvbiAoKSB7CiAgICAgIEp1LmNhbGwodCwgITApLCB1dS5jYWxsKHQsIHQubWVkaWEsICJwbGF5aW5nIik7CiAgICB9KSwgdC5lbWJlZC5vbigicGF1c2UiLCBmdW5jdGlvbiAoKSB7CiAgICAgIEp1LmNhbGwodCwgITEpOwogICAgfSksIHQuZW1iZWQub24oInRpbWV1cGRhdGUiLCBmdW5jdGlvbiAoZSkgewogICAgICB0Lm1lZGlhLnNlZWtpbmcgPSAhMSwgZiA9IGUuc2Vjb25kcywgdXUuY2FsbCh0LCB0Lm1lZGlhLCAidGltZXVwZGF0ZSIpOwogICAgfSksIHQuZW1iZWQub24oInByb2dyZXNzIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgdC5tZWRpYS5idWZmZXJlZCA9IGUucGVyY2VudCwgdXUuY2FsbCh0LCB0Lm1lZGlhLCAicHJvZ3Jlc3MiKSwgMSA9PT0gcGFyc2VJbnQoZS5wZXJjZW50LCAxMCkgJiYgdXUuY2FsbCh0LCB0Lm1lZGlhLCAiY2FucGxheXRocm91Z2giKSwgdC5lbWJlZC5nZXREdXJhdGlvbigpLnRoZW4oZnVuY3Rpb24gKGUpIHsKICAgICAgICBlICE9PSB0Lm1lZGlhLmR1cmF0aW9uICYmICh0Lm1lZGlhLmR1cmF0aW9uID0gZSwgdXUuY2FsbCh0LCB0Lm1lZGlhLCAiZHVyYXRpb25jaGFuZ2UiKSk7CiAgICAgIH0pOwogICAgfSksIHQuZW1iZWQub24oInNlZWtlZCIsIGZ1bmN0aW9uICgpIHsKICAgICAgdC5tZWRpYS5zZWVraW5nID0gITEsIHV1LmNhbGwodCwgdC5tZWRpYSwgInNlZWtlZCIpOwogICAgfSksIHQuZW1iZWQub24oImVuZGVkIiwgZnVuY3Rpb24gKCkgewogICAgICB0Lm1lZGlhLnBhdXNlZCA9ICEwLCB1dS5jYWxsKHQsIHQubWVkaWEsICJlbmRlZCIpOwogICAgfSksIHQuZW1iZWQub24oImVycm9yIiwgZnVuY3Rpb24gKGUpIHsKICAgICAgdC5tZWRpYS5lcnJvciA9IGUsIHV1LmNhbGwodCwgdC5tZWRpYSwgImVycm9yIik7CiAgICB9KSwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBZdS5idWlsZC5jYWxsKHQpOwogICAgfSwgMCk7CiAgfQp9OwoKZnVuY3Rpb24gZWgoZSkgewogIGUgJiYgIXRoaXMuZW1iZWQuaGFzUGxheWVkICYmICh0aGlzLmVtYmVkLmhhc1BsYXllZCA9ICEwKSwgdGhpcy5tZWRpYS5wYXVzZWQgPT09IGUgJiYgKHRoaXMubWVkaWEucGF1c2VkID0gIWUsIHV1LmNhbGwodGhpcywgdGhpcy5tZWRpYSwgZSA/ICJwbGF5IiA6ICJwYXVzZSIpKTsKfQoKZnVuY3Rpb24gdGgoZSkgewogIHJldHVybiBlLm5vQ29va2llID8gImh0dHBzOi8vd3d3LnlvdXR1YmUtbm9jb29raWUuY29tIiA6ICJodHRwOiIgPT09IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCA/ICJodHRwOi8vd3d3LnlvdXR1YmUuY29tIiA6IHZvaWQgMDsKfQoKdmFyIG5oID0gewogIHNldHVwOiBmdW5jdGlvbiBzZXR1cCgpIHsKICAgIHZhciBlID0gdGhpczsKICAgIGlmIChRYyh0aGlzLmVsZW1lbnRzLndyYXBwZXIsIHRoaXMuY29uZmlnLmNsYXNzTmFtZXMuZW1iZWQsICEwKSwgU2Mod2luZG93LllUKSAmJiBDYyh3aW5kb3cuWVQuUGxheWVyKSkgbmgucmVhZHkuY2FsbCh0aGlzKTtlbHNlIHsKICAgICAgdmFyIHQgPSB3aW5kb3cub25Zb3VUdWJlSWZyYW1lQVBJUmVhZHk7CiAgICAgIHdpbmRvdy5vbllvdVR1YmVJZnJhbWVBUElSZWFkeSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBDYyh0KSAmJiB0KCksIG5oLnJlYWR5LmNhbGwoZSk7CiAgICAgIH0sIFF1KHRoaXMuY29uZmlnLnVybHMueW91dHViZS5zZGspLmNhdGNoKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgZS5kZWJ1Zy53YXJuKCJZb3VUdWJlIEFQSSBmYWlsZWQgdG8gbG9hZCIsIHQpOwogICAgICB9KTsKICAgIH0KICB9LAogIGdldFRpdGxlOiBmdW5jdGlvbiBnZXRUaXRsZShlKSB7CiAgICB2YXIgdCA9IHRoaXM7CiAgICBQdSh3dSh0aGlzLmNvbmZpZy51cmxzLnlvdXR1YmUuYXBpLCBlKSkudGhlbihmdW5jdGlvbiAoZSkgewogICAgICBpZiAoU2MoZSkpIHsKICAgICAgICB2YXIgbiA9IGUudGl0bGUsCiAgICAgICAgICAgIGkgPSBlLmhlaWdodCwKICAgICAgICAgICAgciA9IGUud2lkdGg7CiAgICAgICAgdC5jb25maWcudGl0bGUgPSBuLCBZdS5zZXRUaXRsZS5jYWxsKHQpLCB0LmVtYmVkLnJhdGlvID0gW3IsIGldOwogICAgICB9CgogICAgICB2dS5jYWxsKHQpOwogICAgfSkuY2F0Y2goZnVuY3Rpb24gKCkgewogICAgICB2dS5jYWxsKHQpOwogICAgfSk7CiAgfSwKICByZWFkeTogZnVuY3Rpb24gcmVhZHkoKSB7CiAgICB2YXIgZSA9IHRoaXMsCiAgICAgICAgdCA9IGUubWVkaWEgJiYgZS5tZWRpYS5nZXRBdHRyaWJ1dGUoImlkIik7CgogICAgaWYgKF9jKHQpIHx8ICF0LnN0YXJ0c1dpdGgoInlvdXR1YmUtIikpIHsKICAgICAgdmFyIG4gPSBlLm1lZGlhLmdldEF0dHJpYnV0ZSgic3JjIik7CiAgICAgIF9jKG4pICYmIChuID0gZS5tZWRpYS5nZXRBdHRyaWJ1dGUodGhpcy5jb25maWcuYXR0cmlidXRlcy5lbWJlZC5pZCkpOwoKICAgICAgdmFyIGkgPSBmdW5jdGlvbiAoZSkgewogICAgICAgIHJldHVybiBfYyhlKSA/IG51bGwgOiBlLm1hdGNoKC9eLiooeW91dHUuYmVcL3x2XC98dVwvXHdcL3xlbWJlZFwvfHdhdGNoXD92PXwmdj0pKFteIyY/XSopLiovKSA/IFJlZ0V4cC4kMiA6IGU7CiAgICAgIH0obiksCiAgICAgICAgICByID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICByZXR1cm4gIiIuY29uY2F0KGUsICItIikuY29uY2F0KE1hdGguZmxvb3IoMWU0ICogTWF0aC5yYW5kb20oKSkpOwogICAgICB9KGUucHJvdmlkZXIpLAogICAgICAgICAgYSA9IHpjKCJkaXYiLCB7CiAgICAgICAgaWQ6IHIsCiAgICAgICAgImRhdGEtcG9zdGVyIjogZS5wb3N0ZXIKICAgICAgfSk7CgogICAgICBlLm1lZGlhID0gWWMoYSwgZS5tZWRpYSk7CgogICAgICB2YXIgbyA9IGZ1bmN0aW9uIG8oZSkgewogICAgICAgIHJldHVybiAiaHR0cHM6Ly9pLnl0aW1nLmNvbS92aS8iLmNvbmNhdChpLCAiLyIpLmNvbmNhdChlLCAiZGVmYXVsdC5qcGciKTsKICAgICAgfTsKCiAgICAgIEt1KG8oIm1heHJlcyIpLCAxMjEpLmNhdGNoKGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gS3Uobygic2QiKSwgMTIxKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBLdShvKCJocSIpKTsKICAgICAgfSkudGhlbihmdW5jdGlvbiAodCkgewogICAgICAgIHJldHVybiBZdS5zZXRQb3N0ZXIuY2FsbChlLCB0LnNyYyk7CiAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHQpIHsKICAgICAgICB0LmluY2x1ZGVzKCJtYXhyZXMiKSB8fCAoZS5lbGVtZW50cy5wb3N0ZXIuc3R5bGUuYmFja2dyb3VuZFNpemUgPSAiY292ZXIiKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKCkge30pOwogICAgICB2YXIgcyA9IGUuY29uZmlnLnlvdXR1YmU7CiAgICAgIGUuZW1iZWQgPSBuZXcgd2luZG93LllULlBsYXllcihyLCB7CiAgICAgICAgdmlkZW9JZDogaSwKICAgICAgICBob3N0OiB0aChzKSwKICAgICAgICBwbGF5ZXJWYXJzOiBIYyh7fSwgewogICAgICAgICAgYXV0b3BsYXk6IGUuY29uZmlnLmF1dG9wbGF5ID8gMSA6IDAsCiAgICAgICAgICBobDogZS5jb25maWcuaGwsCiAgICAgICAgICBjb250cm9sczogZS5zdXBwb3J0ZWQudWkgPyAwIDogMSwKICAgICAgICAgIGRpc2FibGVrYjogMSwKICAgICAgICAgIHBsYXlzaW5saW5lOiBlLmNvbmZpZy5mdWxsc2NyZWVuLmlvc05hdGl2ZSA/IDAgOiAxLAogICAgICAgICAgY2NfbG9hZF9wb2xpY3k6IGUuY2FwdGlvbnMuYWN0aXZlID8gMSA6IDAsCiAgICAgICAgICBjY19sYW5nX3ByZWY6IGUuY29uZmlnLmNhcHRpb25zLmxhbmd1YWdlLAogICAgICAgICAgd2lkZ2V0X3JlZmVycmVyOiB3aW5kb3cgPyB3aW5kb3cubG9jYXRpb24uaHJlZiA6IG51bGwKICAgICAgICB9LCBzKSwKICAgICAgICBldmVudHM6IHsKICAgICAgICAgIG9uRXJyb3I6IGZ1bmN0aW9uIG9uRXJyb3IodCkgewogICAgICAgICAgICBpZiAoIWUubWVkaWEuZXJyb3IpIHsKICAgICAgICAgICAgICB2YXIgbiA9IHQuZGF0YSwKICAgICAgICAgICAgICAgICAgaSA9IHsKICAgICAgICAgICAgICAgIDI6ICJUaGUgcmVxdWVzdCBjb250YWlucyBhbiBpbnZhbGlkIHBhcmFtZXRlciB2YWx1ZS4gRm9yIGV4YW1wbGUsIHRoaXMgZXJyb3Igb2NjdXJzIGlmIHlvdSBzcGVjaWZ5IGEgdmlkZW8gSUQgdGhhdCBkb2VzIG5vdCBoYXZlIDExIGNoYXJhY3RlcnMsIG9yIGlmIHRoZSB2aWRlbyBJRCBjb250YWlucyBpbnZhbGlkIGNoYXJhY3RlcnMsIHN1Y2ggYXMgZXhjbGFtYXRpb24gcG9pbnRzIG9yIGFzdGVyaXNrcy4iLAogICAgICAgICAgICAgICAgNTogIlRoZSByZXF1ZXN0ZWQgY29udGVudCBjYW5ub3QgYmUgcGxheWVkIGluIGFuIEhUTUw1IHBsYXllciBvciBhbm90aGVyIGVycm9yIHJlbGF0ZWQgdG8gdGhlIEhUTUw1IHBsYXllciBoYXMgb2NjdXJyZWQuIiwKICAgICAgICAgICAgICAgIDEwMDogIlRoZSB2aWRlbyByZXF1ZXN0ZWQgd2FzIG5vdCBmb3VuZC4gVGhpcyBlcnJvciBvY2N1cnMgd2hlbiBhIHZpZGVvIGhhcyBiZWVuIHJlbW92ZWQgKGZvciBhbnkgcmVhc29uKSBvciBoYXMgYmVlbiBtYXJrZWQgYXMgcHJpdmF0ZS4iLAogICAgICAgICAgICAgICAgMTAxOiAiVGhlIG93bmVyIG9mIHRoZSByZXF1ZXN0ZWQgdmlkZW8gZG9lcyBub3QgYWxsb3cgaXQgdG8gYmUgcGxheWVkIGluIGVtYmVkZGVkIHBsYXllcnMuIiwKICAgICAgICAgICAgICAgIDE1MDogIlRoZSBvd25lciBvZiB0aGUgcmVxdWVzdGVkIHZpZGVvIGRvZXMgbm90IGFsbG93IGl0IHRvIGJlIHBsYXllZCBpbiBlbWJlZGRlZCBwbGF5ZXJzLiIKICAgICAgICAgICAgICB9W25dIHx8ICJBbiB1bmtub3duIGVycm9yIG9jY3VyZWQiOwogICAgICAgICAgICAgIGUubWVkaWEuZXJyb3IgPSB7CiAgICAgICAgICAgICAgICBjb2RlOiBuLAogICAgICAgICAgICAgICAgbWVzc2FnZTogaQogICAgICAgICAgICAgIH0sIHV1LmNhbGwoZSwgZS5tZWRpYSwgImVycm9yIik7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBvblBsYXliYWNrUmF0ZUNoYW5nZTogZnVuY3Rpb24gb25QbGF5YmFja1JhdGVDaGFuZ2UodCkgewogICAgICAgICAgICB2YXIgbiA9IHQudGFyZ2V0OwogICAgICAgICAgICBlLm1lZGlhLnBsYXliYWNrUmF0ZSA9IG4uZ2V0UGxheWJhY2tSYXRlKCksIHV1LmNhbGwoZSwgZS5tZWRpYSwgInJhdGVjaGFuZ2UiKTsKICAgICAgICAgIH0sCiAgICAgICAgICBvblJlYWR5OiBmdW5jdGlvbiBvblJlYWR5KHQpIHsKICAgICAgICAgICAgaWYgKCFDYyhlLm1lZGlhLnBsYXkpKSB7CiAgICAgICAgICAgICAgdmFyIG4gPSB0LnRhcmdldDsKICAgICAgICAgICAgICBuaC5nZXRUaXRsZS5jYWxsKGUsIGkpLCBlLm1lZGlhLnBsYXkgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBlaC5jYWxsKGUsICEwKSwgbi5wbGF5VmlkZW8oKTsKICAgICAgICAgICAgICB9LCBlLm1lZGlhLnBhdXNlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZWguY2FsbChlLCAhMSksIG4ucGF1c2VWaWRlbygpOwogICAgICAgICAgICAgIH0sIGUubWVkaWEuc3RvcCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIG4uc3RvcFZpZGVvKCk7CiAgICAgICAgICAgICAgfSwgZS5tZWRpYS5kdXJhdGlvbiA9IG4uZ2V0RHVyYXRpb24oKSwgZS5tZWRpYS5wYXVzZWQgPSAhMCwgZS5tZWRpYS5jdXJyZW50VGltZSA9IDAsIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShlLm1lZGlhLCAiY3VycmVudFRpbWUiLCB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIE51bWJlcihuLmdldEN1cnJlbnRUaW1lKCkpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHQpIHsKICAgICAgICAgICAgICAgICAgZS5wYXVzZWQgJiYgIWUuZW1iZWQuaGFzUGxheWVkICYmIGUuZW1iZWQubXV0ZSgpLCBlLm1lZGlhLnNlZWtpbmcgPSAhMCwgdXUuY2FsbChlLCBlLm1lZGlhLCAic2Vla2luZyIpLCBuLnNlZWtUbyh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUubWVkaWEsICJwbGF5YmFja1JhdGUiLCB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG4uZ2V0UGxheWJhY2tSYXRlKCk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQoZSkgewogICAgICAgICAgICAgICAgICBuLnNldFBsYXliYWNrUmF0ZShlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgciA9IGUuY29uZmlnLnZvbHVtZTsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZS5tZWRpYSwgInZvbHVtZSIsIHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldCh0KSB7CiAgICAgICAgICAgICAgICAgIHIgPSB0LCBuLnNldFZvbHVtZSgxMDAgKiByKSwgdXUuY2FsbChlLCBlLm1lZGlhLCAidm9sdW1lY2hhbmdlIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgdmFyIGEgPSBlLmNvbmZpZy5tdXRlZDsKICAgICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZS5tZWRpYSwgIm11dGVkIiwgewogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBhOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24gc2V0KHQpIHsKICAgICAgICAgICAgICAgICAgdmFyIGkgPSB4Yyh0KSA/IHQgOiBhOwogICAgICAgICAgICAgICAgICBhID0gaSwgbltpID8gIm11dGUiIDogInVuTXV0ZSJdKCksIHV1LmNhbGwoZSwgZS5tZWRpYSwgInZvbHVtZWNoYW5nZSIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0pLCBPYmplY3QuZGVmaW5lUHJvcGVydHkoZS5tZWRpYSwgImN1cnJlbnRTcmMiLCB7CiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgICAgICAgICAgcmV0dXJuIG4uZ2V0VmlkZW9VcmwoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KSwgT2JqZWN0LmRlZmluZVByb3BlcnR5KGUubWVkaWEsICJlbmRlZCIsIHsKICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICAgICAgICByZXR1cm4gZS5jdXJyZW50VGltZSA9PT0gZS5kdXJhdGlvbjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB2YXIgbyA9IG4uZ2V0QXZhaWxhYmxlUGxheWJhY2tSYXRlcygpOwogICAgICAgICAgICAgIGUub3B0aW9ucy5zcGVlZCA9IG8uZmlsdGVyKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZS5jb25maWcuc3BlZWQub3B0aW9ucy5pbmNsdWRlcyh0KTsKICAgICAgICAgICAgICB9KSwgZS5zdXBwb3J0ZWQudWkgJiYgZS5tZWRpYS5zZXRBdHRyaWJ1dGUoInRhYmluZGV4IiwgLTEpLCB1dS5jYWxsKGUsIGUubWVkaWEsICJ0aW1ldXBkYXRlIiksIHV1LmNhbGwoZSwgZS5tZWRpYSwgImR1cmF0aW9uY2hhbmdlIiksIGNsZWFySW50ZXJ2YWwoZS50aW1lcnMuYnVmZmVyaW5nKSwgZS50aW1lcnMuYnVmZmVyaW5nID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgZS5tZWRpYS5idWZmZXJlZCA9IG4uZ2V0VmlkZW9Mb2FkZWRGcmFjdGlvbigpLCAobnVsbCA9PT0gZS5tZWRpYS5sYXN0QnVmZmVyZWQgfHwgZS5tZWRpYS5sYXN0QnVmZmVyZWQgPCBlLm1lZGlhLmJ1ZmZlcmVkKSAmJiB1dS5jYWxsKGUsIGUubWVkaWEsICJwcm9ncmVzcyIpLCBlLm1lZGlhLmxhc3RCdWZmZXJlZCA9IGUubWVkaWEuYnVmZmVyZWQsIDEgPT09IGUubWVkaWEuYnVmZmVyZWQgJiYgKGNsZWFySW50ZXJ2YWwoZS50aW1lcnMuYnVmZmVyaW5nKSwgdXUuY2FsbChlLCBlLm1lZGlhLCAiY2FucGxheXRocm91Z2giKSk7CiAgICAgICAgICAgICAgfSwgMjAwKSwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gWXUuYnVpbGQuY2FsbChlKTsKICAgICAgICAgICAgICB9LCA1MCk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0sCiAgICAgICAgICBvblN0YXRlQ2hhbmdlOiBmdW5jdGlvbiBvblN0YXRlQ2hhbmdlKHQpIHsKICAgICAgICAgICAgdmFyIG4gPSB0LnRhcmdldDsKCiAgICAgICAgICAgIHN3aXRjaCAoY2xlYXJJbnRlcnZhbChlLnRpbWVycy5wbGF5aW5nKSwgZS5tZWRpYS5zZWVraW5nICYmIFsxLCAyXS5pbmNsdWRlcyh0LmRhdGEpICYmIChlLm1lZGlhLnNlZWtpbmcgPSAhMSwgdXUuY2FsbChlLCBlLm1lZGlhLCAic2Vla2VkIikpLCB0LmRhdGEpIHsKICAgICAgICAgICAgICBjYXNlIC0xOgogICAgICAgICAgICAgICAgdXUuY2FsbChlLCBlLm1lZGlhLCAidGltZXVwZGF0ZSIpLCBlLm1lZGlhLmJ1ZmZlcmVkID0gbi5nZXRWaWRlb0xvYWRlZEZyYWN0aW9uKCksIHV1LmNhbGwoZSwgZS5tZWRpYSwgInByb2dyZXNzIik7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSAwOgogICAgICAgICAgICAgICAgZWguY2FsbChlLCAhMSksIGUubWVkaWEubG9vcCA/IChuLnN0b3BWaWRlbygpLCBuLnBsYXlWaWRlbygpKSA6IHV1LmNhbGwoZSwgZS5tZWRpYSwgImVuZGVkIik7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSAxOgogICAgICAgICAgICAgICAgZS5jb25maWcuYXV0b3BsYXkgfHwgIWUubWVkaWEucGF1c2VkIHx8IGUuZW1iZWQuaGFzUGxheWVkID8gKGVoLmNhbGwoZSwgITApLCB1dS5jYWxsKGUsIGUubWVkaWEsICJwbGF5aW5nIiksIGUudGltZXJzLnBsYXlpbmcgPSBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgIHV1LmNhbGwoZSwgZS5tZWRpYSwgInRpbWV1cGRhdGUiKTsKICAgICAgICAgICAgICAgIH0sIDUwKSwgZS5tZWRpYS5kdXJhdGlvbiAhPT0gbi5nZXREdXJhdGlvbigpICYmIChlLm1lZGlhLmR1cmF0aW9uID0gbi5nZXREdXJhdGlvbigpLCB1dS5jYWxsKGUsIGUubWVkaWEsICJkdXJhdGlvbmNoYW5nZSIpKSkgOiBlLm1lZGlhLnBhdXNlKCk7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgICAgY2FzZSAyOgogICAgICAgICAgICAgICAgZS5tdXRlZCB8fCBlLmVtYmVkLnVuTXV0ZSgpLCBlaC5jYWxsKGUsICExKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgICB1dS5jYWxsKGUsIGUubWVkaWEsICJ3YWl0aW5nIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHV1LmNhbGwoZSwgZS5lbGVtZW50cy5jb250YWluZXIsICJzdGF0ZWNoYW5nZSIsICExLCB7CiAgICAgICAgICAgICAgY29kZTogdC5kYXRhCiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfQp9LAogICAgaWggPSB7CiAgc2V0dXA6IGZ1bmN0aW9uIHNldHVwKCkgewogICAgdGhpcy5tZWRpYSA/IChRYyh0aGlzLmVsZW1lbnRzLmNvbnRhaW5lciwgdGhpcy5jb25maWcuY2xhc3NOYW1lcy50eXBlLnJlcGxhY2UoInswfSIsIHRoaXMudHlwZSksICEwKSwgUWModGhpcy5lbGVtZW50cy5jb250YWluZXIsIHRoaXMuY29uZmlnLmNsYXNzTmFtZXMucHJvdmlkZXIucmVwbGFjZSgiezB9IiwgdGhpcy5wcm92aWRlciksICEwKSwgdGhpcy5pc0VtYmVkICYmIFFjKHRoaXMuZWxlbWVudHMuY29udGFpbmVyLCB0aGlzLmNvbmZpZy5jbGFzc05hbWVzLnR5cGUucmVwbGFjZSgiezB9IiwgInZpZGVvIiksICEwKSwgdGhpcy5pc1ZpZGVvICYmICh0aGlzLmVsZW1lbnRzLndyYXBwZXIgPSB6YygiZGl2IiwgewogICAgICBjbGFzczogdGhpcy5jb25maWcuY2xhc3NOYW1lcy52aWRlbwogICAgfSksIEJjKHRoaXMubWVkaWEsIHRoaXMuZWxlbWVudHMud3JhcHBlciksIHRoaXMuZWxlbWVudHMucG9zdGVyID0gemMoImRpdiIsIHsKICAgICAgY2xhc3M6IHRoaXMuY29uZmlnLmNsYXNzTmFtZXMucG9zdGVyCiAgICB9KSwgdGhpcy5lbGVtZW50cy53cmFwcGVyLmFwcGVuZENoaWxkKHRoaXMuZWxlbWVudHMucG9zdGVyKSksIHRoaXMuaXNIVE1MNSA/IHl1LnNldHVwLmNhbGwodGhpcykgOiB0aGlzLmlzWW91VHViZSA/IG5oLnNldHVwLmNhbGwodGhpcykgOiB0aGlzLmlzVmltZW8gJiYgWnUuc2V0dXAuY2FsbCh0aGlzKSkgOiB0aGlzLmRlYnVnLndhcm4oIk5vIG1lZGlhIGVsZW1lbnQgZm91bmQhIik7CiAgfQp9LAogICAgcmggPSBmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gZSh0KSB7CiAgICB2YXIgbiA9IHRoaXM7CiAgICBObCh0aGlzLCBlKSwgdGhpcy5wbGF5ZXIgPSB0LCB0aGlzLmNvbmZpZyA9IHQuY29uZmlnLmFkcywgdGhpcy5wbGF5aW5nID0gITEsIHRoaXMuaW5pdGlhbGl6ZWQgPSAhMSwgdGhpcy5lbGVtZW50cyA9IHsKICAgICAgY29udGFpbmVyOiBudWxsLAogICAgICBkaXNwbGF5Q29udGFpbmVyOiBudWxsCiAgICB9LCB0aGlzLm1hbmFnZXIgPSBudWxsLCB0aGlzLmxvYWRlciA9IG51bGwsIHRoaXMuY3VlUG9pbnRzID0gbnVsbCwgdGhpcy5ldmVudHMgPSB7fSwgdGhpcy5zYWZldHlUaW1lciA9IG51bGwsIHRoaXMuY291bnRkb3duVGltZXIgPSBudWxsLCB0aGlzLm1hbmFnZXJQcm9taXNlID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgbi5vbigibG9hZGVkIiwgZSksIG4ub24oImVycm9yIiwgdCk7CiAgICB9KSwgdGhpcy5sb2FkKCk7CiAgfQoKICByZXR1cm4gamwoZSwgW3sKICAgIGtleTogImxvYWQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgZSA9IHRoaXM7CiAgICAgIHRoaXMuZW5hYmxlZCAmJiAoU2Mod2luZG93Lmdvb2dsZSkgJiYgU2Mod2luZG93Lmdvb2dsZS5pbWEpID8gdGhpcy5yZWFkeSgpIDogUXUodGhpcy5wbGF5ZXIuY29uZmlnLnVybHMuZ29vZ2xlSU1BLnNkaykudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgZS5yZWFkeSgpOwogICAgICB9KS5jYXRjaChmdW5jdGlvbiAoKSB7CiAgICAgICAgZS50cmlnZ2VyKCJlcnJvciIsIG5ldyBFcnJvcigiR29vZ2xlIElNQSBTREsgZmFpbGVkIHRvIGxvYWQiKSk7CiAgICAgIH0pKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZWFkeSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBlID0gdGhpczsKICAgICAgdGhpcy5lbmFibGVkIHx8IGZ1bmN0aW9uIChlKSB7CiAgICAgICAgZS5tYW5hZ2VyICYmIGUubWFuYWdlci5kZXN0cm95KCksIGUuZWxlbWVudHMuZGlzcGxheUNvbnRhaW5lciAmJiBlLmVsZW1lbnRzLmRpc3BsYXlDb250YWluZXIuZGVzdHJveSgpLCBlLmVsZW1lbnRzLmNvbnRhaW5lci5yZW1vdmUoKTsKICAgICAgfSh0aGlzKSwgdGhpcy5zdGFydFNhZmV0eVRpbWVyKDEyZTMsICJyZWFkeSgpIiksIHRoaXMubWFuYWdlclByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgZS5jbGVhclNhZmV0eVRpbWVyKCJvbkFkc01hbmFnZXJMb2FkZWQoKSIpOwogICAgICB9KSwgdGhpcy5saXN0ZW5lcnMoKSwgdGhpcy5zZXR1cElNQSgpOwogICAgfQogIH0sIHsKICAgIGtleTogInNldHVwSU1BIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIGUgPSB0aGlzOwogICAgICB0aGlzLmVsZW1lbnRzLmNvbnRhaW5lciA9IHpjKCJkaXYiLCB7CiAgICAgICAgY2xhc3M6IHRoaXMucGxheWVyLmNvbmZpZy5jbGFzc05hbWVzLmFkcwogICAgICB9KSwgdGhpcy5wbGF5ZXIuZWxlbWVudHMuY29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuZWxlbWVudHMuY29udGFpbmVyKSwgZ29vZ2xlLmltYS5zZXR0aW5ncy5zZXRWcGFpZE1vZGUoZ29vZ2xlLmltYS5JbWFTZGtTZXR0aW5ncy5WcGFpZE1vZGUuRU5BQkxFRCksIGdvb2dsZS5pbWEuc2V0dGluZ3Muc2V0TG9jYWxlKHRoaXMucGxheWVyLmNvbmZpZy5hZHMubGFuZ3VhZ2UpLCBnb29nbGUuaW1hLnNldHRpbmdzLnNldERpc2FibGVDdXN0b21QbGF5YmFja0ZvcklPUzEwUGx1cyh0aGlzLnBsYXllci5jb25maWcucGxheXNpbmxpbmUpLCB0aGlzLmVsZW1lbnRzLmRpc3BsYXlDb250YWluZXIgPSBuZXcgZ29vZ2xlLmltYS5BZERpc3BsYXlDb250YWluZXIodGhpcy5lbGVtZW50cy5jb250YWluZXIsIHRoaXMucGxheWVyLm1lZGlhKSwgdGhpcy5sb2FkZXIgPSBuZXcgZ29vZ2xlLmltYS5BZHNMb2FkZXIodGhpcy5lbGVtZW50cy5kaXNwbGF5Q29udGFpbmVyKSwgdGhpcy5sb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcihnb29nbGUuaW1hLkFkc01hbmFnZXJMb2FkZWRFdmVudC5UeXBlLkFEU19NQU5BR0VSX0xPQURFRCwgZnVuY3Rpb24gKHQpIHsKICAgICAgICByZXR1cm4gZS5vbkFkc01hbmFnZXJMb2FkZWQodCk7CiAgICAgIH0sICExKSwgdGhpcy5sb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcihnb29nbGUuaW1hLkFkRXJyb3JFdmVudC5UeXBlLkFEX0VSUk9SLCBmdW5jdGlvbiAodCkgewogICAgICAgIHJldHVybiBlLm9uQWRFcnJvcih0KTsKICAgICAgfSwgITEpLCB0aGlzLnJlcXVlc3RBZHMoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZXF1ZXN0QWRzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIGUgPSB0aGlzLnBsYXllci5lbGVtZW50cy5jb250YWluZXI7CgogICAgICB0cnkgewogICAgICAgIHZhciB0ID0gbmV3IGdvb2dsZS5pbWEuQWRzUmVxdWVzdCgpOwogICAgICAgIHQuYWRUYWdVcmwgPSB0aGlzLnRhZ1VybCwgdC5saW5lYXJBZFNsb3RXaWR0aCA9IGUub2Zmc2V0V2lkdGgsIHQubGluZWFyQWRTbG90SGVpZ2h0ID0gZS5vZmZzZXRIZWlnaHQsIHQubm9uTGluZWFyQWRTbG90V2lkdGggPSBlLm9mZnNldFdpZHRoLCB0Lm5vbkxpbmVhckFkU2xvdEhlaWdodCA9IGUub2Zmc2V0SGVpZ2h0LCB0LmZvcmNlTm9uTGluZWFyRnVsbFNsb3QgPSAhMSwgdC5zZXRBZFdpbGxQbGF5TXV0ZWQoIXRoaXMucGxheWVyLm11dGVkKSwgdGhpcy5sb2FkZXIucmVxdWVzdEFkcyh0KTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIHRoaXMub25BZEVycm9yKGUpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAicG9sbENvdW50ZG93biIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBlID0gdGhpcywKICAgICAgICAgIHQgPSBhcmd1bWVudHMubGVuZ3RoID4gMCAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1swXSAmJiBhcmd1bWVudHNbMF07CiAgICAgIGlmICghdCkgcmV0dXJuIGNsZWFySW50ZXJ2YWwodGhpcy5jb3VudGRvd25UaW1lciksIHZvaWQgdGhpcy5lbGVtZW50cy5jb250YWluZXIucmVtb3ZlQXR0cmlidXRlKCJkYXRhLWJhZGdlLXRleHQiKTsKCiAgICAgIHZhciBuID0gZnVuY3Rpb24gbigpIHsKICAgICAgICB2YXIgdCA9IE11KE1hdGgubWF4KGUubWFuYWdlci5nZXRSZW1haW5pbmdUaW1lKCksIDApKSwKICAgICAgICAgICAgbiA9ICIiLmNvbmNhdCh4dSgiYWR2ZXJ0aXNlbWVudCIsIGUucGxheWVyLmNvbmZpZyksICIgLSAiKS5jb25jYXQodCk7CiAgICAgICAgZS5lbGVtZW50cy5jb250YWluZXIuc2V0QXR0cmlidXRlKCJkYXRhLWJhZGdlLXRleHQiLCBuKTsKICAgICAgfTsKCiAgICAgIHRoaXMuY291bnRkb3duVGltZXIgPSBzZXRJbnRlcnZhbChuLCAxMDApOwogICAgfQogIH0sIHsKICAgIGtleTogIm9uQWRzTWFuYWdlckxvYWRlZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICB2YXIgdCA9IHRoaXM7CgogICAgICBpZiAodGhpcy5lbmFibGVkKSB7CiAgICAgICAgdmFyIG4gPSBuZXcgZ29vZ2xlLmltYS5BZHNSZW5kZXJpbmdTZXR0aW5ncygpOwogICAgICAgIG4ucmVzdG9yZUN1c3RvbVBsYXliYWNrU3RhdGVPbkFkQnJlYWtDb21wbGV0ZSA9ICEwLCBuLmVuYWJsZVByZWxvYWRpbmcgPSAhMCwgdGhpcy5tYW5hZ2VyID0gZS5nZXRBZHNNYW5hZ2VyKHRoaXMucGxheWVyLCBuKSwgdGhpcy5jdWVQb2ludHMgPSB0aGlzLm1hbmFnZXIuZ2V0Q3VlUG9pbnRzKCksIHRoaXMubWFuYWdlci5hZGRFdmVudExpc3RlbmVyKGdvb2dsZS5pbWEuQWRFcnJvckV2ZW50LlR5cGUuQURfRVJST1IsIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICByZXR1cm4gdC5vbkFkRXJyb3IoZSk7CiAgICAgICAgfSksIE9iamVjdC5rZXlzKGdvb2dsZS5pbWEuQWRFdmVudC5UeXBlKS5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICB0Lm1hbmFnZXIuYWRkRXZlbnRMaXN0ZW5lcihnb29nbGUuaW1hLkFkRXZlbnQuVHlwZVtlXSwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgcmV0dXJuIHQub25BZEV2ZW50KGUpOwogICAgICAgICAgfSk7CiAgICAgICAgfSksIHRoaXMudHJpZ2dlcigibG9hZGVkIik7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJhZGRDdWVQb2ludHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgZSA9IHRoaXM7CiAgICAgIF9jKHRoaXMuY3VlUG9pbnRzKSB8fCB0aGlzLmN1ZVBvaW50cy5mb3JFYWNoKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgaWYgKDAgIT09IHQgJiYgLTEgIT09IHQgJiYgdCA8IGUucGxheWVyLmR1cmF0aW9uKSB7CiAgICAgICAgICB2YXIgbiA9IGUucGxheWVyLmVsZW1lbnRzLnByb2dyZXNzOwoKICAgICAgICAgIGlmIChJYyhuKSkgewogICAgICAgICAgICB2YXIgaSA9IDEwMCAvIGUucGxheWVyLmR1cmF0aW9uICogdCwKICAgICAgICAgICAgICAgIHIgPSB6Yygic3BhbiIsIHsKICAgICAgICAgICAgICBjbGFzczogZS5wbGF5ZXIuY29uZmlnLmNsYXNzTmFtZXMuY3VlcwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgci5zdHlsZS5sZWZ0ID0gIiIuY29uY2F0KGkudG9TdHJpbmcoKSwgIiUiKSwgbi5hcHBlbmRDaGlsZChyKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHsKICAgIGtleTogIm9uQWRFdmVudCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICB2YXIgdCwKICAgICAgICAgIG4gPSB0aGlzLnBsYXllci5lbGVtZW50cy5jb250YWluZXIsCiAgICAgICAgICBpID0gZS5nZXRBZCgpLAogICAgICAgICAgciA9IGUuZ2V0QWREYXRhKCk7CgogICAgICBzd2l0Y2ggKHQgPSBlLnR5cGUsIHV1LmNhbGwodGhpcy5wbGF5ZXIsIHRoaXMucGxheWVyLm1lZGlhLCAiYWRzIi5jb25jYXQodC5yZXBsYWNlKC9fL2csICIiKS50b0xvd2VyQ2FzZSgpKSksIGUudHlwZSkgewogICAgICAgIGNhc2UgZ29vZ2xlLmltYS5BZEV2ZW50LlR5cGUuTE9BREVEOgogICAgICAgICAgdGhpcy50cmlnZ2VyKCJsb2FkZWQiKSwgdGhpcy5wb2xsQ291bnRkb3duKCEwKSwgaS5pc0xpbmVhcigpIHx8IChpLndpZHRoID0gbi5vZmZzZXRXaWR0aCwgaS5oZWlnaHQgPSBuLm9mZnNldEhlaWdodCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBnb29nbGUuaW1hLkFkRXZlbnQuVHlwZS5TVEFSVEVEOgogICAgICAgICAgdGhpcy5tYW5hZ2VyLnNldFZvbHVtZSh0aGlzLnBsYXllci52b2x1bWUpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgZ29vZ2xlLmltYS5BZEV2ZW50LlR5cGUuQUxMX0FEU19DT01QTEVURUQ6CiAgICAgICAgICB0aGlzLnBsYXllci5lbmRlZCA/IHRoaXMubG9hZEFkcygpIDogdGhpcy5sb2FkZXIuY29udGVudENvbXBsZXRlKCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBnb29nbGUuaW1hLkFkRXZlbnQuVHlwZS5DT05URU5UX1BBVVNFX1JFUVVFU1RFRDoKICAgICAgICAgIHRoaXMucGF1c2VDb250ZW50KCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBnb29nbGUuaW1hLkFkRXZlbnQuVHlwZS5DT05URU5UX1JFU1VNRV9SRVFVRVNURUQ6CiAgICAgICAgICB0aGlzLnBvbGxDb3VudGRvd24oKSwgdGhpcy5yZXN1bWVDb250ZW50KCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSBnb29nbGUuaW1hLkFkRXZlbnQuVHlwZS5MT0c6CiAgICAgICAgICByLmFkRXJyb3IgJiYgdGhpcy5wbGF5ZXIuZGVidWcud2FybigiTm9uLWZhdGFsIGFkIGVycm9yOiAiLmNvbmNhdChyLmFkRXJyb3IuZ2V0TWVzc2FnZSgpKSk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJvbkFkRXJyb3IiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGUpIHsKICAgICAgdGhpcy5jYW5jZWwoKSwgdGhpcy5wbGF5ZXIuZGVidWcud2FybigiQWRzIGVycm9yIiwgZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAibGlzdGVuZXJzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIGUsCiAgICAgICAgICB0ID0gdGhpcywKICAgICAgICAgIG4gPSB0aGlzLnBsYXllci5lbGVtZW50cy5jb250YWluZXI7CiAgICAgIHRoaXMucGxheWVyLm9uKCJjYW5wbGF5IiwgZnVuY3Rpb24gKCkgewogICAgICAgIHQuYWRkQ3VlUG9pbnRzKCk7CiAgICAgIH0pLCB0aGlzLnBsYXllci5vbigiZW5kZWQiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdC5sb2FkZXIuY29udGVudENvbXBsZXRlKCk7CiAgICAgIH0pLCB0aGlzLnBsYXllci5vbigidGltZXVwZGF0ZSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlID0gdC5wbGF5ZXIuY3VycmVudFRpbWU7CiAgICAgIH0pLCB0aGlzLnBsYXllci5vbigic2Vla2VkIiwgZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBuID0gdC5wbGF5ZXIuY3VycmVudFRpbWU7CiAgICAgICAgX2ModC5jdWVQb2ludHMpIHx8IHQuY3VlUG9pbnRzLmZvckVhY2goZnVuY3Rpb24gKGksIHIpIHsKICAgICAgICAgIGUgPCBpICYmIGkgPCBuICYmICh0Lm1hbmFnZXIuZGlzY2FyZEFkQnJlYWsoKSwgdC5jdWVQb2ludHMuc3BsaWNlKHIsIDEpKTsKICAgICAgICB9KTsKICAgICAgfSksIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJyZXNpemUiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgdC5tYW5hZ2VyICYmIHQubWFuYWdlci5yZXNpemUobi5vZmZzZXRXaWR0aCwgbi5vZmZzZXRIZWlnaHQsIGdvb2dsZS5pbWEuVmlld01vZGUuTk9STUFMKTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAicGxheSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBlID0gdGhpcywKICAgICAgICAgIHQgPSB0aGlzLnBsYXllci5lbGVtZW50cy5jb250YWluZXI7CiAgICAgIHRoaXMubWFuYWdlclByb21pc2UgfHwgdGhpcy5yZXN1bWVDb250ZW50KCksIHRoaXMubWFuYWdlclByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgZS5tYW5hZ2VyLnNldFZvbHVtZShlLnBsYXllci52b2x1bWUpLCBlLmVsZW1lbnRzLmRpc3BsYXlDb250YWluZXIuaW5pdGlhbGl6ZSgpOwoKICAgICAgICB0cnkgewogICAgICAgICAgZS5pbml0aWFsaXplZCB8fCAoZS5tYW5hZ2VyLmluaXQodC5vZmZzZXRXaWR0aCwgdC5vZmZzZXRIZWlnaHQsIGdvb2dsZS5pbWEuVmlld01vZGUuTk9STUFMKSwgZS5tYW5hZ2VyLnN0YXJ0KCkpLCBlLmluaXRpYWxpemVkID0gITA7CiAgICAgICAgfSBjYXRjaCAodCkgewogICAgICAgICAgZS5vbkFkRXJyb3IodCk7CiAgICAgICAgfQogICAgICB9KS5jYXRjaChmdW5jdGlvbiAoKSB7fSk7CiAgICB9CiAgfSwgewogICAga2V5OiAicmVzdW1lQ29udGVudCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHRoaXMuZWxlbWVudHMuY29udGFpbmVyLnN0eWxlLnpJbmRleCA9ICIiLCB0aGlzLnBsYXlpbmcgPSAhMSwgZnUodGhpcy5wbGF5ZXIubWVkaWEucGxheSgpKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJwYXVzZUNvbnRlbnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB0aGlzLmVsZW1lbnRzLmNvbnRhaW5lci5zdHlsZS56SW5kZXggPSAzLCB0aGlzLnBsYXlpbmcgPSAhMCwgdGhpcy5wbGF5ZXIubWVkaWEucGF1c2UoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjYW5jZWwiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB0aGlzLmluaXRpYWxpemVkICYmIHRoaXMucmVzdW1lQ29udGVudCgpLCB0aGlzLnRyaWdnZXIoImVycm9yIiksIHRoaXMubG9hZEFkcygpOwogICAgfQogIH0sIHsKICAgIGtleTogImxvYWRBZHMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgZSA9IHRoaXM7CiAgICAgIHRoaXMubWFuYWdlclByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgZS5tYW5hZ2VyICYmIGUubWFuYWdlci5kZXN0cm95KCksIGUubWFuYWdlclByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAodCkgewogICAgICAgICAgZS5vbigibG9hZGVkIiwgdCksIGUucGxheWVyLmRlYnVnLmxvZyhlLm1hbmFnZXIpOwogICAgICAgIH0pLCBlLmluaXRpYWxpemVkID0gITEsIGUucmVxdWVzdEFkcygpOwogICAgICB9KS5jYXRjaChmdW5jdGlvbiAoKSB7fSk7CiAgICB9CiAgfSwgewogICAga2V5OiAidHJpZ2dlciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICBmb3IgKHZhciB0ID0gdGhpcywgbiA9IGFyZ3VtZW50cy5sZW5ndGgsIGkgPSBuZXcgQXJyYXkobiA+IDEgPyBuIC0gMSA6IDApLCByID0gMTsgciA8IG47IHIrKykgewogICAgICAgIGlbciAtIDFdID0gYXJndW1lbnRzW3JdOwogICAgICB9CgogICAgICB2YXIgYSA9IHRoaXMuZXZlbnRzW2VdOwogICAgICBQYyhhKSAmJiBhLmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgICAgICBDYyhlKSAmJiBlLmFwcGx5KHQsIGkpOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSwgdCkgewogICAgICByZXR1cm4gUGModGhpcy5ldmVudHNbZV0pIHx8ICh0aGlzLmV2ZW50c1tlXSA9IFtdKSwgdGhpcy5ldmVudHNbZV0ucHVzaCh0KSwgdGhpczsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzdGFydFNhZmV0eVRpbWVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShlLCB0KSB7CiAgICAgIHZhciBuID0gdGhpczsKICAgICAgdGhpcy5wbGF5ZXIuZGVidWcubG9nKCJTYWZldHkgdGltZXIgaW52b2tlZCBmcm9tOiAiLmNvbmNhdCh0KSksIHRoaXMuc2FmZXR5VGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICBuLmNhbmNlbCgpLCBuLmNsZWFyU2FmZXR5VGltZXIoInN0YXJ0U2FmZXR5VGltZXIoKSIpOwogICAgICB9LCBlKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjbGVhclNhZmV0eVRpbWVyIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShlKSB7CiAgICAgIFRjKHRoaXMuc2FmZXR5VGltZXIpIHx8ICh0aGlzLnBsYXllci5kZWJ1Zy5sb2coIlNhZmV0eSB0aW1lciBjbGVhcmVkIGZyb206ICIuY29uY2F0KGUpKSwgY2xlYXJUaW1lb3V0KHRoaXMuc2FmZXR5VGltZXIpLCB0aGlzLnNhZmV0eVRpbWVyID0gbnVsbCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZW5hYmxlZCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIGUgPSB0aGlzLmNvbmZpZzsKICAgICAgcmV0dXJuIHRoaXMucGxheWVyLmlzSFRNTDUgJiYgdGhpcy5wbGF5ZXIuaXNWaWRlbyAmJiBlLmVuYWJsZWQgJiYgKCFfYyhlLnB1Ymxpc2hlcklkKSB8fCBSYyhlLnRhZ1VybCkpOwogICAgfQogIH0sIHsKICAgIGtleTogInRhZ1VybCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgdmFyIGUgPSB0aGlzLmNvbmZpZzsKICAgICAgaWYgKFJjKGUudGFnVXJsKSkgcmV0dXJuIGUudGFnVXJsOwogICAgICB2YXIgdCA9IHsKICAgICAgICBBVl9QVUJMSVNIRVJJRDogIjU4YzI1YmIwMDczZWY0NDhiMTA4N2FkNiIsCiAgICAgICAgQVZfQ0hBTk5FTElEOiAiNWEwNDU4ZGMyOGEwNjE0NWU0NTE5ZDIxIiwKICAgICAgICBBVl9VUkw6IHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZSwKICAgICAgICBjYjogRGF0ZS5ub3coKSwKICAgICAgICBBVl9XSURUSDogNjQwLAogICAgICAgIEFWX0hFSUdIVDogNDgwLAogICAgICAgIEFWX0NESU0yOiBlLnB1Ymxpc2hlcklkCiAgICAgIH07CiAgICAgIHJldHVybiAiIi5jb25jYXQoImh0dHBzOi8vZ28uYW5pdmlldy5jb20vYXBpL2Fkc2VydmVyNi92YXN0LyIsICI/IikuY29uY2F0KF91KHQpKTsKICAgIH0KICB9XSksIGU7Cn0oKSwKICAgIGFoID0gZnVuY3Rpb24gYWgoZSkgewogIHZhciB0ID0gW107CiAgcmV0dXJuIGUuc3BsaXQoL1xyXG5cclxufFxuXG58XHJcci8pLmZvckVhY2goZnVuY3Rpb24gKGUpIHsKICAgIHZhciBuID0ge307CiAgICBlLnNwbGl0KC9cclxufFxufFxyLykuZm9yRWFjaChmdW5jdGlvbiAoZSkgewogICAgICBpZiAoRWMobi5zdGFydFRpbWUpKSB7CiAgICAgICAgaWYgKCFfYyhlLnRyaW0oKSkgJiYgX2Mobi50ZXh0KSkgewogICAgICAgICAgdmFyIHQgPSBlLnRyaW0oKS5zcGxpdCgiI3h5d2g9IiksCiAgICAgICAgICAgICAgaSA9IHFsKHQsIDEpOwoKICAgICAgICAgIGlmIChuLnRleHQgPSBpWzBdLCB0WzFdKSB7CiAgICAgICAgICAgIHZhciByID0gcWwodFsxXS5zcGxpdCgiLCIpLCA0KTsKICAgICAgICAgICAgbi54ID0gclswXSwgbi55ID0gclsxXSwgbi53ID0gclsyXSwgbi5oID0gclszXTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGEgPSBlLm1hdGNoKC8oWzAtOV17Mn0pPzo/KFswLTldezJ9KTooWzAtOV17Mn0pLihbMC05XXsyLDN9KSggPy0tPiA/KShbMC05XXsyfSk/Oj8oWzAtOV17Mn0pOihbMC05XXsyfSkuKFswLTldezIsM30pLyk7CiAgICAgICAgYSAmJiAobi5zdGFydFRpbWUgPSA2MCAqIE51bWJlcihhWzFdIHx8IDApICogNjAgKyA2MCAqIE51bWJlcihhWzJdKSArIE51bWJlcihhWzNdKSArIE51bWJlcigiMC4iLmNvbmNhdChhWzRdKSksIG4uZW5kVGltZSA9IDYwICogTnVtYmVyKGFbNl0gfHwgMCkgKiA2MCArIDYwICogTnVtYmVyKGFbN10pICsgTnVtYmVyKGFbOF0pICsgTnVtYmVyKCIwLiIuY29uY2F0KGFbOV0pKSk7CiAgICAgIH0KICAgIH0pLCBuLnRleHQgJiYgdC5wdXNoKG4pOwogIH0pLCB0Owp9LAogICAgb2ggPSBmdW5jdGlvbiBvaChlLCB0KSB7CiAgdmFyIG4gPSB7fTsKICByZXR1cm4gZSA+IHQud2lkdGggLyB0LmhlaWdodCA/IChuLndpZHRoID0gdC53aWR0aCwgbi5oZWlnaHQgPSAxIC8gZSAqIHQud2lkdGgpIDogKG4uaGVpZ2h0ID0gdC5oZWlnaHQsIG4ud2lkdGggPSBlICogdC5oZWlnaHQpLCBuOwp9LAogICAgc2ggPSBmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gZSh0KSB7CiAgICBObCh0aGlzLCBlKSwgdGhpcy5wbGF5ZXIgPSB0LCB0aGlzLnRodW1ibmFpbHMgPSBbXSwgdGhpcy5sb2FkZWQgPSAhMSwgdGhpcy5sYXN0TW91c2VNb3ZlVGltZSA9IERhdGUubm93KCksIHRoaXMubW91c2VEb3duID0gITEsIHRoaXMubG9hZGVkSW1hZ2VzID0gW10sIHRoaXMuZWxlbWVudHMgPSB7CiAgICAgIHRodW1iOiB7fSwKICAgICAgc2NydWJiaW5nOiB7fQogICAgfSwgdGhpcy5sb2FkKCk7CiAgfQoKICByZXR1cm4gamwoZSwgW3sKICAgIGtleTogImxvYWQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgZSA9IHRoaXM7CiAgICAgIHRoaXMucGxheWVyLmVsZW1lbnRzLmRpc3BsYXkuc2Vla1Rvb2x0aXAgJiYgKHRoaXMucGxheWVyLmVsZW1lbnRzLmRpc3BsYXkuc2Vla1Rvb2x0aXAuaGlkZGVuID0gdGhpcy5lbmFibGVkKSwgdGhpcy5lbmFibGVkICYmIHRoaXMuZ2V0VGh1bWJuYWlscygpLnRoZW4oZnVuY3Rpb24gKCkgewogICAgICAgIGUuZW5hYmxlZCAmJiAoZS5yZW5kZXIoKSwgZS5kZXRlcm1pbmVDb250YWluZXJBdXRvU2l6aW5nKCksIGUubG9hZGVkID0gITApOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJnZXRUaHVtYm5haWxzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIGUgPSB0aGlzOwogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHQpIHsKICAgICAgICB2YXIgbiA9IGUucGxheWVyLmNvbmZpZy5wcmV2aWV3VGh1bWJuYWlscy5zcmM7CiAgICAgICAgaWYgKF9jKG4pKSB0aHJvdyBuZXcgRXJyb3IoIk1pc3NpbmcgcHJldmlld1RodW1ibmFpbHMuc3JjIGNvbmZpZyBhdHRyaWJ1dGUiKTsKCiAgICAgICAgdmFyIGkgPSBmdW5jdGlvbiBpKCkgewogICAgICAgICAgZS50aHVtYm5haWxzLnNvcnQoZnVuY3Rpb24gKGUsIHQpIHsKICAgICAgICAgICAgcmV0dXJuIGUuaGVpZ2h0IC0gdC5oZWlnaHQ7CiAgICAgICAgICB9KSwgZS5wbGF5ZXIuZGVidWcubG9nKCJQcmV2aWV3IHRodW1ibmFpbHMiLCBlLnRodW1ibmFpbHMpLCB0KCk7CiAgICAgICAgfTsKCiAgICAgICAgaWYgKENjKG4pKSBuKGZ1bmN0aW9uICh0KSB7CiAgICAgICAgICBlLnRodW1ibmFpbHMgPSB0LCBpKCk7CiAgICAgICAgfSk7ZWxzZSB7CiAgICAgICAgICB2YXIgciA9IChBYyhuKSA/IFtuXSA6IG4pLm1hcChmdW5jdGlvbiAodCkgewogICAgICAgICAgICByZXR1cm4gZS5nZXRUaHVtYm5haWwodCk7CiAgICAgICAgICB9KTsKICAgICAgICAgIFByb21pc2UuYWxsKHIpLnRoZW4oaSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJnZXRUaHVtYm5haWwiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGUpIHsKICAgICAgdmFyIHQgPSB0aGlzOwogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKG4pIHsKICAgICAgICBQdShlKS50aGVuKGZ1bmN0aW9uIChpKSB7CiAgICAgICAgICB2YXIgciA9IHsKICAgICAgICAgICAgZnJhbWVzOiBhaChpKSwKICAgICAgICAgICAgaGVpZ2h0OiBudWxsLAogICAgICAgICAgICB1cmxQcmVmaXg6ICIiCiAgICAgICAgICB9OwogICAgICAgICAgci5mcmFtZXNbMF0udGV4dC5zdGFydHNXaXRoKCIvIikgfHwgci5mcmFtZXNbMF0udGV4dC5zdGFydHNXaXRoKCJodHRwOi8vIikgfHwgci5mcmFtZXNbMF0udGV4dC5zdGFydHNXaXRoKCJodHRwczovLyIpIHx8IChyLnVybFByZWZpeCA9IGUuc3Vic3RyaW5nKDAsIGUubGFzdEluZGV4T2YoIi8iKSArIDEpKTsKICAgICAgICAgIHZhciBhID0gbmV3IEltYWdlKCk7CiAgICAgICAgICBhLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgci5oZWlnaHQgPSBhLm5hdHVyYWxIZWlnaHQsIHIud2lkdGggPSBhLm5hdHVyYWxXaWR0aCwgdC50aHVtYm5haWxzLnB1c2gociksIG4oKTsKICAgICAgICAgIH0sIGEuc3JjID0gci51cmxQcmVmaXggKyByLmZyYW1lc1swXS50ZXh0OwogICAgICAgIH0pOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzdGFydE1vdmUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGUpIHsKICAgICAgaWYgKHRoaXMubG9hZGVkICYmIExjKGUpICYmIFsidG91Y2htb3ZlIiwgIm1vdXNlbW92ZSJdLmluY2x1ZGVzKGUudHlwZSkgJiYgdGhpcy5wbGF5ZXIubWVkaWEuZHVyYXRpb24pIHsKICAgICAgICBpZiAoInRvdWNobW92ZSIgPT09IGUudHlwZSkgdGhpcy5zZWVrVGltZSA9IHRoaXMucGxheWVyLm1lZGlhLmR1cmF0aW9uICogKHRoaXMucGxheWVyLmVsZW1lbnRzLmlucHV0cy5zZWVrLnZhbHVlIC8gMTAwKTtlbHNlIHsKICAgICAgICAgIHZhciB0ID0gdGhpcy5wbGF5ZXIuZWxlbWVudHMucHJvZ3Jlc3MuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksCiAgICAgICAgICAgICAgbiA9IDEwMCAvIHQud2lkdGggKiAoZS5wYWdlWCAtIHQubGVmdCk7CiAgICAgICAgICB0aGlzLnNlZWtUaW1lID0gdGhpcy5wbGF5ZXIubWVkaWEuZHVyYXRpb24gKiAobiAvIDEwMCksIHRoaXMuc2Vla1RpbWUgPCAwICYmICh0aGlzLnNlZWtUaW1lID0gMCksIHRoaXMuc2Vla1RpbWUgPiB0aGlzLnBsYXllci5tZWRpYS5kdXJhdGlvbiAtIDEgJiYgKHRoaXMuc2Vla1RpbWUgPSB0aGlzLnBsYXllci5tZWRpYS5kdXJhdGlvbiAtIDEpLCB0aGlzLm1vdXNlUG9zWCA9IGUucGFnZVgsIHRoaXMuZWxlbWVudHMudGh1bWIudGltZS5pbm5lclRleHQgPSBNdSh0aGlzLnNlZWtUaW1lKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5zaG93SW1hZ2VBdEN1cnJlbnRUaW1lKCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJlbmRNb3ZlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdGhpcy50b2dnbGVUaHVtYkNvbnRhaW5lcighMSwgITApOwogICAgfQogIH0sIHsKICAgIGtleTogInN0YXJ0U2NydWJiaW5nIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShlKSB7CiAgICAgIChUYyhlLmJ1dHRvbikgfHwgITEgPT09IGUuYnV0dG9uIHx8IDAgPT09IGUuYnV0dG9uKSAmJiAodGhpcy5tb3VzZURvd24gPSAhMCwgdGhpcy5wbGF5ZXIubWVkaWEuZHVyYXRpb24gJiYgKHRoaXMudG9nZ2xlU2NydWJiaW5nQ29udGFpbmVyKCEwKSwgdGhpcy50b2dnbGVUaHVtYkNvbnRhaW5lcighMSwgITApLCB0aGlzLnNob3dJbWFnZUF0Q3VycmVudFRpbWUoKSkpOwogICAgfQogIH0sIHsKICAgIGtleTogImVuZFNjcnViYmluZyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBlID0gdGhpczsKICAgICAgdGhpcy5tb3VzZURvd24gPSAhMSwgTWF0aC5jZWlsKHRoaXMubGFzdFRpbWUpID09PSBNYXRoLmNlaWwodGhpcy5wbGF5ZXIubWVkaWEuY3VycmVudFRpbWUpID8gdGhpcy50b2dnbGVTY3J1YmJpbmdDb250YWluZXIoITEpIDogY3UuY2FsbCh0aGlzLnBsYXllciwgdGhpcy5wbGF5ZXIubWVkaWEsICJ0aW1ldXBkYXRlIiwgZnVuY3Rpb24gKCkgewogICAgICAgIGUubW91c2VEb3duIHx8IGUudG9nZ2xlU2NydWJiaW5nQ29udGFpbmVyKCExKTsKICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAibGlzdGVuZXJzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIGUgPSB0aGlzOwogICAgICB0aGlzLnBsYXllci5vbigicGxheSIsIGZ1bmN0aW9uICgpIHsKICAgICAgICBlLnRvZ2dsZVRodW1iQ29udGFpbmVyKCExLCAhMCk7CiAgICAgIH0pLCB0aGlzLnBsYXllci5vbigic2Vla2VkIiwgZnVuY3Rpb24gKCkgewogICAgICAgIGUudG9nZ2xlVGh1bWJDb250YWluZXIoITEpOwogICAgICB9KSwgdGhpcy5wbGF5ZXIub24oInRpbWV1cGRhdGUiLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgZS5sYXN0VGltZSA9IGUucGxheWVyLm1lZGlhLmN1cnJlbnRUaW1lOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZW5kZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB0aGlzLmVsZW1lbnRzLnRodW1iLmNvbnRhaW5lciA9IHpjKCJkaXYiLCB7CiAgICAgICAgY2xhc3M6IHRoaXMucGxheWVyLmNvbmZpZy5jbGFzc05hbWVzLnByZXZpZXdUaHVtYm5haWxzLnRodW1iQ29udGFpbmVyCiAgICAgIH0pLCB0aGlzLmVsZW1lbnRzLnRodW1iLmltYWdlQ29udGFpbmVyID0gemMoImRpdiIsIHsKICAgICAgICBjbGFzczogdGhpcy5wbGF5ZXIuY29uZmlnLmNsYXNzTmFtZXMucHJldmlld1RodW1ibmFpbHMuaW1hZ2VDb250YWluZXIKICAgICAgfSksIHRoaXMuZWxlbWVudHMudGh1bWIuY29udGFpbmVyLmFwcGVuZENoaWxkKHRoaXMuZWxlbWVudHMudGh1bWIuaW1hZ2VDb250YWluZXIpOwogICAgICB2YXIgZSA9IHpjKCJkaXYiLCB7CiAgICAgICAgY2xhc3M6IHRoaXMucGxheWVyLmNvbmZpZy5jbGFzc05hbWVzLnByZXZpZXdUaHVtYm5haWxzLnRpbWVDb250YWluZXIKICAgICAgfSk7CiAgICAgIHRoaXMuZWxlbWVudHMudGh1bWIudGltZSA9IHpjKCJzcGFuIiwge30sICIwMDowMCIpLCBlLmFwcGVuZENoaWxkKHRoaXMuZWxlbWVudHMudGh1bWIudGltZSksIHRoaXMuZWxlbWVudHMudGh1bWIuY29udGFpbmVyLmFwcGVuZENoaWxkKGUpLCBJYyh0aGlzLnBsYXllci5lbGVtZW50cy5wcm9ncmVzcykgJiYgdGhpcy5wbGF5ZXIuZWxlbWVudHMucHJvZ3Jlc3MuYXBwZW5kQ2hpbGQodGhpcy5lbGVtZW50cy50aHVtYi5jb250YWluZXIpLCB0aGlzLmVsZW1lbnRzLnNjcnViYmluZy5jb250YWluZXIgPSB6YygiZGl2IiwgewogICAgICAgIGNsYXNzOiB0aGlzLnBsYXllci5jb25maWcuY2xhc3NOYW1lcy5wcmV2aWV3VGh1bWJuYWlscy5zY3J1YmJpbmdDb250YWluZXIKICAgICAgfSksIHRoaXMucGxheWVyLmVsZW1lbnRzLndyYXBwZXIuYXBwZW5kQ2hpbGQodGhpcy5lbGVtZW50cy5zY3J1YmJpbmcuY29udGFpbmVyKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJkZXN0cm95IiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdGhpcy5lbGVtZW50cy50aHVtYi5jb250YWluZXIgJiYgdGhpcy5lbGVtZW50cy50aHVtYi5jb250YWluZXIucmVtb3ZlKCksIHRoaXMuZWxlbWVudHMuc2NydWJiaW5nLmNvbnRhaW5lciAmJiB0aGlzLmVsZW1lbnRzLnNjcnViYmluZy5jb250YWluZXIucmVtb3ZlKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2hvd0ltYWdlQXRDdXJyZW50VGltZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBlID0gdGhpczsKICAgICAgdGhpcy5tb3VzZURvd24gPyB0aGlzLnNldFNjcnViYmluZ0NvbnRhaW5lclNpemUoKSA6IHRoaXMuc2V0VGh1bWJDb250YWluZXJTaXplQW5kUG9zKCk7CiAgICAgIHZhciB0ID0gdGhpcy50aHVtYm5haWxzWzBdLmZyYW1lcy5maW5kSW5kZXgoZnVuY3Rpb24gKHQpIHsKICAgICAgICByZXR1cm4gZS5zZWVrVGltZSA+PSB0LnN0YXJ0VGltZSAmJiBlLnNlZWtUaW1lIDw9IHQuZW5kVGltZTsKICAgICAgfSksCiAgICAgICAgICBuID0gdCA+PSAwLAogICAgICAgICAgaSA9IDA7CiAgICAgIHRoaXMubW91c2VEb3duIHx8IHRoaXMudG9nZ2xlVGh1bWJDb250YWluZXIobiksIG4gJiYgKHRoaXMudGh1bWJuYWlscy5mb3JFYWNoKGZ1bmN0aW9uIChuLCByKSB7CiAgICAgICAgZS5sb2FkZWRJbWFnZXMuaW5jbHVkZXMobi5mcmFtZXNbdF0udGV4dCkgJiYgKGkgPSByKTsKICAgICAgfSksIHQgIT09IHRoaXMuc2hvd2luZ1RodW1iICYmICh0aGlzLnNob3dpbmdUaHVtYiA9IHQsIHRoaXMubG9hZEltYWdlKGkpKSk7CiAgICB9CiAgfSwgewogICAga2V5OiAibG9hZEltYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgdmFyIGUgPSB0aGlzLAogICAgICAgICAgdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdID8gYXJndW1lbnRzWzBdIDogMCwKICAgICAgICAgIG4gPSB0aGlzLnNob3dpbmdUaHVtYiwKICAgICAgICAgIGkgPSB0aGlzLnRodW1ibmFpbHNbdF0sCiAgICAgICAgICByID0gaS51cmxQcmVmaXgsCiAgICAgICAgICBhID0gaS5mcmFtZXNbbl0sCiAgICAgICAgICBvID0gaS5mcmFtZXNbbl0udGV4dCwKICAgICAgICAgIHMgPSByICsgbzsKICAgICAgaWYgKHRoaXMuY3VycmVudEltYWdlRWxlbWVudCAmJiB0aGlzLmN1cnJlbnRJbWFnZUVsZW1lbnQuZGF0YXNldC5maWxlbmFtZSA9PT0gbykgdGhpcy5zaG93SW1hZ2UodGhpcy5jdXJyZW50SW1hZ2VFbGVtZW50LCBhLCB0LCBuLCBvLCAhMSksIHRoaXMuY3VycmVudEltYWdlRWxlbWVudC5kYXRhc2V0LmluZGV4ID0gbiwgdGhpcy5yZW1vdmVPbGRJbWFnZXModGhpcy5jdXJyZW50SW1hZ2VFbGVtZW50KTtlbHNlIHsKICAgICAgICB0aGlzLmxvYWRpbmdJbWFnZSAmJiB0aGlzLnVzaW5nU3ByaXRlcyAmJiAodGhpcy5sb2FkaW5nSW1hZ2Uub25sb2FkID0gbnVsbCk7CiAgICAgICAgdmFyIGwgPSBuZXcgSW1hZ2UoKTsKICAgICAgICBsLnNyYyA9IHMsIGwuZGF0YXNldC5pbmRleCA9IG4sIGwuZGF0YXNldC5maWxlbmFtZSA9IG8sIHRoaXMuc2hvd2luZ1RodW1iRmlsZW5hbWUgPSBvLCB0aGlzLnBsYXllci5kZWJ1Zy5sb2coIkxvYWRpbmcgaW1hZ2U6ICIuY29uY2F0KHMpKSwgbC5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXR1cm4gZS5zaG93SW1hZ2UobCwgYSwgdCwgbiwgbywgITApOwogICAgICAgIH0sIHRoaXMubG9hZGluZ0ltYWdlID0gbCwgdGhpcy5yZW1vdmVPbGRJbWFnZXMobCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJzaG93SW1hZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGUsIHQsIG4sIGksIHIpIHsKICAgICAgdmFyIGEgPSAhKGFyZ3VtZW50cy5sZW5ndGggPiA1ICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzVdKSB8fCBhcmd1bWVudHNbNV07CiAgICAgIHRoaXMucGxheWVyLmRlYnVnLmxvZygiU2hvd2luZyB0aHVtYjogIi5jb25jYXQociwgIi4gbnVtOiAiKS5jb25jYXQoaSwgIi4gcXVhbDogIikuY29uY2F0KG4sICIuIG5ld2ltZzogIikuY29uY2F0KGEpKSwgdGhpcy5zZXRJbWFnZVNpemVBbmRPZmZzZXQoZSwgdCksIGEgJiYgKHRoaXMuY3VycmVudEltYWdlQ29udGFpbmVyLmFwcGVuZENoaWxkKGUpLCB0aGlzLmN1cnJlbnRJbWFnZUVsZW1lbnQgPSBlLCB0aGlzLmxvYWRlZEltYWdlcy5pbmNsdWRlcyhyKSB8fCB0aGlzLmxvYWRlZEltYWdlcy5wdXNoKHIpKSwgdGhpcy5wcmVsb2FkTmVhcmJ5KGksICEwKS50aGVuKHRoaXMucHJlbG9hZE5lYXJieShpLCAhMSkpLnRoZW4odGhpcy5nZXRIaWdoZXJRdWFsaXR5KG4sIGUsIHQsIHIpKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJyZW1vdmVPbGRJbWFnZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGUpIHsKICAgICAgdmFyIHQgPSB0aGlzOwogICAgICBBcnJheS5mcm9tKHRoaXMuY3VycmVudEltYWdlQ29udGFpbmVyLmNoaWxkcmVuKS5mb3JFYWNoKGZ1bmN0aW9uIChuKSB7CiAgICAgICAgaWYgKCJpbWciID09PSBuLnRhZ05hbWUudG9Mb3dlckNhc2UoKSkgewogICAgICAgICAgdmFyIGkgPSB0LnVzaW5nU3ByaXRlcyA/IDUwMCA6IDFlMzsKCiAgICAgICAgICBpZiAobi5kYXRhc2V0LmluZGV4ICE9PSBlLmRhdGFzZXQuaW5kZXggJiYgIW4uZGF0YXNldC5kZWxldGluZykgewogICAgICAgICAgICBuLmRhdGFzZXQuZGVsZXRpbmcgPSAhMDsKICAgICAgICAgICAgdmFyIHIgPSB0LmN1cnJlbnRJbWFnZUNvbnRhaW5lcjsKICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgci5yZW1vdmVDaGlsZChuKSwgdC5wbGF5ZXIuZGVidWcubG9nKCJSZW1vdmluZyB0aHVtYjogIi5jb25jYXQobi5kYXRhc2V0LmZpbGVuYW1lKSk7CiAgICAgICAgICAgIH0sIGkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwgewogICAga2V5OiAicHJlbG9hZE5lYXJieSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICBuID0gIShhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSkgfHwgYXJndW1lbnRzWzFdOwogICAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKGkpIHsKICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciByID0gdC50aHVtYm5haWxzWzBdLmZyYW1lc1tlXS50ZXh0OwoKICAgICAgICAgIGlmICh0LnNob3dpbmdUaHVtYkZpbGVuYW1lID09PSByKSB7CiAgICAgICAgICAgIHZhciBhOwogICAgICAgICAgICBhID0gbiA/IHQudGh1bWJuYWlsc1swXS5mcmFtZXMuc2xpY2UoZSkgOiB0LnRodW1ibmFpbHNbMF0uZnJhbWVzLnNsaWNlKDAsIGUpLnJldmVyc2UoKTsKICAgICAgICAgICAgdmFyIG8gPSAhMTsKICAgICAgICAgICAgYS5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgICAgdmFyIG4gPSBlLnRleHQ7CgogICAgICAgICAgICAgIGlmIChuICE9PSByICYmICF0LmxvYWRlZEltYWdlcy5pbmNsdWRlcyhuKSkgewogICAgICAgICAgICAgICAgbyA9ICEwLCB0LnBsYXllci5kZWJ1Zy5sb2coIlByZWxvYWRpbmcgdGh1bWIgZmlsZW5hbWU6ICIuY29uY2F0KG4pKTsKICAgICAgICAgICAgICAgIHZhciBhID0gdC50aHVtYm5haWxzWzBdLnVybFByZWZpeCArIG4sCiAgICAgICAgICAgICAgICAgICAgcyA9IG5ldyBJbWFnZSgpOwogICAgICAgICAgICAgICAgcy5zcmMgPSBhLCBzLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgdC5wbGF5ZXIuZGVidWcubG9nKCJQcmVsb2FkZWQgdGh1bWIgZmlsZW5hbWU6ICIuY29uY2F0KG4pKSwgdC5sb2FkZWRJbWFnZXMuaW5jbHVkZXMobikgfHwgdC5sb2FkZWRJbWFnZXMucHVzaChuKSwgaSgpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pLCBvIHx8IGkoKTsKICAgICAgICAgIH0KICAgICAgICB9LCAzMDApOwogICAgICB9KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJnZXRIaWdoZXJRdWFsaXR5IiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShlLCB0LCBuLCBpKSB7CiAgICAgIHZhciByID0gdGhpczsKCiAgICAgIGlmIChlIDwgdGhpcy50aHVtYm5haWxzLmxlbmd0aCAtIDEpIHsKICAgICAgICB2YXIgYSA9IHQubmF0dXJhbEhlaWdodDsKICAgICAgICB0aGlzLnVzaW5nU3ByaXRlcyAmJiAoYSA9IG4uaCksIGEgPCB0aGlzLnRodW1iQ29udGFpbmVySGVpZ2h0ICYmIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgci5zaG93aW5nVGh1bWJGaWxlbmFtZSA9PT0gaSAmJiAoci5wbGF5ZXIuZGVidWcubG9nKCJTaG93aW5nIGhpZ2hlciBxdWFsaXR5IHRodW1iIGZvcjogIi5jb25jYXQoaSkpLCByLmxvYWRJbWFnZShlICsgMSkpOwogICAgICAgIH0sIDMwMCk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJ0b2dnbGVUaHVtYkNvbnRhaW5lciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBlID0gYXJndW1lbnRzLmxlbmd0aCA+IDAgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbMF0gJiYgYXJndW1lbnRzWzBdLAogICAgICAgICAgdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzFdICYmIGFyZ3VtZW50c1sxXSwKICAgICAgICAgIG4gPSB0aGlzLnBsYXllci5jb25maWcuY2xhc3NOYW1lcy5wcmV2aWV3VGh1bWJuYWlscy50aHVtYkNvbnRhaW5lclNob3duOwogICAgICB0aGlzLmVsZW1lbnRzLnRodW1iLmNvbnRhaW5lci5jbGFzc0xpc3QudG9nZ2xlKG4sIGUpLCAhZSAmJiB0ICYmICh0aGlzLnNob3dpbmdUaHVtYiA9IG51bGwsIHRoaXMuc2hvd2luZ1RodW1iRmlsZW5hbWUgPSBudWxsKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ0b2dnbGVTY3J1YmJpbmdDb250YWluZXIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdICYmIGFyZ3VtZW50c1swXSwKICAgICAgICAgIHQgPSB0aGlzLnBsYXllci5jb25maWcuY2xhc3NOYW1lcy5wcmV2aWV3VGh1bWJuYWlscy5zY3J1YmJpbmdDb250YWluZXJTaG93bjsKICAgICAgdGhpcy5lbGVtZW50cy5zY3J1YmJpbmcuY29udGFpbmVyLmNsYXNzTGlzdC50b2dnbGUodCwgZSksIGUgfHwgKHRoaXMuc2hvd2luZ1RodW1iID0gbnVsbCwgdGhpcy5zaG93aW5nVGh1bWJGaWxlbmFtZSA9IG51bGwpOwogICAgfQogIH0sIHsKICAgIGtleTogImRldGVybWluZUNvbnRhaW5lckF1dG9TaXppbmciLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICAodGhpcy5lbGVtZW50cy50aHVtYi5pbWFnZUNvbnRhaW5lci5jbGllbnRIZWlnaHQgPiAyMCB8fCB0aGlzLmVsZW1lbnRzLnRodW1iLmltYWdlQ29udGFpbmVyLmNsaWVudFdpZHRoID4gMjApICYmICh0aGlzLnNpemVTcGVjaWZpZWRJbkNTUyA9ICEwKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRUaHVtYkNvbnRhaW5lclNpemVBbmRQb3MiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICBpZiAodGhpcy5zaXplU3BlY2lmaWVkSW5DU1MpIHsKICAgICAgICBpZiAodGhpcy5lbGVtZW50cy50aHVtYi5pbWFnZUNvbnRhaW5lci5jbGllbnRIZWlnaHQgPiAyMCAmJiB0aGlzLmVsZW1lbnRzLnRodW1iLmltYWdlQ29udGFpbmVyLmNsaWVudFdpZHRoIDwgMjApIHsKICAgICAgICAgIHZhciBlID0gTWF0aC5mbG9vcih0aGlzLmVsZW1lbnRzLnRodW1iLmltYWdlQ29udGFpbmVyLmNsaWVudEhlaWdodCAqIHRoaXMudGh1bWJBc3BlY3RSYXRpbyk7CiAgICAgICAgICB0aGlzLmVsZW1lbnRzLnRodW1iLmltYWdlQ29udGFpbmVyLnN0eWxlLndpZHRoID0gIiIuY29uY2F0KGUsICJweCIpOwogICAgICAgIH0gZWxzZSBpZiAodGhpcy5lbGVtZW50cy50aHVtYi5pbWFnZUNvbnRhaW5lci5jbGllbnRIZWlnaHQgPCAyMCAmJiB0aGlzLmVsZW1lbnRzLnRodW1iLmltYWdlQ29udGFpbmVyLmNsaWVudFdpZHRoID4gMjApIHsKICAgICAgICAgIHZhciB0ID0gTWF0aC5mbG9vcih0aGlzLmVsZW1lbnRzLnRodW1iLmltYWdlQ29udGFpbmVyLmNsaWVudFdpZHRoIC8gdGhpcy50aHVtYkFzcGVjdFJhdGlvKTsKICAgICAgICAgIHRoaXMuZWxlbWVudHMudGh1bWIuaW1hZ2VDb250YWluZXIuc3R5bGUuaGVpZ2h0ID0gIiIuY29uY2F0KHQsICJweCIpOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgbiA9IE1hdGguZmxvb3IodGhpcy50aHVtYkNvbnRhaW5lckhlaWdodCAqIHRoaXMudGh1bWJBc3BlY3RSYXRpbyk7CiAgICAgICAgdGhpcy5lbGVtZW50cy50aHVtYi5pbWFnZUNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSAiIi5jb25jYXQodGhpcy50aHVtYkNvbnRhaW5lckhlaWdodCwgInB4IiksIHRoaXMuZWxlbWVudHMudGh1bWIuaW1hZ2VDb250YWluZXIuc3R5bGUud2lkdGggPSAiIi5jb25jYXQobiwgInB4Iik7CiAgICAgIH0KCiAgICAgIHRoaXMuc2V0VGh1bWJDb250YWluZXJQb3MoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzZXRUaHVtYkNvbnRhaW5lclBvcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHZhciBlID0gdGhpcy5wbGF5ZXIuZWxlbWVudHMucHJvZ3Jlc3MuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksCiAgICAgICAgICB0ID0gdGhpcy5wbGF5ZXIuZWxlbWVudHMuY29udGFpbmVyLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLAogICAgICAgICAgbiA9IHRoaXMuZWxlbWVudHMudGh1bWIuY29udGFpbmVyLAogICAgICAgICAgaSA9IHQubGVmdCAtIGUubGVmdCArIDEwLAogICAgICAgICAgciA9IHQucmlnaHQgLSBlLmxlZnQgLSBuLmNsaWVudFdpZHRoIC0gMTAsCiAgICAgICAgICBhID0gdGhpcy5tb3VzZVBvc1ggLSBlLmxlZnQgLSBuLmNsaWVudFdpZHRoIC8gMjsKICAgICAgYSA8IGkgJiYgKGEgPSBpKSwgYSA+IHIgJiYgKGEgPSByKSwgbi5zdHlsZS5sZWZ0ID0gIiIuY29uY2F0KGEsICJweCIpOwogICAgfQogIH0sIHsKICAgIGtleTogInNldFNjcnViYmluZ0NvbnRhaW5lclNpemUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgZSA9IG9oKHRoaXMudGh1bWJBc3BlY3RSYXRpbywgewogICAgICAgIHdpZHRoOiB0aGlzLnBsYXllci5tZWRpYS5jbGllbnRXaWR0aCwKICAgICAgICBoZWlnaHQ6IHRoaXMucGxheWVyLm1lZGlhLmNsaWVudEhlaWdodAogICAgICB9KSwKICAgICAgICAgIHQgPSBlLndpZHRoLAogICAgICAgICAgbiA9IGUuaGVpZ2h0OwogICAgICB0aGlzLmVsZW1lbnRzLnNjcnViYmluZy5jb250YWluZXIuc3R5bGUud2lkdGggPSAiIi5jb25jYXQodCwgInB4IiksIHRoaXMuZWxlbWVudHMuc2NydWJiaW5nLmNvbnRhaW5lci5zdHlsZS5oZWlnaHQgPSAiIi5jb25jYXQobiwgInB4Iik7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0SW1hZ2VTaXplQW5kT2Zmc2V0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShlLCB0KSB7CiAgICAgIGlmICh0aGlzLnVzaW5nU3ByaXRlcykgewogICAgICAgIHZhciBuID0gdGhpcy50aHVtYkNvbnRhaW5lckhlaWdodCAvIHQuaDsKICAgICAgICBlLnN0eWxlLmhlaWdodCA9ICIiLmNvbmNhdChlLm5hdHVyYWxIZWlnaHQgKiBuLCAicHgiKSwgZS5zdHlsZS53aWR0aCA9ICIiLmNvbmNhdChlLm5hdHVyYWxXaWR0aCAqIG4sICJweCIpLCBlLnN0eWxlLmxlZnQgPSAiLSIuY29uY2F0KHQueCAqIG4sICJweCIpLCBlLnN0eWxlLnRvcCA9ICItIi5jb25jYXQodC55ICogbiwgInB4Iik7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJlbmFibGVkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5wbGF5ZXIuaXNIVE1MNSAmJiB0aGlzLnBsYXllci5pc1ZpZGVvICYmIHRoaXMucGxheWVyLmNvbmZpZy5wcmV2aWV3VGh1bWJuYWlscy5lbmFibGVkOwogICAgfQogIH0sIHsKICAgIGtleTogImN1cnJlbnRJbWFnZUNvbnRhaW5lciIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMubW91c2VEb3duID8gdGhpcy5lbGVtZW50cy5zY3J1YmJpbmcuY29udGFpbmVyIDogdGhpcy5lbGVtZW50cy50aHVtYi5pbWFnZUNvbnRhaW5lcjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ1c2luZ1Nwcml0ZXMiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBPYmplY3Qua2V5cyh0aGlzLnRodW1ibmFpbHNbMF0uZnJhbWVzWzBdKS5pbmNsdWRlcygidyIpOwogICAgfQogIH0sIHsKICAgIGtleTogInRodW1iQXNwZWN0UmF0aW8iLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLnVzaW5nU3ByaXRlcyA/IHRoaXMudGh1bWJuYWlsc1swXS5mcmFtZXNbMF0udyAvIHRoaXMudGh1bWJuYWlsc1swXS5mcmFtZXNbMF0uaCA6IHRoaXMudGh1bWJuYWlsc1swXS53aWR0aCAvIHRoaXMudGh1bWJuYWlsc1swXS5oZWlnaHQ7CiAgICB9CiAgfSwgewogICAga2V5OiAidGh1bWJDb250YWluZXJIZWlnaHQiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLm1vdXNlRG93biA/IG9oKHRoaXMudGh1bWJBc3BlY3RSYXRpbywgewogICAgICAgIHdpZHRoOiB0aGlzLnBsYXllci5tZWRpYS5jbGllbnRXaWR0aCwKICAgICAgICBoZWlnaHQ6IHRoaXMucGxheWVyLm1lZGlhLmNsaWVudEhlaWdodAogICAgICB9KS5oZWlnaHQgOiB0aGlzLnNpemVTcGVjaWZpZWRJbkNTUyA/IHRoaXMuZWxlbWVudHMudGh1bWIuaW1hZ2VDb250YWluZXIuY2xpZW50SGVpZ2h0IDogTWF0aC5mbG9vcih0aGlzLnBsYXllci5tZWRpYS5jbGllbnRXaWR0aCAvIHRoaXMudGh1bWJBc3BlY3RSYXRpbyAvIDQpOwogICAgfQogIH0sIHsKICAgIGtleTogImN1cnJlbnRJbWFnZUVsZW1lbnQiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLm1vdXNlRG93biA/IHRoaXMuY3VycmVudFNjcnViYmluZ0ltYWdlRWxlbWVudCA6IHRoaXMuY3VycmVudFRodW1ibmFpbEltYWdlRWxlbWVudDsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlKSB7CiAgICAgIHRoaXMubW91c2VEb3duID8gdGhpcy5jdXJyZW50U2NydWJiaW5nSW1hZ2VFbGVtZW50ID0gZSA6IHRoaXMuY3VycmVudFRodW1ibmFpbEltYWdlRWxlbWVudCA9IGU7CiAgICB9CiAgfV0pLCBlOwp9KCksCiAgICBsaCA9IHsKICBpbnNlcnRFbGVtZW50czogZnVuY3Rpb24gaW5zZXJ0RWxlbWVudHMoZSwgdCkgewogICAgdmFyIG4gPSB0aGlzOwogICAgQWModCkgPyBXYyhlLCB0aGlzLm1lZGlhLCB7CiAgICAgIHNyYzogdAogICAgfSkgOiBQYyh0KSAmJiB0LmZvckVhY2goZnVuY3Rpb24gKHQpIHsKICAgICAgV2MoZSwgbi5tZWRpYSwgdCk7CiAgICB9KTsKICB9LAogIGNoYW5nZTogZnVuY3Rpb24gY2hhbmdlKGUpIHsKICAgIHZhciB0ID0gdGhpczsKICAgIFVjKGUsICJzb3VyY2VzLmxlbmd0aCIpID8gKHl1LmNhbmNlbFJlcXVlc3RzLmNhbGwodGhpcyksIHRoaXMuZGVzdHJveS5jYWxsKHRoaXMsIGZ1bmN0aW9uICgpIHsKICAgICAgdC5vcHRpb25zLnF1YWxpdHkgPSBbXSwgJGModC5tZWRpYSksIHQubWVkaWEgPSBudWxsLCBJYyh0LmVsZW1lbnRzLmNvbnRhaW5lcikgJiYgdC5lbGVtZW50cy5jb250YWluZXIucmVtb3ZlQXR0cmlidXRlKCJjbGFzcyIpOwogICAgICB2YXIgbiA9IGUuc291cmNlcywKICAgICAgICAgIGkgPSBlLnR5cGUsCiAgICAgICAgICByID0gcWwobiwgMSlbMF0sCiAgICAgICAgICBhID0gci5wcm92aWRlciwKICAgICAgICAgIG8gPSB2b2lkIDAgPT09IGEgPyBIdS5odG1sNSA6IGEsCiAgICAgICAgICBzID0gci5zcmMsCiAgICAgICAgICBsID0gImh0bWw1IiA9PT0gbyA/IGkgOiAiZGl2IiwKICAgICAgICAgIGMgPSAiaHRtbDUiID09PSBvID8ge30gOiB7CiAgICAgICAgc3JjOiBzCiAgICAgIH07CiAgICAgIE9iamVjdC5hc3NpZ24odCwgewogICAgICAgIHByb3ZpZGVyOiBvLAogICAgICAgIHR5cGU6IGksCiAgICAgICAgc3VwcG9ydGVkOiBydS5jaGVjayhpLCBvLCB0LmNvbmZpZy5wbGF5c2lubGluZSksCiAgICAgICAgbWVkaWE6IHpjKGwsIGMpCiAgICAgIH0pLCB0LmVsZW1lbnRzLmNvbnRhaW5lci5hcHBlbmRDaGlsZCh0Lm1lZGlhKSwgeGMoZS5hdXRvcGxheSkgJiYgKHQuY29uZmlnLmF1dG9wbGF5ID0gZS5hdXRvcGxheSksIHQuaXNIVE1MNSAmJiAodC5jb25maWcuY3Jvc3NvcmlnaW4gJiYgdC5tZWRpYS5zZXRBdHRyaWJ1dGUoImNyb3Nzb3JpZ2luIiwgIiIpLCB0LmNvbmZpZy5hdXRvcGxheSAmJiB0Lm1lZGlhLnNldEF0dHJpYnV0ZSgiYXV0b3BsYXkiLCAiIiksIF9jKGUucG9zdGVyKSB8fCAodC5wb3N0ZXIgPSBlLnBvc3RlciksIHQuY29uZmlnLmxvb3AuYWN0aXZlICYmIHQubWVkaWEuc2V0QXR0cmlidXRlKCJsb29wIiwgIiIpLCB0LmNvbmZpZy5tdXRlZCAmJiB0Lm1lZGlhLnNldEF0dHJpYnV0ZSgibXV0ZWQiLCAiIiksIHQuY29uZmlnLnBsYXlzaW5saW5lICYmIHQubWVkaWEuc2V0QXR0cmlidXRlKCJwbGF5c2lubGluZSIsICIiKSksIFl1LmFkZFN0eWxlSG9vay5jYWxsKHQpLCB0LmlzSFRNTDUgJiYgbGguaW5zZXJ0RWxlbWVudHMuY2FsbCh0LCAic291cmNlIiwgbiksIHQuY29uZmlnLnRpdGxlID0gZS50aXRsZSwgaWguc2V0dXAuY2FsbCh0KSwgdC5pc0hUTUw1ICYmIE9iamVjdC5rZXlzKGUpLmluY2x1ZGVzKCJ0cmFja3MiKSAmJiBsaC5pbnNlcnRFbGVtZW50cy5jYWxsKHQsICJ0cmFjayIsIGUudHJhY2tzKSwgKHQuaXNIVE1MNSB8fCB0LmlzRW1iZWQgJiYgIXQuc3VwcG9ydGVkLnVpKSAmJiBZdS5idWlsZC5jYWxsKHQpLCB0LmlzSFRNTDUgJiYgdC5tZWRpYS5sb2FkKCksIF9jKGUucHJldmlld1RodW1ibmFpbHMpIHx8IChPYmplY3QuYXNzaWduKHQuY29uZmlnLnByZXZpZXdUaHVtYm5haWxzLCBlLnByZXZpZXdUaHVtYm5haWxzKSwgdC5wcmV2aWV3VGh1bWJuYWlscyAmJiB0LnByZXZpZXdUaHVtYm5haWxzLmxvYWRlZCAmJiAodC5wcmV2aWV3VGh1bWJuYWlscy5kZXN0cm95KCksIHQucHJldmlld1RodW1ibmFpbHMgPSBudWxsKSwgdC5jb25maWcucHJldmlld1RodW1ibmFpbHMuZW5hYmxlZCAmJiAodC5wcmV2aWV3VGh1bWJuYWlscyA9IG5ldyBzaCh0KSkpLCB0LmZ1bGxzY3JlZW4udXBkYXRlKCk7CiAgICB9LCAhMCkpIDogdGhpcy5kZWJ1Zy53YXJuKCJJbnZhbGlkIHNvdXJjZSBmb3JtYXQiKTsKICB9Cn07Cgp2YXIgY2ggPSBmdW5jdGlvbiAoKSB7CiAgZnVuY3Rpb24gZSh0LCBuKSB7CiAgICB2YXIgaSA9IHRoaXM7CiAgICBpZiAoTmwodGhpcywgZSksIHRoaXMudGltZXJzID0ge30sIHRoaXMucmVhZHkgPSAhMSwgdGhpcy5sb2FkaW5nID0gITEsIHRoaXMuZmFpbGVkID0gITEsIHRoaXMudG91Y2ggPSBydS50b3VjaCwgdGhpcy5tZWRpYSA9IHQsIEFjKHRoaXMubWVkaWEpICYmICh0aGlzLm1lZGlhID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCh0aGlzLm1lZGlhKSksICh3aW5kb3cualF1ZXJ5ICYmIHRoaXMubWVkaWEgaW5zdGFuY2VvZiBqUXVlcnkgfHwgT2ModGhpcy5tZWRpYSkgfHwgUGModGhpcy5tZWRpYSkpICYmICh0aGlzLm1lZGlhID0gdGhpcy5tZWRpYVswXSksIHRoaXMuY29uZmlnID0gSGMoe30sIEZ1LCBlLmRlZmF1bHRzLCBuIHx8IHt9LCBmdW5jdGlvbiAoKSB7CiAgICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UoaS5tZWRpYS5nZXRBdHRyaWJ1dGUoImRhdGEtcGx5ci1jb25maWciKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4ge307CiAgICAgIH0KICAgIH0oKSksIHRoaXMuZWxlbWVudHMgPSB7CiAgICAgIGNvbnRhaW5lcjogbnVsbCwKICAgICAgZnVsbHNjcmVlbjogbnVsbCwKICAgICAgY2FwdGlvbnM6IG51bGwsCiAgICAgIGJ1dHRvbnM6IHt9LAogICAgICBkaXNwbGF5OiB7fSwKICAgICAgcHJvZ3Jlc3M6IHt9LAogICAgICBpbnB1dHM6IHt9LAogICAgICBzZXR0aW5nczogewogICAgICAgIHBvcHVwOiBudWxsLAogICAgICAgIG1lbnU6IG51bGwsCiAgICAgICAgcGFuZWxzOiB7fSwKICAgICAgICBidXR0b25zOiB7fQogICAgICB9CiAgICB9LCB0aGlzLmNhcHRpb25zID0gewogICAgICBhY3RpdmU6IG51bGwsCiAgICAgIGN1cnJlbnRUcmFjazogLTEsCiAgICAgIG1ldGE6IG5ldyBXZWFrTWFwKCkKICAgIH0sIHRoaXMuZnVsbHNjcmVlbiA9IHsKICAgICAgYWN0aXZlOiAhMQogICAgfSwgdGhpcy5vcHRpb25zID0gewogICAgICBzcGVlZDogW10sCiAgICAgIHF1YWxpdHk6IFtdCiAgICB9LCB0aGlzLmRlYnVnID0gbmV3IFd1KHRoaXMuY29uZmlnLmRlYnVnKSwgdGhpcy5kZWJ1Zy5sb2coIkNvbmZpZyIsIHRoaXMuY29uZmlnKSwgdGhpcy5kZWJ1Zy5sb2coIlN1cHBvcnQiLCBydSksICFUYyh0aGlzLm1lZGlhKSAmJiBJYyh0aGlzLm1lZGlhKSkgewogICAgICBpZiAodGhpcy5tZWRpYS5wbHlyKSB0aGlzLmRlYnVnLndhcm4oIlRhcmdldCBhbHJlYWR5IHNldHVwIik7ZWxzZSBpZiAodGhpcy5jb25maWcuZW5hYmxlZCkgewogICAgICAgIGlmIChydS5jaGVjaygpLmFwaSkgewogICAgICAgICAgdmFyIHIgPSB0aGlzLm1lZGlhLmNsb25lTm9kZSghMCk7CiAgICAgICAgICByLmF1dG9wbGF5ID0gITEsIHRoaXMuZWxlbWVudHMub3JpZ2luYWwgPSByOwogICAgICAgICAgdmFyIGEgPSB0aGlzLm1lZGlhLnRhZ05hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgICBvID0gbnVsbCwKICAgICAgICAgICAgICBzID0gbnVsbDsKCiAgICAgICAgICBzd2l0Y2ggKGEpIHsKICAgICAgICAgICAgY2FzZSAiZGl2IjoKICAgICAgICAgICAgICBpZiAobyA9IHRoaXMubWVkaWEucXVlcnlTZWxlY3RvcigiaWZyYW1lIiksIEljKG8pKSB7CiAgICAgICAgICAgICAgICBpZiAocyA9IFJ1KG8uZ2V0QXR0cmlidXRlKCJzcmMiKSksIHRoaXMucHJvdmlkZXIgPSBmdW5jdGlvbiAoZSkgewogICAgICAgICAgICAgICAgICByZXR1cm4gL14oaHR0cHM/OlwvXC8pPyh3d3dcLik/KHlvdXR1YmVcLmNvbXx5b3V0dWJlLW5vY29va2llXC5jb218eW91dHVcLj9iZSlcLy4rJC8udGVzdChlKSA/IEh1LnlvdXR1YmUgOiAvXmh0dHBzPzpcL1wvcGxheWVyLnZpbWVvLmNvbVwvdmlkZW9cL1xkezAsOX0oPz1cYnxcLykvLnRlc3QoZSkgPyBIdS52aW1lbyA6IG51bGw7CiAgICAgICAgICAgICAgICB9KHMudG9TdHJpbmcoKSksIHRoaXMuZWxlbWVudHMuY29udGFpbmVyID0gdGhpcy5tZWRpYSwgdGhpcy5tZWRpYSA9IG8sIHRoaXMuZWxlbWVudHMuY29udGFpbmVyLmNsYXNzTmFtZSA9ICIiLCBzLnNlYXJjaC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgdmFyIGwgPSBbIjEiLCAidHJ1ZSJdOwogICAgICAgICAgICAgICAgICBsLmluY2x1ZGVzKHMuc2VhcmNoUGFyYW1zLmdldCgiYXV0b3BsYXkiKSkgJiYgKHRoaXMuY29uZmlnLmF1dG9wbGF5ID0gITApLCBsLmluY2x1ZGVzKHMuc2VhcmNoUGFyYW1zLmdldCgibG9vcCIpKSAmJiAodGhpcy5jb25maWcubG9vcC5hY3RpdmUgPSAhMCksIHRoaXMuaXNZb3VUdWJlID8gKHRoaXMuY29uZmlnLnBsYXlzaW5saW5lID0gbC5pbmNsdWRlcyhzLnNlYXJjaFBhcmFtcy5nZXQoInBsYXlzaW5saW5lIikpLCB0aGlzLmNvbmZpZy55b3V0dWJlLmhsID0gcy5zZWFyY2hQYXJhbXMuZ2V0KCJobCIpKSA6IHRoaXMuY29uZmlnLnBsYXlzaW5saW5lID0gITA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIHRoaXMucHJvdmlkZXIgPSB0aGlzLm1lZGlhLmdldEF0dHJpYnV0ZSh0aGlzLmNvbmZpZy5hdHRyaWJ1dGVzLmVtYmVkLnByb3ZpZGVyKSwgdGhpcy5tZWRpYS5yZW1vdmVBdHRyaWJ1dGUodGhpcy5jb25maWcuYXR0cmlidXRlcy5lbWJlZC5wcm92aWRlcik7CgogICAgICAgICAgICAgIGlmIChfYyh0aGlzLnByb3ZpZGVyKSB8fCAhT2JqZWN0LmtleXMoSHUpLmluY2x1ZGVzKHRoaXMucHJvdmlkZXIpKSByZXR1cm4gdm9pZCB0aGlzLmRlYnVnLmVycm9yKCJTZXR1cCBmYWlsZWQ6IEludmFsaWQgcHJvdmlkZXIiKTsKICAgICAgICAgICAgICB0aGlzLnR5cGUgPSBWdTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgInZpZGVvIjoKICAgICAgICAgICAgY2FzZSAiYXVkaW8iOgogICAgICAgICAgICAgIHRoaXMudHlwZSA9IGEsIHRoaXMucHJvdmlkZXIgPSBIdS5odG1sNSwgdGhpcy5tZWRpYS5oYXNBdHRyaWJ1dGUoImNyb3Nzb3JpZ2luIikgJiYgKHRoaXMuY29uZmlnLmNyb3Nzb3JpZ2luID0gITApLCB0aGlzLm1lZGlhLmhhc0F0dHJpYnV0ZSgiYXV0b3BsYXkiKSAmJiAodGhpcy5jb25maWcuYXV0b3BsYXkgPSAhMCksICh0aGlzLm1lZGlhLmhhc0F0dHJpYnV0ZSgicGxheXNpbmxpbmUiKSB8fCB0aGlzLm1lZGlhLmhhc0F0dHJpYnV0ZSgid2Via2l0LXBsYXlzaW5saW5lIikpICYmICh0aGlzLmNvbmZpZy5wbGF5c2lubGluZSA9ICEwKSwgdGhpcy5tZWRpYS5oYXNBdHRyaWJ1dGUoIm11dGVkIikgJiYgKHRoaXMuY29uZmlnLm11dGVkID0gITApLCB0aGlzLm1lZGlhLmhhc0F0dHJpYnV0ZSgibG9vcCIpICYmICh0aGlzLmNvbmZpZy5sb29wLmFjdGl2ZSA9ICEwKTsKICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgcmV0dXJuIHZvaWQgdGhpcy5kZWJ1Zy5lcnJvcigiU2V0dXAgZmFpbGVkOiB1bnN1cHBvcnRlZCB0eXBlIik7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5zdXBwb3J0ZWQgPSBydS5jaGVjayh0aGlzLnR5cGUsIHRoaXMucHJvdmlkZXIsIHRoaXMuY29uZmlnLnBsYXlzaW5saW5lKSwgdGhpcy5zdXBwb3J0ZWQuYXBpID8gKHRoaXMuZXZlbnRMaXN0ZW5lcnMgPSBbXSwgdGhpcy5saXN0ZW5lcnMgPSBuZXcgR3UodGhpcyksIHRoaXMuc3RvcmFnZSA9IG5ldyBDdSh0aGlzKSwgdGhpcy5tZWRpYS5wbHlyID0gdGhpcywgSWModGhpcy5lbGVtZW50cy5jb250YWluZXIpIHx8ICh0aGlzLmVsZW1lbnRzLmNvbnRhaW5lciA9IHpjKCJkaXYiLCB7CiAgICAgICAgICAgIHRhYmluZGV4OiAwCiAgICAgICAgICB9KSwgQmModGhpcy5tZWRpYSwgdGhpcy5lbGVtZW50cy5jb250YWluZXIpKSwgWXUubWlncmF0ZVN0eWxlcy5jYWxsKHRoaXMpLCBZdS5hZGRTdHlsZUhvb2suY2FsbCh0aGlzKSwgaWguc2V0dXAuY2FsbCh0aGlzKSwgdGhpcy5jb25maWcuZGVidWcgJiYgc3UuY2FsbCh0aGlzLCB0aGlzLmVsZW1lbnRzLmNvbnRhaW5lciwgdGhpcy5jb25maWcuZXZlbnRzLmpvaW4oIiAiKSwgZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgaS5kZWJ1Zy5sb2coImV2ZW50OiAiLmNvbmNhdChlLnR5cGUpKTsKICAgICAgICAgIH0pLCB0aGlzLmZ1bGxzY3JlZW4gPSBuZXcgJHUodGhpcyksICh0aGlzLmlzSFRNTDUgfHwgdGhpcy5pc0VtYmVkICYmICF0aGlzLnN1cHBvcnRlZC51aSkgJiYgWXUuYnVpbGQuY2FsbCh0aGlzKSwgdGhpcy5saXN0ZW5lcnMuY29udGFpbmVyKCksIHRoaXMubGlzdGVuZXJzLmdsb2JhbCgpLCB0aGlzLmNvbmZpZy5hZHMuZW5hYmxlZCAmJiAodGhpcy5hZHMgPSBuZXcgcmgodGhpcykpLCB0aGlzLmlzSFRNTDUgJiYgdGhpcy5jb25maWcuYXV0b3BsYXkgJiYgdGhpcy5vbmNlKCJjYW5wbGF5IiwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICByZXR1cm4gZnUoaS5wbGF5KCkpOwogICAgICAgICAgfSksIHRoaXMubGFzdFNlZWtUaW1lID0gMCwgdGhpcy5jb25maWcucHJldmlld1RodW1ibmFpbHMuZW5hYmxlZCAmJiAodGhpcy5wcmV2aWV3VGh1bWJuYWlscyA9IG5ldyBzaCh0aGlzKSkpIDogdGhpcy5kZWJ1Zy5lcnJvcigiU2V0dXAgZmFpbGVkOiBubyBzdXBwb3J0Iik7CiAgICAgICAgfSBlbHNlIHRoaXMuZGVidWcuZXJyb3IoIlNldHVwIGZhaWxlZDogbm8gc3VwcG9ydCIpOwogICAgICB9IGVsc2UgdGhpcy5kZWJ1Zy5lcnJvcigiU2V0dXAgZmFpbGVkOiBkaXNhYmxlZCBieSBjb25maWciKTsKICAgIH0gZWxzZSB0aGlzLmRlYnVnLmVycm9yKCJTZXR1cCBmYWlsZWQ6IG5vIHN1aXRhYmxlIGVsZW1lbnQgcGFzc2VkIik7CiAgfQoKICByZXR1cm4gamwoZSwgW3sKICAgIGtleTogInBsYXkiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKCkgewogICAgICB2YXIgZSA9IHRoaXM7CiAgICAgIHJldHVybiBDYyh0aGlzLm1lZGlhLnBsYXkpID8gKHRoaXMuYWRzICYmIHRoaXMuYWRzLmVuYWJsZWQgJiYgdGhpcy5hZHMubWFuYWdlclByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIGUuYWRzLnBsYXkoKTsKICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBmdShlLm1lZGlhLnBsYXkoKSk7CiAgICAgIH0pLCB0aGlzLm1lZGlhLnBsYXkoKSkgOiBudWxsOwogICAgfQogIH0sIHsKICAgIGtleTogInBhdXNlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSgpIHsKICAgICAgcmV0dXJuIHRoaXMucGxheWluZyAmJiBDYyh0aGlzLm1lZGlhLnBhdXNlKSA/IHRoaXMubWVkaWEucGF1c2UoKSA6IG51bGw7CiAgICB9CiAgfSwgewogICAga2V5OiAidG9nZ2xlUGxheSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICByZXR1cm4gKHhjKGUpID8gZSA6ICF0aGlzLnBsYXlpbmcpID8gdGhpcy5wbGF5KCkgOiB0aGlzLnBhdXNlKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAic3RvcCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHRoaXMuaXNIVE1MNSA/ICh0aGlzLnBhdXNlKCksIHRoaXMucmVzdGFydCgpKSA6IENjKHRoaXMubWVkaWEuc3RvcCkgJiYgdGhpcy5tZWRpYS5zdG9wKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAicmVzdGFydCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHRoaXMuY3VycmVudFRpbWUgPSAwOwogICAgfQogIH0sIHsKICAgIGtleTogInJld2luZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICB0aGlzLmN1cnJlbnRUaW1lIC09IEVjKGUpID8gZSA6IHRoaXMuY29uZmlnLnNlZWtUaW1lOwogICAgfQogIH0sIHsKICAgIGtleTogImZvcndhcmQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKGUpIHsKICAgICAgdGhpcy5jdXJyZW50VGltZSArPSBFYyhlKSA/IGUgOiB0aGlzLmNvbmZpZy5zZWVrVGltZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpbmNyZWFzZVZvbHVtZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICB2YXIgdCA9IHRoaXMubWVkaWEubXV0ZWQgPyAwIDogdGhpcy52b2x1bWU7CiAgICAgIHRoaXMudm9sdW1lID0gdCArIChFYyhlKSA/IGUgOiAwKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJkZWNyZWFzZVZvbHVtZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICB0aGlzLmluY3JlYXNlVm9sdW1lKC1lKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ0b2dnbGVDYXB0aW9ucyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICBEdS50b2dnbGUuY2FsbCh0aGlzLCBlLCAhMSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiYWlycGxheSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgIHJ1LmFpcnBsYXkgJiYgdGhpcy5tZWRpYS53ZWJraXRTaG93UGxheWJhY2tUYXJnZXRQaWNrZXIoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJ0b2dnbGVDb250cm9scyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICBpZiAodGhpcy5zdXBwb3J0ZWQudWkgJiYgIXRoaXMuaXNBdWRpbykgewogICAgICAgIHZhciB0ID0gSmModGhpcy5lbGVtZW50cy5jb250YWluZXIsIHRoaXMuY29uZmlnLmNsYXNzTmFtZXMuaGlkZUNvbnRyb2xzKSwKICAgICAgICAgICAgbiA9IHZvaWQgMCA9PT0gZSA/IHZvaWQgMCA6ICFlLAogICAgICAgICAgICBpID0gUWModGhpcy5lbGVtZW50cy5jb250YWluZXIsIHRoaXMuY29uZmlnLmNsYXNzTmFtZXMuaGlkZUNvbnRyb2xzLCBuKTsKCiAgICAgICAgaWYgKGkgJiYgUGModGhpcy5jb25maWcuY29udHJvbHMpICYmIHRoaXMuY29uZmlnLmNvbnRyb2xzLmluY2x1ZGVzKCJzZXR0aW5ncyIpICYmICFfYyh0aGlzLmNvbmZpZy5zZXR0aW5ncykgJiYganUudG9nZ2xlTWVudS5jYWxsKHRoaXMsICExKSwgaSAhPT0gdCkgewogICAgICAgICAgdmFyIHIgPSBpID8gImNvbnRyb2xzaGlkZGVuIiA6ICJjb250cm9sc3Nob3duIjsKICAgICAgICAgIHV1LmNhbGwodGhpcywgdGhpcy5tZWRpYSwgcik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gIWk7CiAgICAgIH0KCiAgICAgIHJldHVybiAhMTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJvbiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSwgdCkgewogICAgICBzdS5jYWxsKHRoaXMsIHRoaXMuZWxlbWVudHMuY29udGFpbmVyLCBlLCB0KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJvbmNlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShlLCB0KSB7CiAgICAgIGN1LmNhbGwodGhpcywgdGhpcy5lbGVtZW50cy5jb250YWluZXIsIGUsIHQpOwogICAgfQogIH0sIHsKICAgIGtleTogIm9mZiIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSwgdCkgewogICAgICBsdSh0aGlzLmVsZW1lbnRzLmNvbnRhaW5lciwgZSwgdCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZGVzdHJveSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSkgewogICAgICB2YXIgdCA9IHRoaXMsCiAgICAgICAgICBuID0gYXJndW1lbnRzLmxlbmd0aCA+IDEgJiYgdm9pZCAwICE9PSBhcmd1bWVudHNbMV0gJiYgYXJndW1lbnRzWzFdOwoKICAgICAgaWYgKHRoaXMucmVhZHkpIHsKICAgICAgICB2YXIgaSA9IGZ1bmN0aW9uIGkoKSB7CiAgICAgICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLm92ZXJmbG93ID0gIiIsIHQuZW1iZWQgPSBudWxsLCBuID8gKE9iamVjdC5rZXlzKHQuZWxlbWVudHMpLmxlbmd0aCAmJiAoJGModC5lbGVtZW50cy5idXR0b25zLnBsYXkpLCAkYyh0LmVsZW1lbnRzLmNhcHRpb25zKSwgJGModC5lbGVtZW50cy5jb250cm9scyksICRjKHQuZWxlbWVudHMud3JhcHBlciksIHQuZWxlbWVudHMuYnV0dG9ucy5wbGF5ID0gbnVsbCwgdC5lbGVtZW50cy5jYXB0aW9ucyA9IG51bGwsIHQuZWxlbWVudHMuY29udHJvbHMgPSBudWxsLCB0LmVsZW1lbnRzLndyYXBwZXIgPSBudWxsKSwgQ2MoZSkgJiYgZSgpKSA6IChodS5jYWxsKHQpLCB5dS5jYW5jZWxSZXF1ZXN0cy5jYWxsKHQpLCBZYyh0LmVsZW1lbnRzLm9yaWdpbmFsLCB0LmVsZW1lbnRzLmNvbnRhaW5lciksIHV1LmNhbGwodCwgdC5lbGVtZW50cy5vcmlnaW5hbCwgImRlc3Ryb3llZCIsICEwKSwgQ2MoZSkgJiYgZS5jYWxsKHQuZWxlbWVudHMub3JpZ2luYWwpLCB0LnJlYWR5ID0gITEsIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICB0LmVsZW1lbnRzID0gbnVsbCwgdC5tZWRpYSA9IG51bGw7CiAgICAgICAgICB9LCAyMDApKTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLnN0b3AoKSwgY2xlYXJUaW1lb3V0KHRoaXMudGltZXJzLmxvYWRpbmcpLCBjbGVhclRpbWVvdXQodGhpcy50aW1lcnMuY29udHJvbHMpLCBjbGVhclRpbWVvdXQodGhpcy50aW1lcnMucmVzaXplZCksIHRoaXMuaXNIVE1MNSA/IChZdS50b2dnbGVOYXRpdmVDb250cm9scy5jYWxsKHRoaXMsICEwKSwgaSgpKSA6IHRoaXMuaXNZb3VUdWJlID8gKGNsZWFySW50ZXJ2YWwodGhpcy50aW1lcnMuYnVmZmVyaW5nKSwgY2xlYXJJbnRlcnZhbCh0aGlzLnRpbWVycy5wbGF5aW5nKSwgbnVsbCAhPT0gdGhpcy5lbWJlZCAmJiBDYyh0aGlzLmVtYmVkLmRlc3Ryb3kpICYmIHRoaXMuZW1iZWQuZGVzdHJveSgpLCBpKCkpIDogdGhpcy5pc1ZpbWVvICYmIChudWxsICE9PSB0aGlzLmVtYmVkICYmIHRoaXMuZW1iZWQudW5sb2FkKCkudGhlbihpKSwgc2V0VGltZW91dChpLCAyMDApKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogInN1cHBvcnRzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZShlKSB7CiAgICAgIHJldHVybiBydS5taW1lLmNhbGwodGhpcywgZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiaXNIVE1MNSIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMucHJvdmlkZXIgPT09IEh1Lmh0bWw1OwogICAgfQogIH0sIHsKICAgIGtleTogImlzRW1iZWQiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLmlzWW91VHViZSB8fCB0aGlzLmlzVmltZW87CiAgICB9CiAgfSwgewogICAga2V5OiAiaXNZb3VUdWJlIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5wcm92aWRlciA9PT0gSHUueW91dHViZTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpc1ZpbWVvIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5wcm92aWRlciA9PT0gSHUudmltZW87CiAgICB9CiAgfSwgewogICAga2V5OiAiaXNWaWRlbyIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gVnU7CiAgICB9CiAgfSwgewogICAga2V5OiAiaXNBdWRpbyIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMudHlwZSA9PT0gQnU7CiAgICB9CiAgfSwgewogICAga2V5OiAicGxheWluZyIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIEJvb2xlYW4odGhpcy5yZWFkeSAmJiAhdGhpcy5wYXVzZWQgJiYgIXRoaXMuZW5kZWQpOwogICAgfQogIH0sIHsKICAgIGtleTogInBhdXNlZCIsCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIEJvb2xlYW4odGhpcy5tZWRpYS5wYXVzZWQpOwogICAgfQogIH0sIHsKICAgIGtleTogInN0b3BwZWQiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBCb29sZWFuKHRoaXMucGF1c2VkICYmIDAgPT09IHRoaXMuY3VycmVudFRpbWUpOwogICAgfQogIH0sIHsKICAgIGtleTogImVuZGVkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gQm9vbGVhbih0aGlzLm1lZGlhLmVuZGVkKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjdXJyZW50VGltZSIsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlKSB7CiAgICAgIGlmICh0aGlzLmR1cmF0aW9uKSB7CiAgICAgICAgdmFyIHQgPSBFYyhlKSAmJiBlID4gMDsKICAgICAgICB0aGlzLm1lZGlhLmN1cnJlbnRUaW1lID0gdCA/IE1hdGgubWluKGUsIHRoaXMuZHVyYXRpb24pIDogMCwgdGhpcy5kZWJ1Zy5sb2coIlNlZWtpbmcgdG8gIi5jb25jYXQodGhpcy5jdXJyZW50VGltZSwgIiBzZWNvbmRzIikpOwogICAgICB9CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBOdW1iZXIodGhpcy5tZWRpYS5jdXJyZW50VGltZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAiYnVmZmVyZWQiLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBlID0gdGhpcy5tZWRpYS5idWZmZXJlZDsKICAgICAgcmV0dXJuIEVjKGUpID8gZSA6IGUgJiYgZS5sZW5ndGggJiYgdGhpcy5kdXJhdGlvbiA+IDAgPyBlLmVuZCgwKSAvIHRoaXMuZHVyYXRpb24gOiAwOwogICAgfQogIH0sIHsKICAgIGtleTogInNlZWtpbmciLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBCb29sZWFuKHRoaXMubWVkaWEuc2Vla2luZyk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZHVyYXRpb24iLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBlID0gcGFyc2VGbG9hdCh0aGlzLmNvbmZpZy5kdXJhdGlvbiksCiAgICAgICAgICB0ID0gKHRoaXMubWVkaWEgfHwge30pLmR1cmF0aW9uLAogICAgICAgICAgbiA9IEVjKHQpICYmIHQgIT09IDEgLyAwID8gdCA6IDA7CiAgICAgIHJldHVybiBlIHx8IG47CiAgICB9CiAgfSwgewogICAga2V5OiAidm9sdW1lIiwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdmFyIHQgPSBlOwogICAgICBBYyh0KSAmJiAodCA9IE51bWJlcih0KSksIEVjKHQpIHx8ICh0ID0gdGhpcy5zdG9yYWdlLmdldCgidm9sdW1lIikpLCBFYyh0KSB8fCAodCA9IHRoaXMuY29uZmlnLnZvbHVtZSksIHQgPiAxICYmICh0ID0gMSksIHQgPCAwICYmICh0ID0gMCksIHRoaXMuY29uZmlnLnZvbHVtZSA9IHQsIHRoaXMubWVkaWEudm9sdW1lID0gdCwgIV9jKGUpICYmIHRoaXMubXV0ZWQgJiYgdCA+IDAgJiYgKHRoaXMubXV0ZWQgPSAhMSk7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBOdW1iZXIodGhpcy5tZWRpYS52b2x1bWUpOwogICAgfQogIH0sIHsKICAgIGtleTogIm11dGVkIiwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdmFyIHQgPSBlOwogICAgICB4Yyh0KSB8fCAodCA9IHRoaXMuc3RvcmFnZS5nZXQoIm11dGVkIikpLCB4Yyh0KSB8fCAodCA9IHRoaXMuY29uZmlnLm11dGVkKSwgdGhpcy5jb25maWcubXV0ZWQgPSB0LCB0aGlzLm1lZGlhLm11dGVkID0gdDsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIEJvb2xlYW4odGhpcy5tZWRpYS5tdXRlZCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiaGFzQXVkaW8iLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiAhdGhpcy5pc0hUTUw1IHx8ICEhdGhpcy5pc0F1ZGlvIHx8IEJvb2xlYW4odGhpcy5tZWRpYS5tb3pIYXNBdWRpbykgfHwgQm9vbGVhbih0aGlzLm1lZGlhLndlYmtpdEF1ZGlvRGVjb2RlZEJ5dGVDb3VudCkgfHwgQm9vbGVhbih0aGlzLm1lZGlhLmF1ZGlvVHJhY2tzICYmIHRoaXMubWVkaWEuYXVkaW9UcmFja3MubGVuZ3RoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJzcGVlZCIsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlKSB7CiAgICAgIHZhciB0ID0gdGhpcywKICAgICAgICAgIG4gPSBudWxsOwogICAgICBFYyhlKSAmJiAobiA9IGUpLCBFYyhuKSB8fCAobiA9IHRoaXMuc3RvcmFnZS5nZXQoInNwZWVkIikpLCBFYyhuKSB8fCAobiA9IHRoaXMuY29uZmlnLnNwZWVkLnNlbGVjdGVkKTsKICAgICAgdmFyIGkgPSB0aGlzLm1pbmltdW1TcGVlZCwKICAgICAgICAgIHIgPSB0aGlzLm1heGltdW1TcGVlZDsKICAgICAgbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZSA9IGFyZ3VtZW50cy5sZW5ndGggPiAwICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzBdID8gYXJndW1lbnRzWzBdIDogMCwKICAgICAgICAgICAgdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzFdID8gYXJndW1lbnRzWzFdIDogMCwKICAgICAgICAgICAgbiA9IGFyZ3VtZW50cy5sZW5ndGggPiAyICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzJdID8gYXJndW1lbnRzWzJdIDogMjU1OwogICAgICAgIHJldHVybiBNYXRoLm1pbihNYXRoLm1heChlLCB0KSwgbik7CiAgICAgIH0obiwgaSwgciksIHRoaXMuY29uZmlnLnNwZWVkLnNlbGVjdGVkID0gbiwgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgdC5tZWRpYS5wbGF5YmFja1JhdGUgPSBuOwogICAgICB9LCAwKTsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIE51bWJlcih0aGlzLm1lZGlhLnBsYXliYWNrUmF0ZSk7CiAgICB9CiAgfSwgewogICAga2V5OiAibWluaW11bVNwZWVkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5pc1lvdVR1YmUgPyBNYXRoLm1pbi5hcHBseShNYXRoLCBVbCh0aGlzLm9wdGlvbnMuc3BlZWQpKSA6IHRoaXMuaXNWaW1lbyA/IC41IDogLjA2MjU7CiAgICB9CiAgfSwgewogICAga2V5OiAibWF4aW11bVNwZWVkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5pc1lvdVR1YmUgPyBNYXRoLm1heC5hcHBseShNYXRoLCBVbCh0aGlzLm9wdGlvbnMuc3BlZWQpKSA6IHRoaXMuaXNWaW1lbyA/IDIgOiAxNjsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJxdWFsaXR5IiwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdmFyIHQgPSB0aGlzLmNvbmZpZy5xdWFsaXR5LAogICAgICAgICAgbiA9IHRoaXMub3B0aW9ucy5xdWFsaXR5OwoKICAgICAgaWYgKG4ubGVuZ3RoKSB7CiAgICAgICAgdmFyIGkgPSBbIV9jKGUpICYmIE51bWJlcihlKSwgdGhpcy5zdG9yYWdlLmdldCgicXVhbGl0eSIpLCB0LnNlbGVjdGVkLCB0LmRlZmF1bHRdLmZpbmQoRWMpLAogICAgICAgICAgICByID0gITA7CgogICAgICAgIGlmICghbi5pbmNsdWRlcyhpKSkgewogICAgICAgICAgdmFyIGEgPSBmdW5jdGlvbiAoZSwgdCkgewogICAgICAgICAgICByZXR1cm4gUGMoZSkgJiYgZS5sZW5ndGggPyBlLnJlZHVjZShmdW5jdGlvbiAoZSwgbikgewogICAgICAgICAgICAgIHJldHVybiBNYXRoLmFicyhuIC0gdCkgPCBNYXRoLmFicyhlIC0gdCkgPyBuIDogZTsKICAgICAgICAgICAgfSkgOiBudWxsOwogICAgICAgICAgfShuLCBpKTsKCiAgICAgICAgICB0aGlzLmRlYnVnLndhcm4oIlVuc3VwcG9ydGVkIHF1YWxpdHkgb3B0aW9uOiAiLmNvbmNhdChpLCAiLCB1c2luZyAiKS5jb25jYXQoYSwgIiBpbnN0ZWFkIikpLCBpID0gYSwgciA9ICExOwogICAgICAgIH0KCiAgICAgICAgdC5zZWxlY3RlZCA9IGksIHRoaXMubWVkaWEucXVhbGl0eSA9IGksIHIgJiYgdGhpcy5zdG9yYWdlLnNldCh7CiAgICAgICAgICBxdWFsaXR5OiBpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMubWVkaWEucXVhbGl0eTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJsb29wIiwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdmFyIHQgPSB4YyhlKSA/IGUgOiB0aGlzLmNvbmZpZy5sb29wLmFjdGl2ZTsKICAgICAgdGhpcy5jb25maWcubG9vcC5hY3RpdmUgPSB0LCB0aGlzLm1lZGlhLmxvb3AgPSB0OwogICAgfSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gQm9vbGVhbih0aGlzLm1lZGlhLmxvb3ApOwogICAgfQogIH0sIHsKICAgIGtleTogInNvdXJjZSIsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlKSB7CiAgICAgIGxoLmNoYW5nZS5jYWxsKHRoaXMsIGUpOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICByZXR1cm4gdGhpcy5tZWRpYS5jdXJyZW50U3JjOwogICAgfQogIH0sIHsKICAgIGtleTogImRvd25sb2FkIiwKICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICB2YXIgZSA9IHRoaXMuY29uZmlnLnVybHMuZG93bmxvYWQ7CiAgICAgIHJldHVybiBSYyhlKSA/IGUgOiB0aGlzLnNvdXJjZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlKSB7CiAgICAgIFJjKGUpICYmICh0aGlzLmNvbmZpZy51cmxzLmRvd25sb2FkID0gZSwganUuc2V0RG93bmxvYWRVcmwuY2FsbCh0aGlzKSk7CiAgICB9CiAgfSwgewogICAga2V5OiAicG9zdGVyIiwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdGhpcy5pc1ZpZGVvID8gWXUuc2V0UG9zdGVyLmNhbGwodGhpcywgZSwgITEpLmNhdGNoKGZ1bmN0aW9uICgpIHt9KSA6IHRoaXMuZGVidWcud2FybigiUG9zdGVyIGNhbiBvbmx5IGJlIHNldCBmb3IgdmlkZW8iKTsKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgcmV0dXJuIHRoaXMuaXNWaWRlbyA/IHRoaXMubWVkaWEuZ2V0QXR0cmlidXRlKCJwb3N0ZXIiKSB8fCB0aGlzLm1lZGlhLmdldEF0dHJpYnV0ZSgiZGF0YS1wb3N0ZXIiKSA6IG51bGw7CiAgICB9CiAgfSwgewogICAga2V5OiAicmF0aW8iLAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIGlmICghdGhpcy5pc1ZpZGVvKSByZXR1cm4gbnVsbDsKICAgICAgdmFyIGUgPSBtdShndS5jYWxsKHRoaXMpKTsKICAgICAgcmV0dXJuIFBjKGUpID8gZS5qb2luKCI6IikgOiBlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgdGhpcy5pc1ZpZGVvID8gQWMoZSkgJiYgcHUoZSkgPyAodGhpcy5jb25maWcucmF0aW8gPSBlLCB2dS5jYWxsKHRoaXMpKSA6IHRoaXMuZGVidWcuZXJyb3IoIkludmFsaWQgYXNwZWN0IHJhdGlvIHNwZWNpZmllZCAoIi5jb25jYXQoZSwgIikiKSkgOiB0aGlzLmRlYnVnLndhcm4oIkFzcGVjdCByYXRpbyBjYW4gb25seSBiZSBzZXQgZm9yIHZpZGVvIik7CiAgICB9CiAgfSwgewogICAga2V5OiAiYXV0b3BsYXkiLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoZSkgewogICAgICB2YXIgdCA9IHhjKGUpID8gZSA6IHRoaXMuY29uZmlnLmF1dG9wbGF5OwogICAgICB0aGlzLmNvbmZpZy5hdXRvcGxheSA9IHQ7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBCb29sZWFuKHRoaXMuY29uZmlnLmF1dG9wbGF5KTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjdXJyZW50VHJhY2siLAogICAgc2V0OiBmdW5jdGlvbiBzZXQoZSkgewogICAgICBEdS5zZXQuY2FsbCh0aGlzLCBlLCAhMSk7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHZhciBlID0gdGhpcy5jYXB0aW9ucywKICAgICAgICAgIHQgPSBlLnRvZ2dsZWQsCiAgICAgICAgICBuID0gZS5jdXJyZW50VHJhY2s7CiAgICAgIHJldHVybiB0ID8gbiA6IC0xOwogICAgfQogIH0sIHsKICAgIGtleTogImxhbmd1YWdlIiwKICAgIHNldDogZnVuY3Rpb24gc2V0KGUpIHsKICAgICAgRHUuc2V0TGFuZ3VhZ2UuY2FsbCh0aGlzLCBlLCAhMSk7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiAoRHUuZ2V0Q3VycmVudFRyYWNrLmNhbGwodGhpcykgfHwge30pLmxhbmd1YWdlOwogICAgfQogIH0sIHsKICAgIGtleTogInBpcCIsCiAgICBzZXQ6IGZ1bmN0aW9uIHNldChlKSB7CiAgICAgIGlmIChydS5waXApIHsKICAgICAgICB2YXIgdCA9IHhjKGUpID8gZSA6ICF0aGlzLnBpcDsKICAgICAgICBDYyh0aGlzLm1lZGlhLndlYmtpdFNldFByZXNlbnRhdGlvbk1vZGUpICYmIHRoaXMubWVkaWEud2Via2l0U2V0UHJlc2VudGF0aW9uTW9kZSh0ID8gcXUgOiBVdSksIENjKHRoaXMubWVkaWEucmVxdWVzdFBpY3R1cmVJblBpY3R1cmUpICYmICghdGhpcy5waXAgJiYgdCA/IHRoaXMubWVkaWEucmVxdWVzdFBpY3R1cmVJblBpY3R1cmUoKSA6IHRoaXMucGlwICYmICF0ICYmIGRvY3VtZW50LmV4aXRQaWN0dXJlSW5QaWN0dXJlKCkpOwogICAgICB9CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiBydS5waXAgPyBfYyh0aGlzLm1lZGlhLndlYmtpdFByZXNlbnRhdGlvbk1vZGUpID8gdGhpcy5tZWRpYSA9PT0gZG9jdW1lbnQucGljdHVyZUluUGljdHVyZUVsZW1lbnQgOiB0aGlzLm1lZGlhLndlYmtpdFByZXNlbnRhdGlvbk1vZGUgPT09IHF1IDogbnVsbDsKICAgIH0KICB9XSwgW3sKICAgIGtleTogInN1cHBvcnRlZCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSwgdCwgbikgewogICAgICByZXR1cm4gcnUuY2hlY2soZSwgdCwgbik7CiAgICB9CiAgfSwgewogICAga2V5OiAibG9hZFNwcml0ZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoZSwgdCkgewogICAgICByZXR1cm4gT3UoZSwgdCk7CiAgICB9CiAgfSwgewogICAga2V5OiAic2V0dXAiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHZhbHVlKHQpIHsKICAgICAgdmFyIG4gPSBhcmd1bWVudHMubGVuZ3RoID4gMSAmJiB2b2lkIDAgIT09IGFyZ3VtZW50c1sxXSA/IGFyZ3VtZW50c1sxXSA6IHt9LAogICAgICAgICAgaSA9IG51bGw7CiAgICAgIHJldHVybiBBYyh0KSA/IGkgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodCkpIDogT2ModCkgPyBpID0gQXJyYXkuZnJvbSh0KSA6IFBjKHQpICYmIChpID0gdC5maWx0ZXIoSWMpKSwgX2MoaSkgPyBudWxsIDogaS5tYXAoZnVuY3Rpb24gKHQpIHsKICAgICAgICByZXR1cm4gbmV3IGUodCwgbik7CiAgICAgIH0pOwogICAgfQogIH1dKSwgZTsKfSgpOwoKY2guZGVmYXVsdHMgPSBmdW5jdGlvbiAoZSkgewogIHJldHVybiBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGUpKTsKfShGdSk7Cgp2YXIgdWggPSB7CiAgbmFtZTogIlZ1ZVBseXIiLAogIHByb3BzOiB7CiAgICBvcHRpb25zOiB7CiAgICAgIHR5cGU6IE9iamVjdCwKICAgICAgcmVxdWlyZWQ6ICExLAogICAgICBkZWZhdWx0OiBmdW5jdGlvbiBfZGVmYXVsdCgpIHsKICAgICAgICByZXR1cm4ge307CiAgICAgIH0KICAgIH0KICB9LAogIGRhdGE6IGZ1bmN0aW9uIGRhdGEoKSB7CiAgICByZXR1cm4gewogICAgICBwbGF5ZXI6IHt9CiAgICB9OwogIH0sCiAgY29tcHV0ZWQ6IHsKICAgIG9wdHM6IGZ1bmN0aW9uIG9wdHMoKSB7CiAgICAgIHZhciBlID0gdGhpcy5vcHRpb25zOwogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHRoaXMub3B0aW9ucywgImhpZGVZb3VUdWJlRE9NRXJyb3IiKSB8fCAoZS5oaWRlWW91VHViZURPTUVycm9yID0gITApLCBlOwogICAgfQogIH0sCiAgbW91bnRlZDogZnVuY3Rpb24gbW91bnRlZCgpIHsKICAgIHRoaXMucGxheWVyID0gbmV3IGNoKHRoaXMuJGVsLCB0aGlzLm9wdHMpOwogIH0sCiAgYmVmb3JlVW5tb3VudDogZnVuY3Rpb24gYmVmb3JlVW5tb3VudCgpIHsKICAgIHRyeSB7CiAgICAgIHRoaXMucGxheWVyLmRlc3Ryb3koKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgdGhpcy5vcHRzLmhpZGVZb3VUdWJlRE9NRXJyb3IgJiYgIlRoZSBZb3VUdWJlIHBsYXllciBpcyBub3QgYXR0YWNoZWQgdG8gdGhlIERPTS4iID09PSBlLm1lc3NhZ2UgfHwgY29uc29sZS5lcnJvcihlKTsKICAgIH0KICB9LAogIHJlbmRlcjogZnVuY3Rpb24gcmVuZGVyKCkgewogICAgdmFyIGUgPSB0aGlzLiRzbG90cy5kZWZhdWx0OwogICAgcmV0dXJuICJmdW5jdGlvbiIgPT0gdHlwZW9mIGUgPyBlKClbMF0gOiBlOwogIH0sCiAgaW5zdGFsbDogZnVuY3Rpb24gaW5zdGFsbChlKSB7CiAgICB2YXIgdCA9IGFyZ3VtZW50cy5sZW5ndGggPiAxICYmIHZvaWQgMCAhPT0gYXJndW1lbnRzWzFdID8gYXJndW1lbnRzWzFdIDoge307CiAgICB0LnBseXIgJiYgKHVoLnByb3BzLm9wdGlvbnMuZGVmYXVsdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgcmV0dXJuIGtuKHt9LCB0LnBseXIpOwogICAgfSksIGUuY29tcG9uZW50KHVoLm5hbWUsIHVoKTsKICB9Cn07CmV4cG9ydCBkZWZhdWx0IHVoOw=="},null]}