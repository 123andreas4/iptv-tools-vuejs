{"remainingRequest":"/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/thread-loader/dist/cjs.js!/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/babel-loader/lib/index.js!/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/chart.js/dist/Chart.js","dependencies":[{"path":"/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/chart.js/dist/Chart.js","mtime":499162500000},{"path":"/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/thread-loader/dist/cjs.js","mtime":499162500000},{"path":"/media/ernst/63bce43c-5e51-4bf1-a611-3afdf32ac6f6/VueJS/IPTV-Tools/node_modules/babel-loader/lib/index.js","mtime":315532800000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:dmFyIF90eXBlb2YgPSByZXF1aXJlKCIvbWVkaWEvZXJuc3QvNjNiY2U0M2MtNWU1MS00YmYxLWE2MTEtM2FmZGYzMmFjNmY2L1Z1ZUpTL0lQVFYtVG9vbHMvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvdHlwZW9mIikuZGVmYXVsdDsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QudG8tc3RyaW5nLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMucmVnZXhwLnRvLXN0cmluZy5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5leGVjLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLm1hdGNoLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuam9pbi5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5Lm1hcC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnN0cmluZy5zcGxpdC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC5rZXlzLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc2xpY2UuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLmZvci1lYWNoLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvd2ViLmRvbS1jb2xsZWN0aW9ucy5pdGVyYXRvci5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmNvbmNhdC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm51bWJlci5jb25zdHJ1Y3Rvci5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZpbGwuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5zb3J0LmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMubWF0aC5sb2cxMC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZpbmQtaW5kZXguanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5zcGxpY2UuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5vYmplY3QuaXMtZXh0ZW5zaWJsZS5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm9iamVjdC5mcmVlemUuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5maWx0ZXIuanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5tYXRoLnNpZ24uanMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5udW1iZXIuZXBzaWxvbi5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm51bWJlci50by1maXhlZC5qcyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLm51bWJlci5taW4tc2FmZS1pbnRlZ2VyLmpzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMubnVtYmVyLm1heC1zYWZlLWludGVnZXIuanMiKTsKCi8qIQogKiBDaGFydC5qcyB2Mi45LjQKICogaHR0cHM6Ly93d3cuY2hhcnRqcy5vcmcKICogKGMpIDIwMjAgQ2hhcnQuanMgQ29udHJpYnV0b3JzCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZQogKi8KKGZ1bmN0aW9uIChnbG9iYWwsIGZhY3RvcnkpIHsKICAodHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiID8gInVuZGVmaW5lZCIgOiBfdHlwZW9mKGV4cG9ydHMpKSA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgPyBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoZnVuY3Rpb24gKCkgewogICAgdHJ5IHsKICAgICAgcmV0dXJuIHJlcXVpcmUoJ21vbWVudCcpOwogICAgfSBjYXRjaCAoZSkge30KICB9KCkpIDogdHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kID8gZGVmaW5lKFsncmVxdWlyZSddLCBmdW5jdGlvbiAocmVxdWlyZSkgewogICAgcmV0dXJuIGZhY3RvcnkoZnVuY3Rpb24gKCkgewogICAgICB0cnkgewogICAgICAgIHJldHVybiByZXF1aXJlKCdtb21lbnQnKTsKICAgICAgfSBjYXRjaCAoZSkge30KICAgIH0oKSk7CiAgfSkgOiAoZ2xvYmFsID0gZ2xvYmFsIHx8IHNlbGYsIGdsb2JhbC5DaGFydCA9IGZhY3RvcnkoZ2xvYmFsLm1vbWVudCkpOwp9KSh0aGlzLCBmdW5jdGlvbiAobW9tZW50KSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBtb21lbnQgPSBtb21lbnQgJiYgbW9tZW50Lmhhc093blByb3BlcnR5KCdkZWZhdWx0JykgPyBtb21lbnRbJ2RlZmF1bHQnXSA6IG1vbWVudDsKCiAgZnVuY3Rpb24gY3JlYXRlQ29tbW9uanNNb2R1bGUoZm4sIG1vZHVsZSkgewogICAgcmV0dXJuIG1vZHVsZSA9IHsKICAgICAgZXhwb3J0czoge30KICAgIH0sIGZuKG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMpLCBtb2R1bGUuZXhwb3J0czsKICB9CgogIGZ1bmN0aW9uIGdldENqc0V4cG9ydEZyb21OYW1lc3BhY2UobikgewogICAgcmV0dXJuIG4gJiYgblsnZGVmYXVsdCddIHx8IG47CiAgfQoKICB2YXIgY29sb3JOYW1lID0gewogICAgImFsaWNlYmx1ZSI6IFsyNDAsIDI0OCwgMjU1XSwKICAgICJhbnRpcXVld2hpdGUiOiBbMjUwLCAyMzUsIDIxNV0sCiAgICAiYXF1YSI6IFswLCAyNTUsIDI1NV0sCiAgICAiYXF1YW1hcmluZSI6IFsxMjcsIDI1NSwgMjEyXSwKICAgICJhenVyZSI6IFsyNDAsIDI1NSwgMjU1XSwKICAgICJiZWlnZSI6IFsyNDUsIDI0NSwgMjIwXSwKICAgICJiaXNxdWUiOiBbMjU1LCAyMjgsIDE5Nl0sCiAgICAiYmxhY2siOiBbMCwgMCwgMF0sCiAgICAiYmxhbmNoZWRhbG1vbmQiOiBbMjU1LCAyMzUsIDIwNV0sCiAgICAiYmx1ZSI6IFswLCAwLCAyNTVdLAogICAgImJsdWV2aW9sZXQiOiBbMTM4LCA0MywgMjI2XSwKICAgICJicm93biI6IFsxNjUsIDQyLCA0Ml0sCiAgICAiYnVybHl3b29kIjogWzIyMiwgMTg0LCAxMzVdLAogICAgImNhZGV0Ymx1ZSI6IFs5NSwgMTU4LCAxNjBdLAogICAgImNoYXJ0cmV1c2UiOiBbMTI3LCAyNTUsIDBdLAogICAgImNob2NvbGF0ZSI6IFsyMTAsIDEwNSwgMzBdLAogICAgImNvcmFsIjogWzI1NSwgMTI3LCA4MF0sCiAgICAiY29ybmZsb3dlcmJsdWUiOiBbMTAwLCAxNDksIDIzN10sCiAgICAiY29ybnNpbGsiOiBbMjU1LCAyNDgsIDIyMF0sCiAgICAiY3JpbXNvbiI6IFsyMjAsIDIwLCA2MF0sCiAgICAiY3lhbiI6IFswLCAyNTUsIDI1NV0sCiAgICAiZGFya2JsdWUiOiBbMCwgMCwgMTM5XSwKICAgICJkYXJrY3lhbiI6IFswLCAxMzksIDEzOV0sCiAgICAiZGFya2dvbGRlbnJvZCI6IFsxODQsIDEzNCwgMTFdLAogICAgImRhcmtncmF5IjogWzE2OSwgMTY5LCAxNjldLAogICAgImRhcmtncmVlbiI6IFswLCAxMDAsIDBdLAogICAgImRhcmtncmV5IjogWzE2OSwgMTY5LCAxNjldLAogICAgImRhcmtraGFraSI6IFsxODksIDE4MywgMTA3XSwKICAgICJkYXJrbWFnZW50YSI6IFsxMzksIDAsIDEzOV0sCiAgICAiZGFya29saXZlZ3JlZW4iOiBbODUsIDEwNywgNDddLAogICAgImRhcmtvcmFuZ2UiOiBbMjU1LCAxNDAsIDBdLAogICAgImRhcmtvcmNoaWQiOiBbMTUzLCA1MCwgMjA0XSwKICAgICJkYXJrcmVkIjogWzEzOSwgMCwgMF0sCiAgICAiZGFya3NhbG1vbiI6IFsyMzMsIDE1MCwgMTIyXSwKICAgICJkYXJrc2VhZ3JlZW4iOiBbMTQzLCAxODgsIDE0M10sCiAgICAiZGFya3NsYXRlYmx1ZSI6IFs3MiwgNjEsIDEzOV0sCiAgICAiZGFya3NsYXRlZ3JheSI6IFs0NywgNzksIDc5XSwKICAgICJkYXJrc2xhdGVncmV5IjogWzQ3LCA3OSwgNzldLAogICAgImRhcmt0dXJxdW9pc2UiOiBbMCwgMjA2LCAyMDldLAogICAgImRhcmt2aW9sZXQiOiBbMTQ4LCAwLCAyMTFdLAogICAgImRlZXBwaW5rIjogWzI1NSwgMjAsIDE0N10sCiAgICAiZGVlcHNreWJsdWUiOiBbMCwgMTkxLCAyNTVdLAogICAgImRpbWdyYXkiOiBbMTA1LCAxMDUsIDEwNV0sCiAgICAiZGltZ3JleSI6IFsxMDUsIDEwNSwgMTA1XSwKICAgICJkb2RnZXJibHVlIjogWzMwLCAxNDQsIDI1NV0sCiAgICAiZmlyZWJyaWNrIjogWzE3OCwgMzQsIDM0XSwKICAgICJmbG9yYWx3aGl0ZSI6IFsyNTUsIDI1MCwgMjQwXSwKICAgICJmb3Jlc3RncmVlbiI6IFszNCwgMTM5LCAzNF0sCiAgICAiZnVjaHNpYSI6IFsyNTUsIDAsIDI1NV0sCiAgICAiZ2FpbnNib3JvIjogWzIyMCwgMjIwLCAyMjBdLAogICAgImdob3N0d2hpdGUiOiBbMjQ4LCAyNDgsIDI1NV0sCiAgICAiZ29sZCI6IFsyNTUsIDIxNSwgMF0sCiAgICAiZ29sZGVucm9kIjogWzIxOCwgMTY1LCAzMl0sCiAgICAiZ3JheSI6IFsxMjgsIDEyOCwgMTI4XSwKICAgICJncmVlbiI6IFswLCAxMjgsIDBdLAogICAgImdyZWVueWVsbG93IjogWzE3MywgMjU1LCA0N10sCiAgICAiZ3JleSI6IFsxMjgsIDEyOCwgMTI4XSwKICAgICJob25leWRldyI6IFsyNDAsIDI1NSwgMjQwXSwKICAgICJob3RwaW5rIjogWzI1NSwgMTA1LCAxODBdLAogICAgImluZGlhbnJlZCI6IFsyMDUsIDkyLCA5Ml0sCiAgICAiaW5kaWdvIjogWzc1LCAwLCAxMzBdLAogICAgIml2b3J5IjogWzI1NSwgMjU1LCAyNDBdLAogICAgImtoYWtpIjogWzI0MCwgMjMwLCAxNDBdLAogICAgImxhdmVuZGVyIjogWzIzMCwgMjMwLCAyNTBdLAogICAgImxhdmVuZGVyYmx1c2giOiBbMjU1LCAyNDAsIDI0NV0sCiAgICAibGF3bmdyZWVuIjogWzEyNCwgMjUyLCAwXSwKICAgICJsZW1vbmNoaWZmb24iOiBbMjU1LCAyNTAsIDIwNV0sCiAgICAibGlnaHRibHVlIjogWzE3MywgMjE2LCAyMzBdLAogICAgImxpZ2h0Y29yYWwiOiBbMjQwLCAxMjgsIDEyOF0sCiAgICAibGlnaHRjeWFuIjogWzIyNCwgMjU1LCAyNTVdLAogICAgImxpZ2h0Z29sZGVucm9keWVsbG93IjogWzI1MCwgMjUwLCAyMTBdLAogICAgImxpZ2h0Z3JheSI6IFsyMTEsIDIxMSwgMjExXSwKICAgICJsaWdodGdyZWVuIjogWzE0NCwgMjM4LCAxNDRdLAogICAgImxpZ2h0Z3JleSI6IFsyMTEsIDIxMSwgMjExXSwKICAgICJsaWdodHBpbmsiOiBbMjU1LCAxODIsIDE5M10sCiAgICAibGlnaHRzYWxtb24iOiBbMjU1LCAxNjAsIDEyMl0sCiAgICAibGlnaHRzZWFncmVlbiI6IFszMiwgMTc4LCAxNzBdLAogICAgImxpZ2h0c2t5Ymx1ZSI6IFsxMzUsIDIwNiwgMjUwXSwKICAgICJsaWdodHNsYXRlZ3JheSI6IFsxMTksIDEzNiwgMTUzXSwKICAgICJsaWdodHNsYXRlZ3JleSI6IFsxMTksIDEzNiwgMTUzXSwKICAgICJsaWdodHN0ZWVsYmx1ZSI6IFsxNzYsIDE5NiwgMjIyXSwKICAgICJsaWdodHllbGxvdyI6IFsyNTUsIDI1NSwgMjI0XSwKICAgICJsaW1lIjogWzAsIDI1NSwgMF0sCiAgICAibGltZWdyZWVuIjogWzUwLCAyMDUsIDUwXSwKICAgICJsaW5lbiI6IFsyNTAsIDI0MCwgMjMwXSwKICAgICJtYWdlbnRhIjogWzI1NSwgMCwgMjU1XSwKICAgICJtYXJvb24iOiBbMTI4LCAwLCAwXSwKICAgICJtZWRpdW1hcXVhbWFyaW5lIjogWzEwMiwgMjA1LCAxNzBdLAogICAgIm1lZGl1bWJsdWUiOiBbMCwgMCwgMjA1XSwKICAgICJtZWRpdW1vcmNoaWQiOiBbMTg2LCA4NSwgMjExXSwKICAgICJtZWRpdW1wdXJwbGUiOiBbMTQ3LCAxMTIsIDIxOV0sCiAgICAibWVkaXVtc2VhZ3JlZW4iOiBbNjAsIDE3OSwgMTEzXSwKICAgICJtZWRpdW1zbGF0ZWJsdWUiOiBbMTIzLCAxMDQsIDIzOF0sCiAgICAibWVkaXVtc3ByaW5nZ3JlZW4iOiBbMCwgMjUwLCAxNTRdLAogICAgIm1lZGl1bXR1cnF1b2lzZSI6IFs3MiwgMjA5LCAyMDRdLAogICAgIm1lZGl1bXZpb2xldHJlZCI6IFsxOTksIDIxLCAxMzNdLAogICAgIm1pZG5pZ2h0Ymx1ZSI6IFsyNSwgMjUsIDExMl0sCiAgICAibWludGNyZWFtIjogWzI0NSwgMjU1LCAyNTBdLAogICAgIm1pc3R5cm9zZSI6IFsyNTUsIDIyOCwgMjI1XSwKICAgICJtb2NjYXNpbiI6IFsyNTUsIDIyOCwgMTgxXSwKICAgICJuYXZham93aGl0ZSI6IFsyNTUsIDIyMiwgMTczXSwKICAgICJuYXZ5IjogWzAsIDAsIDEyOF0sCiAgICAib2xkbGFjZSI6IFsyNTMsIDI0NSwgMjMwXSwKICAgICJvbGl2ZSI6IFsxMjgsIDEyOCwgMF0sCiAgICAib2xpdmVkcmFiIjogWzEwNywgMTQyLCAzNV0sCiAgICAib3JhbmdlIjogWzI1NSwgMTY1LCAwXSwKICAgICJvcmFuZ2VyZWQiOiBbMjU1LCA2OSwgMF0sCiAgICAib3JjaGlkIjogWzIxOCwgMTEyLCAyMTRdLAogICAgInBhbGVnb2xkZW5yb2QiOiBbMjM4LCAyMzIsIDE3MF0sCiAgICAicGFsZWdyZWVuIjogWzE1MiwgMjUxLCAxNTJdLAogICAgInBhbGV0dXJxdW9pc2UiOiBbMTc1LCAyMzgsIDIzOF0sCiAgICAicGFsZXZpb2xldHJlZCI6IFsyMTksIDExMiwgMTQ3XSwKICAgICJwYXBheWF3aGlwIjogWzI1NSwgMjM5LCAyMTNdLAogICAgInBlYWNocHVmZiI6IFsyNTUsIDIxOCwgMTg1XSwKICAgICJwZXJ1IjogWzIwNSwgMTMzLCA2M10sCiAgICAicGluayI6IFsyNTUsIDE5MiwgMjAzXSwKICAgICJwbHVtIjogWzIyMSwgMTYwLCAyMjFdLAogICAgInBvd2RlcmJsdWUiOiBbMTc2LCAyMjQsIDIzMF0sCiAgICAicHVycGxlIjogWzEyOCwgMCwgMTI4XSwKICAgICJyZWJlY2NhcHVycGxlIjogWzEwMiwgNTEsIDE1M10sCiAgICAicmVkIjogWzI1NSwgMCwgMF0sCiAgICAicm9zeWJyb3duIjogWzE4OCwgMTQzLCAxNDNdLAogICAgInJveWFsYmx1ZSI6IFs2NSwgMTA1LCAyMjVdLAogICAgInNhZGRsZWJyb3duIjogWzEzOSwgNjksIDE5XSwKICAgICJzYWxtb24iOiBbMjUwLCAxMjgsIDExNF0sCiAgICAic2FuZHlicm93biI6IFsyNDQsIDE2NCwgOTZdLAogICAgInNlYWdyZWVuIjogWzQ2LCAxMzksIDg3XSwKICAgICJzZWFzaGVsbCI6IFsyNTUsIDI0NSwgMjM4XSwKICAgICJzaWVubmEiOiBbMTYwLCA4MiwgNDVdLAogICAgInNpbHZlciI6IFsxOTIsIDE5MiwgMTkyXSwKICAgICJza3libHVlIjogWzEzNSwgMjA2LCAyMzVdLAogICAgInNsYXRlYmx1ZSI6IFsxMDYsIDkwLCAyMDVdLAogICAgInNsYXRlZ3JheSI6IFsxMTIsIDEyOCwgMTQ0XSwKICAgICJzbGF0ZWdyZXkiOiBbMTEyLCAxMjgsIDE0NF0sCiAgICAic25vdyI6IFsyNTUsIDI1MCwgMjUwXSwKICAgICJzcHJpbmdncmVlbiI6IFswLCAyNTUsIDEyN10sCiAgICAic3RlZWxibHVlIjogWzcwLCAxMzAsIDE4MF0sCiAgICAidGFuIjogWzIxMCwgMTgwLCAxNDBdLAogICAgInRlYWwiOiBbMCwgMTI4LCAxMjhdLAogICAgInRoaXN0bGUiOiBbMjE2LCAxOTEsIDIxNl0sCiAgICAidG9tYXRvIjogWzI1NSwgOTksIDcxXSwKICAgICJ0dXJxdW9pc2UiOiBbNjQsIDIyNCwgMjA4XSwKICAgICJ2aW9sZXQiOiBbMjM4LCAxMzAsIDIzOF0sCiAgICAid2hlYXQiOiBbMjQ1LCAyMjIsIDE3OV0sCiAgICAid2hpdGUiOiBbMjU1LCAyNTUsIDI1NV0sCiAgICAid2hpdGVzbW9rZSI6IFsyNDUsIDI0NSwgMjQ1XSwKICAgICJ5ZWxsb3ciOiBbMjU1LCAyNTUsIDBdLAogICAgInllbGxvd2dyZWVuIjogWzE1NCwgMjA1LCA1MF0KICB9OwogIHZhciBjb252ZXJzaW9ucyA9IGNyZWF0ZUNvbW1vbmpzTW9kdWxlKGZ1bmN0aW9uIChtb2R1bGUpIHsKICAgIC8qIE1JVCBsaWNlbnNlICovCiAgICAvLyBOT1RFOiBjb252ZXJzaW9ucyBzaG91bGQgb25seSByZXR1cm4gcHJpbWl0aXZlIHZhbHVlcyAoaS5lLiBhcnJheXMsIG9yCiAgICAvLyAgICAgICB2YWx1ZXMgdGhhdCBnaXZlIGNvcnJlY3QgYHR5cGVvZmAgcmVzdWx0cykuCiAgICAvLyAgICAgICBkbyBub3QgdXNlIGJveCB2YWx1ZXMgdHlwZXMgKGkuZS4gTnVtYmVyKCksIFN0cmluZygpLCBldGMuKQogICAgdmFyIHJldmVyc2VLZXl3b3JkcyA9IHt9OwoKICAgIGZvciAodmFyIGtleSBpbiBjb2xvck5hbWUpIHsKICAgICAgaWYgKGNvbG9yTmFtZS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgcmV2ZXJzZUtleXdvcmRzW2NvbG9yTmFtZVtrZXldXSA9IGtleTsKICAgICAgfQogICAgfQoKICAgIHZhciBjb252ZXJ0ID0gbW9kdWxlLmV4cG9ydHMgPSB7CiAgICAgIHJnYjogewogICAgICAgIGNoYW5uZWxzOiAzLAogICAgICAgIGxhYmVsczogJ3JnYicKICAgICAgfSwKICAgICAgaHNsOiB7CiAgICAgICAgY2hhbm5lbHM6IDMsCiAgICAgICAgbGFiZWxzOiAnaHNsJwogICAgICB9LAogICAgICBoc3Y6IHsKICAgICAgICBjaGFubmVsczogMywKICAgICAgICBsYWJlbHM6ICdoc3YnCiAgICAgIH0sCiAgICAgIGh3YjogewogICAgICAgIGNoYW5uZWxzOiAzLAogICAgICAgIGxhYmVsczogJ2h3YicKICAgICAgfSwKICAgICAgY215azogewogICAgICAgIGNoYW5uZWxzOiA0LAogICAgICAgIGxhYmVsczogJ2NteWsnCiAgICAgIH0sCiAgICAgIHh5ejogewogICAgICAgIGNoYW5uZWxzOiAzLAogICAgICAgIGxhYmVsczogJ3h5eicKICAgICAgfSwKICAgICAgbGFiOiB7CiAgICAgICAgY2hhbm5lbHM6IDMsCiAgICAgICAgbGFiZWxzOiAnbGFiJwogICAgICB9LAogICAgICBsY2g6IHsKICAgICAgICBjaGFubmVsczogMywKICAgICAgICBsYWJlbHM6ICdsY2gnCiAgICAgIH0sCiAgICAgIGhleDogewogICAgICAgIGNoYW5uZWxzOiAxLAogICAgICAgIGxhYmVsczogWydoZXgnXQogICAgICB9LAogICAgICBrZXl3b3JkOiB7CiAgICAgICAgY2hhbm5lbHM6IDEsCiAgICAgICAgbGFiZWxzOiBbJ2tleXdvcmQnXQogICAgICB9LAogICAgICBhbnNpMTY6IHsKICAgICAgICBjaGFubmVsczogMSwKICAgICAgICBsYWJlbHM6IFsnYW5zaTE2J10KICAgICAgfSwKICAgICAgYW5zaTI1NjogewogICAgICAgIGNoYW5uZWxzOiAxLAogICAgICAgIGxhYmVsczogWydhbnNpMjU2J10KICAgICAgfSwKICAgICAgaGNnOiB7CiAgICAgICAgY2hhbm5lbHM6IDMsCiAgICAgICAgbGFiZWxzOiBbJ2gnLCAnYycsICdnJ10KICAgICAgfSwKICAgICAgYXBwbGU6IHsKICAgICAgICBjaGFubmVsczogMywKICAgICAgICBsYWJlbHM6IFsncjE2JywgJ2cxNicsICdiMTYnXQogICAgICB9LAogICAgICBncmF5OiB7CiAgICAgICAgY2hhbm5lbHM6IDEsCiAgICAgICAgbGFiZWxzOiBbJ2dyYXknXQogICAgICB9CiAgICB9OyAvLyBoaWRlIC5jaGFubmVscyBhbmQgLmxhYmVscyBwcm9wZXJ0aWVzCgogICAgZm9yICh2YXIgbW9kZWwgaW4gY29udmVydCkgewogICAgICBpZiAoY29udmVydC5oYXNPd25Qcm9wZXJ0eShtb2RlbCkpIHsKICAgICAgICBpZiAoISgnY2hhbm5lbHMnIGluIGNvbnZlcnRbbW9kZWxdKSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdtaXNzaW5nIGNoYW5uZWxzIHByb3BlcnR5OiAnICsgbW9kZWwpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCEoJ2xhYmVscycgaW4gY29udmVydFttb2RlbF0pKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ21pc3NpbmcgY2hhbm5lbCBsYWJlbHMgcHJvcGVydHk6ICcgKyBtb2RlbCk7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29udmVydFttb2RlbF0ubGFiZWxzLmxlbmd0aCAhPT0gY29udmVydFttb2RlbF0uY2hhbm5lbHMpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcignY2hhbm5lbCBhbmQgbGFiZWwgY291bnRzIG1pc21hdGNoOiAnICsgbW9kZWwpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNoYW5uZWxzID0gY29udmVydFttb2RlbF0uY2hhbm5lbHM7CiAgICAgICAgdmFyIGxhYmVscyA9IGNvbnZlcnRbbW9kZWxdLmxhYmVsczsKICAgICAgICBkZWxldGUgY29udmVydFttb2RlbF0uY2hhbm5lbHM7CiAgICAgICAgZGVsZXRlIGNvbnZlcnRbbW9kZWxdLmxhYmVsczsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY29udmVydFttb2RlbF0sICdjaGFubmVscycsIHsKICAgICAgICAgIHZhbHVlOiBjaGFubmVscwogICAgICAgIH0pOwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb252ZXJ0W21vZGVsXSwgJ2xhYmVscycsIHsKICAgICAgICAgIHZhbHVlOiBsYWJlbHMKICAgICAgICB9KTsKICAgICAgfQogICAgfQoKICAgIGNvbnZlcnQucmdiLmhzbCA9IGZ1bmN0aW9uIChyZ2IpIHsKICAgICAgdmFyIHIgPSByZ2JbMF0gLyAyNTU7CiAgICAgIHZhciBnID0gcmdiWzFdIC8gMjU1OwogICAgICB2YXIgYiA9IHJnYlsyXSAvIDI1NTsKICAgICAgdmFyIG1pbiA9IE1hdGgubWluKHIsIGcsIGIpOwogICAgICB2YXIgbWF4ID0gTWF0aC5tYXgociwgZywgYik7CiAgICAgIHZhciBkZWx0YSA9IG1heCAtIG1pbjsKICAgICAgdmFyIGg7CiAgICAgIHZhciBzOwogICAgICB2YXIgbDsKCiAgICAgIGlmIChtYXggPT09IG1pbikgewogICAgICAgIGggPSAwOwogICAgICB9IGVsc2UgaWYgKHIgPT09IG1heCkgewogICAgICAgIGggPSAoZyAtIGIpIC8gZGVsdGE7CiAgICAgIH0gZWxzZSBpZiAoZyA9PT0gbWF4KSB7CiAgICAgICAgaCA9IDIgKyAoYiAtIHIpIC8gZGVsdGE7CiAgICAgIH0gZWxzZSBpZiAoYiA9PT0gbWF4KSB7CiAgICAgICAgaCA9IDQgKyAociAtIGcpIC8gZGVsdGE7CiAgICAgIH0KCiAgICAgIGggPSBNYXRoLm1pbihoICogNjAsIDM2MCk7CgogICAgICBpZiAoaCA8IDApIHsKICAgICAgICBoICs9IDM2MDsKICAgICAgfQoKICAgICAgbCA9IChtaW4gKyBtYXgpIC8gMjsKCiAgICAgIGlmIChtYXggPT09IG1pbikgewogICAgICAgIHMgPSAwOwogICAgICB9IGVsc2UgaWYgKGwgPD0gMC41KSB7CiAgICAgICAgcyA9IGRlbHRhIC8gKG1heCArIG1pbik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcyA9IGRlbHRhIC8gKDIgLSBtYXggLSBtaW4pOwogICAgICB9CgogICAgICByZXR1cm4gW2gsIHMgKiAxMDAsIGwgKiAxMDBdOwogICAgfTsKCiAgICBjb252ZXJ0LnJnYi5oc3YgPSBmdW5jdGlvbiAocmdiKSB7CiAgICAgIHZhciByZGlmOwogICAgICB2YXIgZ2RpZjsKICAgICAgdmFyIGJkaWY7CiAgICAgIHZhciBoOwogICAgICB2YXIgczsKICAgICAgdmFyIHIgPSByZ2JbMF0gLyAyNTU7CiAgICAgIHZhciBnID0gcmdiWzFdIC8gMjU1OwogICAgICB2YXIgYiA9IHJnYlsyXSAvIDI1NTsKICAgICAgdmFyIHYgPSBNYXRoLm1heChyLCBnLCBiKTsKICAgICAgdmFyIGRpZmYgPSB2IC0gTWF0aC5taW4ociwgZywgYik7CgogICAgICB2YXIgZGlmZmMgPSBmdW5jdGlvbiBkaWZmYyhjKSB7CiAgICAgICAgcmV0dXJuICh2IC0gYykgLyA2IC8gZGlmZiArIDEgLyAyOwogICAgICB9OwoKICAgICAgaWYgKGRpZmYgPT09IDApIHsKICAgICAgICBoID0gcyA9IDA7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcyA9IGRpZmYgLyB2OwogICAgICAgIHJkaWYgPSBkaWZmYyhyKTsKICAgICAgICBnZGlmID0gZGlmZmMoZyk7CiAgICAgICAgYmRpZiA9IGRpZmZjKGIpOwoKICAgICAgICBpZiAociA9PT0gdikgewogICAgICAgICAgaCA9IGJkaWYgLSBnZGlmOwogICAgICAgIH0gZWxzZSBpZiAoZyA9PT0gdikgewogICAgICAgICAgaCA9IDEgLyAzICsgcmRpZiAtIGJkaWY7CiAgICAgICAgfSBlbHNlIGlmIChiID09PSB2KSB7CiAgICAgICAgICBoID0gMiAvIDMgKyBnZGlmIC0gcmRpZjsKICAgICAgICB9CgogICAgICAgIGlmIChoIDwgMCkgewogICAgICAgICAgaCArPSAxOwogICAgICAgIH0gZWxzZSBpZiAoaCA+IDEpIHsKICAgICAgICAgIGggLT0gMTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBbaCAqIDM2MCwgcyAqIDEwMCwgdiAqIDEwMF07CiAgICB9OwoKICAgIGNvbnZlcnQucmdiLmh3YiA9IGZ1bmN0aW9uIChyZ2IpIHsKICAgICAgdmFyIHIgPSByZ2JbMF07CiAgICAgIHZhciBnID0gcmdiWzFdOwogICAgICB2YXIgYiA9IHJnYlsyXTsKICAgICAgdmFyIGggPSBjb252ZXJ0LnJnYi5oc2wocmdiKVswXTsKICAgICAgdmFyIHcgPSAxIC8gMjU1ICogTWF0aC5taW4ociwgTWF0aC5taW4oZywgYikpOwogICAgICBiID0gMSAtIDEgLyAyNTUgKiBNYXRoLm1heChyLCBNYXRoLm1heChnLCBiKSk7CiAgICAgIHJldHVybiBbaCwgdyAqIDEwMCwgYiAqIDEwMF07CiAgICB9OwoKICAgIGNvbnZlcnQucmdiLmNteWsgPSBmdW5jdGlvbiAocmdiKSB7CiAgICAgIHZhciByID0gcmdiWzBdIC8gMjU1OwogICAgICB2YXIgZyA9IHJnYlsxXSAvIDI1NTsKICAgICAgdmFyIGIgPSByZ2JbMl0gLyAyNTU7CiAgICAgIHZhciBjOwogICAgICB2YXIgbTsKICAgICAgdmFyIHk7CiAgICAgIHZhciBrOwogICAgICBrID0gTWF0aC5taW4oMSAtIHIsIDEgLSBnLCAxIC0gYik7CiAgICAgIGMgPSAoMSAtIHIgLSBrKSAvICgxIC0gaykgfHwgMDsKICAgICAgbSA9ICgxIC0gZyAtIGspIC8gKDEgLSBrKSB8fCAwOwogICAgICB5ID0gKDEgLSBiIC0gaykgLyAoMSAtIGspIHx8IDA7CiAgICAgIHJldHVybiBbYyAqIDEwMCwgbSAqIDEwMCwgeSAqIDEwMCwgayAqIDEwMF07CiAgICB9OwogICAgLyoqCiAgICAgKiBTZWUgaHR0cHM6Ly9lbi5tLndpa2lwZWRpYS5vcmcvd2lraS9FdWNsaWRlYW5fZGlzdGFuY2UjU3F1YXJlZF9FdWNsaWRlYW5fZGlzdGFuY2UKICAgICAqICovCgoKICAgIGZ1bmN0aW9uIGNvbXBhcmF0aXZlRGlzdGFuY2UoeCwgeSkgewogICAgICByZXR1cm4gTWF0aC5wb3coeFswXSAtIHlbMF0sIDIpICsgTWF0aC5wb3coeFsxXSAtIHlbMV0sIDIpICsgTWF0aC5wb3coeFsyXSAtIHlbMl0sIDIpOwogICAgfQoKICAgIGNvbnZlcnQucmdiLmtleXdvcmQgPSBmdW5jdGlvbiAocmdiKSB7CiAgICAgIHZhciByZXZlcnNlZCA9IHJldmVyc2VLZXl3b3Jkc1tyZ2JdOwoKICAgICAgaWYgKHJldmVyc2VkKSB7CiAgICAgICAgcmV0dXJuIHJldmVyc2VkOwogICAgICB9CgogICAgICB2YXIgY3VycmVudENsb3Nlc3REaXN0YW5jZSA9IEluZmluaXR5OwogICAgICB2YXIgY3VycmVudENsb3Nlc3RLZXl3b3JkOwoKICAgICAgZm9yICh2YXIga2V5d29yZCBpbiBjb2xvck5hbWUpIHsKICAgICAgICBpZiAoY29sb3JOYW1lLmhhc093blByb3BlcnR5KGtleXdvcmQpKSB7CiAgICAgICAgICB2YXIgdmFsdWUgPSBjb2xvck5hbWVba2V5d29yZF07IC8vIENvbXB1dGUgY29tcGFyYXRpdmUgZGlzdGFuY2UKCiAgICAgICAgICB2YXIgZGlzdGFuY2UgPSBjb21wYXJhdGl2ZURpc3RhbmNlKHJnYiwgdmFsdWUpOyAvLyBDaGVjayBpZiBpdHMgbGVzcywgaWYgc28gc2V0IGFzIGNsb3Nlc3QKCiAgICAgICAgICBpZiAoZGlzdGFuY2UgPCBjdXJyZW50Q2xvc2VzdERpc3RhbmNlKSB7CiAgICAgICAgICAgIGN1cnJlbnRDbG9zZXN0RGlzdGFuY2UgPSBkaXN0YW5jZTsKICAgICAgICAgICAgY3VycmVudENsb3Nlc3RLZXl3b3JkID0ga2V5d29yZDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBjdXJyZW50Q2xvc2VzdEtleXdvcmQ7CiAgICB9OwoKICAgIGNvbnZlcnQua2V5d29yZC5yZ2IgPSBmdW5jdGlvbiAoa2V5d29yZCkgewogICAgICByZXR1cm4gY29sb3JOYW1lW2tleXdvcmRdOwogICAgfTsKCiAgICBjb252ZXJ0LnJnYi54eXogPSBmdW5jdGlvbiAocmdiKSB7CiAgICAgIHZhciByID0gcmdiWzBdIC8gMjU1OwogICAgICB2YXIgZyA9IHJnYlsxXSAvIDI1NTsKICAgICAgdmFyIGIgPSByZ2JbMl0gLyAyNTU7IC8vIGFzc3VtZSBzUkdCCgogICAgICByID0gciA+IDAuMDQwNDUgPyBNYXRoLnBvdygociArIDAuMDU1KSAvIDEuMDU1LCAyLjQpIDogciAvIDEyLjkyOwogICAgICBnID0gZyA+IDAuMDQwNDUgPyBNYXRoLnBvdygoZyArIDAuMDU1KSAvIDEuMDU1LCAyLjQpIDogZyAvIDEyLjkyOwogICAgICBiID0gYiA+IDAuMDQwNDUgPyBNYXRoLnBvdygoYiArIDAuMDU1KSAvIDEuMDU1LCAyLjQpIDogYiAvIDEyLjkyOwogICAgICB2YXIgeCA9IHIgKiAwLjQxMjQgKyBnICogMC4zNTc2ICsgYiAqIDAuMTgwNTsKICAgICAgdmFyIHkgPSByICogMC4yMTI2ICsgZyAqIDAuNzE1MiArIGIgKiAwLjA3MjI7CiAgICAgIHZhciB6ID0gciAqIDAuMDE5MyArIGcgKiAwLjExOTIgKyBiICogMC45NTA1OwogICAgICByZXR1cm4gW3ggKiAxMDAsIHkgKiAxMDAsIHogKiAxMDBdOwogICAgfTsKCiAgICBjb252ZXJ0LnJnYi5sYWIgPSBmdW5jdGlvbiAocmdiKSB7CiAgICAgIHZhciB4eXogPSBjb252ZXJ0LnJnYi54eXoocmdiKTsKICAgICAgdmFyIHggPSB4eXpbMF07CiAgICAgIHZhciB5ID0geHl6WzFdOwogICAgICB2YXIgeiA9IHh5elsyXTsKICAgICAgdmFyIGw7CiAgICAgIHZhciBhOwogICAgICB2YXIgYjsKICAgICAgeCAvPSA5NS4wNDc7CiAgICAgIHkgLz0gMTAwOwogICAgICB6IC89IDEwOC44ODM7CiAgICAgIHggPSB4ID4gMC4wMDg4NTYgPyBNYXRoLnBvdyh4LCAxIC8gMykgOiA3Ljc4NyAqIHggKyAxNiAvIDExNjsKICAgICAgeSA9IHkgPiAwLjAwODg1NiA/IE1hdGgucG93KHksIDEgLyAzKSA6IDcuNzg3ICogeSArIDE2IC8gMTE2OwogICAgICB6ID0geiA+IDAuMDA4ODU2ID8gTWF0aC5wb3coeiwgMSAvIDMpIDogNy43ODcgKiB6ICsgMTYgLyAxMTY7CiAgICAgIGwgPSAxMTYgKiB5IC0gMTY7CiAgICAgIGEgPSA1MDAgKiAoeCAtIHkpOwogICAgICBiID0gMjAwICogKHkgLSB6KTsKICAgICAgcmV0dXJuIFtsLCBhLCBiXTsKICAgIH07CgogICAgY29udmVydC5oc2wucmdiID0gZnVuY3Rpb24gKGhzbCkgewogICAgICB2YXIgaCA9IGhzbFswXSAvIDM2MDsKICAgICAgdmFyIHMgPSBoc2xbMV0gLyAxMDA7CiAgICAgIHZhciBsID0gaHNsWzJdIC8gMTAwOwogICAgICB2YXIgdDE7CiAgICAgIHZhciB0MjsKICAgICAgdmFyIHQzOwogICAgICB2YXIgcmdiOwogICAgICB2YXIgdmFsOwoKICAgICAgaWYgKHMgPT09IDApIHsKICAgICAgICB2YWwgPSBsICogMjU1OwogICAgICAgIHJldHVybiBbdmFsLCB2YWwsIHZhbF07CiAgICAgIH0KCiAgICAgIGlmIChsIDwgMC41KSB7CiAgICAgICAgdDIgPSBsICogKDEgKyBzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0MiA9IGwgKyBzIC0gbCAqIHM7CiAgICAgIH0KCiAgICAgIHQxID0gMiAqIGwgLSB0MjsKICAgICAgcmdiID0gWzAsIDAsIDBdOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAzOyBpKyspIHsKICAgICAgICB0MyA9IGggKyAxIC8gMyAqIC0oaSAtIDEpOwoKICAgICAgICBpZiAodDMgPCAwKSB7CiAgICAgICAgICB0MysrOwogICAgICAgIH0KCiAgICAgICAgaWYgKHQzID4gMSkgewogICAgICAgICAgdDMtLTsKICAgICAgICB9CgogICAgICAgIGlmICg2ICogdDMgPCAxKSB7CiAgICAgICAgICB2YWwgPSB0MSArICh0MiAtIHQxKSAqIDYgKiB0MzsKICAgICAgICB9IGVsc2UgaWYgKDIgKiB0MyA8IDEpIHsKICAgICAgICAgIHZhbCA9IHQyOwogICAgICAgIH0gZWxzZSBpZiAoMyAqIHQzIDwgMikgewogICAgICAgICAgdmFsID0gdDEgKyAodDIgLSB0MSkgKiAoMiAvIDMgLSB0MykgKiA2OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YWwgPSB0MTsKICAgICAgICB9CgogICAgICAgIHJnYltpXSA9IHZhbCAqIDI1NTsKICAgICAgfQoKICAgICAgcmV0dXJuIHJnYjsKICAgIH07CgogICAgY29udmVydC5oc2wuaHN2ID0gZnVuY3Rpb24gKGhzbCkgewogICAgICB2YXIgaCA9IGhzbFswXTsKICAgICAgdmFyIHMgPSBoc2xbMV0gLyAxMDA7CiAgICAgIHZhciBsID0gaHNsWzJdIC8gMTAwOwogICAgICB2YXIgc21pbiA9IHM7CiAgICAgIHZhciBsbWluID0gTWF0aC5tYXgobCwgMC4wMSk7CiAgICAgIHZhciBzdjsKICAgICAgdmFyIHY7CiAgICAgIGwgKj0gMjsKICAgICAgcyAqPSBsIDw9IDEgPyBsIDogMiAtIGw7CiAgICAgIHNtaW4gKj0gbG1pbiA8PSAxID8gbG1pbiA6IDIgLSBsbWluOwogICAgICB2ID0gKGwgKyBzKSAvIDI7CiAgICAgIHN2ID0gbCA9PT0gMCA/IDIgKiBzbWluIC8gKGxtaW4gKyBzbWluKSA6IDIgKiBzIC8gKGwgKyBzKTsKICAgICAgcmV0dXJuIFtoLCBzdiAqIDEwMCwgdiAqIDEwMF07CiAgICB9OwoKICAgIGNvbnZlcnQuaHN2LnJnYiA9IGZ1bmN0aW9uIChoc3YpIHsKICAgICAgdmFyIGggPSBoc3ZbMF0gLyA2MDsKICAgICAgdmFyIHMgPSBoc3ZbMV0gLyAxMDA7CiAgICAgIHZhciB2ID0gaHN2WzJdIC8gMTAwOwogICAgICB2YXIgaGkgPSBNYXRoLmZsb29yKGgpICUgNjsKICAgICAgdmFyIGYgPSBoIC0gTWF0aC5mbG9vcihoKTsKICAgICAgdmFyIHAgPSAyNTUgKiB2ICogKDEgLSBzKTsKICAgICAgdmFyIHEgPSAyNTUgKiB2ICogKDEgLSBzICogZik7CiAgICAgIHZhciB0ID0gMjU1ICogdiAqICgxIC0gcyAqICgxIC0gZikpOwogICAgICB2ICo9IDI1NTsKCiAgICAgIHN3aXRjaCAoaGkpIHsKICAgICAgICBjYXNlIDA6CiAgICAgICAgICByZXR1cm4gW3YsIHQsIHBdOwoKICAgICAgICBjYXNlIDE6CiAgICAgICAgICByZXR1cm4gW3EsIHYsIHBdOwoKICAgICAgICBjYXNlIDI6CiAgICAgICAgICByZXR1cm4gW3AsIHYsIHRdOwoKICAgICAgICBjYXNlIDM6CiAgICAgICAgICByZXR1cm4gW3AsIHEsIHZdOwoKICAgICAgICBjYXNlIDQ6CiAgICAgICAgICByZXR1cm4gW3QsIHAsIHZdOwoKICAgICAgICBjYXNlIDU6CiAgICAgICAgICByZXR1cm4gW3YsIHAsIHFdOwogICAgICB9CiAgICB9OwoKICAgIGNvbnZlcnQuaHN2LmhzbCA9IGZ1bmN0aW9uIChoc3YpIHsKICAgICAgdmFyIGggPSBoc3ZbMF07CiAgICAgIHZhciBzID0gaHN2WzFdIC8gMTAwOwogICAgICB2YXIgdiA9IGhzdlsyXSAvIDEwMDsKICAgICAgdmFyIHZtaW4gPSBNYXRoLm1heCh2LCAwLjAxKTsKICAgICAgdmFyIGxtaW47CiAgICAgIHZhciBzbDsKICAgICAgdmFyIGw7CiAgICAgIGwgPSAoMiAtIHMpICogdjsKICAgICAgbG1pbiA9ICgyIC0gcykgKiB2bWluOwogICAgICBzbCA9IHMgKiB2bWluOwogICAgICBzbCAvPSBsbWluIDw9IDEgPyBsbWluIDogMiAtIGxtaW47CiAgICAgIHNsID0gc2wgfHwgMDsKICAgICAgbCAvPSAyOwogICAgICByZXR1cm4gW2gsIHNsICogMTAwLCBsICogMTAwXTsKICAgIH07IC8vIGh0dHA6Ly9kZXYudzMub3JnL2Nzc3dnL2Nzcy1jb2xvci8jaHdiLXRvLXJnYgoKCiAgICBjb252ZXJ0Lmh3Yi5yZ2IgPSBmdW5jdGlvbiAoaHdiKSB7CiAgICAgIHZhciBoID0gaHdiWzBdIC8gMzYwOwogICAgICB2YXIgd2ggPSBod2JbMV0gLyAxMDA7CiAgICAgIHZhciBibCA9IGh3YlsyXSAvIDEwMDsKICAgICAgdmFyIHJhdGlvID0gd2ggKyBibDsKICAgICAgdmFyIGk7CiAgICAgIHZhciB2OwogICAgICB2YXIgZjsKICAgICAgdmFyIG47IC8vIHdoICsgYmwgY2FudCBiZSA+IDEKCiAgICAgIGlmIChyYXRpbyA+IDEpIHsKICAgICAgICB3aCAvPSByYXRpbzsKICAgICAgICBibCAvPSByYXRpbzsKICAgICAgfQoKICAgICAgaSA9IE1hdGguZmxvb3IoNiAqIGgpOwogICAgICB2ID0gMSAtIGJsOwogICAgICBmID0gNiAqIGggLSBpOwoKICAgICAgaWYgKChpICYgMHgwMSkgIT09IDApIHsKICAgICAgICBmID0gMSAtIGY7CiAgICAgIH0KCiAgICAgIG4gPSB3aCArIGYgKiAodiAtIHdoKTsgLy8gbGluZWFyIGludGVycG9sYXRpb24KCiAgICAgIHZhciByOwogICAgICB2YXIgZzsKICAgICAgdmFyIGI7CgogICAgICBzd2l0Y2ggKGkpIHsKICAgICAgICBkZWZhdWx0OgogICAgICAgIGNhc2UgNjoKICAgICAgICBjYXNlIDA6CiAgICAgICAgICByID0gdjsKICAgICAgICAgIGcgPSBuOwogICAgICAgICAgYiA9IHdoOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgMToKICAgICAgICAgIHIgPSBuOwogICAgICAgICAgZyA9IHY7CiAgICAgICAgICBiID0gd2g7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAyOgogICAgICAgICAgciA9IHdoOwogICAgICAgICAgZyA9IHY7CiAgICAgICAgICBiID0gbjsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIDM6CiAgICAgICAgICByID0gd2g7CiAgICAgICAgICBnID0gbjsKICAgICAgICAgIGIgPSB2OwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgNDoKICAgICAgICAgIHIgPSBuOwogICAgICAgICAgZyA9IHdoOwogICAgICAgICAgYiA9IHY7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSA1OgogICAgICAgICAgciA9IHY7CiAgICAgICAgICBnID0gd2g7CiAgICAgICAgICBiID0gbjsKICAgICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICByZXR1cm4gW3IgKiAyNTUsIGcgKiAyNTUsIGIgKiAyNTVdOwogICAgfTsKCiAgICBjb252ZXJ0LmNteWsucmdiID0gZnVuY3Rpb24gKGNteWspIHsKICAgICAgdmFyIGMgPSBjbXlrWzBdIC8gMTAwOwogICAgICB2YXIgbSA9IGNteWtbMV0gLyAxMDA7CiAgICAgIHZhciB5ID0gY215a1syXSAvIDEwMDsKICAgICAgdmFyIGsgPSBjbXlrWzNdIC8gMTAwOwogICAgICB2YXIgcjsKICAgICAgdmFyIGc7CiAgICAgIHZhciBiOwogICAgICByID0gMSAtIE1hdGgubWluKDEsIGMgKiAoMSAtIGspICsgayk7CiAgICAgIGcgPSAxIC0gTWF0aC5taW4oMSwgbSAqICgxIC0gaykgKyBrKTsKICAgICAgYiA9IDEgLSBNYXRoLm1pbigxLCB5ICogKDEgLSBrKSArIGspOwogICAgICByZXR1cm4gW3IgKiAyNTUsIGcgKiAyNTUsIGIgKiAyNTVdOwogICAgfTsKCiAgICBjb252ZXJ0Lnh5ei5yZ2IgPSBmdW5jdGlvbiAoeHl6KSB7CiAgICAgIHZhciB4ID0geHl6WzBdIC8gMTAwOwogICAgICB2YXIgeSA9IHh5elsxXSAvIDEwMDsKICAgICAgdmFyIHogPSB4eXpbMl0gLyAxMDA7CiAgICAgIHZhciByOwogICAgICB2YXIgZzsKICAgICAgdmFyIGI7CiAgICAgIHIgPSB4ICogMy4yNDA2ICsgeSAqIC0xLjUzNzIgKyB6ICogLTAuNDk4NjsKICAgICAgZyA9IHggKiAtMC45Njg5ICsgeSAqIDEuODc1OCArIHogKiAwLjA0MTU7CiAgICAgIGIgPSB4ICogMC4wNTU3ICsgeSAqIC0wLjIwNDAgKyB6ICogMS4wNTcwOyAvLyBhc3N1bWUgc1JHQgoKICAgICAgciA9IHIgPiAwLjAwMzEzMDggPyAxLjA1NSAqIE1hdGgucG93KHIsIDEuMCAvIDIuNCkgLSAwLjA1NSA6IHIgKiAxMi45MjsKICAgICAgZyA9IGcgPiAwLjAwMzEzMDggPyAxLjA1NSAqIE1hdGgucG93KGcsIDEuMCAvIDIuNCkgLSAwLjA1NSA6IGcgKiAxMi45MjsKICAgICAgYiA9IGIgPiAwLjAwMzEzMDggPyAxLjA1NSAqIE1hdGgucG93KGIsIDEuMCAvIDIuNCkgLSAwLjA1NSA6IGIgKiAxMi45MjsKICAgICAgciA9IE1hdGgubWluKE1hdGgubWF4KDAsIHIpLCAxKTsKICAgICAgZyA9IE1hdGgubWluKE1hdGgubWF4KDAsIGcpLCAxKTsKICAgICAgYiA9IE1hdGgubWluKE1hdGgubWF4KDAsIGIpLCAxKTsKICAgICAgcmV0dXJuIFtyICogMjU1LCBnICogMjU1LCBiICogMjU1XTsKICAgIH07CgogICAgY29udmVydC54eXoubGFiID0gZnVuY3Rpb24gKHh5eikgewogICAgICB2YXIgeCA9IHh5elswXTsKICAgICAgdmFyIHkgPSB4eXpbMV07CiAgICAgIHZhciB6ID0geHl6WzJdOwogICAgICB2YXIgbDsKICAgICAgdmFyIGE7CiAgICAgIHZhciBiOwogICAgICB4IC89IDk1LjA0NzsKICAgICAgeSAvPSAxMDA7CiAgICAgIHogLz0gMTA4Ljg4MzsKICAgICAgeCA9IHggPiAwLjAwODg1NiA/IE1hdGgucG93KHgsIDEgLyAzKSA6IDcuNzg3ICogeCArIDE2IC8gMTE2OwogICAgICB5ID0geSA+IDAuMDA4ODU2ID8gTWF0aC5wb3coeSwgMSAvIDMpIDogNy43ODcgKiB5ICsgMTYgLyAxMTY7CiAgICAgIHogPSB6ID4gMC4wMDg4NTYgPyBNYXRoLnBvdyh6LCAxIC8gMykgOiA3Ljc4NyAqIHogKyAxNiAvIDExNjsKICAgICAgbCA9IDExNiAqIHkgLSAxNjsKICAgICAgYSA9IDUwMCAqICh4IC0geSk7CiAgICAgIGIgPSAyMDAgKiAoeSAtIHopOwogICAgICByZXR1cm4gW2wsIGEsIGJdOwogICAgfTsKCiAgICBjb252ZXJ0LmxhYi54eXogPSBmdW5jdGlvbiAobGFiKSB7CiAgICAgIHZhciBsID0gbGFiWzBdOwogICAgICB2YXIgYSA9IGxhYlsxXTsKICAgICAgdmFyIGIgPSBsYWJbMl07CiAgICAgIHZhciB4OwogICAgICB2YXIgeTsKICAgICAgdmFyIHo7CiAgICAgIHkgPSAobCArIDE2KSAvIDExNjsKICAgICAgeCA9IGEgLyA1MDAgKyB5OwogICAgICB6ID0geSAtIGIgLyAyMDA7CiAgICAgIHZhciB5MiA9IE1hdGgucG93KHksIDMpOwogICAgICB2YXIgeDIgPSBNYXRoLnBvdyh4LCAzKTsKICAgICAgdmFyIHoyID0gTWF0aC5wb3coeiwgMyk7CiAgICAgIHkgPSB5MiA+IDAuMDA4ODU2ID8geTIgOiAoeSAtIDE2IC8gMTE2KSAvIDcuNzg3OwogICAgICB4ID0geDIgPiAwLjAwODg1NiA/IHgyIDogKHggLSAxNiAvIDExNikgLyA3Ljc4NzsKICAgICAgeiA9IHoyID4gMC4wMDg4NTYgPyB6MiA6ICh6IC0gMTYgLyAxMTYpIC8gNy43ODc7CiAgICAgIHggKj0gOTUuMDQ3OwogICAgICB5ICo9IDEwMDsKICAgICAgeiAqPSAxMDguODgzOwogICAgICByZXR1cm4gW3gsIHksIHpdOwogICAgfTsKCiAgICBjb252ZXJ0LmxhYi5sY2ggPSBmdW5jdGlvbiAobGFiKSB7CiAgICAgIHZhciBsID0gbGFiWzBdOwogICAgICB2YXIgYSA9IGxhYlsxXTsKICAgICAgdmFyIGIgPSBsYWJbMl07CiAgICAgIHZhciBocjsKICAgICAgdmFyIGg7CiAgICAgIHZhciBjOwogICAgICBociA9IE1hdGguYXRhbjIoYiwgYSk7CiAgICAgIGggPSBociAqIDM2MCAvIDIgLyBNYXRoLlBJOwoKICAgICAgaWYgKGggPCAwKSB7CiAgICAgICAgaCArPSAzNjA7CiAgICAgIH0KCiAgICAgIGMgPSBNYXRoLnNxcnQoYSAqIGEgKyBiICogYik7CiAgICAgIHJldHVybiBbbCwgYywgaF07CiAgICB9OwoKICAgIGNvbnZlcnQubGNoLmxhYiA9IGZ1bmN0aW9uIChsY2gpIHsKICAgICAgdmFyIGwgPSBsY2hbMF07CiAgICAgIHZhciBjID0gbGNoWzFdOwogICAgICB2YXIgaCA9IGxjaFsyXTsKICAgICAgdmFyIGE7CiAgICAgIHZhciBiOwogICAgICB2YXIgaHI7CiAgICAgIGhyID0gaCAvIDM2MCAqIDIgKiBNYXRoLlBJOwogICAgICBhID0gYyAqIE1hdGguY29zKGhyKTsKICAgICAgYiA9IGMgKiBNYXRoLnNpbihocik7CiAgICAgIHJldHVybiBbbCwgYSwgYl07CiAgICB9OwoKICAgIGNvbnZlcnQucmdiLmFuc2kxNiA9IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIHZhciByID0gYXJnc1swXTsKICAgICAgdmFyIGcgPSBhcmdzWzFdOwogICAgICB2YXIgYiA9IGFyZ3NbMl07CiAgICAgIHZhciB2YWx1ZSA9IDEgaW4gYXJndW1lbnRzID8gYXJndW1lbnRzWzFdIDogY29udmVydC5yZ2IuaHN2KGFyZ3MpWzJdOyAvLyBoc3YgLT4gYW5zaTE2IG9wdGltaXphdGlvbgoKICAgICAgdmFsdWUgPSBNYXRoLnJvdW5kKHZhbHVlIC8gNTApOwoKICAgICAgaWYgKHZhbHVlID09PSAwKSB7CiAgICAgICAgcmV0dXJuIDMwOwogICAgICB9CgogICAgICB2YXIgYW5zaSA9IDMwICsgKE1hdGgucm91bmQoYiAvIDI1NSkgPDwgMiB8IE1hdGgucm91bmQoZyAvIDI1NSkgPDwgMSB8IE1hdGgucm91bmQociAvIDI1NSkpOwoKICAgICAgaWYgKHZhbHVlID09PSAyKSB7CiAgICAgICAgYW5zaSArPSA2MDsKICAgICAgfQoKICAgICAgcmV0dXJuIGFuc2k7CiAgICB9OwoKICAgIGNvbnZlcnQuaHN2LmFuc2kxNiA9IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIC8vIG9wdGltaXphdGlvbiBoZXJlOyB3ZSBhbHJlYWR5IGtub3cgdGhlIHZhbHVlIGFuZCBkb24ndCBuZWVkIHRvIGdldAogICAgICAvLyBpdCBjb252ZXJ0ZWQgZm9yIHVzLgogICAgICByZXR1cm4gY29udmVydC5yZ2IuYW5zaTE2KGNvbnZlcnQuaHN2LnJnYihhcmdzKSwgYXJnc1syXSk7CiAgICB9OwoKICAgIGNvbnZlcnQucmdiLmFuc2kyNTYgPSBmdW5jdGlvbiAoYXJncykgewogICAgICB2YXIgciA9IGFyZ3NbMF07CiAgICAgIHZhciBnID0gYXJnc1sxXTsKICAgICAgdmFyIGIgPSBhcmdzWzJdOyAvLyB3ZSB1c2UgdGhlIGV4dGVuZGVkIGdyZXlzY2FsZSBwYWxldHRlIGhlcmUsIHdpdGggdGhlIGV4Y2VwdGlvbiBvZgogICAgICAvLyBibGFjayBhbmQgd2hpdGUuIG5vcm1hbCBwYWxldHRlIG9ubHkgaGFzIDQgZ3JleXNjYWxlIHNoYWRlcy4KCiAgICAgIGlmIChyID09PSBnICYmIGcgPT09IGIpIHsKICAgICAgICBpZiAociA8IDgpIHsKICAgICAgICAgIHJldHVybiAxNjsKICAgICAgICB9CgogICAgICAgIGlmIChyID4gMjQ4KSB7CiAgICAgICAgICByZXR1cm4gMjMxOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoKHIgLSA4KSAvIDI0NyAqIDI0KSArIDIzMjsKICAgICAgfQoKICAgICAgdmFyIGFuc2kgPSAxNiArIDM2ICogTWF0aC5yb3VuZChyIC8gMjU1ICogNSkgKyA2ICogTWF0aC5yb3VuZChnIC8gMjU1ICogNSkgKyBNYXRoLnJvdW5kKGIgLyAyNTUgKiA1KTsKICAgICAgcmV0dXJuIGFuc2k7CiAgICB9OwoKICAgIGNvbnZlcnQuYW5zaTE2LnJnYiA9IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIHZhciBjb2xvciA9IGFyZ3MgJSAxMDsgLy8gaGFuZGxlIGdyZXlzY2FsZQoKICAgICAgaWYgKGNvbG9yID09PSAwIHx8IGNvbG9yID09PSA3KSB7CiAgICAgICAgaWYgKGFyZ3MgPiA1MCkgewogICAgICAgICAgY29sb3IgKz0gMy41OwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciAvIDEwLjUgKiAyNTU7CiAgICAgICAgcmV0dXJuIFtjb2xvciwgY29sb3IsIGNvbG9yXTsKICAgICAgfQoKICAgICAgdmFyIG11bHQgPSAofn4oYXJncyA+IDUwKSArIDEpICogMC41OwogICAgICB2YXIgciA9IChjb2xvciAmIDEpICogbXVsdCAqIDI1NTsKICAgICAgdmFyIGcgPSAoY29sb3IgPj4gMSAmIDEpICogbXVsdCAqIDI1NTsKICAgICAgdmFyIGIgPSAoY29sb3IgPj4gMiAmIDEpICogbXVsdCAqIDI1NTsKICAgICAgcmV0dXJuIFtyLCBnLCBiXTsKICAgIH07CgogICAgY29udmVydC5hbnNpMjU2LnJnYiA9IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIC8vIGhhbmRsZSBncmV5c2NhbGUKICAgICAgaWYgKGFyZ3MgPj0gMjMyKSB7CiAgICAgICAgdmFyIGMgPSAoYXJncyAtIDIzMikgKiAxMCArIDg7CiAgICAgICAgcmV0dXJuIFtjLCBjLCBjXTsKICAgICAgfQoKICAgICAgYXJncyAtPSAxNjsKICAgICAgdmFyIHJlbTsKICAgICAgdmFyIHIgPSBNYXRoLmZsb29yKGFyZ3MgLyAzNikgLyA1ICogMjU1OwogICAgICB2YXIgZyA9IE1hdGguZmxvb3IoKHJlbSA9IGFyZ3MgJSAzNikgLyA2KSAvIDUgKiAyNTU7CiAgICAgIHZhciBiID0gcmVtICUgNiAvIDUgKiAyNTU7CiAgICAgIHJldHVybiBbciwgZywgYl07CiAgICB9OwoKICAgIGNvbnZlcnQucmdiLmhleCA9IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIHZhciBpbnRlZ2VyID0gKChNYXRoLnJvdW5kKGFyZ3NbMF0pICYgMHhGRikgPDwgMTYpICsgKChNYXRoLnJvdW5kKGFyZ3NbMV0pICYgMHhGRikgPDwgOCkgKyAoTWF0aC5yb3VuZChhcmdzWzJdKSAmIDB4RkYpOwogICAgICB2YXIgc3RyaW5nID0gaW50ZWdlci50b1N0cmluZygxNikudG9VcHBlckNhc2UoKTsKICAgICAgcmV0dXJuICcwMDAwMDAnLnN1YnN0cmluZyhzdHJpbmcubGVuZ3RoKSArIHN0cmluZzsKICAgIH07CgogICAgY29udmVydC5oZXgucmdiID0gZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgdmFyIG1hdGNoID0gYXJncy50b1N0cmluZygxNikubWF0Y2goL1thLWYwLTldezZ9fFthLWYwLTldezN9L2kpOwoKICAgICAgaWYgKCFtYXRjaCkgewogICAgICAgIHJldHVybiBbMCwgMCwgMF07CiAgICAgIH0KCiAgICAgIHZhciBjb2xvclN0cmluZyA9IG1hdGNoWzBdOwoKICAgICAgaWYgKG1hdGNoWzBdLmxlbmd0aCA9PT0gMykgewogICAgICAgIGNvbG9yU3RyaW5nID0gY29sb3JTdHJpbmcuc3BsaXQoJycpLm1hcChmdW5jdGlvbiAoY2hhcikgewogICAgICAgICAgcmV0dXJuIGNoYXIgKyBjaGFyOwogICAgICAgIH0pLmpvaW4oJycpOwogICAgICB9CgogICAgICB2YXIgaW50ZWdlciA9IHBhcnNlSW50KGNvbG9yU3RyaW5nLCAxNik7CiAgICAgIHZhciByID0gaW50ZWdlciA+PiAxNiAmIDB4RkY7CiAgICAgIHZhciBnID0gaW50ZWdlciA+PiA4ICYgMHhGRjsKICAgICAgdmFyIGIgPSBpbnRlZ2VyICYgMHhGRjsKICAgICAgcmV0dXJuIFtyLCBnLCBiXTsKICAgIH07CgogICAgY29udmVydC5yZ2IuaGNnID0gZnVuY3Rpb24gKHJnYikgewogICAgICB2YXIgciA9IHJnYlswXSAvIDI1NTsKICAgICAgdmFyIGcgPSByZ2JbMV0gLyAyNTU7CiAgICAgIHZhciBiID0gcmdiWzJdIC8gMjU1OwogICAgICB2YXIgbWF4ID0gTWF0aC5tYXgoTWF0aC5tYXgociwgZyksIGIpOwogICAgICB2YXIgbWluID0gTWF0aC5taW4oTWF0aC5taW4ociwgZyksIGIpOwogICAgICB2YXIgY2hyb21hID0gbWF4IC0gbWluOwogICAgICB2YXIgZ3JheXNjYWxlOwogICAgICB2YXIgaHVlOwoKICAgICAgaWYgKGNocm9tYSA8IDEpIHsKICAgICAgICBncmF5c2NhbGUgPSBtaW4gLyAoMSAtIGNocm9tYSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZ3JheXNjYWxlID0gMDsKICAgICAgfQoKICAgICAgaWYgKGNocm9tYSA8PSAwKSB7CiAgICAgICAgaHVlID0gMDsKICAgICAgfSBlbHNlIGlmIChtYXggPT09IHIpIHsKICAgICAgICBodWUgPSAoZyAtIGIpIC8gY2hyb21hICUgNjsKICAgICAgfSBlbHNlIGlmIChtYXggPT09IGcpIHsKICAgICAgICBodWUgPSAyICsgKGIgLSByKSAvIGNocm9tYTsKICAgICAgfSBlbHNlIHsKICAgICAgICBodWUgPSA0ICsgKHIgLSBnKSAvIGNocm9tYSArIDQ7CiAgICAgIH0KCiAgICAgIGh1ZSAvPSA2OwogICAgICBodWUgJT0gMTsKICAgICAgcmV0dXJuIFtodWUgKiAzNjAsIGNocm9tYSAqIDEwMCwgZ3JheXNjYWxlICogMTAwXTsKICAgIH07CgogICAgY29udmVydC5oc2wuaGNnID0gZnVuY3Rpb24gKGhzbCkgewogICAgICB2YXIgcyA9IGhzbFsxXSAvIDEwMDsKICAgICAgdmFyIGwgPSBoc2xbMl0gLyAxMDA7CiAgICAgIHZhciBjID0gMTsKICAgICAgdmFyIGYgPSAwOwoKICAgICAgaWYgKGwgPCAwLjUpIHsKICAgICAgICBjID0gMi4wICogcyAqIGw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYyA9IDIuMCAqIHMgKiAoMS4wIC0gbCk7CiAgICAgIH0KCiAgICAgIGlmIChjIDwgMS4wKSB7CiAgICAgICAgZiA9IChsIC0gMC41ICogYykgLyAoMS4wIC0gYyk7CiAgICAgIH0KCiAgICAgIHJldHVybiBbaHNsWzBdLCBjICogMTAwLCBmICogMTAwXTsKICAgIH07CgogICAgY29udmVydC5oc3YuaGNnID0gZnVuY3Rpb24gKGhzdikgewogICAgICB2YXIgcyA9IGhzdlsxXSAvIDEwMDsKICAgICAgdmFyIHYgPSBoc3ZbMl0gLyAxMDA7CiAgICAgIHZhciBjID0gcyAqIHY7CiAgICAgIHZhciBmID0gMDsKCiAgICAgIGlmIChjIDwgMS4wKSB7CiAgICAgICAgZiA9ICh2IC0gYykgLyAoMSAtIGMpOwogICAgICB9CgogICAgICByZXR1cm4gW2hzdlswXSwgYyAqIDEwMCwgZiAqIDEwMF07CiAgICB9OwoKICAgIGNvbnZlcnQuaGNnLnJnYiA9IGZ1bmN0aW9uIChoY2cpIHsKICAgICAgdmFyIGggPSBoY2dbMF0gLyAzNjA7CiAgICAgIHZhciBjID0gaGNnWzFdIC8gMTAwOwogICAgICB2YXIgZyA9IGhjZ1syXSAvIDEwMDsKCiAgICAgIGlmIChjID09PSAwLjApIHsKICAgICAgICByZXR1cm4gW2cgKiAyNTUsIGcgKiAyNTUsIGcgKiAyNTVdOwogICAgICB9CgogICAgICB2YXIgcHVyZSA9IFswLCAwLCAwXTsKICAgICAgdmFyIGhpID0gaCAlIDEgKiA2OwogICAgICB2YXIgdiA9IGhpICUgMTsKICAgICAgdmFyIHcgPSAxIC0gdjsKICAgICAgdmFyIG1nID0gMDsKCiAgICAgIHN3aXRjaCAoTWF0aC5mbG9vcihoaSkpIHsKICAgICAgICBjYXNlIDA6CiAgICAgICAgICBwdXJlWzBdID0gMTsKICAgICAgICAgIHB1cmVbMV0gPSB2OwogICAgICAgICAgcHVyZVsyXSA9IDA7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAxOgogICAgICAgICAgcHVyZVswXSA9IHc7CiAgICAgICAgICBwdXJlWzFdID0gMTsKICAgICAgICAgIHB1cmVbMl0gPSAwOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgMjoKICAgICAgICAgIHB1cmVbMF0gPSAwOwogICAgICAgICAgcHVyZVsxXSA9IDE7CiAgICAgICAgICBwdXJlWzJdID0gdjsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlIDM6CiAgICAgICAgICBwdXJlWzBdID0gMDsKICAgICAgICAgIHB1cmVbMV0gPSB3OwogICAgICAgICAgcHVyZVsyXSA9IDE7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSA0OgogICAgICAgICAgcHVyZVswXSA9IHY7CiAgICAgICAgICBwdXJlWzFdID0gMDsKICAgICAgICAgIHB1cmVbMl0gPSAxOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICBwdXJlWzBdID0gMTsKICAgICAgICAgIHB1cmVbMV0gPSAwOwogICAgICAgICAgcHVyZVsyXSA9IHc7CiAgICAgIH0KCiAgICAgIG1nID0gKDEuMCAtIGMpICogZzsKICAgICAgcmV0dXJuIFsoYyAqIHB1cmVbMF0gKyBtZykgKiAyNTUsIChjICogcHVyZVsxXSArIG1nKSAqIDI1NSwgKGMgKiBwdXJlWzJdICsgbWcpICogMjU1XTsKICAgIH07CgogICAgY29udmVydC5oY2cuaHN2ID0gZnVuY3Rpb24gKGhjZykgewogICAgICB2YXIgYyA9IGhjZ1sxXSAvIDEwMDsKICAgICAgdmFyIGcgPSBoY2dbMl0gLyAxMDA7CiAgICAgIHZhciB2ID0gYyArIGcgKiAoMS4wIC0gYyk7CiAgICAgIHZhciBmID0gMDsKCiAgICAgIGlmICh2ID4gMC4wKSB7CiAgICAgICAgZiA9IGMgLyB2OwogICAgICB9CgogICAgICByZXR1cm4gW2hjZ1swXSwgZiAqIDEwMCwgdiAqIDEwMF07CiAgICB9OwoKICAgIGNvbnZlcnQuaGNnLmhzbCA9IGZ1bmN0aW9uIChoY2cpIHsKICAgICAgdmFyIGMgPSBoY2dbMV0gLyAxMDA7CiAgICAgIHZhciBnID0gaGNnWzJdIC8gMTAwOwogICAgICB2YXIgbCA9IGcgKiAoMS4wIC0gYykgKyAwLjUgKiBjOwogICAgICB2YXIgcyA9IDA7CgogICAgICBpZiAobCA+IDAuMCAmJiBsIDwgMC41KSB7CiAgICAgICAgcyA9IGMgLyAoMiAqIGwpOwogICAgICB9IGVsc2UgaWYgKGwgPj0gMC41ICYmIGwgPCAxLjApIHsKICAgICAgICBzID0gYyAvICgyICogKDEgLSBsKSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBbaGNnWzBdLCBzICogMTAwLCBsICogMTAwXTsKICAgIH07CgogICAgY29udmVydC5oY2cuaHdiID0gZnVuY3Rpb24gKGhjZykgewogICAgICB2YXIgYyA9IGhjZ1sxXSAvIDEwMDsKICAgICAgdmFyIGcgPSBoY2dbMl0gLyAxMDA7CiAgICAgIHZhciB2ID0gYyArIGcgKiAoMS4wIC0gYyk7CiAgICAgIHJldHVybiBbaGNnWzBdLCAodiAtIGMpICogMTAwLCAoMSAtIHYpICogMTAwXTsKICAgIH07CgogICAgY29udmVydC5od2IuaGNnID0gZnVuY3Rpb24gKGh3YikgewogICAgICB2YXIgdyA9IGh3YlsxXSAvIDEwMDsKICAgICAgdmFyIGIgPSBod2JbMl0gLyAxMDA7CiAgICAgIHZhciB2ID0gMSAtIGI7CiAgICAgIHZhciBjID0gdiAtIHc7CiAgICAgIHZhciBnID0gMDsKCiAgICAgIGlmIChjIDwgMSkgewogICAgICAgIGcgPSAodiAtIGMpIC8gKDEgLSBjKTsKICAgICAgfQoKICAgICAgcmV0dXJuIFtod2JbMF0sIGMgKiAxMDAsIGcgKiAxMDBdOwogICAgfTsKCiAgICBjb252ZXJ0LmFwcGxlLnJnYiA9IGZ1bmN0aW9uIChhcHBsZSkgewogICAgICByZXR1cm4gW2FwcGxlWzBdIC8gNjU1MzUgKiAyNTUsIGFwcGxlWzFdIC8gNjU1MzUgKiAyNTUsIGFwcGxlWzJdIC8gNjU1MzUgKiAyNTVdOwogICAgfTsKCiAgICBjb252ZXJ0LnJnYi5hcHBsZSA9IGZ1bmN0aW9uIChyZ2IpIHsKICAgICAgcmV0dXJuIFtyZ2JbMF0gLyAyNTUgKiA2NTUzNSwgcmdiWzFdIC8gMjU1ICogNjU1MzUsIHJnYlsyXSAvIDI1NSAqIDY1NTM1XTsKICAgIH07CgogICAgY29udmVydC5ncmF5LnJnYiA9IGZ1bmN0aW9uIChhcmdzKSB7CiAgICAgIHJldHVybiBbYXJnc1swXSAvIDEwMCAqIDI1NSwgYXJnc1swXSAvIDEwMCAqIDI1NSwgYXJnc1swXSAvIDEwMCAqIDI1NV07CiAgICB9OwoKICAgIGNvbnZlcnQuZ3JheS5oc2wgPSBjb252ZXJ0LmdyYXkuaHN2ID0gZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgcmV0dXJuIFswLCAwLCBhcmdzWzBdXTsKICAgIH07CgogICAgY29udmVydC5ncmF5Lmh3YiA9IGZ1bmN0aW9uIChncmF5KSB7CiAgICAgIHJldHVybiBbMCwgMTAwLCBncmF5WzBdXTsKICAgIH07CgogICAgY29udmVydC5ncmF5LmNteWsgPSBmdW5jdGlvbiAoZ3JheSkgewogICAgICByZXR1cm4gWzAsIDAsIDAsIGdyYXlbMF1dOwogICAgfTsKCiAgICBjb252ZXJ0LmdyYXkubGFiID0gZnVuY3Rpb24gKGdyYXkpIHsKICAgICAgcmV0dXJuIFtncmF5WzBdLCAwLCAwXTsKICAgIH07CgogICAgY29udmVydC5ncmF5LmhleCA9IGZ1bmN0aW9uIChncmF5KSB7CiAgICAgIHZhciB2YWwgPSBNYXRoLnJvdW5kKGdyYXlbMF0gLyAxMDAgKiAyNTUpICYgMHhGRjsKICAgICAgdmFyIGludGVnZXIgPSAodmFsIDw8IDE2KSArICh2YWwgPDwgOCkgKyB2YWw7CiAgICAgIHZhciBzdHJpbmcgPSBpbnRlZ2VyLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOwogICAgICByZXR1cm4gJzAwMDAwMCcuc3Vic3RyaW5nKHN0cmluZy5sZW5ndGgpICsgc3RyaW5nOwogICAgfTsKCiAgICBjb252ZXJ0LnJnYi5ncmF5ID0gZnVuY3Rpb24gKHJnYikgewogICAgICB2YXIgdmFsID0gKHJnYlswXSArIHJnYlsxXSArIHJnYlsyXSkgLyAzOwogICAgICByZXR1cm4gW3ZhbCAvIDI1NSAqIDEwMF07CiAgICB9OwogIH0pOwogIHZhciBjb252ZXJzaW9uc18xID0gY29udmVyc2lvbnMucmdiOwogIHZhciBjb252ZXJzaW9uc18yID0gY29udmVyc2lvbnMuaHNsOwogIHZhciBjb252ZXJzaW9uc18zID0gY29udmVyc2lvbnMuaHN2OwogIHZhciBjb252ZXJzaW9uc180ID0gY29udmVyc2lvbnMuaHdiOwogIHZhciBjb252ZXJzaW9uc181ID0gY29udmVyc2lvbnMuY215azsKICB2YXIgY29udmVyc2lvbnNfNiA9IGNvbnZlcnNpb25zLnh5ejsKICB2YXIgY29udmVyc2lvbnNfNyA9IGNvbnZlcnNpb25zLmxhYjsKICB2YXIgY29udmVyc2lvbnNfOCA9IGNvbnZlcnNpb25zLmxjaDsKICB2YXIgY29udmVyc2lvbnNfOSA9IGNvbnZlcnNpb25zLmhleDsKICB2YXIgY29udmVyc2lvbnNfMTAgPSBjb252ZXJzaW9ucy5rZXl3b3JkOwogIHZhciBjb252ZXJzaW9uc18xMSA9IGNvbnZlcnNpb25zLmFuc2kxNjsKICB2YXIgY29udmVyc2lvbnNfMTIgPSBjb252ZXJzaW9ucy5hbnNpMjU2OwogIHZhciBjb252ZXJzaW9uc18xMyA9IGNvbnZlcnNpb25zLmhjZzsKICB2YXIgY29udmVyc2lvbnNfMTQgPSBjb252ZXJzaW9ucy5hcHBsZTsKICB2YXIgY29udmVyc2lvbnNfMTUgPSBjb252ZXJzaW9ucy5ncmF5OwogIC8qCiAgCXRoaXMgZnVuY3Rpb24gcm91dGVzIGEgbW9kZWwgdG8gYWxsIG90aGVyIG1vZGVscy4KICAKICAJYWxsIGZ1bmN0aW9ucyB0aGF0IGFyZSByb3V0ZWQgaGF2ZSBhIHByb3BlcnR5IGAuY29udmVyc2lvbmAgYXR0YWNoZWQKICAJdG8gdGhlIHJldHVybmVkIHN5bnRoZXRpYyBmdW5jdGlvbi4gVGhpcyBwcm9wZXJ0eSBpcyBhbiBhcnJheQogIAlvZiBzdHJpbmdzLCBlYWNoIHdpdGggdGhlIHN0ZXBzIGluIGJldHdlZW4gdGhlICdmcm9tJyBhbmQgJ3RvJwogIAljb2xvciBtb2RlbHMgKGluY2x1c2l2ZSkuCiAgCiAgCWNvbnZlcnNpb25zIHRoYXQgYXJlIG5vdCBwb3NzaWJsZSBzaW1wbHkgYXJlIG5vdCBpbmNsdWRlZC4KICAqLwoKICBmdW5jdGlvbiBidWlsZEdyYXBoKCkgewogICAgdmFyIGdyYXBoID0ge307IC8vIGh0dHBzOi8vanNwZXJmLmNvbS9vYmplY3Qta2V5cy12cy1mb3ItaW4td2l0aC1jbG9zdXJlLzMKCiAgICB2YXIgbW9kZWxzID0gT2JqZWN0LmtleXMoY29udmVyc2lvbnMpOwoKICAgIGZvciAodmFyIGxlbiA9IG1vZGVscy5sZW5ndGgsIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgZ3JhcGhbbW9kZWxzW2ldXSA9IHsKICAgICAgICAvLyBodHRwOi8vanNwZXJmLmNvbS8xLXZzLWluZmluaXR5CiAgICAgICAgLy8gbWljcm8tb3B0LCBidXQgdGhpcyBpcyBzaW1wbGUuCiAgICAgICAgZGlzdGFuY2U6IC0xLAogICAgICAgIHBhcmVudDogbnVsbAogICAgICB9OwogICAgfQoKICAgIHJldHVybiBncmFwaDsKICB9IC8vIGh0dHBzOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL0JyZWFkdGgtZmlyc3Rfc2VhcmNoCgoKICBmdW5jdGlvbiBkZXJpdmVCRlMoZnJvbU1vZGVsKSB7CiAgICB2YXIgZ3JhcGggPSBidWlsZEdyYXBoKCk7CiAgICB2YXIgcXVldWUgPSBbZnJvbU1vZGVsXTsgLy8gdW5zaGlmdCAtPiBxdWV1ZSAtPiBwb3AKCiAgICBncmFwaFtmcm9tTW9kZWxdLmRpc3RhbmNlID0gMDsKCiAgICB3aGlsZSAocXVldWUubGVuZ3RoKSB7CiAgICAgIHZhciBjdXJyZW50ID0gcXVldWUucG9wKCk7CiAgICAgIHZhciBhZGphY2VudHMgPSBPYmplY3Qua2V5cyhjb252ZXJzaW9uc1tjdXJyZW50XSk7CgogICAgICBmb3IgKHZhciBsZW4gPSBhZGphY2VudHMubGVuZ3RoLCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgdmFyIGFkamFjZW50ID0gYWRqYWNlbnRzW2ldOwogICAgICAgIHZhciBub2RlID0gZ3JhcGhbYWRqYWNlbnRdOwoKICAgICAgICBpZiAobm9kZS5kaXN0YW5jZSA9PT0gLTEpIHsKICAgICAgICAgIG5vZGUuZGlzdGFuY2UgPSBncmFwaFtjdXJyZW50XS5kaXN0YW5jZSArIDE7CiAgICAgICAgICBub2RlLnBhcmVudCA9IGN1cnJlbnQ7CiAgICAgICAgICBxdWV1ZS51bnNoaWZ0KGFkamFjZW50KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gZ3JhcGg7CiAgfQoKICBmdW5jdGlvbiBsaW5rKGZyb20sIHRvKSB7CiAgICByZXR1cm4gZnVuY3Rpb24gKGFyZ3MpIHsKICAgICAgcmV0dXJuIHRvKGZyb20oYXJncykpOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIHdyYXBDb252ZXJzaW9uKHRvTW9kZWwsIGdyYXBoKSB7CiAgICB2YXIgcGF0aCA9IFtncmFwaFt0b01vZGVsXS5wYXJlbnQsIHRvTW9kZWxdOwogICAgdmFyIGZuID0gY29udmVyc2lvbnNbZ3JhcGhbdG9Nb2RlbF0ucGFyZW50XVt0b01vZGVsXTsKICAgIHZhciBjdXIgPSBncmFwaFt0b01vZGVsXS5wYXJlbnQ7CgogICAgd2hpbGUgKGdyYXBoW2N1cl0ucGFyZW50KSB7CiAgICAgIHBhdGgudW5zaGlmdChncmFwaFtjdXJdLnBhcmVudCk7CiAgICAgIGZuID0gbGluayhjb252ZXJzaW9uc1tncmFwaFtjdXJdLnBhcmVudF1bY3VyXSwgZm4pOwogICAgICBjdXIgPSBncmFwaFtjdXJdLnBhcmVudDsKICAgIH0KCiAgICBmbi5jb252ZXJzaW9uID0gcGF0aDsKICAgIHJldHVybiBmbjsKICB9CgogIHZhciByb3V0ZSA9IGZ1bmN0aW9uIHJvdXRlKGZyb21Nb2RlbCkgewogICAgdmFyIGdyYXBoID0gZGVyaXZlQkZTKGZyb21Nb2RlbCk7CiAgICB2YXIgY29udmVyc2lvbiA9IHt9OwogICAgdmFyIG1vZGVscyA9IE9iamVjdC5rZXlzKGdyYXBoKTsKCiAgICBmb3IgKHZhciBsZW4gPSBtb2RlbHMubGVuZ3RoLCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgIHZhciB0b01vZGVsID0gbW9kZWxzW2ldOwogICAgICB2YXIgbm9kZSA9IGdyYXBoW3RvTW9kZWxdOwoKICAgICAgaWYgKG5vZGUucGFyZW50ID09PSBudWxsKSB7CiAgICAgICAgLy8gbm8gcG9zc2libGUgY29udmVyc2lvbiwgb3IgdGhpcyBub2RlIGlzIHRoZSBzb3VyY2UgbW9kZWwuCiAgICAgICAgY29udGludWU7CiAgICAgIH0KCiAgICAgIGNvbnZlcnNpb25bdG9Nb2RlbF0gPSB3cmFwQ29udmVyc2lvbih0b01vZGVsLCBncmFwaCk7CiAgICB9CgogICAgcmV0dXJuIGNvbnZlcnNpb247CiAgfTsKCiAgdmFyIGNvbnZlcnQgPSB7fTsKICB2YXIgbW9kZWxzID0gT2JqZWN0LmtleXMoY29udmVyc2lvbnMpOwoKICBmdW5jdGlvbiB3cmFwUmF3KGZuKSB7CiAgICB2YXIgd3JhcHBlZEZuID0gZnVuY3Rpb24gd3JhcHBlZEZuKGFyZ3MpIHsKICAgICAgaWYgKGFyZ3MgPT09IHVuZGVmaW5lZCB8fCBhcmdzID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICAgIH0KCiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICB9CgogICAgICByZXR1cm4gZm4oYXJncyk7CiAgICB9OyAvLyBwcmVzZXJ2ZSAuY29udmVyc2lvbiBwcm9wZXJ0eSBpZiB0aGVyZSBpcyBvbmUKCgogICAgaWYgKCdjb252ZXJzaW9uJyBpbiBmbikgewogICAgICB3cmFwcGVkRm4uY29udmVyc2lvbiA9IGZuLmNvbnZlcnNpb247CiAgICB9CgogICAgcmV0dXJuIHdyYXBwZWRGbjsKICB9CgogIGZ1bmN0aW9uIHdyYXBSb3VuZGVkKGZuKSB7CiAgICB2YXIgd3JhcHBlZEZuID0gZnVuY3Rpb24gd3JhcHBlZEZuKGFyZ3MpIHsKICAgICAgaWYgKGFyZ3MgPT09IHVuZGVmaW5lZCB8fCBhcmdzID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGFyZ3M7CiAgICAgIH0KCiAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgewogICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwogICAgICB9CgogICAgICB2YXIgcmVzdWx0ID0gZm4oYXJncyk7IC8vIHdlJ3JlIGFzc3VtaW5nIHRoZSByZXN1bHQgaXMgYW4gYXJyYXkgaGVyZS4KICAgICAgLy8gc2VlIG5vdGljZSBpbiBjb252ZXJzaW9ucy5qczsgZG9uJ3QgdXNlIGJveCB0eXBlcwogICAgICAvLyBpbiBjb252ZXJzaW9uIGZ1bmN0aW9ucy4KCiAgICAgIGlmIChfdHlwZW9mKHJlc3VsdCkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgZm9yICh2YXIgbGVuID0gcmVzdWx0Lmxlbmd0aCwgaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgcmVzdWx0W2ldID0gTWF0aC5yb3VuZChyZXN1bHRbaV0pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07IC8vIHByZXNlcnZlIC5jb252ZXJzaW9uIHByb3BlcnR5IGlmIHRoZXJlIGlzIG9uZQoKCiAgICBpZiAoJ2NvbnZlcnNpb24nIGluIGZuKSB7CiAgICAgIHdyYXBwZWRGbi5jb252ZXJzaW9uID0gZm4uY29udmVyc2lvbjsKICAgIH0KCiAgICByZXR1cm4gd3JhcHBlZEZuOwogIH0KCiAgbW9kZWxzLmZvckVhY2goZnVuY3Rpb24gKGZyb21Nb2RlbCkgewogICAgY29udmVydFtmcm9tTW9kZWxdID0ge307CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoY29udmVydFtmcm9tTW9kZWxdLCAnY2hhbm5lbHMnLCB7CiAgICAgIHZhbHVlOiBjb252ZXJzaW9uc1tmcm9tTW9kZWxdLmNoYW5uZWxzCiAgICB9KTsKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShjb252ZXJ0W2Zyb21Nb2RlbF0sICdsYWJlbHMnLCB7CiAgICAgIHZhbHVlOiBjb252ZXJzaW9uc1tmcm9tTW9kZWxdLmxhYmVscwogICAgfSk7CiAgICB2YXIgcm91dGVzID0gcm91dGUoZnJvbU1vZGVsKTsKICAgIHZhciByb3V0ZU1vZGVscyA9IE9iamVjdC5rZXlzKHJvdXRlcyk7CiAgICByb3V0ZU1vZGVscy5mb3JFYWNoKGZ1bmN0aW9uICh0b01vZGVsKSB7CiAgICAgIHZhciBmbiA9IHJvdXRlc1t0b01vZGVsXTsKICAgICAgY29udmVydFtmcm9tTW9kZWxdW3RvTW9kZWxdID0gd3JhcFJvdW5kZWQoZm4pOwogICAgICBjb252ZXJ0W2Zyb21Nb2RlbF1bdG9Nb2RlbF0ucmF3ID0gd3JhcFJhdyhmbik7CiAgICB9KTsKICB9KTsKICB2YXIgY29sb3JDb252ZXJ0ID0gY29udmVydDsKICB2YXIgY29sb3JOYW1lJDEgPSB7CiAgICAiYWxpY2VibHVlIjogWzI0MCwgMjQ4LCAyNTVdLAogICAgImFudGlxdWV3aGl0ZSI6IFsyNTAsIDIzNSwgMjE1XSwKICAgICJhcXVhIjogWzAsIDI1NSwgMjU1XSwKICAgICJhcXVhbWFyaW5lIjogWzEyNywgMjU1LCAyMTJdLAogICAgImF6dXJlIjogWzI0MCwgMjU1LCAyNTVdLAogICAgImJlaWdlIjogWzI0NSwgMjQ1LCAyMjBdLAogICAgImJpc3F1ZSI6IFsyNTUsIDIyOCwgMTk2XSwKICAgICJibGFjayI6IFswLCAwLCAwXSwKICAgICJibGFuY2hlZGFsbW9uZCI6IFsyNTUsIDIzNSwgMjA1XSwKICAgICJibHVlIjogWzAsIDAsIDI1NV0sCiAgICAiYmx1ZXZpb2xldCI6IFsxMzgsIDQzLCAyMjZdLAogICAgImJyb3duIjogWzE2NSwgNDIsIDQyXSwKICAgICJidXJseXdvb2QiOiBbMjIyLCAxODQsIDEzNV0sCiAgICAiY2FkZXRibHVlIjogWzk1LCAxNTgsIDE2MF0sCiAgICAiY2hhcnRyZXVzZSI6IFsxMjcsIDI1NSwgMF0sCiAgICAiY2hvY29sYXRlIjogWzIxMCwgMTA1LCAzMF0sCiAgICAiY29yYWwiOiBbMjU1LCAxMjcsIDgwXSwKICAgICJjb3JuZmxvd2VyYmx1ZSI6IFsxMDAsIDE0OSwgMjM3XSwKICAgICJjb3Juc2lsayI6IFsyNTUsIDI0OCwgMjIwXSwKICAgICJjcmltc29uIjogWzIyMCwgMjAsIDYwXSwKICAgICJjeWFuIjogWzAsIDI1NSwgMjU1XSwKICAgICJkYXJrYmx1ZSI6IFswLCAwLCAxMzldLAogICAgImRhcmtjeWFuIjogWzAsIDEzOSwgMTM5XSwKICAgICJkYXJrZ29sZGVucm9kIjogWzE4NCwgMTM0LCAxMV0sCiAgICAiZGFya2dyYXkiOiBbMTY5LCAxNjksIDE2OV0sCiAgICAiZGFya2dyZWVuIjogWzAsIDEwMCwgMF0sCiAgICAiZGFya2dyZXkiOiBbMTY5LCAxNjksIDE2OV0sCiAgICAiZGFya2toYWtpIjogWzE4OSwgMTgzLCAxMDddLAogICAgImRhcmttYWdlbnRhIjogWzEzOSwgMCwgMTM5XSwKICAgICJkYXJrb2xpdmVncmVlbiI6IFs4NSwgMTA3LCA0N10sCiAgICAiZGFya29yYW5nZSI6IFsyNTUsIDE0MCwgMF0sCiAgICAiZGFya29yY2hpZCI6IFsxNTMsIDUwLCAyMDRdLAogICAgImRhcmtyZWQiOiBbMTM5LCAwLCAwXSwKICAgICJkYXJrc2FsbW9uIjogWzIzMywgMTUwLCAxMjJdLAogICAgImRhcmtzZWFncmVlbiI6IFsxNDMsIDE4OCwgMTQzXSwKICAgICJkYXJrc2xhdGVibHVlIjogWzcyLCA2MSwgMTM5XSwKICAgICJkYXJrc2xhdGVncmF5IjogWzQ3LCA3OSwgNzldLAogICAgImRhcmtzbGF0ZWdyZXkiOiBbNDcsIDc5LCA3OV0sCiAgICAiZGFya3R1cnF1b2lzZSI6IFswLCAyMDYsIDIwOV0sCiAgICAiZGFya3Zpb2xldCI6IFsxNDgsIDAsIDIxMV0sCiAgICAiZGVlcHBpbmsiOiBbMjU1LCAyMCwgMTQ3XSwKICAgICJkZWVwc2t5Ymx1ZSI6IFswLCAxOTEsIDI1NV0sCiAgICAiZGltZ3JheSI6IFsxMDUsIDEwNSwgMTA1XSwKICAgICJkaW1ncmV5IjogWzEwNSwgMTA1LCAxMDVdLAogICAgImRvZGdlcmJsdWUiOiBbMzAsIDE0NCwgMjU1XSwKICAgICJmaXJlYnJpY2siOiBbMTc4LCAzNCwgMzRdLAogICAgImZsb3JhbHdoaXRlIjogWzI1NSwgMjUwLCAyNDBdLAogICAgImZvcmVzdGdyZWVuIjogWzM0LCAxMzksIDM0XSwKICAgICJmdWNoc2lhIjogWzI1NSwgMCwgMjU1XSwKICAgICJnYWluc2Jvcm8iOiBbMjIwLCAyMjAsIDIyMF0sCiAgICAiZ2hvc3R3aGl0ZSI6IFsyNDgsIDI0OCwgMjU1XSwKICAgICJnb2xkIjogWzI1NSwgMjE1LCAwXSwKICAgICJnb2xkZW5yb2QiOiBbMjE4LCAxNjUsIDMyXSwKICAgICJncmF5IjogWzEyOCwgMTI4LCAxMjhdLAogICAgImdyZWVuIjogWzAsIDEyOCwgMF0sCiAgICAiZ3JlZW55ZWxsb3ciOiBbMTczLCAyNTUsIDQ3XSwKICAgICJncmV5IjogWzEyOCwgMTI4LCAxMjhdLAogICAgImhvbmV5ZGV3IjogWzI0MCwgMjU1LCAyNDBdLAogICAgImhvdHBpbmsiOiBbMjU1LCAxMDUsIDE4MF0sCiAgICAiaW5kaWFucmVkIjogWzIwNSwgOTIsIDkyXSwKICAgICJpbmRpZ28iOiBbNzUsIDAsIDEzMF0sCiAgICAiaXZvcnkiOiBbMjU1LCAyNTUsIDI0MF0sCiAgICAia2hha2kiOiBbMjQwLCAyMzAsIDE0MF0sCiAgICAibGF2ZW5kZXIiOiBbMjMwLCAyMzAsIDI1MF0sCiAgICAibGF2ZW5kZXJibHVzaCI6IFsyNTUsIDI0MCwgMjQ1XSwKICAgICJsYXduZ3JlZW4iOiBbMTI0LCAyNTIsIDBdLAogICAgImxlbW9uY2hpZmZvbiI6IFsyNTUsIDI1MCwgMjA1XSwKICAgICJsaWdodGJsdWUiOiBbMTczLCAyMTYsIDIzMF0sCiAgICAibGlnaHRjb3JhbCI6IFsyNDAsIDEyOCwgMTI4XSwKICAgICJsaWdodGN5YW4iOiBbMjI0LCAyNTUsIDI1NV0sCiAgICAibGlnaHRnb2xkZW5yb2R5ZWxsb3ciOiBbMjUwLCAyNTAsIDIxMF0sCiAgICAibGlnaHRncmF5IjogWzIxMSwgMjExLCAyMTFdLAogICAgImxpZ2h0Z3JlZW4iOiBbMTQ0LCAyMzgsIDE0NF0sCiAgICAibGlnaHRncmV5IjogWzIxMSwgMjExLCAyMTFdLAogICAgImxpZ2h0cGluayI6IFsyNTUsIDE4MiwgMTkzXSwKICAgICJsaWdodHNhbG1vbiI6IFsyNTUsIDE2MCwgMTIyXSwKICAgICJsaWdodHNlYWdyZWVuIjogWzMyLCAxNzgsIDE3MF0sCiAgICAibGlnaHRza3libHVlIjogWzEzNSwgMjA2LCAyNTBdLAogICAgImxpZ2h0c2xhdGVncmF5IjogWzExOSwgMTM2LCAxNTNdLAogICAgImxpZ2h0c2xhdGVncmV5IjogWzExOSwgMTM2LCAxNTNdLAogICAgImxpZ2h0c3RlZWxibHVlIjogWzE3NiwgMTk2LCAyMjJdLAogICAgImxpZ2h0eWVsbG93IjogWzI1NSwgMjU1LCAyMjRdLAogICAgImxpbWUiOiBbMCwgMjU1LCAwXSwKICAgICJsaW1lZ3JlZW4iOiBbNTAsIDIwNSwgNTBdLAogICAgImxpbmVuIjogWzI1MCwgMjQwLCAyMzBdLAogICAgIm1hZ2VudGEiOiBbMjU1LCAwLCAyNTVdLAogICAgIm1hcm9vbiI6IFsxMjgsIDAsIDBdLAogICAgIm1lZGl1bWFxdWFtYXJpbmUiOiBbMTAyLCAyMDUsIDE3MF0sCiAgICAibWVkaXVtYmx1ZSI6IFswLCAwLCAyMDVdLAogICAgIm1lZGl1bW9yY2hpZCI6IFsxODYsIDg1LCAyMTFdLAogICAgIm1lZGl1bXB1cnBsZSI6IFsxNDcsIDExMiwgMjE5XSwKICAgICJtZWRpdW1zZWFncmVlbiI6IFs2MCwgMTc5LCAxMTNdLAogICAgIm1lZGl1bXNsYXRlYmx1ZSI6IFsxMjMsIDEwNCwgMjM4XSwKICAgICJtZWRpdW1zcHJpbmdncmVlbiI6IFswLCAyNTAsIDE1NF0sCiAgICAibWVkaXVtdHVycXVvaXNlIjogWzcyLCAyMDksIDIwNF0sCiAgICAibWVkaXVtdmlvbGV0cmVkIjogWzE5OSwgMjEsIDEzM10sCiAgICAibWlkbmlnaHRibHVlIjogWzI1LCAyNSwgMTEyXSwKICAgICJtaW50Y3JlYW0iOiBbMjQ1LCAyNTUsIDI1MF0sCiAgICAibWlzdHlyb3NlIjogWzI1NSwgMjI4LCAyMjVdLAogICAgIm1vY2Nhc2luIjogWzI1NSwgMjI4LCAxODFdLAogICAgIm5hdmFqb3doaXRlIjogWzI1NSwgMjIyLCAxNzNdLAogICAgIm5hdnkiOiBbMCwgMCwgMTI4XSwKICAgICJvbGRsYWNlIjogWzI1MywgMjQ1LCAyMzBdLAogICAgIm9saXZlIjogWzEyOCwgMTI4LCAwXSwKICAgICJvbGl2ZWRyYWIiOiBbMTA3LCAxNDIsIDM1XSwKICAgICJvcmFuZ2UiOiBbMjU1LCAxNjUsIDBdLAogICAgIm9yYW5nZXJlZCI6IFsyNTUsIDY5LCAwXSwKICAgICJvcmNoaWQiOiBbMjE4LCAxMTIsIDIxNF0sCiAgICAicGFsZWdvbGRlbnJvZCI6IFsyMzgsIDIzMiwgMTcwXSwKICAgICJwYWxlZ3JlZW4iOiBbMTUyLCAyNTEsIDE1Ml0sCiAgICAicGFsZXR1cnF1b2lzZSI6IFsxNzUsIDIzOCwgMjM4XSwKICAgICJwYWxldmlvbGV0cmVkIjogWzIxOSwgMTEyLCAxNDddLAogICAgInBhcGF5YXdoaXAiOiBbMjU1LCAyMzksIDIxM10sCiAgICAicGVhY2hwdWZmIjogWzI1NSwgMjE4LCAxODVdLAogICAgInBlcnUiOiBbMjA1LCAxMzMsIDYzXSwKICAgICJwaW5rIjogWzI1NSwgMTkyLCAyMDNdLAogICAgInBsdW0iOiBbMjIxLCAxNjAsIDIyMV0sCiAgICAicG93ZGVyYmx1ZSI6IFsxNzYsIDIyNCwgMjMwXSwKICAgICJwdXJwbGUiOiBbMTI4LCAwLCAxMjhdLAogICAgInJlYmVjY2FwdXJwbGUiOiBbMTAyLCA1MSwgMTUzXSwKICAgICJyZWQiOiBbMjU1LCAwLCAwXSwKICAgICJyb3N5YnJvd24iOiBbMTg4LCAxNDMsIDE0M10sCiAgICAicm95YWxibHVlIjogWzY1LCAxMDUsIDIyNV0sCiAgICAic2FkZGxlYnJvd24iOiBbMTM5LCA2OSwgMTldLAogICAgInNhbG1vbiI6IFsyNTAsIDEyOCwgMTE0XSwKICAgICJzYW5keWJyb3duIjogWzI0NCwgMTY0LCA5Nl0sCiAgICAic2VhZ3JlZW4iOiBbNDYsIDEzOSwgODddLAogICAgInNlYXNoZWxsIjogWzI1NSwgMjQ1LCAyMzhdLAogICAgInNpZW5uYSI6IFsxNjAsIDgyLCA0NV0sCiAgICAic2lsdmVyIjogWzE5MiwgMTkyLCAxOTJdLAogICAgInNreWJsdWUiOiBbMTM1LCAyMDYsIDIzNV0sCiAgICAic2xhdGVibHVlIjogWzEwNiwgOTAsIDIwNV0sCiAgICAic2xhdGVncmF5IjogWzExMiwgMTI4LCAxNDRdLAogICAgInNsYXRlZ3JleSI6IFsxMTIsIDEyOCwgMTQ0XSwKICAgICJzbm93IjogWzI1NSwgMjUwLCAyNTBdLAogICAgInNwcmluZ2dyZWVuIjogWzAsIDI1NSwgMTI3XSwKICAgICJzdGVlbGJsdWUiOiBbNzAsIDEzMCwgMTgwXSwKICAgICJ0YW4iOiBbMjEwLCAxODAsIDE0MF0sCiAgICAidGVhbCI6IFswLCAxMjgsIDEyOF0sCiAgICAidGhpc3RsZSI6IFsyMTYsIDE5MSwgMjE2XSwKICAgICJ0b21hdG8iOiBbMjU1LCA5OSwgNzFdLAogICAgInR1cnF1b2lzZSI6IFs2NCwgMjI0LCAyMDhdLAogICAgInZpb2xldCI6IFsyMzgsIDEzMCwgMjM4XSwKICAgICJ3aGVhdCI6IFsyNDUsIDIyMiwgMTc5XSwKICAgICJ3aGl0ZSI6IFsyNTUsIDI1NSwgMjU1XSwKICAgICJ3aGl0ZXNtb2tlIjogWzI0NSwgMjQ1LCAyNDVdLAogICAgInllbGxvdyI6IFsyNTUsIDI1NSwgMF0sCiAgICAieWVsbG93Z3JlZW4iOiBbMTU0LCAyMDUsIDUwXQogIH07CiAgLyogTUlUIGxpY2Vuc2UgKi8KCiAgdmFyIGNvbG9yU3RyaW5nID0gewogICAgZ2V0UmdiYTogZ2V0UmdiYSwKICAgIGdldEhzbGE6IGdldEhzbGEsCiAgICBnZXRSZ2I6IGdldFJnYiwKICAgIGdldEhzbDogZ2V0SHNsLAogICAgZ2V0SHdiOiBnZXRId2IsCiAgICBnZXRBbHBoYTogZ2V0QWxwaGEsCiAgICBoZXhTdHJpbmc6IGhleFN0cmluZywKICAgIHJnYlN0cmluZzogcmdiU3RyaW5nLAogICAgcmdiYVN0cmluZzogcmdiYVN0cmluZywKICAgIHBlcmNlbnRTdHJpbmc6IHBlcmNlbnRTdHJpbmcsCiAgICBwZXJjZW50YVN0cmluZzogcGVyY2VudGFTdHJpbmcsCiAgICBoc2xTdHJpbmc6IGhzbFN0cmluZywKICAgIGhzbGFTdHJpbmc6IGhzbGFTdHJpbmcsCiAgICBod2JTdHJpbmc6IGh3YlN0cmluZywKICAgIGtleXdvcmQ6IGtleXdvcmQKICB9OwoKICBmdW5jdGlvbiBnZXRSZ2JhKHN0cmluZykgewogICAgaWYgKCFzdHJpbmcpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBhYmJyID0gL14jKFthLWZBLUYwLTldezMsNH0pJC9pLAogICAgICAgIGhleCA9IC9eIyhbYS1mQS1GMC05XXs2fShbYS1mQS1GMC05XXsyfSk/KSQvaSwKICAgICAgICByZ2JhID0gL15yZ2JhP1woXHMqKFsrLV0/XGQrKVxzKixccyooWystXT9cZCspXHMqLFxzKihbKy1dP1xkKylccyooPzosXHMqKFsrLV0/W1xkXC5dKylccyopP1wpJC9pLAogICAgICAgIHBlciA9IC9ecmdiYT9cKFxzKihbKy1dP1tcZFwuXSspXCVccyosXHMqKFsrLV0/W1xkXC5dKylcJVxzKixccyooWystXT9bXGRcLl0rKVwlXHMqKD86LFxzKihbKy1dP1tcZFwuXSspXHMqKT9cKSQvaSwKICAgICAgICBrZXl3b3JkID0gLyhcdyspLzsKICAgIHZhciByZ2IgPSBbMCwgMCwgMF0sCiAgICAgICAgYSA9IDEsCiAgICAgICAgbWF0Y2ggPSBzdHJpbmcubWF0Y2goYWJiciksCiAgICAgICAgaGV4QWxwaGEgPSAiIjsKCiAgICBpZiAobWF0Y2gpIHsKICAgICAgbWF0Y2ggPSBtYXRjaFsxXTsKICAgICAgaGV4QWxwaGEgPSBtYXRjaFszXTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmdiLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmdiW2ldID0gcGFyc2VJbnQobWF0Y2hbaV0gKyBtYXRjaFtpXSwgMTYpOwogICAgICB9CgogICAgICBpZiAoaGV4QWxwaGEpIHsKICAgICAgICBhID0gTWF0aC5yb3VuZChwYXJzZUludChoZXhBbHBoYSArIGhleEFscGhhLCAxNikgLyAyNTUgKiAxMDApIC8gMTAwOwogICAgICB9CiAgICB9IGVsc2UgaWYgKG1hdGNoID0gc3RyaW5nLm1hdGNoKGhleCkpIHsKICAgICAgaGV4QWxwaGEgPSBtYXRjaFsyXTsKICAgICAgbWF0Y2ggPSBtYXRjaFsxXTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmdiLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgcmdiW2ldID0gcGFyc2VJbnQobWF0Y2guc2xpY2UoaSAqIDIsIGkgKiAyICsgMiksIDE2KTsKICAgICAgfQoKICAgICAgaWYgKGhleEFscGhhKSB7CiAgICAgICAgYSA9IE1hdGgucm91bmQocGFyc2VJbnQoaGV4QWxwaGEsIDE2KSAvIDI1NSAqIDEwMCkgLyAxMDA7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobWF0Y2ggPSBzdHJpbmcubWF0Y2gocmdiYSkpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZ2IubGVuZ3RoOyBpKyspIHsKICAgICAgICByZ2JbaV0gPSBwYXJzZUludChtYXRjaFtpICsgMV0pOwogICAgICB9CgogICAgICBhID0gcGFyc2VGbG9hdChtYXRjaFs0XSk7CiAgICB9IGVsc2UgaWYgKG1hdGNoID0gc3RyaW5nLm1hdGNoKHBlcikpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZ2IubGVuZ3RoOyBpKyspIHsKICAgICAgICByZ2JbaV0gPSBNYXRoLnJvdW5kKHBhcnNlRmxvYXQobWF0Y2hbaSArIDFdKSAqIDIuNTUpOwogICAgICB9CgogICAgICBhID0gcGFyc2VGbG9hdChtYXRjaFs0XSk7CiAgICB9IGVsc2UgaWYgKG1hdGNoID0gc3RyaW5nLm1hdGNoKGtleXdvcmQpKSB7CiAgICAgIGlmIChtYXRjaFsxXSA9PSAidHJhbnNwYXJlbnQiKSB7CiAgICAgICAgcmV0dXJuIFswLCAwLCAwLCAwXTsKICAgICAgfQoKICAgICAgcmdiID0gY29sb3JOYW1lJDFbbWF0Y2hbMV1dOwoKICAgICAgaWYgKCFyZ2IpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJnYi5sZW5ndGg7IGkrKykgewogICAgICByZ2JbaV0gPSBzY2FsZShyZ2JbaV0sIDAsIDI1NSk7CiAgICB9CgogICAgaWYgKCFhICYmIGEgIT0gMCkgewogICAgICBhID0gMTsKICAgIH0gZWxzZSB7CiAgICAgIGEgPSBzY2FsZShhLCAwLCAxKTsKICAgIH0KCiAgICByZ2JbM10gPSBhOwogICAgcmV0dXJuIHJnYjsKICB9CgogIGZ1bmN0aW9uIGdldEhzbGEoc3RyaW5nKSB7CiAgICBpZiAoIXN0cmluZykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGhzbCA9IC9eaHNsYT9cKFxzKihbKy1dP1xkKykoPzpkZWcpP1xzKixccyooWystXT9bXGRcLl0rKSVccyosXHMqKFsrLV0/W1xkXC5dKyklXHMqKD86LFxzKihbKy1dP1tcZFwuXSspXHMqKT9cKS87CiAgICB2YXIgbWF0Y2ggPSBzdHJpbmcubWF0Y2goaHNsKTsKCiAgICBpZiAobWF0Y2gpIHsKICAgICAgdmFyIGFscGhhID0gcGFyc2VGbG9hdChtYXRjaFs0XSk7CiAgICAgIHZhciBoID0gc2NhbGUocGFyc2VJbnQobWF0Y2hbMV0pLCAwLCAzNjApLAogICAgICAgICAgcyA9IHNjYWxlKHBhcnNlRmxvYXQobWF0Y2hbMl0pLCAwLCAxMDApLAogICAgICAgICAgbCA9IHNjYWxlKHBhcnNlRmxvYXQobWF0Y2hbM10pLCAwLCAxMDApLAogICAgICAgICAgYSA9IHNjYWxlKGlzTmFOKGFscGhhKSA/IDEgOiBhbHBoYSwgMCwgMSk7CiAgICAgIHJldHVybiBbaCwgcywgbCwgYV07CiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZXRId2Ioc3RyaW5nKSB7CiAgICBpZiAoIXN0cmluZykgewogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIGh3YiA9IC9eaHdiXChccyooWystXT9cZCspKD86ZGVnKT9ccyosXHMqKFsrLV0/W1xkXC5dKyklXHMqLFxzKihbKy1dP1tcZFwuXSspJVxzKig/OixccyooWystXT9bXGRcLl0rKVxzKik/XCkvOwogICAgdmFyIG1hdGNoID0gc3RyaW5nLm1hdGNoKGh3Yik7CgogICAgaWYgKG1hdGNoKSB7CiAgICAgIHZhciBhbHBoYSA9IHBhcnNlRmxvYXQobWF0Y2hbNF0pOwogICAgICB2YXIgaCA9IHNjYWxlKHBhcnNlSW50KG1hdGNoWzFdKSwgMCwgMzYwKSwKICAgICAgICAgIHcgPSBzY2FsZShwYXJzZUZsb2F0KG1hdGNoWzJdKSwgMCwgMTAwKSwKICAgICAgICAgIGIgPSBzY2FsZShwYXJzZUZsb2F0KG1hdGNoWzNdKSwgMCwgMTAwKSwKICAgICAgICAgIGEgPSBzY2FsZShpc05hTihhbHBoYSkgPyAxIDogYWxwaGEsIDAsIDEpOwogICAgICByZXR1cm4gW2gsIHcsIGIsIGFdOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZ2V0UmdiKHN0cmluZykgewogICAgdmFyIHJnYmEgPSBnZXRSZ2JhKHN0cmluZyk7CiAgICByZXR1cm4gcmdiYSAmJiByZ2JhLnNsaWNlKDAsIDMpOwogIH0KCiAgZnVuY3Rpb24gZ2V0SHNsKHN0cmluZykgewogICAgdmFyIGhzbGEgPSBnZXRIc2xhKHN0cmluZyk7CiAgICByZXR1cm4gaHNsYSAmJiBoc2xhLnNsaWNlKDAsIDMpOwogIH0KCiAgZnVuY3Rpb24gZ2V0QWxwaGEoc3RyaW5nKSB7CiAgICB2YXIgdmFscyA9IGdldFJnYmEoc3RyaW5nKTsKCiAgICBpZiAodmFscykgewogICAgICByZXR1cm4gdmFsc1szXTsKICAgIH0gZWxzZSBpZiAodmFscyA9IGdldEhzbGEoc3RyaW5nKSkgewogICAgICByZXR1cm4gdmFsc1szXTsKICAgIH0gZWxzZSBpZiAodmFscyA9IGdldEh3YihzdHJpbmcpKSB7CiAgICAgIHJldHVybiB2YWxzWzNdOwogICAgfQogIH0gLy8gZ2VuZXJhdG9ycwoKCiAgZnVuY3Rpb24gaGV4U3RyaW5nKHJnYmEsIGEpIHsKICAgIHZhciBhID0gYSAhPT0gdW5kZWZpbmVkICYmIHJnYmEubGVuZ3RoID09PSAzID8gYSA6IHJnYmFbM107CiAgICByZXR1cm4gIiMiICsgaGV4RG91YmxlKHJnYmFbMF0pICsgaGV4RG91YmxlKHJnYmFbMV0pICsgaGV4RG91YmxlKHJnYmFbMl0pICsgKGEgPj0gMCAmJiBhIDwgMSA/IGhleERvdWJsZShNYXRoLnJvdW5kKGEgKiAyNTUpKSA6ICIiKTsKICB9CgogIGZ1bmN0aW9uIHJnYlN0cmluZyhyZ2JhLCBhbHBoYSkgewogICAgaWYgKGFscGhhIDwgMSB8fCByZ2JhWzNdICYmIHJnYmFbM10gPCAxKSB7CiAgICAgIHJldHVybiByZ2JhU3RyaW5nKHJnYmEsIGFscGhhKTsKICAgIH0KCiAgICByZXR1cm4gInJnYigiICsgcmdiYVswXSArICIsICIgKyByZ2JhWzFdICsgIiwgIiArIHJnYmFbMl0gKyAiKSI7CiAgfQoKICBmdW5jdGlvbiByZ2JhU3RyaW5nKHJnYmEsIGFscGhhKSB7CiAgICBpZiAoYWxwaGEgPT09IHVuZGVmaW5lZCkgewogICAgICBhbHBoYSA9IHJnYmFbM10gIT09IHVuZGVmaW5lZCA/IHJnYmFbM10gOiAxOwogICAgfQoKICAgIHJldHVybiAicmdiYSgiICsgcmdiYVswXSArICIsICIgKyByZ2JhWzFdICsgIiwgIiArIHJnYmFbMl0gKyAiLCAiICsgYWxwaGEgKyAiKSI7CiAgfQoKICBmdW5jdGlvbiBwZXJjZW50U3RyaW5nKHJnYmEsIGFscGhhKSB7CiAgICBpZiAoYWxwaGEgPCAxIHx8IHJnYmFbM10gJiYgcmdiYVszXSA8IDEpIHsKICAgICAgcmV0dXJuIHBlcmNlbnRhU3RyaW5nKHJnYmEsIGFscGhhKTsKICAgIH0KCiAgICB2YXIgciA9IE1hdGgucm91bmQocmdiYVswXSAvIDI1NSAqIDEwMCksCiAgICAgICAgZyA9IE1hdGgucm91bmQocmdiYVsxXSAvIDI1NSAqIDEwMCksCiAgICAgICAgYiA9IE1hdGgucm91bmQocmdiYVsyXSAvIDI1NSAqIDEwMCk7CiAgICByZXR1cm4gInJnYigiICsgciArICIlLCAiICsgZyArICIlLCAiICsgYiArICIlKSI7CiAgfQoKICBmdW5jdGlvbiBwZXJjZW50YVN0cmluZyhyZ2JhLCBhbHBoYSkgewogICAgdmFyIHIgPSBNYXRoLnJvdW5kKHJnYmFbMF0gLyAyNTUgKiAxMDApLAogICAgICAgIGcgPSBNYXRoLnJvdW5kKHJnYmFbMV0gLyAyNTUgKiAxMDApLAogICAgICAgIGIgPSBNYXRoLnJvdW5kKHJnYmFbMl0gLyAyNTUgKiAxMDApOwogICAgcmV0dXJuICJyZ2JhKCIgKyByICsgIiUsICIgKyBnICsgIiUsICIgKyBiICsgIiUsICIgKyAoYWxwaGEgfHwgcmdiYVszXSB8fCAxKSArICIpIjsKICB9CgogIGZ1bmN0aW9uIGhzbFN0cmluZyhoc2xhLCBhbHBoYSkgewogICAgaWYgKGFscGhhIDwgMSB8fCBoc2xhWzNdICYmIGhzbGFbM10gPCAxKSB7CiAgICAgIHJldHVybiBoc2xhU3RyaW5nKGhzbGEsIGFscGhhKTsKICAgIH0KCiAgICByZXR1cm4gImhzbCgiICsgaHNsYVswXSArICIsICIgKyBoc2xhWzFdICsgIiUsICIgKyBoc2xhWzJdICsgIiUpIjsKICB9CgogIGZ1bmN0aW9uIGhzbGFTdHJpbmcoaHNsYSwgYWxwaGEpIHsKICAgIGlmIChhbHBoYSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgIGFscGhhID0gaHNsYVszXSAhPT0gdW5kZWZpbmVkID8gaHNsYVszXSA6IDE7CiAgICB9CgogICAgcmV0dXJuICJoc2xhKCIgKyBoc2xhWzBdICsgIiwgIiArIGhzbGFbMV0gKyAiJSwgIiArIGhzbGFbMl0gKyAiJSwgIiArIGFscGhhICsgIikiOwogIH0gLy8gaHdiIGlzIGEgYml0IGRpZmZlcmVudCB0aGFuIHJnYihhKSAmIGhzbChhKSBzaW5jZSB0aGVyZSBpcyBubyBhbHBoYSBzcGVjaWZpYyBzeW50YXgKICAvLyAoaHdiIGhhdmUgYWxwaGEgb3B0aW9uYWwgJiAxIGlzIGRlZmF1bHQgdmFsdWUpCgoKICBmdW5jdGlvbiBod2JTdHJpbmcoaHdiLCBhbHBoYSkgewogICAgaWYgKGFscGhhID09PSB1bmRlZmluZWQpIHsKICAgICAgYWxwaGEgPSBod2JbM10gIT09IHVuZGVmaW5lZCA/IGh3YlszXSA6IDE7CiAgICB9CgogICAgcmV0dXJuICJod2IoIiArIGh3YlswXSArICIsICIgKyBod2JbMV0gKyAiJSwgIiArIGh3YlsyXSArICIlIiArIChhbHBoYSAhPT0gdW5kZWZpbmVkICYmIGFscGhhICE9PSAxID8gIiwgIiArIGFscGhhIDogIiIpICsgIikiOwogIH0KCiAgZnVuY3Rpb24ga2V5d29yZChyZ2IpIHsKICAgIHJldHVybiByZXZlcnNlTmFtZXNbcmdiLnNsaWNlKDAsIDMpXTsKICB9IC8vIGhlbHBlcnMKCgogIGZ1bmN0aW9uIHNjYWxlKG51bSwgbWluLCBtYXgpIHsKICAgIHJldHVybiBNYXRoLm1pbihNYXRoLm1heChtaW4sIG51bSksIG1heCk7CiAgfQoKICBmdW5jdGlvbiBoZXhEb3VibGUobnVtKSB7CiAgICB2YXIgc3RyID0gbnVtLnRvU3RyaW5nKDE2KS50b1VwcGVyQ2FzZSgpOwogICAgcmV0dXJuIHN0ci5sZW5ndGggPCAyID8gIjAiICsgc3RyIDogc3RyOwogIH0gLy9jcmVhdGUgYSBsaXN0IG9mIHJldmVyc2UgY29sb3IgbmFtZXMKCgogIHZhciByZXZlcnNlTmFtZXMgPSB7fTsKCiAgZm9yICh2YXIgbmFtZSBpbiBjb2xvck5hbWUkMSkgewogICAgcmV2ZXJzZU5hbWVzW2NvbG9yTmFtZSQxW25hbWVdXSA9IG5hbWU7CiAgfQogIC8qIE1JVCBsaWNlbnNlICovCgoKICB2YXIgQ29sb3IgPSBmdW5jdGlvbiBDb2xvcihvYmopIHsKICAgIGlmIChvYmogaW5zdGFuY2VvZiBDb2xvcikgewogICAgICByZXR1cm4gb2JqOwogICAgfQoKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBDb2xvcikpIHsKICAgICAgcmV0dXJuIG5ldyBDb2xvcihvYmopOwogICAgfQoKICAgIHRoaXMudmFsaWQgPSBmYWxzZTsKICAgIHRoaXMudmFsdWVzID0gewogICAgICByZ2I6IFswLCAwLCAwXSwKICAgICAgaHNsOiBbMCwgMCwgMF0sCiAgICAgIGhzdjogWzAsIDAsIDBdLAogICAgICBod2I6IFswLCAwLCAwXSwKICAgICAgY215azogWzAsIDAsIDAsIDBdLAogICAgICBhbHBoYTogMQogICAgfTsgLy8gcGFyc2UgQ29sb3IoKSBhcmd1bWVudAoKICAgIHZhciB2YWxzOwoKICAgIGlmICh0eXBlb2Ygb2JqID09PSAnc3RyaW5nJykgewogICAgICB2YWxzID0gY29sb3JTdHJpbmcuZ2V0UmdiYShvYmopOwoKICAgICAgaWYgKHZhbHMpIHsKICAgICAgICB0aGlzLnNldFZhbHVlcygncmdiJywgdmFscyk7CiAgICAgIH0gZWxzZSBpZiAodmFscyA9IGNvbG9yU3RyaW5nLmdldEhzbGEob2JqKSkgewogICAgICAgIHRoaXMuc2V0VmFsdWVzKCdoc2wnLCB2YWxzKTsKICAgICAgfSBlbHNlIGlmICh2YWxzID0gY29sb3JTdHJpbmcuZ2V0SHdiKG9iaikpIHsKICAgICAgICB0aGlzLnNldFZhbHVlcygnaHdiJywgdmFscyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoX3R5cGVvZihvYmopID09PSAnb2JqZWN0JykgewogICAgICB2YWxzID0gb2JqOwoKICAgICAgaWYgKHZhbHMuciAhPT0gdW5kZWZpbmVkIHx8IHZhbHMucmVkICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLnNldFZhbHVlcygncmdiJywgdmFscyk7CiAgICAgIH0gZWxzZSBpZiAodmFscy5sICE9PSB1bmRlZmluZWQgfHwgdmFscy5saWdodG5lc3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuc2V0VmFsdWVzKCdoc2wnLCB2YWxzKTsKICAgICAgfSBlbHNlIGlmICh2YWxzLnYgIT09IHVuZGVmaW5lZCB8fCB2YWxzLnZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aGlzLnNldFZhbHVlcygnaHN2JywgdmFscyk7CiAgICAgIH0gZWxzZSBpZiAodmFscy53ICE9PSB1bmRlZmluZWQgfHwgdmFscy53aGl0ZW5lc3MgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuc2V0VmFsdWVzKCdod2InLCB2YWxzKTsKICAgICAgfSBlbHNlIGlmICh2YWxzLmMgIT09IHVuZGVmaW5lZCB8fCB2YWxzLmN5YW4gIT09IHVuZGVmaW5lZCkgewogICAgICAgIHRoaXMuc2V0VmFsdWVzKCdjbXlrJywgdmFscyk7CiAgICAgIH0KICAgIH0KICB9OwoKICBDb2xvci5wcm90b3R5cGUgPSB7CiAgICBpc1ZhbGlkOiBmdW5jdGlvbiBpc1ZhbGlkKCkgewogICAgICByZXR1cm4gdGhpcy52YWxpZDsKICAgIH0sCiAgICByZ2I6IGZ1bmN0aW9uIHJnYigpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0U3BhY2UoJ3JnYicsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgaHNsOiBmdW5jdGlvbiBoc2woKSB7CiAgICAgIHJldHVybiB0aGlzLnNldFNwYWNlKCdoc2wnLCBhcmd1bWVudHMpOwogICAgfSwKICAgIGhzdjogZnVuY3Rpb24gaHN2KCkgewogICAgICByZXR1cm4gdGhpcy5zZXRTcGFjZSgnaHN2JywgYXJndW1lbnRzKTsKICAgIH0sCiAgICBod2I6IGZ1bmN0aW9uIGh3YigpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0U3BhY2UoJ2h3YicsIGFyZ3VtZW50cyk7CiAgICB9LAogICAgY215azogZnVuY3Rpb24gY215aygpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0U3BhY2UoJ2NteWsnLCBhcmd1bWVudHMpOwogICAgfSwKICAgIHJnYkFycmF5OiBmdW5jdGlvbiByZ2JBcnJheSgpIHsKICAgICAgcmV0dXJuIHRoaXMudmFsdWVzLnJnYjsKICAgIH0sCiAgICBoc2xBcnJheTogZnVuY3Rpb24gaHNsQXJyYXkoKSB7CiAgICAgIHJldHVybiB0aGlzLnZhbHVlcy5oc2w7CiAgICB9LAogICAgaHN2QXJyYXk6IGZ1bmN0aW9uIGhzdkFycmF5KCkgewogICAgICByZXR1cm4gdGhpcy52YWx1ZXMuaHN2OwogICAgfSwKICAgIGh3YkFycmF5OiBmdW5jdGlvbiBod2JBcnJheSgpIHsKICAgICAgdmFyIHZhbHVlcyA9IHRoaXMudmFsdWVzOwoKICAgICAgaWYgKHZhbHVlcy5hbHBoYSAhPT0gMSkgewogICAgICAgIHJldHVybiB2YWx1ZXMuaHdiLmNvbmNhdChbdmFsdWVzLmFscGhhXSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB2YWx1ZXMuaHdiOwogICAgfSwKICAgIGNteWtBcnJheTogZnVuY3Rpb24gY215a0FycmF5KCkgewogICAgICByZXR1cm4gdGhpcy52YWx1ZXMuY215azsKICAgIH0sCiAgICByZ2JhQXJyYXk6IGZ1bmN0aW9uIHJnYmFBcnJheSgpIHsKICAgICAgdmFyIHZhbHVlcyA9IHRoaXMudmFsdWVzOwogICAgICByZXR1cm4gdmFsdWVzLnJnYi5jb25jYXQoW3ZhbHVlcy5hbHBoYV0pOwogICAgfSwKICAgIGhzbGFBcnJheTogZnVuY3Rpb24gaHNsYUFycmF5KCkgewogICAgICB2YXIgdmFsdWVzID0gdGhpcy52YWx1ZXM7CiAgICAgIHJldHVybiB2YWx1ZXMuaHNsLmNvbmNhdChbdmFsdWVzLmFscGhhXSk7CiAgICB9LAogICAgYWxwaGE6IGZ1bmN0aW9uIGFscGhhKHZhbCkgewogICAgICBpZiAodmFsID09PSB1bmRlZmluZWQpIHsKICAgICAgICByZXR1cm4gdGhpcy52YWx1ZXMuYWxwaGE7CiAgICAgIH0KCiAgICAgIHRoaXMuc2V0VmFsdWVzKCdhbHBoYScsIHZhbCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHJlZDogZnVuY3Rpb24gcmVkKHZhbCkgewogICAgICByZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdyZ2InLCAwLCB2YWwpOwogICAgfSwKICAgIGdyZWVuOiBmdW5jdGlvbiBncmVlbih2YWwpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0Q2hhbm5lbCgncmdiJywgMSwgdmFsKTsKICAgIH0sCiAgICBibHVlOiBmdW5jdGlvbiBibHVlKHZhbCkgewogICAgICByZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdyZ2InLCAyLCB2YWwpOwogICAgfSwKICAgIGh1ZTogZnVuY3Rpb24gaHVlKHZhbCkgewogICAgICBpZiAodmFsKSB7CiAgICAgICAgdmFsICU9IDM2MDsKICAgICAgICB2YWwgPSB2YWwgPCAwID8gMzYwICsgdmFsIDogdmFsOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdoc2wnLCAwLCB2YWwpOwogICAgfSwKICAgIHNhdHVyYXRpb246IGZ1bmN0aW9uIHNhdHVyYXRpb24odmFsKSB7CiAgICAgIHJldHVybiB0aGlzLnNldENoYW5uZWwoJ2hzbCcsIDEsIHZhbCk7CiAgICB9LAogICAgbGlnaHRuZXNzOiBmdW5jdGlvbiBsaWdodG5lc3ModmFsKSB7CiAgICAgIHJldHVybiB0aGlzLnNldENoYW5uZWwoJ2hzbCcsIDIsIHZhbCk7CiAgICB9LAogICAgc2F0dXJhdGlvbnY6IGZ1bmN0aW9uIHNhdHVyYXRpb252KHZhbCkgewogICAgICByZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdoc3YnLCAxLCB2YWwpOwogICAgfSwKICAgIHdoaXRlbmVzczogZnVuY3Rpb24gd2hpdGVuZXNzKHZhbCkgewogICAgICByZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdod2InLCAxLCB2YWwpOwogICAgfSwKICAgIGJsYWNrbmVzczogZnVuY3Rpb24gYmxhY2tuZXNzKHZhbCkgewogICAgICByZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdod2InLCAyLCB2YWwpOwogICAgfSwKICAgIHZhbHVlOiBmdW5jdGlvbiB2YWx1ZSh2YWwpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0Q2hhbm5lbCgnaHN2JywgMiwgdmFsKTsKICAgIH0sCiAgICBjeWFuOiBmdW5jdGlvbiBjeWFuKHZhbCkgewogICAgICByZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdjbXlrJywgMCwgdmFsKTsKICAgIH0sCiAgICBtYWdlbnRhOiBmdW5jdGlvbiBtYWdlbnRhKHZhbCkgewogICAgICByZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdjbXlrJywgMSwgdmFsKTsKICAgIH0sCiAgICB5ZWxsb3c6IGZ1bmN0aW9uIHllbGxvdyh2YWwpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0Q2hhbm5lbCgnY215aycsIDIsIHZhbCk7CiAgICB9LAogICAgYmxhY2s6IGZ1bmN0aW9uIGJsYWNrKHZhbCkgewogICAgICByZXR1cm4gdGhpcy5zZXRDaGFubmVsKCdjbXlrJywgMywgdmFsKTsKICAgIH0sCiAgICBoZXhTdHJpbmc6IGZ1bmN0aW9uIGhleFN0cmluZygpIHsKICAgICAgcmV0dXJuIGNvbG9yU3RyaW5nLmhleFN0cmluZyh0aGlzLnZhbHVlcy5yZ2IpOwogICAgfSwKICAgIHJnYlN0cmluZzogZnVuY3Rpb24gcmdiU3RyaW5nKCkgewogICAgICByZXR1cm4gY29sb3JTdHJpbmcucmdiU3RyaW5nKHRoaXMudmFsdWVzLnJnYiwgdGhpcy52YWx1ZXMuYWxwaGEpOwogICAgfSwKICAgIHJnYmFTdHJpbmc6IGZ1bmN0aW9uIHJnYmFTdHJpbmcoKSB7CiAgICAgIHJldHVybiBjb2xvclN0cmluZy5yZ2JhU3RyaW5nKHRoaXMudmFsdWVzLnJnYiwgdGhpcy52YWx1ZXMuYWxwaGEpOwogICAgfSwKICAgIHBlcmNlbnRTdHJpbmc6IGZ1bmN0aW9uIHBlcmNlbnRTdHJpbmcoKSB7CiAgICAgIHJldHVybiBjb2xvclN0cmluZy5wZXJjZW50U3RyaW5nKHRoaXMudmFsdWVzLnJnYiwgdGhpcy52YWx1ZXMuYWxwaGEpOwogICAgfSwKICAgIGhzbFN0cmluZzogZnVuY3Rpb24gaHNsU3RyaW5nKCkgewogICAgICByZXR1cm4gY29sb3JTdHJpbmcuaHNsU3RyaW5nKHRoaXMudmFsdWVzLmhzbCwgdGhpcy52YWx1ZXMuYWxwaGEpOwogICAgfSwKICAgIGhzbGFTdHJpbmc6IGZ1bmN0aW9uIGhzbGFTdHJpbmcoKSB7CiAgICAgIHJldHVybiBjb2xvclN0cmluZy5oc2xhU3RyaW5nKHRoaXMudmFsdWVzLmhzbCwgdGhpcy52YWx1ZXMuYWxwaGEpOwogICAgfSwKICAgIGh3YlN0cmluZzogZnVuY3Rpb24gaHdiU3RyaW5nKCkgewogICAgICByZXR1cm4gY29sb3JTdHJpbmcuaHdiU3RyaW5nKHRoaXMudmFsdWVzLmh3YiwgdGhpcy52YWx1ZXMuYWxwaGEpOwogICAgfSwKICAgIGtleXdvcmQ6IGZ1bmN0aW9uIGtleXdvcmQoKSB7CiAgICAgIHJldHVybiBjb2xvclN0cmluZy5rZXl3b3JkKHRoaXMudmFsdWVzLnJnYiwgdGhpcy52YWx1ZXMuYWxwaGEpOwogICAgfSwKICAgIHJnYk51bWJlcjogZnVuY3Rpb24gcmdiTnVtYmVyKCkgewogICAgICB2YXIgcmdiID0gdGhpcy52YWx1ZXMucmdiOwogICAgICByZXR1cm4gcmdiWzBdIDw8IDE2IHwgcmdiWzFdIDw8IDggfCByZ2JbMl07CiAgICB9LAogICAgbHVtaW5vc2l0eTogZnVuY3Rpb24gbHVtaW5vc2l0eSgpIHsKICAgICAgLy8gaHR0cDovL3d3dy53My5vcmcvVFIvV0NBRzIwLyNyZWxhdGl2ZWx1bWluYW5jZWRlZgogICAgICB2YXIgcmdiID0gdGhpcy52YWx1ZXMucmdiOwogICAgICB2YXIgbHVtID0gW107CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJnYi5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBjaGFuID0gcmdiW2ldIC8gMjU1OwogICAgICAgIGx1bVtpXSA9IGNoYW4gPD0gMC4wMzkyOCA/IGNoYW4gLyAxMi45MiA6IE1hdGgucG93KChjaGFuICsgMC4wNTUpIC8gMS4wNTUsIDIuNCk7CiAgICAgIH0KCiAgICAgIHJldHVybiAwLjIxMjYgKiBsdW1bMF0gKyAwLjcxNTIgKiBsdW1bMV0gKyAwLjA3MjIgKiBsdW1bMl07CiAgICB9LAogICAgY29udHJhc3Q6IGZ1bmN0aW9uIGNvbnRyYXN0KGNvbG9yMikgewogICAgICAvLyBodHRwOi8vd3d3LnczLm9yZy9UUi9XQ0FHMjAvI2NvbnRyYXN0LXJhdGlvZGVmCiAgICAgIHZhciBsdW0xID0gdGhpcy5sdW1pbm9zaXR5KCk7CiAgICAgIHZhciBsdW0yID0gY29sb3IyLmx1bWlub3NpdHkoKTsKCiAgICAgIGlmIChsdW0xID4gbHVtMikgewogICAgICAgIHJldHVybiAobHVtMSArIDAuMDUpIC8gKGx1bTIgKyAwLjA1KTsKICAgICAgfQoKICAgICAgcmV0dXJuIChsdW0yICsgMC4wNSkgLyAobHVtMSArIDAuMDUpOwogICAgfSwKICAgIGxldmVsOiBmdW5jdGlvbiBsZXZlbChjb2xvcjIpIHsKICAgICAgdmFyIGNvbnRyYXN0UmF0aW8gPSB0aGlzLmNvbnRyYXN0KGNvbG9yMik7CgogICAgICBpZiAoY29udHJhc3RSYXRpbyA+PSA3LjEpIHsKICAgICAgICByZXR1cm4gJ0FBQSc7CiAgICAgIH0KCiAgICAgIHJldHVybiBjb250cmFzdFJhdGlvID49IDQuNSA/ICdBQScgOiAnJzsKICAgIH0sCiAgICBkYXJrOiBmdW5jdGlvbiBkYXJrKCkgewogICAgICAvLyBZSVEgZXF1YXRpb24gZnJvbSBodHRwOi8vMjR3YXlzLm9yZy8yMDEwL2NhbGN1bGF0aW5nLWNvbG9yLWNvbnRyYXN0CiAgICAgIHZhciByZ2IgPSB0aGlzLnZhbHVlcy5yZ2I7CiAgICAgIHZhciB5aXEgPSAocmdiWzBdICogMjk5ICsgcmdiWzFdICogNTg3ICsgcmdiWzJdICogMTE0KSAvIDEwMDA7CiAgICAgIHJldHVybiB5aXEgPCAxMjg7CiAgICB9LAogICAgbGlnaHQ6IGZ1bmN0aW9uIGxpZ2h0KCkgewogICAgICByZXR1cm4gIXRoaXMuZGFyaygpOwogICAgfSwKICAgIG5lZ2F0ZTogZnVuY3Rpb24gbmVnYXRlKCkgewogICAgICB2YXIgcmdiID0gW107CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKykgewogICAgICAgIHJnYltpXSA9IDI1NSAtIHRoaXMudmFsdWVzLnJnYltpXTsKICAgICAgfQoKICAgICAgdGhpcy5zZXRWYWx1ZXMoJ3JnYicsIHJnYik7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGxpZ2h0ZW46IGZ1bmN0aW9uIGxpZ2h0ZW4ocmF0aW8pIHsKICAgICAgdmFyIGhzbCA9IHRoaXMudmFsdWVzLmhzbDsKICAgICAgaHNsWzJdICs9IGhzbFsyXSAqIHJhdGlvOwogICAgICB0aGlzLnNldFZhbHVlcygnaHNsJywgaHNsKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgZGFya2VuOiBmdW5jdGlvbiBkYXJrZW4ocmF0aW8pIHsKICAgICAgdmFyIGhzbCA9IHRoaXMudmFsdWVzLmhzbDsKICAgICAgaHNsWzJdIC09IGhzbFsyXSAqIHJhdGlvOwogICAgICB0aGlzLnNldFZhbHVlcygnaHNsJywgaHNsKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgc2F0dXJhdGU6IGZ1bmN0aW9uIHNhdHVyYXRlKHJhdGlvKSB7CiAgICAgIHZhciBoc2wgPSB0aGlzLnZhbHVlcy5oc2w7CiAgICAgIGhzbFsxXSArPSBoc2xbMV0gKiByYXRpbzsKICAgICAgdGhpcy5zZXRWYWx1ZXMoJ2hzbCcsIGhzbCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGRlc2F0dXJhdGU6IGZ1bmN0aW9uIGRlc2F0dXJhdGUocmF0aW8pIHsKICAgICAgdmFyIGhzbCA9IHRoaXMudmFsdWVzLmhzbDsKICAgICAgaHNsWzFdIC09IGhzbFsxXSAqIHJhdGlvOwogICAgICB0aGlzLnNldFZhbHVlcygnaHNsJywgaHNsKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgd2hpdGVuOiBmdW5jdGlvbiB3aGl0ZW4ocmF0aW8pIHsKICAgICAgdmFyIGh3YiA9IHRoaXMudmFsdWVzLmh3YjsKICAgICAgaHdiWzFdICs9IGh3YlsxXSAqIHJhdGlvOwogICAgICB0aGlzLnNldFZhbHVlcygnaHdiJywgaHdiKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgYmxhY2tlbjogZnVuY3Rpb24gYmxhY2tlbihyYXRpbykgewogICAgICB2YXIgaHdiID0gdGhpcy52YWx1ZXMuaHdiOwogICAgICBod2JbMl0gKz0gaHdiWzJdICogcmF0aW87CiAgICAgIHRoaXMuc2V0VmFsdWVzKCdod2InLCBod2IpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBncmV5c2NhbGU6IGZ1bmN0aW9uIGdyZXlzY2FsZSgpIHsKICAgICAgdmFyIHJnYiA9IHRoaXMudmFsdWVzLnJnYjsgLy8gaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9HcmF5c2NhbGUjQ29udmVydGluZ19jb2xvcl90b19ncmF5c2NhbGUKCiAgICAgIHZhciB2YWwgPSByZ2JbMF0gKiAwLjMgKyByZ2JbMV0gKiAwLjU5ICsgcmdiWzJdICogMC4xMTsKICAgICAgdGhpcy5zZXRWYWx1ZXMoJ3JnYicsIFt2YWwsIHZhbCwgdmFsXSk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIGNsZWFyZXI6IGZ1bmN0aW9uIGNsZWFyZXIocmF0aW8pIHsKICAgICAgdmFyIGFscGhhID0gdGhpcy52YWx1ZXMuYWxwaGE7CiAgICAgIHRoaXMuc2V0VmFsdWVzKCdhbHBoYScsIGFscGhhIC0gYWxwaGEgKiByYXRpbyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIG9wYXF1ZXI6IGZ1bmN0aW9uIG9wYXF1ZXIocmF0aW8pIHsKICAgICAgdmFyIGFscGhhID0gdGhpcy52YWx1ZXMuYWxwaGE7CiAgICAgIHRoaXMuc2V0VmFsdWVzKCdhbHBoYScsIGFscGhhICsgYWxwaGEgKiByYXRpbyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKICAgIHJvdGF0ZTogZnVuY3Rpb24gcm90YXRlKGRlZ3JlZXMpIHsKICAgICAgdmFyIGhzbCA9IHRoaXMudmFsdWVzLmhzbDsKICAgICAgdmFyIGh1ZSA9IChoc2xbMF0gKyBkZWdyZWVzKSAlIDM2MDsKICAgICAgaHNsWzBdID0gaHVlIDwgMCA/IDM2MCArIGh1ZSA6IGh1ZTsKICAgICAgdGhpcy5zZXRWYWx1ZXMoJ2hzbCcsIGhzbCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvKioKICAgICAqIFBvcnRlZCBmcm9tIHNhc3MgaW1wbGVtZW50YXRpb24gaW4gQwogICAgICogaHR0cHM6Ly9naXRodWIuY29tL3Nhc3MvbGlic2Fzcy9ibG9iLzBlNmI0YTI4NTAwOTIzNTZhYTNlY2UwN2M2YjI0OWYwMjIxY2FjZWQvZnVuY3Rpb25zLmNwcCNMMjA5CiAgICAgKi8KICAgIG1peDogZnVuY3Rpb24gbWl4KG1peGluQ29sb3IsIHdlaWdodCkgewogICAgICB2YXIgY29sb3IxID0gdGhpczsKICAgICAgdmFyIGNvbG9yMiA9IG1peGluQ29sb3I7CiAgICAgIHZhciBwID0gd2VpZ2h0ID09PSB1bmRlZmluZWQgPyAwLjUgOiB3ZWlnaHQ7CiAgICAgIHZhciB3ID0gMiAqIHAgLSAxOwogICAgICB2YXIgYSA9IGNvbG9yMS5hbHBoYSgpIC0gY29sb3IyLmFscGhhKCk7CiAgICAgIHZhciB3MSA9ICgodyAqIGEgPT09IC0xID8gdyA6ICh3ICsgYSkgLyAoMSArIHcgKiBhKSkgKyAxKSAvIDIuMDsKICAgICAgdmFyIHcyID0gMSAtIHcxOwogICAgICByZXR1cm4gdGhpcy5yZ2IodzEgKiBjb2xvcjEucmVkKCkgKyB3MiAqIGNvbG9yMi5yZWQoKSwgdzEgKiBjb2xvcjEuZ3JlZW4oKSArIHcyICogY29sb3IyLmdyZWVuKCksIHcxICogY29sb3IxLmJsdWUoKSArIHcyICogY29sb3IyLmJsdWUoKSkuYWxwaGEoY29sb3IxLmFscGhhKCkgKiBwICsgY29sb3IyLmFscGhhKCkgKiAoMSAtIHApKTsKICAgIH0sCiAgICB0b0pTT046IGZ1bmN0aW9uIHRvSlNPTigpIHsKICAgICAgcmV0dXJuIHRoaXMucmdiKCk7CiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uIGNsb25lKCkgewogICAgICAvLyBOT1RFKFNCKTogdXNpbmcgbm9kZS1jbG9uZSBjcmVhdGVzIGEgZGVwZW5kZW5jeSB0byBCdWZmZXIgd2hlbiB1c2luZyBicm93c2VyaWZ5LAogICAgICAvLyBtYWtpbmcgdGhlIGZpbmFsIGJ1aWxkIHdheSB0byBiaWcgdG8gZW1iZWQgaW4gQ2hhcnQuanMuIFNvIGxldCdzIGRvIGl0IG1hbnVhbGx5LAogICAgICAvLyBhc3N1bWluZyB0aGF0IHZhbHVlcyB0byBjbG9uZSBhcmUgMSBkaW1lbnNpb24gYXJyYXlzIGNvbnRhaW5pbmcgb25seSBudW1iZXJzLAogICAgICAvLyBleGNlcHQgJ2FscGhhJyB3aGljaCBpcyBhIG51bWJlci4KICAgICAgdmFyIHJlc3VsdCA9IG5ldyBDb2xvcigpOwogICAgICB2YXIgc291cmNlID0gdGhpcy52YWx1ZXM7CiAgICAgIHZhciB0YXJnZXQgPSByZXN1bHQudmFsdWVzOwogICAgICB2YXIgdmFsdWUsIHR5cGU7CgogICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgIGlmIChzb3VyY2UuaGFzT3duUHJvcGVydHkocHJvcCkpIHsKICAgICAgICAgIHZhbHVlID0gc291cmNlW3Byb3BdOwogICAgICAgICAgdHlwZSA9IHt9LnRvU3RyaW5nLmNhbGwodmFsdWUpOwoKICAgICAgICAgIGlmICh0eXBlID09PSAnW29iamVjdCBBcnJheV0nKSB7CiAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHZhbHVlLnNsaWNlKDApOwogICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnW29iamVjdCBOdW1iZXJdJykgewogICAgICAgICAgICB0YXJnZXRbcHJvcF0gPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ3VuZXhwZWN0ZWQgY29sb3IgdmFsdWU6JywgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0KICB9OwogIENvbG9yLnByb3RvdHlwZS5zcGFjZXMgPSB7CiAgICByZ2I6IFsncmVkJywgJ2dyZWVuJywgJ2JsdWUnXSwKICAgIGhzbDogWydodWUnLCAnc2F0dXJhdGlvbicsICdsaWdodG5lc3MnXSwKICAgIGhzdjogWydodWUnLCAnc2F0dXJhdGlvbicsICd2YWx1ZSddLAogICAgaHdiOiBbJ2h1ZScsICd3aGl0ZW5lc3MnLCAnYmxhY2tuZXNzJ10sCiAgICBjbXlrOiBbJ2N5YW4nLCAnbWFnZW50YScsICd5ZWxsb3cnLCAnYmxhY2snXQogIH07CiAgQ29sb3IucHJvdG90eXBlLm1heGVzID0gewogICAgcmdiOiBbMjU1LCAyNTUsIDI1NV0sCiAgICBoc2w6IFszNjAsIDEwMCwgMTAwXSwKICAgIGhzdjogWzM2MCwgMTAwLCAxMDBdLAogICAgaHdiOiBbMzYwLCAxMDAsIDEwMF0sCiAgICBjbXlrOiBbMTAwLCAxMDAsIDEwMCwgMTAwXQogIH07CgogIENvbG9yLnByb3RvdHlwZS5nZXRWYWx1ZXMgPSBmdW5jdGlvbiAoc3BhY2UpIHsKICAgIHZhciB2YWx1ZXMgPSB0aGlzLnZhbHVlczsKICAgIHZhciB2YWxzID0ge307CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzcGFjZS5sZW5ndGg7IGkrKykgewogICAgICB2YWxzW3NwYWNlLmNoYXJBdChpKV0gPSB2YWx1ZXNbc3BhY2VdW2ldOwogICAgfQoKICAgIGlmICh2YWx1ZXMuYWxwaGEgIT09IDEpIHsKICAgICAgdmFscy5hID0gdmFsdWVzLmFscGhhOwogICAgfSAvLyB7cjogMjU1LCBnOiAyNTUsIGI6IDI1NSwgYTogMC40fQoKCiAgICByZXR1cm4gdmFsczsKICB9OwoKICBDb2xvci5wcm90b3R5cGUuc2V0VmFsdWVzID0gZnVuY3Rpb24gKHNwYWNlLCB2YWxzKSB7CiAgICB2YXIgdmFsdWVzID0gdGhpcy52YWx1ZXM7CiAgICB2YXIgc3BhY2VzID0gdGhpcy5zcGFjZXM7CiAgICB2YXIgbWF4ZXMgPSB0aGlzLm1heGVzOwogICAgdmFyIGFscGhhID0gMTsKICAgIHZhciBpOwogICAgdGhpcy52YWxpZCA9IHRydWU7CgogICAgaWYgKHNwYWNlID09PSAnYWxwaGEnKSB7CiAgICAgIGFscGhhID0gdmFsczsKICAgIH0gZWxzZSBpZiAodmFscy5sZW5ndGgpIHsKICAgICAgLy8gWzEwLCAxMCwgMTBdCiAgICAgIHZhbHVlc1tzcGFjZV0gPSB2YWxzLnNsaWNlKDAsIHNwYWNlLmxlbmd0aCk7CiAgICAgIGFscGhhID0gdmFsc1tzcGFjZS5sZW5ndGhdOwogICAgfSBlbHNlIGlmICh2YWxzW3NwYWNlLmNoYXJBdCgwKV0gIT09IHVuZGVmaW5lZCkgewogICAgICAvLyB7cjogMTAsIGc6IDEwLCBiOiAxMH0KICAgICAgZm9yIChpID0gMDsgaSA8IHNwYWNlLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFsdWVzW3NwYWNlXVtpXSA9IHZhbHNbc3BhY2UuY2hhckF0KGkpXTsKICAgICAgfQoKICAgICAgYWxwaGEgPSB2YWxzLmE7CiAgICB9IGVsc2UgaWYgKHZhbHNbc3BhY2VzW3NwYWNlXVswXV0gIT09IHVuZGVmaW5lZCkgewogICAgICAvLyB7cmVkOiAxMCwgZ3JlZW46IDEwLCBibHVlOiAxMH0KICAgICAgdmFyIGNoYW5zID0gc3BhY2VzW3NwYWNlXTsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBzcGFjZS5sZW5ndGg7IGkrKykgewogICAgICAgIHZhbHVlc1tzcGFjZV1baV0gPSB2YWxzW2NoYW5zW2ldXTsKICAgICAgfQoKICAgICAgYWxwaGEgPSB2YWxzLmFscGhhOwogICAgfQoKICAgIHZhbHVlcy5hbHBoYSA9IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIGFscGhhID09PSB1bmRlZmluZWQgPyB2YWx1ZXMuYWxwaGEgOiBhbHBoYSkpOwoKICAgIGlmIChzcGFjZSA9PT0gJ2FscGhhJykgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgdmFyIGNhcHBlZDsgLy8gY2FwIHZhbHVlcyBvZiB0aGUgc3BhY2UgcHJpb3IgY29udmVydGluZyBhbGwgdmFsdWVzCgogICAgZm9yIChpID0gMDsgaSA8IHNwYWNlLmxlbmd0aDsgaSsrKSB7CiAgICAgIGNhcHBlZCA9IE1hdGgubWF4KDAsIE1hdGgubWluKG1heGVzW3NwYWNlXVtpXSwgdmFsdWVzW3NwYWNlXVtpXSkpOwogICAgICB2YWx1ZXNbc3BhY2VdW2ldID0gTWF0aC5yb3VuZChjYXBwZWQpOwogICAgfSAvLyBjb252ZXJ0IHRvIGFsbCB0aGUgb3RoZXIgY29sb3Igc3BhY2VzCgoKICAgIGZvciAodmFyIHNuYW1lIGluIHNwYWNlcykgewogICAgICBpZiAoc25hbWUgIT09IHNwYWNlKSB7CiAgICAgICAgdmFsdWVzW3NuYW1lXSA9IGNvbG9yQ29udmVydFtzcGFjZV1bc25hbWVdKHZhbHVlc1tzcGFjZV0pOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgQ29sb3IucHJvdG90eXBlLnNldFNwYWNlID0gZnVuY3Rpb24gKHNwYWNlLCBhcmdzKSB7CiAgICB2YXIgdmFscyA9IGFyZ3NbMF07CgogICAgaWYgKHZhbHMgPT09IHVuZGVmaW5lZCkgewogICAgICAvLyBjb2xvci5yZ2IoKQogICAgICByZXR1cm4gdGhpcy5nZXRWYWx1ZXMoc3BhY2UpOwogICAgfSAvLyBjb2xvci5yZ2IoMTAsIDEwLCAxMCkKCgogICAgaWYgKHR5cGVvZiB2YWxzID09PSAnbnVtYmVyJykgewogICAgICB2YWxzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJncyk7CiAgICB9CgogICAgdGhpcy5zZXRWYWx1ZXMoc3BhY2UsIHZhbHMpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgQ29sb3IucHJvdG90eXBlLnNldENoYW5uZWwgPSBmdW5jdGlvbiAoc3BhY2UsIGluZGV4LCB2YWwpIHsKICAgIHZhciBzdmFsdWVzID0gdGhpcy52YWx1ZXNbc3BhY2VdOwoKICAgIGlmICh2YWwgPT09IHVuZGVmaW5lZCkgewogICAgICAvLyBjb2xvci5yZWQoKQogICAgICByZXR1cm4gc3ZhbHVlc1tpbmRleF07CiAgICB9IGVsc2UgaWYgKHZhbCA9PT0gc3ZhbHVlc1tpbmRleF0pIHsKICAgICAgLy8gY29sb3IucmVkKGNvbG9yLnJlZCgpKQogICAgICByZXR1cm4gdGhpczsKICAgIH0gLy8gY29sb3IucmVkKDEwMCkKCgogICAgc3ZhbHVlc1tpbmRleF0gPSB2YWw7CiAgICB0aGlzLnNldFZhbHVlcyhzcGFjZSwgc3ZhbHVlcyk7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHdpbmRvdy5Db2xvciA9IENvbG9yOwogIH0KCiAgdmFyIGNoYXJ0anNDb2xvciA9IENvbG9yOwoKICBmdW5jdGlvbiBpc1ZhbGlkS2V5KGtleSkgewogICAgcmV0dXJuIFsnX19wcm90b19fJywgJ3Byb3RvdHlwZScsICdjb25zdHJ1Y3RvciddLmluZGV4T2Yoa2V5KSA9PT0gLTE7CiAgfQogIC8qKg0KICAgKiBAbmFtZXNwYWNlIENoYXJ0LmhlbHBlcnMNCiAgICovCgoKICB2YXIgaGVscGVycyA9IHsKICAgIC8qKg0KICAgICAqIEFuIGVtcHR5IGZ1bmN0aW9uIHRoYXQgY2FuIGJlIHVzZWQsIGZvciBleGFtcGxlLCBmb3Igb3B0aW9uYWwgY2FsbGJhY2suDQogICAgICovCiAgICBub29wOiBmdW5jdGlvbiBub29wKCkge30sCgogICAgLyoqDQogICAgICogUmV0dXJucyBhIHVuaXF1ZSBpZCwgc2VxdWVudGlhbGx5IGdlbmVyYXRlZCBmcm9tIGEgZ2xvYmFsIHZhcmlhYmxlLg0KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9DQogICAgICogQGZ1bmN0aW9uDQogICAgICovCiAgICB1aWQ6IGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIGlkID0gMDsKICAgICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gaWQrKzsKICAgICAgfTsKICAgIH0oKSwKCiAgICAvKioNCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgYHZhbHVlYCBpcyBuZWl0aGVyIG51bGwgbm9yIHVuZGVmaW5lZCwgZWxzZSByZXR1cm5zIGZhbHNlLg0KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gdGVzdC4NCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0NCiAgICAgKiBAc2luY2UgMi43LjANCiAgICAgKi8KICAgIGlzTnVsbE9yVW5kZWY6IGZ1bmN0aW9uIGlzTnVsbE9yVW5kZWYodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlID09PSBudWxsIHx8IHR5cGVvZiB2YWx1ZSA9PT0gJ3VuZGVmaW5lZCc7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgdHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIGFycmF5IChpbmNsdWRpbmcgdHlwZWQgYXJyYXlzKSwgZWxzZSByZXR1cm5zIGZhbHNlLg0KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gdGVzdC4NCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0NCiAgICAgKiBAZnVuY3Rpb24NCiAgICAgKi8KICAgIGlzQXJyYXk6IGZ1bmN0aW9uIGlzQXJyYXkodmFsdWUpIHsKICAgICAgaWYgKEFycmF5LmlzQXJyYXkgJiYgQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQoKICAgICAgdmFyIHR5cGUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpOwoKICAgICAgaWYgKHR5cGUuc3Vic3RyKDAsIDcpID09PSAnW29iamVjdCcgJiYgdHlwZS5zdWJzdHIoLTYpID09PSAnQXJyYXldJykgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgdHJ1ZSBpZiBgdmFsdWVgIGlzIGFuIG9iamVjdCAoZXhjbHVkaW5nIG51bGwpLCBlbHNlIHJldHVybnMgZmFsc2UuDQogICAgICogQHBhcmFtIHsqfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byB0ZXN0Lg0KICAgICAqIEByZXR1cm5zIHtib29sZWFufQ0KICAgICAqIEBzaW5jZSAyLjcuMA0KICAgICAqLwogICAgaXNPYmplY3Q6IGZ1bmN0aW9uIGlzT2JqZWN0KHZhbHVlKSB7CiAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbCAmJiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpID09PSAnW29iamVjdCBPYmplY3RdJzsKICAgIH0sCgogICAgLyoqDQogICAgICogUmV0dXJucyB0cnVlIGlmIGB2YWx1ZWAgaXMgYSBmaW5pdGUgbnVtYmVyLCBlbHNlIHJldHVybnMgZmFsc2UNCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlICAtIFRoZSB2YWx1ZSB0byB0ZXN0Lg0KICAgICAqIEByZXR1cm5zIHtib29sZWFufQ0KICAgICAqLwogICAgaXNGaW5pdGU6IGZ1bmN0aW9uIChfaXNGaW5pdGUpIHsKICAgICAgZnVuY3Rpb24gaXNGaW5pdGUoX3gpIHsKICAgICAgICByZXR1cm4gX2lzRmluaXRlLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCiAgICAgIGlzRmluaXRlLnRvU3RyaW5nID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBfaXNGaW5pdGUudG9TdHJpbmcoKTsKICAgICAgfTsKCiAgICAgIHJldHVybiBpc0Zpbml0ZTsKICAgIH0oZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIHJldHVybiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyB8fCB2YWx1ZSBpbnN0YW5jZW9mIE51bWJlcikgJiYgaXNGaW5pdGUodmFsdWUpOwogICAgfSksCgogICAgLyoqDQogICAgICogUmV0dXJucyBgdmFsdWVgIGlmIGRlZmluZWQsIGVsc2UgcmV0dXJucyBgZGVmYXVsdFZhbHVlYC4NCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIHJldHVybiBpZiBkZWZpbmVkLg0KICAgICAqIEBwYXJhbSB7Kn0gZGVmYXVsdFZhbHVlIC0gVGhlIHZhbHVlIHRvIHJldHVybiBpZiBgdmFsdWVgIGlzIHVuZGVmaW5lZC4NCiAgICAgKiBAcmV0dXJucyB7Kn0NCiAgICAgKi8KICAgIHZhbHVlT3JEZWZhdWx0OiBmdW5jdGlvbiB2YWx1ZU9yRGVmYXVsdCh2YWx1ZSwgZGVmYXVsdFZhbHVlKSB7CiAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICd1bmRlZmluZWQnID8gZGVmYXVsdFZhbHVlIDogdmFsdWU7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgdmFsdWUgYXQgdGhlIGdpdmVuIGBpbmRleGAgaW4gYXJyYXkgaWYgZGVmaW5lZCwgZWxzZSByZXR1cm5zIGBkZWZhdWx0VmFsdWVgLg0KICAgICAqIEBwYXJhbSB7QXJyYXl9IHZhbHVlIC0gVGhlIGFycmF5IHRvIGxvb2t1cCBmb3IgdmFsdWUgYXQgYGluZGV4YC4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggaW4gYHZhbHVlYCB0byBsb29rdXAgZm9yIHZhbHVlLg0KICAgICAqIEBwYXJhbSB7Kn0gZGVmYXVsdFZhbHVlIC0gVGhlIHZhbHVlIHRvIHJldHVybiBpZiBgdmFsdWVbaW5kZXhdYCBpcyB1bmRlZmluZWQuDQogICAgICogQHJldHVybnMgeyp9DQogICAgICovCiAgICB2YWx1ZUF0SW5kZXhPckRlZmF1bHQ6IGZ1bmN0aW9uIHZhbHVlQXRJbmRleE9yRGVmYXVsdCh2YWx1ZSwgaW5kZXgsIGRlZmF1bHRWYWx1ZSkgewogICAgICByZXR1cm4gaGVscGVycy52YWx1ZU9yRGVmYXVsdChoZWxwZXJzLmlzQXJyYXkodmFsdWUpID8gdmFsdWVbaW5kZXhdIDogdmFsdWUsIGRlZmF1bHRWYWx1ZSk7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIENhbGxzIGBmbmAgd2l0aCB0aGUgZ2l2ZW4gYGFyZ3NgIGluIHRoZSBzY29wZSBkZWZpbmVkIGJ5IGB0aGlzQXJnYCBhbmQgcmV0dXJucyB0aGUNCiAgICAgKiB2YWx1ZSByZXR1cm5lZCBieSBgZm5gLiBJZiBgZm5gIGlzIG5vdCBhIGZ1bmN0aW9uLCB0aGlzIG1ldGhvZCByZXR1cm5zIHVuZGVmaW5lZC4NCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmbiAtIFRoZSBmdW5jdGlvbiB0byBjYWxsLg0KICAgICAqIEBwYXJhbSB7QXJyYXl8dW5kZWZpbmVkfG51bGx9IGFyZ3MgLSBUaGUgYXJndW1lbnRzIHdpdGggd2hpY2ggYGZuYCBzaG91bGQgYmUgY2FsbGVkLg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBbdGhpc0FyZ10gLSBUaGUgdmFsdWUgb2YgYHRoaXNgIHByb3ZpZGVkIGZvciB0aGUgY2FsbCB0byBgZm5gLg0KICAgICAqIEByZXR1cm5zIHsqfQ0KICAgICAqLwogICAgY2FsbGJhY2s6IGZ1bmN0aW9uIGNhbGxiYWNrKGZuLCBhcmdzLCB0aGlzQXJnKSB7CiAgICAgIGlmIChmbiAmJiB0eXBlb2YgZm4uY2FsbCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzQXJnLCBhcmdzKTsKICAgICAgfQogICAgfSwKCiAgICAvKioNCiAgICAgKiBOb3RlKFNCKSBmb3IgcGVyZm9ybWFuY2Ugc2FrZSwgdGhpcyBtZXRob2Qgc2hvdWxkIG9ubHkgYmUgdXNlZCB3aGVuIGxvb3BhYmxlIHR5cGUNCiAgICAgKiBpcyB1bmtub3duIG9yIGluIG5vbmUgaW50ZW5zaXZlIGNvZGUgKG5vdCBjYWxsZWQgb2Z0ZW4gYW5kIHNtYWxsIGxvb3BhYmxlKS4gRWxzZQ0KICAgICAqIGl0J3MgcHJlZmVyYWJsZSB0byB1c2UgYSByZWd1bGFyIGZvcigpIGxvb3AgYW5kIHNhdmUgZXh0cmEgZnVuY3Rpb24gY2FsbHMuDQogICAgICogQHBhcmFtIHtvYmplY3R8QXJyYXl9IGxvb3BhYmxlIC0gVGhlIG9iamVjdCBvciBhcnJheSB0byBiZSBpdGVyYXRlZC4NCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBmbiAtIFRoZSBmdW5jdGlvbiB0byBjYWxsIGZvciBlYWNoIGl0ZW0uDQogICAgICogQHBhcmFtIHtvYmplY3R9IFt0aGlzQXJnXSAtIFRoZSB2YWx1ZSBvZiBgdGhpc2AgcHJvdmlkZWQgZm9yIHRoZSBjYWxsIHRvIGBmbmAuDQogICAgICogQHBhcmFtIHtib29sZWFufSBbcmV2ZXJzZV0gLSBJZiB0cnVlLCBpdGVyYXRlcyBiYWNrd2FyZCBvbiB0aGUgbG9vcGFibGUuDQogICAgICovCiAgICBlYWNoOiBmdW5jdGlvbiBlYWNoKGxvb3BhYmxlLCBmbiwgdGhpc0FyZywgcmV2ZXJzZSkgewogICAgICB2YXIgaSwgbGVuLCBrZXlzOwoKICAgICAgaWYgKGhlbHBlcnMuaXNBcnJheShsb29wYWJsZSkpIHsKICAgICAgICBsZW4gPSBsb29wYWJsZS5sZW5ndGg7CgogICAgICAgIGlmIChyZXZlcnNlKSB7CiAgICAgICAgICBmb3IgKGkgPSBsZW4gLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgICBmbi5jYWxsKHRoaXNBcmcsIGxvb3BhYmxlW2ldLCBpKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgIGZuLmNhbGwodGhpc0FyZywgbG9vcGFibGVbaV0sIGkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIGlmIChoZWxwZXJzLmlzT2JqZWN0KGxvb3BhYmxlKSkgewogICAgICAgIGtleXMgPSBPYmplY3Qua2V5cyhsb29wYWJsZSk7CiAgICAgICAgbGVuID0ga2V5cy5sZW5ndGg7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgZm4uY2FsbCh0aGlzQXJnLCBsb29wYWJsZVtrZXlzW2ldXSwga2V5c1tpXSk7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgYGEwYCBhbmQgYGExYCBhcnJheXMgaGF2ZSB0aGUgc2FtZSBjb250ZW50LCBlbHNlIHJldHVybnMgZmFsc2UuDQogICAgICogQHNlZSBodHRwczovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMTQ4NTM5NzQNCiAgICAgKiBAcGFyYW0ge0FycmF5fSBhMCAtIFRoZSBhcnJheSB0byBjb21wYXJlDQogICAgICogQHBhcmFtIHtBcnJheX0gYTEgLSBUaGUgYXJyYXkgdG8gY29tcGFyZQ0KICAgICAqIEByZXR1cm5zIHtib29sZWFufQ0KICAgICAqLwogICAgYXJyYXlFcXVhbHM6IGZ1bmN0aW9uIGFycmF5RXF1YWxzKGEwLCBhMSkgewogICAgICB2YXIgaSwgaWxlbiwgdjAsIHYxOwoKICAgICAgaWYgKCFhMCB8fCAhYTEgfHwgYTAubGVuZ3RoICE9PSBhMS5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBhMC5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICB2MCA9IGEwW2ldOwogICAgICAgIHYxID0gYTFbaV07CgogICAgICAgIGlmICh2MCBpbnN0YW5jZW9mIEFycmF5ICYmIHYxIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgIGlmICghaGVscGVycy5hcnJheUVxdWFscyh2MCwgdjEpKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHYwICE9PSB2MSkgewogICAgICAgICAgLy8gTk9URTogdHdvIGRpZmZlcmVudCBvYmplY3QgaW5zdGFuY2VzIHdpbGwgbmV2ZXIgYmUgZXF1YWw6IHt4OjIwfSAhPSB7eDoyMH0KICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBSZXR1cm5zIGEgZGVlcCBjb3B5IG9mIGBzb3VyY2VgIHdpdGhvdXQga2VlcGluZyByZWZlcmVuY2VzIG9uIG9iamVjdHMgYW5kIGFycmF5cy4NCiAgICAgKiBAcGFyYW0geyp9IHNvdXJjZSAtIFRoZSB2YWx1ZSB0byBjbG9uZS4NCiAgICAgKiBAcmV0dXJucyB7Kn0NCiAgICAgKi8KICAgIGNsb25lOiBmdW5jdGlvbiBjbG9uZShzb3VyY2UpIHsKICAgICAgaWYgKGhlbHBlcnMuaXNBcnJheShzb3VyY2UpKSB7CiAgICAgICAgcmV0dXJuIHNvdXJjZS5tYXAoaGVscGVycy5jbG9uZSk7CiAgICAgIH0KCiAgICAgIGlmIChoZWxwZXJzLmlzT2JqZWN0KHNvdXJjZSkpIHsKICAgICAgICB2YXIgdGFyZ2V0ID0gT2JqZWN0LmNyZWF0ZShzb3VyY2UpOwogICAgICAgIHZhciBrZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsKICAgICAgICB2YXIga2xlbiA9IGtleXMubGVuZ3RoOwogICAgICAgIHZhciBrID0gMDsKCiAgICAgICAgZm9yICg7IGsgPCBrbGVuOyArK2spIHsKICAgICAgICAgIHRhcmdldFtrZXlzW2tdXSA9IGhlbHBlcnMuY2xvbmUoc291cmNlW2tleXNba11dKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgIH0KCiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFRoZSBkZWZhdWx0IG1lcmdlciB3aGVuIENoYXJ0LmhlbHBlcnMubWVyZ2UgaXMgY2FsbGVkIHdpdGhvdXQgbWVyZ2VyIG9wdGlvbi4NCiAgICAgKiBOb3RlKFNCKTogYWxzbyB1c2VkIGJ5IG1lcmdlQ29uZmlnIGFuZCBtZXJnZVNjYWxlQ29uZmlnIGFzIGZhbGxiYWNrLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfbWVyZ2VyOiBmdW5jdGlvbiBfbWVyZ2VyKGtleSwgdGFyZ2V0LCBzb3VyY2UsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFpc1ZhbGlkS2V5KGtleSkpIHsKICAgICAgICAvLyBXZSB3YW50IHRvIGVuc3VyZSB3ZSBkbyBub3QgY29weSBwcm90b3R5cGVzIG92ZXIKICAgICAgICAvLyBhcyB0aGlzIGNhbiBwb2xsdXRlIGdsb2JhbCBuYW1lc3BhY2VzCiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgdHZhbCA9IHRhcmdldFtrZXldOwogICAgICB2YXIgc3ZhbCA9IHNvdXJjZVtrZXldOwoKICAgICAgaWYgKGhlbHBlcnMuaXNPYmplY3QodHZhbCkgJiYgaGVscGVycy5pc09iamVjdChzdmFsKSkgewogICAgICAgIGhlbHBlcnMubWVyZ2UodHZhbCwgc3ZhbCwgb3B0aW9ucyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGFyZ2V0W2tleV0gPSBoZWxwZXJzLmNsb25lKHN2YWwpOwogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIE1lcmdlcyBzb3VyY2Vba2V5XSBpbiB0YXJnZXRba2V5XSBvbmx5IGlmIHRhcmdldFtrZXldIGlzIHVuZGVmaW5lZC4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX21lcmdlcklmOiBmdW5jdGlvbiBfbWVyZ2VySWYoa2V5LCB0YXJnZXQsIHNvdXJjZSkgewogICAgICBpZiAoIWlzVmFsaWRLZXkoa2V5KSkgewogICAgICAgIC8vIFdlIHdhbnQgdG8gZW5zdXJlIHdlIGRvIG5vdCBjb3B5IHByb3RvdHlwZXMgb3ZlcgogICAgICAgIC8vIGFzIHRoaXMgY2FuIHBvbGx1dGUgZ2xvYmFsIG5hbWVzcGFjZXMKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciB0dmFsID0gdGFyZ2V0W2tleV07CiAgICAgIHZhciBzdmFsID0gc291cmNlW2tleV07CgogICAgICBpZiAoaGVscGVycy5pc09iamVjdCh0dmFsKSAmJiBoZWxwZXJzLmlzT2JqZWN0KHN2YWwpKSB7CiAgICAgICAgaGVscGVycy5tZXJnZUlmKHR2YWwsIHN2YWwpOwogICAgICB9IGVsc2UgaWYgKCF0YXJnZXQuaGFzT3duUHJvcGVydHkoa2V5KSkgewogICAgICAgIHRhcmdldFtrZXldID0gaGVscGVycy5jbG9uZShzdmFsKTsKICAgICAgfQogICAgfSwKCiAgICAvKioNCiAgICAgKiBSZWN1cnNpdmVseSBkZWVwIGNvcGllcyBgc291cmNlYCBwcm9wZXJ0aWVzIGludG8gYHRhcmdldGAgd2l0aCB0aGUgZ2l2ZW4gYG9wdGlvbnNgLg0KICAgICAqIElNUE9SVEFOVDogYHRhcmdldGAgaXMgbm90IGNsb25lZCBhbmQgd2lsbCBiZSB1cGRhdGVkIHdpdGggYHNvdXJjZWAgcHJvcGVydGllcy4NCiAgICAgKiBAcGFyYW0ge29iamVjdH0gdGFyZ2V0IC0gVGhlIHRhcmdldCBvYmplY3QgaW4gd2hpY2ggYWxsIHNvdXJjZXMgYXJlIG1lcmdlZCBpbnRvLg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fG9iamVjdFtdfSBzb3VyY2UgLSBPYmplY3QocykgdG8gbWVyZ2UgaW50byBgdGFyZ2V0YC4NCiAgICAgKiBAcGFyYW0ge29iamVjdH0gW29wdGlvbnNdIC0gTWVyZ2luZyBvcHRpb25zOg0KICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtvcHRpb25zLm1lcmdlcl0gLSBUaGUgbWVyZ2UgbWV0aG9kIChrZXksIHRhcmdldCwgc291cmNlLCBvcHRpb25zKQ0KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IFRoZSBgdGFyZ2V0YCBvYmplY3QuDQogICAgICovCiAgICBtZXJnZTogZnVuY3Rpb24gbWVyZ2UodGFyZ2V0LCBzb3VyY2UsIG9wdGlvbnMpIHsKICAgICAgdmFyIHNvdXJjZXMgPSBoZWxwZXJzLmlzQXJyYXkoc291cmNlKSA/IHNvdXJjZSA6IFtzb3VyY2VdOwogICAgICB2YXIgaWxlbiA9IHNvdXJjZXMubGVuZ3RoOwogICAgICB2YXIgbWVyZ2UsIGksIGtleXMsIGtsZW4sIGs7CgogICAgICBpZiAoIWhlbHBlcnMuaXNPYmplY3QodGFyZ2V0KSkgewogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgIH0KCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgICBtZXJnZSA9IG9wdGlvbnMubWVyZ2VyIHx8IGhlbHBlcnMuX21lcmdlcjsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBzb3VyY2UgPSBzb3VyY2VzW2ldOwoKICAgICAgICBpZiAoIWhlbHBlcnMuaXNPYmplY3Qoc291cmNlKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBrZXlzID0gT2JqZWN0LmtleXMoc291cmNlKTsKCiAgICAgICAgZm9yIChrID0gMCwga2xlbiA9IGtleXMubGVuZ3RoOyBrIDwga2xlbjsgKytrKSB7CiAgICAgICAgICBtZXJnZShrZXlzW2tdLCB0YXJnZXQsIHNvdXJjZSwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfSwKCiAgICAvKioNCiAgICAgKiBSZWN1cnNpdmVseSBkZWVwIGNvcGllcyBgc291cmNlYCBwcm9wZXJ0aWVzIGludG8gYHRhcmdldGAgKm9ubHkqIGlmIG5vdCBkZWZpbmVkIGluIHRhcmdldC4NCiAgICAgKiBJTVBPUlRBTlQ6IGB0YXJnZXRgIGlzIG5vdCBjbG9uZWQgYW5kIHdpbGwgYmUgdXBkYXRlZCB3aXRoIGBzb3VyY2VgIHByb3BlcnRpZXMuDQogICAgICogQHBhcmFtIHtvYmplY3R9IHRhcmdldCAtIFRoZSB0YXJnZXQgb2JqZWN0IGluIHdoaWNoIGFsbCBzb3VyY2VzIGFyZSBtZXJnZWQgaW50by4NCiAgICAgKiBAcGFyYW0ge29iamVjdHxvYmplY3RbXX0gc291cmNlIC0gT2JqZWN0KHMpIHRvIG1lcmdlIGludG8gYHRhcmdldGAuDQogICAgICogQHJldHVybnMge29iamVjdH0gVGhlIGB0YXJnZXRgIG9iamVjdC4NCiAgICAgKi8KICAgIG1lcmdlSWY6IGZ1bmN0aW9uIG1lcmdlSWYodGFyZ2V0LCBzb3VyY2UpIHsKICAgICAgcmV0dXJuIGhlbHBlcnMubWVyZ2UodGFyZ2V0LCBzb3VyY2UsIHsKICAgICAgICBtZXJnZXI6IGhlbHBlcnMuX21lcmdlcklmCiAgICAgIH0pOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBBcHBsaWVzIHRoZSBjb250ZW50cyBvZiB0d28gb3IgbW9yZSBvYmplY3RzIHRvZ2V0aGVyIGludG8gdGhlIGZpcnN0IG9iamVjdC4NCiAgICAgKiBAcGFyYW0ge29iamVjdH0gdGFyZ2V0IC0gVGhlIHRhcmdldCBvYmplY3QgaW4gd2hpY2ggYWxsIG9iamVjdHMgYXJlIG1lcmdlZCBpbnRvLg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBhcmcxIC0gT2JqZWN0IGNvbnRhaW5pbmcgYWRkaXRpb25hbCBwcm9wZXJ0aWVzIHRvIG1lcmdlIGluIHRhcmdldC4NCiAgICAgKiBAcGFyYW0ge29iamVjdH0gYXJnTiAtIEFkZGl0aW9uYWwgb2JqZWN0cyBjb250YWluaW5nIHByb3BlcnRpZXMgdG8gbWVyZ2UgaW4gdGFyZ2V0Lg0KICAgICAqIEByZXR1cm5zIHtvYmplY3R9IFRoZSBgdGFyZ2V0YCBvYmplY3QuDQogICAgICovCiAgICBleHRlbmQ6IE9iamVjdC5hc3NpZ24gfHwgZnVuY3Rpb24gKHRhcmdldCkgewogICAgICByZXR1cm4gaGVscGVycy5tZXJnZSh0YXJnZXQsIFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwgewogICAgICAgIG1lcmdlcjogZnVuY3Rpb24gbWVyZ2VyKGtleSwgZHN0LCBzcmMpIHsKICAgICAgICAgIGRzdFtrZXldID0gc3JjW2tleV07CiAgICAgICAgfQogICAgICB9KTsKICAgIH0sCgogICAgLyoqDQogICAgICogQmFzaWMgamF2YXNjcmlwdCBpbmhlcml0YW5jZSBiYXNlZCBvbiB0aGUgbW9kZWwgY3JlYXRlZCBpbiBCYWNrYm9uZS5qcw0KICAgICAqLwogICAgaW5oZXJpdHM6IGZ1bmN0aW9uIGluaGVyaXRzKGV4dGVuc2lvbnMpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIENoYXJ0RWxlbWVudCA9IGV4dGVuc2lvbnMgJiYgZXh0ZW5zaW9ucy5oYXNPd25Qcm9wZXJ0eSgnY29uc3RydWN0b3InKSA/IGV4dGVuc2lvbnMuY29uc3RydWN0b3IgOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIG1lLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH07CgogICAgICB2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24gU3Vycm9nYXRlKCkgewogICAgICAgIHRoaXMuY29uc3RydWN0b3IgPSBDaGFydEVsZW1lbnQ7CiAgICAgIH07CgogICAgICBTdXJyb2dhdGUucHJvdG90eXBlID0gbWUucHJvdG90eXBlOwogICAgICBDaGFydEVsZW1lbnQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZSgpOwogICAgICBDaGFydEVsZW1lbnQuZXh0ZW5kID0gaGVscGVycy5pbmhlcml0czsKCiAgICAgIGlmIChleHRlbnNpb25zKSB7CiAgICAgICAgaGVscGVycy5leHRlbmQoQ2hhcnRFbGVtZW50LnByb3RvdHlwZSwgZXh0ZW5zaW9ucyk7CiAgICAgIH0KCiAgICAgIENoYXJ0RWxlbWVudC5fX3N1cGVyX18gPSBtZS5wcm90b3R5cGU7CiAgICAgIHJldHVybiBDaGFydEVsZW1lbnQ7CiAgICB9LAogICAgX2RlcHJlY2F0ZWQ6IGZ1bmN0aW9uIF9kZXByZWNhdGVkKHNjb3BlLCB2YWx1ZSwgcHJldmlvdXMsIGN1cnJlbnQpIHsKICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBjb25zb2xlLndhcm4oc2NvcGUgKyAnOiAiJyArIHByZXZpb3VzICsgJyIgaXMgZGVwcmVjYXRlZC4gUGxlYXNlIHVzZSAiJyArIGN1cnJlbnQgKyAnIiBpbnN0ZWFkJyk7CiAgICAgIH0KICAgIH0KICB9OwogIHZhciBoZWxwZXJzX2NvcmUgPSBoZWxwZXJzOyAvLyBERVBSRUNBVElPTlMKCiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQ2hhcnQuaGVscGVycy5jYWxsYmFjayBpbnN0ZWFkLg0KICAgKiBAZnVuY3Rpb24gQ2hhcnQuaGVscGVycy5jYWxsQ2FsbGJhY2sNCiAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjYuMA0KICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAqIEBwcml2YXRlDQogICAqLwoKICBoZWxwZXJzLmNhbGxDYWxsYmFjayA9IGhlbHBlcnMuY2FsbGJhY2s7CiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQXJyYXkucHJvdG90eXBlLmluZGV4T2YgaW5zdGVhZC4NCiAgICogQXJyYXkucHJvdG90eXBlLmluZGV4T2YgY29tcGF0aWJpbGl0eTogQ2hyb21lLCBPcGVyYSwgU2FmYXJpLCBGRjEuNSssIElFOSsNCiAgICogQGZ1bmN0aW9uIENoYXJ0LmhlbHBlcnMuaW5kZXhPZg0KICAgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNy4wDQogICAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMNCiAgICogQHByaXZhdGUNCiAgICovCgogIGhlbHBlcnMuaW5kZXhPZiA9IGZ1bmN0aW9uIChhcnJheSwgaXRlbSwgZnJvbUluZGV4KSB7CiAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChhcnJheSwgaXRlbSwgZnJvbUluZGV4KTsKICB9OwogIC8qKg0KICAgKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdXNlIENoYXJ0LmhlbHBlcnMudmFsdWVPckRlZmF1bHQgaW5zdGVhZC4NCiAgICogQGZ1bmN0aW9uIENoYXJ0LmhlbHBlcnMuZ2V0VmFsdWVPckRlZmF1bHQNCiAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjcuMA0KICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAqIEBwcml2YXRlDQogICAqLwoKCiAgaGVscGVycy5nZXRWYWx1ZU9yRGVmYXVsdCA9IGhlbHBlcnMudmFsdWVPckRlZmF1bHQ7CiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQ2hhcnQuaGVscGVycy52YWx1ZUF0SW5kZXhPckRlZmF1bHQgaW5zdGVhZC4NCiAgICogQGZ1bmN0aW9uIENoYXJ0LmhlbHBlcnMuZ2V0VmFsdWVBdEluZGV4T3JEZWZhdWx0DQogICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi43LjANCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCiAgaGVscGVycy5nZXRWYWx1ZUF0SW5kZXhPckRlZmF1bHQgPSBoZWxwZXJzLnZhbHVlQXRJbmRleE9yRGVmYXVsdDsKICAvKioNCiAgICogRWFzaW5nIGZ1bmN0aW9ucyBhZGFwdGVkIGZyb20gUm9iZXJ0IFBlbm5lcidzIGVhc2luZyBlcXVhdGlvbnMuDQogICAqIEBuYW1lc3BhY2UgQ2hhcnQuaGVscGVycy5lYXNpbmdFZmZlY3RzDQogICAqIEBzZWUgaHR0cDovL3d3dy5yb2JlcnRwZW5uZXIuY29tL2Vhc2luZy8NCiAgICovCgogIHZhciBlZmZlY3RzID0gewogICAgbGluZWFyOiBmdW5jdGlvbiBsaW5lYXIodCkgewogICAgICByZXR1cm4gdDsKICAgIH0sCiAgICBlYXNlSW5RdWFkOiBmdW5jdGlvbiBlYXNlSW5RdWFkKHQpIHsKICAgICAgcmV0dXJuIHQgKiB0OwogICAgfSwKICAgIGVhc2VPdXRRdWFkOiBmdW5jdGlvbiBlYXNlT3V0UXVhZCh0KSB7CiAgICAgIHJldHVybiAtdCAqICh0IC0gMik7CiAgICB9LAogICAgZWFzZUluT3V0UXVhZDogZnVuY3Rpb24gZWFzZUluT3V0UXVhZCh0KSB7CiAgICAgIGlmICgodCAvPSAwLjUpIDwgMSkgewogICAgICAgIHJldHVybiAwLjUgKiB0ICogdDsKICAgICAgfQoKICAgICAgcmV0dXJuIC0wLjUgKiAoLS10ICogKHQgLSAyKSAtIDEpOwogICAgfSwKICAgIGVhc2VJbkN1YmljOiBmdW5jdGlvbiBlYXNlSW5DdWJpYyh0KSB7CiAgICAgIHJldHVybiB0ICogdCAqIHQ7CiAgICB9LAogICAgZWFzZU91dEN1YmljOiBmdW5jdGlvbiBlYXNlT3V0Q3ViaWModCkgewogICAgICByZXR1cm4gKHQgPSB0IC0gMSkgKiB0ICogdCArIDE7CiAgICB9LAogICAgZWFzZUluT3V0Q3ViaWM6IGZ1bmN0aW9uIGVhc2VJbk91dEN1YmljKHQpIHsKICAgICAgaWYgKCh0IC89IDAuNSkgPCAxKSB7CiAgICAgICAgcmV0dXJuIDAuNSAqIHQgKiB0ICogdDsKICAgICAgfQoKICAgICAgcmV0dXJuIDAuNSAqICgodCAtPSAyKSAqIHQgKiB0ICsgMik7CiAgICB9LAogICAgZWFzZUluUXVhcnQ6IGZ1bmN0aW9uIGVhc2VJblF1YXJ0KHQpIHsKICAgICAgcmV0dXJuIHQgKiB0ICogdCAqIHQ7CiAgICB9LAogICAgZWFzZU91dFF1YXJ0OiBmdW5jdGlvbiBlYXNlT3V0UXVhcnQodCkgewogICAgICByZXR1cm4gLSgodCA9IHQgLSAxKSAqIHQgKiB0ICogdCAtIDEpOwogICAgfSwKICAgIGVhc2VJbk91dFF1YXJ0OiBmdW5jdGlvbiBlYXNlSW5PdXRRdWFydCh0KSB7CiAgICAgIGlmICgodCAvPSAwLjUpIDwgMSkgewogICAgICAgIHJldHVybiAwLjUgKiB0ICogdCAqIHQgKiB0OwogICAgICB9CgogICAgICByZXR1cm4gLTAuNSAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAtIDIpOwogICAgfSwKICAgIGVhc2VJblF1aW50OiBmdW5jdGlvbiBlYXNlSW5RdWludCh0KSB7CiAgICAgIHJldHVybiB0ICogdCAqIHQgKiB0ICogdDsKICAgIH0sCiAgICBlYXNlT3V0UXVpbnQ6IGZ1bmN0aW9uIGVhc2VPdXRRdWludCh0KSB7CiAgICAgIHJldHVybiAodCA9IHQgLSAxKSAqIHQgKiB0ICogdCAqIHQgKyAxOwogICAgfSwKICAgIGVhc2VJbk91dFF1aW50OiBmdW5jdGlvbiBlYXNlSW5PdXRRdWludCh0KSB7CiAgICAgIGlmICgodCAvPSAwLjUpIDwgMSkgewogICAgICAgIHJldHVybiAwLjUgKiB0ICogdCAqIHQgKiB0ICogdDsKICAgICAgfQoKICAgICAgcmV0dXJuIDAuNSAqICgodCAtPSAyKSAqIHQgKiB0ICogdCAqIHQgKyAyKTsKICAgIH0sCiAgICBlYXNlSW5TaW5lOiBmdW5jdGlvbiBlYXNlSW5TaW5lKHQpIHsKICAgICAgcmV0dXJuIC1NYXRoLmNvcyh0ICogKE1hdGguUEkgLyAyKSkgKyAxOwogICAgfSwKICAgIGVhc2VPdXRTaW5lOiBmdW5jdGlvbiBlYXNlT3V0U2luZSh0KSB7CiAgICAgIHJldHVybiBNYXRoLnNpbih0ICogKE1hdGguUEkgLyAyKSk7CiAgICB9LAogICAgZWFzZUluT3V0U2luZTogZnVuY3Rpb24gZWFzZUluT3V0U2luZSh0KSB7CiAgICAgIHJldHVybiAtMC41ICogKE1hdGguY29zKE1hdGguUEkgKiB0KSAtIDEpOwogICAgfSwKICAgIGVhc2VJbkV4cG86IGZ1bmN0aW9uIGVhc2VJbkV4cG8odCkgewogICAgICByZXR1cm4gdCA9PT0gMCA/IDAgOiBNYXRoLnBvdygyLCAxMCAqICh0IC0gMSkpOwogICAgfSwKICAgIGVhc2VPdXRFeHBvOiBmdW5jdGlvbiBlYXNlT3V0RXhwbyh0KSB7CiAgICAgIHJldHVybiB0ID09PSAxID8gMSA6IC1NYXRoLnBvdygyLCAtMTAgKiB0KSArIDE7CiAgICB9LAogICAgZWFzZUluT3V0RXhwbzogZnVuY3Rpb24gZWFzZUluT3V0RXhwbyh0KSB7CiAgICAgIGlmICh0ID09PSAwKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0KCiAgICAgIGlmICh0ID09PSAxKSB7CiAgICAgICAgcmV0dXJuIDE7CiAgICAgIH0KCiAgICAgIGlmICgodCAvPSAwLjUpIDwgMSkgewogICAgICAgIHJldHVybiAwLjUgKiBNYXRoLnBvdygyLCAxMCAqICh0IC0gMSkpOwogICAgICB9CgogICAgICByZXR1cm4gMC41ICogKC1NYXRoLnBvdygyLCAtMTAgKiAtLXQpICsgMik7CiAgICB9LAogICAgZWFzZUluQ2lyYzogZnVuY3Rpb24gZWFzZUluQ2lyYyh0KSB7CiAgICAgIGlmICh0ID49IDEpIHsKICAgICAgICByZXR1cm4gdDsKICAgICAgfQoKICAgICAgcmV0dXJuIC0oTWF0aC5zcXJ0KDEgLSB0ICogdCkgLSAxKTsKICAgIH0sCiAgICBlYXNlT3V0Q2lyYzogZnVuY3Rpb24gZWFzZU91dENpcmModCkgewogICAgICByZXR1cm4gTWF0aC5zcXJ0KDEgLSAodCA9IHQgLSAxKSAqIHQpOwogICAgfSwKICAgIGVhc2VJbk91dENpcmM6IGZ1bmN0aW9uIGVhc2VJbk91dENpcmModCkgewogICAgICBpZiAoKHQgLz0gMC41KSA8IDEpIHsKICAgICAgICByZXR1cm4gLTAuNSAqIChNYXRoLnNxcnQoMSAtIHQgKiB0KSAtIDEpOwogICAgICB9CgogICAgICByZXR1cm4gMC41ICogKE1hdGguc3FydCgxIC0gKHQgLT0gMikgKiB0KSArIDEpOwogICAgfSwKICAgIGVhc2VJbkVsYXN0aWM6IGZ1bmN0aW9uIGVhc2VJbkVsYXN0aWModCkgewogICAgICB2YXIgcyA9IDEuNzAxNTg7CiAgICAgIHZhciBwID0gMDsKICAgICAgdmFyIGEgPSAxOwoKICAgICAgaWYgKHQgPT09IDApIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQoKICAgICAgaWYgKHQgPT09IDEpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQoKICAgICAgaWYgKCFwKSB7CiAgICAgICAgcCA9IDAuMzsKICAgICAgfQoKICAgICAgaWYgKGEgPCAxKSB7CiAgICAgICAgYSA9IDE7CiAgICAgICAgcyA9IHAgLyA0OwogICAgICB9IGVsc2UgewogICAgICAgIHMgPSBwIC8gKDIgKiBNYXRoLlBJKSAqIE1hdGguYXNpbigxIC8gYSk7CiAgICAgIH0KCiAgICAgIHJldHVybiAtKGEgKiBNYXRoLnBvdygyLCAxMCAqICh0IC09IDEpKSAqIE1hdGguc2luKCh0IC0gcykgKiAoMiAqIE1hdGguUEkpIC8gcCkpOwogICAgfSwKICAgIGVhc2VPdXRFbGFzdGljOiBmdW5jdGlvbiBlYXNlT3V0RWxhc3RpYyh0KSB7CiAgICAgIHZhciBzID0gMS43MDE1ODsKICAgICAgdmFyIHAgPSAwOwogICAgICB2YXIgYSA9IDE7CgogICAgICBpZiAodCA9PT0gMCkgewogICAgICAgIHJldHVybiAwOwogICAgICB9CgogICAgICBpZiAodCA9PT0gMSkgewogICAgICAgIHJldHVybiAxOwogICAgICB9CgogICAgICBpZiAoIXApIHsKICAgICAgICBwID0gMC4zOwogICAgICB9CgogICAgICBpZiAoYSA8IDEpIHsKICAgICAgICBhID0gMTsKICAgICAgICBzID0gcCAvIDQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcyA9IHAgLyAoMiAqIE1hdGguUEkpICogTWF0aC5hc2luKDEgLyBhKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGEgKiBNYXRoLnBvdygyLCAtMTAgKiB0KSAqIE1hdGguc2luKCh0IC0gcykgKiAoMiAqIE1hdGguUEkpIC8gcCkgKyAxOwogICAgfSwKICAgIGVhc2VJbk91dEVsYXN0aWM6IGZ1bmN0aW9uIGVhc2VJbk91dEVsYXN0aWModCkgewogICAgICB2YXIgcyA9IDEuNzAxNTg7CiAgICAgIHZhciBwID0gMDsKICAgICAgdmFyIGEgPSAxOwoKICAgICAgaWYgKHQgPT09IDApIHsKICAgICAgICByZXR1cm4gMDsKICAgICAgfQoKICAgICAgaWYgKCh0IC89IDAuNSkgPT09IDIpIHsKICAgICAgICByZXR1cm4gMTsKICAgICAgfQoKICAgICAgaWYgKCFwKSB7CiAgICAgICAgcCA9IDAuNDU7CiAgICAgIH0KCiAgICAgIGlmIChhIDwgMSkgewogICAgICAgIGEgPSAxOwogICAgICAgIHMgPSBwIC8gNDsKICAgICAgfSBlbHNlIHsKICAgICAgICBzID0gcCAvICgyICogTWF0aC5QSSkgKiBNYXRoLmFzaW4oMSAvIGEpOwogICAgICB9CgogICAgICBpZiAodCA8IDEpIHsKICAgICAgICByZXR1cm4gLTAuNSAqIChhICogTWF0aC5wb3coMiwgMTAgKiAodCAtPSAxKSkgKiBNYXRoLnNpbigodCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGEgKiBNYXRoLnBvdygyLCAtMTAgKiAodCAtPSAxKSkgKiBNYXRoLnNpbigodCAtIHMpICogKDIgKiBNYXRoLlBJKSAvIHApICogMC41ICsgMTsKICAgIH0sCiAgICBlYXNlSW5CYWNrOiBmdW5jdGlvbiBlYXNlSW5CYWNrKHQpIHsKICAgICAgdmFyIHMgPSAxLjcwMTU4OwogICAgICByZXR1cm4gdCAqIHQgKiAoKHMgKyAxKSAqIHQgLSBzKTsKICAgIH0sCiAgICBlYXNlT3V0QmFjazogZnVuY3Rpb24gZWFzZU91dEJhY2sodCkgewogICAgICB2YXIgcyA9IDEuNzAxNTg7CiAgICAgIHJldHVybiAodCA9IHQgLSAxKSAqIHQgKiAoKHMgKyAxKSAqIHQgKyBzKSArIDE7CiAgICB9LAogICAgZWFzZUluT3V0QmFjazogZnVuY3Rpb24gZWFzZUluT3V0QmFjayh0KSB7CiAgICAgIHZhciBzID0gMS43MDE1ODsKCiAgICAgIGlmICgodCAvPSAwLjUpIDwgMSkgewogICAgICAgIHJldHVybiAwLjUgKiAodCAqIHQgKiAoKChzICo9IDEuNTI1KSArIDEpICogdCAtIHMpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIDAuNSAqICgodCAtPSAyKSAqIHQgKiAoKChzICo9IDEuNTI1KSArIDEpICogdCArIHMpICsgMik7CiAgICB9LAogICAgZWFzZUluQm91bmNlOiBmdW5jdGlvbiBlYXNlSW5Cb3VuY2UodCkgewogICAgICByZXR1cm4gMSAtIGVmZmVjdHMuZWFzZU91dEJvdW5jZSgxIC0gdCk7CiAgICB9LAogICAgZWFzZU91dEJvdW5jZTogZnVuY3Rpb24gZWFzZU91dEJvdW5jZSh0KSB7CiAgICAgIGlmICh0IDwgMSAvIDIuNzUpIHsKICAgICAgICByZXR1cm4gNy41NjI1ICogdCAqIHQ7CiAgICAgIH0KCiAgICAgIGlmICh0IDwgMiAvIDIuNzUpIHsKICAgICAgICByZXR1cm4gNy41NjI1ICogKHQgLT0gMS41IC8gMi43NSkgKiB0ICsgMC43NTsKICAgICAgfQoKICAgICAgaWYgKHQgPCAyLjUgLyAyLjc1KSB7CiAgICAgICAgcmV0dXJuIDcuNTYyNSAqICh0IC09IDIuMjUgLyAyLjc1KSAqIHQgKyAwLjkzNzU7CiAgICAgIH0KCiAgICAgIHJldHVybiA3LjU2MjUgKiAodCAtPSAyLjYyNSAvIDIuNzUpICogdCArIDAuOTg0Mzc1OwogICAgfSwKICAgIGVhc2VJbk91dEJvdW5jZTogZnVuY3Rpb24gZWFzZUluT3V0Qm91bmNlKHQpIHsKICAgICAgaWYgKHQgPCAwLjUpIHsKICAgICAgICByZXR1cm4gZWZmZWN0cy5lYXNlSW5Cb3VuY2UodCAqIDIpICogMC41OwogICAgICB9CgogICAgICByZXR1cm4gZWZmZWN0cy5lYXNlT3V0Qm91bmNlKHQgKiAyIC0gMSkgKiAwLjUgKyAwLjU7CiAgICB9CiAgfTsKICB2YXIgaGVscGVyc19lYXNpbmcgPSB7CiAgICBlZmZlY3RzOiBlZmZlY3RzCiAgfTsgLy8gREVQUkVDQVRJT05TCgogIC8qKg0KICAgKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdXNlIENoYXJ0LmhlbHBlcnMuZWFzaW5nLmVmZmVjdHMgaW5zdGVhZC4NCiAgICogQGZ1bmN0aW9uIENoYXJ0LmhlbHBlcnMuZWFzaW5nRWZmZWN0cw0KICAgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNy4wDQogICAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMNCiAgICogQHByaXZhdGUNCiAgICovCgogIGhlbHBlcnNfY29yZS5lYXNpbmdFZmZlY3RzID0gZWZmZWN0czsKICB2YXIgUEkgPSBNYXRoLlBJOwogIHZhciBSQURfUEVSX0RFRyA9IFBJIC8gMTgwOwogIHZhciBET1VCTEVfUEkgPSBQSSAqIDI7CiAgdmFyIEhBTEZfUEkgPSBQSSAvIDI7CiAgdmFyIFFVQVJURVJfUEkgPSBQSSAvIDQ7CiAgdmFyIFRXT19USElSRFNfUEkgPSBQSSAqIDIgLyAzOwogIC8qKg0KICAgKiBAbmFtZXNwYWNlIENoYXJ0LmhlbHBlcnMuY2FudmFzDQogICAqLwoKICB2YXIgZXhwb3J0cyQxID0gewogICAgLyoqDQogICAgICogQ2xlYXJzIHRoZSBlbnRpcmUgY2FudmFzIGFzc29jaWF0ZWQgdG8gdGhlIGdpdmVuIGBjaGFydGAuDQogICAgICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSBUaGUgY2hhcnQgZm9yIHdoaWNoIHRvIGNsZWFyIHRoZSBjYW52YXMuDQogICAgICovCiAgICBjbGVhcjogZnVuY3Rpb24gY2xlYXIoY2hhcnQpIHsKICAgICAgY2hhcnQuY3R4LmNsZWFyUmVjdCgwLCAwLCBjaGFydC53aWR0aCwgY2hhcnQuaGVpZ2h0KTsKICAgIH0sCgogICAgLyoqDQogICAgICogQ3JlYXRlcyBhICJwYXRoIiBmb3IgYSByZWN0YW5nbGUgd2l0aCByb3VuZGVkIGNvcm5lcnMgYXQgcG9zaXRpb24gKHgsIHkpIHdpdGggYQ0KICAgICAqIGdpdmVuIHNpemUgKHdpZHRoLCBoZWlnaHQpIGFuZCB0aGUgc2FtZSBgcmFkaXVzYCBmb3IgYWxsIGNvcm5lcnMuDQogICAgICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGN0eCAtIFRoZSBjYW52YXMgMkQgQ29udGV4dC4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgcmVjdGFuZ2xlIHN0YXJ0aW5nIHBvaW50Lg0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSByZWN0YW5nbGUncyB3aWR0aC4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIHJlY3RhbmdsZSdzIGhlaWdodC4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gcmFkaXVzIC0gVGhlIHJvdW5kZWQgYW1vdW50IChpbiBwaXhlbHMpIGZvciB0aGUgZm91ciBjb3JuZXJzLg0KICAgICAqIEB0b2RvIGhhbmRsZSBgcmFkaXVzYCBhcyB0b3AtbGVmdCwgdG9wLXJpZ2h0LCBib3R0b20tcmlnaHQsIGJvdHRvbS1sZWZ0IGFycmF5L29iamVjdD8NCiAgICAgKi8KICAgIHJvdW5kZWRSZWN0OiBmdW5jdGlvbiByb3VuZGVkUmVjdChjdHgsIHgsIHksIHdpZHRoLCBoZWlnaHQsIHJhZGl1cykgewogICAgICBpZiAocmFkaXVzKSB7CiAgICAgICAgdmFyIHIgPSBNYXRoLm1pbihyYWRpdXMsIGhlaWdodCAvIDIsIHdpZHRoIC8gMik7CiAgICAgICAgdmFyIGxlZnQgPSB4ICsgcjsKICAgICAgICB2YXIgdG9wID0geSArIHI7CiAgICAgICAgdmFyIHJpZ2h0ID0geCArIHdpZHRoIC0gcjsKICAgICAgICB2YXIgYm90dG9tID0geSArIGhlaWdodCAtIHI7CiAgICAgICAgY3R4Lm1vdmVUbyh4LCB0b3ApOwoKICAgICAgICBpZiAobGVmdCA8IHJpZ2h0ICYmIHRvcCA8IGJvdHRvbSkgewogICAgICAgICAgY3R4LmFyYyhsZWZ0LCB0b3AsIHIsIC1QSSwgLUhBTEZfUEkpOwogICAgICAgICAgY3R4LmFyYyhyaWdodCwgdG9wLCByLCAtSEFMRl9QSSwgMCk7CiAgICAgICAgICBjdHguYXJjKHJpZ2h0LCBib3R0b20sIHIsIDAsIEhBTEZfUEkpOwogICAgICAgICAgY3R4LmFyYyhsZWZ0LCBib3R0b20sIHIsIEhBTEZfUEksIFBJKTsKICAgICAgICB9IGVsc2UgaWYgKGxlZnQgPCByaWdodCkgewogICAgICAgICAgY3R4Lm1vdmVUbyhsZWZ0LCB5KTsKICAgICAgICAgIGN0eC5hcmMocmlnaHQsIHRvcCwgciwgLUhBTEZfUEksIEhBTEZfUEkpOwogICAgICAgICAgY3R4LmFyYyhsZWZ0LCB0b3AsIHIsIEhBTEZfUEksIFBJICsgSEFMRl9QSSk7CiAgICAgICAgfSBlbHNlIGlmICh0b3AgPCBib3R0b20pIHsKICAgICAgICAgIGN0eC5hcmMobGVmdCwgdG9wLCByLCAtUEksIDApOwogICAgICAgICAgY3R4LmFyYyhsZWZ0LCBib3R0b20sIHIsIDAsIFBJKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3R4LmFyYyhsZWZ0LCB0b3AsIHIsIC1QSSwgUEkpOwogICAgICAgIH0KCiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgIGN0eC5tb3ZlVG8oeCwgeSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgY3R4LnJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7CiAgICAgIH0KICAgIH0sCiAgICBkcmF3UG9pbnQ6IGZ1bmN0aW9uIGRyYXdQb2ludChjdHgsIHN0eWxlLCByYWRpdXMsIHgsIHksIHJvdGF0aW9uKSB7CiAgICAgIHZhciB0eXBlLCB4T2Zmc2V0LCB5T2Zmc2V0LCBzaXplLCBjb3JuZXJSYWRpdXM7CiAgICAgIHZhciByYWQgPSAocm90YXRpb24gfHwgMCkgKiBSQURfUEVSX0RFRzsKCiAgICAgIGlmIChzdHlsZSAmJiBfdHlwZW9mKHN0eWxlKSA9PT0gJ29iamVjdCcpIHsKICAgICAgICB0eXBlID0gc3R5bGUudG9TdHJpbmcoKTsKCiAgICAgICAgaWYgKHR5cGUgPT09ICdbb2JqZWN0IEhUTUxJbWFnZUVsZW1lbnRdJyB8fCB0eXBlID09PSAnW29iamVjdCBIVE1MQ2FudmFzRWxlbWVudF0nKSB7CiAgICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgICAgY3R4LnRyYW5zbGF0ZSh4LCB5KTsKICAgICAgICAgIGN0eC5yb3RhdGUocmFkKTsKICAgICAgICAgIGN0eC5kcmF3SW1hZ2Uoc3R5bGUsIC1zdHlsZS53aWR0aCAvIDIsIC1zdHlsZS5oZWlnaHQgLyAyLCBzdHlsZS53aWR0aCwgc3R5bGUuaGVpZ2h0KTsKICAgICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNOYU4ocmFkaXVzKSB8fCByYWRpdXMgPD0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY3R4LmJlZ2luUGF0aCgpOwoKICAgICAgc3dpdGNoIChzdHlsZSkgewogICAgICAgIC8vIERlZmF1bHQgaW5jbHVkZXMgY2lyY2xlCiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgIGN0eC5hcmMoeCwgeSwgcmFkaXVzLCAwLCBET1VCTEVfUEkpOwogICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ3RyaWFuZ2xlJzoKICAgICAgICAgIGN0eC5tb3ZlVG8oeCArIE1hdGguc2luKHJhZCkgKiByYWRpdXMsIHkgLSBNYXRoLmNvcyhyYWQpICogcmFkaXVzKTsKICAgICAgICAgIHJhZCArPSBUV09fVEhJUkRTX1BJOwogICAgICAgICAgY3R4LmxpbmVUbyh4ICsgTWF0aC5zaW4ocmFkKSAqIHJhZGl1cywgeSAtIE1hdGguY29zKHJhZCkgKiByYWRpdXMpOwogICAgICAgICAgcmFkICs9IFRXT19USElSRFNfUEk7CiAgICAgICAgICBjdHgubGluZVRvKHggKyBNYXRoLnNpbihyYWQpICogcmFkaXVzLCB5IC0gTWF0aC5jb3MocmFkKSAqIHJhZGl1cyk7CiAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAncmVjdFJvdW5kZWQnOgogICAgICAgICAgLy8gTk9URTogdGhlIHJvdW5kZWQgcmVjdCBpbXBsZW1lbnRhdGlvbiBjaGFuZ2VkIHRvIHVzZSBgYXJjYCBpbnN0ZWFkIG9mCiAgICAgICAgICAvLyBgcXVhZHJhdGljQ3VydmVUb2Agc2luY2UgaXQgZ2VuZXJhdGVzIGJldHRlciByZXN1bHRzIHdoZW4gcmVjdCBpcwogICAgICAgICAgLy8gYWxtb3N0IGEgY2lyY2xlLiAwLjUxNiAoaW5zdGVhZCBvZiAwLjUpIHByb2R1Y2VzIHJlc3VsdHMgd2l0aCB2aXN1YWxseQogICAgICAgICAgLy8gY2xvc2VyIHByb3BvcnRpb24gdG8gdGhlIHByZXZpb3VzIGltcGwgYW5kIGl0IGlzIGluc2NyaWJlZCBpbiB0aGUKICAgICAgICAgIC8vIGNpcmNsZSB3aXRoIGByYWRpdXNgLiBGb3IgbW9yZSBkZXRhaWxzLCBzZWUgdGhlIGZvbGxvd2luZyBQUnM6CiAgICAgICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9pc3N1ZXMvNTU5NwogICAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzU4NTgKICAgICAgICAgIGNvcm5lclJhZGl1cyA9IHJhZGl1cyAqIDAuNTE2OwogICAgICAgICAgc2l6ZSA9IHJhZGl1cyAtIGNvcm5lclJhZGl1czsKICAgICAgICAgIHhPZmZzZXQgPSBNYXRoLmNvcyhyYWQgKyBRVUFSVEVSX1BJKSAqIHNpemU7CiAgICAgICAgICB5T2Zmc2V0ID0gTWF0aC5zaW4ocmFkICsgUVVBUlRFUl9QSSkgKiBzaXplOwogICAgICAgICAgY3R4LmFyYyh4IC0geE9mZnNldCwgeSAtIHlPZmZzZXQsIGNvcm5lclJhZGl1cywgcmFkIC0gUEksIHJhZCAtIEhBTEZfUEkpOwogICAgICAgICAgY3R4LmFyYyh4ICsgeU9mZnNldCwgeSAtIHhPZmZzZXQsIGNvcm5lclJhZGl1cywgcmFkIC0gSEFMRl9QSSwgcmFkKTsKICAgICAgICAgIGN0eC5hcmMoeCArIHhPZmZzZXQsIHkgKyB5T2Zmc2V0LCBjb3JuZXJSYWRpdXMsIHJhZCwgcmFkICsgSEFMRl9QSSk7CiAgICAgICAgICBjdHguYXJjKHggLSB5T2Zmc2V0LCB5ICsgeE9mZnNldCwgY29ybmVyUmFkaXVzLCByYWQgKyBIQUxGX1BJLCByYWQgKyBQSSk7CiAgICAgICAgICBjdHguY2xvc2VQYXRoKCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAncmVjdCc6CiAgICAgICAgICBpZiAoIXJvdGF0aW9uKSB7CiAgICAgICAgICAgIHNpemUgPSBNYXRoLlNRUlQxXzIgKiByYWRpdXM7CiAgICAgICAgICAgIGN0eC5yZWN0KHggLSBzaXplLCB5IC0gc2l6ZSwgMiAqIHNpemUsIDIgKiBzaXplKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CgogICAgICAgICAgcmFkICs9IFFVQVJURVJfUEk7CgogICAgICAgIC8qIGZhbGxzIHRocm91Z2ggKi8KCiAgICAgICAgY2FzZSAncmVjdFJvdCc6CiAgICAgICAgICB4T2Zmc2V0ID0gTWF0aC5jb3MocmFkKSAqIHJhZGl1czsKICAgICAgICAgIHlPZmZzZXQgPSBNYXRoLnNpbihyYWQpICogcmFkaXVzOwogICAgICAgICAgY3R4Lm1vdmVUbyh4IC0geE9mZnNldCwgeSAtIHlPZmZzZXQpOwogICAgICAgICAgY3R4LmxpbmVUbyh4ICsgeU9mZnNldCwgeSAtIHhPZmZzZXQpOwogICAgICAgICAgY3R4LmxpbmVUbyh4ICsgeE9mZnNldCwgeSArIHlPZmZzZXQpOwogICAgICAgICAgY3R4LmxpbmVUbyh4IC0geU9mZnNldCwgeSArIHhPZmZzZXQpOwogICAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ2Nyb3NzUm90JzoKICAgICAgICAgIHJhZCArPSBRVUFSVEVSX1BJOwoKICAgICAgICAvKiBmYWxscyB0aHJvdWdoICovCgogICAgICAgIGNhc2UgJ2Nyb3NzJzoKICAgICAgICAgIHhPZmZzZXQgPSBNYXRoLmNvcyhyYWQpICogcmFkaXVzOwogICAgICAgICAgeU9mZnNldCA9IE1hdGguc2luKHJhZCkgKiByYWRpdXM7CiAgICAgICAgICBjdHgubW92ZVRvKHggLSB4T2Zmc2V0LCB5IC0geU9mZnNldCk7CiAgICAgICAgICBjdHgubGluZVRvKHggKyB4T2Zmc2V0LCB5ICsgeU9mZnNldCk7CiAgICAgICAgICBjdHgubW92ZVRvKHggKyB5T2Zmc2V0LCB5IC0geE9mZnNldCk7CiAgICAgICAgICBjdHgubGluZVRvKHggLSB5T2Zmc2V0LCB5ICsgeE9mZnNldCk7CiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnc3Rhcic6CiAgICAgICAgICB4T2Zmc2V0ID0gTWF0aC5jb3MocmFkKSAqIHJhZGl1czsKICAgICAgICAgIHlPZmZzZXQgPSBNYXRoLnNpbihyYWQpICogcmFkaXVzOwogICAgICAgICAgY3R4Lm1vdmVUbyh4IC0geE9mZnNldCwgeSAtIHlPZmZzZXQpOwogICAgICAgICAgY3R4LmxpbmVUbyh4ICsgeE9mZnNldCwgeSArIHlPZmZzZXQpOwogICAgICAgICAgY3R4Lm1vdmVUbyh4ICsgeU9mZnNldCwgeSAtIHhPZmZzZXQpOwogICAgICAgICAgY3R4LmxpbmVUbyh4IC0geU9mZnNldCwgeSArIHhPZmZzZXQpOwogICAgICAgICAgcmFkICs9IFFVQVJURVJfUEk7CiAgICAgICAgICB4T2Zmc2V0ID0gTWF0aC5jb3MocmFkKSAqIHJhZGl1czsKICAgICAgICAgIHlPZmZzZXQgPSBNYXRoLnNpbihyYWQpICogcmFkaXVzOwogICAgICAgICAgY3R4Lm1vdmVUbyh4IC0geE9mZnNldCwgeSAtIHlPZmZzZXQpOwogICAgICAgICAgY3R4LmxpbmVUbyh4ICsgeE9mZnNldCwgeSArIHlPZmZzZXQpOwogICAgICAgICAgY3R4Lm1vdmVUbyh4ICsgeU9mZnNldCwgeSAtIHhPZmZzZXQpOwogICAgICAgICAgY3R4LmxpbmVUbyh4IC0geU9mZnNldCwgeSArIHhPZmZzZXQpOwogICAgICAgICAgYnJlYWs7CgogICAgICAgIGNhc2UgJ2xpbmUnOgogICAgICAgICAgeE9mZnNldCA9IE1hdGguY29zKHJhZCkgKiByYWRpdXM7CiAgICAgICAgICB5T2Zmc2V0ID0gTWF0aC5zaW4ocmFkKSAqIHJhZGl1czsKICAgICAgICAgIGN0eC5tb3ZlVG8oeCAtIHhPZmZzZXQsIHkgLSB5T2Zmc2V0KTsKICAgICAgICAgIGN0eC5saW5lVG8oeCArIHhPZmZzZXQsIHkgKyB5T2Zmc2V0KTsKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdkYXNoJzoKICAgICAgICAgIGN0eC5tb3ZlVG8oeCwgeSk7CiAgICAgICAgICBjdHgubGluZVRvKHggKyBNYXRoLmNvcyhyYWQpICogcmFkaXVzLCB5ICsgTWF0aC5zaW4ocmFkKSAqIHJhZGl1cyk7CiAgICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgY3R4LmZpbGwoKTsKICAgICAgY3R4LnN0cm9rZSgpOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHBvaW50IGlzIGluc2lkZSB0aGUgcmVjdGFuZ2xlDQogICAgICogQHBhcmFtIHtvYmplY3R9IHBvaW50IC0gVGhlIHBvaW50IHRvIHRlc3QNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gYXJlYSAtIFRoZSByZWN0YW5nbGUNCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2lzUG9pbnRJbkFyZWE6IGZ1bmN0aW9uIF9pc1BvaW50SW5BcmVhKHBvaW50LCBhcmVhKSB7CiAgICAgIHZhciBlcHNpbG9uID0gMWUtNjsgLy8gMWUtNiBpcyBtYXJnaW4gaW4gcGl4ZWxzIGZvciBhY2N1bXVsYXRlZCBlcnJvci4KCiAgICAgIHJldHVybiBwb2ludC54ID4gYXJlYS5sZWZ0IC0gZXBzaWxvbiAmJiBwb2ludC54IDwgYXJlYS5yaWdodCArIGVwc2lsb24gJiYgcG9pbnQueSA+IGFyZWEudG9wIC0gZXBzaWxvbiAmJiBwb2ludC55IDwgYXJlYS5ib3R0b20gKyBlcHNpbG9uOwogICAgfSwKICAgIGNsaXBBcmVhOiBmdW5jdGlvbiBjbGlwQXJlYShjdHgsIGFyZWEpIHsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICBjdHgucmVjdChhcmVhLmxlZnQsIGFyZWEudG9wLCBhcmVhLnJpZ2h0IC0gYXJlYS5sZWZ0LCBhcmVhLmJvdHRvbSAtIGFyZWEudG9wKTsKICAgICAgY3R4LmNsaXAoKTsKICAgIH0sCiAgICB1bmNsaXBBcmVhOiBmdW5jdGlvbiB1bmNsaXBBcmVhKGN0eCkgewogICAgICBjdHgucmVzdG9yZSgpOwogICAgfSwKICAgIGxpbmVUbzogZnVuY3Rpb24gbGluZVRvKGN0eCwgcHJldmlvdXMsIHRhcmdldCwgZmxpcCkgewogICAgICB2YXIgc3RlcHBlZCA9IHRhcmdldC5zdGVwcGVkTGluZTsKCiAgICAgIGlmIChzdGVwcGVkKSB7CiAgICAgICAgaWYgKHN0ZXBwZWQgPT09ICdtaWRkbGUnKSB7CiAgICAgICAgICB2YXIgbWlkcG9pbnQgPSAocHJldmlvdXMueCArIHRhcmdldC54KSAvIDIuMDsKICAgICAgICAgIGN0eC5saW5lVG8obWlkcG9pbnQsIGZsaXAgPyB0YXJnZXQueSA6IHByZXZpb3VzLnkpOwogICAgICAgICAgY3R4LmxpbmVUbyhtaWRwb2ludCwgZmxpcCA/IHByZXZpb3VzLnkgOiB0YXJnZXQueSk7CiAgICAgICAgfSBlbHNlIGlmIChzdGVwcGVkID09PSAnYWZ0ZXInICYmICFmbGlwIHx8IHN0ZXBwZWQgIT09ICdhZnRlcicgJiYgZmxpcCkgewogICAgICAgICAgY3R4LmxpbmVUbyhwcmV2aW91cy54LCB0YXJnZXQueSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN0eC5saW5lVG8odGFyZ2V0LngsIHByZXZpb3VzLnkpOwogICAgICAgIH0KCiAgICAgICAgY3R4LmxpbmVUbyh0YXJnZXQueCwgdGFyZ2V0LnkpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKCF0YXJnZXQudGVuc2lvbikgewogICAgICAgIGN0eC5saW5lVG8odGFyZ2V0LngsIHRhcmdldC55KTsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGN0eC5iZXppZXJDdXJ2ZVRvKGZsaXAgPyBwcmV2aW91cy5jb250cm9sUG9pbnRQcmV2aW91c1ggOiBwcmV2aW91cy5jb250cm9sUG9pbnROZXh0WCwgZmxpcCA/IHByZXZpb3VzLmNvbnRyb2xQb2ludFByZXZpb3VzWSA6IHByZXZpb3VzLmNvbnRyb2xQb2ludE5leHRZLCBmbGlwID8gdGFyZ2V0LmNvbnRyb2xQb2ludE5leHRYIDogdGFyZ2V0LmNvbnRyb2xQb2ludFByZXZpb3VzWCwgZmxpcCA/IHRhcmdldC5jb250cm9sUG9pbnROZXh0WSA6IHRhcmdldC5jb250cm9sUG9pbnRQcmV2aW91c1ksIHRhcmdldC54LCB0YXJnZXQueSk7CiAgICB9CiAgfTsKICB2YXIgaGVscGVyc19jYW52YXMgPSBleHBvcnRzJDE7IC8vIERFUFJFQ0FUSU9OUwoKICAvKioNCiAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIHVzZSBDaGFydC5oZWxwZXJzLmNhbnZhcy5jbGVhciBpbnN0ZWFkLg0KICAgKiBAbmFtZXNwYWNlIENoYXJ0LmhlbHBlcnMuY2xlYXINCiAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjcuMA0KICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAqIEBwcml2YXRlDQogICAqLwoKICBoZWxwZXJzX2NvcmUuY2xlYXIgPSBleHBvcnRzJDEuY2xlYXI7CiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQ2hhcnQuaGVscGVycy5jYW52YXMucm91bmRlZFJlY3QgaW5zdGVhZC4NCiAgICogQG5hbWVzcGFjZSBDaGFydC5oZWxwZXJzLmRyYXdSb3VuZGVkUmVjdGFuZ2xlDQogICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi43LjANCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCiAgaGVscGVyc19jb3JlLmRyYXdSb3VuZGVkUmVjdGFuZ2xlID0gZnVuY3Rpb24gKGN0eCkgewogICAgY3R4LmJlZ2luUGF0aCgpOwogICAgZXhwb3J0cyQxLnJvdW5kZWRSZWN0LmFwcGx5KGV4cG9ydHMkMSwgYXJndW1lbnRzKTsKICB9OwoKICB2YXIgZGVmYXVsdHMgPSB7CiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX3NldDogZnVuY3Rpb24gX3NldChzY29wZSwgdmFsdWVzKSB7CiAgICAgIHJldHVybiBoZWxwZXJzX2NvcmUubWVyZ2UodGhpc1tzY29wZV0gfHwgKHRoaXNbc2NvcGVdID0ge30pLCB2YWx1ZXMpOwogICAgfQogIH07IC8vIFRPRE8odjMpOiByZW1vdmUgJ2dsb2JhbCcgZnJvbSBuYW1lc3BhY2UuICBhbGwgZGVmYXVsdCBhcmUgZ2xvYmFsIGFuZAogIC8vIHRoZXJlJ3MgaW5jb25zaXN0ZW5jeSBhcm91bmQgd2hpY2ggb3B0aW9ucyBhcmUgdW5kZXIgJ2dsb2JhbCcKCiAgZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewogICAgZGVmYXVsdENvbG9yOiAncmdiYSgwLDAsMCwwLjEpJywKICAgIGRlZmF1bHRGb250Q29sb3I6ICcjNjY2JywKICAgIGRlZmF1bHRGb250RmFtaWx5OiAiJ0hlbHZldGljYSBOZXVlJywgJ0hlbHZldGljYScsICdBcmlhbCcsIHNhbnMtc2VyaWYiLAogICAgZGVmYXVsdEZvbnRTaXplOiAxMiwKICAgIGRlZmF1bHRGb250U3R5bGU6ICdub3JtYWwnLAogICAgZGVmYXVsdExpbmVIZWlnaHQ6IDEuMiwKICAgIHNob3dMaW5lczogdHJ1ZQogIH0pOwoKICB2YXIgY29yZV9kZWZhdWx0cyA9IGRlZmF1bHRzOwogIHZhciB2YWx1ZU9yRGVmYXVsdCA9IGhlbHBlcnNfY29yZS52YWx1ZU9yRGVmYXVsdDsKICAvKioNCiAgICogQ29udmVydHMgdGhlIGdpdmVuIGZvbnQgb2JqZWN0IGludG8gYSBDU1MgZm9udCBzdHJpbmcuDQogICAqIEBwYXJhbSB7b2JqZWN0fSBmb250IC0gQSBmb250IG9iamVjdC4NCiAgICogQHJldHVybiB7c3RyaW5nfSBUaGUgQ1NTIGZvbnQgc3RyaW5nLiBTZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQ1NTL2ZvbnQNCiAgICogQHByaXZhdGUNCiAgICovCgogIGZ1bmN0aW9uIHRvRm9udFN0cmluZyhmb250KSB7CiAgICBpZiAoIWZvbnQgfHwgaGVscGVyc19jb3JlLmlzTnVsbE9yVW5kZWYoZm9udC5zaXplKSB8fCBoZWxwZXJzX2NvcmUuaXNOdWxsT3JVbmRlZihmb250LmZhbWlseSkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgcmV0dXJuIChmb250LnN0eWxlID8gZm9udC5zdHlsZSArICcgJyA6ICcnKSArIChmb250LndlaWdodCA/IGZvbnQud2VpZ2h0ICsgJyAnIDogJycpICsgZm9udC5zaXplICsgJ3B4ICcgKyBmb250LmZhbWlseTsKICB9CiAgLyoqDQogICAqIEBhbGlhcyBDaGFydC5oZWxwZXJzLm9wdGlvbnMNCiAgICogQG5hbWVzcGFjZQ0KICAgKi8KCgogIHZhciBoZWxwZXJzX29wdGlvbnMgPSB7CiAgICAvKioNCiAgICAgKiBDb252ZXJ0cyB0aGUgZ2l2ZW4gbGluZSBoZWlnaHQgYHZhbHVlYCBpbiBwaXhlbHMgZm9yIGEgc3BlY2lmaWMgZm9udCBgc2l6ZWAuDQogICAgICogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSB2YWx1ZSAtIFRoZSBsaW5lSGVpZ2h0IHRvIHBhcnNlIChlZy4gMS42LCAnMTRweCcsICc3NSUnLCAnMS42ZW0nKS4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gc2l6ZSAtIFRoZSBmb250IHNpemUgKGluIHBpeGVscykgdXNlZCB0byByZXNvbHZlIHJlbGF0aXZlIGB2YWx1ZWAuDQogICAgICogQHJldHVybnMge251bWJlcn0gVGhlIGVmZmVjdGl2ZSBsaW5lIGhlaWdodCBpbiBwaXhlbHMgKHNpemUgKiAxLjIgaWYgdmFsdWUgaXMgaW52YWxpZCkuDQogICAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9DU1MvbGluZS1oZWlnaHQNCiAgICAgKiBAc2luY2UgMi43LjANCiAgICAgKi8KICAgIHRvTGluZUhlaWdodDogZnVuY3Rpb24gdG9MaW5lSGVpZ2h0KHZhbHVlLCBzaXplKSB7CiAgICAgIHZhciBtYXRjaGVzID0gKCcnICsgdmFsdWUpLm1hdGNoKC9eKG5vcm1hbHwoXGQrKD86XC5cZCspPykocHh8ZW18JSk/KSQvKTsKCiAgICAgIGlmICghbWF0Y2hlcyB8fCBtYXRjaGVzWzFdID09PSAnbm9ybWFsJykgewogICAgICAgIHJldHVybiBzaXplICogMS4yOwogICAgICB9CgogICAgICB2YWx1ZSA9ICttYXRjaGVzWzJdOwoKICAgICAgc3dpdGNoIChtYXRjaGVzWzNdKSB7CiAgICAgICAgY2FzZSAncHgnOgogICAgICAgICAgcmV0dXJuIHZhbHVlOwoKICAgICAgICBjYXNlICclJzoKICAgICAgICAgIHZhbHVlIC89IDEwMDsKICAgICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICByZXR1cm4gc2l6ZSAqIHZhbHVlOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBDb252ZXJ0cyB0aGUgZ2l2ZW4gdmFsdWUgaW50byBhIHBhZGRpbmcgb2JqZWN0IHdpdGggcHJlLWNvbXB1dGVkIHdpZHRoL2hlaWdodC4NCiAgICAgKiBAcGFyYW0ge251bWJlcnxvYmplY3R9IHZhbHVlIC0gSWYgYSBudW1iZXIsIHNldCB0aGUgdmFsdWUgdG8gYWxsIFRSQkwgY29tcG9uZW50LA0KICAgICAqICBlbHNlLCBpZiBhbmQgb2JqZWN0LCB1c2UgZGVmaW5lZCBwcm9wZXJ0aWVzIGFuZCBzZXRzIHVuZGVmaW5lZCBvbmVzIHRvIDAuDQogICAgICogQHJldHVybnMge29iamVjdH0gVGhlIHBhZGRpbmcgdmFsdWVzICh0b3AsIHJpZ2h0LCBib3R0b20sIGxlZnQsIHdpZHRoLCBoZWlnaHQpDQogICAgICogQHNpbmNlIDIuNy4wDQogICAgICovCiAgICB0b1BhZGRpbmc6IGZ1bmN0aW9uIHRvUGFkZGluZyh2YWx1ZSkgewogICAgICB2YXIgdCwgciwgYiwgbDsKCiAgICAgIGlmIChoZWxwZXJzX2NvcmUuaXNPYmplY3QodmFsdWUpKSB7CiAgICAgICAgdCA9ICt2YWx1ZS50b3AgfHwgMDsKICAgICAgICByID0gK3ZhbHVlLnJpZ2h0IHx8IDA7CiAgICAgICAgYiA9ICt2YWx1ZS5ib3R0b20gfHwgMDsKICAgICAgICBsID0gK3ZhbHVlLmxlZnQgfHwgMDsKICAgICAgfSBlbHNlIHsKICAgICAgICB0ID0gciA9IGIgPSBsID0gK3ZhbHVlIHx8IDA7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgdG9wOiB0LAogICAgICAgIHJpZ2h0OiByLAogICAgICAgIGJvdHRvbTogYiwKICAgICAgICBsZWZ0OiBsLAogICAgICAgIGhlaWdodDogdCArIGIsCiAgICAgICAgd2lkdGg6IGwgKyByCiAgICAgIH07CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFBhcnNlcyBmb250IG9wdGlvbnMgYW5kIHJldHVybnMgdGhlIGZvbnQgb2JqZWN0Lg0KICAgICAqIEBwYXJhbSB7b2JqZWN0fSBvcHRpb25zIC0gQSBvYmplY3QgdGhhdCBjb250YWlucyBmb250IG9wdGlvbnMgdG8gYmUgcGFyc2VkLg0KICAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIGZvbnQgb2JqZWN0Lg0KICAgICAqIEB0b2RvIFN1cHBvcnQgZm9udC4qIG9wdGlvbnMgYW5kIHJlbmFtZWQgdG8gdG9Gb250KCkuDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9wYXJzZUZvbnQ6IGZ1bmN0aW9uIF9wYXJzZUZvbnQob3B0aW9ucykgewogICAgICB2YXIgZ2xvYmFsRGVmYXVsdHMgPSBjb3JlX2RlZmF1bHRzLmdsb2JhbDsKICAgICAgdmFyIHNpemUgPSB2YWx1ZU9yRGVmYXVsdChvcHRpb25zLmZvbnRTaXplLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFNpemUpOwogICAgICB2YXIgZm9udCA9IHsKICAgICAgICBmYW1pbHk6IHZhbHVlT3JEZWZhdWx0KG9wdGlvbnMuZm9udEZhbWlseSwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRGYW1pbHkpLAogICAgICAgIGxpbmVIZWlnaHQ6IGhlbHBlcnNfY29yZS5vcHRpb25zLnRvTGluZUhlaWdodCh2YWx1ZU9yRGVmYXVsdChvcHRpb25zLmxpbmVIZWlnaHQsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRMaW5lSGVpZ2h0KSwgc2l6ZSksCiAgICAgICAgc2l6ZTogc2l6ZSwKICAgICAgICBzdHlsZTogdmFsdWVPckRlZmF1bHQob3B0aW9ucy5mb250U3R5bGUsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250U3R5bGUpLAogICAgICAgIHdlaWdodDogbnVsbCwKICAgICAgICBzdHJpbmc6ICcnCiAgICAgIH07CiAgICAgIGZvbnQuc3RyaW5nID0gdG9Gb250U3RyaW5nKGZvbnQpOwogICAgICByZXR1cm4gZm9udDsKICAgIH0sCgogICAgLyoqDQogICAgICogRXZhbHVhdGVzIHRoZSBnaXZlbiBgaW5wdXRzYCBzZXF1ZW50aWFsbHkgYW5kIHJldHVybnMgdGhlIGZpcnN0IGRlZmluZWQgdmFsdWUuDQogICAgICogQHBhcmFtIHtBcnJheX0gaW5wdXRzIC0gQW4gYXJyYXkgb2YgdmFsdWVzLCBmYWxsaW5nIGJhY2sgdG8gdGhlIGxhc3QgdmFsdWUuDQogICAgICogQHBhcmFtIHtvYmplY3R9IFtjb250ZXh0XSAtIElmIGRlZmluZWQgYW5kIHRoZSBjdXJyZW50IHZhbHVlIGlzIGEgZnVuY3Rpb24sIHRoZSB2YWx1ZQ0KICAgICAqIGlzIGNhbGxlZCB3aXRoIGBjb250ZXh0YCBhcyBmaXJzdCBhcmd1bWVudCBhbmQgdGhlIHJlc3VsdCBiZWNvbWVzIHRoZSBuZXcgaW5wdXQuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IFtpbmRleF0gLSBJZiBkZWZpbmVkIGFuZCB0aGUgY3VycmVudCB2YWx1ZSBpcyBhbiBhcnJheSwgdGhlIHZhbHVlDQogICAgICogYXQgYGluZGV4YCBiZWNvbWUgdGhlIG5ldyBpbnB1dC4NCiAgICAgKiBAcGFyYW0ge29iamVjdH0gW2luZm9dIC0gb2JqZWN0IHRvIHJldHVybiBpbmZvcm1hdGlvbiBhYm91dCByZXNvbHV0aW9uIGluDQogICAgICogQHBhcmFtIHtib29sZWFufSBbaW5mby5jYWNoZWFibGVdIC0gV2lsbCBiZSBzZXQgdG8gYGZhbHNlYCBpZiBvcHRpb24gaXMgbm90IGNhY2hlYWJsZS4NCiAgICAgKiBAc2luY2UgMi43LjANCiAgICAgKi8KICAgIHJlc29sdmU6IGZ1bmN0aW9uIHJlc29sdmUoaW5wdXRzLCBjb250ZXh0LCBpbmRleCwgaW5mbykgewogICAgICB2YXIgY2FjaGVhYmxlID0gdHJ1ZTsKICAgICAgdmFyIGksIGlsZW4sIHZhbHVlOwoKICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGlucHV0cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICB2YWx1ZSA9IGlucHV0c1tpXTsKCiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbnRleHQgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIHZhbHVlID0gdmFsdWUoY29udGV4dCk7CiAgICAgICAgICBjYWNoZWFibGUgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmIChpbmRleCAhPT0gdW5kZWZpbmVkICYmIGhlbHBlcnNfY29yZS5pc0FycmF5KHZhbHVlKSkgewogICAgICAgICAgdmFsdWUgPSB2YWx1ZVtpbmRleF07CiAgICAgICAgICBjYWNoZWFibGUgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBpZiAoaW5mbyAmJiAhY2FjaGVhYmxlKSB7CiAgICAgICAgICAgIGluZm8uY2FjaGVhYmxlID0gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CiAgLyoqDQogICAqIEBhbGlhcyBDaGFydC5oZWxwZXJzLm1hdGgNCiAgICogQG5hbWVzcGFjZQ0KICAgKi8KCiAgdmFyIGV4cG9ydHMkMiA9IHsKICAgIC8qKg0KICAgICAqIFJldHVybnMgYW4gYXJyYXkgb2YgZmFjdG9ycyBzb3J0ZWQgZnJvbSAxIHRvIHNxcnQodmFsdWUpDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9mYWN0b3JpemU6IGZ1bmN0aW9uIF9mYWN0b3JpemUodmFsdWUpIHsKICAgICAgdmFyIHJlc3VsdCA9IFtdOwogICAgICB2YXIgc3FydCA9IE1hdGguc3FydCh2YWx1ZSk7CiAgICAgIHZhciBpOwoKICAgICAgZm9yIChpID0gMTsgaSA8IHNxcnQ7IGkrKykgewogICAgICAgIGlmICh2YWx1ZSAlIGkgPT09IDApIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKGkpOwogICAgICAgICAgcmVzdWx0LnB1c2godmFsdWUgLyBpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChzcXJ0ID09PSAoc3FydCB8IDApKSB7CiAgICAgICAgLy8gaWYgdmFsdWUgaXMgYSBzcXVhcmUgbnVtYmVyCiAgICAgICAgcmVzdWx0LnB1c2goc3FydCk7CiAgICAgIH0KCiAgICAgIHJlc3VsdC5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGEgLSBiOwogICAgICB9KS5wb3AoKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH0sCiAgICBsb2cxMDogTWF0aC5sb2cxMCB8fCBmdW5jdGlvbiAoeCkgewogICAgICB2YXIgZXhwb25lbnQgPSBNYXRoLmxvZyh4KSAqIE1hdGguTE9HMTBFOyAvLyBNYXRoLkxPRzEwRSA9IDEgLyBNYXRoLkxOMTAuCiAgICAgIC8vIENoZWNrIGZvciB3aG9sZSBwb3dlcnMgb2YgMTAsCiAgICAgIC8vIHdoaWNoIGR1ZSB0byBmbG9hdGluZyBwb2ludCByb3VuZGluZyBlcnJvciBzaG91bGQgYmUgY29ycmVjdGVkLgoKICAgICAgdmFyIHBvd2VyT2YxMCA9IE1hdGgucm91bmQoZXhwb25lbnQpOwogICAgICB2YXIgaXNQb3dlck9mMTAgPSB4ID09PSBNYXRoLnBvdygxMCwgcG93ZXJPZjEwKTsKICAgICAgcmV0dXJuIGlzUG93ZXJPZjEwID8gcG93ZXJPZjEwIDogZXhwb25lbnQ7CiAgICB9CiAgfTsKICB2YXIgaGVscGVyc19tYXRoID0gZXhwb3J0cyQyOyAvLyBERVBSRUNBVElPTlMKCiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQ2hhcnQuaGVscGVycy5tYXRoLmxvZzEwIGluc3RlYWQuDQogICAqIEBuYW1lc3BhY2UgQ2hhcnQuaGVscGVycy5sb2cxMA0KICAgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuOS4wDQogICAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMNCiAgICogQHByaXZhdGUNCiAgICovCgogIGhlbHBlcnNfY29yZS5sb2cxMCA9IGV4cG9ydHMkMi5sb2cxMDsKCiAgdmFyIGdldFJ0bEFkYXB0ZXIgPSBmdW5jdGlvbiBnZXRSdGxBZGFwdGVyKHJlY3RYLCB3aWR0aCkgewogICAgcmV0dXJuIHsKICAgICAgeDogZnVuY3Rpb24geChfeDIpIHsKICAgICAgICByZXR1cm4gcmVjdFggKyByZWN0WCArIHdpZHRoIC0gX3gyOwogICAgICB9LAogICAgICBzZXRXaWR0aDogZnVuY3Rpb24gc2V0V2lkdGgodykgewogICAgICAgIHdpZHRoID0gdzsKICAgICAgfSwKICAgICAgdGV4dEFsaWduOiBmdW5jdGlvbiB0ZXh0QWxpZ24oYWxpZ24pIHsKICAgICAgICBpZiAoYWxpZ24gPT09ICdjZW50ZXInKSB7CiAgICAgICAgICByZXR1cm4gYWxpZ247CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYWxpZ24gPT09ICdyaWdodCcgPyAnbGVmdCcgOiAncmlnaHQnOwogICAgICB9LAogICAgICB4UGx1czogZnVuY3Rpb24geFBsdXMoeCwgdmFsdWUpIHsKICAgICAgICByZXR1cm4geCAtIHZhbHVlOwogICAgICB9LAogICAgICBsZWZ0Rm9yTHRyOiBmdW5jdGlvbiBsZWZ0Rm9yTHRyKHgsIGl0ZW1XaWR0aCkgewogICAgICAgIHJldHVybiB4IC0gaXRlbVdpZHRoOwogICAgICB9CiAgICB9OwogIH07CgogIHZhciBnZXRMdHJBZGFwdGVyID0gZnVuY3Rpb24gZ2V0THRyQWRhcHRlcigpIHsKICAgIHJldHVybiB7CiAgICAgIHg6IGZ1bmN0aW9uIHgoX3gzKSB7CiAgICAgICAgcmV0dXJuIF94MzsKICAgICAgfSwKICAgICAgc2V0V2lkdGg6IGZ1bmN0aW9uIHNldFdpZHRoKHcpIHsvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzCiAgICAgIH0sCiAgICAgIHRleHRBbGlnbjogZnVuY3Rpb24gdGV4dEFsaWduKGFsaWduKSB7CiAgICAgICAgcmV0dXJuIGFsaWduOwogICAgICB9LAogICAgICB4UGx1czogZnVuY3Rpb24geFBsdXMoeCwgdmFsdWUpIHsKICAgICAgICByZXR1cm4geCArIHZhbHVlOwogICAgICB9LAogICAgICBsZWZ0Rm9yTHRyOiBmdW5jdGlvbiBsZWZ0Rm9yTHRyKHgsIF9pdGVtV2lkdGgpIHsKICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVudXNlZC12YXJzCiAgICAgICAgcmV0dXJuIHg7CiAgICAgIH0KICAgIH07CiAgfTsKCiAgdmFyIGdldEFkYXB0ZXIgPSBmdW5jdGlvbiBnZXRBZGFwdGVyKHJ0bCwgcmVjdFgsIHdpZHRoKSB7CiAgICByZXR1cm4gcnRsID8gZ2V0UnRsQWRhcHRlcihyZWN0WCwgd2lkdGgpIDogZ2V0THRyQWRhcHRlcigpOwogIH07CgogIHZhciBvdmVycmlkZVRleHREaXJlY3Rpb24gPSBmdW5jdGlvbiBvdmVycmlkZVRleHREaXJlY3Rpb24oY3R4LCBkaXJlY3Rpb24pIHsKICAgIHZhciBzdHlsZSwgb3JpZ2luYWw7CgogICAgaWYgKGRpcmVjdGlvbiA9PT0gJ2x0cicgfHwgZGlyZWN0aW9uID09PSAncnRsJykgewogICAgICBzdHlsZSA9IGN0eC5jYW52YXMuc3R5bGU7CiAgICAgIG9yaWdpbmFsID0gW3N0eWxlLmdldFByb3BlcnR5VmFsdWUoJ2RpcmVjdGlvbicpLCBzdHlsZS5nZXRQcm9wZXJ0eVByaW9yaXR5KCdkaXJlY3Rpb24nKV07CiAgICAgIHN0eWxlLnNldFByb3BlcnR5KCdkaXJlY3Rpb24nLCBkaXJlY3Rpb24sICdpbXBvcnRhbnQnKTsKICAgICAgY3R4LnByZXZUZXh0RGlyZWN0aW9uID0gb3JpZ2luYWw7CiAgICB9CiAgfTsKCiAgdmFyIHJlc3RvcmVUZXh0RGlyZWN0aW9uID0gZnVuY3Rpb24gcmVzdG9yZVRleHREaXJlY3Rpb24oY3R4KSB7CiAgICB2YXIgb3JpZ2luYWwgPSBjdHgucHJldlRleHREaXJlY3Rpb247CgogICAgaWYgKG9yaWdpbmFsICE9PSB1bmRlZmluZWQpIHsKICAgICAgZGVsZXRlIGN0eC5wcmV2VGV4dERpcmVjdGlvbjsKICAgICAgY3R4LmNhbnZhcy5zdHlsZS5zZXRQcm9wZXJ0eSgnZGlyZWN0aW9uJywgb3JpZ2luYWxbMF0sIG9yaWdpbmFsWzFdKTsKICAgIH0KICB9OwoKICB2YXIgaGVscGVyc19ydGwgPSB7CiAgICBnZXRSdGxBZGFwdGVyOiBnZXRBZGFwdGVyLAogICAgb3ZlcnJpZGVUZXh0RGlyZWN0aW9uOiBvdmVycmlkZVRleHREaXJlY3Rpb24sCiAgICByZXN0b3JlVGV4dERpcmVjdGlvbjogcmVzdG9yZVRleHREaXJlY3Rpb24KICB9OwogIHZhciBoZWxwZXJzJDEgPSBoZWxwZXJzX2NvcmU7CiAgdmFyIGVhc2luZyA9IGhlbHBlcnNfZWFzaW5nOwogIHZhciBjYW52YXMgPSBoZWxwZXJzX2NhbnZhczsKICB2YXIgb3B0aW9ucyA9IGhlbHBlcnNfb3B0aW9uczsKICB2YXIgbWF0aCA9IGhlbHBlcnNfbWF0aDsKICB2YXIgcnRsID0gaGVscGVyc19ydGw7CiAgaGVscGVycyQxLmVhc2luZyA9IGVhc2luZzsKICBoZWxwZXJzJDEuY2FudmFzID0gY2FudmFzOwogIGhlbHBlcnMkMS5vcHRpb25zID0gb3B0aW9uczsKICBoZWxwZXJzJDEubWF0aCA9IG1hdGg7CiAgaGVscGVycyQxLnJ0bCA9IHJ0bDsKCiAgZnVuY3Rpb24gaW50ZXJwb2xhdGUoc3RhcnQsIHZpZXcsIG1vZGVsLCBlYXNlKSB7CiAgICB2YXIga2V5cyA9IE9iamVjdC5rZXlzKG1vZGVsKTsKICAgIHZhciBpLCBpbGVuLCBrZXksIGFjdHVhbCwgb3JpZ2luLCB0YXJnZXQsIHR5cGUsIGMwLCBjMTsKCiAgICBmb3IgKGkgPSAwLCBpbGVuID0ga2V5cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAga2V5ID0ga2V5c1tpXTsKICAgICAgdGFyZ2V0ID0gbW9kZWxba2V5XTsgLy8gaWYgYSB2YWx1ZSBpcyBhZGRlZCB0byB0aGUgbW9kZWwgYWZ0ZXIgcGl2b3QoKSBoYXMgYmVlbiBjYWxsZWQsIHRoZSB2aWV3CiAgICAgIC8vIGRvZXNuJ3QgY29udGFpbiBpdCwgc28gbGV0J3MgaW5pdGlhbGl6ZSB0aGUgdmlldyB0byB0aGUgdGFyZ2V0IHZhbHVlLgoKICAgICAgaWYgKCF2aWV3Lmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICB2aWV3W2tleV0gPSB0YXJnZXQ7CiAgICAgIH0KCiAgICAgIGFjdHVhbCA9IHZpZXdba2V5XTsKCiAgICAgIGlmIChhY3R1YWwgPT09IHRhcmdldCB8fCBrZXlbMF0gPT09ICdfJykgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICBpZiAoIXN0YXJ0Lmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICBzdGFydFtrZXldID0gYWN0dWFsOwogICAgICB9CgogICAgICBvcmlnaW4gPSBzdGFydFtrZXldOwogICAgICB0eXBlID0gX3R5cGVvZih0YXJnZXQpOwoKICAgICAgaWYgKHR5cGUgPT09IF90eXBlb2Yob3JpZ2luKSkgewogICAgICAgIGlmICh0eXBlID09PSAnc3RyaW5nJykgewogICAgICAgICAgYzAgPSBjaGFydGpzQ29sb3Iob3JpZ2luKTsKCiAgICAgICAgICBpZiAoYzAudmFsaWQpIHsKICAgICAgICAgICAgYzEgPSBjaGFydGpzQ29sb3IodGFyZ2V0KTsKCiAgICAgICAgICAgIGlmIChjMS52YWxpZCkgewogICAgICAgICAgICAgIHZpZXdba2V5XSA9IGMxLm1peChjMCwgZWFzZSkucmdiU3RyaW5nKCk7CiAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKGhlbHBlcnMkMS5pc0Zpbml0ZShvcmlnaW4pICYmIGhlbHBlcnMkMS5pc0Zpbml0ZSh0YXJnZXQpKSB7CiAgICAgICAgICB2aWV3W2tleV0gPSBvcmlnaW4gKyAodGFyZ2V0IC0gb3JpZ2luKSAqIGVhc2U7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHZpZXdba2V5XSA9IHRhcmdldDsKICAgIH0KICB9CgogIHZhciBFbGVtZW50ID0gZnVuY3Rpb24gRWxlbWVudChjb25maWd1cmF0aW9uKSB7CiAgICBoZWxwZXJzJDEuZXh0ZW5kKHRoaXMsIGNvbmZpZ3VyYXRpb24pOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgaGVscGVycyQxLmV4dGVuZChFbGVtZW50LnByb3RvdHlwZSwgewogICAgX3R5cGU6IHVuZGVmaW5lZCwKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgIHRoaXMuaGlkZGVuID0gZmFsc2U7CiAgICB9LAogICAgcGl2b3Q6IGZ1bmN0aW9uIHBpdm90KCkgewogICAgICB2YXIgbWUgPSB0aGlzOwoKICAgICAgaWYgKCFtZS5fdmlldykgewogICAgICAgIG1lLl92aWV3ID0gaGVscGVycyQxLmV4dGVuZCh7fSwgbWUuX21vZGVsKTsKICAgICAgfQoKICAgICAgbWUuX3N0YXJ0ID0ge307CiAgICAgIHJldHVybiBtZTsKICAgIH0sCiAgICB0cmFuc2l0aW9uOiBmdW5jdGlvbiB0cmFuc2l0aW9uKGVhc2UpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG1vZGVsID0gbWUuX21vZGVsOwogICAgICB2YXIgc3RhcnQgPSBtZS5fc3RhcnQ7CiAgICAgIHZhciB2aWV3ID0gbWUuX3ZpZXc7IC8vIE5vIGFuaW1hdGlvbiAtPiBObyBUcmFuc2l0aW9uCgogICAgICBpZiAoIW1vZGVsIHx8IGVhc2UgPT09IDEpIHsKICAgICAgICBtZS5fdmlldyA9IGhlbHBlcnMkMS5leHRlbmQoe30sIG1vZGVsKTsKICAgICAgICBtZS5fc3RhcnQgPSBudWxsOwogICAgICAgIHJldHVybiBtZTsKICAgICAgfQoKICAgICAgaWYgKCF2aWV3KSB7CiAgICAgICAgdmlldyA9IG1lLl92aWV3ID0ge307CiAgICAgIH0KCiAgICAgIGlmICghc3RhcnQpIHsKICAgICAgICBzdGFydCA9IG1lLl9zdGFydCA9IHt9OwogICAgICB9CgogICAgICBpbnRlcnBvbGF0ZShzdGFydCwgdmlldywgbW9kZWwsIGVhc2UpOwogICAgICByZXR1cm4gbWU7CiAgICB9LAogICAgdG9vbHRpcFBvc2l0aW9uOiBmdW5jdGlvbiB0b29sdGlwUG9zaXRpb24oKSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogdGhpcy5fbW9kZWwueCwKICAgICAgICB5OiB0aGlzLl9tb2RlbC55CiAgICAgIH07CiAgICB9LAogICAgaGFzVmFsdWU6IGZ1bmN0aW9uIGhhc1ZhbHVlKCkgewogICAgICByZXR1cm4gaGVscGVycyQxLmlzTnVtYmVyKHRoaXMuX21vZGVsLngpICYmIGhlbHBlcnMkMS5pc051bWJlcih0aGlzLl9tb2RlbC55KTsKICAgIH0KICB9KTsKICBFbGVtZW50LmV4dGVuZCA9IGhlbHBlcnMkMS5pbmhlcml0czsKICB2YXIgY29yZV9lbGVtZW50ID0gRWxlbWVudDsKICB2YXIgZXhwb3J0cyQzID0gY29yZV9lbGVtZW50LmV4dGVuZCh7CiAgICBjaGFydDogbnVsbCwKICAgIC8vIHRoZSBhbmltYXRpb24gYXNzb2NpYXRlZCBjaGFydCBpbnN0YW5jZQogICAgY3VycmVudFN0ZXA6IDAsCiAgICAvLyB0aGUgY3VycmVudCBhbmltYXRpb24gc3RlcAogICAgbnVtU3RlcHM6IDYwLAogICAgLy8gZGVmYXVsdCBudW1iZXIgb2Ygc3RlcHMKICAgIGVhc2luZzogJycsCiAgICAvLyB0aGUgZWFzaW5nIHRvIHVzZSBmb3IgdGhpcyBhbmltYXRpb24KICAgIHJlbmRlcjogbnVsbCwKICAgIC8vIHJlbmRlciBmdW5jdGlvbiB1c2VkIGJ5IHRoZSBhbmltYXRpb24gc2VydmljZQogICAgb25BbmltYXRpb25Qcm9ncmVzczogbnVsbCwKICAgIC8vIHVzZXIgc3BlY2lmaWVkIGNhbGxiYWNrIHRvIGZpcmUgb24gZWFjaCBzdGVwIG9mIHRoZSBhbmltYXRpb24KICAgIG9uQW5pbWF0aW9uQ29tcGxldGU6IG51bGwgLy8gdXNlciBzcGVjaWZpZWQgY2FsbGJhY2sgdG8gZmlyZSB3aGVuIHRoZSBhbmltYXRpb24gZmluaXNoZXMKCiAgfSk7CiAgdmFyIGNvcmVfYW5pbWF0aW9uID0gZXhwb3J0cyQzOyAvLyBERVBSRUNBVElPTlMKCiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQ2hhcnQuQW5pbWF0aW9uIGluc3RlYWQNCiAgICogQHByb3AgQ2hhcnQuQW5pbWF0aW9uI2FuaW1hdGlvbk9iamVjdA0KICAgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNi4wDQogICAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMNCiAgICovCgogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzJDMucHJvdG90eXBlLCAnYW5pbWF0aW9uT2JqZWN0JywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogIH0pOwogIC8qKg0KICAgKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdXNlIENoYXJ0LkFuaW1hdGlvbiNjaGFydCBpbnN0ZWFkDQogICAqIEBwcm9wIENoYXJ0LkFuaW1hdGlvbiNjaGFydEluc3RhbmNlDQogICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi42LjANCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKi8KCiAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMkMy5wcm90b3R5cGUsICdjaGFydEluc3RhbmNlJywgewogICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7CiAgICAgIHJldHVybiB0aGlzLmNoYXJ0OwogICAgfSwKICAgIHNldDogZnVuY3Rpb24gc2V0KHZhbHVlKSB7CiAgICAgIHRoaXMuY2hhcnQgPSB2YWx1ZTsKICAgIH0KICB9KTsKCiAgY29yZV9kZWZhdWx0cy5fc2V0KCdnbG9iYWwnLCB7CiAgICBhbmltYXRpb246IHsKICAgICAgZHVyYXRpb246IDEwMDAsCiAgICAgIGVhc2luZzogJ2Vhc2VPdXRRdWFydCcsCiAgICAgIG9uUHJvZ3Jlc3M6IGhlbHBlcnMkMS5ub29wLAogICAgICBvbkNvbXBsZXRlOiBoZWxwZXJzJDEubm9vcAogICAgfQogIH0pOwoKICB2YXIgY29yZV9hbmltYXRpb25zID0gewogICAgYW5pbWF0aW9uczogW10sCiAgICByZXF1ZXN0OiBudWxsLAoKICAgIC8qKg0KICAgICAqIEBwYXJhbSB7Q2hhcnR9IGNoYXJ0IC0gVGhlIGNoYXJ0IHRvIGFuaW1hdGUuDQogICAgICogQHBhcmFtIHtDaGFydC5BbmltYXRpb259IGFuaW1hdGlvbiAtIFRoZSBhbmltYXRpb24gdGhhdCB3ZSB3aWxsIGFuaW1hdGUuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IGR1cmF0aW9uIC0gVGhlIGFuaW1hdGlvbiBkdXJhdGlvbiBpbiBtcy4NCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGxhenkgLSBpZiB0cnVlLCB0aGUgY2hhcnQgaXMgbm90IG1hcmtlZCBhcyBhbmltYXRpbmcgdG8gZW5hYmxlIG1vcmUgcmVzcG9uc2l2ZSBpbnRlcmFjdGlvbnMNCiAgICAgKi8KICAgIGFkZEFuaW1hdGlvbjogZnVuY3Rpb24gYWRkQW5pbWF0aW9uKGNoYXJ0LCBhbmltYXRpb24sIGR1cmF0aW9uLCBsYXp5KSB7CiAgICAgIHZhciBhbmltYXRpb25zID0gdGhpcy5hbmltYXRpb25zOwogICAgICB2YXIgaSwgaWxlbjsKICAgICAgYW5pbWF0aW9uLmNoYXJ0ID0gY2hhcnQ7CiAgICAgIGFuaW1hdGlvbi5zdGFydFRpbWUgPSBEYXRlLm5vdygpOwogICAgICBhbmltYXRpb24uZHVyYXRpb24gPSBkdXJhdGlvbjsKCiAgICAgIGlmICghbGF6eSkgewogICAgICAgIGNoYXJ0LmFuaW1hdGluZyA9IHRydWU7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBhbmltYXRpb25zLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewogICAgICAgIGlmIChhbmltYXRpb25zW2ldLmNoYXJ0ID09PSBjaGFydCkgewogICAgICAgICAgYW5pbWF0aW9uc1tpXSA9IGFuaW1hdGlvbjsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGFuaW1hdGlvbnMucHVzaChhbmltYXRpb24pOyAvLyBJZiB0aGVyZSBhcmUgbm8gYW5pbWF0aW9ucyBxdWV1ZWQsIG1hbnVhbGx5IGtpY2tzdGFydCBhIGRpZ2VzdCwgZm9yIGxhY2sgb2YgYSBiZXR0ZXIgd29yZAoKICAgICAgaWYgKGFuaW1hdGlvbnMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKTsKICAgICAgfQogICAgfSwKICAgIGNhbmNlbEFuaW1hdGlvbjogZnVuY3Rpb24gY2FuY2VsQW5pbWF0aW9uKGNoYXJ0KSB7CiAgICAgIHZhciBpbmRleCA9IGhlbHBlcnMkMS5maW5kSW5kZXgodGhpcy5hbmltYXRpb25zLCBmdW5jdGlvbiAoYW5pbWF0aW9uKSB7CiAgICAgICAgcmV0dXJuIGFuaW1hdGlvbi5jaGFydCA9PT0gY2hhcnQ7CiAgICAgIH0pOwoKICAgICAgaWYgKGluZGV4ICE9PSAtMSkgewogICAgICAgIHRoaXMuYW5pbWF0aW9ucy5zcGxpY2UoaW5kZXgsIDEpOwogICAgICAgIGNoYXJ0LmFuaW1hdGluZyA9IGZhbHNlOwogICAgICB9CiAgICB9LAogICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lOiBmdW5jdGlvbiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CgogICAgICBpZiAobWUucmVxdWVzdCA9PT0gbnVsbCkgewogICAgICAgIC8vIFNraXAgYW5pbWF0aW9uIGZyYW1lIHJlcXVlc3RzIHVudGlsIHRoZSBhY3RpdmUgb25lIGlzIGV4ZWN1dGVkLgogICAgICAgIC8vIFRoaXMgY2FuIGhhcHBlbiB3aGVuIHByb2Nlc3NpbmcgbW91c2UgZXZlbnRzLCBlLmcuICdtb3VzZW1vdmUnCiAgICAgICAgLy8gYW5kICdtb3VzZW91dCcgZXZlbnRzIHdpbGwgdHJpZ2dlciBtdWx0aXBsZSByZW5kZXJzLgogICAgICAgIG1lLnJlcXVlc3QgPSBoZWxwZXJzJDEucmVxdWVzdEFuaW1GcmFtZS5jYWxsKHdpbmRvdywgZnVuY3Rpb24gKCkgewogICAgICAgICAgbWUucmVxdWVzdCA9IG51bGw7CiAgICAgICAgICBtZS5zdGFydERpZ2VzdCgpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBzdGFydERpZ2VzdDogZnVuY3Rpb24gc3RhcnREaWdlc3QoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIG1lLmFkdmFuY2UoKTsgLy8gRG8gd2UgaGF2ZSBtb3JlIHN0dWZmIHRvIGFuaW1hdGU/CgogICAgICBpZiAobWUuYW5pbWF0aW9ucy5sZW5ndGggPiAwKSB7CiAgICAgICAgbWUucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIGFkdmFuY2U6IGZ1bmN0aW9uIGFkdmFuY2UoKSB7CiAgICAgIHZhciBhbmltYXRpb25zID0gdGhpcy5hbmltYXRpb25zOwogICAgICB2YXIgYW5pbWF0aW9uLCBjaGFydCwgbnVtU3RlcHMsIG5leHRTdGVwOwogICAgICB2YXIgaSA9IDA7IC8vIDEgYW5pbWF0aW9uIHBlciBjaGFydCwgc28gd2UgYXJlIGxvb3BpbmcgY2hhcnRzIGhlcmUKCiAgICAgIHdoaWxlIChpIDwgYW5pbWF0aW9ucy5sZW5ndGgpIHsKICAgICAgICBhbmltYXRpb24gPSBhbmltYXRpb25zW2ldOwogICAgICAgIGNoYXJ0ID0gYW5pbWF0aW9uLmNoYXJ0OwogICAgICAgIG51bVN0ZXBzID0gYW5pbWF0aW9uLm51bVN0ZXBzOyAvLyBNYWtlIHN1cmUgdGhhdCBjdXJyZW50U3RlcCBzdGFydHMgYXQgMQogICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL2lzc3Vlcy82MTA0CgogICAgICAgIG5leHRTdGVwID0gTWF0aC5mbG9vcigoRGF0ZS5ub3coKSAtIGFuaW1hdGlvbi5zdGFydFRpbWUpIC8gYW5pbWF0aW9uLmR1cmF0aW9uICogbnVtU3RlcHMpICsgMTsKICAgICAgICBhbmltYXRpb24uY3VycmVudFN0ZXAgPSBNYXRoLm1pbihuZXh0U3RlcCwgbnVtU3RlcHMpOwogICAgICAgIGhlbHBlcnMkMS5jYWxsYmFjayhhbmltYXRpb24ucmVuZGVyLCBbY2hhcnQsIGFuaW1hdGlvbl0sIGNoYXJ0KTsKICAgICAgICBoZWxwZXJzJDEuY2FsbGJhY2soYW5pbWF0aW9uLm9uQW5pbWF0aW9uUHJvZ3Jlc3MsIFthbmltYXRpb25dLCBjaGFydCk7CgogICAgICAgIGlmIChhbmltYXRpb24uY3VycmVudFN0ZXAgPj0gbnVtU3RlcHMpIHsKICAgICAgICAgIGhlbHBlcnMkMS5jYWxsYmFjayhhbmltYXRpb24ub25BbmltYXRpb25Db21wbGV0ZSwgW2FuaW1hdGlvbl0sIGNoYXJ0KTsKICAgICAgICAgIGNoYXJ0LmFuaW1hdGluZyA9IGZhbHNlOwogICAgICAgICAgYW5pbWF0aW9ucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICsraTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwogIHZhciByZXNvbHZlID0gaGVscGVycyQxLm9wdGlvbnMucmVzb2x2ZTsKICB2YXIgYXJyYXlFdmVudHMgPSBbJ3B1c2gnLCAncG9wJywgJ3NoaWZ0JywgJ3NwbGljZScsICd1bnNoaWZ0J107CiAgLyoqDQogICAqIEhvb2tzIHRoZSBhcnJheSBtZXRob2RzIHRoYXQgYWRkIG9yIHJlbW92ZSB2YWx1ZXMgKCdwdXNoJywgcG9wJywgJ3NoaWZ0JywgJ3NwbGljZScsDQogICAqICd1bnNoaWZ0JykgYW5kIG5vdGlmeSB0aGUgbGlzdGVuZXIgQUZURVIgdGhlIGFycmF5IGhhcyBiZWVuIGFsdGVyZWQuIExpc3RlbmVycyBhcmUNCiAgICogY2FsbGVkIG9uIHRoZSAnb25EYXRhKicgY2FsbGJhY2tzIChlLmcuIG9uRGF0YVB1c2gsIGV0Yy4pIHdpdGggc2FtZSBhcmd1bWVudHMuDQogICAqLwoKICBmdW5jdGlvbiBsaXN0ZW5BcnJheUV2ZW50cyhhcnJheSwgbGlzdGVuZXIpIHsKICAgIGlmIChhcnJheS5fY2hhcnRqcykgewogICAgICBhcnJheS5fY2hhcnRqcy5saXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7CgogICAgICByZXR1cm47CiAgICB9CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFycmF5LCAnX2NoYXJ0anMnLCB7CiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIHZhbHVlOiB7CiAgICAgICAgbGlzdGVuZXJzOiBbbGlzdGVuZXJdCiAgICAgIH0KICAgIH0pOwogICAgYXJyYXlFdmVudHMuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIHZhciBtZXRob2QgPSAnb25EYXRhJyArIGtleS5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIGtleS5zbGljZSgxKTsKICAgICAgdmFyIGJhc2UgPSBhcnJheVtrZXldOwogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYXJyYXksIGtleSwgewogICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gdmFsdWUoKSB7CiAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgICAgICB2YXIgcmVzID0gYmFzZS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgIGhlbHBlcnMkMS5lYWNoKGFycmF5Ll9jaGFydGpzLmxpc3RlbmVycywgZnVuY3Rpb24gKG9iamVjdCkgewogICAgICAgICAgICBpZiAodHlwZW9mIG9iamVjdFttZXRob2RdID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgb2JqZWN0W21ldGhvZF0uYXBwbHkob2JqZWN0LCBhcmdzKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKICB9CiAgLyoqDQogICAqIFJlbW92ZXMgdGhlIGdpdmVuIGFycmF5IGV2ZW50IGxpc3RlbmVyIGFuZCBjbGVhbnVwIGV4dHJhIGF0dGFjaGVkIHByb3BlcnRpZXMgKHN1Y2ggYXMNCiAgICogdGhlIF9jaGFydGpzIHN0dWIgYW5kIG92ZXJyaWRkZW4gbWV0aG9kcykgaWYgYXJyYXkgZG9lc24ndCBoYXZlIGFueSBtb3JlIGxpc3RlbmVycy4NCiAgICovCgoKICBmdW5jdGlvbiB1bmxpc3RlbkFycmF5RXZlbnRzKGFycmF5LCBsaXN0ZW5lcikgewogICAgdmFyIHN0dWIgPSBhcnJheS5fY2hhcnRqczsKCiAgICBpZiAoIXN0dWIpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBsaXN0ZW5lcnMgPSBzdHViLmxpc3RlbmVyczsKICAgIHZhciBpbmRleCA9IGxpc3RlbmVycy5pbmRleE9mKGxpc3RlbmVyKTsKCiAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgIGxpc3RlbmVycy5zcGxpY2UoaW5kZXgsIDEpOwogICAgfQoKICAgIGlmIChsaXN0ZW5lcnMubGVuZ3RoID4gMCkgewogICAgICByZXR1cm47CiAgICB9CgogICAgYXJyYXlFdmVudHMuZm9yRWFjaChmdW5jdGlvbiAoa2V5KSB7CiAgICAgIGRlbGV0ZSBhcnJheVtrZXldOwogICAgfSk7CiAgICBkZWxldGUgYXJyYXkuX2NoYXJ0anM7CiAgfSAvLyBCYXNlIGNsYXNzIGZvciBhbGwgZGF0YXNldCBjb250cm9sbGVycyAobGluZSwgYmFyLCBldGMpCgoKICB2YXIgRGF0YXNldENvbnRyb2xsZXIgPSBmdW5jdGlvbiBEYXRhc2V0Q29udHJvbGxlcihjaGFydCwgZGF0YXNldEluZGV4KSB7CiAgICB0aGlzLmluaXRpYWxpemUoY2hhcnQsIGRhdGFzZXRJbmRleCk7CiAgfTsKCiAgaGVscGVycyQxLmV4dGVuZChEYXRhc2V0Q29udHJvbGxlci5wcm90b3R5cGUsIHsKICAgIC8qKg0KICAgICAqIEVsZW1lbnQgdHlwZSB1c2VkIHRvIGdlbmVyYXRlIGEgbWV0YSBkYXRhc2V0IChlLmcuIENoYXJ0LmVsZW1lbnQuTGluZSkuDQogICAgICogQHR5cGUge0NoYXJ0LmNvcmUuZWxlbWVudH0NCiAgICAgKi8KICAgIGRhdGFzZXRFbGVtZW50VHlwZTogbnVsbCwKCiAgICAvKioNCiAgICAgKiBFbGVtZW50IHR5cGUgdXNlZCB0byBnZW5lcmF0ZSBhIG1ldGEgZGF0YSAoZS5nLiBDaGFydC5lbGVtZW50LlBvaW50KS4NCiAgICAgKiBAdHlwZSB7Q2hhcnQuY29yZS5lbGVtZW50fQ0KICAgICAqLwogICAgZGF0YUVsZW1lbnRUeXBlOiBudWxsLAoKICAgIC8qKg0KICAgICAqIERhdGFzZXQgZWxlbWVudCBvcHRpb24ga2V5cyB0byBiZSByZXNvbHZlZCBpbiBfcmVzb2x2ZURhdGFzZXRFbGVtZW50T3B0aW9ucy4NCiAgICAgKiBBIGRlcml2ZWQgY29udHJvbGxlciBtYXkgb3ZlcnJpZGUgdGhpcyB0byByZXNvbHZlIGNvbnRyb2xsZXItc3BlY2lmaWMgb3B0aW9ucy4NCiAgICAgKiBUaGUga2V5cyBkZWZpbmVkIGhlcmUgYXJlIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5IGZvciBsZWdlbmQgc3R5bGVzLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZGF0YXNldEVsZW1lbnRPcHRpb25zOiBbJ2JhY2tncm91bmRDb2xvcicsICdib3JkZXJDYXBTdHlsZScsICdib3JkZXJDb2xvcicsICdib3JkZXJEYXNoJywgJ2JvcmRlckRhc2hPZmZzZXQnLCAnYm9yZGVySm9pblN0eWxlJywgJ2JvcmRlcldpZHRoJ10sCgogICAgLyoqDQogICAgICogRGF0YSBlbGVtZW50IG9wdGlvbiBrZXlzIHRvIGJlIHJlc29sdmVkIGluIF9yZXNvbHZlRGF0YUVsZW1lbnRPcHRpb25zLg0KICAgICAqIEEgZGVyaXZlZCBjb250cm9sbGVyIG1heSBvdmVycmlkZSB0aGlzIHRvIHJlc29sdmUgY29udHJvbGxlci1zcGVjaWZpYyBvcHRpb25zLg0KICAgICAqIFRoZSBrZXlzIGRlZmluZWQgaGVyZSBhcmUgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgZm9yIGxlZ2VuZCBzdHlsZXMuDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9kYXRhRWxlbWVudE9wdGlvbnM6IFsnYmFja2dyb3VuZENvbG9yJywgJ2JvcmRlckNvbG9yJywgJ2JvcmRlcldpZHRoJywgJ3BvaW50U3R5bGUnXSwKICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoY2hhcnQsIGRhdGFzZXRJbmRleCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICBtZS5jaGFydCA9IGNoYXJ0OwogICAgICBtZS5pbmRleCA9IGRhdGFzZXRJbmRleDsKICAgICAgbWUubGlua1NjYWxlcygpOwogICAgICBtZS5hZGRFbGVtZW50cygpOwogICAgICBtZS5fdHlwZSA9IG1lLmdldE1ldGEoKS50eXBlOwogICAgfSwKICAgIHVwZGF0ZUluZGV4OiBmdW5jdGlvbiB1cGRhdGVJbmRleChkYXRhc2V0SW5kZXgpIHsKICAgICAgdGhpcy5pbmRleCA9IGRhdGFzZXRJbmRleDsKICAgIH0sCiAgICBsaW5rU2NhbGVzOiBmdW5jdGlvbiBsaW5rU2NhbGVzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKICAgICAgdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CiAgICAgIHZhciBzY2FsZXMgPSBjaGFydC5zY2FsZXM7CiAgICAgIHZhciBkYXRhc2V0ID0gbWUuZ2V0RGF0YXNldCgpOwogICAgICB2YXIgc2NhbGVzT3B0cyA9IGNoYXJ0Lm9wdGlvbnMuc2NhbGVzOwoKICAgICAgaWYgKG1ldGEueEF4aXNJRCA9PT0gbnVsbCB8fCAhKG1ldGEueEF4aXNJRCBpbiBzY2FsZXMpIHx8IGRhdGFzZXQueEF4aXNJRCkgewogICAgICAgIG1ldGEueEF4aXNJRCA9IGRhdGFzZXQueEF4aXNJRCB8fCBzY2FsZXNPcHRzLnhBeGVzWzBdLmlkOwogICAgICB9CgogICAgICBpZiAobWV0YS55QXhpc0lEID09PSBudWxsIHx8ICEobWV0YS55QXhpc0lEIGluIHNjYWxlcykgfHwgZGF0YXNldC55QXhpc0lEKSB7CiAgICAgICAgbWV0YS55QXhpc0lEID0gZGF0YXNldC55QXhpc0lEIHx8IHNjYWxlc09wdHMueUF4ZXNbMF0uaWQ7CiAgICAgIH0KICAgIH0sCiAgICBnZXREYXRhc2V0OiBmdW5jdGlvbiBnZXREYXRhc2V0KCkgewogICAgICByZXR1cm4gdGhpcy5jaGFydC5kYXRhLmRhdGFzZXRzW3RoaXMuaW5kZXhdOwogICAgfSwKICAgIGdldE1ldGE6IGZ1bmN0aW9uIGdldE1ldGEoKSB7CiAgICAgIHJldHVybiB0aGlzLmNoYXJ0LmdldERhdGFzZXRNZXRhKHRoaXMuaW5kZXgpOwogICAgfSwKICAgIGdldFNjYWxlRm9ySWQ6IGZ1bmN0aW9uIGdldFNjYWxlRm9ySWQoc2NhbGVJRCkgewogICAgICByZXR1cm4gdGhpcy5jaGFydC5zY2FsZXNbc2NhbGVJRF07CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZ2V0VmFsdWVTY2FsZUlkOiBmdW5jdGlvbiBfZ2V0VmFsdWVTY2FsZUlkKCkgewogICAgICByZXR1cm4gdGhpcy5nZXRNZXRhKCkueUF4aXNJRDsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9nZXRJbmRleFNjYWxlSWQ6IGZ1bmN0aW9uIF9nZXRJbmRleFNjYWxlSWQoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldE1ldGEoKS54QXhpc0lEOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2dldFZhbHVlU2NhbGU6IGZ1bmN0aW9uIF9nZXRWYWx1ZVNjYWxlKCkgewogICAgICByZXR1cm4gdGhpcy5nZXRTY2FsZUZvcklkKHRoaXMuX2dldFZhbHVlU2NhbGVJZCgpKTsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9nZXRJbmRleFNjYWxlOiBmdW5jdGlvbiBfZ2V0SW5kZXhTY2FsZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0U2NhbGVGb3JJZCh0aGlzLl9nZXRJbmRleFNjYWxlSWQoKSk7CiAgICB9LAogICAgcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICB0aGlzLl91cGRhdGUodHJ1ZSk7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICBpZiAodGhpcy5fZGF0YSkgewogICAgICAgIHVubGlzdGVuQXJyYXlFdmVudHModGhpcy5fZGF0YSwgdGhpcyk7CiAgICAgIH0KICAgIH0sCiAgICBjcmVhdGVNZXRhRGF0YXNldDogZnVuY3Rpb24gY3JlYXRlTWV0YURhdGFzZXQoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciB0eXBlID0gbWUuZGF0YXNldEVsZW1lbnRUeXBlOwogICAgICByZXR1cm4gdHlwZSAmJiBuZXcgdHlwZSh7CiAgICAgICAgX2NoYXJ0OiBtZS5jaGFydCwKICAgICAgICBfZGF0YXNldEluZGV4OiBtZS5pbmRleAogICAgICB9KTsKICAgIH0sCiAgICBjcmVhdGVNZXRhRGF0YTogZnVuY3Rpb24gY3JlYXRlTWV0YURhdGEoaW5kZXgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIHR5cGUgPSBtZS5kYXRhRWxlbWVudFR5cGU7CiAgICAgIHJldHVybiB0eXBlICYmIG5ldyB0eXBlKHsKICAgICAgICBfY2hhcnQ6IG1lLmNoYXJ0LAogICAgICAgIF9kYXRhc2V0SW5kZXg6IG1lLmluZGV4LAogICAgICAgIF9pbmRleDogaW5kZXgKICAgICAgfSk7CiAgICB9LAogICAgYWRkRWxlbWVudHM6IGZ1bmN0aW9uIGFkZEVsZW1lbnRzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKICAgICAgdmFyIGRhdGEgPSBtZS5nZXREYXRhc2V0KCkuZGF0YSB8fCBbXTsKICAgICAgdmFyIG1ldGFEYXRhID0gbWV0YS5kYXRhOwogICAgICB2YXIgaSwgaWxlbjsKCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBkYXRhLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewogICAgICAgIG1ldGFEYXRhW2ldID0gbWV0YURhdGFbaV0gfHwgbWUuY3JlYXRlTWV0YURhdGEoaSk7CiAgICAgIH0KCiAgICAgIG1ldGEuZGF0YXNldCA9IG1ldGEuZGF0YXNldCB8fCBtZS5jcmVhdGVNZXRhRGF0YXNldCgpOwogICAgfSwKICAgIGFkZEVsZW1lbnRBbmRSZXNldDogZnVuY3Rpb24gYWRkRWxlbWVudEFuZFJlc2V0KGluZGV4KSB7CiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5jcmVhdGVNZXRhRGF0YShpbmRleCk7CiAgICAgIHRoaXMuZ2V0TWV0YSgpLmRhdGEuc3BsaWNlKGluZGV4LCAwLCBlbGVtZW50KTsKICAgICAgdGhpcy51cGRhdGVFbGVtZW50KGVsZW1lbnQsIGluZGV4LCB0cnVlKTsKICAgIH0sCiAgICBidWlsZE9yVXBkYXRlRWxlbWVudHM6IGZ1bmN0aW9uIGJ1aWxkT3JVcGRhdGVFbGVtZW50cygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGRhdGFzZXQgPSBtZS5nZXREYXRhc2V0KCk7CiAgICAgIHZhciBkYXRhID0gZGF0YXNldC5kYXRhIHx8IChkYXRhc2V0LmRhdGEgPSBbXSk7IC8vIEluIG9yZGVyIHRvIGNvcnJlY3RseSBoYW5kbGUgZGF0YSBhZGRpdGlvbi9kZWxldGlvbiBhbmltYXRpb24gKGFuIHRodXMgc2ltdWxhdGUKICAgICAgLy8gcmVhbC10aW1lIGNoYXJ0cyksIHdlIG5lZWQgdG8gbW9uaXRvciB0aGVzZSBkYXRhIG1vZGlmaWNhdGlvbnMgYW5kIHN5bmNocm9uaXplCiAgICAgIC8vIHRoZSBpbnRlcm5hbCBtZXRhIGRhdGEgYWNjb3JkaW5nbHkuCgogICAgICBpZiAobWUuX2RhdGEgIT09IGRhdGEpIHsKICAgICAgICBpZiAobWUuX2RhdGEpIHsKICAgICAgICAgIC8vIFRoaXMgY2FzZSBoYXBwZW5zIHdoZW4gdGhlIHVzZXIgcmVwbGFjZWQgdGhlIGRhdGEgYXJyYXkgaW5zdGFuY2UuCiAgICAgICAgICB1bmxpc3RlbkFycmF5RXZlbnRzKG1lLl9kYXRhLCBtZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGF0YSAmJiBPYmplY3QuaXNFeHRlbnNpYmxlKGRhdGEpKSB7CiAgICAgICAgICBsaXN0ZW5BcnJheUV2ZW50cyhkYXRhLCBtZSk7CiAgICAgICAgfQoKICAgICAgICBtZS5fZGF0YSA9IGRhdGE7CiAgICAgIH0gLy8gUmUtc3luYyBtZXRhIGRhdGEgaW4gY2FzZSB0aGUgdXNlciByZXBsYWNlZCB0aGUgZGF0YSBhcnJheSBvciBpZiB3ZSBtaXNzZWQKICAgICAgLy8gYW55IHVwZGF0ZXMgYW5kIHNvIG1ha2Ugc3VyZSB0aGF0IHdlIGhhbmRsZSBudW1iZXIgb2YgZGF0YXBvaW50cyBjaGFuZ2luZy4KCgogICAgICBtZS5yZXN5bmNFbGVtZW50cygpOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBSZXR1cm5zIHRoZSBtZXJnZWQgdXNlci1zdXBwbGllZCBhbmQgZGVmYXVsdCBkYXRhc2V0LWxldmVsIG9wdGlvbnMNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2NvbmZpZ3VyZTogZnVuY3Rpb24gX2NvbmZpZ3VyZSgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgbWUuX2NvbmZpZyA9IGhlbHBlcnMkMS5tZXJnZShPYmplY3QuY3JlYXRlKG51bGwpLCBbbWUuY2hhcnQub3B0aW9ucy5kYXRhc2V0c1ttZS5fdHlwZV0sIG1lLmdldERhdGFzZXQoKV0sIHsKICAgICAgICBtZXJnZXI6IGZ1bmN0aW9uIG1lcmdlcihrZXksIHRhcmdldCwgc291cmNlKSB7CiAgICAgICAgICBpZiAoa2V5ICE9PSAnX21ldGEnICYmIGtleSAhPT0gJ2RhdGEnKSB7CiAgICAgICAgICAgIGhlbHBlcnMkMS5fbWVyZ2VyKGtleSwgdGFyZ2V0LCBzb3VyY2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9LAogICAgX3VwZGF0ZTogZnVuY3Rpb24gX3VwZGF0ZShyZXNldCkgewogICAgICB2YXIgbWUgPSB0aGlzOwoKICAgICAgbWUuX2NvbmZpZ3VyZSgpOwoKICAgICAgbWUuX2NhY2hlZERhdGFPcHRzID0gbnVsbDsKICAgICAgbWUudXBkYXRlKHJlc2V0KTsKICAgIH0sCiAgICB1cGRhdGU6IGhlbHBlcnMkMS5ub29wLAogICAgdHJhbnNpdGlvbjogZnVuY3Rpb24gdHJhbnNpdGlvbihlYXNpbmdWYWx1ZSkgewogICAgICB2YXIgbWV0YSA9IHRoaXMuZ2V0TWV0YSgpOwogICAgICB2YXIgZWxlbWVudHMgPSBtZXRhLmRhdGEgfHwgW107CiAgICAgIHZhciBpbGVuID0gZWxlbWVudHMubGVuZ3RoOwogICAgICB2YXIgaSA9IDA7CgogICAgICBmb3IgKDsgaSA8IGlsZW47ICsraSkgewogICAgICAgIGVsZW1lbnRzW2ldLnRyYW5zaXRpb24oZWFzaW5nVmFsdWUpOwogICAgICB9CgogICAgICBpZiAobWV0YS5kYXRhc2V0KSB7CiAgICAgICAgbWV0YS5kYXRhc2V0LnRyYW5zaXRpb24oZWFzaW5nVmFsdWUpOwogICAgICB9CiAgICB9LAogICAgZHJhdzogZnVuY3Rpb24gZHJhdygpIHsKICAgICAgdmFyIG1ldGEgPSB0aGlzLmdldE1ldGEoKTsKICAgICAgdmFyIGVsZW1lbnRzID0gbWV0YS5kYXRhIHx8IFtdOwogICAgICB2YXIgaWxlbiA9IGVsZW1lbnRzLmxlbmd0aDsKICAgICAgdmFyIGkgPSAwOwoKICAgICAgaWYgKG1ldGEuZGF0YXNldCkgewogICAgICAgIG1ldGEuZGF0YXNldC5kcmF3KCk7CiAgICAgIH0KCiAgICAgIGZvciAoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgZWxlbWVudHNbaV0uZHJhdygpOwogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgYSBzZXQgb2YgcHJlZGVmaW5lZCBzdHlsZSBwcm9wZXJ0aWVzIHRoYXQgc2hvdWxkIGJlIHVzZWQgdG8gcmVwcmVzZW50IHRoZSBkYXRhc2V0DQogICAgICogb3IgdGhlIGRhdGEgaWYgdGhlIGluZGV4IGlzIHNwZWNpZmllZA0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIGRhdGEgaW5kZXgNCiAgICAgKiBAcmV0dXJuIHtJU3R5bGVJbnRlcmZhY2V9IHN0eWxlIG9iamVjdA0KICAgICAqLwogICAgZ2V0U3R5bGU6IGZ1bmN0aW9uIGdldFN0eWxlKGluZGV4KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBtZXRhID0gbWUuZ2V0TWV0YSgpOwogICAgICB2YXIgZGF0YXNldCA9IG1ldGEuZGF0YXNldDsKICAgICAgdmFyIHN0eWxlOwoKICAgICAgbWUuX2NvbmZpZ3VyZSgpOwoKICAgICAgaWYgKGRhdGFzZXQgJiYgaW5kZXggPT09IHVuZGVmaW5lZCkgewogICAgICAgIHN0eWxlID0gbWUuX3Jlc29sdmVEYXRhc2V0RWxlbWVudE9wdGlvbnMoZGF0YXNldCB8fCB7fSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW5kZXggPSBpbmRleCB8fCAwOwogICAgICAgIHN0eWxlID0gbWUuX3Jlc29sdmVEYXRhRWxlbWVudE9wdGlvbnMobWV0YS5kYXRhW2luZGV4XSB8fCB7fSwgaW5kZXgpOwogICAgICB9CgogICAgICBpZiAoc3R5bGUuZmlsbCA9PT0gZmFsc2UgfHwgc3R5bGUuZmlsbCA9PT0gbnVsbCkgewogICAgICAgIHN0eWxlLmJhY2tncm91bmRDb2xvciA9IHN0eWxlLmJvcmRlckNvbG9yOwogICAgICB9CgogICAgICByZXR1cm4gc3R5bGU7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfcmVzb2x2ZURhdGFzZXRFbGVtZW50T3B0aW9uczogZnVuY3Rpb24gX3Jlc29sdmVEYXRhc2V0RWxlbWVudE9wdGlvbnMoZWxlbWVudCwgaG92ZXIpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CiAgICAgIHZhciBkYXRhc2V0T3B0cyA9IG1lLl9jb25maWc7CiAgICAgIHZhciBjdXN0b20gPSBlbGVtZW50LmN1c3RvbSB8fCB7fTsKICAgICAgdmFyIG9wdGlvbnMgPSBjaGFydC5vcHRpb25zLmVsZW1lbnRzW21lLmRhdGFzZXRFbGVtZW50VHlwZS5wcm90b3R5cGUuX3R5cGVdIHx8IHt9OwogICAgICB2YXIgZWxlbWVudE9wdGlvbnMgPSBtZS5fZGF0YXNldEVsZW1lbnRPcHRpb25zOwogICAgICB2YXIgdmFsdWVzID0ge307CiAgICAgIHZhciBpLCBpbGVuLCBrZXksIHJlYWRLZXk7IC8vIFNjcmlwdGFibGUgb3B0aW9ucwoKICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgY2hhcnQ6IGNoYXJ0LAogICAgICAgIGRhdGFzZXQ6IG1lLmdldERhdGFzZXQoKSwKICAgICAgICBkYXRhc2V0SW5kZXg6IG1lLmluZGV4LAogICAgICAgIGhvdmVyOiBob3ZlcgogICAgICB9OwoKICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGVsZW1lbnRPcHRpb25zLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewogICAgICAgIGtleSA9IGVsZW1lbnRPcHRpb25zW2ldOwogICAgICAgIHJlYWRLZXkgPSBob3ZlciA/ICdob3ZlcicgKyBrZXkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBrZXkuc2xpY2UoMSkgOiBrZXk7CiAgICAgICAgdmFsdWVzW2tleV0gPSByZXNvbHZlKFtjdXN0b21bcmVhZEtleV0sIGRhdGFzZXRPcHRzW3JlYWRLZXldLCBvcHRpb25zW3JlYWRLZXldXSwgY29udGV4dCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfcmVzb2x2ZURhdGFFbGVtZW50T3B0aW9uczogZnVuY3Rpb24gX3Jlc29sdmVEYXRhRWxlbWVudE9wdGlvbnMoZWxlbWVudCwgaW5kZXgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGN1c3RvbSA9IGVsZW1lbnQgJiYgZWxlbWVudC5jdXN0b207CiAgICAgIHZhciBjYWNoZWQgPSBtZS5fY2FjaGVkRGF0YU9wdHM7CgogICAgICBpZiAoY2FjaGVkICYmICFjdXN0b20pIHsKICAgICAgICByZXR1cm4gY2FjaGVkOwogICAgICB9CgogICAgICB2YXIgY2hhcnQgPSBtZS5jaGFydDsKICAgICAgdmFyIGRhdGFzZXRPcHRzID0gbWUuX2NvbmZpZzsKICAgICAgdmFyIG9wdGlvbnMgPSBjaGFydC5vcHRpb25zLmVsZW1lbnRzW21lLmRhdGFFbGVtZW50VHlwZS5wcm90b3R5cGUuX3R5cGVdIHx8IHt9OwogICAgICB2YXIgZWxlbWVudE9wdGlvbnMgPSBtZS5fZGF0YUVsZW1lbnRPcHRpb25zOwogICAgICB2YXIgdmFsdWVzID0ge307IC8vIFNjcmlwdGFibGUgb3B0aW9ucwoKICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgY2hhcnQ6IGNoYXJ0LAogICAgICAgIGRhdGFJbmRleDogaW5kZXgsCiAgICAgICAgZGF0YXNldDogbWUuZ2V0RGF0YXNldCgpLAogICAgICAgIGRhdGFzZXRJbmRleDogbWUuaW5kZXgKICAgICAgfTsgLy8gYHJlc29sdmVgIHNldHMgY2FjaGVhYmxlIHRvIGBmYWxzZWAgaWYgYW55IG9wdGlvbiBpcyBpbmRleGVkIG9yIHNjcmlwdGVkCgogICAgICB2YXIgaW5mbyA9IHsKICAgICAgICBjYWNoZWFibGU6ICFjdXN0b20KICAgICAgfTsKICAgICAgdmFyIGtleXMsIGksIGlsZW4sIGtleTsKICAgICAgY3VzdG9tID0gY3VzdG9tIHx8IHt9OwoKICAgICAgaWYgKGhlbHBlcnMkMS5pc0FycmF5KGVsZW1lbnRPcHRpb25zKSkgewogICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBlbGVtZW50T3B0aW9ucy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICAgIGtleSA9IGVsZW1lbnRPcHRpb25zW2ldOwogICAgICAgICAgdmFsdWVzW2tleV0gPSByZXNvbHZlKFtjdXN0b21ba2V5XSwgZGF0YXNldE9wdHNba2V5XSwgb3B0aW9uc1trZXldXSwgY29udGV4dCwgaW5kZXgsIGluZm8pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBrZXlzID0gT2JqZWN0LmtleXMoZWxlbWVudE9wdGlvbnMpOwoKICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0ga2V5cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICAgIGtleSA9IGtleXNbaV07CiAgICAgICAgICB2YWx1ZXNba2V5XSA9IHJlc29sdmUoW2N1c3RvbVtrZXldLCBkYXRhc2V0T3B0c1tlbGVtZW50T3B0aW9uc1trZXldXSwgZGF0YXNldE9wdHNba2V5XSwgb3B0aW9uc1trZXldXSwgY29udGV4dCwgaW5kZXgsIGluZm8pOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKGluZm8uY2FjaGVhYmxlKSB7CiAgICAgICAgbWUuX2NhY2hlZERhdGFPcHRzID0gT2JqZWN0LmZyZWV6ZSh2YWx1ZXMpOwogICAgICB9CgogICAgICByZXR1cm4gdmFsdWVzOwogICAgfSwKICAgIHJlbW92ZUhvdmVyU3R5bGU6IGZ1bmN0aW9uIHJlbW92ZUhvdmVyU3R5bGUoZWxlbWVudCkgewogICAgICBoZWxwZXJzJDEubWVyZ2UoZWxlbWVudC5fbW9kZWwsIGVsZW1lbnQuJHByZXZpb3VzU3R5bGUgfHwge30pOwogICAgICBkZWxldGUgZWxlbWVudC4kcHJldmlvdXNTdHlsZTsKICAgIH0sCiAgICBzZXRIb3ZlclN0eWxlOiBmdW5jdGlvbiBzZXRIb3ZlclN0eWxlKGVsZW1lbnQpIHsKICAgICAgdmFyIGRhdGFzZXQgPSB0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHNbZWxlbWVudC5fZGF0YXNldEluZGV4XTsKICAgICAgdmFyIGluZGV4ID0gZWxlbWVudC5faW5kZXg7CiAgICAgIHZhciBjdXN0b20gPSBlbGVtZW50LmN1c3RvbSB8fCB7fTsKICAgICAgdmFyIG1vZGVsID0gZWxlbWVudC5fbW9kZWw7CiAgICAgIHZhciBnZXRIb3ZlckNvbG9yID0gaGVscGVycyQxLmdldEhvdmVyQ29sb3I7CiAgICAgIGVsZW1lbnQuJHByZXZpb3VzU3R5bGUgPSB7CiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBtb2RlbC5iYWNrZ3JvdW5kQ29sb3IsCiAgICAgICAgYm9yZGVyQ29sb3I6IG1vZGVsLmJvcmRlckNvbG9yLAogICAgICAgIGJvcmRlcldpZHRoOiBtb2RlbC5ib3JkZXJXaWR0aAogICAgICB9OwogICAgICBtb2RlbC5iYWNrZ3JvdW5kQ29sb3IgPSByZXNvbHZlKFtjdXN0b20uaG92ZXJCYWNrZ3JvdW5kQ29sb3IsIGRhdGFzZXQuaG92ZXJCYWNrZ3JvdW5kQ29sb3IsIGdldEhvdmVyQ29sb3IobW9kZWwuYmFja2dyb3VuZENvbG9yKV0sIHVuZGVmaW5lZCwgaW5kZXgpOwogICAgICBtb2RlbC5ib3JkZXJDb2xvciA9IHJlc29sdmUoW2N1c3RvbS5ob3ZlckJvcmRlckNvbG9yLCBkYXRhc2V0LmhvdmVyQm9yZGVyQ29sb3IsIGdldEhvdmVyQ29sb3IobW9kZWwuYm9yZGVyQ29sb3IpXSwgdW5kZWZpbmVkLCBpbmRleCk7CiAgICAgIG1vZGVsLmJvcmRlcldpZHRoID0gcmVzb2x2ZShbY3VzdG9tLmhvdmVyQm9yZGVyV2lkdGgsIGRhdGFzZXQuaG92ZXJCb3JkZXJXaWR0aCwgbW9kZWwuYm9yZGVyV2lkdGhdLCB1bmRlZmluZWQsIGluZGV4KTsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9yZW1vdmVEYXRhc2V0SG92ZXJTdHlsZTogZnVuY3Rpb24gX3JlbW92ZURhdGFzZXRIb3ZlclN0eWxlKCkgewogICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZ2V0TWV0YSgpLmRhdGFzZXQ7CgogICAgICBpZiAoZWxlbWVudCkgewogICAgICAgIHRoaXMucmVtb3ZlSG92ZXJTdHlsZShlbGVtZW50KTsKICAgICAgfQogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX3NldERhdGFzZXRIb3ZlclN0eWxlOiBmdW5jdGlvbiBfc2V0RGF0YXNldEhvdmVyU3R5bGUoKSB7CiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5nZXRNZXRhKCkuZGF0YXNldDsKICAgICAgdmFyIHByZXYgPSB7fTsKICAgICAgdmFyIGksIGlsZW4sIGtleSwga2V5cywgaG92ZXJPcHRpb25zLCBtb2RlbDsKCiAgICAgIGlmICghZWxlbWVudCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgbW9kZWwgPSBlbGVtZW50Ll9tb2RlbDsKICAgICAgaG92ZXJPcHRpb25zID0gdGhpcy5fcmVzb2x2ZURhdGFzZXRFbGVtZW50T3B0aW9ucyhlbGVtZW50LCB0cnVlKTsKICAgICAga2V5cyA9IE9iamVjdC5rZXlzKGhvdmVyT3B0aW9ucyk7CgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0ga2V5cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBrZXkgPSBrZXlzW2ldOwogICAgICAgIHByZXZba2V5XSA9IG1vZGVsW2tleV07CiAgICAgICAgbW9kZWxba2V5XSA9IGhvdmVyT3B0aW9uc1trZXldOwogICAgICB9CgogICAgICBlbGVtZW50LiRwcmV2aW91c1N0eWxlID0gcHJldjsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIHJlc3luY0VsZW1lbnRzOiBmdW5jdGlvbiByZXN5bmNFbGVtZW50cygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7CiAgICAgIHZhciBkYXRhID0gbWUuZ2V0RGF0YXNldCgpLmRhdGE7CiAgICAgIHZhciBudW1NZXRhID0gbWV0YS5kYXRhLmxlbmd0aDsKICAgICAgdmFyIG51bURhdGEgPSBkYXRhLmxlbmd0aDsKCiAgICAgIGlmIChudW1EYXRhIDwgbnVtTWV0YSkgewogICAgICAgIG1ldGEuZGF0YS5zcGxpY2UobnVtRGF0YSwgbnVtTWV0YSAtIG51bURhdGEpOwogICAgICB9IGVsc2UgaWYgKG51bURhdGEgPiBudW1NZXRhKSB7CiAgICAgICAgbWUuaW5zZXJ0RWxlbWVudHMobnVtTWV0YSwgbnVtRGF0YSAtIG51bU1ldGEpOwogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBpbnNlcnRFbGVtZW50czogZnVuY3Rpb24gaW5zZXJ0RWxlbWVudHMoc3RhcnQsIGNvdW50KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY291bnQ7ICsraSkgewogICAgICAgIHRoaXMuYWRkRWxlbWVudEFuZFJlc2V0KHN0YXJ0ICsgaSk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIG9uRGF0YVB1c2g6IGZ1bmN0aW9uIG9uRGF0YVB1c2goKSB7CiAgICAgIHZhciBjb3VudCA9IGFyZ3VtZW50cy5sZW5ndGg7CiAgICAgIHRoaXMuaW5zZXJ0RWxlbWVudHModGhpcy5nZXREYXRhc2V0KCkuZGF0YS5sZW5ndGggLSBjb3VudCwgY291bnQpOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgb25EYXRhUG9wOiBmdW5jdGlvbiBvbkRhdGFQb3AoKSB7CiAgICAgIHRoaXMuZ2V0TWV0YSgpLmRhdGEucG9wKCk7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBvbkRhdGFTaGlmdDogZnVuY3Rpb24gb25EYXRhU2hpZnQoKSB7CiAgICAgIHRoaXMuZ2V0TWV0YSgpLmRhdGEuc2hpZnQoKTsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIG9uRGF0YVNwbGljZTogZnVuY3Rpb24gb25EYXRhU3BsaWNlKHN0YXJ0LCBjb3VudCkgewogICAgICB0aGlzLmdldE1ldGEoKS5kYXRhLnNwbGljZShzdGFydCwgY291bnQpOwogICAgICB0aGlzLmluc2VydEVsZW1lbnRzKHN0YXJ0LCBhcmd1bWVudHMubGVuZ3RoIC0gMik7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBvbkRhdGFVbnNoaWZ0OiBmdW5jdGlvbiBvbkRhdGFVbnNoaWZ0KCkgewogICAgICB0aGlzLmluc2VydEVsZW1lbnRzKDAsIGFyZ3VtZW50cy5sZW5ndGgpOwogICAgfQogIH0pOwogIERhdGFzZXRDb250cm9sbGVyLmV4dGVuZCA9IGhlbHBlcnMkMS5pbmhlcml0czsKICB2YXIgY29yZV9kYXRhc2V0Q29udHJvbGxlciA9IERhdGFzZXRDb250cm9sbGVyOwogIHZhciBUQVUgPSBNYXRoLlBJICogMjsKCiAgY29yZV9kZWZhdWx0cy5fc2V0KCdnbG9iYWwnLCB7CiAgICBlbGVtZW50czogewogICAgICBhcmM6IHsKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGNvcmVfZGVmYXVsdHMuZ2xvYmFsLmRlZmF1bHRDb2xvciwKICAgICAgICBib3JkZXJDb2xvcjogJyNmZmYnLAogICAgICAgIGJvcmRlcldpZHRoOiAyLAogICAgICAgIGJvcmRlckFsaWduOiAnY2VudGVyJwogICAgICB9CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIGNsaXBBcmMoY3R4LCBhcmMpIHsKICAgIHZhciBzdGFydEFuZ2xlID0gYXJjLnN0YXJ0QW5nbGU7CiAgICB2YXIgZW5kQW5nbGUgPSBhcmMuZW5kQW5nbGU7CiAgICB2YXIgcGl4ZWxNYXJnaW4gPSBhcmMucGl4ZWxNYXJnaW47CiAgICB2YXIgYW5nbGVNYXJnaW4gPSBwaXhlbE1hcmdpbiAvIGFyYy5vdXRlclJhZGl1czsKICAgIHZhciB4ID0gYXJjLng7CiAgICB2YXIgeSA9IGFyYy55OyAvLyBEcmF3IGFuIGlubmVyIGJvcmRlciBieSBjbGlwaW5nIHRoZSBhcmMgYW5kIGRyYXdpbmcgYSBkb3VibGUtd2lkdGggYm9yZGVyCiAgICAvLyBFbmxhcmdlIHRoZSBjbGlwcGluZyBhcmMgYnkgMC4zMyBwaXhlbHMgdG8gZWxpbWluYXRlIGdsaXRjaGVzIGJldHdlZW4gYm9yZGVycwoKICAgIGN0eC5iZWdpblBhdGgoKTsKICAgIGN0eC5hcmMoeCwgeSwgYXJjLm91dGVyUmFkaXVzLCBzdGFydEFuZ2xlIC0gYW5nbGVNYXJnaW4sIGVuZEFuZ2xlICsgYW5nbGVNYXJnaW4pOwoKICAgIGlmIChhcmMuaW5uZXJSYWRpdXMgPiBwaXhlbE1hcmdpbikgewogICAgICBhbmdsZU1hcmdpbiA9IHBpeGVsTWFyZ2luIC8gYXJjLmlubmVyUmFkaXVzOwogICAgICBjdHguYXJjKHgsIHksIGFyYy5pbm5lclJhZGl1cyAtIHBpeGVsTWFyZ2luLCBlbmRBbmdsZSArIGFuZ2xlTWFyZ2luLCBzdGFydEFuZ2xlIC0gYW5nbGVNYXJnaW4sIHRydWUpOwogICAgfSBlbHNlIHsKICAgICAgY3R4LmFyYyh4LCB5LCBwaXhlbE1hcmdpbiwgZW5kQW5nbGUgKyBNYXRoLlBJIC8gMiwgc3RhcnRBbmdsZSAtIE1hdGguUEkgLyAyKTsKICAgIH0KCiAgICBjdHguY2xvc2VQYXRoKCk7CiAgICBjdHguY2xpcCgpOwogIH0KCiAgZnVuY3Rpb24gZHJhd0Z1bGxDaXJjbGVCb3JkZXJzKGN0eCwgdm0sIGFyYywgaW5uZXIpIHsKICAgIHZhciBlbmRBbmdsZSA9IGFyYy5lbmRBbmdsZTsKICAgIHZhciBpOwoKICAgIGlmIChpbm5lcikgewogICAgICBhcmMuZW5kQW5nbGUgPSBhcmMuc3RhcnRBbmdsZSArIFRBVTsKICAgICAgY2xpcEFyYyhjdHgsIGFyYyk7CiAgICAgIGFyYy5lbmRBbmdsZSA9IGVuZEFuZ2xlOwoKICAgICAgaWYgKGFyYy5lbmRBbmdsZSA9PT0gYXJjLnN0YXJ0QW5nbGUgJiYgYXJjLmZ1bGxDaXJjbGVzKSB7CiAgICAgICAgYXJjLmVuZEFuZ2xlICs9IFRBVTsKICAgICAgICBhcmMuZnVsbENpcmNsZXMtLTsKICAgICAgfQogICAgfQoKICAgIGN0eC5iZWdpblBhdGgoKTsKICAgIGN0eC5hcmMoYXJjLngsIGFyYy55LCBhcmMuaW5uZXJSYWRpdXMsIGFyYy5zdGFydEFuZ2xlICsgVEFVLCBhcmMuc3RhcnRBbmdsZSwgdHJ1ZSk7CgogICAgZm9yIChpID0gMDsgaSA8IGFyYy5mdWxsQ2lyY2xlczsgKytpKSB7CiAgICAgIGN0eC5zdHJva2UoKTsKICAgIH0KCiAgICBjdHguYmVnaW5QYXRoKCk7CiAgICBjdHguYXJjKGFyYy54LCBhcmMueSwgdm0ub3V0ZXJSYWRpdXMsIGFyYy5zdGFydEFuZ2xlLCBhcmMuc3RhcnRBbmdsZSArIFRBVSk7CgogICAgZm9yIChpID0gMDsgaSA8IGFyYy5mdWxsQ2lyY2xlczsgKytpKSB7CiAgICAgIGN0eC5zdHJva2UoKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGRyYXdCb3JkZXIoY3R4LCB2bSwgYXJjKSB7CiAgICB2YXIgaW5uZXIgPSB2bS5ib3JkZXJBbGlnbiA9PT0gJ2lubmVyJzsKCiAgICBpZiAoaW5uZXIpIHsKICAgICAgY3R4LmxpbmVXaWR0aCA9IHZtLmJvcmRlcldpZHRoICogMjsKICAgICAgY3R4LmxpbmVKb2luID0gJ3JvdW5kJzsKICAgIH0gZWxzZSB7CiAgICAgIGN0eC5saW5lV2lkdGggPSB2bS5ib3JkZXJXaWR0aDsKICAgICAgY3R4LmxpbmVKb2luID0gJ2JldmVsJzsKICAgIH0KCiAgICBpZiAoYXJjLmZ1bGxDaXJjbGVzKSB7CiAgICAgIGRyYXdGdWxsQ2lyY2xlQm9yZGVycyhjdHgsIHZtLCBhcmMsIGlubmVyKTsKICAgIH0KCiAgICBpZiAoaW5uZXIpIHsKICAgICAgY2xpcEFyYyhjdHgsIGFyYyk7CiAgICB9CgogICAgY3R4LmJlZ2luUGF0aCgpOwogICAgY3R4LmFyYyhhcmMueCwgYXJjLnksIHZtLm91dGVyUmFkaXVzLCBhcmMuc3RhcnRBbmdsZSwgYXJjLmVuZEFuZ2xlKTsKICAgIGN0eC5hcmMoYXJjLngsIGFyYy55LCBhcmMuaW5uZXJSYWRpdXMsIGFyYy5lbmRBbmdsZSwgYXJjLnN0YXJ0QW5nbGUsIHRydWUpOwogICAgY3R4LmNsb3NlUGF0aCgpOwogICAgY3R4LnN0cm9rZSgpOwogIH0KCiAgdmFyIGVsZW1lbnRfYXJjID0gY29yZV9lbGVtZW50LmV4dGVuZCh7CiAgICBfdHlwZTogJ2FyYycsCiAgICBpbkxhYmVsUmFuZ2U6IGZ1bmN0aW9uIGluTGFiZWxSYW5nZShtb3VzZVgpIHsKICAgICAgdmFyIHZtID0gdGhpcy5fdmlldzsKCiAgICAgIGlmICh2bSkgewogICAgICAgIHJldHVybiBNYXRoLnBvdyhtb3VzZVggLSB2bS54LCAyKSA8IE1hdGgucG93KHZtLnJhZGl1cyArIHZtLmhvdmVyUmFkaXVzLCAyKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSwKICAgIGluUmFuZ2U6IGZ1bmN0aW9uIGluUmFuZ2UoY2hhcnRYLCBjaGFydFkpIHsKICAgICAgdmFyIHZtID0gdGhpcy5fdmlldzsKCiAgICAgIGlmICh2bSkgewogICAgICAgIHZhciBwb2ludFJlbGF0aXZlUG9zaXRpb24gPSBoZWxwZXJzJDEuZ2V0QW5nbGVGcm9tUG9pbnQodm0sIHsKICAgICAgICAgIHg6IGNoYXJ0WCwKICAgICAgICAgIHk6IGNoYXJ0WQogICAgICAgIH0pOwogICAgICAgIHZhciBhbmdsZSA9IHBvaW50UmVsYXRpdmVQb3NpdGlvbi5hbmdsZTsKICAgICAgICB2YXIgZGlzdGFuY2UgPSBwb2ludFJlbGF0aXZlUG9zaXRpb24uZGlzdGFuY2U7IC8vIFNhbml0aXNlIGFuZ2xlIHJhbmdlCgogICAgICAgIHZhciBzdGFydEFuZ2xlID0gdm0uc3RhcnRBbmdsZTsKICAgICAgICB2YXIgZW5kQW5nbGUgPSB2bS5lbmRBbmdsZTsKCiAgICAgICAgd2hpbGUgKGVuZEFuZ2xlIDwgc3RhcnRBbmdsZSkgewogICAgICAgICAgZW5kQW5nbGUgKz0gVEFVOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKGFuZ2xlID4gZW5kQW5nbGUpIHsKICAgICAgICAgIGFuZ2xlIC09IFRBVTsKICAgICAgICB9CgogICAgICAgIHdoaWxlIChhbmdsZSA8IHN0YXJ0QW5nbGUpIHsKICAgICAgICAgIGFuZ2xlICs9IFRBVTsKICAgICAgICB9IC8vIENoZWNrIGlmIHdpdGhpbiB0aGUgcmFuZ2Ugb2YgdGhlIG9wZW4vY2xvc2UgYW5nbGUKCgogICAgICAgIHZhciBiZXR3ZWVuQW5nbGVzID0gYW5nbGUgPj0gc3RhcnRBbmdsZSAmJiBhbmdsZSA8PSBlbmRBbmdsZTsKICAgICAgICB2YXIgd2l0aGluUmFkaXVzID0gZGlzdGFuY2UgPj0gdm0uaW5uZXJSYWRpdXMgJiYgZGlzdGFuY2UgPD0gdm0ub3V0ZXJSYWRpdXM7CiAgICAgICAgcmV0dXJuIGJldHdlZW5BbmdsZXMgJiYgd2l0aGluUmFkaXVzOwogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAogICAgZ2V0Q2VudGVyUG9pbnQ6IGZ1bmN0aW9uIGdldENlbnRlclBvaW50KCkgewogICAgICB2YXIgdm0gPSB0aGlzLl92aWV3OwogICAgICB2YXIgaGFsZkFuZ2xlID0gKHZtLnN0YXJ0QW5nbGUgKyB2bS5lbmRBbmdsZSkgLyAyOwogICAgICB2YXIgaGFsZlJhZGl1cyA9ICh2bS5pbm5lclJhZGl1cyArIHZtLm91dGVyUmFkaXVzKSAvIDI7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogdm0ueCArIE1hdGguY29zKGhhbGZBbmdsZSkgKiBoYWxmUmFkaXVzLAogICAgICAgIHk6IHZtLnkgKyBNYXRoLnNpbihoYWxmQW5nbGUpICogaGFsZlJhZGl1cwogICAgICB9OwogICAgfSwKICAgIGdldEFyZWE6IGZ1bmN0aW9uIGdldEFyZWEoKSB7CiAgICAgIHZhciB2bSA9IHRoaXMuX3ZpZXc7CiAgICAgIHJldHVybiBNYXRoLlBJICogKCh2bS5lbmRBbmdsZSAtIHZtLnN0YXJ0QW5nbGUpIC8gKDIgKiBNYXRoLlBJKSkgKiAoTWF0aC5wb3codm0ub3V0ZXJSYWRpdXMsIDIpIC0gTWF0aC5wb3codm0uaW5uZXJSYWRpdXMsIDIpKTsKICAgIH0sCiAgICB0b29sdGlwUG9zaXRpb246IGZ1bmN0aW9uIHRvb2x0aXBQb3NpdGlvbigpIHsKICAgICAgdmFyIHZtID0gdGhpcy5fdmlldzsKICAgICAgdmFyIGNlbnRyZUFuZ2xlID0gdm0uc3RhcnRBbmdsZSArICh2bS5lbmRBbmdsZSAtIHZtLnN0YXJ0QW5nbGUpIC8gMjsKICAgICAgdmFyIHJhbmdlRnJvbUNlbnRyZSA9ICh2bS5vdXRlclJhZGl1cyAtIHZtLmlubmVyUmFkaXVzKSAvIDIgKyB2bS5pbm5lclJhZGl1czsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiB2bS54ICsgTWF0aC5jb3MoY2VudHJlQW5nbGUpICogcmFuZ2VGcm9tQ2VudHJlLAogICAgICAgIHk6IHZtLnkgKyBNYXRoLnNpbihjZW50cmVBbmdsZSkgKiByYW5nZUZyb21DZW50cmUKICAgICAgfTsKICAgIH0sCiAgICBkcmF3OiBmdW5jdGlvbiBkcmF3KCkgewogICAgICB2YXIgY3R4ID0gdGhpcy5fY2hhcnQuY3R4OwogICAgICB2YXIgdm0gPSB0aGlzLl92aWV3OwogICAgICB2YXIgcGl4ZWxNYXJnaW4gPSB2bS5ib3JkZXJBbGlnbiA9PT0gJ2lubmVyJyA/IDAuMzMgOiAwOwogICAgICB2YXIgYXJjID0gewogICAgICAgIHg6IHZtLngsCiAgICAgICAgeTogdm0ueSwKICAgICAgICBpbm5lclJhZGl1czogdm0uaW5uZXJSYWRpdXMsCiAgICAgICAgb3V0ZXJSYWRpdXM6IE1hdGgubWF4KHZtLm91dGVyUmFkaXVzIC0gcGl4ZWxNYXJnaW4sIDApLAogICAgICAgIHBpeGVsTWFyZ2luOiBwaXhlbE1hcmdpbiwKICAgICAgICBzdGFydEFuZ2xlOiB2bS5zdGFydEFuZ2xlLAogICAgICAgIGVuZEFuZ2xlOiB2bS5lbmRBbmdsZSwKICAgICAgICBmdWxsQ2lyY2xlczogTWF0aC5mbG9vcih2bS5jaXJjdW1mZXJlbmNlIC8gVEFVKQogICAgICB9OwogICAgICB2YXIgaTsKICAgICAgY3R4LnNhdmUoKTsKICAgICAgY3R4LmZpbGxTdHlsZSA9IHZtLmJhY2tncm91bmRDb2xvcjsKICAgICAgY3R4LnN0cm9rZVN0eWxlID0gdm0uYm9yZGVyQ29sb3I7CgogICAgICBpZiAoYXJjLmZ1bGxDaXJjbGVzKSB7CiAgICAgICAgYXJjLmVuZEFuZ2xlID0gYXJjLnN0YXJ0QW5nbGUgKyBUQVU7CiAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgIGN0eC5hcmMoYXJjLngsIGFyYy55LCBhcmMub3V0ZXJSYWRpdXMsIGFyYy5zdGFydEFuZ2xlLCBhcmMuZW5kQW5nbGUpOwogICAgICAgIGN0eC5hcmMoYXJjLngsIGFyYy55LCBhcmMuaW5uZXJSYWRpdXMsIGFyYy5lbmRBbmdsZSwgYXJjLnN0YXJ0QW5nbGUsIHRydWUpOwogICAgICAgIGN0eC5jbG9zZVBhdGgoKTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGFyYy5mdWxsQ2lyY2xlczsgKytpKSB7CiAgICAgICAgICBjdHguZmlsbCgpOwogICAgICAgIH0KCiAgICAgICAgYXJjLmVuZEFuZ2xlID0gYXJjLnN0YXJ0QW5nbGUgKyB2bS5jaXJjdW1mZXJlbmNlICUgVEFVOwogICAgICB9CgogICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgIGN0eC5hcmMoYXJjLngsIGFyYy55LCBhcmMub3V0ZXJSYWRpdXMsIGFyYy5zdGFydEFuZ2xlLCBhcmMuZW5kQW5nbGUpOwogICAgICBjdHguYXJjKGFyYy54LCBhcmMueSwgYXJjLmlubmVyUmFkaXVzLCBhcmMuZW5kQW5nbGUsIGFyYy5zdGFydEFuZ2xlLCB0cnVlKTsKICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICBjdHguZmlsbCgpOwoKICAgICAgaWYgKHZtLmJvcmRlcldpZHRoKSB7CiAgICAgICAgZHJhd0JvcmRlcihjdHgsIHZtLCBhcmMpOwogICAgICB9CgogICAgICBjdHgucmVzdG9yZSgpOwogICAgfQogIH0pOwogIHZhciB2YWx1ZU9yRGVmYXVsdCQxID0gaGVscGVycyQxLnZhbHVlT3JEZWZhdWx0OwogIHZhciBkZWZhdWx0Q29sb3IgPSBjb3JlX2RlZmF1bHRzLmdsb2JhbC5kZWZhdWx0Q29sb3I7CgogIGNvcmVfZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewogICAgZWxlbWVudHM6IHsKICAgICAgbGluZTogewogICAgICAgIHRlbnNpb246IDAuNCwKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IGRlZmF1bHRDb2xvciwKICAgICAgICBib3JkZXJXaWR0aDogMywKICAgICAgICBib3JkZXJDb2xvcjogZGVmYXVsdENvbG9yLAogICAgICAgIGJvcmRlckNhcFN0eWxlOiAnYnV0dCcsCiAgICAgICAgYm9yZGVyRGFzaDogW10sCiAgICAgICAgYm9yZGVyRGFzaE9mZnNldDogMC4wLAogICAgICAgIGJvcmRlckpvaW5TdHlsZTogJ21pdGVyJywKICAgICAgICBjYXBCZXppZXJQb2ludHM6IHRydWUsCiAgICAgICAgZmlsbDogdHJ1ZSAvLyBkbyB3ZSBmaWxsIGluIHRoZSBhcmVhIGJldHdlZW4gdGhlIGxpbmUgYW5kIGl0cyBiYXNlIGF4aXMKCiAgICAgIH0KICAgIH0KICB9KTsKCiAgdmFyIGVsZW1lbnRfbGluZSA9IGNvcmVfZWxlbWVudC5leHRlbmQoewogICAgX3R5cGU6ICdsaW5lJywKICAgIGRyYXc6IGZ1bmN0aW9uIGRyYXcoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciB2bSA9IG1lLl92aWV3OwogICAgICB2YXIgY3R4ID0gbWUuX2NoYXJ0LmN0eDsKICAgICAgdmFyIHNwYW5HYXBzID0gdm0uc3BhbkdhcHM7CgogICAgICB2YXIgcG9pbnRzID0gbWUuX2NoaWxkcmVuLnNsaWNlKCk7IC8vIGNsb25lIGFycmF5CgoKICAgICAgdmFyIGdsb2JhbERlZmF1bHRzID0gY29yZV9kZWZhdWx0cy5nbG9iYWw7CiAgICAgIHZhciBnbG9iYWxPcHRpb25MaW5lRWxlbWVudHMgPSBnbG9iYWxEZWZhdWx0cy5lbGVtZW50cy5saW5lOwogICAgICB2YXIgbGFzdERyYXduSW5kZXggPSAtMTsKICAgICAgdmFyIGNsb3NlUGF0aCA9IG1lLl9sb29wOwogICAgICB2YXIgaW5kZXgsIHByZXZpb3VzLCBjdXJyZW50Vk07CgogICAgICBpZiAoIXBvaW50cy5sZW5ndGgpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGlmIChtZS5fbG9vcCkgewogICAgICAgIGZvciAoaW5kZXggPSAwOyBpbmRleCA8IHBvaW50cy5sZW5ndGg7ICsraW5kZXgpIHsKICAgICAgICAgIHByZXZpb3VzID0gaGVscGVycyQxLnByZXZpb3VzSXRlbShwb2ludHMsIGluZGV4KTsgLy8gSWYgdGhlIGxpbmUgaGFzIGFuIG9wZW4gcGF0aCwgc2hpZnQgdGhlIHBvaW50IGFycmF5CgogICAgICAgICAgaWYgKCFwb2ludHNbaW5kZXhdLl92aWV3LnNraXAgJiYgcHJldmlvdXMuX3ZpZXcuc2tpcCkgewogICAgICAgICAgICBwb2ludHMgPSBwb2ludHMuc2xpY2UoaW5kZXgpLmNvbmNhdChwb2ludHMuc2xpY2UoMCwgaW5kZXgpKTsKICAgICAgICAgICAgY2xvc2VQYXRoID0gc3BhbkdhcHM7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0gLy8gSWYgdGhlIGxpbmUgaGFzIGEgY2xvc2UgcGF0aCwgYWRkIHRoZSBmaXJzdCBwb2ludCBhZ2FpbgoKCiAgICAgICAgaWYgKGNsb3NlUGF0aCkgewogICAgICAgICAgcG9pbnRzLnB1c2gocG9pbnRzWzBdKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGN0eC5zYXZlKCk7IC8vIFN0cm9rZSBMaW5lIE9wdGlvbnMKCiAgICAgIGN0eC5saW5lQ2FwID0gdm0uYm9yZGVyQ2FwU3R5bGUgfHwgZ2xvYmFsT3B0aW9uTGluZUVsZW1lbnRzLmJvcmRlckNhcFN0eWxlOyAvLyBJRSA5IGFuZCAxMCBkbyBub3Qgc3VwcG9ydCBsaW5lIGRhc2gKCiAgICAgIGlmIChjdHguc2V0TGluZURhc2gpIHsKICAgICAgICBjdHguc2V0TGluZURhc2godm0uYm9yZGVyRGFzaCB8fCBnbG9iYWxPcHRpb25MaW5lRWxlbWVudHMuYm9yZGVyRGFzaCk7CiAgICAgIH0KCiAgICAgIGN0eC5saW5lRGFzaE9mZnNldCA9IHZhbHVlT3JEZWZhdWx0JDEodm0uYm9yZGVyRGFzaE9mZnNldCwgZ2xvYmFsT3B0aW9uTGluZUVsZW1lbnRzLmJvcmRlckRhc2hPZmZzZXQpOwogICAgICBjdHgubGluZUpvaW4gPSB2bS5ib3JkZXJKb2luU3R5bGUgfHwgZ2xvYmFsT3B0aW9uTGluZUVsZW1lbnRzLmJvcmRlckpvaW5TdHlsZTsKICAgICAgY3R4LmxpbmVXaWR0aCA9IHZhbHVlT3JEZWZhdWx0JDEodm0uYm9yZGVyV2lkdGgsIGdsb2JhbE9wdGlvbkxpbmVFbGVtZW50cy5ib3JkZXJXaWR0aCk7CiAgICAgIGN0eC5zdHJva2VTdHlsZSA9IHZtLmJvcmRlckNvbG9yIHx8IGdsb2JhbERlZmF1bHRzLmRlZmF1bHRDb2xvcjsgLy8gU3Ryb2tlIExpbmUKCiAgICAgIGN0eC5iZWdpblBhdGgoKTsgLy8gRmlyc3QgcG9pbnQgbW92ZXMgdG8gaXQncyBzdGFydGluZyBwb3NpdGlvbiBubyBtYXR0ZXIgd2hhdAoKICAgICAgY3VycmVudFZNID0gcG9pbnRzWzBdLl92aWV3OwoKICAgICAgaWYgKCFjdXJyZW50Vk0uc2tpcCkgewogICAgICAgIGN0eC5tb3ZlVG8oY3VycmVudFZNLngsIGN1cnJlbnRWTS55KTsKICAgICAgICBsYXN0RHJhd25JbmRleCA9IDA7CiAgICAgIH0KCiAgICAgIGZvciAoaW5kZXggPSAxOyBpbmRleCA8IHBvaW50cy5sZW5ndGg7ICsraW5kZXgpIHsKICAgICAgICBjdXJyZW50Vk0gPSBwb2ludHNbaW5kZXhdLl92aWV3OwogICAgICAgIHByZXZpb3VzID0gbGFzdERyYXduSW5kZXggPT09IC0xID8gaGVscGVycyQxLnByZXZpb3VzSXRlbShwb2ludHMsIGluZGV4KSA6IHBvaW50c1tsYXN0RHJhd25JbmRleF07CgogICAgICAgIGlmICghY3VycmVudFZNLnNraXApIHsKICAgICAgICAgIGlmIChsYXN0RHJhd25JbmRleCAhPT0gaW5kZXggLSAxICYmICFzcGFuR2FwcyB8fCBsYXN0RHJhd25JbmRleCA9PT0gLTEpIHsKICAgICAgICAgICAgLy8gVGhlcmUgd2FzIGEgZ2FwIGFuZCB0aGlzIGlzIHRoZSBmaXJzdCBwb2ludCBhZnRlciB0aGUgZ2FwCiAgICAgICAgICAgIGN0eC5tb3ZlVG8oY3VycmVudFZNLngsIGN1cnJlbnRWTS55KTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIExpbmUgdG8gbmV4dCBwb2ludAogICAgICAgICAgICBoZWxwZXJzJDEuY2FudmFzLmxpbmVUbyhjdHgsIHByZXZpb3VzLl92aWV3LCBjdXJyZW50Vk0pOwogICAgICAgICAgfQoKICAgICAgICAgIGxhc3REcmF3bkluZGV4ID0gaW5kZXg7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoY2xvc2VQYXRoKSB7CiAgICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICB9CgogICAgICBjdHguc3Ryb2tlKCk7CiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9CiAgfSk7CiAgdmFyIHZhbHVlT3JEZWZhdWx0JDIgPSBoZWxwZXJzJDEudmFsdWVPckRlZmF1bHQ7CiAgdmFyIGRlZmF1bHRDb2xvciQxID0gY29yZV9kZWZhdWx0cy5nbG9iYWwuZGVmYXVsdENvbG9yOwoKICBjb3JlX2RlZmF1bHRzLl9zZXQoJ2dsb2JhbCcsIHsKICAgIGVsZW1lbnRzOiB7CiAgICAgIHBvaW50OiB7CiAgICAgICAgcmFkaXVzOiAzLAogICAgICAgIHBvaW50U3R5bGU6ICdjaXJjbGUnLAogICAgICAgIGJhY2tncm91bmRDb2xvcjogZGVmYXVsdENvbG9yJDEsCiAgICAgICAgYm9yZGVyQ29sb3I6IGRlZmF1bHRDb2xvciQxLAogICAgICAgIGJvcmRlcldpZHRoOiAxLAogICAgICAgIC8vIEhvdmVyCiAgICAgICAgaGl0UmFkaXVzOiAxLAogICAgICAgIGhvdmVyUmFkaXVzOiA0LAogICAgICAgIGhvdmVyQm9yZGVyV2lkdGg6IDEKICAgICAgfQogICAgfQogIH0pOwoKICBmdW5jdGlvbiB4UmFuZ2UobW91c2VYKSB7CiAgICB2YXIgdm0gPSB0aGlzLl92aWV3OwogICAgcmV0dXJuIHZtID8gTWF0aC5hYnMobW91c2VYIC0gdm0ueCkgPCB2bS5yYWRpdXMgKyB2bS5oaXRSYWRpdXMgOiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIHlSYW5nZShtb3VzZVkpIHsKICAgIHZhciB2bSA9IHRoaXMuX3ZpZXc7CiAgICByZXR1cm4gdm0gPyBNYXRoLmFicyhtb3VzZVkgLSB2bS55KSA8IHZtLnJhZGl1cyArIHZtLmhpdFJhZGl1cyA6IGZhbHNlOwogIH0KCiAgdmFyIGVsZW1lbnRfcG9pbnQgPSBjb3JlX2VsZW1lbnQuZXh0ZW5kKHsKICAgIF90eXBlOiAncG9pbnQnLAogICAgaW5SYW5nZTogZnVuY3Rpb24gaW5SYW5nZShtb3VzZVgsIG1vdXNlWSkgewogICAgICB2YXIgdm0gPSB0aGlzLl92aWV3OwogICAgICByZXR1cm4gdm0gPyBNYXRoLnBvdyhtb3VzZVggLSB2bS54LCAyKSArIE1hdGgucG93KG1vdXNlWSAtIHZtLnksIDIpIDwgTWF0aC5wb3codm0uaGl0UmFkaXVzICsgdm0ucmFkaXVzLCAyKSA6IGZhbHNlOwogICAgfSwKICAgIGluTGFiZWxSYW5nZTogeFJhbmdlLAogICAgaW5YUmFuZ2U6IHhSYW5nZSwKICAgIGluWVJhbmdlOiB5UmFuZ2UsCiAgICBnZXRDZW50ZXJQb2ludDogZnVuY3Rpb24gZ2V0Q2VudGVyUG9pbnQoKSB7CiAgICAgIHZhciB2bSA9IHRoaXMuX3ZpZXc7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogdm0ueCwKICAgICAgICB5OiB2bS55CiAgICAgIH07CiAgICB9LAogICAgZ2V0QXJlYTogZnVuY3Rpb24gZ2V0QXJlYSgpIHsKICAgICAgcmV0dXJuIE1hdGguUEkgKiBNYXRoLnBvdyh0aGlzLl92aWV3LnJhZGl1cywgMik7CiAgICB9LAogICAgdG9vbHRpcFBvc2l0aW9uOiBmdW5jdGlvbiB0b29sdGlwUG9zaXRpb24oKSB7CiAgICAgIHZhciB2bSA9IHRoaXMuX3ZpZXc7CiAgICAgIHJldHVybiB7CiAgICAgICAgeDogdm0ueCwKICAgICAgICB5OiB2bS55LAogICAgICAgIHBhZGRpbmc6IHZtLnJhZGl1cyArIHZtLmJvcmRlcldpZHRoCiAgICAgIH07CiAgICB9LAogICAgZHJhdzogZnVuY3Rpb24gZHJhdyhjaGFydEFyZWEpIHsKICAgICAgdmFyIHZtID0gdGhpcy5fdmlldzsKICAgICAgdmFyIGN0eCA9IHRoaXMuX2NoYXJ0LmN0eDsKICAgICAgdmFyIHBvaW50U3R5bGUgPSB2bS5wb2ludFN0eWxlOwogICAgICB2YXIgcm90YXRpb24gPSB2bS5yb3RhdGlvbjsKICAgICAgdmFyIHJhZGl1cyA9IHZtLnJhZGl1czsKICAgICAgdmFyIHggPSB2bS54OwogICAgICB2YXIgeSA9IHZtLnk7CiAgICAgIHZhciBnbG9iYWxEZWZhdWx0cyA9IGNvcmVfZGVmYXVsdHMuZ2xvYmFsOwogICAgICB2YXIgZGVmYXVsdENvbG9yID0gZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdENvbG9yOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXNoYWRvdwoKICAgICAgaWYgKHZtLnNraXApIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gQ2xpcHBpbmcgZm9yIFBvaW50cy4KCgogICAgICBpZiAoY2hhcnRBcmVhID09PSB1bmRlZmluZWQgfHwgaGVscGVycyQxLmNhbnZhcy5faXNQb2ludEluQXJlYSh2bSwgY2hhcnRBcmVhKSkgewogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IHZtLmJvcmRlckNvbG9yIHx8IGRlZmF1bHRDb2xvcjsKICAgICAgICBjdHgubGluZVdpZHRoID0gdmFsdWVPckRlZmF1bHQkMih2bS5ib3JkZXJXaWR0aCwgZ2xvYmFsRGVmYXVsdHMuZWxlbWVudHMucG9pbnQuYm9yZGVyV2lkdGgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSB2bS5iYWNrZ3JvdW5kQ29sb3IgfHwgZGVmYXVsdENvbG9yOwogICAgICAgIGhlbHBlcnMkMS5jYW52YXMuZHJhd1BvaW50KGN0eCwgcG9pbnRTdHlsZSwgcmFkaXVzLCB4LCB5LCByb3RhdGlvbik7CiAgICAgIH0KICAgIH0KICB9KTsKICB2YXIgZGVmYXVsdENvbG9yJDIgPSBjb3JlX2RlZmF1bHRzLmdsb2JhbC5kZWZhdWx0Q29sb3I7CgogIGNvcmVfZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewogICAgZWxlbWVudHM6IHsKICAgICAgcmVjdGFuZ2xlOiB7CiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBkZWZhdWx0Q29sb3IkMiwKICAgICAgICBib3JkZXJDb2xvcjogZGVmYXVsdENvbG9yJDIsCiAgICAgICAgYm9yZGVyU2tpcHBlZDogJ2JvdHRvbScsCiAgICAgICAgYm9yZGVyV2lkdGg6IDAKICAgICAgfQogICAgfQogIH0pOwoKICBmdW5jdGlvbiBpc1ZlcnRpY2FsKHZtKSB7CiAgICByZXR1cm4gdm0gJiYgdm0ud2lkdGggIT09IHVuZGVmaW5lZDsKICB9CiAgLyoqDQogICAqIEhlbHBlciBmdW5jdGlvbiB0byBnZXQgdGhlIGJvdW5kcyBvZiB0aGUgYmFyIHJlZ2FyZGxlc3Mgb2YgdGhlIG9yaWVudGF0aW9uDQogICAqIEBwYXJhbSBiYXIge0NoYXJ0LkVsZW1lbnQuUmVjdGFuZ2xlfSB0aGUgYmFyDQogICAqIEByZXR1cm4ge0JvdW5kc30gYm91bmRzIG9mIHRoZSBiYXINCiAgICogQHByaXZhdGUNCiAgICovCgoKICBmdW5jdGlvbiBnZXRCYXJCb3VuZHModm0pIHsKICAgIHZhciB4MSwgeDIsIHkxLCB5MiwgaGFsZjsKCiAgICBpZiAoaXNWZXJ0aWNhbCh2bSkpIHsKICAgICAgaGFsZiA9IHZtLndpZHRoIC8gMjsKICAgICAgeDEgPSB2bS54IC0gaGFsZjsKICAgICAgeDIgPSB2bS54ICsgaGFsZjsKICAgICAgeTEgPSBNYXRoLm1pbih2bS55LCB2bS5iYXNlKTsKICAgICAgeTIgPSBNYXRoLm1heCh2bS55LCB2bS5iYXNlKTsKICAgIH0gZWxzZSB7CiAgICAgIGhhbGYgPSB2bS5oZWlnaHQgLyAyOwogICAgICB4MSA9IE1hdGgubWluKHZtLngsIHZtLmJhc2UpOwogICAgICB4MiA9IE1hdGgubWF4KHZtLngsIHZtLmJhc2UpOwogICAgICB5MSA9IHZtLnkgLSBoYWxmOwogICAgICB5MiA9IHZtLnkgKyBoYWxmOwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIGxlZnQ6IHgxLAogICAgICB0b3A6IHkxLAogICAgICByaWdodDogeDIsCiAgICAgIGJvdHRvbTogeTIKICAgIH07CiAgfQoKICBmdW5jdGlvbiBzd2FwKG9yaWcsIHYxLCB2MikgewogICAgcmV0dXJuIG9yaWcgPT09IHYxID8gdjIgOiBvcmlnID09PSB2MiA/IHYxIDogb3JpZzsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQm9yZGVyU2tpcHBlZCh2bSkgewogICAgdmFyIGVkZ2UgPSB2bS5ib3JkZXJTa2lwcGVkOwogICAgdmFyIHJlcyA9IHt9OwoKICAgIGlmICghZWRnZSkgewogICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIGlmICh2bS5ob3Jpem9udGFsKSB7CiAgICAgIGlmICh2bS5iYXNlID4gdm0ueCkgewogICAgICAgIGVkZ2UgPSBzd2FwKGVkZ2UsICdsZWZ0JywgJ3JpZ2h0Jyk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAodm0uYmFzZSA8IHZtLnkpIHsKICAgICAgZWRnZSA9IHN3YXAoZWRnZSwgJ2JvdHRvbScsICd0b3AnKTsKICAgIH0KCiAgICByZXNbZWRnZV0gPSB0cnVlOwogICAgcmV0dXJuIHJlczsKICB9CgogIGZ1bmN0aW9uIHBhcnNlQm9yZGVyV2lkdGgodm0sIG1heFcsIG1heEgpIHsKICAgIHZhciB2YWx1ZSA9IHZtLmJvcmRlcldpZHRoOwogICAgdmFyIHNraXAgPSBwYXJzZUJvcmRlclNraXBwZWQodm0pOwogICAgdmFyIHQsIHIsIGIsIGw7CgogICAgaWYgKGhlbHBlcnMkMS5pc09iamVjdCh2YWx1ZSkpIHsKICAgICAgdCA9ICt2YWx1ZS50b3AgfHwgMDsKICAgICAgciA9ICt2YWx1ZS5yaWdodCB8fCAwOwogICAgICBiID0gK3ZhbHVlLmJvdHRvbSB8fCAwOwogICAgICBsID0gK3ZhbHVlLmxlZnQgfHwgMDsKICAgIH0gZWxzZSB7CiAgICAgIHQgPSByID0gYiA9IGwgPSArdmFsdWUgfHwgMDsKICAgIH0KCiAgICByZXR1cm4gewogICAgICB0OiBza2lwLnRvcCB8fCB0IDwgMCA/IDAgOiB0ID4gbWF4SCA/IG1heEggOiB0LAogICAgICByOiBza2lwLnJpZ2h0IHx8IHIgPCAwID8gMCA6IHIgPiBtYXhXID8gbWF4VyA6IHIsCiAgICAgIGI6IHNraXAuYm90dG9tIHx8IGIgPCAwID8gMCA6IGIgPiBtYXhIID8gbWF4SCA6IGIsCiAgICAgIGw6IHNraXAubGVmdCB8fCBsIDwgMCA/IDAgOiBsID4gbWF4VyA/IG1heFcgOiBsCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gYm91bmRpbmdSZWN0cyh2bSkgewogICAgdmFyIGJvdW5kcyA9IGdldEJhckJvdW5kcyh2bSk7CiAgICB2YXIgd2lkdGggPSBib3VuZHMucmlnaHQgLSBib3VuZHMubGVmdDsKICAgIHZhciBoZWlnaHQgPSBib3VuZHMuYm90dG9tIC0gYm91bmRzLnRvcDsKICAgIHZhciBib3JkZXIgPSBwYXJzZUJvcmRlcldpZHRoKHZtLCB3aWR0aCAvIDIsIGhlaWdodCAvIDIpOwogICAgcmV0dXJuIHsKICAgICAgb3V0ZXI6IHsKICAgICAgICB4OiBib3VuZHMubGVmdCwKICAgICAgICB5OiBib3VuZHMudG9wLAogICAgICAgIHc6IHdpZHRoLAogICAgICAgIGg6IGhlaWdodAogICAgICB9LAogICAgICBpbm5lcjogewogICAgICAgIHg6IGJvdW5kcy5sZWZ0ICsgYm9yZGVyLmwsCiAgICAgICAgeTogYm91bmRzLnRvcCArIGJvcmRlci50LAogICAgICAgIHc6IHdpZHRoIC0gYm9yZGVyLmwgLSBib3JkZXIuciwKICAgICAgICBoOiBoZWlnaHQgLSBib3JkZXIudCAtIGJvcmRlci5iCiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBfaW5SYW5nZSh2bSwgeCwgeSkgewogICAgdmFyIHNraXBYID0geCA9PT0gbnVsbDsKICAgIHZhciBza2lwWSA9IHkgPT09IG51bGw7CiAgICB2YXIgYm91bmRzID0gIXZtIHx8IHNraXBYICYmIHNraXBZID8gZmFsc2UgOiBnZXRCYXJCb3VuZHModm0pOwogICAgcmV0dXJuIGJvdW5kcyAmJiAoc2tpcFggfHwgeCA+PSBib3VuZHMubGVmdCAmJiB4IDw9IGJvdW5kcy5yaWdodCkgJiYgKHNraXBZIHx8IHkgPj0gYm91bmRzLnRvcCAmJiB5IDw9IGJvdW5kcy5ib3R0b20pOwogIH0KCiAgdmFyIGVsZW1lbnRfcmVjdGFuZ2xlID0gY29yZV9lbGVtZW50LmV4dGVuZCh7CiAgICBfdHlwZTogJ3JlY3RhbmdsZScsCiAgICBkcmF3OiBmdW5jdGlvbiBkcmF3KCkgewogICAgICB2YXIgY3R4ID0gdGhpcy5fY2hhcnQuY3R4OwogICAgICB2YXIgdm0gPSB0aGlzLl92aWV3OwogICAgICB2YXIgcmVjdHMgPSBib3VuZGluZ1JlY3RzKHZtKTsKICAgICAgdmFyIG91dGVyID0gcmVjdHMub3V0ZXI7CiAgICAgIHZhciBpbm5lciA9IHJlY3RzLmlubmVyOwogICAgICBjdHguZmlsbFN0eWxlID0gdm0uYmFja2dyb3VuZENvbG9yOwogICAgICBjdHguZmlsbFJlY3Qob3V0ZXIueCwgb3V0ZXIueSwgb3V0ZXIudywgb3V0ZXIuaCk7CgogICAgICBpZiAob3V0ZXIudyA9PT0gaW5uZXIudyAmJiBvdXRlci5oID09PSBpbm5lci5oKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjdHguc2F2ZSgpOwogICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgIGN0eC5yZWN0KG91dGVyLngsIG91dGVyLnksIG91dGVyLncsIG91dGVyLmgpOwogICAgICBjdHguY2xpcCgpOwogICAgICBjdHguZmlsbFN0eWxlID0gdm0uYm9yZGVyQ29sb3I7CiAgICAgIGN0eC5yZWN0KGlubmVyLngsIGlubmVyLnksIGlubmVyLncsIGlubmVyLmgpOwogICAgICBjdHguZmlsbCgnZXZlbm9kZCcpOwogICAgICBjdHgucmVzdG9yZSgpOwogICAgfSwKICAgIGhlaWdodDogZnVuY3Rpb24gaGVpZ2h0KCkgewogICAgICB2YXIgdm0gPSB0aGlzLl92aWV3OwogICAgICByZXR1cm4gdm0uYmFzZSAtIHZtLnk7CiAgICB9LAogICAgaW5SYW5nZTogZnVuY3Rpb24gaW5SYW5nZShtb3VzZVgsIG1vdXNlWSkgewogICAgICByZXR1cm4gX2luUmFuZ2UodGhpcy5fdmlldywgbW91c2VYLCBtb3VzZVkpOwogICAgfSwKICAgIGluTGFiZWxSYW5nZTogZnVuY3Rpb24gaW5MYWJlbFJhbmdlKG1vdXNlWCwgbW91c2VZKSB7CiAgICAgIHZhciB2bSA9IHRoaXMuX3ZpZXc7CiAgICAgIHJldHVybiBpc1ZlcnRpY2FsKHZtKSA/IF9pblJhbmdlKHZtLCBtb3VzZVgsIG51bGwpIDogX2luUmFuZ2Uodm0sIG51bGwsIG1vdXNlWSk7CiAgICB9LAogICAgaW5YUmFuZ2U6IGZ1bmN0aW9uIGluWFJhbmdlKG1vdXNlWCkgewogICAgICByZXR1cm4gX2luUmFuZ2UodGhpcy5fdmlldywgbW91c2VYLCBudWxsKTsKICAgIH0sCiAgICBpbllSYW5nZTogZnVuY3Rpb24gaW5ZUmFuZ2UobW91c2VZKSB7CiAgICAgIHJldHVybiBfaW5SYW5nZSh0aGlzLl92aWV3LCBudWxsLCBtb3VzZVkpOwogICAgfSwKICAgIGdldENlbnRlclBvaW50OiBmdW5jdGlvbiBnZXRDZW50ZXJQb2ludCgpIHsKICAgICAgdmFyIHZtID0gdGhpcy5fdmlldzsKICAgICAgdmFyIHgsIHk7CgogICAgICBpZiAoaXNWZXJ0aWNhbCh2bSkpIHsKICAgICAgICB4ID0gdm0ueDsKICAgICAgICB5ID0gKHZtLnkgKyB2bS5iYXNlKSAvIDI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgeCA9ICh2bS54ICsgdm0uYmFzZSkgLyAyOwogICAgICAgIHkgPSB2bS55OwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHg6IHgsCiAgICAgICAgeTogeQogICAgICB9OwogICAgfSwKICAgIGdldEFyZWE6IGZ1bmN0aW9uIGdldEFyZWEoKSB7CiAgICAgIHZhciB2bSA9IHRoaXMuX3ZpZXc7CiAgICAgIHJldHVybiBpc1ZlcnRpY2FsKHZtKSA/IHZtLndpZHRoICogTWF0aC5hYnModm0ueSAtIHZtLmJhc2UpIDogdm0uaGVpZ2h0ICogTWF0aC5hYnModm0ueCAtIHZtLmJhc2UpOwogICAgfSwKICAgIHRvb2x0aXBQb3NpdGlvbjogZnVuY3Rpb24gdG9vbHRpcFBvc2l0aW9uKCkgewogICAgICB2YXIgdm0gPSB0aGlzLl92aWV3OwogICAgICByZXR1cm4gewogICAgICAgIHg6IHZtLngsCiAgICAgICAgeTogdm0ueQogICAgICB9OwogICAgfQogIH0pOwogIHZhciBlbGVtZW50cyA9IHt9OwogIHZhciBBcmMgPSBlbGVtZW50X2FyYzsKICB2YXIgTGluZSA9IGVsZW1lbnRfbGluZTsKICB2YXIgUG9pbnQgPSBlbGVtZW50X3BvaW50OwogIHZhciBSZWN0YW5nbGUgPSBlbGVtZW50X3JlY3RhbmdsZTsKICBlbGVtZW50cy5BcmMgPSBBcmM7CiAgZWxlbWVudHMuTGluZSA9IExpbmU7CiAgZWxlbWVudHMuUG9pbnQgPSBQb2ludDsKICBlbGVtZW50cy5SZWN0YW5nbGUgPSBSZWN0YW5nbGU7CiAgdmFyIGRlcHJlY2F0ZWQgPSBoZWxwZXJzJDEuX2RlcHJlY2F0ZWQ7CiAgdmFyIHZhbHVlT3JEZWZhdWx0JDMgPSBoZWxwZXJzJDEudmFsdWVPckRlZmF1bHQ7CgogIGNvcmVfZGVmYXVsdHMuX3NldCgnYmFyJywgewogICAgaG92ZXI6IHsKICAgICAgbW9kZTogJ2xhYmVsJwogICAgfSwKICAgIHNjYWxlczogewogICAgICB4QXhlczogW3sKICAgICAgICB0eXBlOiAnY2F0ZWdvcnknLAogICAgICAgIG9mZnNldDogdHJ1ZSwKICAgICAgICBncmlkTGluZXM6IHsKICAgICAgICAgIG9mZnNldEdyaWRMaW5lczogdHJ1ZQogICAgICAgIH0KICAgICAgfV0sCiAgICAgIHlBeGVzOiBbewogICAgICAgIHR5cGU6ICdsaW5lYXInCiAgICAgIH1dCiAgICB9CiAgfSk7CgogIGNvcmVfZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewogICAgZGF0YXNldHM6IHsKICAgICAgYmFyOiB7CiAgICAgICAgY2F0ZWdvcnlQZXJjZW50YWdlOiAwLjgsCiAgICAgICAgYmFyUGVyY2VudGFnZTogMC45CiAgICAgIH0KICAgIH0KICB9KTsKICAvKioNCiAgICogQ29tcHV0ZXMgdGhlICJvcHRpbWFsIiBzYW1wbGUgc2l6ZSB0byBtYWludGFpbiBiYXJzIGVxdWFsbHkgc2l6ZWQgd2hpbGUgcHJldmVudGluZyBvdmVybGFwLg0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCgogIGZ1bmN0aW9uIGNvbXB1dGVNaW5TYW1wbGVTaXplKHNjYWxlLCBwaXhlbHMpIHsKICAgIHZhciBtaW4gPSBzY2FsZS5fbGVuZ3RoOwogICAgdmFyIHByZXYsIGN1cnIsIGksIGlsZW47CgogICAgZm9yIChpID0gMSwgaWxlbiA9IHBpeGVscy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgbWluID0gTWF0aC5taW4obWluLCBNYXRoLmFicyhwaXhlbHNbaV0gLSBwaXhlbHNbaSAtIDFdKSk7CiAgICB9CgogICAgZm9yIChpID0gMCwgaWxlbiA9IHNjYWxlLmdldFRpY2tzKCkubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgIGN1cnIgPSBzY2FsZS5nZXRQaXhlbEZvclRpY2soaSk7CiAgICAgIG1pbiA9IGkgPiAwID8gTWF0aC5taW4obWluLCBNYXRoLmFicyhjdXJyIC0gcHJldikpIDogbWluOwogICAgICBwcmV2ID0gY3VycjsKICAgIH0KCiAgICByZXR1cm4gbWluOwogIH0KICAvKioNCiAgICogQ29tcHV0ZXMgYW4gImlkZWFsIiBjYXRlZ29yeSBiYXNlZCBvbiB0aGUgYWJzb2x1dGUgYmFyIHRoaWNrbmVzcyBvciwgaWYgdW5kZWZpbmVkIG9yIG51bGwsDQogICAqIHVzZXMgdGhlIHNtYWxsZXN0IGludGVydmFsIChzZWUgY29tcHV0ZU1pblNhbXBsZVNpemUpIHRoYXQgcHJldmVudHMgYmFyIG92ZXJsYXBwaW5nLiBUaGlzDQogICAqIG1vZGUgY3VycmVudGx5IGFsd2F5cyBnZW5lcmF0ZXMgYmFycyBlcXVhbGx5IHNpemVkICh1bnRpbCB3ZSBpbnRyb2R1Y2Ugc2NyaXB0YWJsZSBvcHRpb25zPykuDQogICAqIEBwcml2YXRlDQogICAqLwoKCiAgZnVuY3Rpb24gY29tcHV0ZUZpdENhdGVnb3J5VHJhaXRzKGluZGV4LCBydWxlciwgb3B0aW9ucykgewogICAgdmFyIHRoaWNrbmVzcyA9IG9wdGlvbnMuYmFyVGhpY2tuZXNzOwogICAgdmFyIGNvdW50ID0gcnVsZXIuc3RhY2tDb3VudDsKICAgIHZhciBjdXJyID0gcnVsZXIucGl4ZWxzW2luZGV4XTsKICAgIHZhciBtaW4gPSBoZWxwZXJzJDEuaXNOdWxsT3JVbmRlZih0aGlja25lc3MpID8gY29tcHV0ZU1pblNhbXBsZVNpemUocnVsZXIuc2NhbGUsIHJ1bGVyLnBpeGVscykgOiAtMTsKICAgIHZhciBzaXplLCByYXRpbzsKCiAgICBpZiAoaGVscGVycyQxLmlzTnVsbE9yVW5kZWYodGhpY2tuZXNzKSkgewogICAgICBzaXplID0gbWluICogb3B0aW9ucy5jYXRlZ29yeVBlcmNlbnRhZ2U7CiAgICAgIHJhdGlvID0gb3B0aW9ucy5iYXJQZXJjZW50YWdlOwogICAgfSBlbHNlIHsKICAgICAgLy8gV2hlbiBiYXIgdGhpY2tuZXNzIGlzIGVuZm9yY2VkLCBjYXRlZ29yeSBhbmQgYmFyIHBlcmNlbnRhZ2VzIGFyZSBpZ25vcmVkLgogICAgICAvLyBOb3RlKFNCKTogd2UgY291bGQgYWRkIHN1cHBvcnQgZm9yIHJlbGF0aXZlIGJhciB0aGlja25lc3MgKGUuZy4gYmFyVGhpY2tuZXNzOiAnNTAlJykKICAgICAgLy8gYW5kIGRlcHJlY2F0ZSBiYXJQZXJjZW50YWdlIHNpbmNlIHRoaXMgdmFsdWUgaXMgaWdub3JlZCB3aGVuIHRoaWNrbmVzcyBpcyBhYnNvbHV0ZS4KICAgICAgc2l6ZSA9IHRoaWNrbmVzcyAqIGNvdW50OwogICAgICByYXRpbyA9IDE7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgY2h1bms6IHNpemUgLyBjb3VudCwKICAgICAgcmF0aW86IHJhdGlvLAogICAgICBzdGFydDogY3VyciAtIHNpemUgLyAyCiAgICB9OwogIH0KICAvKioNCiAgICogQ29tcHV0ZXMgYW4gIm9wdGltYWwiIGNhdGVnb3J5IHRoYXQgZ2xvYmFsbHkgYXJyYW5nZXMgYmFycyBzaWRlIGJ5IHNpZGUgKG5vIGdhcCB3aGVuDQogICAqIHBlcmNlbnRhZ2Ugb3B0aW9ucyBhcmUgMSksIGJhc2VkIG9uIHRoZSBwcmV2aW91cyBhbmQgZm9sbG93aW5nIGNhdGVnb3JpZXMuIFRoaXMgbW9kZQ0KICAgKiBnZW5lcmF0ZXMgYmFycyB3aXRoIGRpZmZlcmVudCB3aWR0aHMgd2hlbiBkYXRhIGFyZSBub3QgZXZlbmx5IHNwYWNlZC4NCiAgICogQHByaXZhdGUNCiAgICovCgoKICBmdW5jdGlvbiBjb21wdXRlRmxleENhdGVnb3J5VHJhaXRzKGluZGV4LCBydWxlciwgb3B0aW9ucykgewogICAgdmFyIHBpeGVscyA9IHJ1bGVyLnBpeGVsczsKICAgIHZhciBjdXJyID0gcGl4ZWxzW2luZGV4XTsKICAgIHZhciBwcmV2ID0gaW5kZXggPiAwID8gcGl4ZWxzW2luZGV4IC0gMV0gOiBudWxsOwogICAgdmFyIG5leHQgPSBpbmRleCA8IHBpeGVscy5sZW5ndGggLSAxID8gcGl4ZWxzW2luZGV4ICsgMV0gOiBudWxsOwogICAgdmFyIHBlcmNlbnQgPSBvcHRpb25zLmNhdGVnb3J5UGVyY2VudGFnZTsKICAgIHZhciBzdGFydCwgc2l6ZTsKCiAgICBpZiAocHJldiA9PT0gbnVsbCkgewogICAgICAvLyBmaXJzdCBkYXRhOiBpdHMgc2l6ZSBpcyBkb3VibGUgYmFzZWQgb24gdGhlIG5leHQgcG9pbnQgb3IsCiAgICAgIC8vIGlmIGl0J3MgYWxzbyB0aGUgbGFzdCBkYXRhLCB3ZSB1c2UgdGhlIHNjYWxlIHNpemUuCiAgICAgIHByZXYgPSBjdXJyIC0gKG5leHQgPT09IG51bGwgPyBydWxlci5lbmQgLSBydWxlci5zdGFydCA6IG5leHQgLSBjdXJyKTsKICAgIH0KCiAgICBpZiAobmV4dCA9PT0gbnVsbCkgewogICAgICAvLyBsYXN0IGRhdGE6IGl0cyBzaXplIGlzIGFsc28gZG91YmxlIGJhc2VkIG9uIHRoZSBwcmV2aW91cyBwb2ludC4KICAgICAgbmV4dCA9IGN1cnIgKyBjdXJyIC0gcHJldjsKICAgIH0KCiAgICBzdGFydCA9IGN1cnIgLSAoY3VyciAtIE1hdGgubWluKHByZXYsIG5leHQpKSAvIDIgKiBwZXJjZW50OwogICAgc2l6ZSA9IE1hdGguYWJzKG5leHQgLSBwcmV2KSAvIDIgKiBwZXJjZW50OwogICAgcmV0dXJuIHsKICAgICAgY2h1bms6IHNpemUgLyBydWxlci5zdGFja0NvdW50LAogICAgICByYXRpbzogb3B0aW9ucy5iYXJQZXJjZW50YWdlLAogICAgICBzdGFydDogc3RhcnQKICAgIH07CiAgfQoKICB2YXIgY29udHJvbGxlcl9iYXIgPSBjb3JlX2RhdGFzZXRDb250cm9sbGVyLmV4dGVuZCh7CiAgICBkYXRhRWxlbWVudFR5cGU6IGVsZW1lbnRzLlJlY3RhbmdsZSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2RhdGFFbGVtZW50T3B0aW9uczogWydiYWNrZ3JvdW5kQ29sb3InLCAnYm9yZGVyQ29sb3InLCAnYm9yZGVyU2tpcHBlZCcsICdib3JkZXJXaWR0aCcsICdiYXJQZXJjZW50YWdlJywgJ2JhclRoaWNrbmVzcycsICdjYXRlZ29yeVBlcmNlbnRhZ2UnLCAnbWF4QmFyVGhpY2tuZXNzJywgJ21pbkJhckxlbmd0aCddLAogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24gaW5pdGlhbGl6ZSgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG1ldGEsIHNjYWxlT3B0czsKICAgICAgY29yZV9kYXRhc2V0Q29udHJvbGxlci5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseShtZSwgYXJndW1lbnRzKTsKICAgICAgbWV0YSA9IG1lLmdldE1ldGEoKTsKICAgICAgbWV0YS5zdGFjayA9IG1lLmdldERhdGFzZXQoKS5zdGFjazsKICAgICAgbWV0YS5iYXIgPSB0cnVlOwogICAgICBzY2FsZU9wdHMgPSBtZS5fZ2V0SW5kZXhTY2FsZSgpLm9wdGlvbnM7CiAgICAgIGRlcHJlY2F0ZWQoJ2JhciBjaGFydCcsIHNjYWxlT3B0cy5iYXJQZXJjZW50YWdlLCAnc2NhbGVzLlt4L3ldQXhlcy5iYXJQZXJjZW50YWdlJywgJ2RhdGFzZXQuYmFyUGVyY2VudGFnZScpOwogICAgICBkZXByZWNhdGVkKCdiYXIgY2hhcnQnLCBzY2FsZU9wdHMuYmFyVGhpY2tuZXNzLCAnc2NhbGVzLlt4L3ldQXhlcy5iYXJUaGlja25lc3MnLCAnZGF0YXNldC5iYXJUaGlja25lc3MnKTsKICAgICAgZGVwcmVjYXRlZCgnYmFyIGNoYXJ0Jywgc2NhbGVPcHRzLmNhdGVnb3J5UGVyY2VudGFnZSwgJ3NjYWxlcy5beC95XUF4ZXMuY2F0ZWdvcnlQZXJjZW50YWdlJywgJ2RhdGFzZXQuY2F0ZWdvcnlQZXJjZW50YWdlJyk7CiAgICAgIGRlcHJlY2F0ZWQoJ2JhciBjaGFydCcsIG1lLl9nZXRWYWx1ZVNjYWxlKCkub3B0aW9ucy5taW5CYXJMZW5ndGgsICdzY2FsZXMuW3gveV1BeGVzLm1pbkJhckxlbmd0aCcsICdkYXRhc2V0Lm1pbkJhckxlbmd0aCcpOwogICAgICBkZXByZWNhdGVkKCdiYXIgY2hhcnQnLCBzY2FsZU9wdHMubWF4QmFyVGhpY2tuZXNzLCAnc2NhbGVzLlt4L3ldQXhlcy5tYXhCYXJUaGlja25lc3MnLCAnZGF0YXNldC5tYXhCYXJUaGlja25lc3MnKTsKICAgIH0sCiAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShyZXNldCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgcmVjdHMgPSBtZS5nZXRNZXRhKCkuZGF0YTsKICAgICAgdmFyIGksIGlsZW47CiAgICAgIG1lLl9ydWxlciA9IG1lLmdldFJ1bGVyKCk7CgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gcmVjdHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgbWUudXBkYXRlRWxlbWVudChyZWN0c1tpXSwgaSwgcmVzZXQpOwogICAgICB9CiAgICB9LAogICAgdXBkYXRlRWxlbWVudDogZnVuY3Rpb24gdXBkYXRlRWxlbWVudChyZWN0YW5nbGUsIGluZGV4LCByZXNldCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKICAgICAgdmFyIGRhdGFzZXQgPSBtZS5nZXREYXRhc2V0KCk7CgogICAgICB2YXIgb3B0aW9ucyA9IG1lLl9yZXNvbHZlRGF0YUVsZW1lbnRPcHRpb25zKHJlY3RhbmdsZSwgaW5kZXgpOwoKICAgICAgcmVjdGFuZ2xlLl94U2NhbGUgPSBtZS5nZXRTY2FsZUZvcklkKG1ldGEueEF4aXNJRCk7CiAgICAgIHJlY3RhbmdsZS5feVNjYWxlID0gbWUuZ2V0U2NhbGVGb3JJZChtZXRhLnlBeGlzSUQpOwogICAgICByZWN0YW5nbGUuX2RhdGFzZXRJbmRleCA9IG1lLmluZGV4OwogICAgICByZWN0YW5nbGUuX2luZGV4ID0gaW5kZXg7CiAgICAgIHJlY3RhbmdsZS5fbW9kZWwgPSB7CiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBvcHRpb25zLmJhY2tncm91bmRDb2xvciwKICAgICAgICBib3JkZXJDb2xvcjogb3B0aW9ucy5ib3JkZXJDb2xvciwKICAgICAgICBib3JkZXJTa2lwcGVkOiBvcHRpb25zLmJvcmRlclNraXBwZWQsCiAgICAgICAgYm9yZGVyV2lkdGg6IG9wdGlvbnMuYm9yZGVyV2lkdGgsCiAgICAgICAgZGF0YXNldExhYmVsOiBkYXRhc2V0LmxhYmVsLAogICAgICAgIGxhYmVsOiBtZS5jaGFydC5kYXRhLmxhYmVsc1tpbmRleF0KICAgICAgfTsKCiAgICAgIGlmIChoZWxwZXJzJDEuaXNBcnJheShkYXRhc2V0LmRhdGFbaW5kZXhdKSkgewogICAgICAgIHJlY3RhbmdsZS5fbW9kZWwuYm9yZGVyU2tpcHBlZCA9IG51bGw7CiAgICAgIH0KCiAgICAgIG1lLl91cGRhdGVFbGVtZW50R2VvbWV0cnkocmVjdGFuZ2xlLCBpbmRleCwgcmVzZXQsIG9wdGlvbnMpOwoKICAgICAgcmVjdGFuZ2xlLnBpdm90KCk7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfdXBkYXRlRWxlbWVudEdlb21ldHJ5OiBmdW5jdGlvbiBfdXBkYXRlRWxlbWVudEdlb21ldHJ5KHJlY3RhbmdsZSwgaW5kZXgsIHJlc2V0LCBvcHRpb25zKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IHJlY3RhbmdsZS5fbW9kZWw7CgogICAgICB2YXIgdnNjYWxlID0gbWUuX2dldFZhbHVlU2NhbGUoKTsKCiAgICAgIHZhciBiYXNlID0gdnNjYWxlLmdldEJhc2VQaXhlbCgpOwogICAgICB2YXIgaG9yaXpvbnRhbCA9IHZzY2FsZS5pc0hvcml6b250YWwoKTsKICAgICAgdmFyIHJ1bGVyID0gbWUuX3J1bGVyIHx8IG1lLmdldFJ1bGVyKCk7CiAgICAgIHZhciB2cGl4ZWxzID0gbWUuY2FsY3VsYXRlQmFyVmFsdWVQaXhlbHMobWUuaW5kZXgsIGluZGV4LCBvcHRpb25zKTsKICAgICAgdmFyIGlwaXhlbHMgPSBtZS5jYWxjdWxhdGVCYXJJbmRleFBpeGVscyhtZS5pbmRleCwgaW5kZXgsIHJ1bGVyLCBvcHRpb25zKTsKICAgICAgbW9kZWwuaG9yaXpvbnRhbCA9IGhvcml6b250YWw7CiAgICAgIG1vZGVsLmJhc2UgPSByZXNldCA/IGJhc2UgOiB2cGl4ZWxzLmJhc2U7CiAgICAgIG1vZGVsLnggPSBob3Jpem9udGFsID8gcmVzZXQgPyBiYXNlIDogdnBpeGVscy5oZWFkIDogaXBpeGVscy5jZW50ZXI7CiAgICAgIG1vZGVsLnkgPSBob3Jpem9udGFsID8gaXBpeGVscy5jZW50ZXIgOiByZXNldCA/IGJhc2UgOiB2cGl4ZWxzLmhlYWQ7CiAgICAgIG1vZGVsLmhlaWdodCA9IGhvcml6b250YWwgPyBpcGl4ZWxzLnNpemUgOiB1bmRlZmluZWQ7CiAgICAgIG1vZGVsLndpZHRoID0gaG9yaXpvbnRhbCA/IHVuZGVmaW5lZCA6IGlwaXhlbHMuc2l6ZTsKICAgIH0sCgogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgc3RhY2tzIGJhc2VkIG9uIGdyb3VwcyBhbmQgYmFyIHZpc2liaWxpdHkuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IFtsYXN0XSAtIFRoZSBkYXRhc2V0IGluZGV4DQogICAgICogQHJldHVybnMge3N0cmluZ1tdfSBUaGUgbGlzdCBvZiBzdGFjayBJRHMNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2dldFN0YWNrczogZnVuY3Rpb24gX2dldFN0YWNrcyhsYXN0KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CgogICAgICB2YXIgc2NhbGUgPSBtZS5fZ2V0SW5kZXhTY2FsZSgpOwoKICAgICAgdmFyIG1ldGFzZXRzID0gc2NhbGUuX2dldE1hdGNoaW5nVmlzaWJsZU1ldGFzKG1lLl90eXBlKTsKCiAgICAgIHZhciBzdGFja2VkID0gc2NhbGUub3B0aW9ucy5zdGFja2VkOwogICAgICB2YXIgaWxlbiA9IG1ldGFzZXRzLmxlbmd0aDsKICAgICAgdmFyIHN0YWNrcyA9IFtdOwogICAgICB2YXIgaSwgbWV0YTsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBtZXRhID0gbWV0YXNldHNbaV07IC8vIHN0YWNrZWQgICB8IG1ldGEuc3RhY2sKICAgICAgICAvLyAgICAgICAgICAgfCBmb3VuZCB8IG5vdCBmb3VuZCB8IHVuZGVmaW5lZAogICAgICAgIC8vIGZhbHNlICAgICB8ICAgeCAgIHwgICAgIHggICAgIHwgICAgIHgKICAgICAgICAvLyB0cnVlICAgICAgfCAgICAgICB8ICAgICB4ICAgICB8CiAgICAgICAgLy8gdW5kZWZpbmVkIHwgICAgICAgfCAgICAgeCAgICAgfCAgICAgeAoKICAgICAgICBpZiAoc3RhY2tlZCA9PT0gZmFsc2UgfHwgc3RhY2tzLmluZGV4T2YobWV0YS5zdGFjaykgPT09IC0xIHx8IHN0YWNrZWQgPT09IHVuZGVmaW5lZCAmJiBtZXRhLnN0YWNrID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIHN0YWNrcy5wdXNoKG1ldGEuc3RhY2spOwogICAgICAgIH0KCiAgICAgICAgaWYgKG1ldGEuaW5kZXggPT09IGxhc3QpIHsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHN0YWNrczsKICAgIH0sCgogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgZWZmZWN0aXZlIG51bWJlciBvZiBzdGFja3MgYmFzZWQgb24gZ3JvdXBzIGFuZCBiYXIgdmlzaWJpbGl0eS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgZ2V0U3RhY2tDb3VudDogZnVuY3Rpb24gZ2V0U3RhY2tDb3VudCgpIHsKICAgICAgcmV0dXJuIHRoaXMuX2dldFN0YWNrcygpLmxlbmd0aDsKICAgIH0sCgogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgc3RhY2sgaW5kZXggZm9yIHRoZSBnaXZlbiBkYXRhc2V0IGJhc2VkIG9uIGdyb3VwcyBhbmQgYmFyIHZpc2liaWxpdHkuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IFtkYXRhc2V0SW5kZXhdIC0gVGhlIGRhdGFzZXQgaW5kZXgNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW25hbWVdIC0gVGhlIHN0YWNrIG5hbWUgdG8gZmluZA0KICAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBzdGFjayBpbmRleA0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBnZXRTdGFja0luZGV4OiBmdW5jdGlvbiBnZXRTdGFja0luZGV4KGRhdGFzZXRJbmRleCwgbmFtZSkgewogICAgICB2YXIgc3RhY2tzID0gdGhpcy5fZ2V0U3RhY2tzKGRhdGFzZXRJbmRleCk7CgogICAgICB2YXIgaW5kZXggPSBuYW1lICE9PSB1bmRlZmluZWQgPyBzdGFja3MuaW5kZXhPZihuYW1lKSA6IC0xOyAvLyBpbmRleE9mIHJldHVybnMgLTEgaWYgZWxlbWVudCBpcyBub3QgcHJlc2VudAoKICAgICAgcmV0dXJuIGluZGV4ID09PSAtMSA/IHN0YWNrcy5sZW5ndGggLSAxIDogaW5kZXg7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBnZXRSdWxlcjogZnVuY3Rpb24gZ2V0UnVsZXIoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CgogICAgICB2YXIgc2NhbGUgPSBtZS5fZ2V0SW5kZXhTY2FsZSgpOwoKICAgICAgdmFyIHBpeGVscyA9IFtdOwogICAgICB2YXIgaSwgaWxlbjsKCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBtZS5nZXRNZXRhKCkuZGF0YS5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBwaXhlbHMucHVzaChzY2FsZS5nZXRQaXhlbEZvclZhbHVlKG51bGwsIGksIG1lLmluZGV4KSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgcGl4ZWxzOiBwaXhlbHMsCiAgICAgICAgc3RhcnQ6IHNjYWxlLl9zdGFydFBpeGVsLAogICAgICAgIGVuZDogc2NhbGUuX2VuZFBpeGVsLAogICAgICAgIHN0YWNrQ291bnQ6IG1lLmdldFN0YWNrQ291bnQoKSwKICAgICAgICBzY2FsZTogc2NhbGUKICAgICAgfTsKICAgIH0sCgogICAgLyoqDQogICAgICogTm90ZTogcGl4ZWwgdmFsdWVzIGFyZSBub3QgY2xhbXBlZCB0byB0aGUgc2NhbGUgYXJlYS4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgY2FsY3VsYXRlQmFyVmFsdWVQaXhlbHM6IGZ1bmN0aW9uIGNhbGN1bGF0ZUJhclZhbHVlUGl4ZWxzKGRhdGFzZXRJbmRleCwgaW5kZXgsIG9wdGlvbnMpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CgogICAgICB2YXIgc2NhbGUgPSBtZS5fZ2V0VmFsdWVTY2FsZSgpOwoKICAgICAgdmFyIGlzSG9yaXpvbnRhbCA9IHNjYWxlLmlzSG9yaXpvbnRhbCgpOwogICAgICB2YXIgZGF0YXNldHMgPSBjaGFydC5kYXRhLmRhdGFzZXRzOwoKICAgICAgdmFyIG1ldGFzZXRzID0gc2NhbGUuX2dldE1hdGNoaW5nVmlzaWJsZU1ldGFzKG1lLl90eXBlKTsKCiAgICAgIHZhciB2YWx1ZSA9IHNjYWxlLl9wYXJzZVZhbHVlKGRhdGFzZXRzW2RhdGFzZXRJbmRleF0uZGF0YVtpbmRleF0pOwoKICAgICAgdmFyIG1pbkJhckxlbmd0aCA9IG9wdGlvbnMubWluQmFyTGVuZ3RoOwogICAgICB2YXIgc3RhY2tlZCA9IHNjYWxlLm9wdGlvbnMuc3RhY2tlZDsKICAgICAgdmFyIHN0YWNrID0gbWUuZ2V0TWV0YSgpLnN0YWNrOwogICAgICB2YXIgc3RhcnQgPSB2YWx1ZS5zdGFydCA9PT0gdW5kZWZpbmVkID8gMCA6IHZhbHVlLm1heCA+PSAwICYmIHZhbHVlLm1pbiA+PSAwID8gdmFsdWUubWluIDogdmFsdWUubWF4OwogICAgICB2YXIgbGVuZ3RoID0gdmFsdWUuc3RhcnQgPT09IHVuZGVmaW5lZCA/IHZhbHVlLmVuZCA6IHZhbHVlLm1heCA+PSAwICYmIHZhbHVlLm1pbiA+PSAwID8gdmFsdWUubWF4IC0gdmFsdWUubWluIDogdmFsdWUubWluIC0gdmFsdWUubWF4OwogICAgICB2YXIgaWxlbiA9IG1ldGFzZXRzLmxlbmd0aDsKICAgICAgdmFyIGksIGltZXRhLCBpdmFsdWUsIGJhc2UsIGhlYWQsIHNpemUsIHN0YWNrTGVuZ3RoOwoKICAgICAgaWYgKHN0YWNrZWQgfHwgc3RhY2tlZCA9PT0gdW5kZWZpbmVkICYmIHN0YWNrICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgICBpbWV0YSA9IG1ldGFzZXRzW2ldOwoKICAgICAgICAgIGlmIChpbWV0YS5pbmRleCA9PT0gZGF0YXNldEluZGV4KSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChpbWV0YS5zdGFjayA9PT0gc3RhY2spIHsKICAgICAgICAgICAgc3RhY2tMZW5ndGggPSBzY2FsZS5fcGFyc2VWYWx1ZShkYXRhc2V0c1tpbWV0YS5pbmRleF0uZGF0YVtpbmRleF0pOwogICAgICAgICAgICBpdmFsdWUgPSBzdGFja0xlbmd0aC5zdGFydCA9PT0gdW5kZWZpbmVkID8gc3RhY2tMZW5ndGguZW5kIDogc3RhY2tMZW5ndGgubWluID49IDAgJiYgc3RhY2tMZW5ndGgubWF4ID49IDAgPyBzdGFja0xlbmd0aC5tYXggOiBzdGFja0xlbmd0aC5taW47CgogICAgICAgICAgICBpZiAodmFsdWUubWluIDwgMCAmJiBpdmFsdWUgPCAwIHx8IHZhbHVlLm1heCA+PSAwICYmIGl2YWx1ZSA+IDApIHsKICAgICAgICAgICAgICBzdGFydCArPSBpdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGJhc2UgPSBzY2FsZS5nZXRQaXhlbEZvclZhbHVlKHN0YXJ0KTsKICAgICAgaGVhZCA9IHNjYWxlLmdldFBpeGVsRm9yVmFsdWUoc3RhcnQgKyBsZW5ndGgpOwogICAgICBzaXplID0gaGVhZCAtIGJhc2U7CgogICAgICBpZiAobWluQmFyTGVuZ3RoICE9PSB1bmRlZmluZWQgJiYgTWF0aC5hYnMoc2l6ZSkgPCBtaW5CYXJMZW5ndGgpIHsKICAgICAgICBzaXplID0gbWluQmFyTGVuZ3RoOwoKICAgICAgICBpZiAobGVuZ3RoID49IDAgJiYgIWlzSG9yaXpvbnRhbCB8fCBsZW5ndGggPCAwICYmIGlzSG9yaXpvbnRhbCkgewogICAgICAgICAgaGVhZCA9IGJhc2UgLSBtaW5CYXJMZW5ndGg7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGhlYWQgPSBiYXNlICsgbWluQmFyTGVuZ3RoOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBzaXplOiBzaXplLAogICAgICAgIGJhc2U6IGJhc2UsCiAgICAgICAgaGVhZDogaGVhZCwKICAgICAgICBjZW50ZXI6IGhlYWQgKyBzaXplIC8gMgogICAgICB9OwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgY2FsY3VsYXRlQmFySW5kZXhQaXhlbHM6IGZ1bmN0aW9uIGNhbGN1bGF0ZUJhckluZGV4UGl4ZWxzKGRhdGFzZXRJbmRleCwgaW5kZXgsIHJ1bGVyLCBvcHRpb25zKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciByYW5nZSA9IG9wdGlvbnMuYmFyVGhpY2tuZXNzID09PSAnZmxleCcgPyBjb21wdXRlRmxleENhdGVnb3J5VHJhaXRzKGluZGV4LCBydWxlciwgb3B0aW9ucykgOiBjb21wdXRlRml0Q2F0ZWdvcnlUcmFpdHMoaW5kZXgsIHJ1bGVyLCBvcHRpb25zKTsKICAgICAgdmFyIHN0YWNrSW5kZXggPSBtZS5nZXRTdGFja0luZGV4KGRhdGFzZXRJbmRleCwgbWUuZ2V0TWV0YSgpLnN0YWNrKTsKICAgICAgdmFyIGNlbnRlciA9IHJhbmdlLnN0YXJ0ICsgcmFuZ2UuY2h1bmsgKiBzdGFja0luZGV4ICsgcmFuZ2UuY2h1bmsgLyAyOwogICAgICB2YXIgc2l6ZSA9IE1hdGgubWluKHZhbHVlT3JEZWZhdWx0JDMob3B0aW9ucy5tYXhCYXJUaGlja25lc3MsIEluZmluaXR5KSwgcmFuZ2UuY2h1bmsgKiByYW5nZS5yYXRpbyk7CiAgICAgIHJldHVybiB7CiAgICAgICAgYmFzZTogY2VudGVyIC0gc2l6ZSAvIDIsCiAgICAgICAgaGVhZDogY2VudGVyICsgc2l6ZSAvIDIsCiAgICAgICAgY2VudGVyOiBjZW50ZXIsCiAgICAgICAgc2l6ZTogc2l6ZQogICAgICB9OwogICAgfSwKICAgIGRyYXc6IGZ1bmN0aW9uIGRyYXcoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBjaGFydCA9IG1lLmNoYXJ0OwoKICAgICAgdmFyIHNjYWxlID0gbWUuX2dldFZhbHVlU2NhbGUoKTsKCiAgICAgIHZhciByZWN0cyA9IG1lLmdldE1ldGEoKS5kYXRhOwogICAgICB2YXIgZGF0YXNldCA9IG1lLmdldERhdGFzZXQoKTsKICAgICAgdmFyIGlsZW4gPSByZWN0cy5sZW5ndGg7CiAgICAgIHZhciBpID0gMDsKICAgICAgaGVscGVycyQxLmNhbnZhcy5jbGlwQXJlYShjaGFydC5jdHgsIGNoYXJ0LmNoYXJ0QXJlYSk7CgogICAgICBmb3IgKDsgaSA8IGlsZW47ICsraSkgewogICAgICAgIHZhciB2YWwgPSBzY2FsZS5fcGFyc2VWYWx1ZShkYXRhc2V0LmRhdGFbaV0pOwoKICAgICAgICBpZiAoIWlzTmFOKHZhbC5taW4pICYmICFpc05hTih2YWwubWF4KSkgewogICAgICAgICAgcmVjdHNbaV0uZHJhdygpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaGVscGVycyQxLmNhbnZhcy51bmNsaXBBcmVhKGNoYXJ0LmN0eCk7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfcmVzb2x2ZURhdGFFbGVtZW50T3B0aW9uczogZnVuY3Rpb24gX3Jlc29sdmVEYXRhRWxlbWVudE9wdGlvbnMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciB2YWx1ZXMgPSBoZWxwZXJzJDEuZXh0ZW5kKHt9LCBjb3JlX2RhdGFzZXRDb250cm9sbGVyLnByb3RvdHlwZS5fcmVzb2x2ZURhdGFFbGVtZW50T3B0aW9ucy5hcHBseShtZSwgYXJndW1lbnRzKSk7CgogICAgICB2YXIgaW5kZXhPcHRzID0gbWUuX2dldEluZGV4U2NhbGUoKS5vcHRpb25zOwoKICAgICAgdmFyIHZhbHVlT3B0cyA9IG1lLl9nZXRWYWx1ZVNjYWxlKCkub3B0aW9uczsKCiAgICAgIHZhbHVlcy5iYXJQZXJjZW50YWdlID0gdmFsdWVPckRlZmF1bHQkMyhpbmRleE9wdHMuYmFyUGVyY2VudGFnZSwgdmFsdWVzLmJhclBlcmNlbnRhZ2UpOwogICAgICB2YWx1ZXMuYmFyVGhpY2tuZXNzID0gdmFsdWVPckRlZmF1bHQkMyhpbmRleE9wdHMuYmFyVGhpY2tuZXNzLCB2YWx1ZXMuYmFyVGhpY2tuZXNzKTsKICAgICAgdmFsdWVzLmNhdGVnb3J5UGVyY2VudGFnZSA9IHZhbHVlT3JEZWZhdWx0JDMoaW5kZXhPcHRzLmNhdGVnb3J5UGVyY2VudGFnZSwgdmFsdWVzLmNhdGVnb3J5UGVyY2VudGFnZSk7CiAgICAgIHZhbHVlcy5tYXhCYXJUaGlja25lc3MgPSB2YWx1ZU9yRGVmYXVsdCQzKGluZGV4T3B0cy5tYXhCYXJUaGlja25lc3MsIHZhbHVlcy5tYXhCYXJUaGlja25lc3MpOwogICAgICB2YWx1ZXMubWluQmFyTGVuZ3RoID0gdmFsdWVPckRlZmF1bHQkMyh2YWx1ZU9wdHMubWluQmFyTGVuZ3RoLCB2YWx1ZXMubWluQmFyTGVuZ3RoKTsKICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0KICB9KTsKICB2YXIgdmFsdWVPckRlZmF1bHQkNCA9IGhlbHBlcnMkMS52YWx1ZU9yRGVmYXVsdDsKICB2YXIgcmVzb2x2ZSQxID0gaGVscGVycyQxLm9wdGlvbnMucmVzb2x2ZTsKCiAgY29yZV9kZWZhdWx0cy5fc2V0KCdidWJibGUnLCB7CiAgICBob3ZlcjogewogICAgICBtb2RlOiAnc2luZ2xlJwogICAgfSwKICAgIHNjYWxlczogewogICAgICB4QXhlczogW3sKICAgICAgICB0eXBlOiAnbGluZWFyJywKICAgICAgICAvLyBidWJibGUgc2hvdWxkIHByb2JhYmx5IHVzZSBhIGxpbmVhciBzY2FsZSBieSBkZWZhdWx0CiAgICAgICAgcG9zaXRpb246ICdib3R0b20nLAogICAgICAgIGlkOiAneC1heGlzLTAnIC8vIG5lZWQgYW4gSUQgc28gZGF0YXNldHMgY2FuIHJlZmVyZW5jZSB0aGUgc2NhbGUKCiAgICAgIH1dLAogICAgICB5QXhlczogW3sKICAgICAgICB0eXBlOiAnbGluZWFyJywKICAgICAgICBwb3NpdGlvbjogJ2xlZnQnLAogICAgICAgIGlkOiAneS1heGlzLTAnCiAgICAgIH1dCiAgICB9LAogICAgdG9vbHRpcHM6IHsKICAgICAgY2FsbGJhY2tzOiB7CiAgICAgICAgdGl0bGU6IGZ1bmN0aW9uIHRpdGxlKCkgewogICAgICAgICAgLy8gVGl0bGUgZG9lc24ndCBtYWtlIHNlbnNlIGZvciBzY2F0dGVyIHNpbmNlIHdlIGZvcm1hdCB0aGUgZGF0YSBhcyBhIHBvaW50CiAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfSwKICAgICAgICBsYWJlbDogZnVuY3Rpb24gbGFiZWwoaXRlbSwgZGF0YSkgewogICAgICAgICAgdmFyIGRhdGFzZXRMYWJlbCA9IGRhdGEuZGF0YXNldHNbaXRlbS5kYXRhc2V0SW5kZXhdLmxhYmVsIHx8ICcnOwogICAgICAgICAgdmFyIGRhdGFQb2ludCA9IGRhdGEuZGF0YXNldHNbaXRlbS5kYXRhc2V0SW5kZXhdLmRhdGFbaXRlbS5pbmRleF07CiAgICAgICAgICByZXR1cm4gZGF0YXNldExhYmVsICsgJzogKCcgKyBpdGVtLnhMYWJlbCArICcsICcgKyBpdGVtLnlMYWJlbCArICcsICcgKyBkYXRhUG9pbnQuciArICcpJzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKCiAgdmFyIGNvbnRyb2xsZXJfYnViYmxlID0gY29yZV9kYXRhc2V0Q29udHJvbGxlci5leHRlbmQoewogICAgLyoqDQogICAgICogQHByb3RlY3RlZA0KICAgICAqLwogICAgZGF0YUVsZW1lbnRUeXBlOiBlbGVtZW50cy5Qb2ludCwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2RhdGFFbGVtZW50T3B0aW9uczogWydiYWNrZ3JvdW5kQ29sb3InLCAnYm9yZGVyQ29sb3InLCAnYm9yZGVyV2lkdGgnLCAnaG92ZXJCYWNrZ3JvdW5kQ29sb3InLCAnaG92ZXJCb3JkZXJDb2xvcicsICdob3ZlckJvcmRlcldpZHRoJywgJ2hvdmVyUmFkaXVzJywgJ2hpdFJhZGl1cycsICdwb2ludFN0eWxlJywgJ3JvdGF0aW9uJ10sCgogICAgLyoqDQogICAgICogQHByb3RlY3RlZA0KICAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUocmVzZXQpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7CiAgICAgIHZhciBwb2ludHMgPSBtZXRhLmRhdGE7IC8vIFVwZGF0ZSBQb2ludHMKCiAgICAgIGhlbHBlcnMkMS5lYWNoKHBvaW50cywgZnVuY3Rpb24gKHBvaW50LCBpbmRleCkgewogICAgICAgIG1lLnVwZGF0ZUVsZW1lbnQocG9pbnQsIGluZGV4LCByZXNldCk7CiAgICAgIH0pOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJvdGVjdGVkDQogICAgICovCiAgICB1cGRhdGVFbGVtZW50OiBmdW5jdGlvbiB1cGRhdGVFbGVtZW50KHBvaW50LCBpbmRleCwgcmVzZXQpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7CiAgICAgIHZhciBjdXN0b20gPSBwb2ludC5jdXN0b20gfHwge307CiAgICAgIHZhciB4U2NhbGUgPSBtZS5nZXRTY2FsZUZvcklkKG1ldGEueEF4aXNJRCk7CiAgICAgIHZhciB5U2NhbGUgPSBtZS5nZXRTY2FsZUZvcklkKG1ldGEueUF4aXNJRCk7CgogICAgICB2YXIgb3B0aW9ucyA9IG1lLl9yZXNvbHZlRGF0YUVsZW1lbnRPcHRpb25zKHBvaW50LCBpbmRleCk7CgogICAgICB2YXIgZGF0YSA9IG1lLmdldERhdGFzZXQoKS5kYXRhW2luZGV4XTsKICAgICAgdmFyIGRzSW5kZXggPSBtZS5pbmRleDsKICAgICAgdmFyIHggPSByZXNldCA/IHhTY2FsZS5nZXRQaXhlbEZvckRlY2ltYWwoMC41KSA6IHhTY2FsZS5nZXRQaXhlbEZvclZhbHVlKF90eXBlb2YoZGF0YSkgPT09ICdvYmplY3QnID8gZGF0YSA6IE5hTiwgaW5kZXgsIGRzSW5kZXgpOwogICAgICB2YXIgeSA9IHJlc2V0ID8geVNjYWxlLmdldEJhc2VQaXhlbCgpIDogeVNjYWxlLmdldFBpeGVsRm9yVmFsdWUoZGF0YSwgaW5kZXgsIGRzSW5kZXgpOwogICAgICBwb2ludC5feFNjYWxlID0geFNjYWxlOwogICAgICBwb2ludC5feVNjYWxlID0geVNjYWxlOwogICAgICBwb2ludC5fb3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHBvaW50Ll9kYXRhc2V0SW5kZXggPSBkc0luZGV4OwogICAgICBwb2ludC5faW5kZXggPSBpbmRleDsKICAgICAgcG9pbnQuX21vZGVsID0gewogICAgICAgIGJhY2tncm91bmRDb2xvcjogb3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IsCiAgICAgICAgYm9yZGVyQ29sb3I6IG9wdGlvbnMuYm9yZGVyQ29sb3IsCiAgICAgICAgYm9yZGVyV2lkdGg6IG9wdGlvbnMuYm9yZGVyV2lkdGgsCiAgICAgICAgaGl0UmFkaXVzOiBvcHRpb25zLmhpdFJhZGl1cywKICAgICAgICBwb2ludFN0eWxlOiBvcHRpb25zLnBvaW50U3R5bGUsCiAgICAgICAgcm90YXRpb246IG9wdGlvbnMucm90YXRpb24sCiAgICAgICAgcmFkaXVzOiByZXNldCA/IDAgOiBvcHRpb25zLnJhZGl1cywKICAgICAgICBza2lwOiBjdXN0b20uc2tpcCB8fCBpc05hTih4KSB8fCBpc05hTih5KSwKICAgICAgICB4OiB4LAogICAgICAgIHk6IHkKICAgICAgfTsKICAgICAgcG9pbnQucGl2b3QoKTsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByb3RlY3RlZA0KICAgICAqLwogICAgc2V0SG92ZXJTdHlsZTogZnVuY3Rpb24gc2V0SG92ZXJTdHlsZShwb2ludCkgewogICAgICB2YXIgbW9kZWwgPSBwb2ludC5fbW9kZWw7CiAgICAgIHZhciBvcHRpb25zID0gcG9pbnQuX29wdGlvbnM7CiAgICAgIHZhciBnZXRIb3ZlckNvbG9yID0gaGVscGVycyQxLmdldEhvdmVyQ29sb3I7CiAgICAgIHBvaW50LiRwcmV2aW91c1N0eWxlID0gewogICAgICAgIGJhY2tncm91bmRDb2xvcjogbW9kZWwuYmFja2dyb3VuZENvbG9yLAogICAgICAgIGJvcmRlckNvbG9yOiBtb2RlbC5ib3JkZXJDb2xvciwKICAgICAgICBib3JkZXJXaWR0aDogbW9kZWwuYm9yZGVyV2lkdGgsCiAgICAgICAgcmFkaXVzOiBtb2RlbC5yYWRpdXMKICAgICAgfTsKICAgICAgbW9kZWwuYmFja2dyb3VuZENvbG9yID0gdmFsdWVPckRlZmF1bHQkNChvcHRpb25zLmhvdmVyQmFja2dyb3VuZENvbG9yLCBnZXRIb3ZlckNvbG9yKG9wdGlvbnMuYmFja2dyb3VuZENvbG9yKSk7CiAgICAgIG1vZGVsLmJvcmRlckNvbG9yID0gdmFsdWVPckRlZmF1bHQkNChvcHRpb25zLmhvdmVyQm9yZGVyQ29sb3IsIGdldEhvdmVyQ29sb3Iob3B0aW9ucy5ib3JkZXJDb2xvcikpOwogICAgICBtb2RlbC5ib3JkZXJXaWR0aCA9IHZhbHVlT3JEZWZhdWx0JDQob3B0aW9ucy5ob3ZlckJvcmRlcldpZHRoLCBvcHRpb25zLmJvcmRlcldpZHRoKTsKICAgICAgbW9kZWwucmFkaXVzID0gb3B0aW9ucy5yYWRpdXMgKyBvcHRpb25zLmhvdmVyUmFkaXVzOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX3Jlc29sdmVEYXRhRWxlbWVudE9wdGlvbnM6IGZ1bmN0aW9uIF9yZXNvbHZlRGF0YUVsZW1lbnRPcHRpb25zKHBvaW50LCBpbmRleCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgY2hhcnQgPSBtZS5jaGFydDsKICAgICAgdmFyIGRhdGFzZXQgPSBtZS5nZXREYXRhc2V0KCk7CiAgICAgIHZhciBjdXN0b20gPSBwb2ludC5jdXN0b20gfHwge307CiAgICAgIHZhciBkYXRhID0gZGF0YXNldC5kYXRhW2luZGV4XSB8fCB7fTsKCiAgICAgIHZhciB2YWx1ZXMgPSBjb3JlX2RhdGFzZXRDb250cm9sbGVyLnByb3RvdHlwZS5fcmVzb2x2ZURhdGFFbGVtZW50T3B0aW9ucy5hcHBseShtZSwgYXJndW1lbnRzKTsgLy8gU2NyaXB0YWJsZSBvcHRpb25zCgoKICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgY2hhcnQ6IGNoYXJ0LAogICAgICAgIGRhdGFJbmRleDogaW5kZXgsCiAgICAgICAgZGF0YXNldDogZGF0YXNldCwKICAgICAgICBkYXRhc2V0SW5kZXg6IG1lLmluZGV4CiAgICAgIH07IC8vIEluIGNhc2UgdmFsdWVzIHdlcmUgY2FjaGVkIChhbmQgdGh1cyBmcm96ZW4pLCB3ZSBuZWVkIHRvIGNsb25lIHRoZSB2YWx1ZXMKCiAgICAgIGlmIChtZS5fY2FjaGVkRGF0YU9wdHMgPT09IHZhbHVlcykgewogICAgICAgIHZhbHVlcyA9IGhlbHBlcnMkMS5leHRlbmQoe30sIHZhbHVlcyk7CiAgICAgIH0gLy8gQ3VzdG9tIHJhZGl1cyByZXNvbHV0aW9uCgoKICAgICAgdmFsdWVzLnJhZGl1cyA9IHJlc29sdmUkMShbY3VzdG9tLnJhZGl1cywgZGF0YS5yLCBtZS5fY29uZmlnLnJhZGl1cywgY2hhcnQub3B0aW9ucy5lbGVtZW50cy5wb2ludC5yYWRpdXNdLCBjb250ZXh0LCBpbmRleCk7CiAgICAgIHJldHVybiB2YWx1ZXM7CiAgICB9CiAgfSk7CiAgdmFyIHZhbHVlT3JEZWZhdWx0JDUgPSBoZWxwZXJzJDEudmFsdWVPckRlZmF1bHQ7CiAgdmFyIFBJJDEgPSBNYXRoLlBJOwogIHZhciBET1VCTEVfUEkkMSA9IFBJJDEgKiAyOwogIHZhciBIQUxGX1BJJDEgPSBQSSQxIC8gMjsKCiAgY29yZV9kZWZhdWx0cy5fc2V0KCdkb3VnaG51dCcsIHsKICAgIGFuaW1hdGlvbjogewogICAgICAvLyBCb29sZWFuIC0gV2hldGhlciB3ZSBhbmltYXRlIHRoZSByb3RhdGlvbiBvZiB0aGUgRG91Z2hudXQKICAgICAgYW5pbWF0ZVJvdGF0ZTogdHJ1ZSwKICAgICAgLy8gQm9vbGVhbiAtIFdoZXRoZXIgd2UgYW5pbWF0ZSBzY2FsaW5nIHRoZSBEb3VnaG51dCBmcm9tIHRoZSBjZW50cmUKICAgICAgYW5pbWF0ZVNjYWxlOiBmYWxzZQogICAgfSwKICAgIGhvdmVyOiB7CiAgICAgIG1vZGU6ICdzaW5nbGUnCiAgICB9LAogICAgbGVnZW5kQ2FsbGJhY2s6IGZ1bmN0aW9uIGxlZ2VuZENhbGxiYWNrKGNoYXJ0KSB7CiAgICAgIHZhciBsaXN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndWwnKTsKICAgICAgdmFyIGRhdGEgPSBjaGFydC5kYXRhOwogICAgICB2YXIgZGF0YXNldHMgPSBkYXRhLmRhdGFzZXRzOwogICAgICB2YXIgbGFiZWxzID0gZGF0YS5sYWJlbHM7CiAgICAgIHZhciBpLCBpbGVuLCBsaXN0SXRlbSwgbGlzdEl0ZW1TcGFuOwogICAgICBsaXN0LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBjaGFydC5pZCArICctbGVnZW5kJyk7CgogICAgICBpZiAoZGF0YXNldHMubGVuZ3RoKSB7CiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGRhdGFzZXRzWzBdLmRhdGEubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgICBsaXN0SXRlbSA9IGxpc3QuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbGknKSk7CiAgICAgICAgICBsaXN0SXRlbVNwYW4gPSBsaXN0SXRlbS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJykpOwogICAgICAgICAgbGlzdEl0ZW1TcGFuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGRhdGFzZXRzWzBdLmJhY2tncm91bmRDb2xvcltpXTsKCiAgICAgICAgICBpZiAobGFiZWxzW2ldKSB7CiAgICAgICAgICAgIGxpc3RJdGVtLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGxhYmVsc1tpXSkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGxpc3Qub3V0ZXJIVE1MOwogICAgfSwKICAgIGxlZ2VuZDogewogICAgICBsYWJlbHM6IHsKICAgICAgICBnZW5lcmF0ZUxhYmVsczogZnVuY3Rpb24gZ2VuZXJhdGVMYWJlbHMoY2hhcnQpIHsKICAgICAgICAgIHZhciBkYXRhID0gY2hhcnQuZGF0YTsKCiAgICAgICAgICBpZiAoZGF0YS5sYWJlbHMubGVuZ3RoICYmIGRhdGEuZGF0YXNldHMubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybiBkYXRhLmxhYmVscy5tYXAoZnVuY3Rpb24gKGxhYmVsLCBpKSB7CiAgICAgICAgICAgICAgdmFyIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YSgwKTsKICAgICAgICAgICAgICB2YXIgc3R5bGUgPSBtZXRhLmNvbnRyb2xsZXIuZ2V0U3R5bGUoaSk7CiAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHRleHQ6IGxhYmVsLAogICAgICAgICAgICAgICAgZmlsbFN0eWxlOiBzdHlsZS5iYWNrZ3JvdW5kQ29sb3IsCiAgICAgICAgICAgICAgICBzdHJva2VTdHlsZTogc3R5bGUuYm9yZGVyQ29sb3IsCiAgICAgICAgICAgICAgICBsaW5lV2lkdGg6IHN0eWxlLmJvcmRlcldpZHRoLAogICAgICAgICAgICAgICAgaGlkZGVuOiBpc05hTihkYXRhLmRhdGFzZXRzWzBdLmRhdGFbaV0pIHx8IG1ldGEuZGF0YVtpXS5oaWRkZW4sCiAgICAgICAgICAgICAgICAvLyBFeHRyYSBkYXRhIHVzZWQgZm9yIHRvZ2dsaW5nIHRoZSBjb3JyZWN0IGl0ZW0KICAgICAgICAgICAgICAgIGluZGV4OiBpCiAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIFtdOwogICAgICAgIH0KICAgICAgfSwKICAgICAgb25DbGljazogZnVuY3Rpb24gb25DbGljayhlLCBsZWdlbmRJdGVtKSB7CiAgICAgICAgdmFyIGluZGV4ID0gbGVnZW5kSXRlbS5pbmRleDsKICAgICAgICB2YXIgY2hhcnQgPSB0aGlzLmNoYXJ0OwogICAgICAgIHZhciBpLCBpbGVuLCBtZXRhOwoKICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gKGNoYXJ0LmRhdGEuZGF0YXNldHMgfHwgW10pLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewogICAgICAgICAgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGkpOyAvLyB0b2dnbGUgdmlzaWJpbGl0eSBvZiBpbmRleCBpZiBleGlzdHMKCiAgICAgICAgICBpZiAobWV0YS5kYXRhW2luZGV4XSkgewogICAgICAgICAgICBtZXRhLmRhdGFbaW5kZXhdLmhpZGRlbiA9ICFtZXRhLmRhdGFbaW5kZXhdLmhpZGRlbjsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGNoYXJ0LnVwZGF0ZSgpOwogICAgICB9CiAgICB9LAogICAgLy8gVGhlIHBlcmNlbnRhZ2Ugb2YgdGhlIGNoYXJ0IHRoYXQgd2UgY3V0IG91dCBvZiB0aGUgbWlkZGxlLgogICAgY3V0b3V0UGVyY2VudGFnZTogNTAsCiAgICAvLyBUaGUgcm90YXRpb24gb2YgdGhlIGNoYXJ0LCB3aGVyZSB0aGUgZmlyc3QgZGF0YSBhcmMgYmVnaW5zLgogICAgcm90YXRpb246IC1IQUxGX1BJJDEsCiAgICAvLyBUaGUgdG90YWwgY2lyY3VtZmVyZW5jZSBvZiB0aGUgY2hhcnQuCiAgICBjaXJjdW1mZXJlbmNlOiBET1VCTEVfUEkkMSwKICAgIC8vIE5lZWQgdG8gb3ZlcnJpZGUgdGhlc2UgdG8gZ2l2ZSBhIG5pY2UgZGVmYXVsdAogICAgdG9vbHRpcHM6IHsKICAgICAgY2FsbGJhY2tzOiB7CiAgICAgICAgdGl0bGU6IGZ1bmN0aW9uIHRpdGxlKCkgewogICAgICAgICAgcmV0dXJuICcnOwogICAgICAgIH0sCiAgICAgICAgbGFiZWw6IGZ1bmN0aW9uIGxhYmVsKHRvb2x0aXBJdGVtLCBkYXRhKSB7CiAgICAgICAgICB2YXIgZGF0YUxhYmVsID0gZGF0YS5sYWJlbHNbdG9vbHRpcEl0ZW0uaW5kZXhdOwogICAgICAgICAgdmFyIHZhbHVlID0gJzogJyArIGRhdGEuZGF0YXNldHNbdG9vbHRpcEl0ZW0uZGF0YXNldEluZGV4XS5kYXRhW3Rvb2x0aXBJdGVtLmluZGV4XTsKCiAgICAgICAgICBpZiAoaGVscGVycyQxLmlzQXJyYXkoZGF0YUxhYmVsKSkgewogICAgICAgICAgICAvLyBzaG93IHZhbHVlIG9uIGZpcnN0IGxpbmUgb2YgbXVsdGlsaW5lIGxhYmVsCiAgICAgICAgICAgIC8vIG5lZWQgdG8gY2xvbmUgYmVjYXVzZSB3ZSBhcmUgY2hhbmdpbmcgdGhlIHZhbHVlCiAgICAgICAgICAgIGRhdGFMYWJlbCA9IGRhdGFMYWJlbC5zbGljZSgpOwogICAgICAgICAgICBkYXRhTGFiZWxbMF0gKz0gdmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkYXRhTGFiZWwgKz0gdmFsdWU7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGRhdGFMYWJlbDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKCiAgdmFyIGNvbnRyb2xsZXJfZG91Z2hudXQgPSBjb3JlX2RhdGFzZXRDb250cm9sbGVyLmV4dGVuZCh7CiAgICBkYXRhRWxlbWVudFR5cGU6IGVsZW1lbnRzLkFyYywKICAgIGxpbmtTY2FsZXM6IGhlbHBlcnMkMS5ub29wLAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZGF0YUVsZW1lbnRPcHRpb25zOiBbJ2JhY2tncm91bmRDb2xvcicsICdib3JkZXJDb2xvcicsICdib3JkZXJXaWR0aCcsICdib3JkZXJBbGlnbicsICdob3ZlckJhY2tncm91bmRDb2xvcicsICdob3ZlckJvcmRlckNvbG9yJywgJ2hvdmVyQm9yZGVyV2lkdGgnXSwKICAgIC8vIEdldCBpbmRleCBvZiB0aGUgZGF0YXNldCBpbiByZWxhdGlvbiB0byB0aGUgdmlzaWJsZSBkYXRhc2V0cy4gVGhpcyBhbGxvd3MgZGV0ZXJtaW5pbmcgdGhlIGlubmVyIGFuZCBvdXRlciByYWRpdXMgY29ycmVjdGx5CiAgICBnZXRSaW5nSW5kZXg6IGZ1bmN0aW9uIGdldFJpbmdJbmRleChkYXRhc2V0SW5kZXgpIHsKICAgICAgdmFyIHJpbmdJbmRleCA9IDA7CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGRhdGFzZXRJbmRleDsgKytqKSB7CiAgICAgICAgaWYgKHRoaXMuY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShqKSkgewogICAgICAgICAgKytyaW5nSW5kZXg7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gcmluZ0luZGV4OwogICAgfSwKICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKHJlc2V0KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBjaGFydCA9IG1lLmNoYXJ0OwogICAgICB2YXIgY2hhcnRBcmVhID0gY2hhcnQuY2hhcnRBcmVhOwogICAgICB2YXIgb3B0cyA9IGNoYXJ0Lm9wdGlvbnM7CiAgICAgIHZhciByYXRpb1ggPSAxOwogICAgICB2YXIgcmF0aW9ZID0gMTsKICAgICAgdmFyIG9mZnNldFggPSAwOwogICAgICB2YXIgb2Zmc2V0WSA9IDA7CiAgICAgIHZhciBtZXRhID0gbWUuZ2V0TWV0YSgpOwogICAgICB2YXIgYXJjcyA9IG1ldGEuZGF0YTsKICAgICAgdmFyIGN1dG91dCA9IG9wdHMuY3V0b3V0UGVyY2VudGFnZSAvIDEwMCB8fCAwOwogICAgICB2YXIgY2lyY3VtZmVyZW5jZSA9IG9wdHMuY2lyY3VtZmVyZW5jZTsKCiAgICAgIHZhciBjaGFydFdlaWdodCA9IG1lLl9nZXRSaW5nV2VpZ2h0KG1lLmluZGV4KTsKCiAgICAgIHZhciBtYXhXaWR0aCwgbWF4SGVpZ2h0LCBpLCBpbGVuOyAvLyBJZiB0aGUgY2hhcnQncyBjaXJjdW1mZXJlbmNlIGlzbid0IGEgZnVsbCBjaXJjbGUsIGNhbGN1bGF0ZSBzaXplIGFzIGEgcmF0aW8gb2YgdGhlIHdpZHRoL2hlaWdodCBvZiB0aGUgYXJjCgogICAgICBpZiAoY2lyY3VtZmVyZW5jZSA8IERPVUJMRV9QSSQxKSB7CiAgICAgICAgdmFyIHN0YXJ0QW5nbGUgPSBvcHRzLnJvdGF0aW9uICUgRE9VQkxFX1BJJDE7CiAgICAgICAgc3RhcnRBbmdsZSArPSBzdGFydEFuZ2xlID49IFBJJDEgPyAtRE9VQkxFX1BJJDEgOiBzdGFydEFuZ2xlIDwgLVBJJDEgPyBET1VCTEVfUEkkMSA6IDA7CiAgICAgICAgdmFyIGVuZEFuZ2xlID0gc3RhcnRBbmdsZSArIGNpcmN1bWZlcmVuY2U7CiAgICAgICAgdmFyIHN0YXJ0WCA9IE1hdGguY29zKHN0YXJ0QW5nbGUpOwogICAgICAgIHZhciBzdGFydFkgPSBNYXRoLnNpbihzdGFydEFuZ2xlKTsKICAgICAgICB2YXIgZW5kWCA9IE1hdGguY29zKGVuZEFuZ2xlKTsKICAgICAgICB2YXIgZW5kWSA9IE1hdGguc2luKGVuZEFuZ2xlKTsKICAgICAgICB2YXIgY29udGFpbnMwID0gc3RhcnRBbmdsZSA8PSAwICYmIGVuZEFuZ2xlID49IDAgfHwgZW5kQW5nbGUgPj0gRE9VQkxFX1BJJDE7CiAgICAgICAgdmFyIGNvbnRhaW5zOTAgPSBzdGFydEFuZ2xlIDw9IEhBTEZfUEkkMSAmJiBlbmRBbmdsZSA+PSBIQUxGX1BJJDEgfHwgZW5kQW5nbGUgPj0gRE9VQkxFX1BJJDEgKyBIQUxGX1BJJDE7CiAgICAgICAgdmFyIGNvbnRhaW5zMTgwID0gc3RhcnRBbmdsZSA9PT0gLVBJJDEgfHwgZW5kQW5nbGUgPj0gUEkkMTsKICAgICAgICB2YXIgY29udGFpbnMyNzAgPSBzdGFydEFuZ2xlIDw9IC1IQUxGX1BJJDEgJiYgZW5kQW5nbGUgPj0gLUhBTEZfUEkkMSB8fCBlbmRBbmdsZSA+PSBQSSQxICsgSEFMRl9QSSQxOwogICAgICAgIHZhciBtaW5YID0gY29udGFpbnMxODAgPyAtMSA6IE1hdGgubWluKHN0YXJ0WCwgc3RhcnRYICogY3V0b3V0LCBlbmRYLCBlbmRYICogY3V0b3V0KTsKICAgICAgICB2YXIgbWluWSA9IGNvbnRhaW5zMjcwID8gLTEgOiBNYXRoLm1pbihzdGFydFksIHN0YXJ0WSAqIGN1dG91dCwgZW5kWSwgZW5kWSAqIGN1dG91dCk7CiAgICAgICAgdmFyIG1heFggPSBjb250YWluczAgPyAxIDogTWF0aC5tYXgoc3RhcnRYLCBzdGFydFggKiBjdXRvdXQsIGVuZFgsIGVuZFggKiBjdXRvdXQpOwogICAgICAgIHZhciBtYXhZID0gY29udGFpbnM5MCA/IDEgOiBNYXRoLm1heChzdGFydFksIHN0YXJ0WSAqIGN1dG91dCwgZW5kWSwgZW5kWSAqIGN1dG91dCk7CiAgICAgICAgcmF0aW9YID0gKG1heFggLSBtaW5YKSAvIDI7CiAgICAgICAgcmF0aW9ZID0gKG1heFkgLSBtaW5ZKSAvIDI7CiAgICAgICAgb2Zmc2V0WCA9IC0obWF4WCArIG1pblgpIC8gMjsKICAgICAgICBvZmZzZXRZID0gLShtYXhZICsgbWluWSkgLyAyOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gYXJjcy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBhcmNzW2ldLl9vcHRpb25zID0gbWUuX3Jlc29sdmVEYXRhRWxlbWVudE9wdGlvbnMoYXJjc1tpXSwgaSk7CiAgICAgIH0KCiAgICAgIGNoYXJ0LmJvcmRlcldpZHRoID0gbWUuZ2V0TWF4Qm9yZGVyV2lkdGgoKTsKICAgICAgbWF4V2lkdGggPSAoY2hhcnRBcmVhLnJpZ2h0IC0gY2hhcnRBcmVhLmxlZnQgLSBjaGFydC5ib3JkZXJXaWR0aCkgLyByYXRpb1g7CiAgICAgIG1heEhlaWdodCA9IChjaGFydEFyZWEuYm90dG9tIC0gY2hhcnRBcmVhLnRvcCAtIGNoYXJ0LmJvcmRlcldpZHRoKSAvIHJhdGlvWTsKICAgICAgY2hhcnQub3V0ZXJSYWRpdXMgPSBNYXRoLm1heChNYXRoLm1pbihtYXhXaWR0aCwgbWF4SGVpZ2h0KSAvIDIsIDApOwogICAgICBjaGFydC5pbm5lclJhZGl1cyA9IE1hdGgubWF4KGNoYXJ0Lm91dGVyUmFkaXVzICogY3V0b3V0LCAwKTsKICAgICAgY2hhcnQucmFkaXVzTGVuZ3RoID0gKGNoYXJ0Lm91dGVyUmFkaXVzIC0gY2hhcnQuaW5uZXJSYWRpdXMpIC8gKG1lLl9nZXRWaXNpYmxlRGF0YXNldFdlaWdodFRvdGFsKCkgfHwgMSk7CiAgICAgIGNoYXJ0Lm9mZnNldFggPSBvZmZzZXRYICogY2hhcnQub3V0ZXJSYWRpdXM7CiAgICAgIGNoYXJ0Lm9mZnNldFkgPSBvZmZzZXRZICogY2hhcnQub3V0ZXJSYWRpdXM7CiAgICAgIG1ldGEudG90YWwgPSBtZS5jYWxjdWxhdGVUb3RhbCgpOwogICAgICBtZS5vdXRlclJhZGl1cyA9IGNoYXJ0Lm91dGVyUmFkaXVzIC0gY2hhcnQucmFkaXVzTGVuZ3RoICogbWUuX2dldFJpbmdXZWlnaHRPZmZzZXQobWUuaW5kZXgpOwogICAgICBtZS5pbm5lclJhZGl1cyA9IE1hdGgubWF4KG1lLm91dGVyUmFkaXVzIC0gY2hhcnQucmFkaXVzTGVuZ3RoICogY2hhcnRXZWlnaHQsIDApOwoKICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGFyY3MubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgbWUudXBkYXRlRWxlbWVudChhcmNzW2ldLCBpLCByZXNldCk7CiAgICAgIH0KICAgIH0sCiAgICB1cGRhdGVFbGVtZW50OiBmdW5jdGlvbiB1cGRhdGVFbGVtZW50KGFyYywgaW5kZXgsIHJlc2V0KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBjaGFydCA9IG1lLmNoYXJ0OwogICAgICB2YXIgY2hhcnRBcmVhID0gY2hhcnQuY2hhcnRBcmVhOwogICAgICB2YXIgb3B0cyA9IGNoYXJ0Lm9wdGlvbnM7CiAgICAgIHZhciBhbmltYXRpb25PcHRzID0gb3B0cy5hbmltYXRpb247CiAgICAgIHZhciBjZW50ZXJYID0gKGNoYXJ0QXJlYS5sZWZ0ICsgY2hhcnRBcmVhLnJpZ2h0KSAvIDI7CiAgICAgIHZhciBjZW50ZXJZID0gKGNoYXJ0QXJlYS50b3AgKyBjaGFydEFyZWEuYm90dG9tKSAvIDI7CiAgICAgIHZhciBzdGFydEFuZ2xlID0gb3B0cy5yb3RhdGlvbjsgLy8gbm9uIHJlc2V0IGNhc2UgaGFuZGxlZCBsYXRlcgoKICAgICAgdmFyIGVuZEFuZ2xlID0gb3B0cy5yb3RhdGlvbjsgLy8gbm9uIHJlc2V0IGNhc2UgaGFuZGxlZCBsYXRlcgoKICAgICAgdmFyIGRhdGFzZXQgPSBtZS5nZXREYXRhc2V0KCk7CiAgICAgIHZhciBjaXJjdW1mZXJlbmNlID0gcmVzZXQgJiYgYW5pbWF0aW9uT3B0cy5hbmltYXRlUm90YXRlID8gMCA6IGFyYy5oaWRkZW4gPyAwIDogbWUuY2FsY3VsYXRlQ2lyY3VtZmVyZW5jZShkYXRhc2V0LmRhdGFbaW5kZXhdKSAqIChvcHRzLmNpcmN1bWZlcmVuY2UgLyBET1VCTEVfUEkkMSk7CiAgICAgIHZhciBpbm5lclJhZGl1cyA9IHJlc2V0ICYmIGFuaW1hdGlvbk9wdHMuYW5pbWF0ZVNjYWxlID8gMCA6IG1lLmlubmVyUmFkaXVzOwogICAgICB2YXIgb3V0ZXJSYWRpdXMgPSByZXNldCAmJiBhbmltYXRpb25PcHRzLmFuaW1hdGVTY2FsZSA/IDAgOiBtZS5vdXRlclJhZGl1czsKICAgICAgdmFyIG9wdGlvbnMgPSBhcmMuX29wdGlvbnMgfHwge307CiAgICAgIGhlbHBlcnMkMS5leHRlbmQoYXJjLCB7CiAgICAgICAgLy8gVXRpbGl0eQogICAgICAgIF9kYXRhc2V0SW5kZXg6IG1lLmluZGV4LAogICAgICAgIF9pbmRleDogaW5kZXgsCiAgICAgICAgLy8gRGVzaXJlZCB2aWV3IHByb3BlcnRpZXMKICAgICAgICBfbW9kZWw6IHsKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogb3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IsCiAgICAgICAgICBib3JkZXJDb2xvcjogb3B0aW9ucy5ib3JkZXJDb2xvciwKICAgICAgICAgIGJvcmRlcldpZHRoOiBvcHRpb25zLmJvcmRlcldpZHRoLAogICAgICAgICAgYm9yZGVyQWxpZ246IG9wdGlvbnMuYm9yZGVyQWxpZ24sCiAgICAgICAgICB4OiBjZW50ZXJYICsgY2hhcnQub2Zmc2V0WCwKICAgICAgICAgIHk6IGNlbnRlclkgKyBjaGFydC5vZmZzZXRZLAogICAgICAgICAgc3RhcnRBbmdsZTogc3RhcnRBbmdsZSwKICAgICAgICAgIGVuZEFuZ2xlOiBlbmRBbmdsZSwKICAgICAgICAgIGNpcmN1bWZlcmVuY2U6IGNpcmN1bWZlcmVuY2UsCiAgICAgICAgICBvdXRlclJhZGl1czogb3V0ZXJSYWRpdXMsCiAgICAgICAgICBpbm5lclJhZGl1czogaW5uZXJSYWRpdXMsCiAgICAgICAgICBsYWJlbDogaGVscGVycyQxLnZhbHVlQXRJbmRleE9yRGVmYXVsdChkYXRhc2V0LmxhYmVsLCBpbmRleCwgY2hhcnQuZGF0YS5sYWJlbHNbaW5kZXhdKQogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHZhciBtb2RlbCA9IGFyYy5fbW9kZWw7IC8vIFNldCBjb3JyZWN0IGFuZ2xlcyBpZiBub3QgcmVzZXR0aW5nCgogICAgICBpZiAoIXJlc2V0IHx8ICFhbmltYXRpb25PcHRzLmFuaW1hdGVSb3RhdGUpIHsKICAgICAgICBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICAgIG1vZGVsLnN0YXJ0QW5nbGUgPSBvcHRzLnJvdGF0aW9uOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBtb2RlbC5zdGFydEFuZ2xlID0gbWUuZ2V0TWV0YSgpLmRhdGFbaW5kZXggLSAxXS5fbW9kZWwuZW5kQW5nbGU7CiAgICAgICAgfQoKICAgICAgICBtb2RlbC5lbmRBbmdsZSA9IG1vZGVsLnN0YXJ0QW5nbGUgKyBtb2RlbC5jaXJjdW1mZXJlbmNlOwogICAgICB9CgogICAgICBhcmMucGl2b3QoKTsKICAgIH0sCiAgICBjYWxjdWxhdGVUb3RhbDogZnVuY3Rpb24gY2FsY3VsYXRlVG90YWwoKSB7CiAgICAgIHZhciBkYXRhc2V0ID0gdGhpcy5nZXREYXRhc2V0KCk7CiAgICAgIHZhciBtZXRhID0gdGhpcy5nZXRNZXRhKCk7CiAgICAgIHZhciB0b3RhbCA9IDA7CiAgICAgIHZhciB2YWx1ZTsKICAgICAgaGVscGVycyQxLmVhY2gobWV0YS5kYXRhLCBmdW5jdGlvbiAoZWxlbWVudCwgaW5kZXgpIHsKICAgICAgICB2YWx1ZSA9IGRhdGFzZXQuZGF0YVtpbmRleF07CgogICAgICAgIGlmICghaXNOYU4odmFsdWUpICYmICFlbGVtZW50LmhpZGRlbikgewogICAgICAgICAgdG90YWwgKz0gTWF0aC5hYnModmFsdWUpOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIC8qIGlmICh0b3RhbCA9PT0gMCkgew0KICAgICAgCXRvdGFsID0gTmFOOw0KICAgICAgfSovCgogICAgICByZXR1cm4gdG90YWw7CiAgICB9LAogICAgY2FsY3VsYXRlQ2lyY3VtZmVyZW5jZTogZnVuY3Rpb24gY2FsY3VsYXRlQ2lyY3VtZmVyZW5jZSh2YWx1ZSkgewogICAgICB2YXIgdG90YWwgPSB0aGlzLmdldE1ldGEoKS50b3RhbDsKCiAgICAgIGlmICh0b3RhbCA+IDAgJiYgIWlzTmFOKHZhbHVlKSkgewogICAgICAgIHJldHVybiBET1VCTEVfUEkkMSAqIChNYXRoLmFicyh2YWx1ZSkgLyB0b3RhbCk7CiAgICAgIH0KCiAgICAgIHJldHVybiAwOwogICAgfSwKICAgIC8vIGdldHMgdGhlIG1heCBib3JkZXIgb3IgaG92ZXIgd2lkdGggdG8gcHJvcGVybHkgc2NhbGUgcGllIGNoYXJ0cwogICAgZ2V0TWF4Qm9yZGVyV2lkdGg6IGZ1bmN0aW9uIGdldE1heEJvcmRlcldpZHRoKGFyY3MpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG1heCA9IDA7CiAgICAgIHZhciBjaGFydCA9IG1lLmNoYXJ0OwogICAgICB2YXIgaSwgaWxlbiwgbWV0YSwgYXJjLCBjb250cm9sbGVyLCBvcHRpb25zLCBib3JkZXJXaWR0aCwgaG92ZXJXaWR0aDsKCiAgICAgIGlmICghYXJjcykgewogICAgICAgIC8vIEZpbmQgdGhlIG91dG1vc3QgdmlzaWJsZSBkYXRhc2V0CiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGNoYXJ0LmRhdGEuZGF0YXNldHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgICBpZiAoY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShpKSkgewogICAgICAgICAgICBtZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoaSk7CiAgICAgICAgICAgIGFyY3MgPSBtZXRhLmRhdGE7CgogICAgICAgICAgICBpZiAoaSAhPT0gbWUuaW5kZXgpIHsKICAgICAgICAgICAgICBjb250cm9sbGVyID0gbWV0YS5jb250cm9sbGVyOwogICAgICAgICAgICB9CgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICghYXJjcykgewogICAgICAgIHJldHVybiAwOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gYXJjcy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBhcmMgPSBhcmNzW2ldOwoKICAgICAgICBpZiAoY29udHJvbGxlcikgewogICAgICAgICAgY29udHJvbGxlci5fY29uZmlndXJlKCk7CgogICAgICAgICAgb3B0aW9ucyA9IGNvbnRyb2xsZXIuX3Jlc29sdmVEYXRhRWxlbWVudE9wdGlvbnMoYXJjLCBpKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgb3B0aW9ucyA9IGFyYy5fb3B0aW9uczsKICAgICAgICB9CgogICAgICAgIGlmIChvcHRpb25zLmJvcmRlckFsaWduICE9PSAnaW5uZXInKSB7CiAgICAgICAgICBib3JkZXJXaWR0aCA9IG9wdGlvbnMuYm9yZGVyV2lkdGg7CiAgICAgICAgICBob3ZlcldpZHRoID0gb3B0aW9ucy5ob3ZlckJvcmRlcldpZHRoOwogICAgICAgICAgbWF4ID0gYm9yZGVyV2lkdGggPiBtYXggPyBib3JkZXJXaWR0aCA6IG1heDsKICAgICAgICAgIG1heCA9IGhvdmVyV2lkdGggPiBtYXggPyBob3ZlcldpZHRoIDogbWF4OwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG1heDsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByb3RlY3RlZA0KICAgICAqLwogICAgc2V0SG92ZXJTdHlsZTogZnVuY3Rpb24gc2V0SG92ZXJTdHlsZShhcmMpIHsKICAgICAgdmFyIG1vZGVsID0gYXJjLl9tb2RlbDsKICAgICAgdmFyIG9wdGlvbnMgPSBhcmMuX29wdGlvbnM7CiAgICAgIHZhciBnZXRIb3ZlckNvbG9yID0gaGVscGVycyQxLmdldEhvdmVyQ29sb3I7CiAgICAgIGFyYy4kcHJldmlvdXNTdHlsZSA9IHsKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IG1vZGVsLmJhY2tncm91bmRDb2xvciwKICAgICAgICBib3JkZXJDb2xvcjogbW9kZWwuYm9yZGVyQ29sb3IsCiAgICAgICAgYm9yZGVyV2lkdGg6IG1vZGVsLmJvcmRlcldpZHRoCiAgICAgIH07CiAgICAgIG1vZGVsLmJhY2tncm91bmRDb2xvciA9IHZhbHVlT3JEZWZhdWx0JDUob3B0aW9ucy5ob3ZlckJhY2tncm91bmRDb2xvciwgZ2V0SG92ZXJDb2xvcihvcHRpb25zLmJhY2tncm91bmRDb2xvcikpOwogICAgICBtb2RlbC5ib3JkZXJDb2xvciA9IHZhbHVlT3JEZWZhdWx0JDUob3B0aW9ucy5ob3ZlckJvcmRlckNvbG9yLCBnZXRIb3ZlckNvbG9yKG9wdGlvbnMuYm9yZGVyQ29sb3IpKTsKICAgICAgbW9kZWwuYm9yZGVyV2lkdGggPSB2YWx1ZU9yRGVmYXVsdCQ1KG9wdGlvbnMuaG92ZXJCb3JkZXJXaWR0aCwgb3B0aW9ucy5ib3JkZXJXaWR0aCk7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEdldCByYWRpdXMgbGVuZ3RoIG9mZnNldCBvZiB0aGUgZGF0YXNldCBpbiByZWxhdGlvbiB0byB0aGUgdmlzaWJsZSBkYXRhc2V0cyB3ZWlnaHRzLiBUaGlzIGFsbG93cyBkZXRlcm1pbmluZyB0aGUgaW5uZXIgYW5kIG91dGVyIHJhZGl1cyBjb3JyZWN0bHkNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2dldFJpbmdXZWlnaHRPZmZzZXQ6IGZ1bmN0aW9uIF9nZXRSaW5nV2VpZ2h0T2Zmc2V0KGRhdGFzZXRJbmRleCkgewogICAgICB2YXIgcmluZ1dlaWdodE9mZnNldCA9IDA7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGRhdGFzZXRJbmRleDsgKytpKSB7CiAgICAgICAgaWYgKHRoaXMuY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShpKSkgewogICAgICAgICAgcmluZ1dlaWdodE9mZnNldCArPSB0aGlzLl9nZXRSaW5nV2VpZ2h0KGkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHJpbmdXZWlnaHRPZmZzZXQ7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZ2V0UmluZ1dlaWdodDogZnVuY3Rpb24gX2dldFJpbmdXZWlnaHQoZGF0YVNldEluZGV4KSB7CiAgICAgIHJldHVybiBNYXRoLm1heCh2YWx1ZU9yRGVmYXVsdCQ1KHRoaXMuY2hhcnQuZGF0YS5kYXRhc2V0c1tkYXRhU2V0SW5kZXhdLndlaWdodCwgMSksIDApOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBSZXR1cm5zIHRoZSBzdW0gb2YgYWxsIHZpc2liaWxlIGRhdGEgc2V0IHdlaWdodHMuICBUaGlzIHZhbHVlIGNhbiBiZSAwLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZ2V0VmlzaWJsZURhdGFzZXRXZWlnaHRUb3RhbDogZnVuY3Rpb24gX2dldFZpc2libGVEYXRhc2V0V2VpZ2h0VG90YWwoKSB7CiAgICAgIHJldHVybiB0aGlzLl9nZXRSaW5nV2VpZ2h0T2Zmc2V0KHRoaXMuY2hhcnQuZGF0YS5kYXRhc2V0cy5sZW5ndGgpOwogICAgfQogIH0pOwoKICBjb3JlX2RlZmF1bHRzLl9zZXQoJ2hvcml6b250YWxCYXInLCB7CiAgICBob3ZlcjogewogICAgICBtb2RlOiAnaW5kZXgnLAogICAgICBheGlzOiAneScKICAgIH0sCiAgICBzY2FsZXM6IHsKICAgICAgeEF4ZXM6IFt7CiAgICAgICAgdHlwZTogJ2xpbmVhcicsCiAgICAgICAgcG9zaXRpb246ICdib3R0b20nCiAgICAgIH1dLAogICAgICB5QXhlczogW3sKICAgICAgICB0eXBlOiAnY2F0ZWdvcnknLAogICAgICAgIHBvc2l0aW9uOiAnbGVmdCcsCiAgICAgICAgb2Zmc2V0OiB0cnVlLAogICAgICAgIGdyaWRMaW5lczogewogICAgICAgICAgb2Zmc2V0R3JpZExpbmVzOiB0cnVlCiAgICAgICAgfQogICAgICB9XQogICAgfSwKICAgIGVsZW1lbnRzOiB7CiAgICAgIHJlY3RhbmdsZTogewogICAgICAgIGJvcmRlclNraXBwZWQ6ICdsZWZ0JwogICAgICB9CiAgICB9LAogICAgdG9vbHRpcHM6IHsKICAgICAgbW9kZTogJ2luZGV4JywKICAgICAgYXhpczogJ3knCiAgICB9CiAgfSk7CgogIGNvcmVfZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewogICAgZGF0YXNldHM6IHsKICAgICAgaG9yaXpvbnRhbEJhcjogewogICAgICAgIGNhdGVnb3J5UGVyY2VudGFnZTogMC44LAogICAgICAgIGJhclBlcmNlbnRhZ2U6IDAuOQogICAgICB9CiAgICB9CiAgfSk7CgogIHZhciBjb250cm9sbGVyX2hvcml6b250YWxCYXIgPSBjb250cm9sbGVyX2Jhci5leHRlbmQoewogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9nZXRWYWx1ZVNjYWxlSWQ6IGZ1bmN0aW9uIF9nZXRWYWx1ZVNjYWxlSWQoKSB7CiAgICAgIHJldHVybiB0aGlzLmdldE1ldGEoKS54QXhpc0lEOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2dldEluZGV4U2NhbGVJZDogZnVuY3Rpb24gX2dldEluZGV4U2NhbGVJZCgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0TWV0YSgpLnlBeGlzSUQ7CiAgICB9CiAgfSk7CiAgdmFyIHZhbHVlT3JEZWZhdWx0JDYgPSBoZWxwZXJzJDEudmFsdWVPckRlZmF1bHQ7CiAgdmFyIHJlc29sdmUkMiA9IGhlbHBlcnMkMS5vcHRpb25zLnJlc29sdmU7CiAgdmFyIGlzUG9pbnRJbkFyZWEgPSBoZWxwZXJzJDEuY2FudmFzLl9pc1BvaW50SW5BcmVhOwoKICBjb3JlX2RlZmF1bHRzLl9zZXQoJ2xpbmUnLCB7CiAgICBzaG93TGluZXM6IHRydWUsCiAgICBzcGFuR2FwczogZmFsc2UsCiAgICBob3ZlcjogewogICAgICBtb2RlOiAnbGFiZWwnCiAgICB9LAogICAgc2NhbGVzOiB7CiAgICAgIHhBeGVzOiBbewogICAgICAgIHR5cGU6ICdjYXRlZ29yeScsCiAgICAgICAgaWQ6ICd4LWF4aXMtMCcKICAgICAgfV0sCiAgICAgIHlBeGVzOiBbewogICAgICAgIHR5cGU6ICdsaW5lYXInLAogICAgICAgIGlkOiAneS1heGlzLTAnCiAgICAgIH1dCiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIHNjYWxlQ2xpcChzY2FsZSwgaGFsZkJvcmRlcldpZHRoKSB7CiAgICB2YXIgdGlja09wdHMgPSBzY2FsZSAmJiBzY2FsZS5vcHRpb25zLnRpY2tzIHx8IHt9OwogICAgdmFyIHJldmVyc2UgPSB0aWNrT3B0cy5yZXZlcnNlOwogICAgdmFyIG1pbiA9IHRpY2tPcHRzLm1pbiA9PT0gdW5kZWZpbmVkID8gaGFsZkJvcmRlcldpZHRoIDogMDsKICAgIHZhciBtYXggPSB0aWNrT3B0cy5tYXggPT09IHVuZGVmaW5lZCA/IGhhbGZCb3JkZXJXaWR0aCA6IDA7CiAgICByZXR1cm4gewogICAgICBzdGFydDogcmV2ZXJzZSA/IG1heCA6IG1pbiwKICAgICAgZW5kOiByZXZlcnNlID8gbWluIDogbWF4CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZGVmYXVsdENsaXAoeFNjYWxlLCB5U2NhbGUsIGJvcmRlcldpZHRoKSB7CiAgICB2YXIgaGFsZkJvcmRlcldpZHRoID0gYm9yZGVyV2lkdGggLyAyOwogICAgdmFyIHggPSBzY2FsZUNsaXAoeFNjYWxlLCBoYWxmQm9yZGVyV2lkdGgpOwogICAgdmFyIHkgPSBzY2FsZUNsaXAoeVNjYWxlLCBoYWxmQm9yZGVyV2lkdGgpOwogICAgcmV0dXJuIHsKICAgICAgdG9wOiB5LmVuZCwKICAgICAgcmlnaHQ6IHguZW5kLAogICAgICBib3R0b206IHkuc3RhcnQsCiAgICAgIGxlZnQ6IHguc3RhcnQKICAgIH07CiAgfQoKICBmdW5jdGlvbiB0b0NsaXAodmFsdWUpIHsKICAgIHZhciB0LCByLCBiLCBsOwoKICAgIGlmIChoZWxwZXJzJDEuaXNPYmplY3QodmFsdWUpKSB7CiAgICAgIHQgPSB2YWx1ZS50b3A7CiAgICAgIHIgPSB2YWx1ZS5yaWdodDsKICAgICAgYiA9IHZhbHVlLmJvdHRvbTsKICAgICAgbCA9IHZhbHVlLmxlZnQ7CiAgICB9IGVsc2UgewogICAgICB0ID0gciA9IGIgPSBsID0gdmFsdWU7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgdG9wOiB0LAogICAgICByaWdodDogciwKICAgICAgYm90dG9tOiBiLAogICAgICBsZWZ0OiBsCiAgICB9OwogIH0KCiAgdmFyIGNvbnRyb2xsZXJfbGluZSA9IGNvcmVfZGF0YXNldENvbnRyb2xsZXIuZXh0ZW5kKHsKICAgIGRhdGFzZXRFbGVtZW50VHlwZTogZWxlbWVudHMuTGluZSwKICAgIGRhdGFFbGVtZW50VHlwZTogZWxlbWVudHMuUG9pbnQsCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9kYXRhc2V0RWxlbWVudE9wdGlvbnM6IFsnYmFja2dyb3VuZENvbG9yJywgJ2JvcmRlckNhcFN0eWxlJywgJ2JvcmRlckNvbG9yJywgJ2JvcmRlckRhc2gnLCAnYm9yZGVyRGFzaE9mZnNldCcsICdib3JkZXJKb2luU3R5bGUnLCAnYm9yZGVyV2lkdGgnLCAnY3ViaWNJbnRlcnBvbGF0aW9uTW9kZScsICdmaWxsJ10sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9kYXRhRWxlbWVudE9wdGlvbnM6IHsKICAgICAgYmFja2dyb3VuZENvbG9yOiAncG9pbnRCYWNrZ3JvdW5kQ29sb3InLAogICAgICBib3JkZXJDb2xvcjogJ3BvaW50Qm9yZGVyQ29sb3InLAogICAgICBib3JkZXJXaWR0aDogJ3BvaW50Qm9yZGVyV2lkdGgnLAogICAgICBoaXRSYWRpdXM6ICdwb2ludEhpdFJhZGl1cycsCiAgICAgIGhvdmVyQmFja2dyb3VuZENvbG9yOiAncG9pbnRIb3ZlckJhY2tncm91bmRDb2xvcicsCiAgICAgIGhvdmVyQm9yZGVyQ29sb3I6ICdwb2ludEhvdmVyQm9yZGVyQ29sb3InLAogICAgICBob3ZlckJvcmRlcldpZHRoOiAncG9pbnRIb3ZlckJvcmRlcldpZHRoJywKICAgICAgaG92ZXJSYWRpdXM6ICdwb2ludEhvdmVyUmFkaXVzJywKICAgICAgcG9pbnRTdHlsZTogJ3BvaW50U3R5bGUnLAogICAgICByYWRpdXM6ICdwb2ludFJhZGl1cycsCiAgICAgIHJvdGF0aW9uOiAncG9pbnRSb3RhdGlvbicKICAgIH0sCiAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShyZXNldCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKICAgICAgdmFyIGxpbmUgPSBtZXRhLmRhdGFzZXQ7CiAgICAgIHZhciBwb2ludHMgPSBtZXRhLmRhdGEgfHwgW107CiAgICAgIHZhciBvcHRpb25zID0gbWUuY2hhcnQub3B0aW9uczsKICAgICAgdmFyIGNvbmZpZyA9IG1lLl9jb25maWc7CiAgICAgIHZhciBzaG93TGluZSA9IG1lLl9zaG93TGluZSA9IHZhbHVlT3JEZWZhdWx0JDYoY29uZmlnLnNob3dMaW5lLCBvcHRpb25zLnNob3dMaW5lcyk7CiAgICAgIHZhciBpLCBpbGVuOwogICAgICBtZS5feFNjYWxlID0gbWUuZ2V0U2NhbGVGb3JJZChtZXRhLnhBeGlzSUQpOwogICAgICBtZS5feVNjYWxlID0gbWUuZ2V0U2NhbGVGb3JJZChtZXRhLnlBeGlzSUQpOyAvLyBVcGRhdGUgTGluZQoKICAgICAgaWYgKHNob3dMaW5lKSB7CiAgICAgICAgLy8gQ29tcGF0aWJpbGl0eTogSWYgdGhlIHByb3BlcnRpZXMgYXJlIGRlZmluZWQgd2l0aCBvbmx5IHRoZSBvbGQgbmFtZSwgdXNlIHRob3NlIHZhbHVlcwogICAgICAgIGlmIChjb25maWcudGVuc2lvbiAhPT0gdW5kZWZpbmVkICYmIGNvbmZpZy5saW5lVGVuc2lvbiA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBjb25maWcubGluZVRlbnNpb24gPSBjb25maWcudGVuc2lvbjsKICAgICAgICB9IC8vIFV0aWxpdHkKCgogICAgICAgIGxpbmUuX3NjYWxlID0gbWUuX3lTY2FsZTsKICAgICAgICBsaW5lLl9kYXRhc2V0SW5kZXggPSBtZS5pbmRleDsgLy8gRGF0YQoKICAgICAgICBsaW5lLl9jaGlsZHJlbiA9IHBvaW50czsgLy8gTW9kZWwKCiAgICAgICAgbGluZS5fbW9kZWwgPSBtZS5fcmVzb2x2ZURhdGFzZXRFbGVtZW50T3B0aW9ucyhsaW5lKTsKICAgICAgICBsaW5lLnBpdm90KCk7CiAgICAgIH0gLy8gVXBkYXRlIFBvaW50cwoKCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBwb2ludHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgbWUudXBkYXRlRWxlbWVudChwb2ludHNbaV0sIGksIHJlc2V0KTsKICAgICAgfQoKICAgICAgaWYgKHNob3dMaW5lICYmIGxpbmUuX21vZGVsLnRlbnNpb24gIT09IDApIHsKICAgICAgICBtZS51cGRhdGVCZXppZXJDb250cm9sUG9pbnRzKCk7CiAgICAgIH0gLy8gTm93IHBpdm90IHRoZSBwb2ludCBmb3IgYW5pbWF0aW9uCgoKICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHBvaW50cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBwb2ludHNbaV0ucGl2b3QoKTsKICAgICAgfQogICAgfSwKICAgIHVwZGF0ZUVsZW1lbnQ6IGZ1bmN0aW9uIHVwZGF0ZUVsZW1lbnQocG9pbnQsIGluZGV4LCByZXNldCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKICAgICAgdmFyIGN1c3RvbSA9IHBvaW50LmN1c3RvbSB8fCB7fTsKICAgICAgdmFyIGRhdGFzZXQgPSBtZS5nZXREYXRhc2V0KCk7CiAgICAgIHZhciBkYXRhc2V0SW5kZXggPSBtZS5pbmRleDsKICAgICAgdmFyIHZhbHVlID0gZGF0YXNldC5kYXRhW2luZGV4XTsKICAgICAgdmFyIHhTY2FsZSA9IG1lLl94U2NhbGU7CiAgICAgIHZhciB5U2NhbGUgPSBtZS5feVNjYWxlOwogICAgICB2YXIgbGluZU1vZGVsID0gbWV0YS5kYXRhc2V0Ll9tb2RlbDsKICAgICAgdmFyIHgsIHk7CgogICAgICB2YXIgb3B0aW9ucyA9IG1lLl9yZXNvbHZlRGF0YUVsZW1lbnRPcHRpb25zKHBvaW50LCBpbmRleCk7CgogICAgICB4ID0geFNjYWxlLmdldFBpeGVsRm9yVmFsdWUoX3R5cGVvZih2YWx1ZSkgPT09ICdvYmplY3QnID8gdmFsdWUgOiBOYU4sIGluZGV4LCBkYXRhc2V0SW5kZXgpOwogICAgICB5ID0gcmVzZXQgPyB5U2NhbGUuZ2V0QmFzZVBpeGVsKCkgOiBtZS5jYWxjdWxhdGVQb2ludFkodmFsdWUsIGluZGV4LCBkYXRhc2V0SW5kZXgpOyAvLyBVdGlsaXR5CgogICAgICBwb2ludC5feFNjYWxlID0geFNjYWxlOwogICAgICBwb2ludC5feVNjYWxlID0geVNjYWxlOwogICAgICBwb2ludC5fb3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHBvaW50Ll9kYXRhc2V0SW5kZXggPSBkYXRhc2V0SW5kZXg7CiAgICAgIHBvaW50Ll9pbmRleCA9IGluZGV4OyAvLyBEZXNpcmVkIHZpZXcgcHJvcGVydGllcwoKICAgICAgcG9pbnQuX21vZGVsID0gewogICAgICAgIHg6IHgsCiAgICAgICAgeTogeSwKICAgICAgICBza2lwOiBjdXN0b20uc2tpcCB8fCBpc05hTih4KSB8fCBpc05hTih5KSwKICAgICAgICAvLyBBcHBlYXJhbmNlCiAgICAgICAgcmFkaXVzOiBvcHRpb25zLnJhZGl1cywKICAgICAgICBwb2ludFN0eWxlOiBvcHRpb25zLnBvaW50U3R5bGUsCiAgICAgICAgcm90YXRpb246IG9wdGlvbnMucm90YXRpb24sCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBvcHRpb25zLmJhY2tncm91bmRDb2xvciwKICAgICAgICBib3JkZXJDb2xvcjogb3B0aW9ucy5ib3JkZXJDb2xvciwKICAgICAgICBib3JkZXJXaWR0aDogb3B0aW9ucy5ib3JkZXJXaWR0aCwKICAgICAgICB0ZW5zaW9uOiB2YWx1ZU9yRGVmYXVsdCQ2KGN1c3RvbS50ZW5zaW9uLCBsaW5lTW9kZWwgPyBsaW5lTW9kZWwudGVuc2lvbiA6IDApLAogICAgICAgIHN0ZXBwZWRMaW5lOiBsaW5lTW9kZWwgPyBsaW5lTW9kZWwuc3RlcHBlZExpbmUgOiBmYWxzZSwKICAgICAgICAvLyBUb29sdGlwCiAgICAgICAgaGl0UmFkaXVzOiBvcHRpb25zLmhpdFJhZGl1cwogICAgICB9OwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX3Jlc29sdmVEYXRhc2V0RWxlbWVudE9wdGlvbnM6IGZ1bmN0aW9uIF9yZXNvbHZlRGF0YXNldEVsZW1lbnRPcHRpb25zKGVsZW1lbnQpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGNvbmZpZyA9IG1lLl9jb25maWc7CiAgICAgIHZhciBjdXN0b20gPSBlbGVtZW50LmN1c3RvbSB8fCB7fTsKICAgICAgdmFyIG9wdGlvbnMgPSBtZS5jaGFydC5vcHRpb25zOwogICAgICB2YXIgbGluZU9wdGlvbnMgPSBvcHRpb25zLmVsZW1lbnRzLmxpbmU7CgogICAgICB2YXIgdmFsdWVzID0gY29yZV9kYXRhc2V0Q29udHJvbGxlci5wcm90b3R5cGUuX3Jlc29sdmVEYXRhc2V0RWxlbWVudE9wdGlvbnMuYXBwbHkobWUsIGFyZ3VtZW50cyk7IC8vIFRoZSBkZWZhdWx0IGJlaGF2aW9yIG9mIGxpbmVzIGlzIHRvIGJyZWFrIGF0IG51bGwgdmFsdWVzLCBhY2NvcmRpbmcKICAgICAgLy8gdG8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzI0MzUjaXNzdWVjb21tZW50LTIxNjcxODE1OAogICAgICAvLyBUaGlzIG9wdGlvbiBnaXZlcyBsaW5lcyB0aGUgYWJpbGl0eSB0byBzcGFuIGdhcHMKCgogICAgICB2YWx1ZXMuc3BhbkdhcHMgPSB2YWx1ZU9yRGVmYXVsdCQ2KGNvbmZpZy5zcGFuR2Fwcywgb3B0aW9ucy5zcGFuR2Fwcyk7CiAgICAgIHZhbHVlcy50ZW5zaW9uID0gdmFsdWVPckRlZmF1bHQkNihjb25maWcubGluZVRlbnNpb24sIGxpbmVPcHRpb25zLnRlbnNpb24pOwogICAgICB2YWx1ZXMuc3RlcHBlZExpbmUgPSByZXNvbHZlJDIoW2N1c3RvbS5zdGVwcGVkTGluZSwgY29uZmlnLnN0ZXBwZWRMaW5lLCBsaW5lT3B0aW9ucy5zdGVwcGVkXSk7CiAgICAgIHZhbHVlcy5jbGlwID0gdG9DbGlwKHZhbHVlT3JEZWZhdWx0JDYoY29uZmlnLmNsaXAsIGRlZmF1bHRDbGlwKG1lLl94U2NhbGUsIG1lLl95U2NhbGUsIHZhbHVlcy5ib3JkZXJXaWR0aCkpKTsKICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0sCiAgICBjYWxjdWxhdGVQb2ludFk6IGZ1bmN0aW9uIGNhbGN1bGF0ZVBvaW50WSh2YWx1ZSwgaW5kZXgsIGRhdGFzZXRJbmRleCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgY2hhcnQgPSBtZS5jaGFydDsKICAgICAgdmFyIHlTY2FsZSA9IG1lLl95U2NhbGU7CiAgICAgIHZhciBzdW1Qb3MgPSAwOwogICAgICB2YXIgc3VtTmVnID0gMDsKICAgICAgdmFyIGksIGRzLCBkc01ldGEsIHN0YWNrZWRSaWdodFZhbHVlLCByaWdodFZhbHVlLCBtZXRhc2V0cywgaWxlbjsKCiAgICAgIGlmICh5U2NhbGUub3B0aW9ucy5zdGFja2VkKSB7CiAgICAgICAgcmlnaHRWYWx1ZSA9ICt5U2NhbGUuZ2V0UmlnaHRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgbWV0YXNldHMgPSBjaGFydC5fZ2V0U29ydGVkVmlzaWJsZURhdGFzZXRNZXRhcygpOwogICAgICAgIGlsZW4gPSBtZXRhc2V0cy5sZW5ndGg7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICAgIGRzTWV0YSA9IG1ldGFzZXRzW2ldOwoKICAgICAgICAgIGlmIChkc01ldGEuaW5kZXggPT09IGRhdGFzZXRJbmRleCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KCiAgICAgICAgICBkcyA9IGNoYXJ0LmRhdGEuZGF0YXNldHNbZHNNZXRhLmluZGV4XTsKCiAgICAgICAgICBpZiAoZHNNZXRhLnR5cGUgPT09ICdsaW5lJyAmJiBkc01ldGEueUF4aXNJRCA9PT0geVNjYWxlLmlkKSB7CiAgICAgICAgICAgIHN0YWNrZWRSaWdodFZhbHVlID0gK3lTY2FsZS5nZXRSaWdodFZhbHVlKGRzLmRhdGFbaW5kZXhdKTsKCiAgICAgICAgICAgIGlmIChzdGFja2VkUmlnaHRWYWx1ZSA8IDApIHsKICAgICAgICAgICAgICBzdW1OZWcgKz0gc3RhY2tlZFJpZ2h0VmFsdWUgfHwgMDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBzdW1Qb3MgKz0gc3RhY2tlZFJpZ2h0VmFsdWUgfHwgMDsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHJpZ2h0VmFsdWUgPCAwKSB7CiAgICAgICAgICByZXR1cm4geVNjYWxlLmdldFBpeGVsRm9yVmFsdWUoc3VtTmVnICsgcmlnaHRWYWx1ZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4geVNjYWxlLmdldFBpeGVsRm9yVmFsdWUoc3VtUG9zICsgcmlnaHRWYWx1ZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB5U2NhbGUuZ2V0UGl4ZWxGb3JWYWx1ZSh2YWx1ZSk7CiAgICB9LAogICAgdXBkYXRlQmV6aWVyQ29udHJvbFBvaW50czogZnVuY3Rpb24gdXBkYXRlQmV6aWVyQ29udHJvbFBvaW50cygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CiAgICAgIHZhciBtZXRhID0gbWUuZ2V0TWV0YSgpOwogICAgICB2YXIgbGluZU1vZGVsID0gbWV0YS5kYXRhc2V0Ll9tb2RlbDsKICAgICAgdmFyIGFyZWEgPSBjaGFydC5jaGFydEFyZWE7CiAgICAgIHZhciBwb2ludHMgPSBtZXRhLmRhdGEgfHwgW107CiAgICAgIHZhciBpLCBpbGVuLCBtb2RlbCwgY29udHJvbFBvaW50czsgLy8gT25seSBjb25zaWRlciBwb2ludHMgdGhhdCBhcmUgZHJhd24gaW4gY2FzZSB0aGUgc3BhbkdhcHMgb3B0aW9uIGlzIHVzZWQKCiAgICAgIGlmIChsaW5lTW9kZWwuc3BhbkdhcHMpIHsKICAgICAgICBwb2ludHMgPSBwb2ludHMuZmlsdGVyKGZ1bmN0aW9uIChwdCkgewogICAgICAgICAgcmV0dXJuICFwdC5fbW9kZWwuc2tpcDsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgZnVuY3Rpb24gY2FwQ29udHJvbFBvaW50KHB0LCBtaW4sIG1heCkgewogICAgICAgIHJldHVybiBNYXRoLm1heChNYXRoLm1pbihwdCwgbWF4KSwgbWluKTsKICAgICAgfQoKICAgICAgaWYgKGxpbmVNb2RlbC5jdWJpY0ludGVycG9sYXRpb25Nb2RlID09PSAnbW9ub3RvbmUnKSB7CiAgICAgICAgaGVscGVycyQxLnNwbGluZUN1cnZlTW9ub3RvbmUocG9pbnRzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gcG9pbnRzLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewogICAgICAgICAgbW9kZWwgPSBwb2ludHNbaV0uX21vZGVsOwogICAgICAgICAgY29udHJvbFBvaW50cyA9IGhlbHBlcnMkMS5zcGxpbmVDdXJ2ZShoZWxwZXJzJDEucHJldmlvdXNJdGVtKHBvaW50cywgaSkuX21vZGVsLCBtb2RlbCwgaGVscGVycyQxLm5leHRJdGVtKHBvaW50cywgaSkuX21vZGVsLCBsaW5lTW9kZWwudGVuc2lvbik7CiAgICAgICAgICBtb2RlbC5jb250cm9sUG9pbnRQcmV2aW91c1ggPSBjb250cm9sUG9pbnRzLnByZXZpb3VzLng7CiAgICAgICAgICBtb2RlbC5jb250cm9sUG9pbnRQcmV2aW91c1kgPSBjb250cm9sUG9pbnRzLnByZXZpb3VzLnk7CiAgICAgICAgICBtb2RlbC5jb250cm9sUG9pbnROZXh0WCA9IGNvbnRyb2xQb2ludHMubmV4dC54OwogICAgICAgICAgbW9kZWwuY29udHJvbFBvaW50TmV4dFkgPSBjb250cm9sUG9pbnRzLm5leHQueTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChjaGFydC5vcHRpb25zLmVsZW1lbnRzLmxpbmUuY2FwQmV6aWVyUG9pbnRzKSB7CiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHBvaW50cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICAgIG1vZGVsID0gcG9pbnRzW2ldLl9tb2RlbDsKCiAgICAgICAgICBpZiAoaXNQb2ludEluQXJlYShtb2RlbCwgYXJlYSkpIHsKICAgICAgICAgICAgaWYgKGkgPiAwICYmIGlzUG9pbnRJbkFyZWEocG9pbnRzW2kgLSAxXS5fbW9kZWwsIGFyZWEpKSB7CiAgICAgICAgICAgICAgbW9kZWwuY29udHJvbFBvaW50UHJldmlvdXNYID0gY2FwQ29udHJvbFBvaW50KG1vZGVsLmNvbnRyb2xQb2ludFByZXZpb3VzWCwgYXJlYS5sZWZ0LCBhcmVhLnJpZ2h0KTsKICAgICAgICAgICAgICBtb2RlbC5jb250cm9sUG9pbnRQcmV2aW91c1kgPSBjYXBDb250cm9sUG9pbnQobW9kZWwuY29udHJvbFBvaW50UHJldmlvdXNZLCBhcmVhLnRvcCwgYXJlYS5ib3R0b20pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoaSA8IHBvaW50cy5sZW5ndGggLSAxICYmIGlzUG9pbnRJbkFyZWEocG9pbnRzW2kgKyAxXS5fbW9kZWwsIGFyZWEpKSB7CiAgICAgICAgICAgICAgbW9kZWwuY29udHJvbFBvaW50TmV4dFggPSBjYXBDb250cm9sUG9pbnQobW9kZWwuY29udHJvbFBvaW50TmV4dFgsIGFyZWEubGVmdCwgYXJlYS5yaWdodCk7CiAgICAgICAgICAgICAgbW9kZWwuY29udHJvbFBvaW50TmV4dFkgPSBjYXBDb250cm9sUG9pbnQobW9kZWwuY29udHJvbFBvaW50TmV4dFksIGFyZWEudG9wLCBhcmVhLmJvdHRvbSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBkcmF3OiBmdW5jdGlvbiBkcmF3KCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgY2hhcnQgPSBtZS5jaGFydDsKICAgICAgdmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7CiAgICAgIHZhciBwb2ludHMgPSBtZXRhLmRhdGEgfHwgW107CiAgICAgIHZhciBhcmVhID0gY2hhcnQuY2hhcnRBcmVhOwogICAgICB2YXIgY2FudmFzID0gY2hhcnQuY2FudmFzOwogICAgICB2YXIgaSA9IDA7CiAgICAgIHZhciBpbGVuID0gcG9pbnRzLmxlbmd0aDsKICAgICAgdmFyIGNsaXA7CgogICAgICBpZiAobWUuX3Nob3dMaW5lKSB7CiAgICAgICAgY2xpcCA9IG1ldGEuZGF0YXNldC5fbW9kZWwuY2xpcDsKICAgICAgICBoZWxwZXJzJDEuY2FudmFzLmNsaXBBcmVhKGNoYXJ0LmN0eCwgewogICAgICAgICAgbGVmdDogY2xpcC5sZWZ0ID09PSBmYWxzZSA/IDAgOiBhcmVhLmxlZnQgLSBjbGlwLmxlZnQsCiAgICAgICAgICByaWdodDogY2xpcC5yaWdodCA9PT0gZmFsc2UgPyBjYW52YXMud2lkdGggOiBhcmVhLnJpZ2h0ICsgY2xpcC5yaWdodCwKICAgICAgICAgIHRvcDogY2xpcC50b3AgPT09IGZhbHNlID8gMCA6IGFyZWEudG9wIC0gY2xpcC50b3AsCiAgICAgICAgICBib3R0b206IGNsaXAuYm90dG9tID09PSBmYWxzZSA/IGNhbnZhcy5oZWlnaHQgOiBhcmVhLmJvdHRvbSArIGNsaXAuYm90dG9tCiAgICAgICAgfSk7CiAgICAgICAgbWV0YS5kYXRhc2V0LmRyYXcoKTsKICAgICAgICBoZWxwZXJzJDEuY2FudmFzLnVuY2xpcEFyZWEoY2hhcnQuY3R4KTsKICAgICAgfSAvLyBEcmF3IHRoZSBwb2ludHMKCgogICAgICBmb3IgKDsgaSA8IGlsZW47ICsraSkgewogICAgICAgIHBvaW50c1tpXS5kcmF3KGFyZWEpOwogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcm90ZWN0ZWQNCiAgICAgKi8KICAgIHNldEhvdmVyU3R5bGU6IGZ1bmN0aW9uIHNldEhvdmVyU3R5bGUocG9pbnQpIHsKICAgICAgdmFyIG1vZGVsID0gcG9pbnQuX21vZGVsOwogICAgICB2YXIgb3B0aW9ucyA9IHBvaW50Ll9vcHRpb25zOwogICAgICB2YXIgZ2V0SG92ZXJDb2xvciA9IGhlbHBlcnMkMS5nZXRIb3ZlckNvbG9yOwogICAgICBwb2ludC4kcHJldmlvdXNTdHlsZSA9IHsKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IG1vZGVsLmJhY2tncm91bmRDb2xvciwKICAgICAgICBib3JkZXJDb2xvcjogbW9kZWwuYm9yZGVyQ29sb3IsCiAgICAgICAgYm9yZGVyV2lkdGg6IG1vZGVsLmJvcmRlcldpZHRoLAogICAgICAgIHJhZGl1czogbW9kZWwucmFkaXVzCiAgICAgIH07CiAgICAgIG1vZGVsLmJhY2tncm91bmRDb2xvciA9IHZhbHVlT3JEZWZhdWx0JDYob3B0aW9ucy5ob3ZlckJhY2tncm91bmRDb2xvciwgZ2V0SG92ZXJDb2xvcihvcHRpb25zLmJhY2tncm91bmRDb2xvcikpOwogICAgICBtb2RlbC5ib3JkZXJDb2xvciA9IHZhbHVlT3JEZWZhdWx0JDYob3B0aW9ucy5ob3ZlckJvcmRlckNvbG9yLCBnZXRIb3ZlckNvbG9yKG9wdGlvbnMuYm9yZGVyQ29sb3IpKTsKICAgICAgbW9kZWwuYm9yZGVyV2lkdGggPSB2YWx1ZU9yRGVmYXVsdCQ2KG9wdGlvbnMuaG92ZXJCb3JkZXJXaWR0aCwgb3B0aW9ucy5ib3JkZXJXaWR0aCk7CiAgICAgIG1vZGVsLnJhZGl1cyA9IHZhbHVlT3JEZWZhdWx0JDYob3B0aW9ucy5ob3ZlclJhZGl1cywgb3B0aW9ucy5yYWRpdXMpOwogICAgfQogIH0pOwogIHZhciByZXNvbHZlJDMgPSBoZWxwZXJzJDEub3B0aW9ucy5yZXNvbHZlOwoKICBjb3JlX2RlZmF1bHRzLl9zZXQoJ3BvbGFyQXJlYScsIHsKICAgIHNjYWxlOiB7CiAgICAgIHR5cGU6ICdyYWRpYWxMaW5lYXInLAogICAgICBhbmdsZUxpbmVzOiB7CiAgICAgICAgZGlzcGxheTogZmFsc2UKICAgICAgfSwKICAgICAgZ3JpZExpbmVzOiB7CiAgICAgICAgY2lyY3VsYXI6IHRydWUKICAgICAgfSwKICAgICAgcG9pbnRMYWJlbHM6IHsKICAgICAgICBkaXNwbGF5OiBmYWxzZQogICAgICB9LAogICAgICB0aWNrczogewogICAgICAgIGJlZ2luQXRaZXJvOiB0cnVlCiAgICAgIH0KICAgIH0sCiAgICAvLyBCb29sZWFuIC0gV2hldGhlciB0byBhbmltYXRlIHRoZSByb3RhdGlvbiBvZiB0aGUgY2hhcnQKICAgIGFuaW1hdGlvbjogewogICAgICBhbmltYXRlUm90YXRlOiB0cnVlLAogICAgICBhbmltYXRlU2NhbGU6IHRydWUKICAgIH0sCiAgICBzdGFydEFuZ2xlOiAtMC41ICogTWF0aC5QSSwKICAgIGxlZ2VuZENhbGxiYWNrOiBmdW5jdGlvbiBsZWdlbmRDYWxsYmFjayhjaGFydCkgewogICAgICB2YXIgbGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3VsJyk7CiAgICAgIHZhciBkYXRhID0gY2hhcnQuZGF0YTsKICAgICAgdmFyIGRhdGFzZXRzID0gZGF0YS5kYXRhc2V0czsKICAgICAgdmFyIGxhYmVscyA9IGRhdGEubGFiZWxzOwogICAgICB2YXIgaSwgaWxlbiwgbGlzdEl0ZW0sIGxpc3RJdGVtU3BhbjsKICAgICAgbGlzdC5zZXRBdHRyaWJ1dGUoJ2NsYXNzJywgY2hhcnQuaWQgKyAnLWxlZ2VuZCcpOwoKICAgICAgaWYgKGRhdGFzZXRzLmxlbmd0aCkgewogICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBkYXRhc2V0c1swXS5kYXRhLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewogICAgICAgICAgbGlzdEl0ZW0gPSBsaXN0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJykpOwogICAgICAgICAgbGlzdEl0ZW1TcGFuID0gbGlzdEl0ZW0uYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpKTsKICAgICAgICAgIGxpc3RJdGVtU3Bhbi5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBkYXRhc2V0c1swXS5iYWNrZ3JvdW5kQ29sb3JbaV07CgogICAgICAgICAgaWYgKGxhYmVsc1tpXSkgewogICAgICAgICAgICBsaXN0SXRlbS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShsYWJlbHNbaV0pKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBsaXN0Lm91dGVySFRNTDsKICAgIH0sCiAgICBsZWdlbmQ6IHsKICAgICAgbGFiZWxzOiB7CiAgICAgICAgZ2VuZXJhdGVMYWJlbHM6IGZ1bmN0aW9uIGdlbmVyYXRlTGFiZWxzKGNoYXJ0KSB7CiAgICAgICAgICB2YXIgZGF0YSA9IGNoYXJ0LmRhdGE7CgogICAgICAgICAgaWYgKGRhdGEubGFiZWxzLmxlbmd0aCAmJiBkYXRhLmRhdGFzZXRzLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm4gZGF0YS5sYWJlbHMubWFwKGZ1bmN0aW9uIChsYWJlbCwgaSkgewogICAgICAgICAgICAgIHZhciBtZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoMCk7CiAgICAgICAgICAgICAgdmFyIHN0eWxlID0gbWV0YS5jb250cm9sbGVyLmdldFN0eWxlKGkpOwogICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICB0ZXh0OiBsYWJlbCwKICAgICAgICAgICAgICAgIGZpbGxTdHlsZTogc3R5bGUuYmFja2dyb3VuZENvbG9yLAogICAgICAgICAgICAgICAgc3Ryb2tlU3R5bGU6IHN0eWxlLmJvcmRlckNvbG9yLAogICAgICAgICAgICAgICAgbGluZVdpZHRoOiBzdHlsZS5ib3JkZXJXaWR0aCwKICAgICAgICAgICAgICAgIGhpZGRlbjogaXNOYU4oZGF0YS5kYXRhc2V0c1swXS5kYXRhW2ldKSB8fCBtZXRhLmRhdGFbaV0uaGlkZGVuLAogICAgICAgICAgICAgICAgLy8gRXh0cmEgZGF0YSB1c2VkIGZvciB0b2dnbGluZyB0aGUgY29ycmVjdCBpdGVtCiAgICAgICAgICAgICAgICBpbmRleDogaQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQoKICAgICAgICAgIHJldHVybiBbXTsKICAgICAgICB9CiAgICAgIH0sCiAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uIG9uQ2xpY2soZSwgbGVnZW5kSXRlbSkgewogICAgICAgIHZhciBpbmRleCA9IGxlZ2VuZEl0ZW0uaW5kZXg7CiAgICAgICAgdmFyIGNoYXJ0ID0gdGhpcy5jaGFydDsKICAgICAgICB2YXIgaSwgaWxlbiwgbWV0YTsKCiAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IChjaGFydC5kYXRhLmRhdGFzZXRzIHx8IFtdKS5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICAgIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YShpKTsKICAgICAgICAgIG1ldGEuZGF0YVtpbmRleF0uaGlkZGVuID0gIW1ldGEuZGF0YVtpbmRleF0uaGlkZGVuOwogICAgICAgIH0KCiAgICAgICAgY2hhcnQudXBkYXRlKCk7CiAgICAgIH0KICAgIH0sCiAgICAvLyBOZWVkIHRvIG92ZXJyaWRlIHRoZXNlIHRvIGdpdmUgYSBuaWNlIGRlZmF1bHQKICAgIHRvb2x0aXBzOiB7CiAgICAgIGNhbGxiYWNrczogewogICAgICAgIHRpdGxlOiBmdW5jdGlvbiB0aXRsZSgpIHsKICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICB9LAogICAgICAgIGxhYmVsOiBmdW5jdGlvbiBsYWJlbChpdGVtLCBkYXRhKSB7CiAgICAgICAgICByZXR1cm4gZGF0YS5sYWJlbHNbaXRlbS5pbmRleF0gKyAnOiAnICsgaXRlbS55TGFiZWw7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSk7CgogIHZhciBjb250cm9sbGVyX3BvbGFyQXJlYSA9IGNvcmVfZGF0YXNldENvbnRyb2xsZXIuZXh0ZW5kKHsKICAgIGRhdGFFbGVtZW50VHlwZTogZWxlbWVudHMuQXJjLAogICAgbGlua1NjYWxlczogaGVscGVycyQxLm5vb3AsCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9kYXRhRWxlbWVudE9wdGlvbnM6IFsnYmFja2dyb3VuZENvbG9yJywgJ2JvcmRlckNvbG9yJywgJ2JvcmRlcldpZHRoJywgJ2JvcmRlckFsaWduJywgJ2hvdmVyQmFja2dyb3VuZENvbG9yJywgJ2hvdmVyQm9yZGVyQ29sb3InLCAnaG92ZXJCb3JkZXJXaWR0aCddLAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZ2V0SW5kZXhTY2FsZUlkOiBmdW5jdGlvbiBfZ2V0SW5kZXhTY2FsZUlkKCkgewogICAgICByZXR1cm4gdGhpcy5jaGFydC5zY2FsZS5pZDsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9nZXRWYWx1ZVNjYWxlSWQ6IGZ1bmN0aW9uIF9nZXRWYWx1ZVNjYWxlSWQoKSB7CiAgICAgIHJldHVybiB0aGlzLmNoYXJ0LnNjYWxlLmlkOwogICAgfSwKICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKHJlc2V0KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBkYXRhc2V0ID0gbWUuZ2V0RGF0YXNldCgpOwogICAgICB2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKICAgICAgdmFyIHN0YXJ0ID0gbWUuY2hhcnQub3B0aW9ucy5zdGFydEFuZ2xlIHx8IDA7CiAgICAgIHZhciBzdGFydHMgPSBtZS5fc3RhcnRzID0gW107CiAgICAgIHZhciBhbmdsZXMgPSBtZS5fYW5nbGVzID0gW107CiAgICAgIHZhciBhcmNzID0gbWV0YS5kYXRhOwogICAgICB2YXIgaSwgaWxlbiwgYW5nbGU7CgogICAgICBtZS5fdXBkYXRlUmFkaXVzKCk7CgogICAgICBtZXRhLmNvdW50ID0gbWUuY291bnRWaXNpYmxlRWxlbWVudHMoKTsKCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBkYXRhc2V0LmRhdGEubGVuZ3RoOyBpIDwgaWxlbjsgaSsrKSB7CiAgICAgICAgc3RhcnRzW2ldID0gc3RhcnQ7CiAgICAgICAgYW5nbGUgPSBtZS5fY29tcHV0ZUFuZ2xlKGkpOwogICAgICAgIGFuZ2xlc1tpXSA9IGFuZ2xlOwogICAgICAgIHN0YXJ0ICs9IGFuZ2xlOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gYXJjcy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBhcmNzW2ldLl9vcHRpb25zID0gbWUuX3Jlc29sdmVEYXRhRWxlbWVudE9wdGlvbnMoYXJjc1tpXSwgaSk7CiAgICAgICAgbWUudXBkYXRlRWxlbWVudChhcmNzW2ldLCBpLCByZXNldCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF91cGRhdGVSYWRpdXM6IGZ1bmN0aW9uIF91cGRhdGVSYWRpdXMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBjaGFydCA9IG1lLmNoYXJ0OwogICAgICB2YXIgY2hhcnRBcmVhID0gY2hhcnQuY2hhcnRBcmVhOwogICAgICB2YXIgb3B0cyA9IGNoYXJ0Lm9wdGlvbnM7CiAgICAgIHZhciBtaW5TaXplID0gTWF0aC5taW4oY2hhcnRBcmVhLnJpZ2h0IC0gY2hhcnRBcmVhLmxlZnQsIGNoYXJ0QXJlYS5ib3R0b20gLSBjaGFydEFyZWEudG9wKTsKICAgICAgY2hhcnQub3V0ZXJSYWRpdXMgPSBNYXRoLm1heChtaW5TaXplIC8gMiwgMCk7CiAgICAgIGNoYXJ0LmlubmVyUmFkaXVzID0gTWF0aC5tYXgob3B0cy5jdXRvdXRQZXJjZW50YWdlID8gY2hhcnQub3V0ZXJSYWRpdXMgLyAxMDAgKiBvcHRzLmN1dG91dFBlcmNlbnRhZ2UgOiAxLCAwKTsKICAgICAgY2hhcnQucmFkaXVzTGVuZ3RoID0gKGNoYXJ0Lm91dGVyUmFkaXVzIC0gY2hhcnQuaW5uZXJSYWRpdXMpIC8gY2hhcnQuZ2V0VmlzaWJsZURhdGFzZXRDb3VudCgpOwogICAgICBtZS5vdXRlclJhZGl1cyA9IGNoYXJ0Lm91dGVyUmFkaXVzIC0gY2hhcnQucmFkaXVzTGVuZ3RoICogbWUuaW5kZXg7CiAgICAgIG1lLmlubmVyUmFkaXVzID0gbWUub3V0ZXJSYWRpdXMgLSBjaGFydC5yYWRpdXNMZW5ndGg7CiAgICB9LAogICAgdXBkYXRlRWxlbWVudDogZnVuY3Rpb24gdXBkYXRlRWxlbWVudChhcmMsIGluZGV4LCByZXNldCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgY2hhcnQgPSBtZS5jaGFydDsKICAgICAgdmFyIGRhdGFzZXQgPSBtZS5nZXREYXRhc2V0KCk7CiAgICAgIHZhciBvcHRzID0gY2hhcnQub3B0aW9uczsKICAgICAgdmFyIGFuaW1hdGlvbk9wdHMgPSBvcHRzLmFuaW1hdGlvbjsKICAgICAgdmFyIHNjYWxlID0gY2hhcnQuc2NhbGU7CiAgICAgIHZhciBsYWJlbHMgPSBjaGFydC5kYXRhLmxhYmVsczsKICAgICAgdmFyIGNlbnRlclggPSBzY2FsZS54Q2VudGVyOwogICAgICB2YXIgY2VudGVyWSA9IHNjYWxlLnlDZW50ZXI7IC8vIHZhciBuZWdIYWxmUEkgPSAtMC41ICogTWF0aC5QSTsKCiAgICAgIHZhciBkYXRhc2V0U3RhcnRBbmdsZSA9IG9wdHMuc3RhcnRBbmdsZTsKICAgICAgdmFyIGRpc3RhbmNlID0gYXJjLmhpZGRlbiA/IDAgOiBzY2FsZS5nZXREaXN0YW5jZUZyb21DZW50ZXJGb3JWYWx1ZShkYXRhc2V0LmRhdGFbaW5kZXhdKTsKICAgICAgdmFyIHN0YXJ0QW5nbGUgPSBtZS5fc3RhcnRzW2luZGV4XTsKICAgICAgdmFyIGVuZEFuZ2xlID0gc3RhcnRBbmdsZSArIChhcmMuaGlkZGVuID8gMCA6IG1lLl9hbmdsZXNbaW5kZXhdKTsKICAgICAgdmFyIHJlc2V0UmFkaXVzID0gYW5pbWF0aW9uT3B0cy5hbmltYXRlU2NhbGUgPyAwIDogc2NhbGUuZ2V0RGlzdGFuY2VGcm9tQ2VudGVyRm9yVmFsdWUoZGF0YXNldC5kYXRhW2luZGV4XSk7CiAgICAgIHZhciBvcHRpb25zID0gYXJjLl9vcHRpb25zIHx8IHt9OwogICAgICBoZWxwZXJzJDEuZXh0ZW5kKGFyYywgewogICAgICAgIC8vIFV0aWxpdHkKICAgICAgICBfZGF0YXNldEluZGV4OiBtZS5pbmRleCwKICAgICAgICBfaW5kZXg6IGluZGV4LAogICAgICAgIF9zY2FsZTogc2NhbGUsCiAgICAgICAgLy8gRGVzaXJlZCB2aWV3IHByb3BlcnRpZXMKICAgICAgICBfbW9kZWw6IHsKICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogb3B0aW9ucy5iYWNrZ3JvdW5kQ29sb3IsCiAgICAgICAgICBib3JkZXJDb2xvcjogb3B0aW9ucy5ib3JkZXJDb2xvciwKICAgICAgICAgIGJvcmRlcldpZHRoOiBvcHRpb25zLmJvcmRlcldpZHRoLAogICAgICAgICAgYm9yZGVyQWxpZ246IG9wdGlvbnMuYm9yZGVyQWxpZ24sCiAgICAgICAgICB4OiBjZW50ZXJYLAogICAgICAgICAgeTogY2VudGVyWSwKICAgICAgICAgIGlubmVyUmFkaXVzOiAwLAogICAgICAgICAgb3V0ZXJSYWRpdXM6IHJlc2V0ID8gcmVzZXRSYWRpdXMgOiBkaXN0YW5jZSwKICAgICAgICAgIHN0YXJ0QW5nbGU6IHJlc2V0ICYmIGFuaW1hdGlvbk9wdHMuYW5pbWF0ZVJvdGF0ZSA/IGRhdGFzZXRTdGFydEFuZ2xlIDogc3RhcnRBbmdsZSwKICAgICAgICAgIGVuZEFuZ2xlOiByZXNldCAmJiBhbmltYXRpb25PcHRzLmFuaW1hdGVSb3RhdGUgPyBkYXRhc2V0U3RhcnRBbmdsZSA6IGVuZEFuZ2xlLAogICAgICAgICAgbGFiZWw6IGhlbHBlcnMkMS52YWx1ZUF0SW5kZXhPckRlZmF1bHQobGFiZWxzLCBpbmRleCwgbGFiZWxzW2luZGV4XSkKICAgICAgICB9CiAgICAgIH0pOwogICAgICBhcmMucGl2b3QoKTsKICAgIH0sCiAgICBjb3VudFZpc2libGVFbGVtZW50czogZnVuY3Rpb24gY291bnRWaXNpYmxlRWxlbWVudHMoKSB7CiAgICAgIHZhciBkYXRhc2V0ID0gdGhpcy5nZXREYXRhc2V0KCk7CiAgICAgIHZhciBtZXRhID0gdGhpcy5nZXRNZXRhKCk7CiAgICAgIHZhciBjb3VudCA9IDA7CiAgICAgIGhlbHBlcnMkMS5lYWNoKG1ldGEuZGF0YSwgZnVuY3Rpb24gKGVsZW1lbnQsIGluZGV4KSB7CiAgICAgICAgaWYgKCFpc05hTihkYXRhc2V0LmRhdGFbaW5kZXhdKSAmJiAhZWxlbWVudC5oaWRkZW4pIHsKICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIGNvdW50OwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJvdGVjdGVkDQogICAgICovCiAgICBzZXRIb3ZlclN0eWxlOiBmdW5jdGlvbiBzZXRIb3ZlclN0eWxlKGFyYykgewogICAgICB2YXIgbW9kZWwgPSBhcmMuX21vZGVsOwogICAgICB2YXIgb3B0aW9ucyA9IGFyYy5fb3B0aW9uczsKICAgICAgdmFyIGdldEhvdmVyQ29sb3IgPSBoZWxwZXJzJDEuZ2V0SG92ZXJDb2xvcjsKICAgICAgdmFyIHZhbHVlT3JEZWZhdWx0ID0gaGVscGVycyQxLnZhbHVlT3JEZWZhdWx0OwogICAgICBhcmMuJHByZXZpb3VzU3R5bGUgPSB7CiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBtb2RlbC5iYWNrZ3JvdW5kQ29sb3IsCiAgICAgICAgYm9yZGVyQ29sb3I6IG1vZGVsLmJvcmRlckNvbG9yLAogICAgICAgIGJvcmRlcldpZHRoOiBtb2RlbC5ib3JkZXJXaWR0aAogICAgICB9OwogICAgICBtb2RlbC5iYWNrZ3JvdW5kQ29sb3IgPSB2YWx1ZU9yRGVmYXVsdChvcHRpb25zLmhvdmVyQmFja2dyb3VuZENvbG9yLCBnZXRIb3ZlckNvbG9yKG9wdGlvbnMuYmFja2dyb3VuZENvbG9yKSk7CiAgICAgIG1vZGVsLmJvcmRlckNvbG9yID0gdmFsdWVPckRlZmF1bHQob3B0aW9ucy5ob3ZlckJvcmRlckNvbG9yLCBnZXRIb3ZlckNvbG9yKG9wdGlvbnMuYm9yZGVyQ29sb3IpKTsKICAgICAgbW9kZWwuYm9yZGVyV2lkdGggPSB2YWx1ZU9yRGVmYXVsdChvcHRpb25zLmhvdmVyQm9yZGVyV2lkdGgsIG9wdGlvbnMuYm9yZGVyV2lkdGgpOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2NvbXB1dGVBbmdsZTogZnVuY3Rpb24gX2NvbXB1dGVBbmdsZShpbmRleCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgY291bnQgPSB0aGlzLmdldE1ldGEoKS5jb3VudDsKICAgICAgdmFyIGRhdGFzZXQgPSBtZS5nZXREYXRhc2V0KCk7CiAgICAgIHZhciBtZXRhID0gbWUuZ2V0TWV0YSgpOwoKICAgICAgaWYgKGlzTmFOKGRhdGFzZXQuZGF0YVtpbmRleF0pIHx8IG1ldGEuZGF0YVtpbmRleF0uaGlkZGVuKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICAgIH0gLy8gU2NyaXB0YWJsZSBvcHRpb25zCgoKICAgICAgdmFyIGNvbnRleHQgPSB7CiAgICAgICAgY2hhcnQ6IG1lLmNoYXJ0LAogICAgICAgIGRhdGFJbmRleDogaW5kZXgsCiAgICAgICAgZGF0YXNldDogZGF0YXNldCwKICAgICAgICBkYXRhc2V0SW5kZXg6IG1lLmluZGV4CiAgICAgIH07CiAgICAgIHJldHVybiByZXNvbHZlJDMoW21lLmNoYXJ0Lm9wdGlvbnMuZWxlbWVudHMuYXJjLmFuZ2xlLCAyICogTWF0aC5QSSAvIGNvdW50XSwgY29udGV4dCwgaW5kZXgpOwogICAgfQogIH0pOwoKICBjb3JlX2RlZmF1bHRzLl9zZXQoJ3BpZScsIGhlbHBlcnMkMS5jbG9uZShjb3JlX2RlZmF1bHRzLmRvdWdobnV0KSk7CgogIGNvcmVfZGVmYXVsdHMuX3NldCgncGllJywgewogICAgY3V0b3V0UGVyY2VudGFnZTogMAogIH0pOyAvLyBQaWUgY2hhcnRzIGFyZSBEb3VnaG51dCBjaGFydCB3aXRoIGRpZmZlcmVudCBkZWZhdWx0cwoKCiAgdmFyIGNvbnRyb2xsZXJfcGllID0gY29udHJvbGxlcl9kb3VnaG51dDsKICB2YXIgdmFsdWVPckRlZmF1bHQkNyA9IGhlbHBlcnMkMS52YWx1ZU9yRGVmYXVsdDsKCiAgY29yZV9kZWZhdWx0cy5fc2V0KCdyYWRhcicsIHsKICAgIHNwYW5HYXBzOiBmYWxzZSwKICAgIHNjYWxlOiB7CiAgICAgIHR5cGU6ICdyYWRpYWxMaW5lYXInCiAgICB9LAogICAgZWxlbWVudHM6IHsKICAgICAgbGluZTogewogICAgICAgIGZpbGw6ICdzdGFydCcsCiAgICAgICAgdGVuc2lvbjogMCAvLyBubyBiZXppZXIgaW4gcmFkYXIKCiAgICAgIH0KICAgIH0KICB9KTsKCiAgdmFyIGNvbnRyb2xsZXJfcmFkYXIgPSBjb3JlX2RhdGFzZXRDb250cm9sbGVyLmV4dGVuZCh7CiAgICBkYXRhc2V0RWxlbWVudFR5cGU6IGVsZW1lbnRzLkxpbmUsCiAgICBkYXRhRWxlbWVudFR5cGU6IGVsZW1lbnRzLlBvaW50LAogICAgbGlua1NjYWxlczogaGVscGVycyQxLm5vb3AsCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9kYXRhc2V0RWxlbWVudE9wdGlvbnM6IFsnYmFja2dyb3VuZENvbG9yJywgJ2JvcmRlcldpZHRoJywgJ2JvcmRlckNvbG9yJywgJ2JvcmRlckNhcFN0eWxlJywgJ2JvcmRlckRhc2gnLCAnYm9yZGVyRGFzaE9mZnNldCcsICdib3JkZXJKb2luU3R5bGUnLCAnZmlsbCddLAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZGF0YUVsZW1lbnRPcHRpb25zOiB7CiAgICAgIGJhY2tncm91bmRDb2xvcjogJ3BvaW50QmFja2dyb3VuZENvbG9yJywKICAgICAgYm9yZGVyQ29sb3I6ICdwb2ludEJvcmRlckNvbG9yJywKICAgICAgYm9yZGVyV2lkdGg6ICdwb2ludEJvcmRlcldpZHRoJywKICAgICAgaGl0UmFkaXVzOiAncG9pbnRIaXRSYWRpdXMnLAogICAgICBob3ZlckJhY2tncm91bmRDb2xvcjogJ3BvaW50SG92ZXJCYWNrZ3JvdW5kQ29sb3InLAogICAgICBob3ZlckJvcmRlckNvbG9yOiAncG9pbnRIb3ZlckJvcmRlckNvbG9yJywKICAgICAgaG92ZXJCb3JkZXJXaWR0aDogJ3BvaW50SG92ZXJCb3JkZXJXaWR0aCcsCiAgICAgIGhvdmVyUmFkaXVzOiAncG9pbnRIb3ZlclJhZGl1cycsCiAgICAgIHBvaW50U3R5bGU6ICdwb2ludFN0eWxlJywKICAgICAgcmFkaXVzOiAncG9pbnRSYWRpdXMnLAogICAgICByb3RhdGlvbjogJ3BvaW50Um90YXRpb24nCiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZ2V0SW5kZXhTY2FsZUlkOiBmdW5jdGlvbiBfZ2V0SW5kZXhTY2FsZUlkKCkgewogICAgICByZXR1cm4gdGhpcy5jaGFydC5zY2FsZS5pZDsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9nZXRWYWx1ZVNjYWxlSWQ6IGZ1bmN0aW9uIF9nZXRWYWx1ZVNjYWxlSWQoKSB7CiAgICAgIHJldHVybiB0aGlzLmNoYXJ0LnNjYWxlLmlkOwogICAgfSwKICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKHJlc2V0KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBtZXRhID0gbWUuZ2V0TWV0YSgpOwogICAgICB2YXIgbGluZSA9IG1ldGEuZGF0YXNldDsKICAgICAgdmFyIHBvaW50cyA9IG1ldGEuZGF0YSB8fCBbXTsKICAgICAgdmFyIHNjYWxlID0gbWUuY2hhcnQuc2NhbGU7CiAgICAgIHZhciBjb25maWcgPSBtZS5fY29uZmlnOwogICAgICB2YXIgaSwgaWxlbjsgLy8gQ29tcGF0aWJpbGl0eTogSWYgdGhlIHByb3BlcnRpZXMgYXJlIGRlZmluZWQgd2l0aCBvbmx5IHRoZSBvbGQgbmFtZSwgdXNlIHRob3NlIHZhbHVlcwoKICAgICAgaWYgKGNvbmZpZy50ZW5zaW9uICE9PSB1bmRlZmluZWQgJiYgY29uZmlnLmxpbmVUZW5zaW9uID09PSB1bmRlZmluZWQpIHsKICAgICAgICBjb25maWcubGluZVRlbnNpb24gPSBjb25maWcudGVuc2lvbjsKICAgICAgfSAvLyBVdGlsaXR5CgoKICAgICAgbGluZS5fc2NhbGUgPSBzY2FsZTsKICAgICAgbGluZS5fZGF0YXNldEluZGV4ID0gbWUuaW5kZXg7IC8vIERhdGEKCiAgICAgIGxpbmUuX2NoaWxkcmVuID0gcG9pbnRzOwogICAgICBsaW5lLl9sb29wID0gdHJ1ZTsgLy8gTW9kZWwKCiAgICAgIGxpbmUuX21vZGVsID0gbWUuX3Jlc29sdmVEYXRhc2V0RWxlbWVudE9wdGlvbnMobGluZSk7CiAgICAgIGxpbmUucGl2b3QoKTsgLy8gVXBkYXRlIFBvaW50cwoKICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHBvaW50cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBtZS51cGRhdGVFbGVtZW50KHBvaW50c1tpXSwgaSwgcmVzZXQpOwogICAgICB9IC8vIFVwZGF0ZSBiZXppZXIgY29udHJvbCBwb2ludHMKCgogICAgICBtZS51cGRhdGVCZXppZXJDb250cm9sUG9pbnRzKCk7IC8vIE5vdyBwaXZvdCB0aGUgcG9pbnQgZm9yIGFuaW1hdGlvbgoKICAgICAgZm9yIChpID0gMCwgaWxlbiA9IHBvaW50cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBwb2ludHNbaV0ucGl2b3QoKTsKICAgICAgfQogICAgfSwKICAgIHVwZGF0ZUVsZW1lbnQ6IGZ1bmN0aW9uIHVwZGF0ZUVsZW1lbnQocG9pbnQsIGluZGV4LCByZXNldCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgY3VzdG9tID0gcG9pbnQuY3VzdG9tIHx8IHt9OwogICAgICB2YXIgZGF0YXNldCA9IG1lLmdldERhdGFzZXQoKTsKICAgICAgdmFyIHNjYWxlID0gbWUuY2hhcnQuc2NhbGU7CiAgICAgIHZhciBwb2ludFBvc2l0aW9uID0gc2NhbGUuZ2V0UG9pbnRQb3NpdGlvbkZvclZhbHVlKGluZGV4LCBkYXRhc2V0LmRhdGFbaW5kZXhdKTsKCiAgICAgIHZhciBvcHRpb25zID0gbWUuX3Jlc29sdmVEYXRhRWxlbWVudE9wdGlvbnMocG9pbnQsIGluZGV4KTsKCiAgICAgIHZhciBsaW5lTW9kZWwgPSBtZS5nZXRNZXRhKCkuZGF0YXNldC5fbW9kZWw7CgogICAgICB2YXIgeCA9IHJlc2V0ID8gc2NhbGUueENlbnRlciA6IHBvaW50UG9zaXRpb24ueDsKICAgICAgdmFyIHkgPSByZXNldCA/IHNjYWxlLnlDZW50ZXIgOiBwb2ludFBvc2l0aW9uLnk7IC8vIFV0aWxpdHkKCiAgICAgIHBvaW50Ll9zY2FsZSA9IHNjYWxlOwogICAgICBwb2ludC5fb3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgIHBvaW50Ll9kYXRhc2V0SW5kZXggPSBtZS5pbmRleDsKICAgICAgcG9pbnQuX2luZGV4ID0gaW5kZXg7IC8vIERlc2lyZWQgdmlldyBwcm9wZXJ0aWVzCgogICAgICBwb2ludC5fbW9kZWwgPSB7CiAgICAgICAgeDogeCwKICAgICAgICAvLyB2YWx1ZSBub3QgdXNlZCBpbiBkYXRhc2V0IHNjYWxlLCBidXQgd2Ugd2FudCBhIGNvbnNpc3RlbnQgQVBJIGJldHdlZW4gc2NhbGVzCiAgICAgICAgeTogeSwKICAgICAgICBza2lwOiBjdXN0b20uc2tpcCB8fCBpc05hTih4KSB8fCBpc05hTih5KSwKICAgICAgICAvLyBBcHBlYXJhbmNlCiAgICAgICAgcmFkaXVzOiBvcHRpb25zLnJhZGl1cywKICAgICAgICBwb2ludFN0eWxlOiBvcHRpb25zLnBvaW50U3R5bGUsCiAgICAgICAgcm90YXRpb246IG9wdGlvbnMucm90YXRpb24sCiAgICAgICAgYmFja2dyb3VuZENvbG9yOiBvcHRpb25zLmJhY2tncm91bmRDb2xvciwKICAgICAgICBib3JkZXJDb2xvcjogb3B0aW9ucy5ib3JkZXJDb2xvciwKICAgICAgICBib3JkZXJXaWR0aDogb3B0aW9ucy5ib3JkZXJXaWR0aCwKICAgICAgICB0ZW5zaW9uOiB2YWx1ZU9yRGVmYXVsdCQ3KGN1c3RvbS50ZW5zaW9uLCBsaW5lTW9kZWwgPyBsaW5lTW9kZWwudGVuc2lvbiA6IDApLAogICAgICAgIC8vIFRvb2x0aXAKICAgICAgICBoaXRSYWRpdXM6IG9wdGlvbnMuaGl0UmFkaXVzCiAgICAgIH07CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfcmVzb2x2ZURhdGFzZXRFbGVtZW50T3B0aW9uczogZnVuY3Rpb24gX3Jlc29sdmVEYXRhc2V0RWxlbWVudE9wdGlvbnMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBjb25maWcgPSBtZS5fY29uZmlnOwogICAgICB2YXIgb3B0aW9ucyA9IG1lLmNoYXJ0Lm9wdGlvbnM7CgogICAgICB2YXIgdmFsdWVzID0gY29yZV9kYXRhc2V0Q29udHJvbGxlci5wcm90b3R5cGUuX3Jlc29sdmVEYXRhc2V0RWxlbWVudE9wdGlvbnMuYXBwbHkobWUsIGFyZ3VtZW50cyk7CgogICAgICB2YWx1ZXMuc3BhbkdhcHMgPSB2YWx1ZU9yRGVmYXVsdCQ3KGNvbmZpZy5zcGFuR2Fwcywgb3B0aW9ucy5zcGFuR2Fwcyk7CiAgICAgIHZhbHVlcy50ZW5zaW9uID0gdmFsdWVPckRlZmF1bHQkNyhjb25maWcubGluZVRlbnNpb24sIG9wdGlvbnMuZWxlbWVudHMubGluZS50ZW5zaW9uKTsKICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0sCiAgICB1cGRhdGVCZXppZXJDb250cm9sUG9pbnRzOiBmdW5jdGlvbiB1cGRhdGVCZXppZXJDb250cm9sUG9pbnRzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgbWV0YSA9IG1lLmdldE1ldGEoKTsKICAgICAgdmFyIGFyZWEgPSBtZS5jaGFydC5jaGFydEFyZWE7CiAgICAgIHZhciBwb2ludHMgPSBtZXRhLmRhdGEgfHwgW107CiAgICAgIHZhciBpLCBpbGVuLCBtb2RlbCwgY29udHJvbFBvaW50czsgLy8gT25seSBjb25zaWRlciBwb2ludHMgdGhhdCBhcmUgZHJhd24gaW4gY2FzZSB0aGUgc3BhbkdhcHMgb3B0aW9uIGlzIHVzZWQKCiAgICAgIGlmIChtZXRhLmRhdGFzZXQuX21vZGVsLnNwYW5HYXBzKSB7CiAgICAgICAgcG9pbnRzID0gcG9pbnRzLmZpbHRlcihmdW5jdGlvbiAocHQpIHsKICAgICAgICAgIHJldHVybiAhcHQuX21vZGVsLnNraXA7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIGZ1bmN0aW9uIGNhcENvbnRyb2xQb2ludChwdCwgbWluLCBtYXgpIHsKICAgICAgICByZXR1cm4gTWF0aC5tYXgoTWF0aC5taW4ocHQsIG1heCksIG1pbik7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBwb2ludHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgbW9kZWwgPSBwb2ludHNbaV0uX21vZGVsOwogICAgICAgIGNvbnRyb2xQb2ludHMgPSBoZWxwZXJzJDEuc3BsaW5lQ3VydmUoaGVscGVycyQxLnByZXZpb3VzSXRlbShwb2ludHMsIGksIHRydWUpLl9tb2RlbCwgbW9kZWwsIGhlbHBlcnMkMS5uZXh0SXRlbShwb2ludHMsIGksIHRydWUpLl9tb2RlbCwgbW9kZWwudGVuc2lvbik7IC8vIFByZXZlbnQgdGhlIGJlemllciBnb2luZyBvdXRzaWRlIG9mIHRoZSBib3VuZHMgb2YgdGhlIGdyYXBoCgogICAgICAgIG1vZGVsLmNvbnRyb2xQb2ludFByZXZpb3VzWCA9IGNhcENvbnRyb2xQb2ludChjb250cm9sUG9pbnRzLnByZXZpb3VzLngsIGFyZWEubGVmdCwgYXJlYS5yaWdodCk7CiAgICAgICAgbW9kZWwuY29udHJvbFBvaW50UHJldmlvdXNZID0gY2FwQ29udHJvbFBvaW50KGNvbnRyb2xQb2ludHMucHJldmlvdXMueSwgYXJlYS50b3AsIGFyZWEuYm90dG9tKTsKICAgICAgICBtb2RlbC5jb250cm9sUG9pbnROZXh0WCA9IGNhcENvbnRyb2xQb2ludChjb250cm9sUG9pbnRzLm5leHQueCwgYXJlYS5sZWZ0LCBhcmVhLnJpZ2h0KTsKICAgICAgICBtb2RlbC5jb250cm9sUG9pbnROZXh0WSA9IGNhcENvbnRyb2xQb2ludChjb250cm9sUG9pbnRzLm5leHQueSwgYXJlYS50b3AsIGFyZWEuYm90dG9tKTsKICAgICAgfQogICAgfSwKICAgIHNldEhvdmVyU3R5bGU6IGZ1bmN0aW9uIHNldEhvdmVyU3R5bGUocG9pbnQpIHsKICAgICAgdmFyIG1vZGVsID0gcG9pbnQuX21vZGVsOwogICAgICB2YXIgb3B0aW9ucyA9IHBvaW50Ll9vcHRpb25zOwogICAgICB2YXIgZ2V0SG92ZXJDb2xvciA9IGhlbHBlcnMkMS5nZXRIb3ZlckNvbG9yOwogICAgICBwb2ludC4kcHJldmlvdXNTdHlsZSA9IHsKICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IG1vZGVsLmJhY2tncm91bmRDb2xvciwKICAgICAgICBib3JkZXJDb2xvcjogbW9kZWwuYm9yZGVyQ29sb3IsCiAgICAgICAgYm9yZGVyV2lkdGg6IG1vZGVsLmJvcmRlcldpZHRoLAogICAgICAgIHJhZGl1czogbW9kZWwucmFkaXVzCiAgICAgIH07CiAgICAgIG1vZGVsLmJhY2tncm91bmRDb2xvciA9IHZhbHVlT3JEZWZhdWx0JDcob3B0aW9ucy5ob3ZlckJhY2tncm91bmRDb2xvciwgZ2V0SG92ZXJDb2xvcihvcHRpb25zLmJhY2tncm91bmRDb2xvcikpOwogICAgICBtb2RlbC5ib3JkZXJDb2xvciA9IHZhbHVlT3JEZWZhdWx0JDcob3B0aW9ucy5ob3ZlckJvcmRlckNvbG9yLCBnZXRIb3ZlckNvbG9yKG9wdGlvbnMuYm9yZGVyQ29sb3IpKTsKICAgICAgbW9kZWwuYm9yZGVyV2lkdGggPSB2YWx1ZU9yRGVmYXVsdCQ3KG9wdGlvbnMuaG92ZXJCb3JkZXJXaWR0aCwgb3B0aW9ucy5ib3JkZXJXaWR0aCk7CiAgICAgIG1vZGVsLnJhZGl1cyA9IHZhbHVlT3JEZWZhdWx0JDcob3B0aW9ucy5ob3ZlclJhZGl1cywgb3B0aW9ucy5yYWRpdXMpOwogICAgfQogIH0pOwoKICBjb3JlX2RlZmF1bHRzLl9zZXQoJ3NjYXR0ZXInLCB7CiAgICBob3ZlcjogewogICAgICBtb2RlOiAnc2luZ2xlJwogICAgfSwKICAgIHNjYWxlczogewogICAgICB4QXhlczogW3sKICAgICAgICBpZDogJ3gtYXhpcy0xJywKICAgICAgICAvLyBuZWVkIGFuIElEIHNvIGRhdGFzZXRzIGNhbiByZWZlcmVuY2UgdGhlIHNjYWxlCiAgICAgICAgdHlwZTogJ2xpbmVhcicsCiAgICAgICAgLy8gc2NhdHRlciBzaG91bGQgbm90IHVzZSBhIGNhdGVnb3J5IGF4aXMKICAgICAgICBwb3NpdGlvbjogJ2JvdHRvbScKICAgICAgfV0sCiAgICAgIHlBeGVzOiBbewogICAgICAgIGlkOiAneS1heGlzLTEnLAogICAgICAgIHR5cGU6ICdsaW5lYXInLAogICAgICAgIHBvc2l0aW9uOiAnbGVmdCcKICAgICAgfV0KICAgIH0sCiAgICB0b29sdGlwczogewogICAgICBjYWxsYmFja3M6IHsKICAgICAgICB0aXRsZTogZnVuY3Rpb24gdGl0bGUoKSB7CiAgICAgICAgICByZXR1cm4gJyc7IC8vIGRvZXNuJ3QgbWFrZSBzZW5zZSBmb3Igc2NhdHRlciBzaW5jZSBkYXRhIGFyZSBmb3JtYXR0ZWQgYXMgYSBwb2ludAogICAgICAgIH0sCiAgICAgICAgbGFiZWw6IGZ1bmN0aW9uIGxhYmVsKGl0ZW0pIHsKICAgICAgICAgIHJldHVybiAnKCcgKyBpdGVtLnhMYWJlbCArICcsICcgKyBpdGVtLnlMYWJlbCArICcpJzsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKCiAgY29yZV9kZWZhdWx0cy5fc2V0KCdnbG9iYWwnLCB7CiAgICBkYXRhc2V0czogewogICAgICBzY2F0dGVyOiB7CiAgICAgICAgc2hvd0xpbmU6IGZhbHNlCiAgICAgIH0KICAgIH0KICB9KTsgLy8gU2NhdHRlciBjaGFydHMgdXNlIGxpbmUgY29udHJvbGxlcnMKCgogIHZhciBjb250cm9sbGVyX3NjYXR0ZXIgPSBjb250cm9sbGVyX2xpbmU7IC8vIE5PVEUgZXhwb3J0IGEgbWFwIGluIHdoaWNoIHRoZSBrZXkgcmVwcmVzZW50cyB0aGUgY29udHJvbGxlciB0eXBlLCBub3QKICAvLyB0aGUgY2xhc3MsIGFuZCBzbyBtdXN0IGJlIENhbWVsQ2FzZSBpbiBvcmRlciB0byBiZSBjb3JyZWN0bHkgcmV0cmlldmVkCiAgLy8gYnkgdGhlIGNvbnRyb2xsZXIgaW4gY29yZS5jb250cm9sbGVyLmpzIChgY29udHJvbGxlcnNbbWV0YS50eXBlXWApLgoKICB2YXIgY29udHJvbGxlcnMgPSB7CiAgICBiYXI6IGNvbnRyb2xsZXJfYmFyLAogICAgYnViYmxlOiBjb250cm9sbGVyX2J1YmJsZSwKICAgIGRvdWdobnV0OiBjb250cm9sbGVyX2RvdWdobnV0LAogICAgaG9yaXpvbnRhbEJhcjogY29udHJvbGxlcl9ob3Jpem9udGFsQmFyLAogICAgbGluZTogY29udHJvbGxlcl9saW5lLAogICAgcG9sYXJBcmVhOiBjb250cm9sbGVyX3BvbGFyQXJlYSwKICAgIHBpZTogY29udHJvbGxlcl9waWUsCiAgICByYWRhcjogY29udHJvbGxlcl9yYWRhciwKICAgIHNjYXR0ZXI6IGNvbnRyb2xsZXJfc2NhdHRlcgogIH07CiAgLyoqDQogICAqIEhlbHBlciBmdW5jdGlvbiB0byBnZXQgcmVsYXRpdmUgcG9zaXRpb24gZm9yIGFuIGV2ZW50DQogICAqIEBwYXJhbSB7RXZlbnR8SUV2ZW50fSBldmVudCAtIFRoZSBldmVudCB0byBnZXQgdGhlIHBvc2l0aW9uIGZvcg0KICAgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIFRoZSBjaGFydA0KICAgKiBAcmV0dXJucyB7b2JqZWN0fSB0aGUgZXZlbnQgcG9zaXRpb24NCiAgICovCgogIGZ1bmN0aW9uIGdldFJlbGF0aXZlUG9zaXRpb24oZSwgY2hhcnQpIHsKICAgIGlmIChlLm5hdGl2ZSkgewogICAgICByZXR1cm4gewogICAgICAgIHg6IGUueCwKICAgICAgICB5OiBlLnkKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gaGVscGVycyQxLmdldFJlbGF0aXZlUG9zaXRpb24oZSwgY2hhcnQpOwogIH0KICAvKioNCiAgICogSGVscGVyIGZ1bmN0aW9uIHRvIHRyYXZlcnNlIGFsbCBvZiB0aGUgdmlzaWJsZSBlbGVtZW50cyBpbiB0aGUgY2hhcnQNCiAgICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSB0aGUgY2hhcnQNCiAgICogQHBhcmFtIHtmdW5jdGlvbn0gaGFuZGxlciAtIHRoZSBjYWxsYmFjayB0byBleGVjdXRlIGZvciBlYWNoIHZpc2libGUgaXRlbQ0KICAgKi8KCgogIGZ1bmN0aW9uIHBhcnNlVmlzaWJsZUl0ZW1zKGNoYXJ0LCBoYW5kbGVyKSB7CiAgICB2YXIgbWV0YXNldHMgPSBjaGFydC5fZ2V0U29ydGVkVmlzaWJsZURhdGFzZXRNZXRhcygpOwoKICAgIHZhciBtZXRhZGF0YSwgaSwgaiwgaWxlbiwgamxlbiwgZWxlbWVudDsKCiAgICBmb3IgKGkgPSAwLCBpbGVuID0gbWV0YXNldHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgIG1ldGFkYXRhID0gbWV0YXNldHNbaV0uZGF0YTsKCiAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBtZXRhZGF0YS5sZW5ndGg7IGogPCBqbGVuOyArK2opIHsKICAgICAgICBlbGVtZW50ID0gbWV0YWRhdGFbal07CgogICAgICAgIGlmICghZWxlbWVudC5fdmlldy5za2lwKSB7CiAgICAgICAgICBoYW5kbGVyKGVsZW1lbnQpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH0KICAvKioNCiAgICogSGVscGVyIGZ1bmN0aW9uIHRvIGdldCB0aGUgaXRlbXMgdGhhdCBpbnRlcnNlY3QgdGhlIGV2ZW50IHBvc2l0aW9uDQogICAqIEBwYXJhbSB7Q2hhcnRFbGVtZW50W119IGl0ZW1zIC0gZWxlbWVudHMgdG8gZmlsdGVyDQogICAqIEBwYXJhbSB7b2JqZWN0fSBwb3NpdGlvbiAtIHRoZSBwb2ludCB0byBiZSBuZWFyZXN0IHRvDQogICAqIEByZXR1cm4ge0NoYXJ0RWxlbWVudFtdfSB0aGUgbmVhcmVzdCBpdGVtcw0KICAgKi8KCgogIGZ1bmN0aW9uIGdldEludGVyc2VjdEl0ZW1zKGNoYXJ0LCBwb3NpdGlvbikgewogICAgdmFyIGVsZW1lbnRzID0gW107CiAgICBwYXJzZVZpc2libGVJdGVtcyhjaGFydCwgZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgICAgaWYgKGVsZW1lbnQuaW5SYW5nZShwb3NpdGlvbi54LCBwb3NpdGlvbi55KSkgewogICAgICAgIGVsZW1lbnRzLnB1c2goZWxlbWVudCk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIGVsZW1lbnRzOwogIH0KICAvKioNCiAgICogSGVscGVyIGZ1bmN0aW9uIHRvIGdldCB0aGUgaXRlbXMgbmVhcmVzdCB0byB0aGUgZXZlbnQgcG9zaXRpb24gY29uc2lkZXJpbmcgYWxsIHZpc2libGUgaXRlbXMgaW4gdGVoIGNoYXJ0DQogICAqIEBwYXJhbSB7Q2hhcnR9IGNoYXJ0IC0gdGhlIGNoYXJ0IHRvIGxvb2sgYXQgZWxlbWVudHMgZnJvbQ0KICAgKiBAcGFyYW0ge29iamVjdH0gcG9zaXRpb24gLSB0aGUgcG9pbnQgdG8gYmUgbmVhcmVzdCB0bw0KICAgKiBAcGFyYW0ge2Jvb2xlYW59IGludGVyc2VjdCAtIGlmIHRydWUsIG9ubHkgY29uc2lkZXIgaXRlbXMgdGhhdCBpbnRlcnNlY3QgdGhlIHBvc2l0aW9uDQogICAqIEBwYXJhbSB7ZnVuY3Rpb259IGRpc3RhbmNlTWV0cmljIC0gZnVuY3Rpb24gdG8gcHJvdmlkZSB0aGUgZGlzdGFuY2UgYmV0d2VlbiBwb2ludHMNCiAgICogQHJldHVybiB7Q2hhcnRFbGVtZW50W119IHRoZSBuZWFyZXN0IGl0ZW1zDQogICAqLwoKCiAgZnVuY3Rpb24gZ2V0TmVhcmVzdEl0ZW1zKGNoYXJ0LCBwb3NpdGlvbiwgaW50ZXJzZWN0LCBkaXN0YW5jZU1ldHJpYykgewogICAgdmFyIG1pbkRpc3RhbmNlID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgdmFyIG5lYXJlc3RJdGVtcyA9IFtdOwogICAgcGFyc2VWaXNpYmxlSXRlbXMoY2hhcnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgIGlmIChpbnRlcnNlY3QgJiYgIWVsZW1lbnQuaW5SYW5nZShwb3NpdGlvbi54LCBwb3NpdGlvbi55KSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGNlbnRlciA9IGVsZW1lbnQuZ2V0Q2VudGVyUG9pbnQoKTsKICAgICAgdmFyIGRpc3RhbmNlID0gZGlzdGFuY2VNZXRyaWMocG9zaXRpb24sIGNlbnRlcik7CgogICAgICBpZiAoZGlzdGFuY2UgPCBtaW5EaXN0YW5jZSkgewogICAgICAgIG5lYXJlc3RJdGVtcyA9IFtlbGVtZW50XTsKICAgICAgICBtaW5EaXN0YW5jZSA9IGRpc3RhbmNlOwogICAgICB9IGVsc2UgaWYgKGRpc3RhbmNlID09PSBtaW5EaXN0YW5jZSkgewogICAgICAgIC8vIENhbiBoYXZlIG11bHRpcGxlIGl0ZW1zIGF0IHRoZSBzYW1lIGRpc3RhbmNlIGluIHdoaWNoIGNhc2Ugd2Ugc29ydCBieSBzaXplCiAgICAgICAgbmVhcmVzdEl0ZW1zLnB1c2goZWxlbWVudCk7CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIG5lYXJlc3RJdGVtczsKICB9CiAgLyoqDQogICAqIEdldCBhIGRpc3RhbmNlIG1ldHJpYyBmdW5jdGlvbiBmb3IgdHdvIHBvaW50cyBiYXNlZCBvbiB0aGUNCiAgICogYXhpcyBtb2RlIHNldHRpbmcNCiAgICogQHBhcmFtIHtzdHJpbmd9IGF4aXMgLSB0aGUgYXhpcyBtb2RlLiB4fHl8eHkNCiAgICovCgoKICBmdW5jdGlvbiBnZXREaXN0YW5jZU1ldHJpY0ZvckF4aXMoYXhpcykgewogICAgdmFyIHVzZVggPSBheGlzLmluZGV4T2YoJ3gnKSAhPT0gLTE7CiAgICB2YXIgdXNlWSA9IGF4aXMuaW5kZXhPZigneScpICE9PSAtMTsKICAgIHJldHVybiBmdW5jdGlvbiAocHQxLCBwdDIpIHsKICAgICAgdmFyIGRlbHRhWCA9IHVzZVggPyBNYXRoLmFicyhwdDEueCAtIHB0Mi54KSA6IDA7CiAgICAgIHZhciBkZWx0YVkgPSB1c2VZID8gTWF0aC5hYnMocHQxLnkgLSBwdDIueSkgOiAwOwogICAgICByZXR1cm4gTWF0aC5zcXJ0KE1hdGgucG93KGRlbHRhWCwgMikgKyBNYXRoLnBvdyhkZWx0YVksIDIpKTsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBpbmRleE1vZGUoY2hhcnQsIGUsIG9wdGlvbnMpIHsKICAgIHZhciBwb3NpdGlvbiA9IGdldFJlbGF0aXZlUG9zaXRpb24oZSwgY2hhcnQpOyAvLyBEZWZhdWx0IGF4aXMgZm9yIGluZGV4IG1vZGUgaXMgJ3gnIHRvIG1hdGNoIG9sZCBiZWhhdmlvdXIKCiAgICBvcHRpb25zLmF4aXMgPSBvcHRpb25zLmF4aXMgfHwgJ3gnOwogICAgdmFyIGRpc3RhbmNlTWV0cmljID0gZ2V0RGlzdGFuY2VNZXRyaWNGb3JBeGlzKG9wdGlvbnMuYXhpcyk7CiAgICB2YXIgaXRlbXMgPSBvcHRpb25zLmludGVyc2VjdCA/IGdldEludGVyc2VjdEl0ZW1zKGNoYXJ0LCBwb3NpdGlvbikgOiBnZXROZWFyZXN0SXRlbXMoY2hhcnQsIHBvc2l0aW9uLCBmYWxzZSwgZGlzdGFuY2VNZXRyaWMpOwogICAgdmFyIGVsZW1lbnRzID0gW107CgogICAgaWYgKCFpdGVtcy5sZW5ndGgpIHsKICAgICAgcmV0dXJuIFtdOwogICAgfQoKICAgIGNoYXJ0Ll9nZXRTb3J0ZWRWaXNpYmxlRGF0YXNldE1ldGFzKCkuZm9yRWFjaChmdW5jdGlvbiAobWV0YSkgewogICAgICB2YXIgZWxlbWVudCA9IG1ldGEuZGF0YVtpdGVtc1swXS5faW5kZXhdOyAvLyBkb24ndCBjb3VudCBpdGVtcyB0aGF0IGFyZSBza2lwcGVkIChudWxsIGRhdGEpCgogICAgICBpZiAoZWxlbWVudCAmJiAhZWxlbWVudC5fdmlldy5za2lwKSB7CiAgICAgICAgZWxlbWVudHMucHVzaChlbGVtZW50KTsKICAgICAgfQogICAgfSk7CgogICAgcmV0dXJuIGVsZW1lbnRzOwogIH0KICAvKioNCiAgICogQGludGVyZmFjZSBJSW50ZXJhY3Rpb25PcHRpb25zDQogICAqLwoKICAvKioNCiAgICogSWYgdHJ1ZSwgb25seSBjb25zaWRlciBpdGVtcyB0aGF0IGludGVyc2VjdCB0aGUgcG9pbnQNCiAgICogQG5hbWUgSUludGVyZmFjZU9wdGlvbnMjYm9vbGVhbg0KICAgKiBAdHlwZSBCb29sZWFuDQogICAqLwoKICAvKioNCiAgICogQ29udGFpbnMgaW50ZXJhY3Rpb24gcmVsYXRlZCBmdW5jdGlvbnMNCiAgICogQG5hbWVzcGFjZSBDaGFydC5JbnRlcmFjdGlvbg0KICAgKi8KCgogIHZhciBjb3JlX2ludGVyYWN0aW9uID0gewogICAgLy8gSGVscGVyIGZ1bmN0aW9uIGZvciBkaWZmZXJlbnQgbW9kZXMKICAgIG1vZGVzOiB7CiAgICAgIHNpbmdsZTogZnVuY3Rpb24gc2luZ2xlKGNoYXJ0LCBlKSB7CiAgICAgICAgdmFyIHBvc2l0aW9uID0gZ2V0UmVsYXRpdmVQb3NpdGlvbihlLCBjaGFydCk7CiAgICAgICAgdmFyIGVsZW1lbnRzID0gW107CiAgICAgICAgcGFyc2VWaXNpYmxlSXRlbXMoY2hhcnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICBpZiAoZWxlbWVudC5pblJhbmdlKHBvc2l0aW9uLngsIHBvc2l0aW9uLnkpKSB7CiAgICAgICAgICAgIGVsZW1lbnRzLnB1c2goZWxlbWVudCk7CiAgICAgICAgICAgIHJldHVybiBlbGVtZW50czsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gZWxlbWVudHMuc2xpY2UoMCwgMSk7CiAgICAgIH0sCgogICAgICAvKioNCiAgICAgICAqIEBmdW5jdGlvbiBDaGFydC5JbnRlcmFjdGlvbi5tb2Rlcy5sYWJlbA0KICAgICAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjQuMA0KICAgICAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgICAgICogQHByaXZhdGUNCiAgICAgICAqLwogICAgICBsYWJlbDogaW5kZXhNb2RlLAoKICAgICAgLyoqDQogICAgICAgKiBSZXR1cm5zIGl0ZW1zIGF0IHRoZSBzYW1lIGluZGV4LiBJZiB0aGUgb3B0aW9ucy5pbnRlcnNlY3QgcGFyYW1ldGVyIGlzIHRydWUsIHdlIG9ubHkgcmV0dXJuIGl0ZW1zIGlmIHdlIGludGVyc2VjdCBzb21ldGhpbmcNCiAgICAgICAqIElmIHRoZSBvcHRpb25zLmludGVyc2VjdCBtb2RlIGlzIGZhbHNlLCB3ZSBmaW5kIHRoZSBuZWFyZXN0IGl0ZW0gYW5kIHJldHVybiB0aGUgaXRlbXMgYXQgdGhlIHNhbWUgaW5kZXggYXMgdGhhdCBpdGVtDQogICAgICAgKiBAZnVuY3Rpb24gQ2hhcnQuSW50ZXJhY3Rpb24ubW9kZXMuaW5kZXgNCiAgICAgICAqIEBzaW5jZSB2Mi40LjANCiAgICAgICAqIEBwYXJhbSB7Q2hhcnR9IGNoYXJ0IC0gdGhlIGNoYXJ0IHdlIGFyZSByZXR1cm5pbmcgaXRlbXMgZnJvbQ0KICAgICAgICogQHBhcmFtIHtFdmVudH0gZSAtIHRoZSBldmVudCB3ZSBhcmUgZmluZCB0aGluZ3MgYXQNCiAgICAgICAqIEBwYXJhbSB7SUludGVyYWN0aW9uT3B0aW9uc30gb3B0aW9ucyAtIG9wdGlvbnMgdG8gdXNlIGR1cmluZyBpbnRlcmFjdGlvbg0KICAgICAgICogQHJldHVybiB7Q2hhcnQuRWxlbWVudFtdfSBBcnJheSBvZiBlbGVtZW50cyB0aGF0IGFyZSB1bmRlciB0aGUgcG9pbnQuIElmIG5vbmUgYXJlIGZvdW5kLCBhbiBlbXB0eSBhcnJheSBpcyByZXR1cm5lZA0KICAgICAgICovCiAgICAgIGluZGV4OiBpbmRleE1vZGUsCgogICAgICAvKioNCiAgICAgICAqIFJldHVybnMgaXRlbXMgaW4gdGhlIHNhbWUgZGF0YXNldC4gSWYgdGhlIG9wdGlvbnMuaW50ZXJzZWN0IHBhcmFtZXRlciBpcyB0cnVlLCB3ZSBvbmx5IHJldHVybiBpdGVtcyBpZiB3ZSBpbnRlcnNlY3Qgc29tZXRoaW5nDQogICAgICAgKiBJZiB0aGUgb3B0aW9ucy5pbnRlcnNlY3QgaXMgZmFsc2UsIHdlIGZpbmQgdGhlIG5lYXJlc3QgaXRlbSBhbmQgcmV0dXJuIHRoZSBpdGVtcyBpbiB0aGF0IGRhdGFzZXQNCiAgICAgICAqIEBmdW5jdGlvbiBDaGFydC5JbnRlcmFjdGlvbi5tb2Rlcy5kYXRhc2V0DQogICAgICAgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIHRoZSBjaGFydCB3ZSBhcmUgcmV0dXJuaW5nIGl0ZW1zIGZyb20NCiAgICAgICAqIEBwYXJhbSB7RXZlbnR9IGUgLSB0aGUgZXZlbnQgd2UgYXJlIGZpbmQgdGhpbmdzIGF0DQogICAgICAgKiBAcGFyYW0ge0lJbnRlcmFjdGlvbk9wdGlvbnN9IG9wdGlvbnMgLSBvcHRpb25zIHRvIHVzZSBkdXJpbmcgaW50ZXJhY3Rpb24NCiAgICAgICAqIEByZXR1cm4ge0NoYXJ0LkVsZW1lbnRbXX0gQXJyYXkgb2YgZWxlbWVudHMgdGhhdCBhcmUgdW5kZXIgdGhlIHBvaW50LiBJZiBub25lIGFyZSBmb3VuZCwgYW4gZW1wdHkgYXJyYXkgaXMgcmV0dXJuZWQNCiAgICAgICAqLwogICAgICBkYXRhc2V0OiBmdW5jdGlvbiBkYXRhc2V0KGNoYXJ0LCBlLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIHBvc2l0aW9uID0gZ2V0UmVsYXRpdmVQb3NpdGlvbihlLCBjaGFydCk7CiAgICAgICAgb3B0aW9ucy5heGlzID0gb3B0aW9ucy5heGlzIHx8ICd4eSc7CiAgICAgICAgdmFyIGRpc3RhbmNlTWV0cmljID0gZ2V0RGlzdGFuY2VNZXRyaWNGb3JBeGlzKG9wdGlvbnMuYXhpcyk7CiAgICAgICAgdmFyIGl0ZW1zID0gb3B0aW9ucy5pbnRlcnNlY3QgPyBnZXRJbnRlcnNlY3RJdGVtcyhjaGFydCwgcG9zaXRpb24pIDogZ2V0TmVhcmVzdEl0ZW1zKGNoYXJ0LCBwb3NpdGlvbiwgZmFsc2UsIGRpc3RhbmNlTWV0cmljKTsKCiAgICAgICAgaWYgKGl0ZW1zLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGl0ZW1zID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoaXRlbXNbMF0uX2RhdGFzZXRJbmRleCkuZGF0YTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBpdGVtczsKICAgICAgfSwKCiAgICAgIC8qKg0KICAgICAgICogQGZ1bmN0aW9uIENoYXJ0LkludGVyYWN0aW9uLm1vZGVzLngtYXhpcw0KICAgICAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjQuMC4gVXNlIGluZGV4IG1vZGUgYW5kIGludGVyc2VjdCA9PSB0cnVlDQogICAgICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAgICAgKiBAcHJpdmF0ZQ0KICAgICAgICovCiAgICAgICd4LWF4aXMnOiBmdW5jdGlvbiB4QXhpcyhjaGFydCwgZSkgewogICAgICAgIHJldHVybiBpbmRleE1vZGUoY2hhcnQsIGUsIHsKICAgICAgICAgIGludGVyc2VjdDogZmFsc2UKICAgICAgICB9KTsKICAgICAgfSwKCiAgICAgIC8qKg0KICAgICAgICogUG9pbnQgbW9kZSByZXR1cm5zIGFsbCBlbGVtZW50cyB0aGF0IGhpdCB0ZXN0IGJhc2VkIG9uIHRoZSBldmVudCBwb3NpdGlvbg0KICAgICAgICogb2YgdGhlIGV2ZW50DQogICAgICAgKiBAZnVuY3Rpb24gQ2hhcnQuSW50ZXJhY3Rpb24ubW9kZXMuaW50ZXJzZWN0DQogICAgICAgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIHRoZSBjaGFydCB3ZSBhcmUgcmV0dXJuaW5nIGl0ZW1zIGZyb20NCiAgICAgICAqIEBwYXJhbSB7RXZlbnR9IGUgLSB0aGUgZXZlbnQgd2UgYXJlIGZpbmQgdGhpbmdzIGF0DQogICAgICAgKiBAcmV0dXJuIHtDaGFydC5FbGVtZW50W119IEFycmF5IG9mIGVsZW1lbnRzIHRoYXQgYXJlIHVuZGVyIHRoZSBwb2ludC4gSWYgbm9uZSBhcmUgZm91bmQsIGFuIGVtcHR5IGFycmF5IGlzIHJldHVybmVkDQogICAgICAgKi8KICAgICAgcG9pbnQ6IGZ1bmN0aW9uIHBvaW50KGNoYXJ0LCBlKSB7CiAgICAgICAgdmFyIHBvc2l0aW9uID0gZ2V0UmVsYXRpdmVQb3NpdGlvbihlLCBjaGFydCk7CiAgICAgICAgcmV0dXJuIGdldEludGVyc2VjdEl0ZW1zKGNoYXJ0LCBwb3NpdGlvbik7CiAgICAgIH0sCgogICAgICAvKioNCiAgICAgICAqIG5lYXJlc3QgbW9kZSByZXR1cm5zIHRoZSBlbGVtZW50IGNsb3Nlc3QgdG8gdGhlIHBvaW50DQogICAgICAgKiBAZnVuY3Rpb24gQ2hhcnQuSW50ZXJhY3Rpb24ubW9kZXMuaW50ZXJzZWN0DQogICAgICAgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIHRoZSBjaGFydCB3ZSBhcmUgcmV0dXJuaW5nIGl0ZW1zIGZyb20NCiAgICAgICAqIEBwYXJhbSB7RXZlbnR9IGUgLSB0aGUgZXZlbnQgd2UgYXJlIGZpbmQgdGhpbmdzIGF0DQogICAgICAgKiBAcGFyYW0ge0lJbnRlcmFjdGlvbk9wdGlvbnN9IG9wdGlvbnMgLSBvcHRpb25zIHRvIHVzZQ0KICAgICAgICogQHJldHVybiB7Q2hhcnQuRWxlbWVudFtdfSBBcnJheSBvZiBlbGVtZW50cyB0aGF0IGFyZSB1bmRlciB0aGUgcG9pbnQuIElmIG5vbmUgYXJlIGZvdW5kLCBhbiBlbXB0eSBhcnJheSBpcyByZXR1cm5lZA0KICAgICAgICovCiAgICAgIG5lYXJlc3Q6IGZ1bmN0aW9uIG5lYXJlc3QoY2hhcnQsIGUsIG9wdGlvbnMpIHsKICAgICAgICB2YXIgcG9zaXRpb24gPSBnZXRSZWxhdGl2ZVBvc2l0aW9uKGUsIGNoYXJ0KTsKICAgICAgICBvcHRpb25zLmF4aXMgPSBvcHRpb25zLmF4aXMgfHwgJ3h5JzsKICAgICAgICB2YXIgZGlzdGFuY2VNZXRyaWMgPSBnZXREaXN0YW5jZU1ldHJpY0ZvckF4aXMob3B0aW9ucy5heGlzKTsKICAgICAgICByZXR1cm4gZ2V0TmVhcmVzdEl0ZW1zKGNoYXJ0LCBwb3NpdGlvbiwgb3B0aW9ucy5pbnRlcnNlY3QsIGRpc3RhbmNlTWV0cmljKTsKICAgICAgfSwKCiAgICAgIC8qKg0KICAgICAgICogeCBtb2RlIHJldHVybnMgdGhlIGVsZW1lbnRzIHRoYXQgaGl0LXRlc3QgYXQgdGhlIGN1cnJlbnQgeCBjb29yZGluYXRlDQogICAgICAgKiBAZnVuY3Rpb24gQ2hhcnQuSW50ZXJhY3Rpb24ubW9kZXMueA0KICAgICAgICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSB0aGUgY2hhcnQgd2UgYXJlIHJldHVybmluZyBpdGVtcyBmcm9tDQogICAgICAgKiBAcGFyYW0ge0V2ZW50fSBlIC0gdGhlIGV2ZW50IHdlIGFyZSBmaW5kIHRoaW5ncyBhdA0KICAgICAgICogQHBhcmFtIHtJSW50ZXJhY3Rpb25PcHRpb25zfSBvcHRpb25zIC0gb3B0aW9ucyB0byB1c2UNCiAgICAgICAqIEByZXR1cm4ge0NoYXJ0LkVsZW1lbnRbXX0gQXJyYXkgb2YgZWxlbWVudHMgdGhhdCBhcmUgdW5kZXIgdGhlIHBvaW50LiBJZiBub25lIGFyZSBmb3VuZCwgYW4gZW1wdHkgYXJyYXkgaXMgcmV0dXJuZWQNCiAgICAgICAqLwogICAgICB4OiBmdW5jdGlvbiB4KGNoYXJ0LCBlLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIHBvc2l0aW9uID0gZ2V0UmVsYXRpdmVQb3NpdGlvbihlLCBjaGFydCk7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgdmFyIGludGVyc2VjdHNJdGVtID0gZmFsc2U7CiAgICAgICAgcGFyc2VWaXNpYmxlSXRlbXMoY2hhcnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICBpZiAoZWxlbWVudC5pblhSYW5nZShwb3NpdGlvbi54KSkgewogICAgICAgICAgICBpdGVtcy5wdXNoKGVsZW1lbnQpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChlbGVtZW50LmluUmFuZ2UocG9zaXRpb24ueCwgcG9zaXRpb24ueSkpIHsKICAgICAgICAgICAgaW50ZXJzZWN0c0l0ZW0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0pOyAvLyBJZiB3ZSB3YW50IHRvIHRyaWdnZXIgb24gYW4gaW50ZXJzZWN0IGFuZCB3ZSBkb24ndCBoYXZlIGFueSBpdGVtcwogICAgICAgIC8vIHRoYXQgaW50ZXJzZWN0IHRoZSBwb3NpdGlvbiwgcmV0dXJuIG5vdGhpbmcKCiAgICAgICAgaWYgKG9wdGlvbnMuaW50ZXJzZWN0ICYmICFpbnRlcnNlY3RzSXRlbSkgewogICAgICAgICAgaXRlbXMgPSBbXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBpdGVtczsKICAgICAgfSwKCiAgICAgIC8qKg0KICAgICAgICogeSBtb2RlIHJldHVybnMgdGhlIGVsZW1lbnRzIHRoYXQgaGl0LXRlc3QgYXQgdGhlIGN1cnJlbnQgeSBjb29yZGluYXRlDQogICAgICAgKiBAZnVuY3Rpb24gQ2hhcnQuSW50ZXJhY3Rpb24ubW9kZXMueQ0KICAgICAgICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSB0aGUgY2hhcnQgd2UgYXJlIHJldHVybmluZyBpdGVtcyBmcm9tDQogICAgICAgKiBAcGFyYW0ge0V2ZW50fSBlIC0gdGhlIGV2ZW50IHdlIGFyZSBmaW5kIHRoaW5ncyBhdA0KICAgICAgICogQHBhcmFtIHtJSW50ZXJhY3Rpb25PcHRpb25zfSBvcHRpb25zIC0gb3B0aW9ucyB0byB1c2UNCiAgICAgICAqIEByZXR1cm4ge0NoYXJ0LkVsZW1lbnRbXX0gQXJyYXkgb2YgZWxlbWVudHMgdGhhdCBhcmUgdW5kZXIgdGhlIHBvaW50LiBJZiBub25lIGFyZSBmb3VuZCwgYW4gZW1wdHkgYXJyYXkgaXMgcmV0dXJuZWQNCiAgICAgICAqLwogICAgICB5OiBmdW5jdGlvbiB5KGNoYXJ0LCBlLCBvcHRpb25zKSB7CiAgICAgICAgdmFyIHBvc2l0aW9uID0gZ2V0UmVsYXRpdmVQb3NpdGlvbihlLCBjaGFydCk7CiAgICAgICAgdmFyIGl0ZW1zID0gW107CiAgICAgICAgdmFyIGludGVyc2VjdHNJdGVtID0gZmFsc2U7CiAgICAgICAgcGFyc2VWaXNpYmxlSXRlbXMoY2hhcnQsIGZ1bmN0aW9uIChlbGVtZW50KSB7CiAgICAgICAgICBpZiAoZWxlbWVudC5pbllSYW5nZShwb3NpdGlvbi55KSkgewogICAgICAgICAgICBpdGVtcy5wdXNoKGVsZW1lbnQpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChlbGVtZW50LmluUmFuZ2UocG9zaXRpb24ueCwgcG9zaXRpb24ueSkpIHsKICAgICAgICAgICAgaW50ZXJzZWN0c0l0ZW0gPSB0cnVlOwogICAgICAgICAgfQogICAgICAgIH0pOyAvLyBJZiB3ZSB3YW50IHRvIHRyaWdnZXIgb24gYW4gaW50ZXJzZWN0IGFuZCB3ZSBkb24ndCBoYXZlIGFueSBpdGVtcwogICAgICAgIC8vIHRoYXQgaW50ZXJzZWN0IHRoZSBwb3NpdGlvbiwgcmV0dXJuIG5vdGhpbmcKCiAgICAgICAgaWYgKG9wdGlvbnMuaW50ZXJzZWN0ICYmICFpbnRlcnNlY3RzSXRlbSkgewogICAgICAgICAgaXRlbXMgPSBbXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBpdGVtczsKICAgICAgfQogICAgfQogIH07CiAgdmFyIGV4dGVuZCA9IGhlbHBlcnMkMS5leHRlbmQ7CgogIGZ1bmN0aW9uIGZpbHRlckJ5UG9zaXRpb24oYXJyYXksIHBvc2l0aW9uKSB7CiAgICByZXR1cm4gaGVscGVycyQxLndoZXJlKGFycmF5LCBmdW5jdGlvbiAodikgewogICAgICByZXR1cm4gdi5wb3MgPT09IHBvc2l0aW9uOwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiBzb3J0QnlXZWlnaHQoYXJyYXksIHJldmVyc2UpIHsKICAgIHJldHVybiBhcnJheS5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgIHZhciB2MCA9IHJldmVyc2UgPyBiIDogYTsKICAgICAgdmFyIHYxID0gcmV2ZXJzZSA/IGEgOiBiOwogICAgICByZXR1cm4gdjAud2VpZ2h0ID09PSB2MS53ZWlnaHQgPyB2MC5pbmRleCAtIHYxLmluZGV4IDogdjAud2VpZ2h0IC0gdjEud2VpZ2h0OwogICAgfSk7CiAgfQoKICBmdW5jdGlvbiB3cmFwQm94ZXMoYm94ZXMpIHsKICAgIHZhciBsYXlvdXRCb3hlcyA9IFtdOwogICAgdmFyIGksIGlsZW4sIGJveDsKCiAgICBmb3IgKGkgPSAwLCBpbGVuID0gKGJveGVzIHx8IFtdKS5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgYm94ID0gYm94ZXNbaV07CiAgICAgIGxheW91dEJveGVzLnB1c2goewogICAgICAgIGluZGV4OiBpLAogICAgICAgIGJveDogYm94LAogICAgICAgIHBvczogYm94LnBvc2l0aW9uLAogICAgICAgIGhvcml6b250YWw6IGJveC5pc0hvcml6b250YWwoKSwKICAgICAgICB3ZWlnaHQ6IGJveC53ZWlnaHQKICAgICAgfSk7CiAgICB9CgogICAgcmV0dXJuIGxheW91dEJveGVzOwogIH0KCiAgZnVuY3Rpb24gc2V0TGF5b3V0RGltcyhsYXlvdXRzLCBwYXJhbXMpIHsKICAgIHZhciBpLCBpbGVuLCBsYXlvdXQ7CgogICAgZm9yIChpID0gMCwgaWxlbiA9IGxheW91dHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgIGxheW91dCA9IGxheW91dHNbaV07IC8vIHN0b3JlIHdpZHRoIHVzZWQgaW5zdGVhZCBvZiBjaGFydEFyZWEudyBpbiBmaXRCb3hlcwoKICAgICAgbGF5b3V0LndpZHRoID0gbGF5b3V0Lmhvcml6b250YWwgPyBsYXlvdXQuYm94LmZ1bGxXaWR0aCAmJiBwYXJhbXMuYXZhaWxhYmxlV2lkdGggOiBwYXJhbXMudkJveE1heFdpZHRoOyAvLyBzdG9yZSBoZWlnaHQgdXNlZCBpbnN0ZWFkIG9mIGNoYXJ0QXJlYS5oIGluIGZpdEJveGVzCgogICAgICBsYXlvdXQuaGVpZ2h0ID0gbGF5b3V0Lmhvcml6b250YWwgJiYgcGFyYW1zLmhCb3hNYXhIZWlnaHQ7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBidWlsZExheW91dEJveGVzKGJveGVzKSB7CiAgICB2YXIgbGF5b3V0Qm94ZXMgPSB3cmFwQm94ZXMoYm94ZXMpOwogICAgdmFyIGxlZnQgPSBzb3J0QnlXZWlnaHQoZmlsdGVyQnlQb3NpdGlvbihsYXlvdXRCb3hlcywgJ2xlZnQnKSwgdHJ1ZSk7CiAgICB2YXIgcmlnaHQgPSBzb3J0QnlXZWlnaHQoZmlsdGVyQnlQb3NpdGlvbihsYXlvdXRCb3hlcywgJ3JpZ2h0JykpOwogICAgdmFyIHRvcCA9IHNvcnRCeVdlaWdodChmaWx0ZXJCeVBvc2l0aW9uKGxheW91dEJveGVzLCAndG9wJyksIHRydWUpOwogICAgdmFyIGJvdHRvbSA9IHNvcnRCeVdlaWdodChmaWx0ZXJCeVBvc2l0aW9uKGxheW91dEJveGVzLCAnYm90dG9tJykpOwogICAgcmV0dXJuIHsKICAgICAgbGVmdEFuZFRvcDogbGVmdC5jb25jYXQodG9wKSwKICAgICAgcmlnaHRBbmRCb3R0b206IHJpZ2h0LmNvbmNhdChib3R0b20pLAogICAgICBjaGFydEFyZWE6IGZpbHRlckJ5UG9zaXRpb24obGF5b3V0Qm94ZXMsICdjaGFydEFyZWEnKSwKICAgICAgdmVydGljYWw6IGxlZnQuY29uY2F0KHJpZ2h0KSwKICAgICAgaG9yaXpvbnRhbDogdG9wLmNvbmNhdChib3R0b20pCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZ2V0Q29tYmluZWRNYXgobWF4UGFkZGluZywgY2hhcnRBcmVhLCBhLCBiKSB7CiAgICByZXR1cm4gTWF0aC5tYXgobWF4UGFkZGluZ1thXSwgY2hhcnRBcmVhW2FdKSArIE1hdGgubWF4KG1heFBhZGRpbmdbYl0sIGNoYXJ0QXJlYVtiXSk7CiAgfQoKICBmdW5jdGlvbiB1cGRhdGVEaW1zKGNoYXJ0QXJlYSwgcGFyYW1zLCBsYXlvdXQpIHsKICAgIHZhciBib3ggPSBsYXlvdXQuYm94OwogICAgdmFyIG1heFBhZGRpbmcgPSBjaGFydEFyZWEubWF4UGFkZGluZzsKICAgIHZhciBuZXdXaWR0aCwgbmV3SGVpZ2h0OwoKICAgIGlmIChsYXlvdXQuc2l6ZSkgewogICAgICAvLyB0aGlzIGxheW91dCB3YXMgYWxyZWFkeSBjb3VudGVkIGZvciwgbGV0cyBmaXJzdCByZWR1Y2Ugb2xkIHNpemUKICAgICAgY2hhcnRBcmVhW2xheW91dC5wb3NdIC09IGxheW91dC5zaXplOwogICAgfQoKICAgIGxheW91dC5zaXplID0gbGF5b3V0Lmhvcml6b250YWwgPyBib3guaGVpZ2h0IDogYm94LndpZHRoOwogICAgY2hhcnRBcmVhW2xheW91dC5wb3NdICs9IGxheW91dC5zaXplOwoKICAgIGlmIChib3guZ2V0UGFkZGluZykgewogICAgICB2YXIgYm94UGFkZGluZyA9IGJveC5nZXRQYWRkaW5nKCk7CiAgICAgIG1heFBhZGRpbmcudG9wID0gTWF0aC5tYXgobWF4UGFkZGluZy50b3AsIGJveFBhZGRpbmcudG9wKTsKICAgICAgbWF4UGFkZGluZy5sZWZ0ID0gTWF0aC5tYXgobWF4UGFkZGluZy5sZWZ0LCBib3hQYWRkaW5nLmxlZnQpOwogICAgICBtYXhQYWRkaW5nLmJvdHRvbSA9IE1hdGgubWF4KG1heFBhZGRpbmcuYm90dG9tLCBib3hQYWRkaW5nLmJvdHRvbSk7CiAgICAgIG1heFBhZGRpbmcucmlnaHQgPSBNYXRoLm1heChtYXhQYWRkaW5nLnJpZ2h0LCBib3hQYWRkaW5nLnJpZ2h0KTsKICAgIH0KCiAgICBuZXdXaWR0aCA9IHBhcmFtcy5vdXRlcldpZHRoIC0gZ2V0Q29tYmluZWRNYXgobWF4UGFkZGluZywgY2hhcnRBcmVhLCAnbGVmdCcsICdyaWdodCcpOwogICAgbmV3SGVpZ2h0ID0gcGFyYW1zLm91dGVySGVpZ2h0IC0gZ2V0Q29tYmluZWRNYXgobWF4UGFkZGluZywgY2hhcnRBcmVhLCAndG9wJywgJ2JvdHRvbScpOwoKICAgIGlmIChuZXdXaWR0aCAhPT0gY2hhcnRBcmVhLncgfHwgbmV3SGVpZ2h0ICE9PSBjaGFydEFyZWEuaCkgewogICAgICBjaGFydEFyZWEudyA9IG5ld1dpZHRoOwogICAgICBjaGFydEFyZWEuaCA9IG5ld0hlaWdodDsgLy8gcmV0dXJuIHRydWUgaWYgY2hhcnQgYXJlYSBjaGFuZ2VkIGluIGxheW91dCdzIGRpcmVjdGlvbgoKICAgICAgdmFyIHNpemVzID0gbGF5b3V0Lmhvcml6b250YWwgPyBbbmV3V2lkdGgsIGNoYXJ0QXJlYS53XSA6IFtuZXdIZWlnaHQsIGNoYXJ0QXJlYS5oXTsKICAgICAgcmV0dXJuIHNpemVzWzBdICE9PSBzaXplc1sxXSAmJiAoIWlzTmFOKHNpemVzWzBdKSB8fCAhaXNOYU4oc2l6ZXNbMV0pKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGhhbmRsZU1heFBhZGRpbmcoY2hhcnRBcmVhKSB7CiAgICB2YXIgbWF4UGFkZGluZyA9IGNoYXJ0QXJlYS5tYXhQYWRkaW5nOwoKICAgIGZ1bmN0aW9uIHVwZGF0ZVBvcyhwb3MpIHsKICAgICAgdmFyIGNoYW5nZSA9IE1hdGgubWF4KG1heFBhZGRpbmdbcG9zXSAtIGNoYXJ0QXJlYVtwb3NdLCAwKTsKICAgICAgY2hhcnRBcmVhW3Bvc10gKz0gY2hhbmdlOwogICAgICByZXR1cm4gY2hhbmdlOwogICAgfQoKICAgIGNoYXJ0QXJlYS55ICs9IHVwZGF0ZVBvcygndG9wJyk7CiAgICBjaGFydEFyZWEueCArPSB1cGRhdGVQb3MoJ2xlZnQnKTsKICAgIHVwZGF0ZVBvcygncmlnaHQnKTsKICAgIHVwZGF0ZVBvcygnYm90dG9tJyk7CiAgfQoKICBmdW5jdGlvbiBnZXRNYXJnaW5zKGhvcml6b250YWwsIGNoYXJ0QXJlYSkgewogICAgdmFyIG1heFBhZGRpbmcgPSBjaGFydEFyZWEubWF4UGFkZGluZzsKCiAgICBmdW5jdGlvbiBtYXJnaW5Gb3JQb3NpdGlvbnMocG9zaXRpb25zKSB7CiAgICAgIHZhciBtYXJnaW4gPSB7CiAgICAgICAgbGVmdDogMCwKICAgICAgICB0b3A6IDAsCiAgICAgICAgcmlnaHQ6IDAsCiAgICAgICAgYm90dG9tOiAwCiAgICAgIH07CiAgICAgIHBvc2l0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChwb3MpIHsKICAgICAgICBtYXJnaW5bcG9zXSA9IE1hdGgubWF4KGNoYXJ0QXJlYVtwb3NdLCBtYXhQYWRkaW5nW3Bvc10pOwogICAgICB9KTsKICAgICAgcmV0dXJuIG1hcmdpbjsKICAgIH0KCiAgICByZXR1cm4gaG9yaXpvbnRhbCA/IG1hcmdpbkZvclBvc2l0aW9ucyhbJ2xlZnQnLCAncmlnaHQnXSkgOiBtYXJnaW5Gb3JQb3NpdGlvbnMoWyd0b3AnLCAnYm90dG9tJ10pOwogIH0KCiAgZnVuY3Rpb24gZml0Qm94ZXMoYm94ZXMsIGNoYXJ0QXJlYSwgcGFyYW1zKSB7CiAgICB2YXIgcmVmaXRCb3hlcyA9IFtdOwogICAgdmFyIGksIGlsZW4sIGxheW91dCwgYm94LCByZWZpdCwgY2hhbmdlZDsKCiAgICBmb3IgKGkgPSAwLCBpbGVuID0gYm94ZXMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgIGxheW91dCA9IGJveGVzW2ldOwogICAgICBib3ggPSBsYXlvdXQuYm94OwogICAgICBib3gudXBkYXRlKGxheW91dC53aWR0aCB8fCBjaGFydEFyZWEudywgbGF5b3V0LmhlaWdodCB8fCBjaGFydEFyZWEuaCwgZ2V0TWFyZ2lucyhsYXlvdXQuaG9yaXpvbnRhbCwgY2hhcnRBcmVhKSk7CgogICAgICBpZiAodXBkYXRlRGltcyhjaGFydEFyZWEsIHBhcmFtcywgbGF5b3V0KSkgewogICAgICAgIGNoYW5nZWQgPSB0cnVlOwoKICAgICAgICBpZiAocmVmaXRCb3hlcy5sZW5ndGgpIHsKICAgICAgICAgIC8vIERpbWVuc2lvbnMgY2hhbmdlZCBhbmQgdGhlcmUgd2VyZSBub24gZnVsbCB3aWR0aCBib3hlcyBiZWZvcmUgdGhpcwogICAgICAgICAgLy8gLT4gd2UgaGF2ZSB0byByZWZpdCB0aG9zZQogICAgICAgICAgcmVmaXQgPSB0cnVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCFib3guZnVsbFdpZHRoKSB7CiAgICAgICAgLy8gZnVsbFdpZHRoIGJveGVzIGRvbid0IG5lZWQgdG8gYmUgcmUtZml0dGVkIGluIGFueSBjYXNlCiAgICAgICAgcmVmaXRCb3hlcy5wdXNoKGxheW91dCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVmaXQgPyBmaXRCb3hlcyhyZWZpdEJveGVzLCBjaGFydEFyZWEsIHBhcmFtcykgfHwgY2hhbmdlZCA6IGNoYW5nZWQ7CiAgfQoKICBmdW5jdGlvbiBwbGFjZUJveGVzKGJveGVzLCBjaGFydEFyZWEsIHBhcmFtcykgewogICAgdmFyIHVzZXJQYWRkaW5nID0gcGFyYW1zLnBhZGRpbmc7CiAgICB2YXIgeCA9IGNoYXJ0QXJlYS54OwogICAgdmFyIHkgPSBjaGFydEFyZWEueTsKICAgIHZhciBpLCBpbGVuLCBsYXlvdXQsIGJveDsKCiAgICBmb3IgKGkgPSAwLCBpbGVuID0gYm94ZXMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgIGxheW91dCA9IGJveGVzW2ldOwogICAgICBib3ggPSBsYXlvdXQuYm94OwoKICAgICAgaWYgKGxheW91dC5ob3Jpem9udGFsKSB7CiAgICAgICAgYm94LmxlZnQgPSBib3guZnVsbFdpZHRoID8gdXNlclBhZGRpbmcubGVmdCA6IGNoYXJ0QXJlYS5sZWZ0OwogICAgICAgIGJveC5yaWdodCA9IGJveC5mdWxsV2lkdGggPyBwYXJhbXMub3V0ZXJXaWR0aCAtIHVzZXJQYWRkaW5nLnJpZ2h0IDogY2hhcnRBcmVhLmxlZnQgKyBjaGFydEFyZWEudzsKICAgICAgICBib3gudG9wID0geTsKICAgICAgICBib3guYm90dG9tID0geSArIGJveC5oZWlnaHQ7CiAgICAgICAgYm94LndpZHRoID0gYm94LnJpZ2h0IC0gYm94LmxlZnQ7CiAgICAgICAgeSA9IGJveC5ib3R0b207CiAgICAgIH0gZWxzZSB7CiAgICAgICAgYm94LmxlZnQgPSB4OwogICAgICAgIGJveC5yaWdodCA9IHggKyBib3gud2lkdGg7CiAgICAgICAgYm94LnRvcCA9IGNoYXJ0QXJlYS50b3A7CiAgICAgICAgYm94LmJvdHRvbSA9IGNoYXJ0QXJlYS50b3AgKyBjaGFydEFyZWEuaDsKICAgICAgICBib3guaGVpZ2h0ID0gYm94LmJvdHRvbSAtIGJveC50b3A7CiAgICAgICAgeCA9IGJveC5yaWdodDsKICAgICAgfQogICAgfQoKICAgIGNoYXJ0QXJlYS54ID0geDsKICAgIGNoYXJ0QXJlYS55ID0geTsKICB9CgogIGNvcmVfZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewogICAgbGF5b3V0OiB7CiAgICAgIHBhZGRpbmc6IHsKICAgICAgICB0b3A6IDAsCiAgICAgICAgcmlnaHQ6IDAsCiAgICAgICAgYm90dG9tOiAwLAogICAgICAgIGxlZnQ6IDAKICAgICAgfQogICAgfQogIH0pOwogIC8qKg0KICAgKiBAaW50ZXJmYWNlIElMYXlvdXRJdGVtDQogICAqIEBwcm9wIHtzdHJpbmd9IHBvc2l0aW9uIC0gVGhlIHBvc2l0aW9uIG9mIHRoZSBpdGVtIGluIHRoZSBjaGFydCBsYXlvdXQuIFBvc3NpYmxlIHZhbHVlcyBhcmUNCiAgICogJ2xlZnQnLCAndG9wJywgJ3JpZ2h0JywgJ2JvdHRvbScsIGFuZCAnY2hhcnRBcmVhJw0KICAgKiBAcHJvcCB7bnVtYmVyfSB3ZWlnaHQgLSBUaGUgd2VpZ2h0IHVzZWQgdG8gc29ydCB0aGUgaXRlbS4gSGlnaGVyIHdlaWdodHMgYXJlIGZ1cnRoZXIgYXdheSBmcm9tIHRoZSBjaGFydCBhcmVhDQogICAqIEBwcm9wIHtib29sZWFufSBmdWxsV2lkdGggLSBpZiB0cnVlLCBhbmQgdGhlIGl0ZW0gaXMgaG9yaXpvbnRhbCwgdGhlbiBwdXNoIHZlcnRpY2FsIGJveGVzIGRvd24NCiAgICogQHByb3Age2Z1bmN0aW9ufSBpc0hvcml6b250YWwgLSByZXR1cm5zIHRydWUgaWYgdGhlIGxheW91dCBpdGVtIGlzIGhvcml6b250YWwgKGllLiB0b3Agb3IgYm90dG9tKQ0KICAgKiBAcHJvcCB7ZnVuY3Rpb259IHVwZGF0ZSAtIFRha2VzIHR3byBwYXJhbWV0ZXJzOiB3aWR0aCBhbmQgaGVpZ2h0LiBSZXR1cm5zIHNpemUgb2YgaXRlbQ0KICAgKiBAcHJvcCB7ZnVuY3Rpb259IGdldFBhZGRpbmcgLSAgUmV0dXJucyBhbiBvYmplY3Qgd2l0aCBwYWRkaW5nIG9uIHRoZSBlZGdlcw0KICAgKiBAcHJvcCB7bnVtYmVyfSB3aWR0aCAtIFdpZHRoIG9mIGl0ZW0uIE11c3QgYmUgdmFsaWQgYWZ0ZXIgdXBkYXRlKCkNCiAgICogQHByb3Age251bWJlcn0gaGVpZ2h0IC0gSGVpZ2h0IG9mIGl0ZW0uIE11c3QgYmUgdmFsaWQgYWZ0ZXIgdXBkYXRlKCkNCiAgICogQHByb3Age251bWJlcn0gbGVmdCAtIExlZnQgZWRnZSBvZiB0aGUgaXRlbS4gU2V0IGJ5IGxheW91dCBzeXN0ZW0gYW5kIGNhbm5vdCBiZSB1c2VkIGluIHVwZGF0ZQ0KICAgKiBAcHJvcCB7bnVtYmVyfSB0b3AgLSBUb3AgZWRnZSBvZiB0aGUgaXRlbS4gU2V0IGJ5IGxheW91dCBzeXN0ZW0gYW5kIGNhbm5vdCBiZSB1c2VkIGluIHVwZGF0ZQ0KICAgKiBAcHJvcCB7bnVtYmVyfSByaWdodCAtIFJpZ2h0IGVkZ2Ugb2YgdGhlIGl0ZW0uIFNldCBieSBsYXlvdXQgc3lzdGVtIGFuZCBjYW5ub3QgYmUgdXNlZCBpbiB1cGRhdGUNCiAgICogQHByb3Age251bWJlcn0gYm90dG9tIC0gQm90dG9tIGVkZ2Ugb2YgdGhlIGl0ZW0uIFNldCBieSBsYXlvdXQgc3lzdGVtIGFuZCBjYW5ub3QgYmUgdXNlZCBpbiB1cGRhdGUNCiAgICovCiAgLy8gVGhlIGxheW91dCBzZXJ2aWNlIGlzIHZlcnkgc2VsZiBleHBsYW5hdG9yeS4gIEl0J3MgcmVzcG9uc2libGUgZm9yIHRoZSBsYXlvdXQgd2l0aGluIGEgY2hhcnQuCiAgLy8gU2NhbGVzLCBMZWdlbmRzIGFuZCBQbHVnaW5zIGFsbCByZWx5IG9uIHRoZSBsYXlvdXQgc2VydmljZSBhbmQgY2FuIGVhc2lseSByZWdpc3RlciB0byBiZSBwbGFjZWQgYW55d2hlcmUgdGhleSBuZWVkCiAgLy8gSXQgaXMgdGhpcyBzZXJ2aWNlJ3MgcmVzcG9uc2liaWxpdHkgb2YgY2Fycnlpbmcgb3V0IHRoYXQgbGF5b3V0LgoKCiAgdmFyIGNvcmVfbGF5b3V0cyA9IHsKICAgIGRlZmF1bHRzOiB7fSwKCiAgICAvKioNCiAgICAgKiBSZWdpc3RlciBhIGJveCB0byBhIGNoYXJ0Lg0KICAgICAqIEEgYm94IGlzIHNpbXBseSBhIHJlZmVyZW5jZSB0byBhbiBvYmplY3QgdGhhdCByZXF1aXJlcyBsYXlvdXQuIGVnLiBTY2FsZXMsIExlZ2VuZCwgVGl0bGUuDQogICAgICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSB0aGUgY2hhcnQgdG8gdXNlDQogICAgICogQHBhcmFtIHtJTGF5b3V0SXRlbX0gaXRlbSAtIHRoZSBpdGVtIHRvIGFkZCB0byBiZSBsYXllZCBvdXQNCiAgICAgKi8KICAgIGFkZEJveDogZnVuY3Rpb24gYWRkQm94KGNoYXJ0LCBpdGVtKSB7CiAgICAgIGlmICghY2hhcnQuYm94ZXMpIHsKICAgICAgICBjaGFydC5ib3hlcyA9IFtdOwogICAgICB9IC8vIGluaXRpYWxpemUgaXRlbSB3aXRoIGRlZmF1bHQgdmFsdWVzCgoKICAgICAgaXRlbS5mdWxsV2lkdGggPSBpdGVtLmZ1bGxXaWR0aCB8fCBmYWxzZTsKICAgICAgaXRlbS5wb3NpdGlvbiA9IGl0ZW0ucG9zaXRpb24gfHwgJ3RvcCc7CiAgICAgIGl0ZW0ud2VpZ2h0ID0gaXRlbS53ZWlnaHQgfHwgMDsKCiAgICAgIGl0ZW0uX2xheWVycyA9IGl0ZW0uX2xheWVycyB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIFt7CiAgICAgICAgICB6OiAwLAogICAgICAgICAgZHJhdzogZnVuY3Rpb24gZHJhdygpIHsKICAgICAgICAgICAgaXRlbS5kcmF3LmFwcGx5KGl0ZW0sIGFyZ3VtZW50cyk7CiAgICAgICAgICB9CiAgICAgICAgfV07CiAgICAgIH07CgogICAgICBjaGFydC5ib3hlcy5wdXNoKGl0ZW0pOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBSZW1vdmUgYSBsYXlvdXRJdGVtIGZyb20gYSBjaGFydA0KICAgICAqIEBwYXJhbSB7Q2hhcnR9IGNoYXJ0IC0gdGhlIGNoYXJ0IHRvIHJlbW92ZSB0aGUgYm94IGZyb20NCiAgICAgKiBAcGFyYW0ge0lMYXlvdXRJdGVtfSBsYXlvdXRJdGVtIC0gdGhlIGl0ZW0gdG8gcmVtb3ZlIGZyb20gdGhlIGxheW91dA0KICAgICAqLwogICAgcmVtb3ZlQm94OiBmdW5jdGlvbiByZW1vdmVCb3goY2hhcnQsIGxheW91dEl0ZW0pIHsKICAgICAgdmFyIGluZGV4ID0gY2hhcnQuYm94ZXMgPyBjaGFydC5ib3hlcy5pbmRleE9mKGxheW91dEl0ZW0pIDogLTE7CgogICAgICBpZiAoaW5kZXggIT09IC0xKSB7CiAgICAgICAgY2hhcnQuYm94ZXMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgfQogICAgfSwKCiAgICAvKioNCiAgICAgKiBTZXRzIChvciB1cGRhdGVzKSBvcHRpb25zIG9uIHRoZSBnaXZlbiBgaXRlbWAuDQogICAgICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSB0aGUgY2hhcnQgaW4gd2hpY2ggdGhlIGl0ZW0gbGl2ZXMgKG9yIHdpbGwgYmUgYWRkZWQgdG8pDQogICAgICogQHBhcmFtIHtJTGF5b3V0SXRlbX0gaXRlbSAtIHRoZSBpdGVtIHRvIGNvbmZpZ3VyZSB3aXRoIHRoZSBnaXZlbiBvcHRpb25zDQogICAgICogQHBhcmFtIHtvYmplY3R9IG9wdGlvbnMgLSB0aGUgbmV3IGl0ZW0gb3B0aW9ucy4NCiAgICAgKi8KICAgIGNvbmZpZ3VyZTogZnVuY3Rpb24gY29uZmlndXJlKGNoYXJ0LCBpdGVtLCBvcHRpb25zKSB7CiAgICAgIHZhciBwcm9wcyA9IFsnZnVsbFdpZHRoJywgJ3Bvc2l0aW9uJywgJ3dlaWdodCddOwogICAgICB2YXIgaWxlbiA9IHByb3BzLmxlbmd0aDsKICAgICAgdmFyIGkgPSAwOwogICAgICB2YXIgcHJvcDsKCiAgICAgIGZvciAoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgcHJvcCA9IHByb3BzW2ldOwoKICAgICAgICBpZiAob3B0aW9ucy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkgewogICAgICAgICAgaXRlbVtwcm9wXSA9IG9wdGlvbnNbcHJvcF07CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEZpdHMgYm94ZXMgb2YgdGhlIGdpdmVuIGNoYXJ0IGludG8gdGhlIGdpdmVuIHNpemUgYnkgaGF2aW5nIGVhY2ggYm94IG1lYXN1cmUgaXRzZWxmDQogICAgICogdGhlbiBydW5uaW5nIGEgZml0dGluZyBhbGdvcml0aG0NCiAgICAgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIHRoZSBjaGFydA0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIHRoZSB3aWR0aCB0byBmaXQgaW50bw0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0IHRvIGZpdCBpbnRvDQogICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShjaGFydCwgd2lkdGgsIGhlaWdodCkgewogICAgICBpZiAoIWNoYXJ0KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgbGF5b3V0T3B0aW9ucyA9IGNoYXJ0Lm9wdGlvbnMubGF5b3V0IHx8IHt9OwogICAgICB2YXIgcGFkZGluZyA9IGhlbHBlcnMkMS5vcHRpb25zLnRvUGFkZGluZyhsYXlvdXRPcHRpb25zLnBhZGRpbmcpOwogICAgICB2YXIgYXZhaWxhYmxlV2lkdGggPSB3aWR0aCAtIHBhZGRpbmcud2lkdGg7CiAgICAgIHZhciBhdmFpbGFibGVIZWlnaHQgPSBoZWlnaHQgLSBwYWRkaW5nLmhlaWdodDsKICAgICAgdmFyIGJveGVzID0gYnVpbGRMYXlvdXRCb3hlcyhjaGFydC5ib3hlcyk7CiAgICAgIHZhciB2ZXJ0aWNhbEJveGVzID0gYm94ZXMudmVydGljYWw7CiAgICAgIHZhciBob3Jpem9udGFsQm94ZXMgPSBib3hlcy5ob3Jpem9udGFsOyAvLyBFc3NlbnRpYWxseSB3ZSBub3cgaGF2ZSBhbnkgbnVtYmVyIG9mIGJveGVzIG9uIGVhY2ggb2YgdGhlIDQgc2lkZXMuCiAgICAgIC8vIE91ciBjYW52YXMgbG9va3MgbGlrZSB0aGUgZm9sbG93aW5nLgogICAgICAvLyBUaGUgYXJlYXMgTDEgYW5kIEwyIGFyZSB0aGUgbGVmdCBheGVzLiBSMSBpcyB0aGUgcmlnaHQgYXhpcywgVDEgaXMgdGhlIHRvcCBheGlzIGFuZAogICAgICAvLyBCMSBpcyB0aGUgYm90dG9tIGF4aXMKICAgICAgLy8gVGhlcmUgYXJlIGFsc28gNCBxdWFkcmFudC1saWtlIGxvY2F0aW9ucyAobGVmdCB0byByaWdodCBpbnN0ZWFkIG9mIGNsb2Nrd2lzZSkgcmVzZXJ2ZWQgZm9yIGNoYXJ0IG92ZXJsYXlzCiAgICAgIC8vIFRoZXNlIGxvY2F0aW9ucyBhcmUgc2luZ2xlLWJveCBsb2NhdGlvbnMgb25seSwgd2hlbiB0cnlpbmcgdG8gcmVnaXN0ZXIgYSBjaGFydEFyZWEgbG9jYXRpb24gdGhhdCBpcyBhbHJlYWR5IHRha2VuLAogICAgICAvLyBhbiBlcnJvciB3aWxsIGJlIHRocm93bi4KICAgICAgLy8KICAgICAgLy8gfC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS18CiAgICAgIC8vIHwgICAgICAgICAgICAgICAgICBUMSAoRnVsbCBXaWR0aCkgICAgICAgICAgICAgICAgICAgfAogICAgICAvLyB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgLy8gfCAgICB8ICAgIHwgICAgICAgICAgICAgICAgIFQyICAgICAgICAgICAgICAgICAgfCAgICB8CiAgICAgIC8vIHwgICAgfC0tLS18LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwtLS0tfAogICAgICAvLyB8ICAgIHwgICAgfCBDMSB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBDMiB8ICAgIHwKICAgICAgLy8gfCAgICB8ICAgIHwtLS0tfCAgICAgICAgICAgICAgICAgICAgICAgICAgIHwtLS0tfCAgICB8CiAgICAgIC8vIHwgICAgfCAgICB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHwgICAgfAogICAgICAvLyB8IEwxIHwgTDIgfCAgICAgICAgICAgQ2hhcnRBcmVhIChDMCkgICAgICAgICAgICB8IFIxIHwKICAgICAgLy8gfCAgICB8ICAgIHwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfCAgICB8CiAgICAgIC8vIHwgICAgfCAgICB8LS0tLXwgICAgICAgICAgICAgICAgICAgICAgICAgICB8LS0tLXwgICAgfAogICAgICAvLyB8ICAgIHwgICAgfCBDMyB8ICAgICAgICAgICAgICAgICAgICAgICAgICAgfCBDNCB8ICAgIHwKICAgICAgLy8gfCAgICB8LS0tLXwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfC0tLS18CiAgICAgIC8vIHwgICAgfCAgICB8ICAgICAgICAgICAgICAgICBCMSAgICAgICAgICAgICAgICAgIHwgICAgfAogICAgICAvLyB8LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLXwKICAgICAgLy8gfCAgICAgICAgICAgICAgICAgIEIyIChGdWxsIFdpZHRoKSAgICAgICAgICAgICAgICAgICB8CiAgICAgIC8vIHwtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tfAogICAgICAvLwoKICAgICAgdmFyIHBhcmFtcyA9IE9iamVjdC5mcmVlemUoewogICAgICAgIG91dGVyV2lkdGg6IHdpZHRoLAogICAgICAgIG91dGVySGVpZ2h0OiBoZWlnaHQsCiAgICAgICAgcGFkZGluZzogcGFkZGluZywKICAgICAgICBhdmFpbGFibGVXaWR0aDogYXZhaWxhYmxlV2lkdGgsCiAgICAgICAgdkJveE1heFdpZHRoOiBhdmFpbGFibGVXaWR0aCAvIDIgLyB2ZXJ0aWNhbEJveGVzLmxlbmd0aCwKICAgICAgICBoQm94TWF4SGVpZ2h0OiBhdmFpbGFibGVIZWlnaHQgLyAyCiAgICAgIH0pOwogICAgICB2YXIgY2hhcnRBcmVhID0gZXh0ZW5kKHsKICAgICAgICBtYXhQYWRkaW5nOiBleHRlbmQoe30sIHBhZGRpbmcpLAogICAgICAgIHc6IGF2YWlsYWJsZVdpZHRoLAogICAgICAgIGg6IGF2YWlsYWJsZUhlaWdodCwKICAgICAgICB4OiBwYWRkaW5nLmxlZnQsCiAgICAgICAgeTogcGFkZGluZy50b3AKICAgICAgfSwgcGFkZGluZyk7CiAgICAgIHNldExheW91dERpbXModmVydGljYWxCb3hlcy5jb25jYXQoaG9yaXpvbnRhbEJveGVzKSwgcGFyYW1zKTsgLy8gRmlyc3QgZml0IHZlcnRpY2FsIGJveGVzCgogICAgICBmaXRCb3hlcyh2ZXJ0aWNhbEJveGVzLCBjaGFydEFyZWEsIHBhcmFtcyk7IC8vIFRoZW4gZml0IGhvcml6b250YWwgYm94ZXMKCiAgICAgIGlmIChmaXRCb3hlcyhob3Jpem9udGFsQm94ZXMsIGNoYXJ0QXJlYSwgcGFyYW1zKSkgewogICAgICAgIC8vIGlmIHRoZSBhcmVhIGNoYW5nZWQsIHJlLWZpdCB2ZXJ0aWNhbCBib3hlcwogICAgICAgIGZpdEJveGVzKHZlcnRpY2FsQm94ZXMsIGNoYXJ0QXJlYSwgcGFyYW1zKTsKICAgICAgfQoKICAgICAgaGFuZGxlTWF4UGFkZGluZyhjaGFydEFyZWEpOyAvLyBGaW5hbGx5IHBsYWNlIHRoZSBib3hlcyB0byBjb3JyZWN0IGNvb3JkaW5hdGVzCgogICAgICBwbGFjZUJveGVzKGJveGVzLmxlZnRBbmRUb3AsIGNoYXJ0QXJlYSwgcGFyYW1zKTsgLy8gTW92ZSB0byBvcHBvc2l0ZSBzaWRlIG9mIGNoYXJ0CgogICAgICBjaGFydEFyZWEueCArPSBjaGFydEFyZWEudzsKICAgICAgY2hhcnRBcmVhLnkgKz0gY2hhcnRBcmVhLmg7CiAgICAgIHBsYWNlQm94ZXMoYm94ZXMucmlnaHRBbmRCb3R0b20sIGNoYXJ0QXJlYSwgcGFyYW1zKTsKICAgICAgY2hhcnQuY2hhcnRBcmVhID0gewogICAgICAgIGxlZnQ6IGNoYXJ0QXJlYS5sZWZ0LAogICAgICAgIHRvcDogY2hhcnRBcmVhLnRvcCwKICAgICAgICByaWdodDogY2hhcnRBcmVhLmxlZnQgKyBjaGFydEFyZWEudywKICAgICAgICBib3R0b206IGNoYXJ0QXJlYS50b3AgKyBjaGFydEFyZWEuaAogICAgICB9OyAvLyBGaW5hbGx5IHVwZGF0ZSBib3hlcyBpbiBjaGFydEFyZWEgKHJhZGlhbCBzY2FsZSBmb3IgZXhhbXBsZSkKCiAgICAgIGhlbHBlcnMkMS5lYWNoKGJveGVzLmNoYXJ0QXJlYSwgZnVuY3Rpb24gKGxheW91dCkgewogICAgICAgIHZhciBib3ggPSBsYXlvdXQuYm94OwogICAgICAgIGV4dGVuZChib3gsIGNoYXJ0LmNoYXJ0QXJlYSk7CiAgICAgICAgYm94LnVwZGF0ZShjaGFydEFyZWEudywgY2hhcnRBcmVhLmgpOwogICAgICB9KTsKICAgIH0KICB9OwogIC8qKg0KICAgKiBQbGF0Zm9ybSBmYWxsYmFjayBpbXBsZW1lbnRhdGlvbiAobWluaW1hbCkuDQogICAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvcHVsbC80NTkxI2lzc3VlY29tbWVudC0zMTk1NzU5MzkNCiAgICovCgogIHZhciBwbGF0Zm9ybV9iYXNpYyA9IHsKICAgIGFjcXVpcmVDb250ZXh0OiBmdW5jdGlvbiBhY3F1aXJlQ29udGV4dChpdGVtKSB7CiAgICAgIGlmIChpdGVtICYmIGl0ZW0uY2FudmFzKSB7CiAgICAgICAgLy8gU3VwcG9ydCBmb3IgYW55IG9iamVjdCBhc3NvY2lhdGVkIHRvIGEgY2FudmFzIChpbmNsdWRpbmcgYSBjb250ZXh0MmQpCiAgICAgICAgaXRlbSA9IGl0ZW0uY2FudmFzOwogICAgICB9CgogICAgICByZXR1cm4gaXRlbSAmJiBpdGVtLmdldENvbnRleHQoJzJkJykgfHwgbnVsbDsKICAgIH0KICB9OwogIHZhciBwbGF0Zm9ybV9kb20gPSAiLypcclxuICogRE9NIGVsZW1lbnQgcmVuZGVyaW5nIGRldGVjdGlvblxyXG4gKiBodHRwczovL2Rhdmlkd2Fsc2gubmFtZS9kZXRlY3Qtbm9kZS1pbnNlcnRpb25cclxuICovXHJcbkBrZXlmcmFtZXMgY2hhcnRqcy1yZW5kZXItYW5pbWF0aW9uIHtcclxuXHRmcm9tIHsgb3BhY2l0eTogMC45OTsgfVxyXG5cdHRvIHsgb3BhY2l0eTogMTsgfVxyXG59XHJcblxyXG4uY2hhcnRqcy1yZW5kZXItbW9uaXRvciB7XHJcblx0YW5pbWF0aW9uOiBjaGFydGpzLXJlbmRlci1hbmltYXRpb24gMC4wMDFzO1xyXG59XHJcblxyXG4vKlxyXG4gKiBET00gZWxlbWVudCByZXNpemluZyBkZXRlY3Rpb25cclxuICogaHR0cHM6Ly9naXRodWIuY29tL21hcmNqL2Nzcy1lbGVtZW50LXF1ZXJpZXNcclxuICovXHJcbi5jaGFydGpzLXNpemUtbW9uaXRvcixcclxuLmNoYXJ0anMtc2l6ZS1tb25pdG9yLWV4cGFuZCxcclxuLmNoYXJ0anMtc2l6ZS1tb25pdG9yLXNocmluayB7XHJcblx0cG9zaXRpb246IGFic29sdXRlO1xyXG5cdGRpcmVjdGlvbjogbHRyO1xyXG5cdGxlZnQ6IDA7XHJcblx0dG9wOiAwO1xyXG5cdHJpZ2h0OiAwO1xyXG5cdGJvdHRvbTogMDtcclxuXHRvdmVyZmxvdzogaGlkZGVuO1xyXG5cdHBvaW50ZXItZXZlbnRzOiBub25lO1xyXG5cdHZpc2liaWxpdHk6IGhpZGRlbjtcclxuXHR6LWluZGV4OiAtMTtcclxufVxyXG5cclxuLmNoYXJ0anMtc2l6ZS1tb25pdG9yLWV4cGFuZCA+IGRpdiB7XHJcblx0cG9zaXRpb246IGFic29sdXRlO1xyXG5cdHdpZHRoOiAxMDAwMDAwcHg7XHJcblx0aGVpZ2h0OiAxMDAwMDAwcHg7XHJcblx0bGVmdDogMDtcclxuXHR0b3A6IDA7XHJcbn1cclxuXHJcbi5jaGFydGpzLXNpemUtbW9uaXRvci1zaHJpbmsgPiBkaXYge1xyXG5cdHBvc2l0aW9uOiBhYnNvbHV0ZTtcclxuXHR3aWR0aDogMjAwJTtcclxuXHRoZWlnaHQ6IDIwMCU7XHJcblx0bGVmdDogMDtcclxuXHR0b3A6IDA7XHJcbn1cclxuIjsKICB2YXIgcGxhdGZvcm1fZG9tJDEgPSAvKiNfX1BVUkVfXyovT2JqZWN0LmZyZWV6ZSh7CiAgICBfX3Byb3RvX186IG51bGwsCiAgICAnZGVmYXVsdCc6IHBsYXRmb3JtX2RvbQogIH0pOwogIHZhciBzdHlsZXNoZWV0ID0gZ2V0Q2pzRXhwb3J0RnJvbU5hbWVzcGFjZShwbGF0Zm9ybV9kb20kMSk7CiAgdmFyIEVYUEFORE9fS0VZID0gJyRjaGFydGpzJzsKICB2YXIgQ1NTX1BSRUZJWCA9ICdjaGFydGpzLSc7CiAgdmFyIENTU19TSVpFX01PTklUT1IgPSBDU1NfUFJFRklYICsgJ3NpemUtbW9uaXRvcic7CiAgdmFyIENTU19SRU5ERVJfTU9OSVRPUiA9IENTU19QUkVGSVggKyAncmVuZGVyLW1vbml0b3InOwogIHZhciBDU1NfUkVOREVSX0FOSU1BVElPTiA9IENTU19QUkVGSVggKyAncmVuZGVyLWFuaW1hdGlvbic7CiAgdmFyIEFOSU1BVElPTl9TVEFSVF9FVkVOVFMgPSBbJ2FuaW1hdGlvbnN0YXJ0JywgJ3dlYmtpdEFuaW1hdGlvblN0YXJ0J107CiAgLyoqDQogICAqIERPTSBldmVudCB0eXBlcyAtPiBDaGFydC5qcyBldmVudCB0eXBlcy4NCiAgICogTm90ZTogb25seSBldmVudHMgd2l0aCBkaWZmZXJlbnQgdHlwZXMgYXJlIG1hcHBlZC4NCiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9FdmVudHMNCiAgICovCgogIHZhciBFVkVOVF9UWVBFUyA9IHsKICAgIHRvdWNoc3RhcnQ6ICdtb3VzZWRvd24nLAogICAgdG91Y2htb3ZlOiAnbW91c2Vtb3ZlJywKICAgIHRvdWNoZW5kOiAnbW91c2V1cCcsCiAgICBwb2ludGVyZW50ZXI6ICdtb3VzZWVudGVyJywKICAgIHBvaW50ZXJkb3duOiAnbW91c2Vkb3duJywKICAgIHBvaW50ZXJtb3ZlOiAnbW91c2Vtb3ZlJywKICAgIHBvaW50ZXJ1cDogJ21vdXNldXAnLAogICAgcG9pbnRlcmxlYXZlOiAnbW91c2VvdXQnLAogICAgcG9pbnRlcm91dDogJ21vdXNlb3V0JwogIH07CiAgLyoqDQogICAqIFRoZSAidXNlZCIgc2l6ZSBpcyB0aGUgZmluYWwgdmFsdWUgb2YgYSBkaW1lbnNpb24gcHJvcGVydHkgYWZ0ZXIgYWxsIGNhbGN1bGF0aW9ucyBoYXZlDQogICAqIGJlZW4gcGVyZm9ybWVkLiBUaGlzIG1ldGhvZCB1c2VzIHRoZSBjb21wdXRlZCBzdHlsZSBvZiBgZWxlbWVudGAgYnV0IHJldHVybnMgdW5kZWZpbmVkDQogICAqIGlmIHRoZSBjb21wdXRlZCBzdHlsZSBpcyBub3QgZXhwcmVzc2VkIGluIHBpeGVscy4gVGhhdCBjYW4gaGFwcGVuIGluIHNvbWUgY2FzZXMgd2hlcmUNCiAgICogYGVsZW1lbnRgIGhhcyBhIHNpemUgcmVsYXRpdmUgdG8gaXRzIHBhcmVudCBhbmQgdGhpcyBsYXN0IG9uZSBpcyBub3QgeWV0IGRpc3BsYXllZCwNCiAgICogZm9yIGV4YW1wbGUgYmVjYXVzZSBvZiBgZGlzcGxheTogbm9uZWAgb24gYSBwYXJlbnQgbm9kZS4NCiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9DU1MvdXNlZF92YWx1ZQ0KICAgKiBAcmV0dXJucyB7bnVtYmVyfSBTaXplIGluIHBpeGVscyBvciB1bmRlZmluZWQgaWYgdW5rbm93bi4NCiAgICovCgogIGZ1bmN0aW9uIHJlYWRVc2VkU2l6ZShlbGVtZW50LCBwcm9wZXJ0eSkgewogICAgdmFyIHZhbHVlID0gaGVscGVycyQxLmdldFN0eWxlKGVsZW1lbnQsIHByb3BlcnR5KTsKICAgIHZhciBtYXRjaGVzID0gdmFsdWUgJiYgdmFsdWUubWF0Y2goL14oXGQrKShcLlxkKyk/cHgkLyk7CiAgICByZXR1cm4gbWF0Y2hlcyA/IE51bWJlcihtYXRjaGVzWzFdKSA6IHVuZGVmaW5lZDsKICB9CiAgLyoqDQogICAqIEluaXRpYWxpemVzIHRoZSBjYW52YXMgc3R5bGUgYW5kIHJlbmRlciBzaXplIHdpdGhvdXQgbW9kaWZ5aW5nIHRoZSBjYW52YXMgZGlzcGxheSBzaXplLA0KICAgKiBzaW5jZSByZXNwb25zaXZlbmVzcyBpcyBoYW5kbGVkIGJ5IHRoZSBjb250cm9sbGVyLnJlc2l6ZSgpIG1ldGhvZC4gVGhlIGNvbmZpZyBpcyB1c2VkDQogICAqIHRvIGRldGVybWluZSB0aGUgYXNwZWN0IHJhdGlvIHRvIGFwcGx5IGluIGNhc2Ugbm8gZXhwbGljaXQgaGVpZ2h0IGhhcyBiZWVuIHNwZWNpZmllZC4NCiAgICovCgoKICBmdW5jdGlvbiBpbml0Q2FudmFzKGNhbnZhcywgY29uZmlnKSB7CiAgICB2YXIgc3R5bGUgPSBjYW52YXMuc3R5bGU7IC8vIE5PVEUoU0IpIGNhbnZhcy5nZXRBdHRyaWJ1dGUoJ3dpZHRoJykgIT09IGNhbnZhcy53aWR0aDogaW4gdGhlIGZpcnN0IGNhc2UgaXQKICAgIC8vIHJldHVybnMgbnVsbCBvciAnJyBpZiBubyBleHBsaWNpdCB2YWx1ZSBoYXMgYmVlbiBzZXQgdG8gdGhlIGNhbnZhcyBhdHRyaWJ1dGUuCgogICAgdmFyIHJlbmRlckhlaWdodCA9IGNhbnZhcy5nZXRBdHRyaWJ1dGUoJ2hlaWdodCcpOwogICAgdmFyIHJlbmRlcldpZHRoID0gY2FudmFzLmdldEF0dHJpYnV0ZSgnd2lkdGgnKTsgLy8gQ2hhcnQuanMgbW9kaWZpZXMgc29tZSBjYW52YXMgdmFsdWVzIHRoYXQgd2Ugd2FudCB0byByZXN0b3JlIG9uIGRlc3Ryb3kKCiAgICBjYW52YXNbRVhQQU5ET19LRVldID0gewogICAgICBpbml0aWFsOiB7CiAgICAgICAgaGVpZ2h0OiByZW5kZXJIZWlnaHQsCiAgICAgICAgd2lkdGg6IHJlbmRlcldpZHRoLAogICAgICAgIHN0eWxlOiB7CiAgICAgICAgICBkaXNwbGF5OiBzdHlsZS5kaXNwbGF5LAogICAgICAgICAgaGVpZ2h0OiBzdHlsZS5oZWlnaHQsCiAgICAgICAgICB3aWR0aDogc3R5bGUud2lkdGgKICAgICAgICB9CiAgICAgIH0KICAgIH07IC8vIEZvcmNlIGNhbnZhcyB0byBkaXNwbGF5IGFzIGJsb2NrIHRvIGF2b2lkIGV4dHJhIHNwYWNlIGNhdXNlZCBieSBpbmxpbmUKICAgIC8vIGVsZW1lbnRzLCB3aGljaCB3b3VsZCBpbnRlcmZlcmUgd2l0aCB0aGUgcmVzcG9uc2l2ZSByZXNpemUgcHJvY2Vzcy4KICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL2lzc3Vlcy8yNTM4CgogICAgc3R5bGUuZGlzcGxheSA9IHN0eWxlLmRpc3BsYXkgfHwgJ2Jsb2NrJzsKCiAgICBpZiAocmVuZGVyV2lkdGggPT09IG51bGwgfHwgcmVuZGVyV2lkdGggPT09ICcnKSB7CiAgICAgIHZhciBkaXNwbGF5V2lkdGggPSByZWFkVXNlZFNpemUoY2FudmFzLCAnd2lkdGgnKTsKCiAgICAgIGlmIChkaXNwbGF5V2lkdGggIT09IHVuZGVmaW5lZCkgewogICAgICAgIGNhbnZhcy53aWR0aCA9IGRpc3BsYXlXaWR0aDsKICAgICAgfQogICAgfQoKICAgIGlmIChyZW5kZXJIZWlnaHQgPT09IG51bGwgfHwgcmVuZGVySGVpZ2h0ID09PSAnJykgewogICAgICBpZiAoY2FudmFzLnN0eWxlLmhlaWdodCA9PT0gJycpIHsKICAgICAgICAvLyBJZiBubyBleHBsaWNpdCByZW5kZXIgaGVpZ2h0IGFuZCBzdHlsZSBoZWlnaHQsIGxldCdzIGFwcGx5IHRoZSBhc3BlY3QgcmF0aW8sCiAgICAgICAgLy8gd2hpY2ggb25lIGNhbiBiZSBzcGVjaWZpZWQgYnkgdGhlIHVzZXIgYnV0IGFsc28gYnkgY2hhcnRzIGFzIGRlZmF1bHQgb3B0aW9uCiAgICAgICAgLy8gKGkuZS4gb3B0aW9ucy5hc3BlY3RSYXRpbykuIElmIG5vdCBzcGVjaWZpZWQsIHVzZSBjYW52YXMgYXNwZWN0IHJhdGlvIG9mIDIuCiAgICAgICAgY2FudmFzLmhlaWdodCA9IGNhbnZhcy53aWR0aCAvIChjb25maWcub3B0aW9ucy5hc3BlY3RSYXRpbyB8fCAyKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgZGlzcGxheUhlaWdodCA9IHJlYWRVc2VkU2l6ZShjYW52YXMsICdoZWlnaHQnKTsKCiAgICAgICAgaWYgKGRpc3BsYXlXaWR0aCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICBjYW52YXMuaGVpZ2h0ID0gZGlzcGxheUhlaWdodDsKICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gY2FudmFzOwogIH0KICAvKioNCiAgICogRGV0ZWN0cyBzdXBwb3J0IGZvciBvcHRpb25zIG9iamVjdCBhcmd1bWVudCBpbiBhZGRFdmVudExpc3RlbmVyLg0KICAgKiBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvRXZlbnRUYXJnZXQvYWRkRXZlbnRMaXN0ZW5lciNTYWZlbHlfZGV0ZWN0aW5nX29wdGlvbl9zdXBwb3J0DQogICAqIEBwcml2YXRlDQogICAqLwoKCiAgdmFyIHN1cHBvcnRzRXZlbnRMaXN0ZW5lck9wdGlvbnMgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgc3VwcG9ydHMgPSBmYWxzZTsKCiAgICB0cnkgewogICAgICB2YXIgb3B0aW9ucyA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh7fSwgJ3Bhc3NpdmUnLCB7CiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGdldHRlci1yZXR1cm4KICAgICAgICBnZXQ6IGZ1bmN0aW9uIGdldCgpIHsKICAgICAgICAgIHN1cHBvcnRzID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZScsIG51bGwsIG9wdGlvbnMpOwogICAgfSBjYXRjaCAoZSkgey8vIGNvbnRpbnVlIHJlZ2FyZGxlc3Mgb2YgZXJyb3IKICAgIH0KCiAgICByZXR1cm4gc3VwcG9ydHM7CiAgfSgpOyAvLyBEZWZhdWx0IHBhc3NpdmUgdG8gdHJ1ZSBhcyBleHBlY3RlZCBieSBDaHJvbWUgZm9yICd0b3VjaHN0YXJ0JyBhbmQgJ3RvdWNoZW5kJyBldmVudHMuCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzQyODcKCgogIHZhciBldmVudExpc3RlbmVyT3B0aW9ucyA9IHN1cHBvcnRzRXZlbnRMaXN0ZW5lck9wdGlvbnMgPyB7CiAgICBwYXNzaXZlOiB0cnVlCiAgfSA6IGZhbHNlOwoKICBmdW5jdGlvbiBhZGRMaXN0ZW5lcihub2RlLCB0eXBlLCBsaXN0ZW5lcikgewogICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyLCBldmVudExpc3RlbmVyT3B0aW9ucyk7CiAgfQoKICBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihub2RlLCB0eXBlLCBsaXN0ZW5lcikgewogICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGxpc3RlbmVyLCBldmVudExpc3RlbmVyT3B0aW9ucyk7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVFdmVudCh0eXBlLCBjaGFydCwgeCwgeSwgbmF0aXZlRXZlbnQpIHsKICAgIHJldHVybiB7CiAgICAgIHR5cGU6IHR5cGUsCiAgICAgIGNoYXJ0OiBjaGFydCwKICAgICAgbmF0aXZlOiBuYXRpdmVFdmVudCB8fCBudWxsLAogICAgICB4OiB4ICE9PSB1bmRlZmluZWQgPyB4IDogbnVsbCwKICAgICAgeTogeSAhPT0gdW5kZWZpbmVkID8geSA6IG51bGwKICAgIH07CiAgfQoKICBmdW5jdGlvbiBmcm9tTmF0aXZlRXZlbnQoZXZlbnQsIGNoYXJ0KSB7CiAgICB2YXIgdHlwZSA9IEVWRU5UX1RZUEVTW2V2ZW50LnR5cGVdIHx8IGV2ZW50LnR5cGU7CiAgICB2YXIgcG9zID0gaGVscGVycyQxLmdldFJlbGF0aXZlUG9zaXRpb24oZXZlbnQsIGNoYXJ0KTsKICAgIHJldHVybiBjcmVhdGVFdmVudCh0eXBlLCBjaGFydCwgcG9zLngsIHBvcy55LCBldmVudCk7CiAgfQoKICBmdW5jdGlvbiB0aHJvdHRsZWQoZm4sIHRoaXNBcmcpIHsKICAgIHZhciB0aWNraW5nID0gZmFsc2U7CiAgICB2YXIgYXJncyA9IFtdOwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIHRoaXNBcmcgPSB0aGlzQXJnIHx8IHRoaXM7CgogICAgICBpZiAoIXRpY2tpbmcpIHsKICAgICAgICB0aWNraW5nID0gdHJ1ZTsKICAgICAgICBoZWxwZXJzJDEucmVxdWVzdEFuaW1GcmFtZS5jYWxsKHdpbmRvdywgZnVuY3Rpb24gKCkgewogICAgICAgICAgdGlja2luZyA9IGZhbHNlOwogICAgICAgICAgZm4uYXBwbHkodGhpc0FyZywgYXJncyk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVEaXYoY2xzKSB7CiAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGVsLmNsYXNzTmFtZSA9IGNscyB8fCAnJzsKICAgIHJldHVybiBlbDsKICB9IC8vIEltcGxlbWVudGF0aW9uIGJhc2VkIG9uIGh0dHBzOi8vZ2l0aHViLmNvbS9tYXJjai9jc3MtZWxlbWVudC1xdWVyaWVzCgoKICBmdW5jdGlvbiBjcmVhdGVSZXNpemVyKGhhbmRsZXIpIHsKICAgIHZhciBtYXhTaXplID0gMTAwMDAwMDsgLy8gTk9URShTQikgRG9uJ3QgdXNlIGlubmVySFRNTCBiZWNhdXNlIGl0IGNvdWxkIGJlIGNvbnNpZGVyZWQgdW5zYWZlLgogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzU5MDIKCiAgICB2YXIgcmVzaXplciA9IGNyZWF0ZURpdihDU1NfU0laRV9NT05JVE9SKTsKICAgIHZhciBleHBhbmQgPSBjcmVhdGVEaXYoQ1NTX1NJWkVfTU9OSVRPUiArICctZXhwYW5kJyk7CiAgICB2YXIgc2hyaW5rID0gY3JlYXRlRGl2KENTU19TSVpFX01PTklUT1IgKyAnLXNocmluaycpOwogICAgZXhwYW5kLmFwcGVuZENoaWxkKGNyZWF0ZURpdigpKTsKICAgIHNocmluay5hcHBlbmRDaGlsZChjcmVhdGVEaXYoKSk7CiAgICByZXNpemVyLmFwcGVuZENoaWxkKGV4cGFuZCk7CiAgICByZXNpemVyLmFwcGVuZENoaWxkKHNocmluayk7CgogICAgcmVzaXplci5fcmVzZXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGV4cGFuZC5zY3JvbGxMZWZ0ID0gbWF4U2l6ZTsKICAgICAgZXhwYW5kLnNjcm9sbFRvcCA9IG1heFNpemU7CiAgICAgIHNocmluay5zY3JvbGxMZWZ0ID0gbWF4U2l6ZTsKICAgICAgc2hyaW5rLnNjcm9sbFRvcCA9IG1heFNpemU7CiAgICB9OwoKICAgIHZhciBvblNjcm9sbCA9IGZ1bmN0aW9uIG9uU2Nyb2xsKCkgewogICAgICByZXNpemVyLl9yZXNldCgpOwoKICAgICAgaGFuZGxlcigpOwogICAgfTsKCiAgICBhZGRMaXN0ZW5lcihleHBhbmQsICdzY3JvbGwnLCBvblNjcm9sbC5iaW5kKGV4cGFuZCwgJ2V4cGFuZCcpKTsKICAgIGFkZExpc3RlbmVyKHNocmluaywgJ3Njcm9sbCcsIG9uU2Nyb2xsLmJpbmQoc2hyaW5rLCAnc2hyaW5rJykpOwogICAgcmV0dXJuIHJlc2l6ZXI7CiAgfSAvLyBodHRwczovL2Rhdmlkd2Fsc2gubmFtZS9kZXRlY3Qtbm9kZS1pbnNlcnRpb24KCgogIGZ1bmN0aW9uIHdhdGNoRm9yUmVuZGVyKG5vZGUsIGhhbmRsZXIpIHsKICAgIHZhciBleHBhbmRvID0gbm9kZVtFWFBBTkRPX0tFWV0gfHwgKG5vZGVbRVhQQU5ET19LRVldID0ge30pOwoKICAgIHZhciBwcm94eSA9IGV4cGFuZG8ucmVuZGVyUHJveHkgPSBmdW5jdGlvbiAoZSkgewogICAgICBpZiAoZS5hbmltYXRpb25OYW1lID09PSBDU1NfUkVOREVSX0FOSU1BVElPTikgewogICAgICAgIGhhbmRsZXIoKTsKICAgICAgfQogICAgfTsKCiAgICBoZWxwZXJzJDEuZWFjaChBTklNQVRJT05fU1RBUlRfRVZFTlRTLCBmdW5jdGlvbiAodHlwZSkgewogICAgICBhZGRMaXN0ZW5lcihub2RlLCB0eXBlLCBwcm94eSk7CiAgICB9KTsgLy8gIzQ3Mzc6IENocm9tZSBtaWdodCBza2lwIHRoZSBDU1MgYW5pbWF0aW9uIHdoZW4gdGhlIENTU19SRU5ERVJfTU9OSVRPUiBjbGFzcwogICAgLy8gaXMgcmVtb3ZlZCB0aGVuIGFkZGVkIGJhY2sgaW1tZWRpYXRlbHkgKHNhbWUgYW5pbWF0aW9uIGZyYW1lPykuIEFjY2Vzc2luZyB0aGUKICAgIC8vIGBvZmZzZXRQYXJlbnRgIHByb3BlcnR5IHdpbGwgZm9yY2UgYSByZWZsb3cgYW5kIHJlLWV2YWx1YXRlIHRoZSBDU1MgYW5pbWF0aW9uLgogICAgLy8gaHR0cHM6Ly9naXN0LmdpdGh1Yi5jb20vcGF1bGlyaXNoLzVkNTJmYjA4MWIzNTcwYzgxZTNhI2JveC1tZXRyaWNzCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9pc3N1ZXMvNDczNwoKICAgIGV4cGFuZG8ucmVmbG93ID0gISFub2RlLm9mZnNldFBhcmVudDsKICAgIG5vZGUuY2xhc3NMaXN0LmFkZChDU1NfUkVOREVSX01PTklUT1IpOwogIH0KCiAgZnVuY3Rpb24gdW53YXRjaEZvclJlbmRlcihub2RlKSB7CiAgICB2YXIgZXhwYW5kbyA9IG5vZGVbRVhQQU5ET19LRVldIHx8IHt9OwogICAgdmFyIHByb3h5ID0gZXhwYW5kby5yZW5kZXJQcm94eTsKCiAgICBpZiAocHJveHkpIHsKICAgICAgaGVscGVycyQxLmVhY2goQU5JTUFUSU9OX1NUQVJUX0VWRU5UUywgZnVuY3Rpb24gKHR5cGUpIHsKICAgICAgICByZW1vdmVMaXN0ZW5lcihub2RlLCB0eXBlLCBwcm94eSk7CiAgICAgIH0pOwogICAgICBkZWxldGUgZXhwYW5kby5yZW5kZXJQcm94eTsKICAgIH0KCiAgICBub2RlLmNsYXNzTGlzdC5yZW1vdmUoQ1NTX1JFTkRFUl9NT05JVE9SKTsKICB9CgogIGZ1bmN0aW9uIGFkZFJlc2l6ZUxpc3RlbmVyKG5vZGUsIGxpc3RlbmVyLCBjaGFydCkgewogICAgdmFyIGV4cGFuZG8gPSBub2RlW0VYUEFORE9fS0VZXSB8fCAobm9kZVtFWFBBTkRPX0tFWV0gPSB7fSk7IC8vIExldCdzIGtlZXAgdHJhY2sgb2YgdGhpcyBhZGRlZCByZXNpemVyIGFuZCB0aHVzIGF2b2lkIERPTSBxdWVyeSB3aGVuIHJlbW92aW5nIGl0LgoKICAgIHZhciByZXNpemVyID0gZXhwYW5kby5yZXNpemVyID0gY3JlYXRlUmVzaXplcih0aHJvdHRsZWQoZnVuY3Rpb24gKCkgewogICAgICBpZiAoZXhwYW5kby5yZXNpemVyKSB7CiAgICAgICAgdmFyIGNvbnRhaW5lciA9IGNoYXJ0Lm9wdGlvbnMubWFpbnRhaW5Bc3BlY3RSYXRpbyAmJiBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgdmFyIHcgPSBjb250YWluZXIgPyBjb250YWluZXIuY2xpZW50V2lkdGggOiAwOwogICAgICAgIGxpc3RlbmVyKGNyZWF0ZUV2ZW50KCdyZXNpemUnLCBjaGFydCkpOwoKICAgICAgICBpZiAoY29udGFpbmVyICYmIGNvbnRhaW5lci5jbGllbnRXaWR0aCA8IHcgJiYgY2hhcnQuY2FudmFzKSB7CiAgICAgICAgICAvLyBJZiB0aGUgY29udGFpbmVyIHNpemUgc2hyYW5rIGR1cmluZyBjaGFydCByZXNpemUsIGxldCdzIGFzc3VtZQogICAgICAgICAgLy8gc2Nyb2xsYmFyIGFwcGVhcmVkLiBTbyB3ZSByZXNpemUgYWdhaW4gd2l0aCB0aGUgc2Nyb2xsYmFyIHZpc2libGUgLQogICAgICAgICAgLy8gZWZmZWN0aXZlbHkgbWFraW5nIGNoYXJ0IHNtYWxsZXIgYW5kIHRoZSBzY3JvbGxiYXIgaGlkZGVuIGFnYWluLgogICAgICAgICAgLy8gQmVjYXVzZSB3ZSBhcmUgaW5zaWRlIGB0aHJvdHRsZWRgLCBhbmQgY3VycmVudGx5IGB0aWNraW5nYCwgc2Nyb2xsCiAgICAgICAgICAvLyBldmVudHMgYXJlIGlnbm9yZWQgZHVyaW5nIHRoaXMgd2hvbGUgMiByZXNpemUgcHJvY2Vzcy4KICAgICAgICAgIC8vIElmIHdlIGFzc3VtZWQgd3JvbmcgYW5kIHNvbWV0aGluZyBlbHNlIGhhcHBlbmVkLCB3ZSBhcmUgcmVzaXppbmcKICAgICAgICAgIC8vIHR3aWNlIGluIGEgZnJhbWUgKHBvdGVudGlhbCBwZXJmb3JtYW5jZSBpc3N1ZSkKICAgICAgICAgIGxpc3RlbmVyKGNyZWF0ZUV2ZW50KCdyZXNpemUnLCBjaGFydCkpOwogICAgICAgIH0KICAgICAgfQogICAgfSkpOyAvLyBUaGUgcmVzaXplciBuZWVkcyB0byBiZSBhdHRhY2hlZCB0byB0aGUgbm9kZSBwYXJlbnQsIHNvIHdlIGZpcnN0IG5lZWQgdG8gYmUKICAgIC8vIHN1cmUgdGhhdCBgbm9kZWAgaXMgYXR0YWNoZWQgdG8gdGhlIERPTSBiZWZvcmUgaW5qZWN0aW5nIHRoZSByZXNpemVyIGVsZW1lbnQuCgogICAgd2F0Y2hGb3JSZW5kZXIobm9kZSwgZnVuY3Rpb24gKCkgewogICAgICBpZiAoZXhwYW5kby5yZXNpemVyKSB7CiAgICAgICAgdmFyIGNvbnRhaW5lciA9IG5vZGUucGFyZW50Tm9kZTsKCiAgICAgICAgaWYgKGNvbnRhaW5lciAmJiBjb250YWluZXIgIT09IHJlc2l6ZXIucGFyZW50Tm9kZSkgewogICAgICAgICAgY29udGFpbmVyLmluc2VydEJlZm9yZShyZXNpemVyLCBjb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgfSAvLyBUaGUgY29udGFpbmVyIHNpemUgbWlnaHQgaGF2ZSBjaGFuZ2VkLCBsZXQncyByZXNldCB0aGUgcmVzaXplciBzdGF0ZS4KCgogICAgICAgIHJlc2l6ZXIuX3Jlc2V0KCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlUmVzaXplTGlzdGVuZXIobm9kZSkgewogICAgdmFyIGV4cGFuZG8gPSBub2RlW0VYUEFORE9fS0VZXSB8fCB7fTsKICAgIHZhciByZXNpemVyID0gZXhwYW5kby5yZXNpemVyOwogICAgZGVsZXRlIGV4cGFuZG8ucmVzaXplcjsKICAgIHVud2F0Y2hGb3JSZW5kZXIobm9kZSk7CgogICAgaWYgKHJlc2l6ZXIgJiYgcmVzaXplci5wYXJlbnROb2RlKSB7CiAgICAgIHJlc2l6ZXIucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChyZXNpemVyKTsKICAgIH0KICB9CiAgLyoqDQogICAqIEluamVjdHMgQ1NTIHN0eWxlcyBpbmxpbmUgaWYgdGhlIHN0eWxlcyBhcmUgbm90IGFscmVhZHkgcHJlc2VudC4NCiAgICogQHBhcmFtIHtIVE1MRG9jdW1lbnR8U2hhZG93Um9vdH0gcm9vdE5vZGUgLSB0aGUgbm9kZSB0byBjb250YWluIHRoZSA8c3R5bGU+Lg0KICAgKiBAcGFyYW0ge3N0cmluZ30gY3NzIC0gdGhlIENTUyB0byBiZSBpbmplY3RlZC4NCiAgICovCgoKICBmdW5jdGlvbiBpbmplY3RDU1Mocm9vdE5vZGUsIGNzcykgewogICAgLy8gaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xLzM5MjIxMzkKICAgIHZhciBleHBhbmRvID0gcm9vdE5vZGVbRVhQQU5ET19LRVldIHx8IChyb290Tm9kZVtFWFBBTkRPX0tFWV0gPSB7fSk7CgogICAgaWYgKCFleHBhbmRvLmNvbnRhaW5zU3R5bGVzKSB7CiAgICAgIGV4cGFuZG8uY29udGFpbnNTdHlsZXMgPSB0cnVlOwogICAgICBjc3MgPSAnLyogQ2hhcnQuanMgKi9cbicgKyBjc3M7CiAgICAgIHZhciBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICAgIHN0eWxlLnNldEF0dHJpYnV0ZSgndHlwZScsICd0ZXh0L2NzcycpOwogICAgICBzdHlsZS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjc3MpKTsKICAgICAgcm9vdE5vZGUuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgfQogIH0KCiAgdmFyIHBsYXRmb3JtX2RvbSQyID0gewogICAgLyoqDQogICAgICogV2hlbiBgdHJ1ZWAsIHByZXZlbnRzIHRoZSBhdXRvbWF0aWMgaW5qZWN0aW9uIG9mIHRoZSBzdHlsZXNoZWV0IHJlcXVpcmVkIHRvDQogICAgICogY29ycmVjdGx5IGRldGVjdCB3aGVuIHRoZSBjaGFydCBpcyBhZGRlZCB0byB0aGUgRE9NIGFuZCB0aGVuIHJlc2l6ZWQuIFRoaXMNCiAgICAgKiBzd2l0Y2ggaGFzIGJlZW4gYWRkZWQgdG8gYWxsb3cgZXh0ZXJuYWwgc3R5bGVzaGVldCAoYGRpc3QvQ2hhcnQoLm1pbik/LmpzYCkNCiAgICAgKiB0byBiZSBtYW51YWxseSBpbXBvcnRlZCB0byBtYWtlIHRoaXMgbGlicmFyeSBjb21wYXRpYmxlIHdpdGggYW55IENTUC4NCiAgICAgKiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzUyMDgNCiAgICAgKi8KICAgIGRpc2FibGVDU1NJbmplY3Rpb246IGZhbHNlLAoKICAgIC8qKg0KICAgICAqIFRoaXMgcHJvcGVydHkgaG9sZHMgd2hldGhlciB0aGlzIHBsYXRmb3JtIGlzIGVuYWJsZWQgZm9yIHRoZSBjdXJyZW50IGVudmlyb25tZW50Lg0KICAgICAqIEN1cnJlbnRseSB1c2VkIGJ5IHBsYXRmb3JtLmpzIHRvIHNlbGVjdCB0aGUgcHJvcGVyIGltcGxlbWVudGF0aW9uLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZW5hYmxlZDogdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mIGRvY3VtZW50ICE9PSAndW5kZWZpbmVkJywKCiAgICAvKioNCiAgICAgKiBJbml0aWFsaXplcyByZXNvdXJjZXMgdGhhdCBkZXBlbmQgb24gcGxhdGZvcm0gb3B0aW9ucy4NCiAgICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgQ2FudmFzIGVsZW1lbnQuDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9lbnN1cmVMb2FkZWQ6IGZ1bmN0aW9uIF9lbnN1cmVMb2FkZWQoY2FudmFzKSB7CiAgICAgIGlmICghdGhpcy5kaXNhYmxlQ1NTSW5qZWN0aW9uKSB7CiAgICAgICAgLy8gSWYgdGhlIGNhbnZhcyBpcyBpbiBhIHNoYWRvdyBET00sIHRoZW4gdGhlIHN0eWxlcyBtdXN0IGFsc28gYmUgaW5zZXJ0ZWQKICAgICAgICAvLyBpbnRvIHRoZSBzYW1lIHNoYWRvdyBET00uCiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzU3NjMKICAgICAgICB2YXIgcm9vdCA9IGNhbnZhcy5nZXRSb290Tm9kZSA/IGNhbnZhcy5nZXRSb290Tm9kZSgpIDogZG9jdW1lbnQ7CiAgICAgICAgdmFyIHRhcmdldE5vZGUgPSByb290Lmhvc3QgPyByb290IDogZG9jdW1lbnQuaGVhZDsKICAgICAgICBpbmplY3RDU1ModGFyZ2V0Tm9kZSwgc3R5bGVzaGVldCk7CiAgICAgIH0KICAgIH0sCiAgICBhY3F1aXJlQ29udGV4dDogZnVuY3Rpb24gYWNxdWlyZUNvbnRleHQoaXRlbSwgY29uZmlnKSB7CiAgICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycpIHsKICAgICAgICBpdGVtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaXRlbSk7CiAgICAgIH0gZWxzZSBpZiAoaXRlbS5sZW5ndGgpIHsKICAgICAgICAvLyBTdXBwb3J0IGZvciBhcnJheSBiYXNlZCBxdWVyaWVzIChzdWNoIGFzIGpRdWVyeSkKICAgICAgICBpdGVtID0gaXRlbVswXTsKICAgICAgfQoKICAgICAgaWYgKGl0ZW0gJiYgaXRlbS5jYW52YXMpIHsKICAgICAgICAvLyBTdXBwb3J0IGZvciBhbnkgb2JqZWN0IGFzc29jaWF0ZWQgdG8gYSBjYW52YXMgKGluY2x1ZGluZyBhIGNvbnRleHQyZCkKICAgICAgICBpdGVtID0gaXRlbS5jYW52YXM7CiAgICAgIH0gLy8gVG8gcHJldmVudCBjYW52YXMgZmluZ2VycHJpbnRpbmcsIHNvbWUgYWRkLW9ucyB1bmRlZmluZSB0aGUgZ2V0Q29udGV4dAogICAgICAvLyBtZXRob2QsIGZvciBleGFtcGxlOiBodHRwczovL2dpdGh1Yi5jb20va2thcHNuZXIvQ2FudmFzQmxvY2tlcgogICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9pc3N1ZXMvMjgwNwoKCiAgICAgIHZhciBjb250ZXh0ID0gaXRlbSAmJiBpdGVtLmdldENvbnRleHQgJiYgaXRlbS5nZXRDb250ZXh0KCcyZCcpOyAvLyBgaW5zdGFuY2VvZiBIVE1MQ2FudmFzRWxlbWVudC9DYW52YXNSZW5kZXJpbmdDb250ZXh0MkRgIGZhaWxzIHdoZW4gdGhlIGl0ZW0gaXMKICAgICAgLy8gaW5zaWRlIGFuIGlmcmFtZSBvciB3aGVuIHJ1bm5pbmcgaW4gYSBwcm90ZWN0ZWQgZW52aXJvbm1lbnQuIFdlIGNvdWxkIGd1ZXNzIHRoZQogICAgICAvLyB0eXBlcyBmcm9tIHRoZWlyIHRvU3RyaW5nKCkgdmFsdWUgYnV0IGxldCdzIGtlZXAgdGhpbmdzIGZsZXhpYmxlIGFuZCBhc3N1bWUgaXQncwogICAgICAvLyBhIHN1ZmZpY2llbnQgY29uZGl0aW9uIGlmIHRoZSBpdGVtIGhhcyBhIGNvbnRleHQyRCB3aGljaCBoYXMgaXRlbSBhcyBgY2FudmFzYC4KICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzM4ODcKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzQxMDIKICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzQxNTIKCiAgICAgIGlmIChjb250ZXh0ICYmIGNvbnRleHQuY2FudmFzID09PSBpdGVtKSB7CiAgICAgICAgLy8gTG9hZCBwbGF0Zm9ybSByZXNvdXJjZXMgb24gZmlyc3QgY2hhcnQgY3JlYXRpb24sIHRvIG1ha2UgaXQgcG9zc2libGUgdG8KICAgICAgICAvLyBpbXBvcnQgdGhlIGxpYnJhcnkgYmVmb3JlIHNldHRpbmcgcGxhdGZvcm0gb3B0aW9ucy4KICAgICAgICB0aGlzLl9lbnN1cmVMb2FkZWQoaXRlbSk7CgogICAgICAgIGluaXRDYW52YXMoaXRlbSwgY29uZmlnKTsKICAgICAgICByZXR1cm4gY29udGV4dDsKICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAogICAgcmVsZWFzZUNvbnRleHQ6IGZ1bmN0aW9uIHJlbGVhc2VDb250ZXh0KGNvbnRleHQpIHsKICAgICAgdmFyIGNhbnZhcyA9IGNvbnRleHQuY2FudmFzOwoKICAgICAgaWYgKCFjYW52YXNbRVhQQU5ET19LRVldKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgaW5pdGlhbCA9IGNhbnZhc1tFWFBBTkRPX0tFWV0uaW5pdGlhbDsKICAgICAgWydoZWlnaHQnLCAnd2lkdGgnXS5mb3JFYWNoKGZ1bmN0aW9uIChwcm9wKSB7CiAgICAgICAgdmFyIHZhbHVlID0gaW5pdGlhbFtwcm9wXTsKCiAgICAgICAgaWYgKGhlbHBlcnMkMS5pc051bGxPclVuZGVmKHZhbHVlKSkgewogICAgICAgICAgY2FudmFzLnJlbW92ZUF0dHJpYnV0ZShwcm9wKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY2FudmFzLnNldEF0dHJpYnV0ZShwcm9wLCB2YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgaGVscGVycyQxLmVhY2goaW5pdGlhbC5zdHlsZSB8fCB7fSwgZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBjYW52YXMuc3R5bGVba2V5XSA9IHZhbHVlOwogICAgICB9KTsgLy8gVGhlIGNhbnZhcyByZW5kZXIgc2l6ZSBtaWdodCBoYXZlIGJlZW4gY2hhbmdlZCAoYW5kIHRodXMgdGhlIHN0YXRlIHN0YWNrIGRpc2NhcmRlZCksCiAgICAgIC8vIHdlIGNhbid0IHVzZSBzYXZlKCkgYW5kIHJlc3RvcmUoKSB0byByZXN0b3JlIHRoZSBpbml0aWFsIHN0YXRlLiBTbyBtYWtlIHN1cmUgdGhhdCBhdAogICAgICAvLyBsZWFzdCB0aGUgY2FudmFzIGNvbnRleHQgaXMgcmVzZXQgdG8gdGhlIGRlZmF1bHQgc3RhdGUgYnkgc2V0dGluZyB0aGUgY2FudmFzIHdpZHRoLgogICAgICAvLyBodHRwczovL3d3dy53My5vcmcvVFIvMjAxMS9XRC1odG1sNS0yMDExMDUyNS90aGUtY2FudmFzLWVsZW1lbnQuaHRtbAogICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tc2VsZi1hc3NpZ24KCiAgICAgIGNhbnZhcy53aWR0aCA9IGNhbnZhcy53aWR0aDsKICAgICAgZGVsZXRlIGNhbnZhc1tFWFBBTkRPX0tFWV07CiAgICB9LAogICAgYWRkRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcihjaGFydCwgdHlwZSwgbGlzdGVuZXIpIHsKICAgICAgdmFyIGNhbnZhcyA9IGNoYXJ0LmNhbnZhczsKCiAgICAgIGlmICh0eXBlID09PSAncmVzaXplJykgewogICAgICAgIC8vIE5vdGU6IHRoZSByZXNpemUgZXZlbnQgaXMgbm90IHN1cHBvcnRlZCBvbiBhbGwgYnJvd3NlcnMuCiAgICAgICAgYWRkUmVzaXplTGlzdGVuZXIoY2FudmFzLCBsaXN0ZW5lciwgY2hhcnQpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGV4cGFuZG8gPSBsaXN0ZW5lcltFWFBBTkRPX0tFWV0gfHwgKGxpc3RlbmVyW0VYUEFORE9fS0VZXSA9IHt9KTsKICAgICAgdmFyIHByb3hpZXMgPSBleHBhbmRvLnByb3hpZXMgfHwgKGV4cGFuZG8ucHJveGllcyA9IHt9KTsKCiAgICAgIHZhciBwcm94eSA9IHByb3hpZXNbY2hhcnQuaWQgKyAnXycgKyB0eXBlXSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIGxpc3RlbmVyKGZyb21OYXRpdmVFdmVudChldmVudCwgY2hhcnQpKTsKICAgICAgfTsKCiAgICAgIGFkZExpc3RlbmVyKGNhbnZhcywgdHlwZSwgcHJveHkpOwogICAgfSwKICAgIHJlbW92ZUV2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uIHJlbW92ZUV2ZW50TGlzdGVuZXIoY2hhcnQsIHR5cGUsIGxpc3RlbmVyKSB7CiAgICAgIHZhciBjYW52YXMgPSBjaGFydC5jYW52YXM7CgogICAgICBpZiAodHlwZSA9PT0gJ3Jlc2l6ZScpIHsKICAgICAgICAvLyBOb3RlOiB0aGUgcmVzaXplIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgb24gYWxsIGJyb3dzZXJzLgogICAgICAgIHJlbW92ZVJlc2l6ZUxpc3RlbmVyKGNhbnZhcyk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgZXhwYW5kbyA9IGxpc3RlbmVyW0VYUEFORE9fS0VZXSB8fCB7fTsKICAgICAgdmFyIHByb3hpZXMgPSBleHBhbmRvLnByb3hpZXMgfHwge307CiAgICAgIHZhciBwcm94eSA9IHByb3hpZXNbY2hhcnQuaWQgKyAnXycgKyB0eXBlXTsKCiAgICAgIGlmICghcHJveHkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHJlbW92ZUxpc3RlbmVyKGNhbnZhcywgdHlwZSwgcHJveHkpOwogICAgfQogIH07IC8vIERFUFJFQ0FUSU9OUwoKICAvKioNCiAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIHVzZSBFdmVudFRhcmdldC5hZGRFdmVudExpc3RlbmVyIGluc3RlYWQuDQogICAqIEV2ZW50VGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIgY29tcGF0aWJpbGl0eTogQ2hyb21lLCBPcGVyYSA3LCBTYWZhcmksIEZGMS41KywgSUU5Kw0KICAgKiBAc2VlIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9FdmVudFRhcmdldC9hZGRFdmVudExpc3RlbmVyDQogICAqIEBmdW5jdGlvbiBDaGFydC5oZWxwZXJzLmFkZEV2ZW50DQogICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi43LjANCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCiAgaGVscGVycyQxLmFkZEV2ZW50ID0gYWRkTGlzdGVuZXI7CiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgRXZlbnRUYXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lciBpbnN0ZWFkLg0KICAgKiBFdmVudFRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyIGNvbXBhdGliaWxpdHk6IENocm9tZSwgT3BlcmEgNywgU2FmYXJpLCBGRjEuNSssIElFOSsNCiAgICogQHNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvRXZlbnRUYXJnZXQvcmVtb3ZlRXZlbnRMaXN0ZW5lcg0KICAgKiBAZnVuY3Rpb24gQ2hhcnQuaGVscGVycy5yZW1vdmVFdmVudA0KICAgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNy4wDQogICAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMNCiAgICogQHByaXZhdGUNCiAgICovCgogIGhlbHBlcnMkMS5yZW1vdmVFdmVudCA9IHJlbW92ZUxpc3RlbmVyOyAvLyBAVE9ETyBNYWtlIHBvc3NpYmxlIHRvIHNlbGVjdCBhbm90aGVyIHBsYXRmb3JtIGF0IGJ1aWxkIHRpbWUuCgogIHZhciBpbXBsZW1lbnRhdGlvbiA9IHBsYXRmb3JtX2RvbSQyLl9lbmFibGVkID8gcGxhdGZvcm1fZG9tJDIgOiBwbGF0Zm9ybV9iYXNpYzsKICAvKioNCiAgICogQG5hbWVzcGFjZSBDaGFydC5wbGF0Zm9ybQ0KICAgKiBAc2VlIGh0dHBzOi8vY2hhcnRqcy5naXRib29rcy5pby9wcm9wb3NhbHMvY29udGVudC9QbGF0Zm9ybS5odG1sDQogICAqIEBzaW5jZSAyLjQuMA0KICAgKi8KCiAgdmFyIHBsYXRmb3JtID0gaGVscGVycyQxLmV4dGVuZCh7CiAgICAvKioNCiAgICAgKiBAc2luY2UgMi43LjANCiAgICAgKi8KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7fSwKCiAgICAvKioNCiAgICAgKiBDYWxsZWQgYXQgY2hhcnQgY29uc3RydWN0aW9uIHRpbWUsIHJldHVybnMgYSBjb250ZXh0MmQgaW5zdGFuY2UgaW1wbGVtZW50aW5nDQogICAgICogdGhlIFtXM0MgQ2FudmFzIDJEIENvbnRleHQgQVBJIHN0YW5kYXJkXXtAbGluayBodHRwczovL3d3dy53My5vcmcvVFIvMmRjb250ZXh0L30uDQogICAgICogQHBhcmFtIHsqfSBpdGVtIC0gVGhlIG5hdGl2ZSBpdGVtIGZyb20gd2hpY2ggdG8gYWNxdWlyZSBjb250ZXh0IChwbGF0Zm9ybSBzcGVjaWZpYykNCiAgICAgKiBAcGFyYW0ge29iamVjdH0gb3B0aW9ucyAtIFRoZSBjaGFydCBvcHRpb25zDQogICAgICogQHJldHVybnMge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gY29udGV4dDJkIGluc3RhbmNlDQogICAgICovCiAgICBhY3F1aXJlQ29udGV4dDogZnVuY3Rpb24gYWNxdWlyZUNvbnRleHQoKSB7fSwKCiAgICAvKioNCiAgICAgKiBDYWxsZWQgYXQgY2hhcnQgZGVzdHJ1Y3Rpb24gdGltZSwgcmVsZWFzZXMgYW55IHJlc291cmNlcyBhc3NvY2lhdGVkIHRvIHRoZSBjb250ZXh0DQogICAgICogcHJldmlvdXNseSByZXR1cm5lZCBieSB0aGUgYWNxdWlyZUNvbnRleHQoKSBtZXRob2QuDQogICAgICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHQgLSBUaGUgY29udGV4dDJkIGluc3RhbmNlDQogICAgICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgdGhlIG1ldGhvZCBzdWNjZWVkZWQsIGVsc2UgZmFsc2UNCiAgICAgKi8KICAgIHJlbGVhc2VDb250ZXh0OiBmdW5jdGlvbiByZWxlYXNlQ29udGV4dCgpIHt9LAoKICAgIC8qKg0KICAgICAqIFJlZ2lzdGVycyB0aGUgc3BlY2lmaWVkIGxpc3RlbmVyIG9uIHRoZSBnaXZlbiBjaGFydC4NCiAgICAgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIENoYXJ0IGZyb20gd2hpY2ggdG8gbGlzdGVuIGZvciBldmVudA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gVGhlICh7QGxpbmsgSUV2ZW50fSkgdHlwZSB0byBsaXN0ZW4gZm9yDQogICAgICogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgLSBSZWNlaXZlcyBhIG5vdGlmaWNhdGlvbiAoYW4gb2JqZWN0IHRoYXQgaW1wbGVtZW50cw0KICAgICAqIHRoZSB7QGxpbmsgSUV2ZW50fSBpbnRlcmZhY2UpIHdoZW4gYW4gZXZlbnQgb2YgdGhlIHNwZWNpZmllZCB0eXBlIG9jY3Vycy4NCiAgICAgKi8KICAgIGFkZEV2ZW50TGlzdGVuZXI6IGZ1bmN0aW9uIGFkZEV2ZW50TGlzdGVuZXIoKSB7fSwKCiAgICAvKioNCiAgICAgKiBSZW1vdmVzIHRoZSBzcGVjaWZpZWQgbGlzdGVuZXIgcHJldmlvdXNseSByZWdpc3RlcmVkIHdpdGggYWRkRXZlbnRMaXN0ZW5lci4NCiAgICAgKiBAcGFyYW0ge0NoYXJ0fSBjaGFydCAtIENoYXJ0IGZyb20gd2hpY2ggdG8gcmVtb3ZlIHRoZSBsaXN0ZW5lcg0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gVGhlICh7QGxpbmsgSUV2ZW50fSkgdHlwZSB0byByZW1vdmUNCiAgICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBsaXN0ZW5lciAtIFRoZSBsaXN0ZW5lciBmdW5jdGlvbiB0byByZW1vdmUgZnJvbSB0aGUgZXZlbnQgdGFyZ2V0Lg0KICAgICAqLwogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcjogZnVuY3Rpb24gcmVtb3ZlRXZlbnRMaXN0ZW5lcigpIHt9CiAgfSwgaW1wbGVtZW50YXRpb24pOwoKICBjb3JlX2RlZmF1bHRzLl9zZXQoJ2dsb2JhbCcsIHsKICAgIHBsdWdpbnM6IHt9CiAgfSk7CiAgLyoqDQogICAqIFRoZSBwbHVnaW4gc2VydmljZSBzaW5nbGV0b24NCiAgICogQG5hbWVzcGFjZSBDaGFydC5wbHVnaW5zDQogICAqIEBzaW5jZSAyLjEuMA0KICAgKi8KCgogIHZhciBjb3JlX3BsdWdpbnMgPSB7CiAgICAvKioNCiAgICAgKiBHbG9iYWxseSByZWdpc3RlcmVkIHBsdWdpbnMuDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9wbHVnaW5zOiBbXSwKCiAgICAvKioNCiAgICAgKiBUaGlzIGlkZW50aWZpZXIgaXMgdXNlZCB0byBpbnZhbGlkYXRlIHRoZSBkZXNjcmlwdG9ycyBjYWNoZSBhdHRhY2hlZCB0byBlYWNoIGNoYXJ0DQogICAgICogd2hlbiBhIGdsb2JhbCBwbHVnaW4gaXMgcmVnaXN0ZXJlZCBvciB1bnJlZ2lzdGVyZWQuIEluIHRoaXMgY2FzZSwgdGhlIGNhY2hlIElEIGlzDQogICAgICogaW5jcmVtZW50ZWQgYW5kIGRlc2NyaXB0b3JzIGFyZSByZWdlbmVyYXRlZCBkdXJpbmcgZm9sbG93aW5nIEFQSSBjYWxscy4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2NhY2hlSWQ6IDAsCgogICAgLyoqDQogICAgICogUmVnaXN0ZXJzIHRoZSBnaXZlbiBwbHVnaW4ocykgaWYgbm90IGFscmVhZHkgcmVnaXN0ZXJlZC4NCiAgICAgKiBAcGFyYW0ge0lQbHVnaW5bXXxJUGx1Z2lufSBwbHVnaW5zIHBsdWdpbiBpbnN0YW5jZShzKS4NCiAgICAgKi8KICAgIHJlZ2lzdGVyOiBmdW5jdGlvbiByZWdpc3RlcihwbHVnaW5zKSB7CiAgICAgIHZhciBwID0gdGhpcy5fcGx1Z2luczsKICAgICAgW10uY29uY2F0KHBsdWdpbnMpLmZvckVhY2goZnVuY3Rpb24gKHBsdWdpbikgewogICAgICAgIGlmIChwLmluZGV4T2YocGx1Z2luKSA9PT0gLTEpIHsKICAgICAgICAgIHAucHVzaChwbHVnaW4pOwogICAgICAgIH0KICAgICAgfSk7CiAgICAgIHRoaXMuX2NhY2hlSWQrKzsKICAgIH0sCgogICAgLyoqDQogICAgICogVW5yZWdpc3RlcnMgdGhlIGdpdmVuIHBsdWdpbihzKSBvbmx5IGlmIHJlZ2lzdGVyZWQuDQogICAgICogQHBhcmFtIHtJUGx1Z2luW118SVBsdWdpbn0gcGx1Z2lucyBwbHVnaW4gaW5zdGFuY2UocykuDQogICAgICovCiAgICB1bnJlZ2lzdGVyOiBmdW5jdGlvbiB1bnJlZ2lzdGVyKHBsdWdpbnMpIHsKICAgICAgdmFyIHAgPSB0aGlzLl9wbHVnaW5zOwogICAgICBbXS5jb25jYXQocGx1Z2lucykuZm9yRWFjaChmdW5jdGlvbiAocGx1Z2luKSB7CiAgICAgICAgdmFyIGlkeCA9IHAuaW5kZXhPZihwbHVnaW4pOwoKICAgICAgICBpZiAoaWR4ICE9PSAtMSkgewogICAgICAgICAgcC5zcGxpY2UoaWR4LCAxKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICB0aGlzLl9jYWNoZUlkKys7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFJlbW92ZSBhbGwgcmVnaXN0ZXJlZCBwbHVnaW5zLg0KICAgICAqIEBzaW5jZSAyLjEuNQ0KICAgICAqLwogICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICB0aGlzLl9wbHVnaW5zID0gW107CiAgICAgIHRoaXMuX2NhY2hlSWQrKzsKICAgIH0sCgogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgbnVtYmVyIG9mIHJlZ2lzdGVyZWQgcGx1Z2lucz8NCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfQ0KICAgICAqIEBzaW5jZSAyLjEuNQ0KICAgICAqLwogICAgY291bnQ6IGZ1bmN0aW9uIGNvdW50KCkgewogICAgICByZXR1cm4gdGhpcy5fcGx1Z2lucy5sZW5ndGg7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgYWxsIHJlZ2lzdGVyZWQgcGx1Z2luIGluc3RhbmNlcy4NCiAgICAgKiBAcmV0dXJucyB7SVBsdWdpbltdfSBhcnJheSBvZiBwbHVnaW4gb2JqZWN0cy4NCiAgICAgKiBAc2luY2UgMi4xLjUNCiAgICAgKi8KICAgIGdldEFsbDogZnVuY3Rpb24gZ2V0QWxsKCkgewogICAgICByZXR1cm4gdGhpcy5fcGx1Z2luczsKICAgIH0sCgogICAgLyoqDQogICAgICogQ2FsbHMgZW5hYmxlZCBwbHVnaW5zIGZvciBgY2hhcnRgIG9uIHRoZSBzcGVjaWZpZWQgaG9vayBhbmQgd2l0aCB0aGUgZ2l2ZW4gYXJncy4NCiAgICAgKiBUaGlzIG1ldGhvZCBpbW1lZGlhdGVseSByZXR1cm5zIGFzIHNvb24gYXMgYSBwbHVnaW4gZXhwbGljaXRseSByZXR1cm5zIGZhbHNlLiBUaGUNCiAgICAgKiByZXR1cm5lZCB2YWx1ZSBjYW4gYmUgdXNlZCwgZm9yIGluc3RhbmNlLCB0byBpbnRlcnJ1cHQgdGhlIGN1cnJlbnQgYWN0aW9uLg0KICAgICAqIEBwYXJhbSB7Q2hhcnR9IGNoYXJ0IC0gVGhlIGNoYXJ0IGluc3RhbmNlIGZvciB3aGljaCBwbHVnaW5zIHNob3VsZCBiZSBjYWxsZWQuDQogICAgICogQHBhcmFtIHtzdHJpbmd9IGhvb2sgLSBUaGUgbmFtZSBvZiB0aGUgcGx1Z2luIG1ldGhvZCB0byBjYWxsIChlLmcuICdiZWZvcmVVcGRhdGUnKS4NCiAgICAgKiBAcGFyYW0ge0FycmF5fSBbYXJnc10gLSBFeHRyYSBhcmd1bWVudHMgdG8gYXBwbHkgdG8gdGhlIGhvb2sgY2FsbC4NCiAgICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gZmFsc2UgaWYgYW55IG9mIHRoZSBwbHVnaW5zIHJldHVybiBmYWxzZSwgZWxzZSByZXR1cm5zIHRydWUuDQogICAgICovCiAgICBub3RpZnk6IGZ1bmN0aW9uIG5vdGlmeShjaGFydCwgaG9vaywgYXJncykgewogICAgICB2YXIgZGVzY3JpcHRvcnMgPSB0aGlzLmRlc2NyaXB0b3JzKGNoYXJ0KTsKICAgICAgdmFyIGlsZW4gPSBkZXNjcmlwdG9ycy5sZW5ndGg7CiAgICAgIHZhciBpLCBkZXNjcmlwdG9yLCBwbHVnaW4sIHBhcmFtcywgbWV0aG9kOwoKICAgICAgZm9yIChpID0gMDsgaSA8IGlsZW47ICsraSkgewogICAgICAgIGRlc2NyaXB0b3IgPSBkZXNjcmlwdG9yc1tpXTsKICAgICAgICBwbHVnaW4gPSBkZXNjcmlwdG9yLnBsdWdpbjsKICAgICAgICBtZXRob2QgPSBwbHVnaW5baG9va107CgogICAgICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICBwYXJhbXMgPSBbY2hhcnRdLmNvbmNhdChhcmdzIHx8IFtdKTsKICAgICAgICAgIHBhcmFtcy5wdXNoKGRlc2NyaXB0b3Iub3B0aW9ucyk7CgogICAgICAgICAgaWYgKG1ldGhvZC5hcHBseShwbHVnaW4sIHBhcmFtcykgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBSZXR1cm5zIGRlc2NyaXB0b3JzIG9mIGVuYWJsZWQgcGx1Z2lucyBmb3IgdGhlIGdpdmVuIGNoYXJ0Lg0KICAgICAqIEByZXR1cm5zIHtvYmplY3RbXX0gW3sgcGx1Z2luLCBvcHRpb25zIH1dDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIGRlc2NyaXB0b3JzOiBmdW5jdGlvbiBkZXNjcmlwdG9ycyhjaGFydCkgewogICAgICB2YXIgY2FjaGUgPSBjaGFydC4kcGx1Z2lucyB8fCAoY2hhcnQuJHBsdWdpbnMgPSB7fSk7CgogICAgICBpZiAoY2FjaGUuaWQgPT09IHRoaXMuX2NhY2hlSWQpIHsKICAgICAgICByZXR1cm4gY2FjaGUuZGVzY3JpcHRvcnM7CiAgICAgIH0KCiAgICAgIHZhciBwbHVnaW5zID0gW107CiAgICAgIHZhciBkZXNjcmlwdG9ycyA9IFtdOwogICAgICB2YXIgY29uZmlnID0gY2hhcnQgJiYgY2hhcnQuY29uZmlnIHx8IHt9OwogICAgICB2YXIgb3B0aW9ucyA9IGNvbmZpZy5vcHRpb25zICYmIGNvbmZpZy5vcHRpb25zLnBsdWdpbnMgfHwge307CgogICAgICB0aGlzLl9wbHVnaW5zLmNvbmNhdChjb25maWcucGx1Z2lucyB8fCBbXSkuZm9yRWFjaChmdW5jdGlvbiAocGx1Z2luKSB7CiAgICAgICAgdmFyIGlkeCA9IHBsdWdpbnMuaW5kZXhPZihwbHVnaW4pOwoKICAgICAgICBpZiAoaWR4ICE9PSAtMSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGlkID0gcGx1Z2luLmlkOwogICAgICAgIHZhciBvcHRzID0gb3B0aW9uc1tpZF07CgogICAgICAgIGlmIChvcHRzID09PSBmYWxzZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKG9wdHMgPT09IHRydWUpIHsKICAgICAgICAgIG9wdHMgPSBoZWxwZXJzJDEuY2xvbmUoY29yZV9kZWZhdWx0cy5nbG9iYWwucGx1Z2luc1tpZF0pOwogICAgICAgIH0KCiAgICAgICAgcGx1Z2lucy5wdXNoKHBsdWdpbik7CiAgICAgICAgZGVzY3JpcHRvcnMucHVzaCh7CiAgICAgICAgICBwbHVnaW46IHBsdWdpbiwKICAgICAgICAgIG9wdGlvbnM6IG9wdHMgfHwge30KICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICBjYWNoZS5kZXNjcmlwdG9ycyA9IGRlc2NyaXB0b3JzOwogICAgICBjYWNoZS5pZCA9IHRoaXMuX2NhY2hlSWQ7CiAgICAgIHJldHVybiBkZXNjcmlwdG9yczsKICAgIH0sCgogICAgLyoqDQogICAgICogSW52YWxpZGF0ZXMgY2FjaGUgZm9yIHRoZSBnaXZlbiBjaGFydDogZGVzY3JpcHRvcnMgaG9sZCBhIHJlZmVyZW5jZSBvbiBwbHVnaW4gb3B0aW9uLA0KICAgICAqIGJ1dCBpbiBzb21lIGNhc2VzLCB0aGlzIHJlZmVyZW5jZSBjYW4gYmUgY2hhbmdlZCBieSB0aGUgdXNlciB3aGVuIHVwZGF0aW5nIG9wdGlvbnMuDQogICAgICogaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzUxMTEjaXNzdWVjb21tZW50LTM1NTkzNDE2Nw0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfaW52YWxpZGF0ZTogZnVuY3Rpb24gX2ludmFsaWRhdGUoY2hhcnQpIHsKICAgICAgZGVsZXRlIGNoYXJ0LiRwbHVnaW5zOwogICAgfQogIH07CiAgdmFyIGNvcmVfc2NhbGVTZXJ2aWNlID0gewogICAgLy8gU2NhbGUgcmVnaXN0cmF0aW9uIG9iamVjdC4gRXh0ZW5zaW9ucyBjYW4gcmVnaXN0ZXIgbmV3IHNjYWxlIHR5cGVzIChzdWNoIGFzIGxvZyBvciBEQiBzY2FsZXMpIGFuZCB0aGVuCiAgICAvLyB1c2UgdGhlIG5ldyBjaGFydCBvcHRpb25zIHRvIGdyYWIgdGhlIGNvcnJlY3Qgc2NhbGUKICAgIGNvbnN0cnVjdG9yczoge30sCiAgICAvLyBVc2UgYSByZWdpc3RyYXRpb24gZnVuY3Rpb24gc28gdGhhdCB3ZSBjYW4gbW92ZSB0byBhbiBFUzYgbWFwIHdoZW4gd2Ugbm8gbG9uZ2VyIG5lZWQgdG8gc3VwcG9ydAogICAgLy8gb2xkIGJyb3dzZXJzCiAgICAvLyBTY2FsZSBjb25maWcgZGVmYXVsdHMKICAgIGRlZmF1bHRzOiB7fSwKICAgIHJlZ2lzdGVyU2NhbGVUeXBlOiBmdW5jdGlvbiByZWdpc3RlclNjYWxlVHlwZSh0eXBlLCBzY2FsZUNvbnN0cnVjdG9yLCBzY2FsZURlZmF1bHRzKSB7CiAgICAgIHRoaXMuY29uc3RydWN0b3JzW3R5cGVdID0gc2NhbGVDb25zdHJ1Y3RvcjsKICAgICAgdGhpcy5kZWZhdWx0c1t0eXBlXSA9IGhlbHBlcnMkMS5jbG9uZShzY2FsZURlZmF1bHRzKTsKICAgIH0sCiAgICBnZXRTY2FsZUNvbnN0cnVjdG9yOiBmdW5jdGlvbiBnZXRTY2FsZUNvbnN0cnVjdG9yKHR5cGUpIHsKICAgICAgcmV0dXJuIHRoaXMuY29uc3RydWN0b3JzLmhhc093blByb3BlcnR5KHR5cGUpID8gdGhpcy5jb25zdHJ1Y3RvcnNbdHlwZV0gOiB1bmRlZmluZWQ7CiAgICB9LAogICAgZ2V0U2NhbGVEZWZhdWx0czogZnVuY3Rpb24gZ2V0U2NhbGVEZWZhdWx0cyh0eXBlKSB7CiAgICAgIC8vIFJldHVybiB0aGUgc2NhbGUgZGVmYXVsdHMgbWVyZ2VkIHdpdGggdGhlIGdsb2JhbCBzZXR0aW5ncyBzbyB0aGF0IHdlIGFsd2F5cyB1c2UgdGhlIGxhdGVzdCBvbmVzCiAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRzLmhhc093blByb3BlcnR5KHR5cGUpID8gaGVscGVycyQxLm1lcmdlKE9iamVjdC5jcmVhdGUobnVsbCksIFtjb3JlX2RlZmF1bHRzLnNjYWxlLCB0aGlzLmRlZmF1bHRzW3R5cGVdXSkgOiB7fTsKICAgIH0sCiAgICB1cGRhdGVTY2FsZURlZmF1bHRzOiBmdW5jdGlvbiB1cGRhdGVTY2FsZURlZmF1bHRzKHR5cGUsIGFkZGl0aW9ucykgewogICAgICB2YXIgbWUgPSB0aGlzOwoKICAgICAgaWYgKG1lLmRlZmF1bHRzLmhhc093blByb3BlcnR5KHR5cGUpKSB7CiAgICAgICAgbWUuZGVmYXVsdHNbdHlwZV0gPSBoZWxwZXJzJDEuZXh0ZW5kKG1lLmRlZmF1bHRzW3R5cGVdLCBhZGRpdGlvbnMpOwogICAgICB9CiAgICB9LAogICAgYWRkU2NhbGVzVG9MYXlvdXQ6IGZ1bmN0aW9uIGFkZFNjYWxlc1RvTGF5b3V0KGNoYXJ0KSB7CiAgICAgIC8vIEFkZHMgZWFjaCBzY2FsZSB0byB0aGUgY2hhcnQuYm94ZXMgYXJyYXkgdG8gYmUgc2l6ZWQgYWNjb3JkaW5nbHkKICAgICAgaGVscGVycyQxLmVhY2goY2hhcnQuc2NhbGVzLCBmdW5jdGlvbiAoc2NhbGUpIHsKICAgICAgICAvLyBTZXQgSUxheW91dEl0ZW0gcGFyYW1ldGVycyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkKICAgICAgICBzY2FsZS5mdWxsV2lkdGggPSBzY2FsZS5vcHRpb25zLmZ1bGxXaWR0aDsKICAgICAgICBzY2FsZS5wb3NpdGlvbiA9IHNjYWxlLm9wdGlvbnMucG9zaXRpb247CiAgICAgICAgc2NhbGUud2VpZ2h0ID0gc2NhbGUub3B0aW9ucy53ZWlnaHQ7CiAgICAgICAgY29yZV9sYXlvdXRzLmFkZEJveChjaGFydCwgc2NhbGUpOwogICAgICB9KTsKICAgIH0KICB9OwogIHZhciB2YWx1ZU9yRGVmYXVsdCQ4ID0gaGVscGVycyQxLnZhbHVlT3JEZWZhdWx0OwogIHZhciBnZXRSdGxIZWxwZXIgPSBoZWxwZXJzJDEucnRsLmdldFJ0bEFkYXB0ZXI7CgogIGNvcmVfZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewogICAgdG9vbHRpcHM6IHsKICAgICAgZW5hYmxlZDogdHJ1ZSwKICAgICAgY3VzdG9tOiBudWxsLAogICAgICBtb2RlOiAnbmVhcmVzdCcsCiAgICAgIHBvc2l0aW9uOiAnYXZlcmFnZScsCiAgICAgIGludGVyc2VjdDogdHJ1ZSwKICAgICAgYmFja2dyb3VuZENvbG9yOiAncmdiYSgwLDAsMCwwLjgpJywKICAgICAgdGl0bGVGb250U3R5bGU6ICdib2xkJywKICAgICAgdGl0bGVTcGFjaW5nOiAyLAogICAgICB0aXRsZU1hcmdpbkJvdHRvbTogNiwKICAgICAgdGl0bGVGb250Q29sb3I6ICcjZmZmJywKICAgICAgdGl0bGVBbGlnbjogJ2xlZnQnLAogICAgICBib2R5U3BhY2luZzogMiwKICAgICAgYm9keUZvbnRDb2xvcjogJyNmZmYnLAogICAgICBib2R5QWxpZ246ICdsZWZ0JywKICAgICAgZm9vdGVyRm9udFN0eWxlOiAnYm9sZCcsCiAgICAgIGZvb3RlclNwYWNpbmc6IDIsCiAgICAgIGZvb3Rlck1hcmdpblRvcDogNiwKICAgICAgZm9vdGVyRm9udENvbG9yOiAnI2ZmZicsCiAgICAgIGZvb3RlckFsaWduOiAnbGVmdCcsCiAgICAgIHlQYWRkaW5nOiA2LAogICAgICB4UGFkZGluZzogNiwKICAgICAgY2FyZXRQYWRkaW5nOiAyLAogICAgICBjYXJldFNpemU6IDUsCiAgICAgIGNvcm5lclJhZGl1czogNiwKICAgICAgbXVsdGlLZXlCYWNrZ3JvdW5kOiAnI2ZmZicsCiAgICAgIGRpc3BsYXlDb2xvcnM6IHRydWUsCiAgICAgIGJvcmRlckNvbG9yOiAncmdiYSgwLDAsMCwwKScsCiAgICAgIGJvcmRlcldpZHRoOiAwLAogICAgICBjYWxsYmFja3M6IHsKICAgICAgICAvLyBBcmdzIGFyZTogKHRvb2x0aXBJdGVtcywgZGF0YSkKICAgICAgICBiZWZvcmVUaXRsZTogaGVscGVycyQxLm5vb3AsCiAgICAgICAgdGl0bGU6IGZ1bmN0aW9uIHRpdGxlKHRvb2x0aXBJdGVtcywgZGF0YSkgewogICAgICAgICAgdmFyIHRpdGxlID0gJyc7CiAgICAgICAgICB2YXIgbGFiZWxzID0gZGF0YS5sYWJlbHM7CiAgICAgICAgICB2YXIgbGFiZWxDb3VudCA9IGxhYmVscyA/IGxhYmVscy5sZW5ndGggOiAwOwoKICAgICAgICAgIGlmICh0b29sdGlwSXRlbXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICB2YXIgaXRlbSA9IHRvb2x0aXBJdGVtc1swXTsKCiAgICAgICAgICAgIGlmIChpdGVtLmxhYmVsKSB7CiAgICAgICAgICAgICAgdGl0bGUgPSBpdGVtLmxhYmVsOwogICAgICAgICAgICB9IGVsc2UgaWYgKGl0ZW0ueExhYmVsKSB7CiAgICAgICAgICAgICAgdGl0bGUgPSBpdGVtLnhMYWJlbDsKICAgICAgICAgICAgfSBlbHNlIGlmIChsYWJlbENvdW50ID4gMCAmJiBpdGVtLmluZGV4IDwgbGFiZWxDb3VudCkgewogICAgICAgICAgICAgIHRpdGxlID0gbGFiZWxzW2l0ZW0uaW5kZXhdOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHRpdGxlOwogICAgICAgIH0sCiAgICAgICAgYWZ0ZXJUaXRsZTogaGVscGVycyQxLm5vb3AsCiAgICAgICAgLy8gQXJncyBhcmU6ICh0b29sdGlwSXRlbXMsIGRhdGEpCiAgICAgICAgYmVmb3JlQm9keTogaGVscGVycyQxLm5vb3AsCiAgICAgICAgLy8gQXJncyBhcmU6ICh0b29sdGlwSXRlbSwgZGF0YSkKICAgICAgICBiZWZvcmVMYWJlbDogaGVscGVycyQxLm5vb3AsCiAgICAgICAgbGFiZWw6IGZ1bmN0aW9uIGxhYmVsKHRvb2x0aXBJdGVtLCBkYXRhKSB7CiAgICAgICAgICB2YXIgbGFiZWwgPSBkYXRhLmRhdGFzZXRzW3Rvb2x0aXBJdGVtLmRhdGFzZXRJbmRleF0ubGFiZWwgfHwgJyc7CgogICAgICAgICAgaWYgKGxhYmVsKSB7CiAgICAgICAgICAgIGxhYmVsICs9ICc6ICc7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKCFoZWxwZXJzJDEuaXNOdWxsT3JVbmRlZih0b29sdGlwSXRlbS52YWx1ZSkpIHsKICAgICAgICAgICAgbGFiZWwgKz0gdG9vbHRpcEl0ZW0udmFsdWU7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBsYWJlbCArPSB0b29sdGlwSXRlbS55TGFiZWw7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIGxhYmVsOwogICAgICAgIH0sCiAgICAgICAgbGFiZWxDb2xvcjogZnVuY3Rpb24gbGFiZWxDb2xvcih0b29sdGlwSXRlbSwgY2hhcnQpIHsKICAgICAgICAgIHZhciBtZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEodG9vbHRpcEl0ZW0uZGF0YXNldEluZGV4KTsKICAgICAgICAgIHZhciBhY3RpdmVFbGVtZW50ID0gbWV0YS5kYXRhW3Rvb2x0aXBJdGVtLmluZGV4XTsKICAgICAgICAgIHZhciB2aWV3ID0gYWN0aXZlRWxlbWVudC5fdmlldzsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGJvcmRlckNvbG9yOiB2aWV3LmJvcmRlckNvbG9yLAogICAgICAgICAgICBiYWNrZ3JvdW5kQ29sb3I6IHZpZXcuYmFja2dyb3VuZENvbG9yCiAgICAgICAgICB9OwogICAgICAgIH0sCiAgICAgICAgbGFiZWxUZXh0Q29sb3I6IGZ1bmN0aW9uIGxhYmVsVGV4dENvbG9yKCkgewogICAgICAgICAgcmV0dXJuIHRoaXMuX29wdGlvbnMuYm9keUZvbnRDb2xvcjsKICAgICAgICB9LAogICAgICAgIGFmdGVyTGFiZWw6IGhlbHBlcnMkMS5ub29wLAogICAgICAgIC8vIEFyZ3MgYXJlOiAodG9vbHRpcEl0ZW1zLCBkYXRhKQogICAgICAgIGFmdGVyQm9keTogaGVscGVycyQxLm5vb3AsCiAgICAgICAgLy8gQXJncyBhcmU6ICh0b29sdGlwSXRlbXMsIGRhdGEpCiAgICAgICAgYmVmb3JlRm9vdGVyOiBoZWxwZXJzJDEubm9vcCwKICAgICAgICBmb290ZXI6IGhlbHBlcnMkMS5ub29wLAogICAgICAgIGFmdGVyRm9vdGVyOiBoZWxwZXJzJDEubm9vcAogICAgICB9CiAgICB9CiAgfSk7CgogIHZhciBwb3NpdGlvbmVycyA9IHsKICAgIC8qKg0KICAgICAqIEF2ZXJhZ2UgbW9kZSBwbGFjZXMgdGhlIHRvb2x0aXAgYXQgdGhlIGF2ZXJhZ2UgcG9zaXRpb24gb2YgdGhlIGVsZW1lbnRzIHNob3duDQogICAgICogQGZ1bmN0aW9uIENoYXJ0LlRvb2x0aXAucG9zaXRpb25lcnMuYXZlcmFnZQ0KICAgICAqIEBwYXJhbSBlbGVtZW50cyB7Q2hhcnRFbGVtZW50W119IHRoZSBlbGVtZW50cyBiZWluZyBkaXNwbGF5ZWQgaW4gdGhlIHRvb2x0aXANCiAgICAgKiBAcmV0dXJucyB7b2JqZWN0fSB0b29sdGlwIHBvc2l0aW9uDQogICAgICovCiAgICBhdmVyYWdlOiBmdW5jdGlvbiBhdmVyYWdlKGVsZW1lbnRzKSB7CiAgICAgIGlmICghZWxlbWVudHMubGVuZ3RoKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB2YXIgaSwgbGVuOwogICAgICB2YXIgeCA9IDA7CiAgICAgIHZhciB5ID0gMDsKICAgICAgdmFyIGNvdW50ID0gMDsKCiAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGVsZW1lbnRzLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgICAgdmFyIGVsID0gZWxlbWVudHNbaV07CgogICAgICAgIGlmIChlbCAmJiBlbC5oYXNWYWx1ZSgpKSB7CiAgICAgICAgICB2YXIgcG9zID0gZWwudG9vbHRpcFBvc2l0aW9uKCk7CiAgICAgICAgICB4ICs9IHBvcy54OwogICAgICAgICAgeSArPSBwb3MueTsKICAgICAgICAgICsrY291bnQ7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHg6IHggLyBjb3VudCwKICAgICAgICB5OiB5IC8gY291bnQKICAgICAgfTsKICAgIH0sCgogICAgLyoqDQogICAgICogR2V0cyB0aGUgdG9vbHRpcCBwb3NpdGlvbiBuZWFyZXN0IG9mIHRoZSBpdGVtIG5lYXJlc3QgdG8gdGhlIGV2ZW50IHBvc2l0aW9uDQogICAgICogQGZ1bmN0aW9uIENoYXJ0LlRvb2x0aXAucG9zaXRpb25lcnMubmVhcmVzdA0KICAgICAqIEBwYXJhbSBlbGVtZW50cyB7Q2hhcnQuRWxlbWVudFtdfSB0aGUgdG9vbHRpcCBlbGVtZW50cw0KICAgICAqIEBwYXJhbSBldmVudFBvc2l0aW9uIHtvYmplY3R9IHRoZSBwb3NpdGlvbiBvZiB0aGUgZXZlbnQgaW4gY2FudmFzIGNvb3JkaW5hdGVzDQogICAgICogQHJldHVybnMge29iamVjdH0gdGhlIHRvb2x0aXAgcG9zaXRpb24NCiAgICAgKi8KICAgIG5lYXJlc3Q6IGZ1bmN0aW9uIG5lYXJlc3QoZWxlbWVudHMsIGV2ZW50UG9zaXRpb24pIHsKICAgICAgdmFyIHggPSBldmVudFBvc2l0aW9uLng7CiAgICAgIHZhciB5ID0gZXZlbnRQb3NpdGlvbi55OwogICAgICB2YXIgbWluRGlzdGFuY2UgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgIHZhciBpLCBsZW4sIG5lYXJlc3RFbGVtZW50OwoKICAgICAgZm9yIChpID0gMCwgbGVuID0gZWxlbWVudHMubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHsKICAgICAgICB2YXIgZWwgPSBlbGVtZW50c1tpXTsKCiAgICAgICAgaWYgKGVsICYmIGVsLmhhc1ZhbHVlKCkpIHsKICAgICAgICAgIHZhciBjZW50ZXIgPSBlbC5nZXRDZW50ZXJQb2ludCgpOwogICAgICAgICAgdmFyIGQgPSBoZWxwZXJzJDEuZGlzdGFuY2VCZXR3ZWVuUG9pbnRzKGV2ZW50UG9zaXRpb24sIGNlbnRlcik7CgogICAgICAgICAgaWYgKGQgPCBtaW5EaXN0YW5jZSkgewogICAgICAgICAgICBtaW5EaXN0YW5jZSA9IGQ7CiAgICAgICAgICAgIG5lYXJlc3RFbGVtZW50ID0gZWw7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAobmVhcmVzdEVsZW1lbnQpIHsKICAgICAgICB2YXIgdHAgPSBuZWFyZXN0RWxlbWVudC50b29sdGlwUG9zaXRpb24oKTsKICAgICAgICB4ID0gdHAueDsKICAgICAgICB5ID0gdHAueTsKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiB4LAogICAgICAgIHk6IHkKICAgICAgfTsKICAgIH0KICB9OyAvLyBIZWxwZXIgdG8gcHVzaCBvciBjb25jYXQgYmFzZWQgb24gaWYgdGhlIDJuZCBwYXJhbWV0ZXIgaXMgYW4gYXJyYXkgb3Igbm90CgogIGZ1bmN0aW9uIHB1c2hPckNvbmNhdChiYXNlLCB0b1B1c2gpIHsKICAgIGlmICh0b1B1c2gpIHsKICAgICAgaWYgKGhlbHBlcnMkMS5pc0FycmF5KHRvUHVzaCkpIHsKICAgICAgICAvLyBiYXNlID0gYmFzZS5jb25jYXQodG9QdXNoKTsKICAgICAgICBBcnJheS5wcm90b3R5cGUucHVzaC5hcHBseShiYXNlLCB0b1B1c2gpOwogICAgICB9IGVsc2UgewogICAgICAgIGJhc2UucHVzaCh0b1B1c2gpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGJhc2U7CiAgfQogIC8qKg0KICAgKiBSZXR1cm5zIGFycmF5IG9mIHN0cmluZ3Mgc3BsaXQgYnkgbmV3bGluZQ0KICAgKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgLSBUaGUgdmFsdWUgdG8gc3BsaXQgYnkgbmV3bGluZS4NCiAgICogQHJldHVybnMge3N0cmluZ1tdfSB2YWx1ZSBpZiBuZXdsaW5lIHByZXNlbnQgLSBSZXR1cm5lZCBmcm9tIFN0cmluZyBzcGxpdCgpIG1ldGhvZA0KICAgKiBAZnVuY3Rpb24NCiAgICovCgoKICBmdW5jdGlvbiBzcGxpdE5ld2xpbmVzKHN0cikgewogICAgaWYgKCh0eXBlb2Ygc3RyID09PSAnc3RyaW5nJyB8fCBzdHIgaW5zdGFuY2VvZiBTdHJpbmcpICYmIHN0ci5pbmRleE9mKCdcbicpID4gLTEpIHsKICAgICAgcmV0dXJuIHN0ci5zcGxpdCgnXG4nKTsKICAgIH0KCiAgICByZXR1cm4gc3RyOwogIH0KICAvKioNCiAgICogUHJpdmF0ZSBoZWxwZXIgdG8gY3JlYXRlIGEgdG9vbHRpcCBpdGVtIG1vZGVsDQogICAqIEBwYXJhbSBlbGVtZW50IC0gdGhlIGNoYXJ0IGVsZW1lbnQgKHBvaW50LCBhcmMsIGJhcikgdG8gY3JlYXRlIHRoZSB0b29sdGlwIGl0ZW0gZm9yDQogICAqIEByZXR1cm4gbmV3IHRvb2x0aXAgaXRlbQ0KICAgKi8KCgogIGZ1bmN0aW9uIGNyZWF0ZVRvb2x0aXBJdGVtKGVsZW1lbnQpIHsKICAgIHZhciB4U2NhbGUgPSBlbGVtZW50Ll94U2NhbGU7CiAgICB2YXIgeVNjYWxlID0gZWxlbWVudC5feVNjYWxlIHx8IGVsZW1lbnQuX3NjYWxlOyAvLyBoYW5kbGUgcmFkYXIgfHwgcG9sYXJBcmVhIGNoYXJ0cwoKICAgIHZhciBpbmRleCA9IGVsZW1lbnQuX2luZGV4OwogICAgdmFyIGRhdGFzZXRJbmRleCA9IGVsZW1lbnQuX2RhdGFzZXRJbmRleDsKCiAgICB2YXIgY29udHJvbGxlciA9IGVsZW1lbnQuX2NoYXJ0LmdldERhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCkuY29udHJvbGxlcjsKCiAgICB2YXIgaW5kZXhTY2FsZSA9IGNvbnRyb2xsZXIuX2dldEluZGV4U2NhbGUoKTsKCiAgICB2YXIgdmFsdWVTY2FsZSA9IGNvbnRyb2xsZXIuX2dldFZhbHVlU2NhbGUoKTsKCiAgICByZXR1cm4gewogICAgICB4TGFiZWw6IHhTY2FsZSA/IHhTY2FsZS5nZXRMYWJlbEZvckluZGV4KGluZGV4LCBkYXRhc2V0SW5kZXgpIDogJycsCiAgICAgIHlMYWJlbDogeVNjYWxlID8geVNjYWxlLmdldExhYmVsRm9ySW5kZXgoaW5kZXgsIGRhdGFzZXRJbmRleCkgOiAnJywKICAgICAgbGFiZWw6IGluZGV4U2NhbGUgPyAnJyArIGluZGV4U2NhbGUuZ2V0TGFiZWxGb3JJbmRleChpbmRleCwgZGF0YXNldEluZGV4KSA6ICcnLAogICAgICB2YWx1ZTogdmFsdWVTY2FsZSA/ICcnICsgdmFsdWVTY2FsZS5nZXRMYWJlbEZvckluZGV4KGluZGV4LCBkYXRhc2V0SW5kZXgpIDogJycsCiAgICAgIGluZGV4OiBpbmRleCwKICAgICAgZGF0YXNldEluZGV4OiBkYXRhc2V0SW5kZXgsCiAgICAgIHg6IGVsZW1lbnQuX21vZGVsLngsCiAgICAgIHk6IGVsZW1lbnQuX21vZGVsLnkKICAgIH07CiAgfQogIC8qKg0KICAgKiBIZWxwZXIgdG8gZ2V0IHRoZSByZXNldCBtb2RlbCBmb3IgdGhlIHRvb2x0aXANCiAgICogQHBhcmFtIHRvb2x0aXBPcHRzIHtvYmplY3R9IHRoZSB0b29sdGlwIG9wdGlvbnMNCiAgICovCgoKICBmdW5jdGlvbiBnZXRCYXNlTW9kZWwodG9vbHRpcE9wdHMpIHsKICAgIHZhciBnbG9iYWxEZWZhdWx0cyA9IGNvcmVfZGVmYXVsdHMuZ2xvYmFsOwogICAgcmV0dXJuIHsKICAgICAgLy8gUG9zaXRpb25pbmcKICAgICAgeFBhZGRpbmc6IHRvb2x0aXBPcHRzLnhQYWRkaW5nLAogICAgICB5UGFkZGluZzogdG9vbHRpcE9wdHMueVBhZGRpbmcsCiAgICAgIHhBbGlnbjogdG9vbHRpcE9wdHMueEFsaWduLAogICAgICB5QWxpZ246IHRvb2x0aXBPcHRzLnlBbGlnbiwKICAgICAgLy8gRHJhd2luZyBkaXJlY3Rpb24gYW5kIHRleHQgZGlyZWN0aW9uCiAgICAgIHJ0bDogdG9vbHRpcE9wdHMucnRsLAogICAgICB0ZXh0RGlyZWN0aW9uOiB0b29sdGlwT3B0cy50ZXh0RGlyZWN0aW9uLAogICAgICAvLyBCb2R5CiAgICAgIGJvZHlGb250Q29sb3I6IHRvb2x0aXBPcHRzLmJvZHlGb250Q29sb3IsCiAgICAgIF9ib2R5Rm9udEZhbWlseTogdmFsdWVPckRlZmF1bHQkOCh0b29sdGlwT3B0cy5ib2R5Rm9udEZhbWlseSwgZ2xvYmFsRGVmYXVsdHMuZGVmYXVsdEZvbnRGYW1pbHkpLAogICAgICBfYm9keUZvbnRTdHlsZTogdmFsdWVPckRlZmF1bHQkOCh0b29sdGlwT3B0cy5ib2R5Rm9udFN0eWxlLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFN0eWxlKSwKICAgICAgX2JvZHlBbGlnbjogdG9vbHRpcE9wdHMuYm9keUFsaWduLAogICAgICBib2R5Rm9udFNpemU6IHZhbHVlT3JEZWZhdWx0JDgodG9vbHRpcE9wdHMuYm9keUZvbnRTaXplLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFNpemUpLAogICAgICBib2R5U3BhY2luZzogdG9vbHRpcE9wdHMuYm9keVNwYWNpbmcsCiAgICAgIC8vIFRpdGxlCiAgICAgIHRpdGxlRm9udENvbG9yOiB0b29sdGlwT3B0cy50aXRsZUZvbnRDb2xvciwKICAgICAgX3RpdGxlRm9udEZhbWlseTogdmFsdWVPckRlZmF1bHQkOCh0b29sdGlwT3B0cy50aXRsZUZvbnRGYW1pbHksIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250RmFtaWx5KSwKICAgICAgX3RpdGxlRm9udFN0eWxlOiB2YWx1ZU9yRGVmYXVsdCQ4KHRvb2x0aXBPcHRzLnRpdGxlRm9udFN0eWxlLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFN0eWxlKSwKICAgICAgdGl0bGVGb250U2l6ZTogdmFsdWVPckRlZmF1bHQkOCh0b29sdGlwT3B0cy50aXRsZUZvbnRTaXplLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFNpemUpLAogICAgICBfdGl0bGVBbGlnbjogdG9vbHRpcE9wdHMudGl0bGVBbGlnbiwKICAgICAgdGl0bGVTcGFjaW5nOiB0b29sdGlwT3B0cy50aXRsZVNwYWNpbmcsCiAgICAgIHRpdGxlTWFyZ2luQm90dG9tOiB0b29sdGlwT3B0cy50aXRsZU1hcmdpbkJvdHRvbSwKICAgICAgLy8gRm9vdGVyCiAgICAgIGZvb3RlckZvbnRDb2xvcjogdG9vbHRpcE9wdHMuZm9vdGVyRm9udENvbG9yLAogICAgICBfZm9vdGVyRm9udEZhbWlseTogdmFsdWVPckRlZmF1bHQkOCh0b29sdGlwT3B0cy5mb290ZXJGb250RmFtaWx5LCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udEZhbWlseSksCiAgICAgIF9mb290ZXJGb250U3R5bGU6IHZhbHVlT3JEZWZhdWx0JDgodG9vbHRpcE9wdHMuZm9vdGVyRm9udFN0eWxlLCBnbG9iYWxEZWZhdWx0cy5kZWZhdWx0Rm9udFN0eWxlKSwKICAgICAgZm9vdGVyRm9udFNpemU6IHZhbHVlT3JEZWZhdWx0JDgodG9vbHRpcE9wdHMuZm9vdGVyRm9udFNpemUsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250U2l6ZSksCiAgICAgIF9mb290ZXJBbGlnbjogdG9vbHRpcE9wdHMuZm9vdGVyQWxpZ24sCiAgICAgIGZvb3RlclNwYWNpbmc6IHRvb2x0aXBPcHRzLmZvb3RlclNwYWNpbmcsCiAgICAgIGZvb3Rlck1hcmdpblRvcDogdG9vbHRpcE9wdHMuZm9vdGVyTWFyZ2luVG9wLAogICAgICAvLyBBcHBlYXJhbmNlCiAgICAgIGNhcmV0U2l6ZTogdG9vbHRpcE9wdHMuY2FyZXRTaXplLAogICAgICBjb3JuZXJSYWRpdXM6IHRvb2x0aXBPcHRzLmNvcm5lclJhZGl1cywKICAgICAgYmFja2dyb3VuZENvbG9yOiB0b29sdGlwT3B0cy5iYWNrZ3JvdW5kQ29sb3IsCiAgICAgIG9wYWNpdHk6IDAsCiAgICAgIGxlZ2VuZENvbG9yQmFja2dyb3VuZDogdG9vbHRpcE9wdHMubXVsdGlLZXlCYWNrZ3JvdW5kLAogICAgICBkaXNwbGF5Q29sb3JzOiB0b29sdGlwT3B0cy5kaXNwbGF5Q29sb3JzLAogICAgICBib3JkZXJDb2xvcjogdG9vbHRpcE9wdHMuYm9yZGVyQ29sb3IsCiAgICAgIGJvcmRlcldpZHRoOiB0b29sdGlwT3B0cy5ib3JkZXJXaWR0aAogICAgfTsKICB9CiAgLyoqDQogICAqIEdldCB0aGUgc2l6ZSBvZiB0aGUgdG9vbHRpcA0KICAgKi8KCgogIGZ1bmN0aW9uIGdldFRvb2x0aXBTaXplKHRvb2x0aXAsIG1vZGVsKSB7CiAgICB2YXIgY3R4ID0gdG9vbHRpcC5fY2hhcnQuY3R4OwogICAgdmFyIGhlaWdodCA9IG1vZGVsLnlQYWRkaW5nICogMjsgLy8gVG9vbHRpcCBQYWRkaW5nCgogICAgdmFyIHdpZHRoID0gMDsgLy8gQ291bnQgb2YgYWxsIGxpbmVzIGluIHRoZSBib2R5CgogICAgdmFyIGJvZHkgPSBtb2RlbC5ib2R5OwogICAgdmFyIGNvbWJpbmVkQm9keUxlbmd0aCA9IGJvZHkucmVkdWNlKGZ1bmN0aW9uIChjb3VudCwgYm9keUl0ZW0pIHsKICAgICAgcmV0dXJuIGNvdW50ICsgYm9keUl0ZW0uYmVmb3JlLmxlbmd0aCArIGJvZHlJdGVtLmxpbmVzLmxlbmd0aCArIGJvZHlJdGVtLmFmdGVyLmxlbmd0aDsKICAgIH0sIDApOwogICAgY29tYmluZWRCb2R5TGVuZ3RoICs9IG1vZGVsLmJlZm9yZUJvZHkubGVuZ3RoICsgbW9kZWwuYWZ0ZXJCb2R5Lmxlbmd0aDsKICAgIHZhciB0aXRsZUxpbmVDb3VudCA9IG1vZGVsLnRpdGxlLmxlbmd0aDsKICAgIHZhciBmb290ZXJMaW5lQ291bnQgPSBtb2RlbC5mb290ZXIubGVuZ3RoOwogICAgdmFyIHRpdGxlRm9udFNpemUgPSBtb2RlbC50aXRsZUZvbnRTaXplOwogICAgdmFyIGJvZHlGb250U2l6ZSA9IG1vZGVsLmJvZHlGb250U2l6ZTsKICAgIHZhciBmb290ZXJGb250U2l6ZSA9IG1vZGVsLmZvb3RlckZvbnRTaXplOwogICAgaGVpZ2h0ICs9IHRpdGxlTGluZUNvdW50ICogdGl0bGVGb250U2l6ZTsgLy8gVGl0bGUgTGluZXMKCiAgICBoZWlnaHQgKz0gdGl0bGVMaW5lQ291bnQgPyAodGl0bGVMaW5lQ291bnQgLSAxKSAqIG1vZGVsLnRpdGxlU3BhY2luZyA6IDA7IC8vIFRpdGxlIExpbmUgU3BhY2luZwoKICAgIGhlaWdodCArPSB0aXRsZUxpbmVDb3VudCA/IG1vZGVsLnRpdGxlTWFyZ2luQm90dG9tIDogMDsgLy8gVGl0bGUncyBib3R0b20gTWFyZ2luCgogICAgaGVpZ2h0ICs9IGNvbWJpbmVkQm9keUxlbmd0aCAqIGJvZHlGb250U2l6ZTsgLy8gQm9keSBMaW5lcwoKICAgIGhlaWdodCArPSBjb21iaW5lZEJvZHlMZW5ndGggPyAoY29tYmluZWRCb2R5TGVuZ3RoIC0gMSkgKiBtb2RlbC5ib2R5U3BhY2luZyA6IDA7IC8vIEJvZHkgTGluZSBTcGFjaW5nCgogICAgaGVpZ2h0ICs9IGZvb3RlckxpbmVDb3VudCA/IG1vZGVsLmZvb3Rlck1hcmdpblRvcCA6IDA7IC8vIEZvb3RlciBNYXJnaW4KCiAgICBoZWlnaHQgKz0gZm9vdGVyTGluZUNvdW50ICogZm9vdGVyRm9udFNpemU7IC8vIEZvb3RlciBMaW5lcwoKICAgIGhlaWdodCArPSBmb290ZXJMaW5lQ291bnQgPyAoZm9vdGVyTGluZUNvdW50IC0gMSkgKiBtb2RlbC5mb290ZXJTcGFjaW5nIDogMDsgLy8gRm9vdGVyIExpbmUgU3BhY2luZwogICAgLy8gVGl0bGUgd2lkdGgKCiAgICB2YXIgd2lkdGhQYWRkaW5nID0gMDsKCiAgICB2YXIgbWF4TGluZVdpZHRoID0gZnVuY3Rpb24gbWF4TGluZVdpZHRoKGxpbmUpIHsKICAgICAgd2lkdGggPSBNYXRoLm1heCh3aWR0aCwgY3R4Lm1lYXN1cmVUZXh0KGxpbmUpLndpZHRoICsgd2lkdGhQYWRkaW5nKTsKICAgIH07CgogICAgY3R4LmZvbnQgPSBoZWxwZXJzJDEuZm9udFN0cmluZyh0aXRsZUZvbnRTaXplLCBtb2RlbC5fdGl0bGVGb250U3R5bGUsIG1vZGVsLl90aXRsZUZvbnRGYW1pbHkpOwogICAgaGVscGVycyQxLmVhY2gobW9kZWwudGl0bGUsIG1heExpbmVXaWR0aCk7IC8vIEJvZHkgd2lkdGgKCiAgICBjdHguZm9udCA9IGhlbHBlcnMkMS5mb250U3RyaW5nKGJvZHlGb250U2l6ZSwgbW9kZWwuX2JvZHlGb250U3R5bGUsIG1vZGVsLl9ib2R5Rm9udEZhbWlseSk7CiAgICBoZWxwZXJzJDEuZWFjaChtb2RlbC5iZWZvcmVCb2R5LmNvbmNhdChtb2RlbC5hZnRlckJvZHkpLCBtYXhMaW5lV2lkdGgpOyAvLyBCb2R5IGxpbmVzIG1heSBpbmNsdWRlIHNvbWUgZXh0cmEgd2lkdGggZHVlIHRvIHRoZSBjb2xvciBib3gKCiAgICB3aWR0aFBhZGRpbmcgPSBtb2RlbC5kaXNwbGF5Q29sb3JzID8gYm9keUZvbnRTaXplICsgMiA6IDA7CiAgICBoZWxwZXJzJDEuZWFjaChib2R5LCBmdW5jdGlvbiAoYm9keUl0ZW0pIHsKICAgICAgaGVscGVycyQxLmVhY2goYm9keUl0ZW0uYmVmb3JlLCBtYXhMaW5lV2lkdGgpOwogICAgICBoZWxwZXJzJDEuZWFjaChib2R5SXRlbS5saW5lcywgbWF4TGluZVdpZHRoKTsKICAgICAgaGVscGVycyQxLmVhY2goYm9keUl0ZW0uYWZ0ZXIsIG1heExpbmVXaWR0aCk7CiAgICB9KTsgLy8gUmVzZXQgYmFjayB0byAwCgogICAgd2lkdGhQYWRkaW5nID0gMDsgLy8gRm9vdGVyIHdpZHRoCgogICAgY3R4LmZvbnQgPSBoZWxwZXJzJDEuZm9udFN0cmluZyhmb290ZXJGb250U2l6ZSwgbW9kZWwuX2Zvb3RlckZvbnRTdHlsZSwgbW9kZWwuX2Zvb3RlckZvbnRGYW1pbHkpOwogICAgaGVscGVycyQxLmVhY2gobW9kZWwuZm9vdGVyLCBtYXhMaW5lV2lkdGgpOyAvLyBBZGQgcGFkZGluZwoKICAgIHdpZHRoICs9IDIgKiBtb2RlbC54UGFkZGluZzsKICAgIHJldHVybiB7CiAgICAgIHdpZHRoOiB3aWR0aCwKICAgICAgaGVpZ2h0OiBoZWlnaHQKICAgIH07CiAgfQogIC8qKg0KICAgKiBIZWxwZXIgdG8gZ2V0IHRoZSBhbGlnbm1lbnQgb2YgYSB0b29sdGlwIGdpdmVuIHRoZSBzaXplDQogICAqLwoKCiAgZnVuY3Rpb24gZGV0ZXJtaW5lQWxpZ25tZW50KHRvb2x0aXAsIHNpemUpIHsKICAgIHZhciBtb2RlbCA9IHRvb2x0aXAuX21vZGVsOwogICAgdmFyIGNoYXJ0ID0gdG9vbHRpcC5fY2hhcnQ7CiAgICB2YXIgY2hhcnRBcmVhID0gdG9vbHRpcC5fY2hhcnQuY2hhcnRBcmVhOwogICAgdmFyIHhBbGlnbiA9ICdjZW50ZXInOwogICAgdmFyIHlBbGlnbiA9ICdjZW50ZXInOwoKICAgIGlmIChtb2RlbC55IDwgc2l6ZS5oZWlnaHQpIHsKICAgICAgeUFsaWduID0gJ3RvcCc7CiAgICB9IGVsc2UgaWYgKG1vZGVsLnkgPiBjaGFydC5oZWlnaHQgLSBzaXplLmhlaWdodCkgewogICAgICB5QWxpZ24gPSAnYm90dG9tJzsKICAgIH0KCiAgICB2YXIgbGYsIHJmOyAvLyBmdW5jdGlvbnMgdG8gZGV0ZXJtaW5lIGxlZnQsIHJpZ2h0IGFsaWdubWVudAoKICAgIHZhciBvbGYsIG9yZjsgLy8gZnVuY3Rpb25zIHRvIGRldGVybWluZSBpZiBsZWZ0L3JpZ2h0IGFsaWdubWVudCBjYXVzZXMgdG9vbHRpcCB0byBnbyBvdXRzaWRlIGNoYXJ0CgogICAgdmFyIHlmOyAvLyBmdW5jdGlvbiB0byBnZXQgdGhlIHkgYWxpZ25tZW50IGlmIHRoZSB0b29sdGlwIGdvZXMgb3V0c2lkZSBvZiB0aGUgbGVmdCBvciByaWdodCBlZGdlcwoKICAgIHZhciBtaWRYID0gKGNoYXJ0QXJlYS5sZWZ0ICsgY2hhcnRBcmVhLnJpZ2h0KSAvIDI7CiAgICB2YXIgbWlkWSA9IChjaGFydEFyZWEudG9wICsgY2hhcnRBcmVhLmJvdHRvbSkgLyAyOwoKICAgIGlmICh5QWxpZ24gPT09ICdjZW50ZXInKSB7CiAgICAgIGxmID0gZnVuY3Rpb24gbGYoeCkgewogICAgICAgIHJldHVybiB4IDw9IG1pZFg7CiAgICAgIH07CgogICAgICByZiA9IGZ1bmN0aW9uIHJmKHgpIHsKICAgICAgICByZXR1cm4geCA+IG1pZFg7CiAgICAgIH07CiAgICB9IGVsc2UgewogICAgICBsZiA9IGZ1bmN0aW9uIGxmKHgpIHsKICAgICAgICByZXR1cm4geCA8PSBzaXplLndpZHRoIC8gMjsKICAgICAgfTsKCiAgICAgIHJmID0gZnVuY3Rpb24gcmYoeCkgewogICAgICAgIHJldHVybiB4ID49IGNoYXJ0LndpZHRoIC0gc2l6ZS53aWR0aCAvIDI7CiAgICAgIH07CiAgICB9CgogICAgb2xmID0gZnVuY3Rpb24gb2xmKHgpIHsKICAgICAgcmV0dXJuIHggKyBzaXplLndpZHRoICsgbW9kZWwuY2FyZXRTaXplICsgbW9kZWwuY2FyZXRQYWRkaW5nID4gY2hhcnQud2lkdGg7CiAgICB9OwoKICAgIG9yZiA9IGZ1bmN0aW9uIG9yZih4KSB7CiAgICAgIHJldHVybiB4IC0gc2l6ZS53aWR0aCAtIG1vZGVsLmNhcmV0U2l6ZSAtIG1vZGVsLmNhcmV0UGFkZGluZyA8IDA7CiAgICB9OwoKICAgIHlmID0gZnVuY3Rpb24geWYoeSkgewogICAgICByZXR1cm4geSA8PSBtaWRZID8gJ3RvcCcgOiAnYm90dG9tJzsKICAgIH07CgogICAgaWYgKGxmKG1vZGVsLngpKSB7CiAgICAgIHhBbGlnbiA9ICdsZWZ0JzsgLy8gSXMgdG9vbHRpcCB0b28gd2lkZSBhbmQgZ29lcyBvdmVyIHRoZSByaWdodCBzaWRlIG9mIHRoZSBjaGFydC4/CgogICAgICBpZiAob2xmKG1vZGVsLngpKSB7CiAgICAgICAgeEFsaWduID0gJ2NlbnRlcic7CiAgICAgICAgeUFsaWduID0geWYobW9kZWwueSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAocmYobW9kZWwueCkpIHsKICAgICAgeEFsaWduID0gJ3JpZ2h0JzsgLy8gSXMgdG9vbHRpcCB0b28gd2lkZSBhbmQgZ29lcyBvdXRzaWRlIGxlZnQgZWRnZSBvZiBjYW52YXM/CgogICAgICBpZiAob3JmKG1vZGVsLngpKSB7CiAgICAgICAgeEFsaWduID0gJ2NlbnRlcic7CiAgICAgICAgeUFsaWduID0geWYobW9kZWwueSk7CiAgICAgIH0KICAgIH0KCiAgICB2YXIgb3B0cyA9IHRvb2x0aXAuX29wdGlvbnM7CiAgICByZXR1cm4gewogICAgICB4QWxpZ246IG9wdHMueEFsaWduID8gb3B0cy54QWxpZ24gOiB4QWxpZ24sCiAgICAgIHlBbGlnbjogb3B0cy55QWxpZ24gPyBvcHRzLnlBbGlnbiA6IHlBbGlnbgogICAgfTsKICB9CiAgLyoqDQogICAqIEhlbHBlciB0byBnZXQgdGhlIGxvY2F0aW9uIGEgdG9vbHRpcCBuZWVkcyB0byBiZSBwbGFjZWQgYXQgZ2l2ZW4gdGhlIGluaXRpYWwgcG9zaXRpb24gKHZpYSB0aGUgdm0pIGFuZCB0aGUgc2l6ZSBhbmQgYWxpZ25tZW50DQogICAqLwoKCiAgZnVuY3Rpb24gZ2V0QmFja2dyb3VuZFBvaW50KHZtLCBzaXplLCBhbGlnbm1lbnQsIGNoYXJ0KSB7CiAgICAvLyBCYWNrZ3JvdW5kIFBvc2l0aW9uCiAgICB2YXIgeCA9IHZtLng7CiAgICB2YXIgeSA9IHZtLnk7CiAgICB2YXIgY2FyZXRTaXplID0gdm0uY2FyZXRTaXplOwogICAgdmFyIGNhcmV0UGFkZGluZyA9IHZtLmNhcmV0UGFkZGluZzsKICAgIHZhciBjb3JuZXJSYWRpdXMgPSB2bS5jb3JuZXJSYWRpdXM7CiAgICB2YXIgeEFsaWduID0gYWxpZ25tZW50LnhBbGlnbjsKICAgIHZhciB5QWxpZ24gPSBhbGlnbm1lbnQueUFsaWduOwogICAgdmFyIHBhZGRpbmdBbmRTaXplID0gY2FyZXRTaXplICsgY2FyZXRQYWRkaW5nOwogICAgdmFyIHJhZGl1c0FuZFBhZGRpbmcgPSBjb3JuZXJSYWRpdXMgKyBjYXJldFBhZGRpbmc7CgogICAgaWYgKHhBbGlnbiA9PT0gJ3JpZ2h0JykgewogICAgICB4IC09IHNpemUud2lkdGg7CiAgICB9IGVsc2UgaWYgKHhBbGlnbiA9PT0gJ2NlbnRlcicpIHsKICAgICAgeCAtPSBzaXplLndpZHRoIC8gMjsKCiAgICAgIGlmICh4ICsgc2l6ZS53aWR0aCA+IGNoYXJ0LndpZHRoKSB7CiAgICAgICAgeCA9IGNoYXJ0LndpZHRoIC0gc2l6ZS53aWR0aDsKICAgICAgfQoKICAgICAgaWYgKHggPCAwKSB7CiAgICAgICAgeCA9IDA7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoeUFsaWduID09PSAndG9wJykgewogICAgICB5ICs9IHBhZGRpbmdBbmRTaXplOwogICAgfSBlbHNlIGlmICh5QWxpZ24gPT09ICdib3R0b20nKSB7CiAgICAgIHkgLT0gc2l6ZS5oZWlnaHQgKyBwYWRkaW5nQW5kU2l6ZTsKICAgIH0gZWxzZSB7CiAgICAgIHkgLT0gc2l6ZS5oZWlnaHQgLyAyOwogICAgfQoKICAgIGlmICh5QWxpZ24gPT09ICdjZW50ZXInKSB7CiAgICAgIGlmICh4QWxpZ24gPT09ICdsZWZ0JykgewogICAgICAgIHggKz0gcGFkZGluZ0FuZFNpemU7CiAgICAgIH0gZWxzZSBpZiAoeEFsaWduID09PSAncmlnaHQnKSB7CiAgICAgICAgeCAtPSBwYWRkaW5nQW5kU2l6ZTsKICAgICAgfQogICAgfSBlbHNlIGlmICh4QWxpZ24gPT09ICdsZWZ0JykgewogICAgICB4IC09IHJhZGl1c0FuZFBhZGRpbmc7CiAgICB9IGVsc2UgaWYgKHhBbGlnbiA9PT0gJ3JpZ2h0JykgewogICAgICB4ICs9IHJhZGl1c0FuZFBhZGRpbmc7CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgeDogeCwKICAgICAgeTogeQogICAgfTsKICB9CgogIGZ1bmN0aW9uIGdldEFsaWduZWRYKHZtLCBhbGlnbikgewogICAgcmV0dXJuIGFsaWduID09PSAnY2VudGVyJyA/IHZtLnggKyB2bS53aWR0aCAvIDIgOiBhbGlnbiA9PT0gJ3JpZ2h0JyA/IHZtLnggKyB2bS53aWR0aCAtIHZtLnhQYWRkaW5nIDogdm0ueCArIHZtLnhQYWRkaW5nOwogIH0KICAvKioNCiAgICogSGVscGVyIHRvIGJ1aWxkIGJlZm9yZSBhbmQgYWZ0ZXIgYm9keSBsaW5lcw0KICAgKi8KCgogIGZ1bmN0aW9uIGdldEJlZm9yZUFmdGVyQm9keUxpbmVzKGNhbGxiYWNrKSB7CiAgICByZXR1cm4gcHVzaE9yQ29uY2F0KFtdLCBzcGxpdE5ld2xpbmVzKGNhbGxiYWNrKSk7CiAgfQoKICB2YXIgZXhwb3J0cyQ0ID0gY29yZV9lbGVtZW50LmV4dGVuZCh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiBpbml0aWFsaXplKCkgewogICAgICB0aGlzLl9tb2RlbCA9IGdldEJhc2VNb2RlbCh0aGlzLl9vcHRpb25zKTsKICAgICAgdGhpcy5fbGFzdEFjdGl2ZSA9IFtdOwogICAgfSwKICAgIC8vIEdldCB0aGUgdGl0bGUKICAgIC8vIEFyZ3MgYXJlOiAodG9vbHRpcEl0ZW0sIGRhdGEpCiAgICBnZXRUaXRsZTogZnVuY3Rpb24gZ2V0VGl0bGUoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBvcHRzID0gbWUuX29wdGlvbnM7CiAgICAgIHZhciBjYWxsYmFja3MgPSBvcHRzLmNhbGxiYWNrczsKICAgICAgdmFyIGJlZm9yZVRpdGxlID0gY2FsbGJhY2tzLmJlZm9yZVRpdGxlLmFwcGx5KG1lLCBhcmd1bWVudHMpOwogICAgICB2YXIgdGl0bGUgPSBjYWxsYmFja3MudGl0bGUuYXBwbHkobWUsIGFyZ3VtZW50cyk7CiAgICAgIHZhciBhZnRlclRpdGxlID0gY2FsbGJhY2tzLmFmdGVyVGl0bGUuYXBwbHkobWUsIGFyZ3VtZW50cyk7CiAgICAgIHZhciBsaW5lcyA9IFtdOwogICAgICBsaW5lcyA9IHB1c2hPckNvbmNhdChsaW5lcywgc3BsaXROZXdsaW5lcyhiZWZvcmVUaXRsZSkpOwogICAgICBsaW5lcyA9IHB1c2hPckNvbmNhdChsaW5lcywgc3BsaXROZXdsaW5lcyh0aXRsZSkpOwogICAgICBsaW5lcyA9IHB1c2hPckNvbmNhdChsaW5lcywgc3BsaXROZXdsaW5lcyhhZnRlclRpdGxlKSk7CiAgICAgIHJldHVybiBsaW5lczsKICAgIH0sCiAgICAvLyBBcmdzIGFyZTogKHRvb2x0aXBJdGVtLCBkYXRhKQogICAgZ2V0QmVmb3JlQm9keTogZnVuY3Rpb24gZ2V0QmVmb3JlQm9keSgpIHsKICAgICAgcmV0dXJuIGdldEJlZm9yZUFmdGVyQm9keUxpbmVzKHRoaXMuX29wdGlvbnMuY2FsbGJhY2tzLmJlZm9yZUJvZHkuYXBwbHkodGhpcywgYXJndW1lbnRzKSk7CiAgICB9LAogICAgLy8gQXJncyBhcmU6ICh0b29sdGlwSXRlbSwgZGF0YSkKICAgIGdldEJvZHk6IGZ1bmN0aW9uIGdldEJvZHkodG9vbHRpcEl0ZW1zLCBkYXRhKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBjYWxsYmFja3MgPSBtZS5fb3B0aW9ucy5jYWxsYmFja3M7CiAgICAgIHZhciBib2R5SXRlbXMgPSBbXTsKICAgICAgaGVscGVycyQxLmVhY2godG9vbHRpcEl0ZW1zLCBmdW5jdGlvbiAodG9vbHRpcEl0ZW0pIHsKICAgICAgICB2YXIgYm9keUl0ZW0gPSB7CiAgICAgICAgICBiZWZvcmU6IFtdLAogICAgICAgICAgbGluZXM6IFtdLAogICAgICAgICAgYWZ0ZXI6IFtdCiAgICAgICAgfTsKICAgICAgICBwdXNoT3JDb25jYXQoYm9keUl0ZW0uYmVmb3JlLCBzcGxpdE5ld2xpbmVzKGNhbGxiYWNrcy5iZWZvcmVMYWJlbC5jYWxsKG1lLCB0b29sdGlwSXRlbSwgZGF0YSkpKTsKICAgICAgICBwdXNoT3JDb25jYXQoYm9keUl0ZW0ubGluZXMsIGNhbGxiYWNrcy5sYWJlbC5jYWxsKG1lLCB0b29sdGlwSXRlbSwgZGF0YSkpOwogICAgICAgIHB1c2hPckNvbmNhdChib2R5SXRlbS5hZnRlciwgc3BsaXROZXdsaW5lcyhjYWxsYmFja3MuYWZ0ZXJMYWJlbC5jYWxsKG1lLCB0b29sdGlwSXRlbSwgZGF0YSkpKTsKICAgICAgICBib2R5SXRlbXMucHVzaChib2R5SXRlbSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gYm9keUl0ZW1zOwogICAgfSwKICAgIC8vIEFyZ3MgYXJlOiAodG9vbHRpcEl0ZW0sIGRhdGEpCiAgICBnZXRBZnRlckJvZHk6IGZ1bmN0aW9uIGdldEFmdGVyQm9keSgpIHsKICAgICAgcmV0dXJuIGdldEJlZm9yZUFmdGVyQm9keUxpbmVzKHRoaXMuX29wdGlvbnMuY2FsbGJhY2tzLmFmdGVyQm9keS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH0sCiAgICAvLyBHZXQgdGhlIGZvb3RlciBhbmQgYmVmb3JlRm9vdGVyIGFuZCBhZnRlckZvb3RlciBsaW5lcwogICAgLy8gQXJncyBhcmU6ICh0b29sdGlwSXRlbSwgZGF0YSkKICAgIGdldEZvb3RlcjogZnVuY3Rpb24gZ2V0Rm9vdGVyKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgY2FsbGJhY2tzID0gbWUuX29wdGlvbnMuY2FsbGJhY2tzOwogICAgICB2YXIgYmVmb3JlRm9vdGVyID0gY2FsbGJhY2tzLmJlZm9yZUZvb3Rlci5hcHBseShtZSwgYXJndW1lbnRzKTsKICAgICAgdmFyIGZvb3RlciA9IGNhbGxiYWNrcy5mb290ZXIuYXBwbHkobWUsIGFyZ3VtZW50cyk7CiAgICAgIHZhciBhZnRlckZvb3RlciA9IGNhbGxiYWNrcy5hZnRlckZvb3Rlci5hcHBseShtZSwgYXJndW1lbnRzKTsKICAgICAgdmFyIGxpbmVzID0gW107CiAgICAgIGxpbmVzID0gcHVzaE9yQ29uY2F0KGxpbmVzLCBzcGxpdE5ld2xpbmVzKGJlZm9yZUZvb3RlcikpOwogICAgICBsaW5lcyA9IHB1c2hPckNvbmNhdChsaW5lcywgc3BsaXROZXdsaW5lcyhmb290ZXIpKTsKICAgICAgbGluZXMgPSBwdXNoT3JDb25jYXQobGluZXMsIHNwbGl0TmV3bGluZXMoYWZ0ZXJGb290ZXIpKTsKICAgICAgcmV0dXJuIGxpbmVzOwogICAgfSwKICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKGNoYW5nZWQpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9wdHMgPSBtZS5fb3B0aW9uczsgLy8gTmVlZCB0byByZWdlbmVyYXRlIHRoZSBtb2RlbCBiZWNhdXNlIGl0cyBmYXN0ZXIgdGhhbiB1c2luZyBleHRlbmQgYW5kIGl0IGlzIG5lY2Vzc2FyeSBkdWUgdG8gdGhlIG9wdGltaXphdGlvbiBpbiBDaGFydC5FbGVtZW50LnRyYW5zaXRpb24KICAgICAgLy8gdGhhdCBkb2VzIF92aWV3ID0gX21vZGVsIGlmIGVhc2UgPT09IDEuIFRoaXMgY2F1c2VzIHRoZSAybmQgdG9vbHRpcCB1cGRhdGUgdG8gc2V0IHByb3BlcnRpZXMgaW4gYm90aCB0aGUgdmlldyBhbmQgbW9kZWwgYXQgdGhlIHNhbWUgdGltZQogICAgICAvLyB3aGljaCBicmVha3MgYW55IGFuaW1hdGlvbnMuCgogICAgICB2YXIgZXhpc3RpbmdNb2RlbCA9IG1lLl9tb2RlbDsKICAgICAgdmFyIG1vZGVsID0gbWUuX21vZGVsID0gZ2V0QmFzZU1vZGVsKG9wdHMpOwogICAgICB2YXIgYWN0aXZlID0gbWUuX2FjdGl2ZTsKICAgICAgdmFyIGRhdGEgPSBtZS5fZGF0YTsgLy8gSW4gdGhlIGNhc2Ugd2hlcmUgYWN0aXZlLmxlbmd0aCA9PT0gMCB3ZSBuZWVkIHRvIGtlZXAgdGhlc2UgYXQgZXhpc3RpbmcgdmFsdWVzIGZvciBnb29kIGFuaW1hdGlvbnMKCiAgICAgIHZhciBhbGlnbm1lbnQgPSB7CiAgICAgICAgeEFsaWduOiBleGlzdGluZ01vZGVsLnhBbGlnbiwKICAgICAgICB5QWxpZ246IGV4aXN0aW5nTW9kZWwueUFsaWduCiAgICAgIH07CiAgICAgIHZhciBiYWNrZ3JvdW5kUG9pbnQgPSB7CiAgICAgICAgeDogZXhpc3RpbmdNb2RlbC54LAogICAgICAgIHk6IGV4aXN0aW5nTW9kZWwueQogICAgICB9OwogICAgICB2YXIgdG9vbHRpcFNpemUgPSB7CiAgICAgICAgd2lkdGg6IGV4aXN0aW5nTW9kZWwud2lkdGgsCiAgICAgICAgaGVpZ2h0OiBleGlzdGluZ01vZGVsLmhlaWdodAogICAgICB9OwogICAgICB2YXIgdG9vbHRpcFBvc2l0aW9uID0gewogICAgICAgIHg6IGV4aXN0aW5nTW9kZWwuY2FyZXRYLAogICAgICAgIHk6IGV4aXN0aW5nTW9kZWwuY2FyZXRZCiAgICAgIH07CiAgICAgIHZhciBpLCBsZW47CgogICAgICBpZiAoYWN0aXZlLmxlbmd0aCkgewogICAgICAgIG1vZGVsLm9wYWNpdHkgPSAxOwogICAgICAgIHZhciBsYWJlbENvbG9ycyA9IFtdOwogICAgICAgIHZhciBsYWJlbFRleHRDb2xvcnMgPSBbXTsKICAgICAgICB0b29sdGlwUG9zaXRpb24gPSBwb3NpdGlvbmVyc1tvcHRzLnBvc2l0aW9uXS5jYWxsKG1lLCBhY3RpdmUsIG1lLl9ldmVudFBvc2l0aW9uKTsKICAgICAgICB2YXIgdG9vbHRpcEl0ZW1zID0gW107CgogICAgICAgIGZvciAoaSA9IDAsIGxlbiA9IGFjdGl2ZS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICAgICAgdG9vbHRpcEl0ZW1zLnB1c2goY3JlYXRlVG9vbHRpcEl0ZW0oYWN0aXZlW2ldKSk7CiAgICAgICAgfSAvLyBJZiB0aGUgdXNlciBwcm92aWRlZCBhIGZpbHRlciBmdW5jdGlvbiwgdXNlIGl0IHRvIG1vZGlmeSB0aGUgdG9vbHRpcCBpdGVtcwoKCiAgICAgICAgaWYgKG9wdHMuZmlsdGVyKSB7CiAgICAgICAgICB0b29sdGlwSXRlbXMgPSB0b29sdGlwSXRlbXMuZmlsdGVyKGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIHJldHVybiBvcHRzLmZpbHRlcihhLCBkYXRhKTsKICAgICAgICAgIH0pOwogICAgICAgIH0gLy8gSWYgdGhlIHVzZXIgcHJvdmlkZWQgYSBzb3J0aW5nIGZ1bmN0aW9uLCB1c2UgaXQgdG8gbW9kaWZ5IHRoZSB0b29sdGlwIGl0ZW1zCgoKICAgICAgICBpZiAob3B0cy5pdGVtU29ydCkgewogICAgICAgICAgdG9vbHRpcEl0ZW1zID0gdG9vbHRpcEl0ZW1zLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIG9wdHMuaXRlbVNvcnQoYSwgYiwgZGF0YSk7CiAgICAgICAgICB9KTsKICAgICAgICB9IC8vIERldGVybWluZSBjb2xvcnMgZm9yIGJveGVzCgoKICAgICAgICBoZWxwZXJzJDEuZWFjaCh0b29sdGlwSXRlbXMsIGZ1bmN0aW9uICh0b29sdGlwSXRlbSkgewogICAgICAgICAgbGFiZWxDb2xvcnMucHVzaChvcHRzLmNhbGxiYWNrcy5sYWJlbENvbG9yLmNhbGwobWUsIHRvb2x0aXBJdGVtLCBtZS5fY2hhcnQpKTsKICAgICAgICAgIGxhYmVsVGV4dENvbG9ycy5wdXNoKG9wdHMuY2FsbGJhY2tzLmxhYmVsVGV4dENvbG9yLmNhbGwobWUsIHRvb2x0aXBJdGVtLCBtZS5fY2hhcnQpKTsKICAgICAgICB9KTsgLy8gQnVpbGQgdGhlIFRleHQgTGluZXMKCiAgICAgICAgbW9kZWwudGl0bGUgPSBtZS5nZXRUaXRsZSh0b29sdGlwSXRlbXMsIGRhdGEpOwogICAgICAgIG1vZGVsLmJlZm9yZUJvZHkgPSBtZS5nZXRCZWZvcmVCb2R5KHRvb2x0aXBJdGVtcywgZGF0YSk7CiAgICAgICAgbW9kZWwuYm9keSA9IG1lLmdldEJvZHkodG9vbHRpcEl0ZW1zLCBkYXRhKTsKICAgICAgICBtb2RlbC5hZnRlckJvZHkgPSBtZS5nZXRBZnRlckJvZHkodG9vbHRpcEl0ZW1zLCBkYXRhKTsKICAgICAgICBtb2RlbC5mb290ZXIgPSBtZS5nZXRGb290ZXIodG9vbHRpcEl0ZW1zLCBkYXRhKTsgLy8gSW5pdGlhbCBwb3NpdGlvbmluZyBhbmQgY29sb3JzCgogICAgICAgIG1vZGVsLnggPSB0b29sdGlwUG9zaXRpb24ueDsKICAgICAgICBtb2RlbC55ID0gdG9vbHRpcFBvc2l0aW9uLnk7CiAgICAgICAgbW9kZWwuY2FyZXRQYWRkaW5nID0gb3B0cy5jYXJldFBhZGRpbmc7CiAgICAgICAgbW9kZWwubGFiZWxDb2xvcnMgPSBsYWJlbENvbG9yczsKICAgICAgICBtb2RlbC5sYWJlbFRleHRDb2xvcnMgPSBsYWJlbFRleHRDb2xvcnM7IC8vIGRhdGEgcG9pbnRzCgogICAgICAgIG1vZGVsLmRhdGFQb2ludHMgPSB0b29sdGlwSXRlbXM7IC8vIFdlIG5lZWQgdG8gZGV0ZXJtaW5lIGFsaWdubWVudCBvZiB0aGUgdG9vbHRpcAoKICAgICAgICB0b29sdGlwU2l6ZSA9IGdldFRvb2x0aXBTaXplKHRoaXMsIG1vZGVsKTsKICAgICAgICBhbGlnbm1lbnQgPSBkZXRlcm1pbmVBbGlnbm1lbnQodGhpcywgdG9vbHRpcFNpemUpOyAvLyBGaW5hbCBTaXplIGFuZCBQb3NpdGlvbgoKICAgICAgICBiYWNrZ3JvdW5kUG9pbnQgPSBnZXRCYWNrZ3JvdW5kUG9pbnQobW9kZWwsIHRvb2x0aXBTaXplLCBhbGlnbm1lbnQsIG1lLl9jaGFydCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbW9kZWwub3BhY2l0eSA9IDA7CiAgICAgIH0KCiAgICAgIG1vZGVsLnhBbGlnbiA9IGFsaWdubWVudC54QWxpZ247CiAgICAgIG1vZGVsLnlBbGlnbiA9IGFsaWdubWVudC55QWxpZ247CiAgICAgIG1vZGVsLnggPSBiYWNrZ3JvdW5kUG9pbnQueDsKICAgICAgbW9kZWwueSA9IGJhY2tncm91bmRQb2ludC55OwogICAgICBtb2RlbC53aWR0aCA9IHRvb2x0aXBTaXplLndpZHRoOwogICAgICBtb2RlbC5oZWlnaHQgPSB0b29sdGlwU2l6ZS5oZWlnaHQ7IC8vIFBvaW50IHdoZXJlIHRoZSBjYXJldCBvbiB0aGUgdG9vbHRpcCBwb2ludHMgdG8KCiAgICAgIG1vZGVsLmNhcmV0WCA9IHRvb2x0aXBQb3NpdGlvbi54OwogICAgICBtb2RlbC5jYXJldFkgPSB0b29sdGlwUG9zaXRpb24ueTsKICAgICAgbWUuX21vZGVsID0gbW9kZWw7CgogICAgICBpZiAoY2hhbmdlZCAmJiBvcHRzLmN1c3RvbSkgewogICAgICAgIG9wdHMuY3VzdG9tLmNhbGwobWUsIG1vZGVsKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG1lOwogICAgfSwKICAgIGRyYXdDYXJldDogZnVuY3Rpb24gZHJhd0NhcmV0KHRvb2x0aXBQb2ludCwgc2l6ZSkgewogICAgICB2YXIgY3R4ID0gdGhpcy5fY2hhcnQuY3R4OwogICAgICB2YXIgdm0gPSB0aGlzLl92aWV3OwogICAgICB2YXIgY2FyZXRQb3NpdGlvbiA9IHRoaXMuZ2V0Q2FyZXRQb3NpdGlvbih0b29sdGlwUG9pbnQsIHNpemUsIHZtKTsKICAgICAgY3R4LmxpbmVUbyhjYXJldFBvc2l0aW9uLngxLCBjYXJldFBvc2l0aW9uLnkxKTsKICAgICAgY3R4LmxpbmVUbyhjYXJldFBvc2l0aW9uLngyLCBjYXJldFBvc2l0aW9uLnkyKTsKICAgICAgY3R4LmxpbmVUbyhjYXJldFBvc2l0aW9uLngzLCBjYXJldFBvc2l0aW9uLnkzKTsKICAgIH0sCiAgICBnZXRDYXJldFBvc2l0aW9uOiBmdW5jdGlvbiBnZXRDYXJldFBvc2l0aW9uKHRvb2x0aXBQb2ludCwgc2l6ZSwgdm0pIHsKICAgICAgdmFyIHgxLCB4MiwgeDMsIHkxLCB5MiwgeTM7CiAgICAgIHZhciBjYXJldFNpemUgPSB2bS5jYXJldFNpemU7CiAgICAgIHZhciBjb3JuZXJSYWRpdXMgPSB2bS5jb3JuZXJSYWRpdXM7CiAgICAgIHZhciB4QWxpZ24gPSB2bS54QWxpZ247CiAgICAgIHZhciB5QWxpZ24gPSB2bS55QWxpZ247CiAgICAgIHZhciBwdFggPSB0b29sdGlwUG9pbnQueDsKICAgICAgdmFyIHB0WSA9IHRvb2x0aXBQb2ludC55OwogICAgICB2YXIgd2lkdGggPSBzaXplLndpZHRoOwogICAgICB2YXIgaGVpZ2h0ID0gc2l6ZS5oZWlnaHQ7CgogICAgICBpZiAoeUFsaWduID09PSAnY2VudGVyJykgewogICAgICAgIHkyID0gcHRZICsgaGVpZ2h0IC8gMjsKCiAgICAgICAgaWYgKHhBbGlnbiA9PT0gJ2xlZnQnKSB7CiAgICAgICAgICB4MSA9IHB0WDsKICAgICAgICAgIHgyID0geDEgLSBjYXJldFNpemU7CiAgICAgICAgICB4MyA9IHgxOwogICAgICAgICAgeTEgPSB5MiArIGNhcmV0U2l6ZTsKICAgICAgICAgIHkzID0geTIgLSBjYXJldFNpemU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHgxID0gcHRYICsgd2lkdGg7CiAgICAgICAgICB4MiA9IHgxICsgY2FyZXRTaXplOwogICAgICAgICAgeDMgPSB4MTsKICAgICAgICAgIHkxID0geTIgLSBjYXJldFNpemU7CiAgICAgICAgICB5MyA9IHkyICsgY2FyZXRTaXplOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAoeEFsaWduID09PSAnbGVmdCcpIHsKICAgICAgICAgIHgyID0gcHRYICsgY29ybmVyUmFkaXVzICsgY2FyZXRTaXplOwogICAgICAgICAgeDEgPSB4MiAtIGNhcmV0U2l6ZTsKICAgICAgICAgIHgzID0geDIgKyBjYXJldFNpemU7CiAgICAgICAgfSBlbHNlIGlmICh4QWxpZ24gPT09ICdyaWdodCcpIHsKICAgICAgICAgIHgyID0gcHRYICsgd2lkdGggLSBjb3JuZXJSYWRpdXMgLSBjYXJldFNpemU7CiAgICAgICAgICB4MSA9IHgyIC0gY2FyZXRTaXplOwogICAgICAgICAgeDMgPSB4MiArIGNhcmV0U2l6ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeDIgPSB2bS5jYXJldFg7CiAgICAgICAgICB4MSA9IHgyIC0gY2FyZXRTaXplOwogICAgICAgICAgeDMgPSB4MiArIGNhcmV0U2l6ZTsKICAgICAgICB9CgogICAgICAgIGlmICh5QWxpZ24gPT09ICd0b3AnKSB7CiAgICAgICAgICB5MSA9IHB0WTsKICAgICAgICAgIHkyID0geTEgLSBjYXJldFNpemU7CiAgICAgICAgICB5MyA9IHkxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB5MSA9IHB0WSArIGhlaWdodDsKICAgICAgICAgIHkyID0geTEgKyBjYXJldFNpemU7CiAgICAgICAgICB5MyA9IHkxOyAvLyBpbnZlcnQgZHJhd2luZyBvcmRlcgoKICAgICAgICAgIHZhciB0bXAgPSB4MzsKICAgICAgICAgIHgzID0geDE7CiAgICAgICAgICB4MSA9IHRtcDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgeDE6IHgxLAogICAgICAgIHgyOiB4MiwKICAgICAgICB4MzogeDMsCiAgICAgICAgeTE6IHkxLAogICAgICAgIHkyOiB5MiwKICAgICAgICB5MzogeTMKICAgICAgfTsKICAgIH0sCiAgICBkcmF3VGl0bGU6IGZ1bmN0aW9uIGRyYXdUaXRsZShwdCwgdm0sIGN0eCkgewogICAgICB2YXIgdGl0bGUgPSB2bS50aXRsZTsKICAgICAgdmFyIGxlbmd0aCA9IHRpdGxlLmxlbmd0aDsKICAgICAgdmFyIHRpdGxlRm9udFNpemUsIHRpdGxlU3BhY2luZywgaTsKCiAgICAgIGlmIChsZW5ndGgpIHsKICAgICAgICB2YXIgcnRsSGVscGVyID0gZ2V0UnRsSGVscGVyKHZtLnJ0bCwgdm0ueCwgdm0ud2lkdGgpOwogICAgICAgIHB0LnggPSBnZXRBbGlnbmVkWCh2bSwgdm0uX3RpdGxlQWxpZ24pOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSBydGxIZWxwZXIudGV4dEFsaWduKHZtLl90aXRsZUFsaWduKTsKICAgICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgICAgdGl0bGVGb250U2l6ZSA9IHZtLnRpdGxlRm9udFNpemU7CiAgICAgICAgdGl0bGVTcGFjaW5nID0gdm0udGl0bGVTcGFjaW5nOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSB2bS50aXRsZUZvbnRDb2xvcjsKICAgICAgICBjdHguZm9udCA9IGhlbHBlcnMkMS5mb250U3RyaW5nKHRpdGxlRm9udFNpemUsIHZtLl90aXRsZUZvbnRTdHlsZSwgdm0uX3RpdGxlRm9udEZhbWlseSk7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICAgICAgY3R4LmZpbGxUZXh0KHRpdGxlW2ldLCBydGxIZWxwZXIueChwdC54KSwgcHQueSArIHRpdGxlRm9udFNpemUgLyAyKTsKICAgICAgICAgIHB0LnkgKz0gdGl0bGVGb250U2l6ZSArIHRpdGxlU3BhY2luZzsgLy8gTGluZSBIZWlnaHQgYW5kIHNwYWNpbmcKCiAgICAgICAgICBpZiAoaSArIDEgPT09IGxlbmd0aCkgewogICAgICAgICAgICBwdC55ICs9IHZtLnRpdGxlTWFyZ2luQm90dG9tIC0gdGl0bGVTcGFjaW5nOyAvLyBJZiBMYXN0LCBhZGQgbWFyZ2luLCByZW1vdmUgc3BhY2luZwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGRyYXdCb2R5OiBmdW5jdGlvbiBkcmF3Qm9keShwdCwgdm0sIGN0eCkgewogICAgICB2YXIgYm9keUZvbnRTaXplID0gdm0uYm9keUZvbnRTaXplOwogICAgICB2YXIgYm9keVNwYWNpbmcgPSB2bS5ib2R5U3BhY2luZzsKICAgICAgdmFyIGJvZHlBbGlnbiA9IHZtLl9ib2R5QWxpZ247CiAgICAgIHZhciBib2R5ID0gdm0uYm9keTsKICAgICAgdmFyIGRyYXdDb2xvckJveGVzID0gdm0uZGlzcGxheUNvbG9yczsKICAgICAgdmFyIHhMaW5lUGFkZGluZyA9IDA7CiAgICAgIHZhciBjb2xvclggPSBkcmF3Q29sb3JCb3hlcyA/IGdldEFsaWduZWRYKHZtLCAnbGVmdCcpIDogMDsKICAgICAgdmFyIHJ0bEhlbHBlciA9IGdldFJ0bEhlbHBlcih2bS5ydGwsIHZtLngsIHZtLndpZHRoKTsKCiAgICAgIHZhciBmaWxsTGluZU9mVGV4dCA9IGZ1bmN0aW9uIGZpbGxMaW5lT2ZUZXh0KGxpbmUpIHsKICAgICAgICBjdHguZmlsbFRleHQobGluZSwgcnRsSGVscGVyLngocHQueCArIHhMaW5lUGFkZGluZyksIHB0LnkgKyBib2R5Rm9udFNpemUgLyAyKTsKICAgICAgICBwdC55ICs9IGJvZHlGb250U2l6ZSArIGJvZHlTcGFjaW5nOwogICAgICB9OwoKICAgICAgdmFyIGJvZHlJdGVtLCB0ZXh0Q29sb3IsIGxhYmVsQ29sb3JzLCBsaW5lcywgaSwgaiwgaWxlbiwgamxlbjsKICAgICAgdmFyIGJvZHlBbGlnbkZvckNhbGN1bGF0aW9uID0gcnRsSGVscGVyLnRleHRBbGlnbihib2R5QWxpZ24pOwogICAgICBjdHgudGV4dEFsaWduID0gYm9keUFsaWduOwogICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgIGN0eC5mb250ID0gaGVscGVycyQxLmZvbnRTdHJpbmcoYm9keUZvbnRTaXplLCB2bS5fYm9keUZvbnRTdHlsZSwgdm0uX2JvZHlGb250RmFtaWx5KTsKICAgICAgcHQueCA9IGdldEFsaWduZWRYKHZtLCBib2R5QWxpZ25Gb3JDYWxjdWxhdGlvbik7IC8vIEJlZm9yZSBib2R5IGxpbmVzCgogICAgICBjdHguZmlsbFN0eWxlID0gdm0uYm9keUZvbnRDb2xvcjsKICAgICAgaGVscGVycyQxLmVhY2godm0uYmVmb3JlQm9keSwgZmlsbExpbmVPZlRleHQpOwogICAgICB4TGluZVBhZGRpbmcgPSBkcmF3Q29sb3JCb3hlcyAmJiBib2R5QWxpZ25Gb3JDYWxjdWxhdGlvbiAhPT0gJ3JpZ2h0JyA/IGJvZHlBbGlnbiA9PT0gJ2NlbnRlcicgPyBib2R5Rm9udFNpemUgLyAyICsgMSA6IGJvZHlGb250U2l6ZSArIDIgOiAwOyAvLyBEcmF3IGJvZHkgbGluZXMgbm93CgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gYm9keS5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBib2R5SXRlbSA9IGJvZHlbaV07CiAgICAgICAgdGV4dENvbG9yID0gdm0ubGFiZWxUZXh0Q29sb3JzW2ldOwogICAgICAgIGxhYmVsQ29sb3JzID0gdm0ubGFiZWxDb2xvcnNbaV07CiAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHRleHRDb2xvcjsKICAgICAgICBoZWxwZXJzJDEuZWFjaChib2R5SXRlbS5iZWZvcmUsIGZpbGxMaW5lT2ZUZXh0KTsKICAgICAgICBsaW5lcyA9IGJvZHlJdGVtLmxpbmVzOwoKICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gbGluZXMubGVuZ3RoOyBqIDwgamxlbjsgKytqKSB7CiAgICAgICAgICAvLyBEcmF3IExlZ2VuZC1saWtlIGJveGVzIGlmIG5lZWRlZAogICAgICAgICAgaWYgKGRyYXdDb2xvckJveGVzKSB7CiAgICAgICAgICAgIHZhciBydGxDb2xvclggPSBydGxIZWxwZXIueChjb2xvclgpOyAvLyBGaWxsIGEgd2hpdGUgcmVjdCBzbyB0aGF0IGNvbG91cnMgbWVyZ2UgbmljZWx5IGlmIHRoZSBvcGFjaXR5IGlzIDwgMQoKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHZtLmxlZ2VuZENvbG9yQmFja2dyb3VuZDsKICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHJ0bEhlbHBlci5sZWZ0Rm9yTHRyKHJ0bENvbG9yWCwgYm9keUZvbnRTaXplKSwgcHQueSwgYm9keUZvbnRTaXplLCBib2R5Rm9udFNpemUpOyAvLyBCb3JkZXIKCiAgICAgICAgICAgIGN0eC5saW5lV2lkdGggPSAxOwogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBsYWJlbENvbG9ycy5ib3JkZXJDb2xvcjsKICAgICAgICAgICAgY3R4LnN0cm9rZVJlY3QocnRsSGVscGVyLmxlZnRGb3JMdHIocnRsQ29sb3JYLCBib2R5Rm9udFNpemUpLCBwdC55LCBib2R5Rm9udFNpemUsIGJvZHlGb250U2l6ZSk7IC8vIElubmVyIHNxdWFyZQoKICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGxhYmVsQ29sb3JzLmJhY2tncm91bmRDb2xvcjsKICAgICAgICAgICAgY3R4LmZpbGxSZWN0KHJ0bEhlbHBlci5sZWZ0Rm9yTHRyKHJ0bEhlbHBlci54UGx1cyhydGxDb2xvclgsIDEpLCBib2R5Rm9udFNpemUgLSAyKSwgcHQueSArIDEsIGJvZHlGb250U2l6ZSAtIDIsIGJvZHlGb250U2l6ZSAtIDIpOwogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gdGV4dENvbG9yOwogICAgICAgICAgfQoKICAgICAgICAgIGZpbGxMaW5lT2ZUZXh0KGxpbmVzW2pdKTsKICAgICAgICB9CgogICAgICAgIGhlbHBlcnMkMS5lYWNoKGJvZHlJdGVtLmFmdGVyLCBmaWxsTGluZU9mVGV4dCk7CiAgICAgIH0gLy8gUmVzZXQgYmFjayB0byAwIGZvciBhZnRlciBib2R5CgoKICAgICAgeExpbmVQYWRkaW5nID0gMDsgLy8gQWZ0ZXIgYm9keSBsaW5lcwoKICAgICAgaGVscGVycyQxLmVhY2godm0uYWZ0ZXJCb2R5LCBmaWxsTGluZU9mVGV4dCk7CiAgICAgIHB0LnkgLT0gYm9keVNwYWNpbmc7IC8vIFJlbW92ZSBsYXN0IGJvZHkgc3BhY2luZwogICAgfSwKICAgIGRyYXdGb290ZXI6IGZ1bmN0aW9uIGRyYXdGb290ZXIocHQsIHZtLCBjdHgpIHsKICAgICAgdmFyIGZvb3RlciA9IHZtLmZvb3RlcjsKICAgICAgdmFyIGxlbmd0aCA9IGZvb3Rlci5sZW5ndGg7CiAgICAgIHZhciBmb290ZXJGb250U2l6ZSwgaTsKCiAgICAgIGlmIChsZW5ndGgpIHsKICAgICAgICB2YXIgcnRsSGVscGVyID0gZ2V0UnRsSGVscGVyKHZtLnJ0bCwgdm0ueCwgdm0ud2lkdGgpOwogICAgICAgIHB0LnggPSBnZXRBbGlnbmVkWCh2bSwgdm0uX2Zvb3RlckFsaWduKTsKICAgICAgICBwdC55ICs9IHZtLmZvb3Rlck1hcmdpblRvcDsKICAgICAgICBjdHgudGV4dEFsaWduID0gcnRsSGVscGVyLnRleHRBbGlnbih2bS5fZm9vdGVyQWxpZ24pOwogICAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAnbWlkZGxlJzsKICAgICAgICBmb290ZXJGb250U2l6ZSA9IHZtLmZvb3RlckZvbnRTaXplOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSB2bS5mb290ZXJGb250Q29sb3I7CiAgICAgICAgY3R4LmZvbnQgPSBoZWxwZXJzJDEuZm9udFN0cmluZyhmb290ZXJGb250U2l6ZSwgdm0uX2Zvb3RlckZvbnRTdHlsZSwgdm0uX2Zvb3RlckZvbnRGYW1pbHkpOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGN0eC5maWxsVGV4dChmb290ZXJbaV0sIHJ0bEhlbHBlci54KHB0LngpLCBwdC55ICsgZm9vdGVyRm9udFNpemUgLyAyKTsKICAgICAgICAgIHB0LnkgKz0gZm9vdGVyRm9udFNpemUgKyB2bS5mb290ZXJTcGFjaW5nOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGRyYXdCYWNrZ3JvdW5kOiBmdW5jdGlvbiBkcmF3QmFja2dyb3VuZChwdCwgdm0sIGN0eCwgdG9vbHRpcFNpemUpIHsKICAgICAgY3R4LmZpbGxTdHlsZSA9IHZtLmJhY2tncm91bmRDb2xvcjsKICAgICAgY3R4LnN0cm9rZVN0eWxlID0gdm0uYm9yZGVyQ29sb3I7CiAgICAgIGN0eC5saW5lV2lkdGggPSB2bS5ib3JkZXJXaWR0aDsKICAgICAgdmFyIHhBbGlnbiA9IHZtLnhBbGlnbjsKICAgICAgdmFyIHlBbGlnbiA9IHZtLnlBbGlnbjsKICAgICAgdmFyIHggPSBwdC54OwogICAgICB2YXIgeSA9IHB0Lnk7CiAgICAgIHZhciB3aWR0aCA9IHRvb2x0aXBTaXplLndpZHRoOwogICAgICB2YXIgaGVpZ2h0ID0gdG9vbHRpcFNpemUuaGVpZ2h0OwogICAgICB2YXIgcmFkaXVzID0gdm0uY29ybmVyUmFkaXVzOwogICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgIGN0eC5tb3ZlVG8oeCArIHJhZGl1cywgeSk7CgogICAgICBpZiAoeUFsaWduID09PSAndG9wJykgewogICAgICAgIHRoaXMuZHJhd0NhcmV0KHB0LCB0b29sdGlwU2l6ZSk7CiAgICAgIH0KCiAgICAgIGN0eC5saW5lVG8oeCArIHdpZHRoIC0gcmFkaXVzLCB5KTsKICAgICAgY3R4LnF1YWRyYXRpY0N1cnZlVG8oeCArIHdpZHRoLCB5LCB4ICsgd2lkdGgsIHkgKyByYWRpdXMpOwoKICAgICAgaWYgKHlBbGlnbiA9PT0gJ2NlbnRlcicgJiYgeEFsaWduID09PSAncmlnaHQnKSB7CiAgICAgICAgdGhpcy5kcmF3Q2FyZXQocHQsIHRvb2x0aXBTaXplKTsKICAgICAgfQoKICAgICAgY3R4LmxpbmVUbyh4ICsgd2lkdGgsIHkgKyBoZWlnaHQgLSByYWRpdXMpOwogICAgICBjdHgucXVhZHJhdGljQ3VydmVUbyh4ICsgd2lkdGgsIHkgKyBoZWlnaHQsIHggKyB3aWR0aCAtIHJhZGl1cywgeSArIGhlaWdodCk7CgogICAgICBpZiAoeUFsaWduID09PSAnYm90dG9tJykgewogICAgICAgIHRoaXMuZHJhd0NhcmV0KHB0LCB0b29sdGlwU2l6ZSk7CiAgICAgIH0KCiAgICAgIGN0eC5saW5lVG8oeCArIHJhZGl1cywgeSArIGhlaWdodCk7CiAgICAgIGN0eC5xdWFkcmF0aWNDdXJ2ZVRvKHgsIHkgKyBoZWlnaHQsIHgsIHkgKyBoZWlnaHQgLSByYWRpdXMpOwoKICAgICAgaWYgKHlBbGlnbiA9PT0gJ2NlbnRlcicgJiYgeEFsaWduID09PSAnbGVmdCcpIHsKICAgICAgICB0aGlzLmRyYXdDYXJldChwdCwgdG9vbHRpcFNpemUpOwogICAgICB9CgogICAgICBjdHgubGluZVRvKHgsIHkgKyByYWRpdXMpOwogICAgICBjdHgucXVhZHJhdGljQ3VydmVUbyh4LCB5LCB4ICsgcmFkaXVzLCB5KTsKICAgICAgY3R4LmNsb3NlUGF0aCgpOwogICAgICBjdHguZmlsbCgpOwoKICAgICAgaWYgKHZtLmJvcmRlcldpZHRoID4gMCkgewogICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgfQogICAgfSwKICAgIGRyYXc6IGZ1bmN0aW9uIGRyYXcoKSB7CiAgICAgIHZhciBjdHggPSB0aGlzLl9jaGFydC5jdHg7CiAgICAgIHZhciB2bSA9IHRoaXMuX3ZpZXc7CgogICAgICBpZiAodm0ub3BhY2l0eSA9PT0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHRvb2x0aXBTaXplID0gewogICAgICAgIHdpZHRoOiB2bS53aWR0aCwKICAgICAgICBoZWlnaHQ6IHZtLmhlaWdodAogICAgICB9OwogICAgICB2YXIgcHQgPSB7CiAgICAgICAgeDogdm0ueCwKICAgICAgICB5OiB2bS55CiAgICAgIH07IC8vIElFMTEvRWRnZSBkb2VzIG5vdCBsaWtlIHZlcnkgc21hbGwgb3BhY2l0aWVzLCBzbyBzbmFwIHRvIDAKCiAgICAgIHZhciBvcGFjaXR5ID0gTWF0aC5hYnModm0ub3BhY2l0eSA8IDFlLTMpID8gMCA6IHZtLm9wYWNpdHk7IC8vIFRydXRoeS9mYWxzZXkgdmFsdWUgZm9yIGVtcHR5IHRvb2x0aXAKCiAgICAgIHZhciBoYXNUb29sdGlwQ29udGVudCA9IHZtLnRpdGxlLmxlbmd0aCB8fCB2bS5iZWZvcmVCb2R5Lmxlbmd0aCB8fCB2bS5ib2R5Lmxlbmd0aCB8fCB2bS5hZnRlckJvZHkubGVuZ3RoIHx8IHZtLmZvb3Rlci5sZW5ndGg7CgogICAgICBpZiAodGhpcy5fb3B0aW9ucy5lbmFibGVkICYmIGhhc1Rvb2x0aXBDb250ZW50KSB7CiAgICAgICAgY3R4LnNhdmUoKTsKICAgICAgICBjdHguZ2xvYmFsQWxwaGEgPSBvcGFjaXR5OyAvLyBEcmF3IEJhY2tncm91bmQKCiAgICAgICAgdGhpcy5kcmF3QmFja2dyb3VuZChwdCwgdm0sIGN0eCwgdG9vbHRpcFNpemUpOyAvLyBEcmF3IFRpdGxlLCBCb2R5LCBhbmQgRm9vdGVyCgogICAgICAgIHB0LnkgKz0gdm0ueVBhZGRpbmc7CiAgICAgICAgaGVscGVycyQxLnJ0bC5vdmVycmlkZVRleHREaXJlY3Rpb24oY3R4LCB2bS50ZXh0RGlyZWN0aW9uKTsgLy8gVGl0bGVzCgogICAgICAgIHRoaXMuZHJhd1RpdGxlKHB0LCB2bSwgY3R4KTsgLy8gQm9keQoKICAgICAgICB0aGlzLmRyYXdCb2R5KHB0LCB2bSwgY3R4KTsgLy8gRm9vdGVyCgogICAgICAgIHRoaXMuZHJhd0Zvb3RlcihwdCwgdm0sIGN0eCk7CiAgICAgICAgaGVscGVycyQxLnJ0bC5yZXN0b3JlVGV4dERpcmVjdGlvbihjdHgsIHZtLnRleHREaXJlY3Rpb24pOwogICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqDQogICAgICogSGFuZGxlIGFuIGV2ZW50DQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge0lFdmVudH0gZXZlbnQgLSBUaGUgZXZlbnQgdG8gaGFuZGxlDQogICAgICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgdGhlIHRvb2x0aXAgY2hhbmdlZA0KICAgICAqLwogICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uIGhhbmRsZUV2ZW50KGUpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9wdGlvbnMgPSBtZS5fb3B0aW9uczsKICAgICAgdmFyIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgbWUuX2xhc3RBY3RpdmUgPSBtZS5fbGFzdEFjdGl2ZSB8fCBbXTsgLy8gRmluZCBBY3RpdmUgRWxlbWVudHMgZm9yIHRvb2x0aXBzCgogICAgICBpZiAoZS50eXBlID09PSAnbW91c2VvdXQnKSB7CiAgICAgICAgbWUuX2FjdGl2ZSA9IFtdOwogICAgICB9IGVsc2UgewogICAgICAgIG1lLl9hY3RpdmUgPSBtZS5fY2hhcnQuZ2V0RWxlbWVudHNBdEV2ZW50Rm9yTW9kZShlLCBvcHRpb25zLm1vZGUsIG9wdGlvbnMpOwoKICAgICAgICBpZiAob3B0aW9ucy5yZXZlcnNlKSB7CiAgICAgICAgICBtZS5fYWN0aXZlLnJldmVyc2UoKTsKICAgICAgICB9CiAgICAgIH0gLy8gUmVtZW1iZXIgTGFzdCBBY3RpdmVzCgoKICAgICAgY2hhbmdlZCA9ICFoZWxwZXJzJDEuYXJyYXlFcXVhbHMobWUuX2FjdGl2ZSwgbWUuX2xhc3RBY3RpdmUpOyAvLyBPbmx5IGhhbmRsZSB0YXJnZXQgZXZlbnQgb24gdG9vbHRpcCBjaGFuZ2UKCiAgICAgIGlmIChjaGFuZ2VkKSB7CiAgICAgICAgbWUuX2xhc3RBY3RpdmUgPSBtZS5fYWN0aXZlOwoKICAgICAgICBpZiAob3B0aW9ucy5lbmFibGVkIHx8IG9wdGlvbnMuY3VzdG9tKSB7CiAgICAgICAgICBtZS5fZXZlbnRQb3NpdGlvbiA9IHsKICAgICAgICAgICAgeDogZS54LAogICAgICAgICAgICB5OiBlLnkKICAgICAgICAgIH07CiAgICAgICAgICBtZS51cGRhdGUodHJ1ZSk7CiAgICAgICAgICBtZS5waXZvdCgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGNoYW5nZWQ7CiAgICB9CiAgfSk7CiAgLyoqDQogICAqIEBuYW1lc3BhY2UgQ2hhcnQuVG9vbHRpcC5wb3NpdGlvbmVycw0KICAgKi8KCiAgdmFyIHBvc2l0aW9uZXJzXzEgPSBwb3NpdGlvbmVyczsKICB2YXIgY29yZV90b29sdGlwID0gZXhwb3J0cyQ0OwogIGNvcmVfdG9vbHRpcC5wb3NpdGlvbmVycyA9IHBvc2l0aW9uZXJzXzE7CiAgdmFyIHZhbHVlT3JEZWZhdWx0JDkgPSBoZWxwZXJzJDEudmFsdWVPckRlZmF1bHQ7CgogIGNvcmVfZGVmYXVsdHMuX3NldCgnZ2xvYmFsJywgewogICAgZWxlbWVudHM6IHt9LAogICAgZXZlbnRzOiBbJ21vdXNlbW92ZScsICdtb3VzZW91dCcsICdjbGljaycsICd0b3VjaHN0YXJ0JywgJ3RvdWNobW92ZSddLAogICAgaG92ZXI6IHsKICAgICAgb25Ib3ZlcjogbnVsbCwKICAgICAgbW9kZTogJ25lYXJlc3QnLAogICAgICBpbnRlcnNlY3Q6IHRydWUsCiAgICAgIGFuaW1hdGlvbkR1cmF0aW9uOiA0MDAKICAgIH0sCiAgICBvbkNsaWNrOiBudWxsLAogICAgbWFpbnRhaW5Bc3BlY3RSYXRpbzogdHJ1ZSwKICAgIHJlc3BvbnNpdmU6IHRydWUsCiAgICByZXNwb25zaXZlQW5pbWF0aW9uRHVyYXRpb246IDAKICB9KTsKICAvKioNCiAgICogUmVjdXJzaXZlbHkgbWVyZ2UgdGhlIGdpdmVuIGNvbmZpZyBvYmplY3RzIHJlcHJlc2VudGluZyB0aGUgYHNjYWxlc2Agb3B0aW9uDQogICAqIGJ5IGluY29ycG9yYXRpbmcgc2NhbGUgZGVmYXVsdHMgaW4gYHhBeGVzYCBhbmQgYHlBeGVzYCBhcnJheSBpdGVtcywgdGhlbg0KICAgKiByZXR1cm5zIGEgZGVlcCBjb3B5IG9mIHRoZSByZXN1bHQsIHRodXMgZG9lc24ndCBhbHRlciBpbnB1dHMuDQogICAqLwoKCiAgZnVuY3Rpb24gbWVyZ2VTY2FsZUNvbmZpZygpCiAgLyogY29uZmlnIG9iamVjdHMgLi4uICovCiAgewogICAgcmV0dXJuIGhlbHBlcnMkMS5tZXJnZShPYmplY3QuY3JlYXRlKG51bGwpLCBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cyksIHsKICAgICAgbWVyZ2VyOiBmdW5jdGlvbiBtZXJnZXIoa2V5LCB0YXJnZXQsIHNvdXJjZSwgb3B0aW9ucykgewogICAgICAgIGlmIChrZXkgPT09ICd4QXhlcycgfHwga2V5ID09PSAneUF4ZXMnKSB7CiAgICAgICAgICB2YXIgc2xlbiA9IHNvdXJjZVtrZXldLmxlbmd0aDsKICAgICAgICAgIHZhciBpLCB0eXBlLCBzY2FsZTsKCiAgICAgICAgICBpZiAoIXRhcmdldFtrZXldKSB7CiAgICAgICAgICAgIHRhcmdldFtrZXldID0gW107CiAgICAgICAgICB9CgogICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNsZW47ICsraSkgewogICAgICAgICAgICBzY2FsZSA9IHNvdXJjZVtrZXldW2ldOwogICAgICAgICAgICB0eXBlID0gdmFsdWVPckRlZmF1bHQkOShzY2FsZS50eXBlLCBrZXkgPT09ICd4QXhlcycgPyAnY2F0ZWdvcnknIDogJ2xpbmVhcicpOwoKICAgICAgICAgICAgaWYgKGkgPj0gdGFyZ2V0W2tleV0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdGFyZ2V0W2tleV0ucHVzaCh7fSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICghdGFyZ2V0W2tleV1baV0udHlwZSB8fCBzY2FsZS50eXBlICYmIHNjYWxlLnR5cGUgIT09IHRhcmdldFtrZXldW2ldLnR5cGUpIHsKICAgICAgICAgICAgICAvLyBuZXcvdW50eXBlZCBzY2FsZSBvciB0eXBlIGNoYW5nZWQ6IGxldCdzIGFwcGx5IHRoZSBuZXcgZGVmYXVsdHMKICAgICAgICAgICAgICAvLyB0aGVuIG1lcmdlIHNvdXJjZSBzY2FsZSB0byBjb3JyZWN0bHkgb3ZlcndyaXRlIHRoZSBkZWZhdWx0cy4KICAgICAgICAgICAgICBoZWxwZXJzJDEubWVyZ2UodGFyZ2V0W2tleV1baV0sIFtjb3JlX3NjYWxlU2VydmljZS5nZXRTY2FsZURlZmF1bHRzKHR5cGUpLCBzY2FsZV0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIC8vIHNjYWxlcyB0eXBlIGFyZSB0aGUgc2FtZQogICAgICAgICAgICAgIGhlbHBlcnMkMS5tZXJnZSh0YXJnZXRba2V5XVtpXSwgc2NhbGUpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGhlbHBlcnMkMS5fbWVyZ2VyKGtleSwgdGFyZ2V0LCBzb3VyY2UsIG9wdGlvbnMpOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgfQogIC8qKg0KICAgKiBSZWN1cnNpdmVseSBtZXJnZSB0aGUgZ2l2ZW4gY29uZmlnIG9iamVjdHMgYXMgdGhlIHJvb3Qgb3B0aW9ucyBieSBoYW5kbGluZw0KICAgKiBkZWZhdWx0IHNjYWxlIG9wdGlvbnMgZm9yIHRoZSBgc2NhbGVzYCBhbmQgYHNjYWxlYCBwcm9wZXJ0aWVzLCB0aGVuIHJldHVybnMNCiAgICogYSBkZWVwIGNvcHkgb2YgdGhlIHJlc3VsdCwgdGh1cyBkb2Vzbid0IGFsdGVyIGlucHV0cy4NCiAgICovCgoKICBmdW5jdGlvbiBtZXJnZUNvbmZpZygpCiAgLyogY29uZmlnIG9iamVjdHMgLi4uICovCiAgewogICAgcmV0dXJuIGhlbHBlcnMkMS5tZXJnZShPYmplY3QuY3JlYXRlKG51bGwpLCBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cyksIHsKICAgICAgbWVyZ2VyOiBmdW5jdGlvbiBtZXJnZXIoa2V5LCB0YXJnZXQsIHNvdXJjZSwgb3B0aW9ucykgewogICAgICAgIHZhciB0dmFsID0gdGFyZ2V0W2tleV0gfHwgT2JqZWN0LmNyZWF0ZShudWxsKTsKICAgICAgICB2YXIgc3ZhbCA9IHNvdXJjZVtrZXldOwoKICAgICAgICBpZiAoa2V5ID09PSAnc2NhbGVzJykgewogICAgICAgICAgLy8gc2NhbGUgY29uZmlnIG1lcmdpbmcgaXMgY29tcGxleC4gQWRkIG91ciBvd24gZnVuY3Rpb24gaGVyZSBmb3IgdGhhdAogICAgICAgICAgdGFyZ2V0W2tleV0gPSBtZXJnZVNjYWxlQ29uZmlnKHR2YWwsIHN2YWwpOwogICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAnc2NhbGUnKSB7CiAgICAgICAgICAvLyB1c2VkIGluIHBvbGFyIGFyZWEgJiByYWRhciBjaGFydHMgc2luY2UgdGhlcmUgaXMgb25seSBvbmUgc2NhbGUKICAgICAgICAgIHRhcmdldFtrZXldID0gaGVscGVycyQxLm1lcmdlKHR2YWwsIFtjb3JlX3NjYWxlU2VydmljZS5nZXRTY2FsZURlZmF1bHRzKHN2YWwudHlwZSksIHN2YWxdKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaGVscGVycyQxLl9tZXJnZXIoa2V5LCB0YXJnZXQsIHNvdXJjZSwgb3B0aW9ucyk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGluaXRDb25maWcoY29uZmlnKSB7CiAgICBjb25maWcgPSBjb25maWcgfHwgT2JqZWN0LmNyZWF0ZShudWxsKTsgLy8gRG8gTk9UIHVzZSBtZXJnZUNvbmZpZyBmb3IgdGhlIGRhdGEgb2JqZWN0IGJlY2F1c2UgdGhpcyBtZXRob2QgbWVyZ2VzIGFycmF5cwogICAgLy8gYW5kIHNvIHdvdWxkIGNoYW5nZSByZWZlcmVuY2VzIHRvIGxhYmVscyBhbmQgZGF0YXNldHMsIHByZXZlbnRpbmcgZGF0YSB1cGRhdGVzLgoKICAgIHZhciBkYXRhID0gY29uZmlnLmRhdGEgPSBjb25maWcuZGF0YSB8fCB7fTsKICAgIGRhdGEuZGF0YXNldHMgPSBkYXRhLmRhdGFzZXRzIHx8IFtdOwogICAgZGF0YS5sYWJlbHMgPSBkYXRhLmxhYmVscyB8fCBbXTsKICAgIGNvbmZpZy5vcHRpb25zID0gbWVyZ2VDb25maWcoY29yZV9kZWZhdWx0cy5nbG9iYWwsIGNvcmVfZGVmYXVsdHNbY29uZmlnLnR5cGVdLCBjb25maWcub3B0aW9ucyB8fCB7fSk7CiAgICByZXR1cm4gY29uZmlnOwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlQ29uZmlnKGNoYXJ0KSB7CiAgICB2YXIgbmV3T3B0aW9ucyA9IGNoYXJ0Lm9wdGlvbnM7CiAgICBoZWxwZXJzJDEuZWFjaChjaGFydC5zY2FsZXMsIGZ1bmN0aW9uIChzY2FsZSkgewogICAgICBjb3JlX2xheW91dHMucmVtb3ZlQm94KGNoYXJ0LCBzY2FsZSk7CiAgICB9KTsKICAgIG5ld09wdGlvbnMgPSBtZXJnZUNvbmZpZyhjb3JlX2RlZmF1bHRzLmdsb2JhbCwgY29yZV9kZWZhdWx0c1tjaGFydC5jb25maWcudHlwZV0sIG5ld09wdGlvbnMpOwogICAgY2hhcnQub3B0aW9ucyA9IGNoYXJ0LmNvbmZpZy5vcHRpb25zID0gbmV3T3B0aW9uczsKICAgIGNoYXJ0LmVuc3VyZVNjYWxlc0hhdmVJRHMoKTsKICAgIGNoYXJ0LmJ1aWxkT3JVcGRhdGVTY2FsZXMoKTsgLy8gVG9vbHRpcAoKICAgIGNoYXJ0LnRvb2x0aXAuX29wdGlvbnMgPSBuZXdPcHRpb25zLnRvb2x0aXBzOwogICAgY2hhcnQudG9vbHRpcC5pbml0aWFsaXplKCk7CiAgfQoKICBmdW5jdGlvbiBuZXh0QXZhaWxhYmxlU2NhbGVJZChheGVzT3B0cywgcHJlZml4LCBpbmRleCkgewogICAgdmFyIGlkOwoKICAgIHZhciBoYXNJZCA9IGZ1bmN0aW9uIGhhc0lkKG9iaikgewogICAgICByZXR1cm4gb2JqLmlkID09PSBpZDsKICAgIH07CgogICAgZG8gewogICAgICBpZCA9IHByZWZpeCArIGluZGV4Kys7CiAgICB9IHdoaWxlIChoZWxwZXJzJDEuZmluZEluZGV4KGF4ZXNPcHRzLCBoYXNJZCkgPj0gMCk7CgogICAgcmV0dXJuIGlkOwogIH0KCiAgZnVuY3Rpb24gcG9zaXRpb25Jc0hvcml6b250YWwocG9zaXRpb24pIHsKICAgIHJldHVybiBwb3NpdGlvbiA9PT0gJ3RvcCcgfHwgcG9zaXRpb24gPT09ICdib3R0b20nOwogIH0KCiAgZnVuY3Rpb24gY29tcGFyZTJMZXZlbChsMSwgbDIpIHsKICAgIHJldHVybiBmdW5jdGlvbiAoYSwgYikgewogICAgICByZXR1cm4gYVtsMV0gPT09IGJbbDFdID8gYVtsMl0gLSBiW2wyXSA6IGFbbDFdIC0gYltsMV07CiAgICB9OwogIH0KCiAgdmFyIENoYXJ0ID0gZnVuY3Rpb24gQ2hhcnQoaXRlbSwgY29uZmlnKSB7CiAgICB0aGlzLmNvbnN0cnVjdChpdGVtLCBjb25maWcpOwogICAgcmV0dXJuIHRoaXM7CiAgfTsKCiAgaGVscGVycyQxLmV4dGVuZChDaGFydC5wcm90b3R5cGUsCiAgLyoqIEBsZW5kcyBDaGFydCAqLwogIHsKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBjb25zdHJ1Y3Q6IGZ1bmN0aW9uIGNvbnN0cnVjdChpdGVtLCBjb25maWcpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgY29uZmlnID0gaW5pdENvbmZpZyhjb25maWcpOwogICAgICB2YXIgY29udGV4dCA9IHBsYXRmb3JtLmFjcXVpcmVDb250ZXh0KGl0ZW0sIGNvbmZpZyk7CiAgICAgIHZhciBjYW52YXMgPSBjb250ZXh0ICYmIGNvbnRleHQuY2FudmFzOwogICAgICB2YXIgaGVpZ2h0ID0gY2FudmFzICYmIGNhbnZhcy5oZWlnaHQ7CiAgICAgIHZhciB3aWR0aCA9IGNhbnZhcyAmJiBjYW52YXMud2lkdGg7CiAgICAgIG1lLmlkID0gaGVscGVycyQxLnVpZCgpOwogICAgICBtZS5jdHggPSBjb250ZXh0OwogICAgICBtZS5jYW52YXMgPSBjYW52YXM7CiAgICAgIG1lLmNvbmZpZyA9IGNvbmZpZzsKICAgICAgbWUud2lkdGggPSB3aWR0aDsKICAgICAgbWUuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICBtZS5hc3BlY3RSYXRpbyA9IGhlaWdodCA/IHdpZHRoIC8gaGVpZ2h0IDogbnVsbDsKICAgICAgbWUub3B0aW9ucyA9IGNvbmZpZy5vcHRpb25zOwogICAgICBtZS5fYnVmZmVyZWRSZW5kZXIgPSBmYWxzZTsKICAgICAgbWUuX2xheWVycyA9IFtdOwogICAgICAvKioNCiAgICAgICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCBDaGFydCBhbmQgQ2hhcnQuQ29udHJvbGxlciBoYXZlIGJlZW4gbWVyZ2VkLA0KICAgICAgICogdGhlICJpbnN0YW5jZSIgc3RpbGwgbmVlZCB0byBiZSBkZWZpbmVkIHNpbmNlIGl0IG1pZ2h0IGJlIGNhbGxlZCBmcm9tIHBsdWdpbnMuDQogICAgICAgKiBAcHJvcCBDaGFydCNjaGFydA0KICAgICAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjYuMA0KICAgICAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgICAgICogQHByaXZhdGUNCiAgICAgICAqLwoKICAgICAgbWUuY2hhcnQgPSBtZTsKICAgICAgbWUuY29udHJvbGxlciA9IG1lOyAvLyBjaGFydC5jaGFydC5jb250cm9sbGVyICNpbmNlcHRpb24KICAgICAgLy8gQWRkIHRoZSBjaGFydCBpbnN0YW5jZSB0byB0aGUgZ2xvYmFsIG5hbWVzcGFjZQoKICAgICAgQ2hhcnQuaW5zdGFuY2VzW21lLmlkXSA9IG1lOyAvLyBEZWZpbmUgYWxpYXMgdG8gdGhlIGNvbmZpZyBkYXRhOiBgY2hhcnQuZGF0YSA9PT0gY2hhcnQuY29uZmlnLmRhdGFgCgogICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobWUsICdkYXRhJywgewogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgcmV0dXJuIG1lLmNvbmZpZy5kYXRhOwogICAgICAgIH0sCiAgICAgICAgc2V0OiBmdW5jdGlvbiBzZXQodmFsdWUpIHsKICAgICAgICAgIG1lLmNvbmZpZy5kYXRhID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGlmICghY29udGV4dCB8fCAhY2FudmFzKSB7CiAgICAgICAgLy8gVGhlIGdpdmVuIGl0ZW0gaXMgbm90IGEgY29tcGF0aWJsZSBjb250ZXh0MmQgZWxlbWVudCwgbGV0J3MgcmV0dXJuIGJlZm9yZSBmaW5hbGl6aW5nCiAgICAgICAgLy8gdGhlIGNoYXJ0IGluaXRpYWxpemF0aW9uIGJ1dCBhZnRlciBzZXR0aW5nIGJhc2ljIGNoYXJ0IC8gY29udHJvbGxlciBwcm9wZXJ0aWVzIHRoYXQKICAgICAgICAvLyBjYW4gaGVscCB0byBmaWd1cmUgb3V0IHRoYXQgdGhlIGNoYXJ0IGlzIG5vdCB2YWxpZCAoZS5nIGNoYXJ0LmNhbnZhcyAhPT0gbnVsbCk7CiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvaXNzdWVzLzI4MDcKICAgICAgICBjb25zb2xlLmVycm9yKCJGYWlsZWQgdG8gY3JlYXRlIGNoYXJ0OiBjYW4ndCBhY3F1aXJlIGNvbnRleHQgZnJvbSB0aGUgZ2l2ZW4gaXRlbSIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgbWUuaW5pdGlhbGl6ZSgpOwogICAgICBtZS51cGRhdGUoKTsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7IC8vIEJlZm9yZSBpbml0IHBsdWdpbiBub3RpZmljYXRpb24KCiAgICAgIGNvcmVfcGx1Z2lucy5ub3RpZnkobWUsICdiZWZvcmVJbml0Jyk7CiAgICAgIGhlbHBlcnMkMS5yZXRpbmFTY2FsZShtZSwgbWUub3B0aW9ucy5kZXZpY2VQaXhlbFJhdGlvKTsKICAgICAgbWUuYmluZEV2ZW50cygpOwoKICAgICAgaWYgKG1lLm9wdGlvbnMucmVzcG9uc2l2ZSkgewogICAgICAgIC8vIEluaXRpYWwgcmVzaXplIGJlZm9yZSBjaGFydCBkcmF3cyAobXVzdCBiZSBzaWxlbnQgdG8gcHJlc2VydmUgaW5pdGlhbCBhbmltYXRpb25zKS4KICAgICAgICBtZS5yZXNpemUodHJ1ZSk7CiAgICAgIH0KCiAgICAgIG1lLmluaXRUb29sVGlwKCk7IC8vIEFmdGVyIGluaXQgcGx1Z2luIG5vdGlmaWNhdGlvbgoKICAgICAgY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2FmdGVySW5pdCcpOwogICAgICByZXR1cm4gbWU7CiAgICB9LAogICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkgewogICAgICBoZWxwZXJzJDEuY2FudmFzLmNsZWFyKHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCiAgICBzdG9wOiBmdW5jdGlvbiBzdG9wKCkgewogICAgICAvLyBTdG9wcyBhbnkgY3VycmVudCBhbmltYXRpb24gbG9vcCBvY2N1cnJpbmcKICAgICAgY29yZV9hbmltYXRpb25zLmNhbmNlbEFuaW1hdGlvbih0aGlzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAogICAgcmVzaXplOiBmdW5jdGlvbiByZXNpemUoc2lsZW50KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBvcHRpb25zID0gbWUub3B0aW9uczsKICAgICAgdmFyIGNhbnZhcyA9IG1lLmNhbnZhczsKICAgICAgdmFyIGFzcGVjdFJhdGlvID0gb3B0aW9ucy5tYWludGFpbkFzcGVjdFJhdGlvICYmIG1lLmFzcGVjdFJhdGlvIHx8IG51bGw7IC8vIHRoZSBjYW52YXMgcmVuZGVyIHdpZHRoIGFuZCBoZWlnaHQgd2lsbCBiZSBjYXN0ZWQgdG8gaW50ZWdlcnMgc28gbWFrZSBzdXJlIHRoYXQKICAgICAgLy8gdGhlIGNhbnZhcyBkaXNwbGF5IHN0eWxlIHVzZXMgdGhlIHNhbWUgaW50ZWdlciB2YWx1ZXMgdG8gYXZvaWQgYmx1cnJpbmcgZWZmZWN0LgogICAgICAvLyBTZXQgdG8gMCBpbnN0ZWFkIG9mIGNhbnZhcy5zaXplIGJlY2F1c2UgdGhlIHNpemUgZGVmYXVsdHMgdG8gMzAweDE1MCBpZiB0aGUgZWxlbWVudCBpcyBjb2xsYXBzZWQKCiAgICAgIHZhciBuZXdXaWR0aCA9IE1hdGgubWF4KDAsIE1hdGguZmxvb3IoaGVscGVycyQxLmdldE1heGltdW1XaWR0aChjYW52YXMpKSk7CiAgICAgIHZhciBuZXdIZWlnaHQgPSBNYXRoLm1heCgwLCBNYXRoLmZsb29yKGFzcGVjdFJhdGlvID8gbmV3V2lkdGggLyBhc3BlY3RSYXRpbyA6IGhlbHBlcnMkMS5nZXRNYXhpbXVtSGVpZ2h0KGNhbnZhcykpKTsKCiAgICAgIGlmIChtZS53aWR0aCA9PT0gbmV3V2lkdGggJiYgbWUuaGVpZ2h0ID09PSBuZXdIZWlnaHQpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGNhbnZhcy53aWR0aCA9IG1lLndpZHRoID0gbmV3V2lkdGg7CiAgICAgIGNhbnZhcy5oZWlnaHQgPSBtZS5oZWlnaHQgPSBuZXdIZWlnaHQ7CiAgICAgIGNhbnZhcy5zdHlsZS53aWR0aCA9IG5ld1dpZHRoICsgJ3B4JzsKICAgICAgY2FudmFzLnN0eWxlLmhlaWdodCA9IG5ld0hlaWdodCArICdweCc7CiAgICAgIGhlbHBlcnMkMS5yZXRpbmFTY2FsZShtZSwgb3B0aW9ucy5kZXZpY2VQaXhlbFJhdGlvKTsKCiAgICAgIGlmICghc2lsZW50KSB7CiAgICAgICAgLy8gTm90aWZ5IGFueSBwbHVnaW5zIGFib3V0IHRoZSByZXNpemUKICAgICAgICB2YXIgbmV3U2l6ZSA9IHsKICAgICAgICAgIHdpZHRoOiBuZXdXaWR0aCwKICAgICAgICAgIGhlaWdodDogbmV3SGVpZ2h0CiAgICAgICAgfTsKICAgICAgICBjb3JlX3BsdWdpbnMubm90aWZ5KG1lLCAncmVzaXplJywgW25ld1NpemVdKTsgLy8gTm90aWZ5IG9mIHJlc2l6ZQoKICAgICAgICBpZiAob3B0aW9ucy5vblJlc2l6ZSkgewogICAgICAgICAgb3B0aW9ucy5vblJlc2l6ZShtZSwgbmV3U2l6ZSk7CiAgICAgICAgfQoKICAgICAgICBtZS5zdG9wKCk7CiAgICAgICAgbWUudXBkYXRlKHsKICAgICAgICAgIGR1cmF0aW9uOiBvcHRpb25zLnJlc3BvbnNpdmVBbmltYXRpb25EdXJhdGlvbgogICAgICAgIH0pOwogICAgICB9CiAgICB9LAogICAgZW5zdXJlU2NhbGVzSGF2ZUlEczogZnVuY3Rpb24gZW5zdXJlU2NhbGVzSGF2ZUlEcygpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgIHZhciBzY2FsZXNPcHRpb25zID0gb3B0aW9ucy5zY2FsZXMgfHwge307CiAgICAgIHZhciBzY2FsZU9wdGlvbnMgPSBvcHRpb25zLnNjYWxlOwogICAgICBoZWxwZXJzJDEuZWFjaChzY2FsZXNPcHRpb25zLnhBeGVzLCBmdW5jdGlvbiAoeEF4aXNPcHRpb25zLCBpbmRleCkgewogICAgICAgIGlmICgheEF4aXNPcHRpb25zLmlkKSB7CiAgICAgICAgICB4QXhpc09wdGlvbnMuaWQgPSBuZXh0QXZhaWxhYmxlU2NhbGVJZChzY2FsZXNPcHRpb25zLnhBeGVzLCAneC1heGlzLScsIGluZGV4KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBoZWxwZXJzJDEuZWFjaChzY2FsZXNPcHRpb25zLnlBeGVzLCBmdW5jdGlvbiAoeUF4aXNPcHRpb25zLCBpbmRleCkgewogICAgICAgIGlmICgheUF4aXNPcHRpb25zLmlkKSB7CiAgICAgICAgICB5QXhpc09wdGlvbnMuaWQgPSBuZXh0QXZhaWxhYmxlU2NhbGVJZChzY2FsZXNPcHRpb25zLnlBeGVzLCAneS1heGlzLScsIGluZGV4KTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgaWYgKHNjYWxlT3B0aW9ucykgewogICAgICAgIHNjYWxlT3B0aW9ucy5pZCA9IHNjYWxlT3B0aW9ucy5pZCB8fCAnc2NhbGUnOwogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEJ1aWxkcyBhIG1hcCBvZiBzY2FsZSBJRCB0byBzY2FsZSBvYmplY3QgZm9yIGZ1dHVyZSBsb29rdXAuDQogICAgICovCiAgICBidWlsZE9yVXBkYXRlU2NhbGVzOiBmdW5jdGlvbiBidWlsZE9yVXBkYXRlU2NhbGVzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgb3B0aW9ucyA9IG1lLm9wdGlvbnM7CiAgICAgIHZhciBzY2FsZXMgPSBtZS5zY2FsZXMgfHwge307CiAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICB2YXIgdXBkYXRlZCA9IE9iamVjdC5rZXlzKHNjYWxlcykucmVkdWNlKGZ1bmN0aW9uIChvYmosIGlkKSB7CiAgICAgICAgb2JqW2lkXSA9IGZhbHNlOwogICAgICAgIHJldHVybiBvYmo7CiAgICAgIH0sIHt9KTsKCiAgICAgIGlmIChvcHRpb25zLnNjYWxlcykgewogICAgICAgIGl0ZW1zID0gaXRlbXMuY29uY2F0KChvcHRpb25zLnNjYWxlcy54QXhlcyB8fCBbXSkubWFwKGZ1bmN0aW9uICh4QXhpc09wdGlvbnMpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG9wdGlvbnM6IHhBeGlzT3B0aW9ucywKICAgICAgICAgICAgZHR5cGU6ICdjYXRlZ29yeScsCiAgICAgICAgICAgIGRwb3NpdGlvbjogJ2JvdHRvbScKICAgICAgICAgIH07CiAgICAgICAgfSksIChvcHRpb25zLnNjYWxlcy55QXhlcyB8fCBbXSkubWFwKGZ1bmN0aW9uICh5QXhpc09wdGlvbnMpIHsKICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIG9wdGlvbnM6IHlBeGlzT3B0aW9ucywKICAgICAgICAgICAgZHR5cGU6ICdsaW5lYXInLAogICAgICAgICAgICBkcG9zaXRpb246ICdsZWZ0JwogICAgICAgICAgfTsKICAgICAgICB9KSk7CiAgICAgIH0KCiAgICAgIGlmIChvcHRpb25zLnNjYWxlKSB7CiAgICAgICAgaXRlbXMucHVzaCh7CiAgICAgICAgICBvcHRpb25zOiBvcHRpb25zLnNjYWxlLAogICAgICAgICAgZHR5cGU6ICdyYWRpYWxMaW5lYXInLAogICAgICAgICAgaXNEZWZhdWx0OiB0cnVlLAogICAgICAgICAgZHBvc2l0aW9uOiAnY2hhcnRBcmVhJwogICAgICAgIH0pOwogICAgICB9CgogICAgICBoZWxwZXJzJDEuZWFjaChpdGVtcywgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICB2YXIgc2NhbGVPcHRpb25zID0gaXRlbS5vcHRpb25zOwogICAgICAgIHZhciBpZCA9IHNjYWxlT3B0aW9ucy5pZDsKICAgICAgICB2YXIgc2NhbGVUeXBlID0gdmFsdWVPckRlZmF1bHQkOShzY2FsZU9wdGlvbnMudHlwZSwgaXRlbS5kdHlwZSk7CgogICAgICAgIGlmIChwb3NpdGlvbklzSG9yaXpvbnRhbChzY2FsZU9wdGlvbnMucG9zaXRpb24pICE9PSBwb3NpdGlvbklzSG9yaXpvbnRhbChpdGVtLmRwb3NpdGlvbikpIHsKICAgICAgICAgIHNjYWxlT3B0aW9ucy5wb3NpdGlvbiA9IGl0ZW0uZHBvc2l0aW9uOwogICAgICAgIH0KCiAgICAgICAgdXBkYXRlZFtpZF0gPSB0cnVlOwogICAgICAgIHZhciBzY2FsZSA9IG51bGw7CgogICAgICAgIGlmIChpZCBpbiBzY2FsZXMgJiYgc2NhbGVzW2lkXS50eXBlID09PSBzY2FsZVR5cGUpIHsKICAgICAgICAgIHNjYWxlID0gc2NhbGVzW2lkXTsKICAgICAgICAgIHNjYWxlLm9wdGlvbnMgPSBzY2FsZU9wdGlvbnM7CiAgICAgICAgICBzY2FsZS5jdHggPSBtZS5jdHg7CiAgICAgICAgICBzY2FsZS5jaGFydCA9IG1lOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB2YXIgc2NhbGVDbGFzcyA9IGNvcmVfc2NhbGVTZXJ2aWNlLmdldFNjYWxlQ29uc3RydWN0b3Ioc2NhbGVUeXBlKTsKCiAgICAgICAgICBpZiAoIXNjYWxlQ2xhc3MpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQoKICAgICAgICAgIHNjYWxlID0gbmV3IHNjYWxlQ2xhc3MoewogICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgIHR5cGU6IHNjYWxlVHlwZSwKICAgICAgICAgICAgb3B0aW9uczogc2NhbGVPcHRpb25zLAogICAgICAgICAgICBjdHg6IG1lLmN0eCwKICAgICAgICAgICAgY2hhcnQ6IG1lCiAgICAgICAgICB9KTsKICAgICAgICAgIHNjYWxlc1tzY2FsZS5pZF0gPSBzY2FsZTsKICAgICAgICB9CgogICAgICAgIHNjYWxlLm1lcmdlVGlja3NPcHRpb25zKCk7IC8vIFRPRE8oU0IpOiBJIHRoaW5rIHdlIHNob3VsZCBiZSBhYmxlIHRvIHJlbW92ZSB0aGlzIGN1c3RvbSBjYXNlIChvcHRpb25zLnNjYWxlKQogICAgICAgIC8vIGFuZCBjb25zaWRlciBpdCBhcyBhIHJlZ3VsYXIgc2NhbGUgcGFydCBvZiB0aGUgInNjYWxlcyIiIG1hcCBvbmx5ISBUaGlzIHdvdWxkCiAgICAgICAgLy8gbWFrZSB0aGUgbG9naWMgZWFzaWVyIGFuZCByZW1vdmUgc29tZSB1c2VsZXNzPyBjdXN0b20gY29kZS4KCiAgICAgICAgaWYgKGl0ZW0uaXNEZWZhdWx0KSB7CiAgICAgICAgICBtZS5zY2FsZSA9IHNjYWxlOwogICAgICAgIH0KICAgICAgfSk7IC8vIGNsZWFyIHVwIGRpc2NhcmRlZCBzY2FsZXMKCiAgICAgIGhlbHBlcnMkMS5lYWNoKHVwZGF0ZWQsIGZ1bmN0aW9uIChoYXNVcGRhdGVkLCBpZCkgewogICAgICAgIGlmICghaGFzVXBkYXRlZCkgewogICAgICAgICAgZGVsZXRlIHNjYWxlc1tpZF07CiAgICAgICAgfQogICAgICB9KTsKICAgICAgbWUuc2NhbGVzID0gc2NhbGVzOwogICAgICBjb3JlX3NjYWxlU2VydmljZS5hZGRTY2FsZXNUb0xheW91dCh0aGlzKTsKICAgIH0sCiAgICBidWlsZE9yVXBkYXRlQ29udHJvbGxlcnM6IGZ1bmN0aW9uIGJ1aWxkT3JVcGRhdGVDb250cm9sbGVycygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG5ld0NvbnRyb2xsZXJzID0gW107CiAgICAgIHZhciBkYXRhc2V0cyA9IG1lLmRhdGEuZGF0YXNldHM7CiAgICAgIHZhciBpLCBpbGVuOwoKICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGRhdGFzZXRzLmxlbmd0aDsgaSA8IGlsZW47IGkrKykgewogICAgICAgIHZhciBkYXRhc2V0ID0gZGF0YXNldHNbaV07CiAgICAgICAgdmFyIG1ldGEgPSBtZS5nZXREYXRhc2V0TWV0YShpKTsKICAgICAgICB2YXIgdHlwZSA9IGRhdGFzZXQudHlwZSB8fCBtZS5jb25maWcudHlwZTsKCiAgICAgICAgaWYgKG1ldGEudHlwZSAmJiBtZXRhLnR5cGUgIT09IHR5cGUpIHsKICAgICAgICAgIG1lLmRlc3Ryb3lEYXRhc2V0TWV0YShpKTsKICAgICAgICAgIG1ldGEgPSBtZS5nZXREYXRhc2V0TWV0YShpKTsKICAgICAgICB9CgogICAgICAgIG1ldGEudHlwZSA9IHR5cGU7CiAgICAgICAgbWV0YS5vcmRlciA9IGRhdGFzZXQub3JkZXIgfHwgMDsKICAgICAgICBtZXRhLmluZGV4ID0gaTsKCiAgICAgICAgaWYgKG1ldGEuY29udHJvbGxlcikgewogICAgICAgICAgbWV0YS5jb250cm9sbGVyLnVwZGF0ZUluZGV4KGkpOwogICAgICAgICAgbWV0YS5jb250cm9sbGVyLmxpbmtTY2FsZXMoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIENvbnRyb2xsZXJDbGFzcyA9IGNvbnRyb2xsZXJzW21ldGEudHlwZV07CgogICAgICAgICAgaWYgKENvbnRyb2xsZXJDbGFzcyA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignIicgKyBtZXRhLnR5cGUgKyAnIiBpcyBub3QgYSBjaGFydCB0eXBlLicpOwogICAgICAgICAgfQoKICAgICAgICAgIG1ldGEuY29udHJvbGxlciA9IG5ldyBDb250cm9sbGVyQ2xhc3MobWUsIGkpOwogICAgICAgICAgbmV3Q29udHJvbGxlcnMucHVzaChtZXRhLmNvbnRyb2xsZXIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG5ld0NvbnRyb2xsZXJzOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBSZXNldCB0aGUgZWxlbWVudHMgb2YgYWxsIGRhdGFzZXRzDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIHJlc2V0RWxlbWVudHM6IGZ1bmN0aW9uIHJlc2V0RWxlbWVudHMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIGhlbHBlcnMkMS5lYWNoKG1lLmRhdGEuZGF0YXNldHMsIGZ1bmN0aW9uIChkYXRhc2V0LCBkYXRhc2V0SW5kZXgpIHsKICAgICAgICBtZS5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpLmNvbnRyb2xsZXIucmVzZXQoKTsKICAgICAgfSwgbWUpOwogICAgfSwKCiAgICAvKioNCiAgICAqIFJlc2V0cyB0aGUgY2hhcnQgYmFjayB0byBpdCdzIHN0YXRlIGJlZm9yZSB0aGUgaW5pdGlhbCBhbmltYXRpb24NCiAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KCkgewogICAgICB0aGlzLnJlc2V0RWxlbWVudHMoKTsKICAgICAgdGhpcy50b29sdGlwLmluaXRpYWxpemUoKTsKICAgIH0sCiAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZShjb25maWcpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGksIGlsZW47CgogICAgICBpZiAoIWNvbmZpZyB8fCBfdHlwZW9mKGNvbmZpZykgIT09ICdvYmplY3QnKSB7CiAgICAgICAgLy8gYmFja3dhcmRzIGNvbXBhdGliaWxpdHkKICAgICAgICBjb25maWcgPSB7CiAgICAgICAgICBkdXJhdGlvbjogY29uZmlnLAogICAgICAgICAgbGF6eTogYXJndW1lbnRzWzFdCiAgICAgICAgfTsKICAgICAgfQoKICAgICAgdXBkYXRlQ29uZmlnKG1lKTsgLy8gcGx1Z2lucyBvcHRpb25zIHJlZmVyZW5jZXMgbWlnaHQgaGF2ZSBjaGFuZ2UsIGxldCdzIGludmFsaWRhdGUgdGhlIGNhY2hlCiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL2lzc3Vlcy81MTExI2lzc3VlY29tbWVudC0zNTU5MzQxNjcKCiAgICAgIGNvcmVfcGx1Z2lucy5faW52YWxpZGF0ZShtZSk7CgogICAgICBpZiAoY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2JlZm9yZVVwZGF0ZScpID09PSBmYWxzZSkgewogICAgICAgIHJldHVybjsKICAgICAgfSAvLyBJbiBjYXNlIHRoZSBlbnRpcmUgZGF0YSBvYmplY3QgY2hhbmdlZAoKCiAgICAgIG1lLnRvb2x0aXAuX2RhdGEgPSBtZS5kYXRhOyAvLyBNYWtlIHN1cmUgZGF0YXNldCBjb250cm9sbGVycyBhcmUgdXBkYXRlZCBhbmQgbmV3IGNvbnRyb2xsZXJzIGFyZSByZXNldAoKICAgICAgdmFyIG5ld0NvbnRyb2xsZXJzID0gbWUuYnVpbGRPclVwZGF0ZUNvbnRyb2xsZXJzKCk7IC8vIE1ha2Ugc3VyZSBhbGwgZGF0YXNldCBjb250cm9sbGVycyBoYXZlIGNvcnJlY3QgbWV0YSBkYXRhIGNvdW50cwoKICAgICAgZm9yIChpID0gMCwgaWxlbiA9IG1lLmRhdGEuZGF0YXNldHMubGVuZ3RoOyBpIDwgaWxlbjsgaSsrKSB7CiAgICAgICAgbWUuZ2V0RGF0YXNldE1ldGEoaSkuY29udHJvbGxlci5idWlsZE9yVXBkYXRlRWxlbWVudHMoKTsKICAgICAgfQoKICAgICAgbWUudXBkYXRlTGF5b3V0KCk7IC8vIENhbiBvbmx5IHJlc2V0IHRoZSBuZXcgY29udHJvbGxlcnMgYWZ0ZXIgdGhlIHNjYWxlcyBoYXZlIGJlZW4gdXBkYXRlZAoKICAgICAgaWYgKG1lLm9wdGlvbnMuYW5pbWF0aW9uICYmIG1lLm9wdGlvbnMuYW5pbWF0aW9uLmR1cmF0aW9uKSB7CiAgICAgICAgaGVscGVycyQxLmVhY2gobmV3Q29udHJvbGxlcnMsIGZ1bmN0aW9uIChjb250cm9sbGVyKSB7CiAgICAgICAgICBjb250cm9sbGVyLnJlc2V0KCk7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIG1lLnVwZGF0ZURhdGFzZXRzKCk7IC8vIE5lZWQgdG8gcmVzZXQgdG9vbHRpcCBpbiBjYXNlIGl0IGlzIGRpc3BsYXllZCB3aXRoIGVsZW1lbnRzIHRoYXQgYXJlIHJlbW92ZWQKICAgICAgLy8gYWZ0ZXIgdXBkYXRlLgoKICAgICAgbWUudG9vbHRpcC5pbml0aWFsaXplKCk7IC8vIExhc3QgYWN0aXZlIGNvbnRhaW5zIGl0ZW1zIHRoYXQgd2VyZSBwcmV2aW91c2x5IGluIHRoZSB0b29sdGlwLgogICAgICAvLyBXaGVuIHdlIHJlc2V0IHRoZSB0b29sdGlwLCB3ZSBuZWVkIHRvIGNsZWFyIGl0CgogICAgICBtZS5sYXN0QWN0aXZlID0gW107IC8vIERvIHRoaXMgYmVmb3JlIHJlbmRlciBzbyB0aGF0IGFueSBwbHVnaW5zIHRoYXQgbmVlZCBmaW5hbCBzY2FsZSB1cGRhdGVzIGNhbiB1c2UgaXQKCiAgICAgIGNvcmVfcGx1Z2lucy5ub3RpZnkobWUsICdhZnRlclVwZGF0ZScpOwoKICAgICAgbWUuX2xheWVycy5zb3J0KGNvbXBhcmUyTGV2ZWwoJ3onLCAnX2lkeCcpKTsKCiAgICAgIGlmIChtZS5fYnVmZmVyZWRSZW5kZXIpIHsKICAgICAgICBtZS5fYnVmZmVyZWRSZXF1ZXN0ID0gewogICAgICAgICAgZHVyYXRpb246IGNvbmZpZy5kdXJhdGlvbiwKICAgICAgICAgIGVhc2luZzogY29uZmlnLmVhc2luZywKICAgICAgICAgIGxhenk6IGNvbmZpZy5sYXp5CiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZS5yZW5kZXIoY29uZmlnKTsKICAgICAgfQogICAgfSwKCiAgICAvKioNCiAgICAgKiBVcGRhdGVzIHRoZSBjaGFydCBsYXlvdXQgdW5sZXNzIGEgcGx1Z2luIHJldHVybnMgYGZhbHNlYCB0byB0aGUgYGJlZm9yZUxheW91dGANCiAgICAgKiBob29rLCBpbiB3aGljaCBjYXNlLCBwbHVnaW5zIHdpbGwgbm90IGJlIGNhbGxlZCBvbiBgYWZ0ZXJMYXlvdXRgLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICB1cGRhdGVMYXlvdXQ6IGZ1bmN0aW9uIHVwZGF0ZUxheW91dCgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKCiAgICAgIGlmIChjb3JlX3BsdWdpbnMubm90aWZ5KG1lLCAnYmVmb3JlTGF5b3V0JykgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb3JlX2xheW91dHMudXBkYXRlKHRoaXMsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKICAgICAgbWUuX2xheWVycyA9IFtdOwogICAgICBoZWxwZXJzJDEuZWFjaChtZS5ib3hlcywgZnVuY3Rpb24gKGJveCkgewogICAgICAgIC8vIF9jb25maWd1cmUgaXMgY2FsbGVkIHR3aWNlLCBvbmNlIGluIGNvcmUuc2NhbGUudXBkYXRlIGFuZCBvbmNlIGhlcmUuCiAgICAgICAgLy8gSGVyZSB0aGUgYm94ZXMgYXJlIGZ1bGx5IHVwZGF0ZWQgYW5kIGF0IHRoZWlyIGZpbmFsIHBvc2l0aW9ucy4KICAgICAgICBpZiAoYm94Ll9jb25maWd1cmUpIHsKICAgICAgICAgIGJveC5fY29uZmlndXJlKCk7CiAgICAgICAgfQoKICAgICAgICBtZS5fbGF5ZXJzLnB1c2guYXBwbHkobWUuX2xheWVycywgYm94Ll9sYXllcnMoKSk7CiAgICAgIH0sIG1lKTsKCiAgICAgIG1lLl9sYXllcnMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSwgaW5kZXgpIHsKICAgICAgICBpdGVtLl9pZHggPSBpbmRleDsKICAgICAgfSk7CiAgICAgIC8qKg0KICAgICAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIHVzZSBgYWZ0ZXJMYXlvdXRgIGluc3RlYWQuDQogICAgICAgKiBAbWV0aG9kIElQbHVnaW4jYWZ0ZXJTY2FsZVVwZGF0ZQ0KICAgICAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjUuMA0KICAgICAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgICAgICogQHByaXZhdGUNCiAgICAgICAqLwoKCiAgICAgIGNvcmVfcGx1Z2lucy5ub3RpZnkobWUsICdhZnRlclNjYWxlVXBkYXRlJyk7CiAgICAgIGNvcmVfcGx1Z2lucy5ub3RpZnkobWUsICdhZnRlckxheW91dCcpOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBVcGRhdGVzIGFsbCBkYXRhc2V0cyB1bmxlc3MgYSBwbHVnaW4gcmV0dXJucyBgZmFsc2VgIHRvIHRoZSBgYmVmb3JlRGF0YXNldHNVcGRhdGVgDQogICAgICogaG9vaywgaW4gd2hpY2ggY2FzZSwgcGx1Z2lucyB3aWxsIG5vdCBiZSBjYWxsZWQgb24gYGFmdGVyRGF0YXNldHNVcGRhdGVgLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICB1cGRhdGVEYXRhc2V0czogZnVuY3Rpb24gdXBkYXRlRGF0YXNldHMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CgogICAgICBpZiAoY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2JlZm9yZURhdGFzZXRzVXBkYXRlJykgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBmb3IgKHZhciBpID0gMCwgaWxlbiA9IG1lLmRhdGEuZGF0YXNldHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgbWUudXBkYXRlRGF0YXNldChpKTsKICAgICAgfQoKICAgICAgY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2FmdGVyRGF0YXNldHNVcGRhdGUnKTsKICAgIH0sCgogICAgLyoqDQogICAgICogVXBkYXRlcyBkYXRhc2V0IGF0IGluZGV4IHVubGVzcyBhIHBsdWdpbiByZXR1cm5zIGBmYWxzZWAgdG8gdGhlIGBiZWZvcmVEYXRhc2V0VXBkYXRlYA0KICAgICAqIGhvb2ssIGluIHdoaWNoIGNhc2UsIHBsdWdpbnMgd2lsbCBub3QgYmUgY2FsbGVkIG9uIGBhZnRlckRhdGFzZXRVcGRhdGVgLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICB1cGRhdGVEYXRhc2V0OiBmdW5jdGlvbiB1cGRhdGVEYXRhc2V0KGluZGV4KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBtZXRhID0gbWUuZ2V0RGF0YXNldE1ldGEoaW5kZXgpOwogICAgICB2YXIgYXJncyA9IHsKICAgICAgICBtZXRhOiBtZXRhLAogICAgICAgIGluZGV4OiBpbmRleAogICAgICB9OwoKICAgICAgaWYgKGNvcmVfcGx1Z2lucy5ub3RpZnkobWUsICdiZWZvcmVEYXRhc2V0VXBkYXRlJywgW2FyZ3NdKSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIG1ldGEuY29udHJvbGxlci5fdXBkYXRlKCk7CgogICAgICBjb3JlX3BsdWdpbnMubm90aWZ5KG1lLCAnYWZ0ZXJEYXRhc2V0VXBkYXRlJywgW2FyZ3NdKTsKICAgIH0sCiAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcihjb25maWcpIHsKICAgICAgdmFyIG1lID0gdGhpczsKCiAgICAgIGlmICghY29uZmlnIHx8IF90eXBlb2YoY29uZmlnKSAhPT0gJ29iamVjdCcpIHsKICAgICAgICAvLyBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgICAgIGNvbmZpZyA9IHsKICAgICAgICAgIGR1cmF0aW9uOiBjb25maWcsCiAgICAgICAgICBsYXp5OiBhcmd1bWVudHNbMV0KICAgICAgICB9OwogICAgICB9CgogICAgICB2YXIgYW5pbWF0aW9uT3B0aW9ucyA9IG1lLm9wdGlvbnMuYW5pbWF0aW9uOwogICAgICB2YXIgZHVyYXRpb24gPSB2YWx1ZU9yRGVmYXVsdCQ5KGNvbmZpZy5kdXJhdGlvbiwgYW5pbWF0aW9uT3B0aW9ucyAmJiBhbmltYXRpb25PcHRpb25zLmR1cmF0aW9uKTsKICAgICAgdmFyIGxhenkgPSBjb25maWcubGF6eTsKCiAgICAgIGlmIChjb3JlX3BsdWdpbnMubm90aWZ5KG1lLCAnYmVmb3JlUmVuZGVyJykgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgb25Db21wbGV0ZSA9IGZ1bmN0aW9uIG9uQ29tcGxldGUoYW5pbWF0aW9uKSB7CiAgICAgICAgY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2FmdGVyUmVuZGVyJyk7CiAgICAgICAgaGVscGVycyQxLmNhbGxiYWNrKGFuaW1hdGlvbk9wdGlvbnMgJiYgYW5pbWF0aW9uT3B0aW9ucy5vbkNvbXBsZXRlLCBbYW5pbWF0aW9uXSwgbWUpOwogICAgICB9OwoKICAgICAgaWYgKGFuaW1hdGlvbk9wdGlvbnMgJiYgZHVyYXRpb24pIHsKICAgICAgICB2YXIgYW5pbWF0aW9uID0gbmV3IGNvcmVfYW5pbWF0aW9uKHsKICAgICAgICAgIG51bVN0ZXBzOiBkdXJhdGlvbiAvIDE2LjY2LAogICAgICAgICAgLy8gNjAgZnBzCiAgICAgICAgICBlYXNpbmc6IGNvbmZpZy5lYXNpbmcgfHwgYW5pbWF0aW9uT3B0aW9ucy5lYXNpbmcsCiAgICAgICAgICByZW5kZXI6IGZ1bmN0aW9uIHJlbmRlcihjaGFydCwgYW5pbWF0aW9uT2JqZWN0KSB7CiAgICAgICAgICAgIHZhciBlYXNpbmdGdW5jdGlvbiA9IGhlbHBlcnMkMS5lYXNpbmcuZWZmZWN0c1thbmltYXRpb25PYmplY3QuZWFzaW5nXTsKICAgICAgICAgICAgdmFyIGN1cnJlbnRTdGVwID0gYW5pbWF0aW9uT2JqZWN0LmN1cnJlbnRTdGVwOwogICAgICAgICAgICB2YXIgc3RlcERlY2ltYWwgPSBjdXJyZW50U3RlcCAvIGFuaW1hdGlvbk9iamVjdC5udW1TdGVwczsKICAgICAgICAgICAgY2hhcnQuZHJhdyhlYXNpbmdGdW5jdGlvbihzdGVwRGVjaW1hbCksIHN0ZXBEZWNpbWFsLCBjdXJyZW50U3RlcCk7CiAgICAgICAgICB9LAogICAgICAgICAgb25BbmltYXRpb25Qcm9ncmVzczogYW5pbWF0aW9uT3B0aW9ucy5vblByb2dyZXNzLAogICAgICAgICAgb25BbmltYXRpb25Db21wbGV0ZTogb25Db21wbGV0ZQogICAgICAgIH0pOwogICAgICAgIGNvcmVfYW5pbWF0aW9ucy5hZGRBbmltYXRpb24obWUsIGFuaW1hdGlvbiwgZHVyYXRpb24sIGxhenkpOwogICAgICB9IGVsc2UgewogICAgICAgIG1lLmRyYXcoKTsgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL2lzc3Vlcy8zNzgxCgogICAgICAgIG9uQ29tcGxldGUobmV3IGNvcmVfYW5pbWF0aW9uKHsKICAgICAgICAgIG51bVN0ZXBzOiAwLAogICAgICAgICAgY2hhcnQ6IG1lCiAgICAgICAgfSkpOwogICAgICB9CgogICAgICByZXR1cm4gbWU7CiAgICB9LAogICAgZHJhdzogZnVuY3Rpb24gZHJhdyhlYXNpbmdWYWx1ZSkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgaSwgbGF5ZXJzOwogICAgICBtZS5jbGVhcigpOwoKICAgICAgaWYgKGhlbHBlcnMkMS5pc051bGxPclVuZGVmKGVhc2luZ1ZhbHVlKSkgewogICAgICAgIGVhc2luZ1ZhbHVlID0gMTsKICAgICAgfQoKICAgICAgbWUudHJhbnNpdGlvbihlYXNpbmdWYWx1ZSk7CgogICAgICBpZiAobWUud2lkdGggPD0gMCB8fCBtZS5oZWlnaHQgPD0gMCkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgaWYgKGNvcmVfcGx1Z2lucy5ub3RpZnkobWUsICdiZWZvcmVEcmF3JywgW2Vhc2luZ1ZhbHVlXSkgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIEJlY2F1c2Ugb2YgcGx1Z2luIGhvb2tzIChiZWZvcmUvYWZ0ZXJEYXRhc2V0c0RyYXcpLCBkYXRhc2V0cyBjYW4ndAogICAgICAvLyBjdXJyZW50bHkgYmUgcGFydCBvZiBsYXllcnMuIEluc3RlYWQsIHdlIGRyYXcKICAgICAgLy8gbGF5ZXJzIDw9IDAgYmVmb3JlKGRlZmF1bHQsIGJhY2t3YXJkIGNvbXBhdCksIGFuZCB0aGUgcmVzdCBhZnRlcgoKCiAgICAgIGxheWVycyA9IG1lLl9sYXllcnM7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgbGF5ZXJzLmxlbmd0aCAmJiBsYXllcnNbaV0ueiA8PSAwOyArK2kpIHsKICAgICAgICBsYXllcnNbaV0uZHJhdyhtZS5jaGFydEFyZWEpOwogICAgICB9CgogICAgICBtZS5kcmF3RGF0YXNldHMoZWFzaW5nVmFsdWUpOyAvLyBSZXN0IG9mIGxheWVycwoKICAgICAgZm9yICg7IGkgPCBsYXllcnMubGVuZ3RoOyArK2kpIHsKICAgICAgICBsYXllcnNbaV0uZHJhdyhtZS5jaGFydEFyZWEpOwogICAgICB9CgogICAgICBtZS5fZHJhd1Rvb2x0aXAoZWFzaW5nVmFsdWUpOwoKICAgICAgY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2FmdGVyRHJhdycsIFtlYXNpbmdWYWx1ZV0pOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgdHJhbnNpdGlvbjogZnVuY3Rpb24gdHJhbnNpdGlvbihlYXNpbmdWYWx1ZSkgewogICAgICB2YXIgbWUgPSB0aGlzOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSAobWUuZGF0YS5kYXRhc2V0cyB8fCBbXSkubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgaWYgKG1lLmlzRGF0YXNldFZpc2libGUoaSkpIHsKICAgICAgICAgIG1lLmdldERhdGFzZXRNZXRhKGkpLmNvbnRyb2xsZXIudHJhbnNpdGlvbihlYXNpbmdWYWx1ZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBtZS50b29sdGlwLnRyYW5zaXRpb24oZWFzaW5nVmFsdWUpOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2dldFNvcnRlZERhdGFzZXRNZXRhczogZnVuY3Rpb24gX2dldFNvcnRlZERhdGFzZXRNZXRhcyhmaWx0ZXJWaXNpYmxlKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBkYXRhc2V0cyA9IG1lLmRhdGEuZGF0YXNldHMgfHwgW107CiAgICAgIHZhciByZXN1bHQgPSBbXTsKICAgICAgdmFyIGksIGlsZW47CgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gZGF0YXNldHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgaWYgKCFmaWx0ZXJWaXNpYmxlIHx8IG1lLmlzRGF0YXNldFZpc2libGUoaSkpIHsKICAgICAgICAgIHJlc3VsdC5wdXNoKG1lLmdldERhdGFzZXRNZXRhKGkpKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJlc3VsdC5zb3J0KGNvbXBhcmUyTGV2ZWwoJ29yZGVyJywgJ2luZGV4JykpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2dldFNvcnRlZFZpc2libGVEYXRhc2V0TWV0YXM6IGZ1bmN0aW9uIF9nZXRTb3J0ZWRWaXNpYmxlRGF0YXNldE1ldGFzKCkgewogICAgICByZXR1cm4gdGhpcy5fZ2V0U29ydGVkRGF0YXNldE1ldGFzKHRydWUpOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBEcmF3cyBhbGwgZGF0YXNldHMgdW5sZXNzIGEgcGx1Z2luIHJldHVybnMgYGZhbHNlYCB0byB0aGUgYGJlZm9yZURhdGFzZXRzRHJhd2ANCiAgICAgKiBob29rLCBpbiB3aGljaCBjYXNlLCBwbHVnaW5zIHdpbGwgbm90IGJlIGNhbGxlZCBvbiBgYWZ0ZXJEYXRhc2V0c0RyYXdgLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBkcmF3RGF0YXNldHM6IGZ1bmN0aW9uIGRyYXdEYXRhc2V0cyhlYXNpbmdWYWx1ZSkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgbWV0YXNldHMsIGk7CgogICAgICBpZiAoY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2JlZm9yZURhdGFzZXRzRHJhdycsIFtlYXNpbmdWYWx1ZV0pID09PSBmYWxzZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgbWV0YXNldHMgPSBtZS5fZ2V0U29ydGVkVmlzaWJsZURhdGFzZXRNZXRhcygpOwoKICAgICAgZm9yIChpID0gbWV0YXNldHMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICBtZS5kcmF3RGF0YXNldChtZXRhc2V0c1tpXSwgZWFzaW5nVmFsdWUpOwogICAgICB9CgogICAgICBjb3JlX3BsdWdpbnMubm90aWZ5KG1lLCAnYWZ0ZXJEYXRhc2V0c0RyYXcnLCBbZWFzaW5nVmFsdWVdKTsKICAgIH0sCgogICAgLyoqDQogICAgICogRHJhd3MgZGF0YXNldCBhdCBpbmRleCB1bmxlc3MgYSBwbHVnaW4gcmV0dXJucyBgZmFsc2VgIHRvIHRoZSBgYmVmb3JlRGF0YXNldERyYXdgDQogICAgICogaG9vaywgaW4gd2hpY2ggY2FzZSwgcGx1Z2lucyB3aWxsIG5vdCBiZSBjYWxsZWQgb24gYGFmdGVyRGF0YXNldERyYXdgLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBkcmF3RGF0YXNldDogZnVuY3Rpb24gZHJhd0RhdGFzZXQobWV0YSwgZWFzaW5nVmFsdWUpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGFyZ3MgPSB7CiAgICAgICAgbWV0YTogbWV0YSwKICAgICAgICBpbmRleDogbWV0YS5pbmRleCwKICAgICAgICBlYXNpbmdWYWx1ZTogZWFzaW5nVmFsdWUKICAgICAgfTsKCiAgICAgIGlmIChjb3JlX3BsdWdpbnMubm90aWZ5KG1lLCAnYmVmb3JlRGF0YXNldERyYXcnLCBbYXJnc10pID09PSBmYWxzZSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgbWV0YS5jb250cm9sbGVyLmRyYXcoZWFzaW5nVmFsdWUpOwogICAgICBjb3JlX3BsdWdpbnMubm90aWZ5KG1lLCAnYWZ0ZXJEYXRhc2V0RHJhdycsIFthcmdzXSk7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIERyYXdzIHRvb2x0aXAgdW5sZXNzIGEgcGx1Z2luIHJldHVybnMgYGZhbHNlYCB0byB0aGUgYGJlZm9yZVRvb2x0aXBEcmF3YA0KICAgICAqIGhvb2ssIGluIHdoaWNoIGNhc2UsIHBsdWdpbnMgd2lsbCBub3QgYmUgY2FsbGVkIG9uIGBhZnRlclRvb2x0aXBEcmF3YC4NCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2RyYXdUb29sdGlwOiBmdW5jdGlvbiBfZHJhd1Rvb2x0aXAoZWFzaW5nVmFsdWUpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIHRvb2x0aXAgPSBtZS50b29sdGlwOwogICAgICB2YXIgYXJncyA9IHsKICAgICAgICB0b29sdGlwOiB0b29sdGlwLAogICAgICAgIGVhc2luZ1ZhbHVlOiBlYXNpbmdWYWx1ZQogICAgICB9OwoKICAgICAgaWYgKGNvcmVfcGx1Z2lucy5ub3RpZnkobWUsICdiZWZvcmVUb29sdGlwRHJhdycsIFthcmdzXSkgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0b29sdGlwLmRyYXcoKTsKICAgICAgY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2FmdGVyVG9vbHRpcERyYXcnLCBbYXJnc10pOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBHZXQgdGhlIHNpbmdsZSBlbGVtZW50IHRoYXQgd2FzIGNsaWNrZWQgb24NCiAgICAgKiBAcmV0dXJuIEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBkYXRhc2V0IGluZGV4IGFuZCBlbGVtZW50IGluZGV4IG9mIHRoZSBtYXRjaGluZyBlbGVtZW50LiBBbHNvIGNvbnRhaW5zIHRoZSByZWN0YW5nbGUgdGhhdCB3YXMgZHJhdw0KICAgICAqLwogICAgZ2V0RWxlbWVudEF0RXZlbnQ6IGZ1bmN0aW9uIGdldEVsZW1lbnRBdEV2ZW50KGUpIHsKICAgICAgcmV0dXJuIGNvcmVfaW50ZXJhY3Rpb24ubW9kZXMuc2luZ2xlKHRoaXMsIGUpOwogICAgfSwKICAgIGdldEVsZW1lbnRzQXRFdmVudDogZnVuY3Rpb24gZ2V0RWxlbWVudHNBdEV2ZW50KGUpIHsKICAgICAgcmV0dXJuIGNvcmVfaW50ZXJhY3Rpb24ubW9kZXMubGFiZWwodGhpcywgZSwgewogICAgICAgIGludGVyc2VjdDogdHJ1ZQogICAgICB9KTsKICAgIH0sCiAgICBnZXRFbGVtZW50c0F0WEF4aXM6IGZ1bmN0aW9uIGdldEVsZW1lbnRzQXRYQXhpcyhlKSB7CiAgICAgIHJldHVybiBjb3JlX2ludGVyYWN0aW9uLm1vZGVzWyd4LWF4aXMnXSh0aGlzLCBlLCB7CiAgICAgICAgaW50ZXJzZWN0OiB0cnVlCiAgICAgIH0pOwogICAgfSwKICAgIGdldEVsZW1lbnRzQXRFdmVudEZvck1vZGU6IGZ1bmN0aW9uIGdldEVsZW1lbnRzQXRFdmVudEZvck1vZGUoZSwgbW9kZSwgb3B0aW9ucykgewogICAgICB2YXIgbWV0aG9kID0gY29yZV9pbnRlcmFjdGlvbi5tb2Rlc1ttb2RlXTsKCiAgICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIG1ldGhvZCh0aGlzLCBlLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIFtdOwogICAgfSwKICAgIGdldERhdGFzZXRBdEV2ZW50OiBmdW5jdGlvbiBnZXREYXRhc2V0QXRFdmVudChlKSB7CiAgICAgIHJldHVybiBjb3JlX2ludGVyYWN0aW9uLm1vZGVzLmRhdGFzZXQodGhpcywgZSwgewogICAgICAgIGludGVyc2VjdDogdHJ1ZQogICAgICB9KTsKICAgIH0sCiAgICBnZXREYXRhc2V0TWV0YTogZnVuY3Rpb24gZ2V0RGF0YXNldE1ldGEoZGF0YXNldEluZGV4KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBkYXRhc2V0ID0gbWUuZGF0YS5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdOwoKICAgICAgaWYgKCFkYXRhc2V0Ll9tZXRhKSB7CiAgICAgICAgZGF0YXNldC5fbWV0YSA9IHt9OwogICAgICB9CgogICAgICB2YXIgbWV0YSA9IGRhdGFzZXQuX21ldGFbbWUuaWRdOwoKICAgICAgaWYgKCFtZXRhKSB7CiAgICAgICAgbWV0YSA9IGRhdGFzZXQuX21ldGFbbWUuaWRdID0gewogICAgICAgICAgdHlwZTogbnVsbCwKICAgICAgICAgIGRhdGE6IFtdLAogICAgICAgICAgZGF0YXNldDogbnVsbCwKICAgICAgICAgIGNvbnRyb2xsZXI6IG51bGwsCiAgICAgICAgICBoaWRkZW46IG51bGwsCiAgICAgICAgICAvLyBTZWUgaXNEYXRhc2V0VmlzaWJsZSgpIGNvbW1lbnQKICAgICAgICAgIHhBeGlzSUQ6IG51bGwsCiAgICAgICAgICB5QXhpc0lEOiBudWxsLAogICAgICAgICAgb3JkZXI6IGRhdGFzZXQub3JkZXIgfHwgMCwKICAgICAgICAgIGluZGV4OiBkYXRhc2V0SW5kZXgKICAgICAgICB9OwogICAgICB9CgogICAgICByZXR1cm4gbWV0YTsKICAgIH0sCiAgICBnZXRWaXNpYmxlRGF0YXNldENvdW50OiBmdW5jdGlvbiBnZXRWaXNpYmxlRGF0YXNldENvdW50KCkgewogICAgICB2YXIgY291bnQgPSAwOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSB0aGlzLmRhdGEuZGF0YXNldHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgaWYgKHRoaXMuaXNEYXRhc2V0VmlzaWJsZShpKSkgewogICAgICAgICAgY291bnQrKzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiBjb3VudDsKICAgIH0sCiAgICBpc0RhdGFzZXRWaXNpYmxlOiBmdW5jdGlvbiBpc0RhdGFzZXRWaXNpYmxlKGRhdGFzZXRJbmRleCkgewogICAgICB2YXIgbWV0YSA9IHRoaXMuZ2V0RGF0YXNldE1ldGEoZGF0YXNldEluZGV4KTsgLy8gbWV0YS5oaWRkZW4gaXMgYSBwZXIgY2hhcnQgZGF0YXNldCBoaWRkZW4gZmxhZyBvdmVycmlkZSB3aXRoIDMgc3RhdGVzOiBpZiB0cnVlIG9yIGZhbHNlLAogICAgICAvLyB0aGUgZGF0YXNldC5oaWRkZW4gdmFsdWUgaXMgaWdub3JlZCwgZWxzZSBpZiBudWxsLCB0aGUgZGF0YXNldCBoaWRkZW4gc3RhdGUgaXMgcmV0dXJuZWQuCgogICAgICByZXR1cm4gdHlwZW9mIG1ldGEuaGlkZGVuID09PSAnYm9vbGVhbicgPyAhbWV0YS5oaWRkZW4gOiAhdGhpcy5kYXRhLmRhdGFzZXRzW2RhdGFzZXRJbmRleF0uaGlkZGVuOwogICAgfSwKICAgIGdlbmVyYXRlTGVnZW5kOiBmdW5jdGlvbiBnZW5lcmF0ZUxlZ2VuZCgpIHsKICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5sZWdlbmRDYWxsYmFjayh0aGlzKTsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIGRlc3Ryb3lEYXRhc2V0TWV0YTogZnVuY3Rpb24gZGVzdHJveURhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCkgewogICAgICB2YXIgaWQgPSB0aGlzLmlkOwogICAgICB2YXIgZGF0YXNldCA9IHRoaXMuZGF0YS5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdOwogICAgICB2YXIgbWV0YSA9IGRhdGFzZXQuX21ldGEgJiYgZGF0YXNldC5fbWV0YVtpZF07CgogICAgICBpZiAobWV0YSkgewogICAgICAgIG1ldGEuY29udHJvbGxlci5kZXN0cm95KCk7CiAgICAgICAgZGVsZXRlIGRhdGFzZXQuX21ldGFbaWRdOwogICAgICB9CiAgICB9LAogICAgZGVzdHJveTogZnVuY3Rpb24gZGVzdHJveSgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGNhbnZhcyA9IG1lLmNhbnZhczsKICAgICAgdmFyIGksIGlsZW47CiAgICAgIG1lLnN0b3AoKTsgLy8gZGF0YXNldCBjb250cm9sbGVycyBuZWVkIHRvIGNsZWFudXAgYXNzb2NpYXRlZCBkYXRhCgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gbWUuZGF0YS5kYXRhc2V0cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBtZS5kZXN0cm95RGF0YXNldE1ldGEoaSk7CiAgICAgIH0KCiAgICAgIGlmIChjYW52YXMpIHsKICAgICAgICBtZS51bmJpbmRFdmVudHMoKTsKICAgICAgICBoZWxwZXJzJDEuY2FudmFzLmNsZWFyKG1lKTsKICAgICAgICBwbGF0Zm9ybS5yZWxlYXNlQ29udGV4dChtZS5jdHgpOwogICAgICAgIG1lLmNhbnZhcyA9IG51bGw7CiAgICAgICAgbWUuY3R4ID0gbnVsbDsKICAgICAgfQoKICAgICAgY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2Rlc3Ryb3knKTsKICAgICAgZGVsZXRlIENoYXJ0Lmluc3RhbmNlc1ttZS5pZF07CiAgICB9LAogICAgdG9CYXNlNjRJbWFnZTogZnVuY3Rpb24gdG9CYXNlNjRJbWFnZSgpIHsKICAgICAgcmV0dXJuIHRoaXMuY2FudmFzLnRvRGF0YVVSTC5hcHBseSh0aGlzLmNhbnZhcywgYXJndW1lbnRzKTsKICAgIH0sCiAgICBpbml0VG9vbFRpcDogZnVuY3Rpb24gaW5pdFRvb2xUaXAoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIG1lLnRvb2x0aXAgPSBuZXcgY29yZV90b29sdGlwKHsKICAgICAgICBfY2hhcnQ6IG1lLAogICAgICAgIF9jaGFydEluc3RhbmNlOiBtZSwKICAgICAgICAvLyBkZXByZWNhdGVkLCBiYWNrd2FyZCBjb21wYXRpYmlsaXR5CiAgICAgICAgX2RhdGE6IG1lLmRhdGEsCiAgICAgICAgX29wdGlvbnM6IG1lLm9wdGlvbnMudG9vbHRpcHMKICAgICAgfSwgbWUpOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgYmluZEV2ZW50czogZnVuY3Rpb24gYmluZEV2ZW50cygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGxpc3RlbmVycyA9IG1lLl9saXN0ZW5lcnMgPSB7fTsKCiAgICAgIHZhciBsaXN0ZW5lciA9IGZ1bmN0aW9uIGxpc3RlbmVyKCkgewogICAgICAgIG1lLmV2ZW50SGFuZGxlci5hcHBseShtZSwgYXJndW1lbnRzKTsKICAgICAgfTsKCiAgICAgIGhlbHBlcnMkMS5lYWNoKG1lLm9wdGlvbnMuZXZlbnRzLCBmdW5jdGlvbiAodHlwZSkgewogICAgICAgIHBsYXRmb3JtLmFkZEV2ZW50TGlzdGVuZXIobWUsIHR5cGUsIGxpc3RlbmVyKTsKICAgICAgICBsaXN0ZW5lcnNbdHlwZV0gPSBsaXN0ZW5lcjsKICAgICAgfSk7IC8vIEVsZW1lbnRzIHVzZWQgdG8gZGV0ZWN0IHNpemUgY2hhbmdlIHNob3VsZCBub3QgYmUgaW5qZWN0ZWQgZm9yIG5vbiByZXNwb25zaXZlIGNoYXJ0cy4KICAgICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL2lzc3Vlcy8yMjEwCgogICAgICBpZiAobWUub3B0aW9ucy5yZXNwb25zaXZlKSB7CiAgICAgICAgbGlzdGVuZXIgPSBmdW5jdGlvbiBsaXN0ZW5lcigpIHsKICAgICAgICAgIG1lLnJlc2l6ZSgpOwogICAgICAgIH07CgogICAgICAgIHBsYXRmb3JtLmFkZEV2ZW50TGlzdGVuZXIobWUsICdyZXNpemUnLCBsaXN0ZW5lcik7CiAgICAgICAgbGlzdGVuZXJzLnJlc2l6ZSA9IGxpc3RlbmVyOwogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICB1bmJpbmRFdmVudHM6IGZ1bmN0aW9uIHVuYmluZEV2ZW50cygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGxpc3RlbmVycyA9IG1lLl9saXN0ZW5lcnM7CgogICAgICBpZiAoIWxpc3RlbmVycykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgZGVsZXRlIG1lLl9saXN0ZW5lcnM7CiAgICAgIGhlbHBlcnMkMS5lYWNoKGxpc3RlbmVycywgZnVuY3Rpb24gKGxpc3RlbmVyLCB0eXBlKSB7CiAgICAgICAgcGxhdGZvcm0ucmVtb3ZlRXZlbnRMaXN0ZW5lcihtZSwgdHlwZSwgbGlzdGVuZXIpOwogICAgICB9KTsKICAgIH0sCiAgICB1cGRhdGVIb3ZlclN0eWxlOiBmdW5jdGlvbiB1cGRhdGVIb3ZlclN0eWxlKGVsZW1lbnRzLCBtb2RlLCBlbmFibGVkKSB7CiAgICAgIHZhciBwcmVmaXggPSBlbmFibGVkID8gJ3NldCcgOiAncmVtb3ZlJzsKICAgICAgdmFyIGVsZW1lbnQsIGksIGlsZW47CgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gZWxlbWVudHMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgZWxlbWVudCA9IGVsZW1lbnRzW2ldOwoKICAgICAgICBpZiAoZWxlbWVudCkgewogICAgICAgICAgdGhpcy5nZXREYXRhc2V0TWV0YShlbGVtZW50Ll9kYXRhc2V0SW5kZXgpLmNvbnRyb2xsZXJbcHJlZml4ICsgJ0hvdmVyU3R5bGUnXShlbGVtZW50KTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChtb2RlID09PSAnZGF0YXNldCcpIHsKICAgICAgICB0aGlzLmdldERhdGFzZXRNZXRhKGVsZW1lbnRzWzBdLl9kYXRhc2V0SW5kZXgpLmNvbnRyb2xsZXJbJ18nICsgcHJlZml4ICsgJ0RhdGFzZXRIb3ZlclN0eWxlJ10oKTsKICAgICAgfQogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgZXZlbnRIYW5kbGVyOiBmdW5jdGlvbiBldmVudEhhbmRsZXIoZSkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgdG9vbHRpcCA9IG1lLnRvb2x0aXA7CgogICAgICBpZiAoY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2JlZm9yZUV2ZW50JywgW2VdKSA9PT0gZmFsc2UpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0gLy8gQnVmZmVyIGFueSB1cGRhdGUgY2FsbHMgc28gdGhhdCByZW5kZXJzIGRvIG5vdCBvY2N1cgoKCiAgICAgIG1lLl9idWZmZXJlZFJlbmRlciA9IHRydWU7CiAgICAgIG1lLl9idWZmZXJlZFJlcXVlc3QgPSBudWxsOwogICAgICB2YXIgY2hhbmdlZCA9IG1lLmhhbmRsZUV2ZW50KGUpOyAvLyBmb3Igc21vb3RoIHRvb2x0aXAgYW5pbWF0aW9ucyBpc3N1ZSAjNDk4OQogICAgICAvLyB0aGUgdG9vbHRpcCBzaG91bGQgYmUgdGhlIHNvdXJjZSBvZiBjaGFuZ2UKICAgICAgLy8gQW5pbWF0aW9uIGNoZWNrIHdvcmthcm91bmQ6CiAgICAgIC8vIHRvb2x0aXAuX3N0YXJ0IHdpbGwgYmUgbnVsbCB3aGVuIHRvb2x0aXAgaXNuJ3QgYW5pbWF0aW5nCgogICAgICBpZiAodG9vbHRpcCkgewogICAgICAgIGNoYW5nZWQgPSB0b29sdGlwLl9zdGFydCA/IHRvb2x0aXAuaGFuZGxlRXZlbnQoZSkgOiBjaGFuZ2VkIHwgdG9vbHRpcC5oYW5kbGVFdmVudChlKTsKICAgICAgfQoKICAgICAgY29yZV9wbHVnaW5zLm5vdGlmeShtZSwgJ2FmdGVyRXZlbnQnLCBbZV0pOwogICAgICB2YXIgYnVmZmVyZWRSZXF1ZXN0ID0gbWUuX2J1ZmZlcmVkUmVxdWVzdDsKCiAgICAgIGlmIChidWZmZXJlZFJlcXVlc3QpIHsKICAgICAgICAvLyBJZiB3ZSBoYXZlIGFuIHVwZGF0ZSB0aGF0IHdhcyB0cmlnZ2VyZWQsIHdlIG5lZWQgdG8gZG8gYSBub3JtYWwgcmVuZGVyCiAgICAgICAgbWUucmVuZGVyKGJ1ZmZlcmVkUmVxdWVzdCk7CiAgICAgIH0gZWxzZSBpZiAoY2hhbmdlZCAmJiAhbWUuYW5pbWF0aW5nKSB7CiAgICAgICAgLy8gSWYgZW50ZXJpbmcsIGxlYXZpbmcsIG9yIGNoYW5naW5nIGVsZW1lbnRzLCBhbmltYXRlIHRoZSBjaGFuZ2UgdmlhIHBpdm90CiAgICAgICAgbWUuc3RvcCgpOyAvLyBXZSBvbmx5IG5lZWQgdG8gcmVuZGVyIGF0IHRoaXMgcG9pbnQuIFVwZGF0aW5nIHdpbGwgY2F1c2Ugc2NhbGVzIHRvIGJlCiAgICAgICAgLy8gcmVjb21wdXRlZCBnZW5lcmF0aW5nIGZsaWNrZXIgJiB1c2luZyBtb3JlIG1lbW9yeSB0aGFuIG5lY2Vzc2FyeS4KCiAgICAgICAgbWUucmVuZGVyKHsKICAgICAgICAgIGR1cmF0aW9uOiBtZS5vcHRpb25zLmhvdmVyLmFuaW1hdGlvbkR1cmF0aW9uLAogICAgICAgICAgbGF6eTogdHJ1ZQogICAgICAgIH0pOwogICAgICB9CgogICAgICBtZS5fYnVmZmVyZWRSZW5kZXIgPSBmYWxzZTsKICAgICAgbWUuX2J1ZmZlcmVkUmVxdWVzdCA9IG51bGw7CiAgICAgIHJldHVybiBtZTsKICAgIH0sCgogICAgLyoqDQogICAgICogSGFuZGxlIGFuIGV2ZW50DQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcGFyYW0ge0lFdmVudH0gZXZlbnQgdGhlIGV2ZW50IHRvIGhhbmRsZQ0KICAgICAqIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhlIGNoYXJ0IG5lZWRzIHRvIHJlLXJlbmRlcg0KICAgICAqLwogICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uIGhhbmRsZUV2ZW50KGUpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9wdGlvbnMgPSBtZS5vcHRpb25zIHx8IHt9OwogICAgICB2YXIgaG92ZXJPcHRpb25zID0gb3B0aW9ucy5ob3ZlcjsKICAgICAgdmFyIGNoYW5nZWQgPSBmYWxzZTsKICAgICAgbWUubGFzdEFjdGl2ZSA9IG1lLmxhc3RBY3RpdmUgfHwgW107IC8vIEZpbmQgQWN0aXZlIEVsZW1lbnRzIGZvciBob3ZlciBhbmQgdG9vbHRpcHMKCiAgICAgIGlmIChlLnR5cGUgPT09ICdtb3VzZW91dCcpIHsKICAgICAgICBtZS5hY3RpdmUgPSBbXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZS5hY3RpdmUgPSBtZS5nZXRFbGVtZW50c0F0RXZlbnRGb3JNb2RlKGUsIGhvdmVyT3B0aW9ucy5tb2RlLCBob3Zlck9wdGlvbnMpOwogICAgICB9IC8vIEludm9rZSBvbkhvdmVyIGhvb2sKICAgICAgLy8gTmVlZCB0byBjYWxsIHdpdGggbmF0aXZlIGV2ZW50IGhlcmUgdG8gbm90IGJyZWFrIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CgoKICAgICAgaGVscGVycyQxLmNhbGxiYWNrKG9wdGlvbnMub25Ib3ZlciB8fCBvcHRpb25zLmhvdmVyLm9uSG92ZXIsIFtlLm5hdGl2ZSwgbWUuYWN0aXZlXSwgbWUpOwoKICAgICAgaWYgKGUudHlwZSA9PT0gJ21vdXNldXAnIHx8IGUudHlwZSA9PT0gJ2NsaWNrJykgewogICAgICAgIGlmIChvcHRpb25zLm9uQ2xpY2spIHsKICAgICAgICAgIC8vIFVzZSBlLm5hdGl2ZSBoZXJlIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgICAgICAgb3B0aW9ucy5vbkNsaWNrLmNhbGwobWUsIGUubmF0aXZlLCBtZS5hY3RpdmUpOwogICAgICAgIH0KICAgICAgfSAvLyBSZW1vdmUgc3R5bGluZyBmb3IgbGFzdCBhY3RpdmUgKGV2ZW4gaWYgaXQgbWF5IHN0aWxsIGJlIGFjdGl2ZSkKCgogICAgICBpZiAobWUubGFzdEFjdGl2ZS5sZW5ndGgpIHsKICAgICAgICBtZS51cGRhdGVIb3ZlclN0eWxlKG1lLmxhc3RBY3RpdmUsIGhvdmVyT3B0aW9ucy5tb2RlLCBmYWxzZSk7CiAgICAgIH0gLy8gQnVpbHQgaW4gaG92ZXIgc3R5bGluZwoKCiAgICAgIGlmIChtZS5hY3RpdmUubGVuZ3RoICYmIGhvdmVyT3B0aW9ucy5tb2RlKSB7CiAgICAgICAgbWUudXBkYXRlSG92ZXJTdHlsZShtZS5hY3RpdmUsIGhvdmVyT3B0aW9ucy5tb2RlLCB0cnVlKTsKICAgICAgfQoKICAgICAgY2hhbmdlZCA9ICFoZWxwZXJzJDEuYXJyYXlFcXVhbHMobWUuYWN0aXZlLCBtZS5sYXN0QWN0aXZlKTsgLy8gUmVtZW1iZXIgTGFzdCBBY3RpdmVzCgogICAgICBtZS5sYXN0QWN0aXZlID0gbWUuYWN0aXZlOwogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0KICB9KTsKICAvKioNCiAgICogTk9URShTQikgV2UgYWN0dWFsbHkgZG9uJ3QgdXNlIHRoaXMgY29udGFpbmVyIGFueW1vcmUgYnV0IHdlIG5lZWQgdG8ga2VlcCBpdA0KICAgKiBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eS4gVGhvdWdoLCBpdCBjYW4gc3RpbGwgYmUgdXNlZnVsIGZvciBwbHVnaW5zIHRoYXQNCiAgICogd291bGQgbmVlZCB0byB3b3JrIG9uIG11bHRpcGxlIGNoYXJ0cz8hDQogICAqLwoKICBDaGFydC5pbnN0YW5jZXMgPSB7fTsKICB2YXIgY29yZV9jb250cm9sbGVyID0gQ2hhcnQ7IC8vIERFUFJFQ0FUSU9OUwoKICAvKioNCiAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIHVzZSBDaGFydCBpbnN0ZWFkLg0KICAgKiBAY2xhc3MgQ2hhcnQuQ29udHJvbGxlcg0KICAgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuNg0KICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAqIEBwcml2YXRlDQogICAqLwoKICBDaGFydC5Db250cm9sbGVyID0gQ2hhcnQ7CiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCBub3QgYXZhaWxhYmxlIGFueW1vcmUuDQogICAqIEBuYW1lc3BhY2UgQ2hhcnQNCiAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjgNCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCiAgQ2hhcnQudHlwZXMgPSB7fTsKICAvKioNCiAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIG5vdCBhdmFpbGFibGUgYW55bW9yZS4NCiAgICogQG5hbWVzcGFjZSBDaGFydC5oZWxwZXJzLmNvbmZpZ01lcmdlDQogICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi44LjANCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCiAgaGVscGVycyQxLmNvbmZpZ01lcmdlID0gbWVyZ2VDb25maWc7CiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCBub3QgYXZhaWxhYmxlIGFueW1vcmUuDQogICAqIEBuYW1lc3BhY2UgQ2hhcnQuaGVscGVycy5zY2FsZU1lcmdlDQogICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi44LjANCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCiAgaGVscGVycyQxLnNjYWxlTWVyZ2UgPSBtZXJnZVNjYWxlQ29uZmlnOwoKICB2YXIgY29yZV9oZWxwZXJzID0gZnVuY3Rpb24gY29yZV9oZWxwZXJzKCkgewogICAgLy8gLS0gQmFzaWMganMgdXRpbGl0eSBtZXRob2RzCiAgICBoZWxwZXJzJDEud2hlcmUgPSBmdW5jdGlvbiAoY29sbGVjdGlvbiwgZmlsdGVyQ2FsbGJhY2spIHsKICAgICAgaWYgKGhlbHBlcnMkMS5pc0FycmF5KGNvbGxlY3Rpb24pICYmIEFycmF5LnByb3RvdHlwZS5maWx0ZXIpIHsKICAgICAgICByZXR1cm4gY29sbGVjdGlvbi5maWx0ZXIoZmlsdGVyQ2FsbGJhY2spOwogICAgICB9CgogICAgICB2YXIgZmlsdGVyZWQgPSBbXTsKICAgICAgaGVscGVycyQxLmVhY2goY29sbGVjdGlvbiwgZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICBpZiAoZmlsdGVyQ2FsbGJhY2soaXRlbSkpIHsKICAgICAgICAgIGZpbHRlcmVkLnB1c2goaXRlbSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIGZpbHRlcmVkOwogICAgfTsKCiAgICBoZWxwZXJzJDEuZmluZEluZGV4ID0gQXJyYXkucHJvdG90eXBlLmZpbmRJbmRleCA/IGZ1bmN0aW9uIChhcnJheSwgY2FsbGJhY2ssIHNjb3BlKSB7CiAgICAgIHJldHVybiBhcnJheS5maW5kSW5kZXgoY2FsbGJhY2ssIHNjb3BlKTsKICAgIH0gOiBmdW5jdGlvbiAoYXJyYXksIGNhbGxiYWNrLCBzY29wZSkgewogICAgICBzY29wZSA9IHNjb3BlID09PSB1bmRlZmluZWQgPyBhcnJheSA6IHNjb3BlOwoKICAgICAgZm9yICh2YXIgaSA9IDAsIGlsZW4gPSBhcnJheS5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBpZiAoY2FsbGJhY2suY2FsbChzY29wZSwgYXJyYXlbaV0sIGksIGFycmF5KSkgewogICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gLTE7CiAgICB9OwoKICAgIGhlbHBlcnMkMS5maW5kTmV4dFdoZXJlID0gZnVuY3Rpb24gKGFycmF5VG9TZWFyY2gsIGZpbHRlckNhbGxiYWNrLCBzdGFydEluZGV4KSB7CiAgICAgIC8vIERlZmF1bHQgdG8gc3RhcnQgb2YgdGhlIGFycmF5CiAgICAgIGlmIChoZWxwZXJzJDEuaXNOdWxsT3JVbmRlZihzdGFydEluZGV4KSkgewogICAgICAgIHN0YXJ0SW5kZXggPSAtMTsKICAgICAgfQoKICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0SW5kZXggKyAxOyBpIDwgYXJyYXlUb1NlYXJjaC5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBjdXJyZW50SXRlbSA9IGFycmF5VG9TZWFyY2hbaV07CgogICAgICAgIGlmIChmaWx0ZXJDYWxsYmFjayhjdXJyZW50SXRlbSkpIHsKICAgICAgICAgIHJldHVybiBjdXJyZW50SXRlbTsKICAgICAgICB9CiAgICAgIH0KICAgIH07CgogICAgaGVscGVycyQxLmZpbmRQcmV2aW91c1doZXJlID0gZnVuY3Rpb24gKGFycmF5VG9TZWFyY2gsIGZpbHRlckNhbGxiYWNrLCBzdGFydEluZGV4KSB7CiAgICAgIC8vIERlZmF1bHQgdG8gZW5kIG9mIHRoZSBhcnJheQogICAgICBpZiAoaGVscGVycyQxLmlzTnVsbE9yVW5kZWYoc3RhcnRJbmRleCkpIHsKICAgICAgICBzdGFydEluZGV4ID0gYXJyYXlUb1NlYXJjaC5sZW5ndGg7CiAgICAgIH0KCiAgICAgIGZvciAodmFyIGkgPSBzdGFydEluZGV4IC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICB2YXIgY3VycmVudEl0ZW0gPSBhcnJheVRvU2VhcmNoW2ldOwoKICAgICAgICBpZiAoZmlsdGVyQ2FsbGJhY2soY3VycmVudEl0ZW0pKSB7CiAgICAgICAgICByZXR1cm4gY3VycmVudEl0ZW07CiAgICAgICAgfQogICAgICB9CiAgICB9OyAvLyAtLSBNYXRoIG1ldGhvZHMKCgogICAgaGVscGVycyQxLmlzTnVtYmVyID0gZnVuY3Rpb24gKG4pIHsKICAgICAgcmV0dXJuICFpc05hTihwYXJzZUZsb2F0KG4pKSAmJiBpc0Zpbml0ZShuKTsKICAgIH07CgogICAgaGVscGVycyQxLmFsbW9zdEVxdWFscyA9IGZ1bmN0aW9uICh4LCB5LCBlcHNpbG9uKSB7CiAgICAgIHJldHVybiBNYXRoLmFicyh4IC0geSkgPCBlcHNpbG9uOwogICAgfTsKCiAgICBoZWxwZXJzJDEuYWxtb3N0V2hvbGUgPSBmdW5jdGlvbiAoeCwgZXBzaWxvbikgewogICAgICB2YXIgcm91bmRlZCA9IE1hdGgucm91bmQoeCk7CiAgICAgIHJldHVybiByb3VuZGVkIC0gZXBzaWxvbiA8PSB4ICYmIHJvdW5kZWQgKyBlcHNpbG9uID49IHg7CiAgICB9OwoKICAgIGhlbHBlcnMkMS5tYXggPSBmdW5jdGlvbiAoYXJyYXkpIHsKICAgICAgcmV0dXJuIGFycmF5LnJlZHVjZShmdW5jdGlvbiAobWF4LCB2YWx1ZSkgewogICAgICAgIGlmICghaXNOYU4odmFsdWUpKSB7CiAgICAgICAgICByZXR1cm4gTWF0aC5tYXgobWF4LCB2YWx1ZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbWF4OwogICAgICB9LCBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkpOwogICAgfTsKCiAgICBoZWxwZXJzJDEubWluID0gZnVuY3Rpb24gKGFycmF5KSB7CiAgICAgIHJldHVybiBhcnJheS5yZWR1Y2UoZnVuY3Rpb24gKG1pbiwgdmFsdWUpIHsKICAgICAgICBpZiAoIWlzTmFOKHZhbHVlKSkgewogICAgICAgICAgcmV0dXJuIE1hdGgubWluKG1pbiwgdmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG1pbjsKICAgICAgfSwgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZKTsKICAgIH07CgogICAgaGVscGVycyQxLnNpZ24gPSBNYXRoLnNpZ24gPyBmdW5jdGlvbiAoeCkgewogICAgICByZXR1cm4gTWF0aC5zaWduKHgpOwogICAgfSA6IGZ1bmN0aW9uICh4KSB7CiAgICAgIHggPSAreDsgLy8gY29udmVydCB0byBhIG51bWJlcgoKICAgICAgaWYgKHggPT09IDAgfHwgaXNOYU4oeCkpIHsKICAgICAgICByZXR1cm4geDsKICAgICAgfQoKICAgICAgcmV0dXJuIHggPiAwID8gMSA6IC0xOwogICAgfTsKCiAgICBoZWxwZXJzJDEudG9SYWRpYW5zID0gZnVuY3Rpb24gKGRlZ3JlZXMpIHsKICAgICAgcmV0dXJuIGRlZ3JlZXMgKiAoTWF0aC5QSSAvIDE4MCk7CiAgICB9OwoKICAgIGhlbHBlcnMkMS50b0RlZ3JlZXMgPSBmdW5jdGlvbiAocmFkaWFucykgewogICAgICByZXR1cm4gcmFkaWFucyAqICgxODAgLyBNYXRoLlBJKTsKICAgIH07CiAgICAvKioNCiAgICAgKiBSZXR1cm5zIHRoZSBudW1iZXIgb2YgZGVjaW1hbCBwbGFjZXMNCiAgICAgKiBpLmUuIHRoZSBudW1iZXIgb2YgZGlnaXRzIGFmdGVyIHRoZSBkZWNpbWFsIHBvaW50LCBvZiB0aGUgdmFsdWUgb2YgdGhpcyBOdW1iZXIuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBBIG51bWJlci4NCiAgICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCgoKICAgIGhlbHBlcnMkMS5fZGVjaW1hbFBsYWNlcyA9IGZ1bmN0aW9uICh4KSB7CiAgICAgIGlmICghaGVscGVycyQxLmlzRmluaXRlKHgpKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgZSA9IDE7CiAgICAgIHZhciBwID0gMDsKCiAgICAgIHdoaWxlIChNYXRoLnJvdW5kKHggKiBlKSAvIGUgIT09IHgpIHsKICAgICAgICBlICo9IDEwOwogICAgICAgIHArKzsKICAgICAgfQoKICAgICAgcmV0dXJuIHA7CiAgICB9OyAvLyBHZXRzIHRoZSBhbmdsZSBmcm9tIHZlcnRpY2FsIHVwcmlnaHQgdG8gdGhlIHBvaW50IGFib3V0IGEgY2VudHJlLgoKCiAgICBoZWxwZXJzJDEuZ2V0QW5nbGVGcm9tUG9pbnQgPSBmdW5jdGlvbiAoY2VudHJlUG9pbnQsIGFuZ2xlUG9pbnQpIHsKICAgICAgdmFyIGRpc3RhbmNlRnJvbVhDZW50ZXIgPSBhbmdsZVBvaW50LnggLSBjZW50cmVQb2ludC54OwogICAgICB2YXIgZGlzdGFuY2VGcm9tWUNlbnRlciA9IGFuZ2xlUG9pbnQueSAtIGNlbnRyZVBvaW50Lnk7CiAgICAgIHZhciByYWRpYWxEaXN0YW5jZUZyb21DZW50ZXIgPSBNYXRoLnNxcnQoZGlzdGFuY2VGcm9tWENlbnRlciAqIGRpc3RhbmNlRnJvbVhDZW50ZXIgKyBkaXN0YW5jZUZyb21ZQ2VudGVyICogZGlzdGFuY2VGcm9tWUNlbnRlcik7CiAgICAgIHZhciBhbmdsZSA9IE1hdGguYXRhbjIoZGlzdGFuY2VGcm9tWUNlbnRlciwgZGlzdGFuY2VGcm9tWENlbnRlcik7CgogICAgICBpZiAoYW5nbGUgPCAtMC41ICogTWF0aC5QSSkgewogICAgICAgIGFuZ2xlICs9IDIuMCAqIE1hdGguUEk7IC8vIG1ha2Ugc3VyZSB0aGUgcmV0dXJuZWQgYW5nbGUgaXMgaW4gdGhlIHJhbmdlIG9mICgtUEkvMiwgM1BJLzJdCiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgYW5nbGU6IGFuZ2xlLAogICAgICAgIGRpc3RhbmNlOiByYWRpYWxEaXN0YW5jZUZyb21DZW50ZXIKICAgICAgfTsKICAgIH07CgogICAgaGVscGVycyQxLmRpc3RhbmNlQmV0d2VlblBvaW50cyA9IGZ1bmN0aW9uIChwdDEsIHB0MikgewogICAgICByZXR1cm4gTWF0aC5zcXJ0KE1hdGgucG93KHB0Mi54IC0gcHQxLngsIDIpICsgTWF0aC5wb3cocHQyLnkgLSBwdDEueSwgMikpOwogICAgfTsKICAgIC8qKg0KICAgICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCBub3QgYXZhaWxhYmxlIGFueW1vcmUNCiAgICAgKiBAZnVuY3Rpb24gQ2hhcnQuaGVscGVycy5hbGlhc1BpeGVsDQogICAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjguMA0KICAgICAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMNCiAgICAgKi8KCgogICAgaGVscGVycyQxLmFsaWFzUGl4ZWwgPSBmdW5jdGlvbiAocGl4ZWxXaWR0aCkgewogICAgICByZXR1cm4gcGl4ZWxXaWR0aCAlIDIgPT09IDAgPyAwIDogMC41OwogICAgfTsKICAgIC8qKg0KICAgICAqIFJldHVybnMgdGhlIGFsaWduZWQgcGl4ZWwgdmFsdWUgdG8gYXZvaWQgYW50aS1hbGlhc2luZyBibHVyDQogICAgICogQHBhcmFtIHtDaGFydH0gY2hhcnQgLSBUaGUgY2hhcnQgaW5zdGFuY2UuDQogICAgICogQHBhcmFtIHtudW1iZXJ9IHBpeGVsIC0gQSBwaXhlbCB2YWx1ZS4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIGVsZW1lbnQuDQogICAgICogQHJldHVybnMge251bWJlcn0gVGhlIGFsaWduZWQgcGl4ZWwgdmFsdWUuDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KCgogICAgaGVscGVycyQxLl9hbGlnblBpeGVsID0gZnVuY3Rpb24gKGNoYXJ0LCBwaXhlbCwgd2lkdGgpIHsKICAgICAgdmFyIGRldmljZVBpeGVsUmF0aW8gPSBjaGFydC5jdXJyZW50RGV2aWNlUGl4ZWxSYXRpbzsKICAgICAgdmFyIGhhbGZXaWR0aCA9IHdpZHRoIC8gMjsKICAgICAgcmV0dXJuIE1hdGgucm91bmQoKHBpeGVsIC0gaGFsZldpZHRoKSAqIGRldmljZVBpeGVsUmF0aW8pIC8gZGV2aWNlUGl4ZWxSYXRpbyArIGhhbGZXaWR0aDsKICAgIH07CgogICAgaGVscGVycyQxLnNwbGluZUN1cnZlID0gZnVuY3Rpb24gKGZpcnN0UG9pbnQsIG1pZGRsZVBvaW50LCBhZnRlclBvaW50LCB0KSB7CiAgICAgIC8vIFByb3BzIHRvIFJvYiBTcGVuY2VyIGF0IHNjYWxlZCBpbm5vdmF0aW9uIGZvciBoaXMgcG9zdCBvbiBzcGxpbmluZyBiZXR3ZWVuIHBvaW50cwogICAgICAvLyBodHRwOi8vc2NhbGVkaW5ub3ZhdGlvbi5jb20vYW5hbHl0aWNzL3NwbGluZXMvYWJvdXRTcGxpbmVzLmh0bWwKICAgICAgLy8gVGhpcyBmdW5jdGlvbiBtdXN0IGFsc28gcmVzcGVjdCAic2tpcHBlZCIgcG9pbnRzCiAgICAgIHZhciBwcmV2aW91cyA9IGZpcnN0UG9pbnQuc2tpcCA/IG1pZGRsZVBvaW50IDogZmlyc3RQb2ludDsKICAgICAgdmFyIGN1cnJlbnQgPSBtaWRkbGVQb2ludDsKICAgICAgdmFyIG5leHQgPSBhZnRlclBvaW50LnNraXAgPyBtaWRkbGVQb2ludCA6IGFmdGVyUG9pbnQ7CiAgICAgIHZhciBkMDEgPSBNYXRoLnNxcnQoTWF0aC5wb3coY3VycmVudC54IC0gcHJldmlvdXMueCwgMikgKyBNYXRoLnBvdyhjdXJyZW50LnkgLSBwcmV2aW91cy55LCAyKSk7CiAgICAgIHZhciBkMTIgPSBNYXRoLnNxcnQoTWF0aC5wb3cobmV4dC54IC0gY3VycmVudC54LCAyKSArIE1hdGgucG93KG5leHQueSAtIGN1cnJlbnQueSwgMikpOwogICAgICB2YXIgczAxID0gZDAxIC8gKGQwMSArIGQxMik7CiAgICAgIHZhciBzMTIgPSBkMTIgLyAoZDAxICsgZDEyKTsgLy8gSWYgYWxsIHBvaW50cyBhcmUgdGhlIHNhbWUsIHMwMSAmIHMwMiB3aWxsIGJlIGluZgoKICAgICAgczAxID0gaXNOYU4oczAxKSA/IDAgOiBzMDE7CiAgICAgIHMxMiA9IGlzTmFOKHMxMikgPyAwIDogczEyOwogICAgICB2YXIgZmEgPSB0ICogczAxOyAvLyBzY2FsaW5nIGZhY3RvciBmb3IgdHJpYW5nbGUgVGEKCiAgICAgIHZhciBmYiA9IHQgKiBzMTI7CiAgICAgIHJldHVybiB7CiAgICAgICAgcHJldmlvdXM6IHsKICAgICAgICAgIHg6IGN1cnJlbnQueCAtIGZhICogKG5leHQueCAtIHByZXZpb3VzLngpLAogICAgICAgICAgeTogY3VycmVudC55IC0gZmEgKiAobmV4dC55IC0gcHJldmlvdXMueSkKICAgICAgICB9LAogICAgICAgIG5leHQ6IHsKICAgICAgICAgIHg6IGN1cnJlbnQueCArIGZiICogKG5leHQueCAtIHByZXZpb3VzLngpLAogICAgICAgICAgeTogY3VycmVudC55ICsgZmIgKiAobmV4dC55IC0gcHJldmlvdXMueSkKICAgICAgICB9CiAgICAgIH07CiAgICB9OwoKICAgIGhlbHBlcnMkMS5FUFNJTE9OID0gTnVtYmVyLkVQU0lMT04gfHwgMWUtMTQ7CgogICAgaGVscGVycyQxLnNwbGluZUN1cnZlTW9ub3RvbmUgPSBmdW5jdGlvbiAocG9pbnRzKSB7CiAgICAgIC8vIFRoaXMgZnVuY3Rpb24gY2FsY3VsYXRlcyBCw6l6aWVyIGNvbnRyb2wgcG9pbnRzIGluIGEgc2ltaWxhciB3YXkgdGhhbiB8c3BsaW5lQ3VydmV8LAogICAgICAvLyBidXQgcHJlc2VydmVzIG1vbm90b25pY2l0eSBvZiB0aGUgcHJvdmlkZWQgZGF0YSBhbmQgZW5zdXJlcyBubyBsb2NhbCBleHRyZW11bXMgYXJlIGFkZGVkCiAgICAgIC8vIGJldHdlZW4gdGhlIGRhdGFzZXQgZGlzY3JldGUgcG9pbnRzIGR1ZSB0byB0aGUgaW50ZXJwb2xhdGlvbi4KICAgICAgLy8gU2VlIDogaHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTW9ub3RvbmVfY3ViaWNfaW50ZXJwb2xhdGlvbgogICAgICB2YXIgcG9pbnRzV2l0aFRhbmdlbnRzID0gKHBvaW50cyB8fCBbXSkubWFwKGZ1bmN0aW9uIChwb2ludCkgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICBtb2RlbDogcG9pbnQuX21vZGVsLAogICAgICAgICAgZGVsdGFLOiAwLAogICAgICAgICAgbUs6IDAKICAgICAgICB9OwogICAgICB9KTsgLy8gQ2FsY3VsYXRlIHNsb3BlcyAoZGVsdGFLKSBhbmQgaW5pdGlhbGl6ZSB0YW5nZW50cyAobUspCgogICAgICB2YXIgcG9pbnRzTGVuID0gcG9pbnRzV2l0aFRhbmdlbnRzLmxlbmd0aDsKICAgICAgdmFyIGksIHBvaW50QmVmb3JlLCBwb2ludEN1cnJlbnQsIHBvaW50QWZ0ZXI7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgcG9pbnRzTGVuOyArK2kpIHsKICAgICAgICBwb2ludEN1cnJlbnQgPSBwb2ludHNXaXRoVGFuZ2VudHNbaV07CgogICAgICAgIGlmIChwb2ludEN1cnJlbnQubW9kZWwuc2tpcCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBwb2ludEJlZm9yZSA9IGkgPiAwID8gcG9pbnRzV2l0aFRhbmdlbnRzW2kgLSAxXSA6IG51bGw7CiAgICAgICAgcG9pbnRBZnRlciA9IGkgPCBwb2ludHNMZW4gLSAxID8gcG9pbnRzV2l0aFRhbmdlbnRzW2kgKyAxXSA6IG51bGw7CgogICAgICAgIGlmIChwb2ludEFmdGVyICYmICFwb2ludEFmdGVyLm1vZGVsLnNraXApIHsKICAgICAgICAgIHZhciBzbG9wZURlbHRhWCA9IHBvaW50QWZ0ZXIubW9kZWwueCAtIHBvaW50Q3VycmVudC5tb2RlbC54OyAvLyBJbiB0aGUgY2FzZSBvZiB0d28gcG9pbnRzIHRoYXQgYXBwZWFyIGF0IHRoZSBzYW1lIHggcGl4ZWwsIHNsb3BlRGVsdGFYIGlzIDAKCiAgICAgICAgICBwb2ludEN1cnJlbnQuZGVsdGFLID0gc2xvcGVEZWx0YVggIT09IDAgPyAocG9pbnRBZnRlci5tb2RlbC55IC0gcG9pbnRDdXJyZW50Lm1vZGVsLnkpIC8gc2xvcGVEZWx0YVggOiAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFwb2ludEJlZm9yZSB8fCBwb2ludEJlZm9yZS5tb2RlbC5za2lwKSB7CiAgICAgICAgICBwb2ludEN1cnJlbnQubUsgPSBwb2ludEN1cnJlbnQuZGVsdGFLOwogICAgICAgIH0gZWxzZSBpZiAoIXBvaW50QWZ0ZXIgfHwgcG9pbnRBZnRlci5tb2RlbC5za2lwKSB7CiAgICAgICAgICBwb2ludEN1cnJlbnQubUsgPSBwb2ludEJlZm9yZS5kZWx0YUs7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnNpZ24ocG9pbnRCZWZvcmUuZGVsdGFLKSAhPT0gdGhpcy5zaWduKHBvaW50Q3VycmVudC5kZWx0YUspKSB7CiAgICAgICAgICBwb2ludEN1cnJlbnQubUsgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwb2ludEN1cnJlbnQubUsgPSAocG9pbnRCZWZvcmUuZGVsdGFLICsgcG9pbnRDdXJyZW50LmRlbHRhSykgLyAyOwogICAgICAgIH0KICAgICAgfSAvLyBBZGp1c3QgdGFuZ2VudHMgdG8gZW5zdXJlIG1vbm90b25pYyBwcm9wZXJ0aWVzCgoKICAgICAgdmFyIGFscGhhSywgYmV0YUssIHRhdUssIHNxdWFyZWRNYWduaXR1ZGU7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgcG9pbnRzTGVuIC0gMTsgKytpKSB7CiAgICAgICAgcG9pbnRDdXJyZW50ID0gcG9pbnRzV2l0aFRhbmdlbnRzW2ldOwogICAgICAgIHBvaW50QWZ0ZXIgPSBwb2ludHNXaXRoVGFuZ2VudHNbaSArIDFdOwoKICAgICAgICBpZiAocG9pbnRDdXJyZW50Lm1vZGVsLnNraXAgfHwgcG9pbnRBZnRlci5tb2RlbC5za2lwKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGlmIChoZWxwZXJzJDEuYWxtb3N0RXF1YWxzKHBvaW50Q3VycmVudC5kZWx0YUssIDAsIHRoaXMuRVBTSUxPTikpIHsKICAgICAgICAgIHBvaW50Q3VycmVudC5tSyA9IHBvaW50QWZ0ZXIubUsgPSAwOwogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBhbHBoYUsgPSBwb2ludEN1cnJlbnQubUsgLyBwb2ludEN1cnJlbnQuZGVsdGFLOwogICAgICAgIGJldGFLID0gcG9pbnRBZnRlci5tSyAvIHBvaW50Q3VycmVudC5kZWx0YUs7CiAgICAgICAgc3F1YXJlZE1hZ25pdHVkZSA9IE1hdGgucG93KGFscGhhSywgMikgKyBNYXRoLnBvdyhiZXRhSywgMik7CgogICAgICAgIGlmIChzcXVhcmVkTWFnbml0dWRlIDw9IDkpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgdGF1SyA9IDMgLyBNYXRoLnNxcnQoc3F1YXJlZE1hZ25pdHVkZSk7CiAgICAgICAgcG9pbnRDdXJyZW50Lm1LID0gYWxwaGFLICogdGF1SyAqIHBvaW50Q3VycmVudC5kZWx0YUs7CiAgICAgICAgcG9pbnRBZnRlci5tSyA9IGJldGFLICogdGF1SyAqIHBvaW50Q3VycmVudC5kZWx0YUs7CiAgICAgIH0gLy8gQ29tcHV0ZSBjb250cm9sIHBvaW50cwoKCiAgICAgIHZhciBkZWx0YVg7CgogICAgICBmb3IgKGkgPSAwOyBpIDwgcG9pbnRzTGVuOyArK2kpIHsKICAgICAgICBwb2ludEN1cnJlbnQgPSBwb2ludHNXaXRoVGFuZ2VudHNbaV07CgogICAgICAgIGlmIChwb2ludEN1cnJlbnQubW9kZWwuc2tpcCkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBwb2ludEJlZm9yZSA9IGkgPiAwID8gcG9pbnRzV2l0aFRhbmdlbnRzW2kgLSAxXSA6IG51bGw7CiAgICAgICAgcG9pbnRBZnRlciA9IGkgPCBwb2ludHNMZW4gLSAxID8gcG9pbnRzV2l0aFRhbmdlbnRzW2kgKyAxXSA6IG51bGw7CgogICAgICAgIGlmIChwb2ludEJlZm9yZSAmJiAhcG9pbnRCZWZvcmUubW9kZWwuc2tpcCkgewogICAgICAgICAgZGVsdGFYID0gKHBvaW50Q3VycmVudC5tb2RlbC54IC0gcG9pbnRCZWZvcmUubW9kZWwueCkgLyAzOwogICAgICAgICAgcG9pbnRDdXJyZW50Lm1vZGVsLmNvbnRyb2xQb2ludFByZXZpb3VzWCA9IHBvaW50Q3VycmVudC5tb2RlbC54IC0gZGVsdGFYOwogICAgICAgICAgcG9pbnRDdXJyZW50Lm1vZGVsLmNvbnRyb2xQb2ludFByZXZpb3VzWSA9IHBvaW50Q3VycmVudC5tb2RlbC55IC0gZGVsdGFYICogcG9pbnRDdXJyZW50Lm1LOwogICAgICAgIH0KCiAgICAgICAgaWYgKHBvaW50QWZ0ZXIgJiYgIXBvaW50QWZ0ZXIubW9kZWwuc2tpcCkgewogICAgICAgICAgZGVsdGFYID0gKHBvaW50QWZ0ZXIubW9kZWwueCAtIHBvaW50Q3VycmVudC5tb2RlbC54KSAvIDM7CiAgICAgICAgICBwb2ludEN1cnJlbnQubW9kZWwuY29udHJvbFBvaW50TmV4dFggPSBwb2ludEN1cnJlbnQubW9kZWwueCArIGRlbHRhWDsKICAgICAgICAgIHBvaW50Q3VycmVudC5tb2RlbC5jb250cm9sUG9pbnROZXh0WSA9IHBvaW50Q3VycmVudC5tb2RlbC55ICsgZGVsdGFYICogcG9pbnRDdXJyZW50Lm1LOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBoZWxwZXJzJDEubmV4dEl0ZW0gPSBmdW5jdGlvbiAoY29sbGVjdGlvbiwgaW5kZXgsIGxvb3ApIHsKICAgICAgaWYgKGxvb3ApIHsKICAgICAgICByZXR1cm4gaW5kZXggPj0gY29sbGVjdGlvbi5sZW5ndGggLSAxID8gY29sbGVjdGlvblswXSA6IGNvbGxlY3Rpb25baW5kZXggKyAxXTsKICAgICAgfQoKICAgICAgcmV0dXJuIGluZGV4ID49IGNvbGxlY3Rpb24ubGVuZ3RoIC0gMSA/IGNvbGxlY3Rpb25bY29sbGVjdGlvbi5sZW5ndGggLSAxXSA6IGNvbGxlY3Rpb25baW5kZXggKyAxXTsKICAgIH07CgogICAgaGVscGVycyQxLnByZXZpb3VzSXRlbSA9IGZ1bmN0aW9uIChjb2xsZWN0aW9uLCBpbmRleCwgbG9vcCkgewogICAgICBpZiAobG9vcCkgewogICAgICAgIHJldHVybiBpbmRleCA8PSAwID8gY29sbGVjdGlvbltjb2xsZWN0aW9uLmxlbmd0aCAtIDFdIDogY29sbGVjdGlvbltpbmRleCAtIDFdOwogICAgICB9CgogICAgICByZXR1cm4gaW5kZXggPD0gMCA/IGNvbGxlY3Rpb25bMF0gOiBjb2xsZWN0aW9uW2luZGV4IC0gMV07CiAgICB9OyAvLyBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgbmljZSBudW1iZXIgYWxnb3JpdGhtIHVzZWQgaW4gZGV0ZXJtaW5pbmcgd2hlcmUgYXhpcyBsYWJlbHMgd2lsbCBnbwoKCiAgICBoZWxwZXJzJDEubmljZU51bSA9IGZ1bmN0aW9uIChyYW5nZSwgcm91bmQpIHsKICAgICAgdmFyIGV4cG9uZW50ID0gTWF0aC5mbG9vcihoZWxwZXJzJDEubG9nMTAocmFuZ2UpKTsKICAgICAgdmFyIGZyYWN0aW9uID0gcmFuZ2UgLyBNYXRoLnBvdygxMCwgZXhwb25lbnQpOwogICAgICB2YXIgbmljZUZyYWN0aW9uOwoKICAgICAgaWYgKHJvdW5kKSB7CiAgICAgICAgaWYgKGZyYWN0aW9uIDwgMS41KSB7CiAgICAgICAgICBuaWNlRnJhY3Rpb24gPSAxOwogICAgICAgIH0gZWxzZSBpZiAoZnJhY3Rpb24gPCAzKSB7CiAgICAgICAgICBuaWNlRnJhY3Rpb24gPSAyOwogICAgICAgIH0gZWxzZSBpZiAoZnJhY3Rpb24gPCA3KSB7CiAgICAgICAgICBuaWNlRnJhY3Rpb24gPSA1OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBuaWNlRnJhY3Rpb24gPSAxMDsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAoZnJhY3Rpb24gPD0gMS4wKSB7CiAgICAgICAgbmljZUZyYWN0aW9uID0gMTsKICAgICAgfSBlbHNlIGlmIChmcmFjdGlvbiA8PSAyKSB7CiAgICAgICAgbmljZUZyYWN0aW9uID0gMjsKICAgICAgfSBlbHNlIGlmIChmcmFjdGlvbiA8PSA1KSB7CiAgICAgICAgbmljZUZyYWN0aW9uID0gNTsKICAgICAgfSBlbHNlIHsKICAgICAgICBuaWNlRnJhY3Rpb24gPSAxMDsKICAgICAgfQoKICAgICAgcmV0dXJuIG5pY2VGcmFjdGlvbiAqIE1hdGgucG93KDEwLCBleHBvbmVudCk7CiAgICB9OyAvLyBSZXF1ZXN0IGFuaW1hdGlvbiBwb2x5ZmlsbCAtIGh0dHBzOi8vd3d3LnBhdWxpcmlzaC5jb20vMjAxMS9yZXF1ZXN0YW5pbWF0aW9uZnJhbWUtZm9yLXNtYXJ0LWFuaW1hdGluZy8KCgogICAgaGVscGVycyQxLnJlcXVlc3RBbmltRnJhbWUgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAndW5kZWZpbmVkJykgewogICAgICAgIHJldHVybiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgIGNhbGxiYWNrKCk7CiAgICAgICAgfTsKICAgICAgfQoKICAgICAgcmV0dXJuIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSB8fCB3aW5kb3cubW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IHdpbmRvdy5vUmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8IHdpbmRvdy5tc1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fCBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICByZXR1cm4gd2luZG93LnNldFRpbWVvdXQoY2FsbGJhY2ssIDEwMDAgLyA2MCk7CiAgICAgIH07CiAgICB9KCk7IC8vIC0tIERPTSBtZXRob2RzCgoKICAgIGhlbHBlcnMkMS5nZXRSZWxhdGl2ZVBvc2l0aW9uID0gZnVuY3Rpb24gKGV2dCwgY2hhcnQpIHsKICAgICAgdmFyIG1vdXNlWCwgbW91c2VZOwogICAgICB2YXIgZSA9IGV2dC5vcmlnaW5hbEV2ZW50IHx8IGV2dDsKICAgICAgdmFyIGNhbnZhcyA9IGV2dC50YXJnZXQgfHwgZXZ0LnNyY0VsZW1lbnQ7CiAgICAgIHZhciBib3VuZGluZ1JlY3QgPSBjYW52YXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICAgIHZhciB0b3VjaGVzID0gZS50b3VjaGVzOwoKICAgICAgaWYgKHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPiAwKSB7CiAgICAgICAgbW91c2VYID0gdG91Y2hlc1swXS5jbGllbnRYOwogICAgICAgIG1vdXNlWSA9IHRvdWNoZXNbMF0uY2xpZW50WTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtb3VzZVggPSBlLmNsaWVudFg7CiAgICAgICAgbW91c2VZID0gZS5jbGllbnRZOwogICAgICB9IC8vIFNjYWxlIG1vdXNlIGNvb3JkaW5hdGVzIGludG8gY2FudmFzIGNvb3JkaW5hdGVzCiAgICAgIC8vIGJ5IGZvbGxvd2luZyB0aGUgcGF0dGVybiBsYWlkIG91dCBieSAnamVycnlqJyBpbiB0aGUgY29tbWVudHMgb2YKICAgICAgLy8gaHR0cHM6Ly93d3cuaHRtbDVjYW52YXN0dXRvcmlhbHMuY29tL2FkdmFuY2VkL2h0bWw1LWNhbnZhcy1tb3VzZS1jb29yZGluYXRlcy8KCgogICAgICB2YXIgcGFkZGluZ0xlZnQgPSBwYXJzZUZsb2F0KGhlbHBlcnMkMS5nZXRTdHlsZShjYW52YXMsICdwYWRkaW5nLWxlZnQnKSk7CiAgICAgIHZhciBwYWRkaW5nVG9wID0gcGFyc2VGbG9hdChoZWxwZXJzJDEuZ2V0U3R5bGUoY2FudmFzLCAncGFkZGluZy10b3AnKSk7CiAgICAgIHZhciBwYWRkaW5nUmlnaHQgPSBwYXJzZUZsb2F0KGhlbHBlcnMkMS5nZXRTdHlsZShjYW52YXMsICdwYWRkaW5nLXJpZ2h0JykpOwogICAgICB2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoaGVscGVycyQxLmdldFN0eWxlKGNhbnZhcywgJ3BhZGRpbmctYm90dG9tJykpOwogICAgICB2YXIgd2lkdGggPSBib3VuZGluZ1JlY3QucmlnaHQgLSBib3VuZGluZ1JlY3QubGVmdCAtIHBhZGRpbmdMZWZ0IC0gcGFkZGluZ1JpZ2h0OwogICAgICB2YXIgaGVpZ2h0ID0gYm91bmRpbmdSZWN0LmJvdHRvbSAtIGJvdW5kaW5nUmVjdC50b3AgLSBwYWRkaW5nVG9wIC0gcGFkZGluZ0JvdHRvbTsgLy8gV2UgZGl2aWRlIGJ5IHRoZSBjdXJyZW50IGRldmljZSBwaXhlbCByYXRpbywgYmVjYXVzZSB0aGUgY2FudmFzIGlzIHNjYWxlZCB1cCBieSB0aGF0IGFtb3VudCBpbiBlYWNoIGRpcmVjdGlvbi4gSG93ZXZlcgogICAgICAvLyB0aGUgYmFja2VuZCBtb2RlbCBpcyBpbiB1bnNjYWxlZCBjb29yZGluYXRlcy4gU2luY2Ugd2UgYXJlIGdvaW5nIHRvIGRlYWwgd2l0aCBvdXIgbW9kZWwgY29vcmRpbmF0ZXMsIHdlIGdvIGJhY2sgaGVyZQoKICAgICAgbW91c2VYID0gTWF0aC5yb3VuZCgobW91c2VYIC0gYm91bmRpbmdSZWN0LmxlZnQgLSBwYWRkaW5nTGVmdCkgLyB3aWR0aCAqIGNhbnZhcy53aWR0aCAvIGNoYXJ0LmN1cnJlbnREZXZpY2VQaXhlbFJhdGlvKTsKICAgICAgbW91c2VZID0gTWF0aC5yb3VuZCgobW91c2VZIC0gYm91bmRpbmdSZWN0LnRvcCAtIHBhZGRpbmdUb3ApIC8gaGVpZ2h0ICogY2FudmFzLmhlaWdodCAvIGNoYXJ0LmN1cnJlbnREZXZpY2VQaXhlbFJhdGlvKTsKICAgICAgcmV0dXJuIHsKICAgICAgICB4OiBtb3VzZVgsCiAgICAgICAgeTogbW91c2VZCiAgICAgIH07CiAgICB9OyAvLyBQcml2YXRlIGhlbHBlciBmdW5jdGlvbiB0byBjb252ZXJ0IG1heC13aWR0aC9tYXgtaGVpZ2h0IHZhbHVlcyB0aGF0IG1heSBiZSBwZXJjZW50YWdlcyBpbnRvIGEgbnVtYmVyCgoKICAgIGZ1bmN0aW9uIHBhcnNlTWF4U3R5bGUoc3R5bGVWYWx1ZSwgbm9kZSwgcGFyZW50UHJvcGVydHkpIHsKICAgICAgdmFyIHZhbHVlSW5QaXhlbHM7CgogICAgICBpZiAodHlwZW9mIHN0eWxlVmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdmFsdWVJblBpeGVscyA9IHBhcnNlSW50KHN0eWxlVmFsdWUsIDEwKTsKCiAgICAgICAgaWYgKHN0eWxlVmFsdWUuaW5kZXhPZignJScpICE9PSAtMSkgewogICAgICAgICAgLy8gcGVyY2VudGFnZSAqIHNpemUgaW4gZGltZW5zaW9uCiAgICAgICAgICB2YWx1ZUluUGl4ZWxzID0gdmFsdWVJblBpeGVscyAvIDEwMCAqIG5vZGUucGFyZW50Tm9kZVtwYXJlbnRQcm9wZXJ0eV07CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHZhbHVlSW5QaXhlbHMgPSBzdHlsZVZhbHVlOwogICAgICB9CgogICAgICByZXR1cm4gdmFsdWVJblBpeGVsczsKICAgIH0KICAgIC8qKg0KICAgICAqIFJldHVybnMgaWYgdGhlIGdpdmVuIHZhbHVlIGNvbnRhaW5zIGFuIGVmZmVjdGl2ZSBjb25zdHJhaW50Lg0KICAgICAqIEBwcml2YXRlDQogICAgICovCgoKICAgIGZ1bmN0aW9uIGlzQ29uc3RyYWluZWRWYWx1ZSh2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gJ25vbmUnOwogICAgfQogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgbWF4IHdpZHRoIG9yIGhlaWdodCBvZiB0aGUgZ2l2ZW4gRE9NIG5vZGUgaW4gYSBjcm9zcy1icm93c2VyIGNvbXBhdGlibGUgZmFzaGlvbg0KICAgICAqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IGRvbU5vZGUgLSB0aGUgbm9kZSB0byBjaGVjayB0aGUgY29uc3RyYWludCBvbg0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBtYXhTdHlsZSAtIHRoZSBzdHlsZSB0aGF0IGRlZmluZXMgdGhlIG1heGltdW0gZm9yIHRoZSBkaXJlY3Rpb24gd2UgYXJlIHVzaW5nICgnbWF4LXdpZHRoJyAvICdtYXgtaGVpZ2h0JykNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGVyY2VudGFnZVByb3BlcnR5IC0gcHJvcGVydHkgb2YgcGFyZW50IHRvIHVzZSB3aGVuIGNhbGN1bGF0aW5nIHdpZHRoIGFzIGEgcGVyY2VudGFnZQ0KICAgICAqIEBzZWUge0BsaW5rIGh0dHBzOi8vd3d3Lm5hdGhhbmFlbGpvbmVzLmNvbS9ibG9nLzIwMTMvcmVhZGluZy1tYXgtd2lkdGgtY3Jvc3MtYnJvd3Nlcn0NCiAgICAgKi8KCgogICAgZnVuY3Rpb24gZ2V0Q29uc3RyYWludERpbWVuc2lvbihkb21Ob2RlLCBtYXhTdHlsZSwgcGVyY2VudGFnZVByb3BlcnR5KSB7CiAgICAgIHZhciB2aWV3ID0gZG9jdW1lbnQuZGVmYXVsdFZpZXc7CgogICAgICB2YXIgcGFyZW50Tm9kZSA9IGhlbHBlcnMkMS5fZ2V0UGFyZW50Tm9kZShkb21Ob2RlKTsKCiAgICAgIHZhciBjb25zdHJhaW5lZE5vZGUgPSB2aWV3LmdldENvbXB1dGVkU3R5bGUoZG9tTm9kZSlbbWF4U3R5bGVdOwogICAgICB2YXIgY29uc3RyYWluZWRDb250YWluZXIgPSB2aWV3LmdldENvbXB1dGVkU3R5bGUocGFyZW50Tm9kZSlbbWF4U3R5bGVdOwogICAgICB2YXIgaGFzQ05vZGUgPSBpc0NvbnN0cmFpbmVkVmFsdWUoY29uc3RyYWluZWROb2RlKTsKICAgICAgdmFyIGhhc0NDb250YWluZXIgPSBpc0NvbnN0cmFpbmVkVmFsdWUoY29uc3RyYWluZWRDb250YWluZXIpOwogICAgICB2YXIgaW5maW5pdHkgPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CgogICAgICBpZiAoaGFzQ05vZGUgfHwgaGFzQ0NvbnRhaW5lcikgewogICAgICAgIHJldHVybiBNYXRoLm1pbihoYXNDTm9kZSA/IHBhcnNlTWF4U3R5bGUoY29uc3RyYWluZWROb2RlLCBkb21Ob2RlLCBwZXJjZW50YWdlUHJvcGVydHkpIDogaW5maW5pdHksIGhhc0NDb250YWluZXIgPyBwYXJzZU1heFN0eWxlKGNvbnN0cmFpbmVkQ29udGFpbmVyLCBwYXJlbnROb2RlLCBwZXJjZW50YWdlUHJvcGVydHkpIDogaW5maW5pdHkpOwogICAgICB9CgogICAgICByZXR1cm4gJ25vbmUnOwogICAgfSAvLyByZXR1cm5zIE51bWJlciBvciB1bmRlZmluZWQgaWYgbm8gY29uc3RyYWludAoKCiAgICBoZWxwZXJzJDEuZ2V0Q29uc3RyYWludFdpZHRoID0gZnVuY3Rpb24gKGRvbU5vZGUpIHsKICAgICAgcmV0dXJuIGdldENvbnN0cmFpbnREaW1lbnNpb24oZG9tTm9kZSwgJ21heC13aWR0aCcsICdjbGllbnRXaWR0aCcpOwogICAgfTsgLy8gcmV0dXJucyBOdW1iZXIgb3IgdW5kZWZpbmVkIGlmIG5vIGNvbnN0cmFpbnQKCgogICAgaGVscGVycyQxLmdldENvbnN0cmFpbnRIZWlnaHQgPSBmdW5jdGlvbiAoZG9tTm9kZSkgewogICAgICByZXR1cm4gZ2V0Q29uc3RyYWludERpbWVuc2lvbihkb21Ob2RlLCAnbWF4LWhlaWdodCcsICdjbGllbnRIZWlnaHQnKTsKICAgIH07CiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgIAkgKi8KCgogICAgaGVscGVycyQxLl9jYWxjdWxhdGVQYWRkaW5nID0gZnVuY3Rpb24gKGNvbnRhaW5lciwgcGFkZGluZywgcGFyZW50RGltZW5zaW9uKSB7CiAgICAgIHBhZGRpbmcgPSBoZWxwZXJzJDEuZ2V0U3R5bGUoY29udGFpbmVyLCBwYWRkaW5nKTsKICAgICAgcmV0dXJuIHBhZGRpbmcuaW5kZXhPZignJScpID4gLTEgPyBwYXJlbnREaW1lbnNpb24gKiBwYXJzZUludChwYWRkaW5nLCAxMCkgLyAxMDAgOiBwYXJzZUludChwYWRkaW5nLCAxMCk7CiAgICB9OwogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KCgogICAgaGVscGVycyQxLl9nZXRQYXJlbnROb2RlID0gZnVuY3Rpb24gKGRvbU5vZGUpIHsKICAgICAgdmFyIHBhcmVudCA9IGRvbU5vZGUucGFyZW50Tm9kZTsKCiAgICAgIGlmIChwYXJlbnQgJiYgcGFyZW50LnRvU3RyaW5nKCkgPT09ICdbb2JqZWN0IFNoYWRvd1Jvb3RdJykgewogICAgICAgIHBhcmVudCA9IHBhcmVudC5ob3N0OwogICAgICB9CgogICAgICByZXR1cm4gcGFyZW50OwogICAgfTsKCiAgICBoZWxwZXJzJDEuZ2V0TWF4aW11bVdpZHRoID0gZnVuY3Rpb24gKGRvbU5vZGUpIHsKICAgICAgdmFyIGNvbnRhaW5lciA9IGhlbHBlcnMkMS5fZ2V0UGFyZW50Tm9kZShkb21Ob2RlKTsKCiAgICAgIGlmICghY29udGFpbmVyKSB7CiAgICAgICAgcmV0dXJuIGRvbU5vZGUuY2xpZW50V2lkdGg7CiAgICAgIH0KCiAgICAgIHZhciBjbGllbnRXaWR0aCA9IGNvbnRhaW5lci5jbGllbnRXaWR0aDsKCiAgICAgIHZhciBwYWRkaW5nTGVmdCA9IGhlbHBlcnMkMS5fY2FsY3VsYXRlUGFkZGluZyhjb250YWluZXIsICdwYWRkaW5nLWxlZnQnLCBjbGllbnRXaWR0aCk7CgogICAgICB2YXIgcGFkZGluZ1JpZ2h0ID0gaGVscGVycyQxLl9jYWxjdWxhdGVQYWRkaW5nKGNvbnRhaW5lciwgJ3BhZGRpbmctcmlnaHQnLCBjbGllbnRXaWR0aCk7CgogICAgICB2YXIgdyA9IGNsaWVudFdpZHRoIC0gcGFkZGluZ0xlZnQgLSBwYWRkaW5nUmlnaHQ7CiAgICAgIHZhciBjdyA9IGhlbHBlcnMkMS5nZXRDb25zdHJhaW50V2lkdGgoZG9tTm9kZSk7CiAgICAgIHJldHVybiBpc05hTihjdykgPyB3IDogTWF0aC5taW4odywgY3cpOwogICAgfTsKCiAgICBoZWxwZXJzJDEuZ2V0TWF4aW11bUhlaWdodCA9IGZ1bmN0aW9uIChkb21Ob2RlKSB7CiAgICAgIHZhciBjb250YWluZXIgPSBoZWxwZXJzJDEuX2dldFBhcmVudE5vZGUoZG9tTm9kZSk7CgogICAgICBpZiAoIWNvbnRhaW5lcikgewogICAgICAgIHJldHVybiBkb21Ob2RlLmNsaWVudEhlaWdodDsKICAgICAgfQoKICAgICAgdmFyIGNsaWVudEhlaWdodCA9IGNvbnRhaW5lci5jbGllbnRIZWlnaHQ7CgogICAgICB2YXIgcGFkZGluZ1RvcCA9IGhlbHBlcnMkMS5fY2FsY3VsYXRlUGFkZGluZyhjb250YWluZXIsICdwYWRkaW5nLXRvcCcsIGNsaWVudEhlaWdodCk7CgogICAgICB2YXIgcGFkZGluZ0JvdHRvbSA9IGhlbHBlcnMkMS5fY2FsY3VsYXRlUGFkZGluZyhjb250YWluZXIsICdwYWRkaW5nLWJvdHRvbScsIGNsaWVudEhlaWdodCk7CgogICAgICB2YXIgaCA9IGNsaWVudEhlaWdodCAtIHBhZGRpbmdUb3AgLSBwYWRkaW5nQm90dG9tOwogICAgICB2YXIgY2ggPSBoZWxwZXJzJDEuZ2V0Q29uc3RyYWludEhlaWdodChkb21Ob2RlKTsKICAgICAgcmV0dXJuIGlzTmFOKGNoKSA/IGggOiBNYXRoLm1pbihoLCBjaCk7CiAgICB9OwoKICAgIGhlbHBlcnMkMS5nZXRTdHlsZSA9IGZ1bmN0aW9uIChlbCwgcHJvcGVydHkpIHsKICAgICAgcmV0dXJuIGVsLmN1cnJlbnRTdHlsZSA/IGVsLmN1cnJlbnRTdHlsZVtwcm9wZXJ0eV0gOiBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKGVsLCBudWxsKS5nZXRQcm9wZXJ0eVZhbHVlKHByb3BlcnR5KTsKICAgIH07CgogICAgaGVscGVycyQxLnJldGluYVNjYWxlID0gZnVuY3Rpb24gKGNoYXJ0LCBmb3JjZVJhdGlvKSB7CiAgICAgIHZhciBwaXhlbFJhdGlvID0gY2hhcnQuY3VycmVudERldmljZVBpeGVsUmF0aW8gPSBmb3JjZVJhdGlvIHx8IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5kZXZpY2VQaXhlbFJhdGlvIHx8IDE7CgogICAgICBpZiAocGl4ZWxSYXRpbyA9PT0gMSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGNhbnZhcyA9IGNoYXJ0LmNhbnZhczsKICAgICAgdmFyIGhlaWdodCA9IGNoYXJ0LmhlaWdodDsKICAgICAgdmFyIHdpZHRoID0gY2hhcnQud2lkdGg7CiAgICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQgKiBwaXhlbFJhdGlvOwogICAgICBjYW52YXMud2lkdGggPSB3aWR0aCAqIHBpeGVsUmF0aW87CiAgICAgIGNoYXJ0LmN0eC5zY2FsZShwaXhlbFJhdGlvLCBwaXhlbFJhdGlvKTsgLy8gSWYgbm8gc3R5bGUgaGFzIGJlZW4gc2V0IG9uIHRoZSBjYW52YXMsIHRoZSByZW5kZXIgc2l6ZSBpcyB1c2VkIGFzIGRpc3BsYXkgc2l6ZSwKICAgICAgLy8gbWFraW5nIHRoZSBjaGFydCB2aXN1YWxseSBiaWdnZXIsIHNvIGxldCdzIGVuZm9yY2UgaXQgdG8gdGhlICJjb3JyZWN0IiB2YWx1ZXMuCiAgICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9pc3N1ZXMvMzU3NQoKICAgICAgaWYgKCFjYW52YXMuc3R5bGUuaGVpZ2h0ICYmICFjYW52YXMuc3R5bGUud2lkdGgpIHsKICAgICAgICBjYW52YXMuc3R5bGUuaGVpZ2h0ID0gaGVpZ2h0ICsgJ3B4JzsKICAgICAgICBjYW52YXMuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICAgIH0KICAgIH07IC8vIC0tIENhbnZhcyBtZXRob2RzCgoKICAgIGhlbHBlcnMkMS5mb250U3RyaW5nID0gZnVuY3Rpb24gKHBpeGVsU2l6ZSwgZm9udFN0eWxlLCBmb250RmFtaWx5KSB7CiAgICAgIHJldHVybiBmb250U3R5bGUgKyAnICcgKyBwaXhlbFNpemUgKyAncHggJyArIGZvbnRGYW1pbHk7CiAgICB9OwoKICAgIGhlbHBlcnMkMS5sb25nZXN0VGV4dCA9IGZ1bmN0aW9uIChjdHgsIGZvbnQsIGFycmF5T2ZUaGluZ3MsIGNhY2hlKSB7CiAgICAgIGNhY2hlID0gY2FjaGUgfHwge307CiAgICAgIHZhciBkYXRhID0gY2FjaGUuZGF0YSA9IGNhY2hlLmRhdGEgfHwge307CiAgICAgIHZhciBnYyA9IGNhY2hlLmdhcmJhZ2VDb2xsZWN0ID0gY2FjaGUuZ2FyYmFnZUNvbGxlY3QgfHwgW107CgogICAgICBpZiAoY2FjaGUuZm9udCAhPT0gZm9udCkgewogICAgICAgIGRhdGEgPSBjYWNoZS5kYXRhID0ge307CiAgICAgICAgZ2MgPSBjYWNoZS5nYXJiYWdlQ29sbGVjdCA9IFtdOwogICAgICAgIGNhY2hlLmZvbnQgPSBmb250OwogICAgICB9CgogICAgICBjdHguZm9udCA9IGZvbnQ7CiAgICAgIHZhciBsb25nZXN0ID0gMDsKICAgICAgdmFyIGlsZW4gPSBhcnJheU9mVGhpbmdzLmxlbmd0aDsKICAgICAgdmFyIGksIGosIGpsZW4sIHRoaW5nLCBuZXN0ZWRUaGluZzsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBpbGVuOyBpKyspIHsKICAgICAgICB0aGluZyA9IGFycmF5T2ZUaGluZ3NbaV07IC8vIFVuZGVmaW5lZCBzdHJpbmdzIGFuZCBhcnJheXMgc2hvdWxkIG5vdCBiZSBtZWFzdXJlZAoKICAgICAgICBpZiAodGhpbmcgIT09IHVuZGVmaW5lZCAmJiB0aGluZyAhPT0gbnVsbCAmJiBoZWxwZXJzJDEuaXNBcnJheSh0aGluZykgIT09IHRydWUpIHsKICAgICAgICAgIGxvbmdlc3QgPSBoZWxwZXJzJDEubWVhc3VyZVRleHQoY3R4LCBkYXRhLCBnYywgbG9uZ2VzdCwgdGhpbmcpOwogICAgICAgIH0gZWxzZSBpZiAoaGVscGVycyQxLmlzQXJyYXkodGhpbmcpKSB7CiAgICAgICAgICAvLyBpZiBpdCBpcyBhbiBhcnJheSBsZXRzIG1lYXN1cmUgZWFjaCBlbGVtZW50CiAgICAgICAgICAvLyB0byBkbyBtYXliZSBzaW1wbGlmeSB0aGlzIGZ1bmN0aW9uIGEgYml0IHNvIHdlIGNhbiBkbyB0aGlzIG1vcmUgcmVjdXJzaXZlbHk/CiAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gdGhpbmcubGVuZ3RoOyBqIDwgamxlbjsgaisrKSB7CiAgICAgICAgICAgIG5lc3RlZFRoaW5nID0gdGhpbmdbal07IC8vIFVuZGVmaW5lZCBzdHJpbmdzIGFuZCBhcnJheXMgc2hvdWxkIG5vdCBiZSBtZWFzdXJlZAoKICAgICAgICAgICAgaWYgKG5lc3RlZFRoaW5nICE9PSB1bmRlZmluZWQgJiYgbmVzdGVkVGhpbmcgIT09IG51bGwgJiYgIWhlbHBlcnMkMS5pc0FycmF5KG5lc3RlZFRoaW5nKSkgewogICAgICAgICAgICAgIGxvbmdlc3QgPSBoZWxwZXJzJDEubWVhc3VyZVRleHQoY3R4LCBkYXRhLCBnYywgbG9uZ2VzdCwgbmVzdGVkVGhpbmcpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB2YXIgZ2NMZW4gPSBnYy5sZW5ndGggLyAyOwoKICAgICAgaWYgKGdjTGVuID4gYXJyYXlPZlRoaW5ncy5sZW5ndGgpIHsKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgZ2NMZW47IGkrKykgewogICAgICAgICAgZGVsZXRlIGRhdGFbZ2NbaV1dOwogICAgICAgIH0KCiAgICAgICAgZ2Muc3BsaWNlKDAsIGdjTGVuKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGxvbmdlc3Q7CiAgICB9OwoKICAgIGhlbHBlcnMkMS5tZWFzdXJlVGV4dCA9IGZ1bmN0aW9uIChjdHgsIGRhdGEsIGdjLCBsb25nZXN0LCBzdHJpbmcpIHsKICAgICAgdmFyIHRleHRXaWR0aCA9IGRhdGFbc3RyaW5nXTsKCiAgICAgIGlmICghdGV4dFdpZHRoKSB7CiAgICAgICAgdGV4dFdpZHRoID0gZGF0YVtzdHJpbmddID0gY3R4Lm1lYXN1cmVUZXh0KHN0cmluZykud2lkdGg7CiAgICAgICAgZ2MucHVzaChzdHJpbmcpOwogICAgICB9CgogICAgICBpZiAodGV4dFdpZHRoID4gbG9uZ2VzdCkgewogICAgICAgIGxvbmdlc3QgPSB0ZXh0V2lkdGg7CiAgICAgIH0KCiAgICAgIHJldHVybiBsb25nZXN0OwogICAgfTsKICAgIC8qKg0KICAgICAqIEBkZXByZWNhdGVkDQogICAgICovCgoKICAgIGhlbHBlcnMkMS5udW1iZXJPZkxhYmVsTGluZXMgPSBmdW5jdGlvbiAoYXJyYXlPZlRoaW5ncykgewogICAgICB2YXIgbnVtYmVyT2ZMaW5lcyA9IDE7CiAgICAgIGhlbHBlcnMkMS5lYWNoKGFycmF5T2ZUaGluZ3MsIGZ1bmN0aW9uICh0aGluZykgewogICAgICAgIGlmIChoZWxwZXJzJDEuaXNBcnJheSh0aGluZykpIHsKICAgICAgICAgIGlmICh0aGluZy5sZW5ndGggPiBudW1iZXJPZkxpbmVzKSB7CiAgICAgICAgICAgIG51bWJlck9mTGluZXMgPSB0aGluZy5sZW5ndGg7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIG51bWJlck9mTGluZXM7CiAgICB9OwoKICAgIGhlbHBlcnMkMS5jb2xvciA9ICFjaGFydGpzQ29sb3IgPyBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgY29uc29sZS5lcnJvcignQ29sb3IuanMgbm90IGZvdW5kIScpOwogICAgICByZXR1cm4gdmFsdWU7CiAgICB9IDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgIC8qIGdsb2JhbCBDYW52YXNHcmFkaWVudCAqLwogICAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBDYW52YXNHcmFkaWVudCkgewogICAgICAgIHZhbHVlID0gY29yZV9kZWZhdWx0cy5nbG9iYWwuZGVmYXVsdENvbG9yOwogICAgICB9CgogICAgICByZXR1cm4gY2hhcnRqc0NvbG9yKHZhbHVlKTsKICAgIH07CgogICAgaGVscGVycyQxLmdldEhvdmVyQ29sb3IgPSBmdW5jdGlvbiAoY29sb3JWYWx1ZSkgewogICAgICAvKiBnbG9iYWwgQ2FudmFzUGF0dGVybiAqLwogICAgICByZXR1cm4gY29sb3JWYWx1ZSBpbnN0YW5jZW9mIENhbnZhc1BhdHRlcm4gfHwgY29sb3JWYWx1ZSBpbnN0YW5jZW9mIENhbnZhc0dyYWRpZW50ID8gY29sb3JWYWx1ZSA6IGhlbHBlcnMkMS5jb2xvcihjb2xvclZhbHVlKS5zYXR1cmF0ZSgwLjUpLmRhcmtlbigwLjEpLnJnYlN0cmluZygpOwogICAgfTsKICB9OwoKICBmdW5jdGlvbiBhYnN0cmFjdCgpIHsKICAgIHRocm93IG5ldyBFcnJvcignVGhpcyBtZXRob2QgaXMgbm90IGltcGxlbWVudGVkOiBlaXRoZXIgbm8gYWRhcHRlciBjYW4gJyArICdiZSBmb3VuZCBvciBhbiBpbmNvbXBsZXRlIGludGVncmF0aW9uIHdhcyBwcm92aWRlZC4nKTsKICB9CiAgLyoqDQogICAqIERhdGUgYWRhcHRlciAoY3VycmVudCB1c2VkIGJ5IHRoZSB0aW1lIHNjYWxlKQ0KICAgKiBAbmFtZXNwYWNlIENoYXJ0Ll9hZGFwdGVycy5fZGF0ZQ0KICAgKiBAbWVtYmVyb2YgQ2hhcnQuX2FkYXB0ZXJzDQogICAqIEBwcml2YXRlDQogICAqLwoKICAvKioNCiAgICogQ3VycmVudGx5IHN1cHBvcnRlZCB1bml0IHN0cmluZyB2YWx1ZXMuDQogICAqIEB0eXBlZGVmIHsoJ21pbGxpc2Vjb25kJ3wnc2Vjb25kJ3wnbWludXRlJ3wnaG91cid8J2RheSd8J3dlZWsnfCdtb250aCd8J3F1YXJ0ZXInfCd5ZWFyJyl9DQogICAqIEBtZW1iZXJvZiBDaGFydC5fYWRhcHRlcnMuX2RhdGUNCiAgICogQG5hbWUgVW5pdA0KICAgKi8KCiAgLyoqDQogICAqIEBjbGFzcw0KICAgKi8KCgogIGZ1bmN0aW9uIERhdGVBZGFwdGVyKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgfQoKICBoZWxwZXJzJDEuZXh0ZW5kKERhdGVBZGFwdGVyLnByb3RvdHlwZSwKICAvKiogQGxlbmRzIERhdGVBZGFwdGVyICovCiAgewogICAgLyoqDQogICAgICogUmV0dXJucyBhIG1hcCBvZiB0aW1lIGZvcm1hdHMgZm9yIHRoZSBzdXBwb3J0ZWQgZm9ybWF0dGluZyB1bml0cyBkZWZpbmVkDQogICAgICogaW4gVW5pdCBhcyB3ZWxsIGFzICdkYXRldGltZScgcmVwcmVzZW50aW5nIGEgZGV0YWlsZWQgZGF0ZS90aW1lIHN0cmluZy4NCiAgICAgKiBAcmV0dXJucyB7e3N0cmluZzogc3RyaW5nfX0NCiAgICAgKi8KICAgIGZvcm1hdHM6IGFic3RyYWN0LAoKICAgIC8qKg0KICAgICAqIFBhcnNlcyB0aGUgZ2l2ZW4gYHZhbHVlYCBhbmQgcmV0dXJuIHRoZSBhc3NvY2lhdGVkIHRpbWVzdGFtcC4NCiAgICAgKiBAcGFyYW0ge2FueX0gdmFsdWUgLSB0aGUgdmFsdWUgdG8gcGFyc2UgKHVzdWFsbHkgY29tZXMgZnJvbSB0aGUgZGF0YSkNCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2Zvcm1hdF0gLSB0aGUgZXhwZWN0ZWQgZGF0YSBmb3JtYXQNCiAgICAgKiBAcmV0dXJucyB7KG51bWJlcnxudWxsKX0NCiAgICAgKiBAZnVuY3Rpb24NCiAgICAgKi8KICAgIHBhcnNlOiBhYnN0cmFjdCwKCiAgICAvKioNCiAgICAgKiBSZXR1cm5zIHRoZSBmb3JtYXR0ZWQgZGF0ZSBpbiB0aGUgc3BlY2lmaWVkIGBmb3JtYXRgIGZvciBhIGdpdmVuIGB0aW1lc3RhbXBgLg0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lc3RhbXAgLSB0aGUgdGltZXN0YW1wIHRvIGZvcm1hdA0KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBmb3JtYXQgLSB0aGUgZGF0ZS90aW1lIHRva2VuDQogICAgICogQHJldHVybiB7c3RyaW5nfQ0KICAgICAqIEBmdW5jdGlvbg0KICAgICAqLwogICAgZm9ybWF0OiBhYnN0cmFjdCwKCiAgICAvKioNCiAgICAgKiBBZGRzIHRoZSBzcGVjaWZpZWQgYGFtb3VudGAgb2YgYHVuaXRgIHRvIHRoZSBnaXZlbiBgdGltZXN0YW1wYC4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdGltZXN0YW1wIC0gdGhlIGlucHV0IHRpbWVzdGFtcA0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSB0aGUgYW1vdW50IHRvIGFkZA0KICAgICAqIEBwYXJhbSB7VW5pdH0gdW5pdCAtIHRoZSB1bml0IGFzIHN0cmluZw0KICAgICAqIEByZXR1cm4ge251bWJlcn0NCiAgICAgKiBAZnVuY3Rpb24NCiAgICAgKi8KICAgIGFkZDogYWJzdHJhY3QsCgogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgbnVtYmVyIG9mIGB1bml0YCBiZXR3ZWVuIHRoZSBnaXZlbiB0aW1lc3RhbXBzLg0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSB0aGUgaW5wdXQgdGltZXN0YW1wIChyZWZlcmVuY2UpDQogICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIHRoZSB0aW1lc3RhbXAgdG8gc3Vic3RyYWN0DQogICAgICogQHBhcmFtIHtVbml0fSB1bml0IC0gdGhlIHVuaXQgYXMgc3RyaW5nDQogICAgICogQHJldHVybiB7bnVtYmVyfQ0KICAgICAqIEBmdW5jdGlvbg0KICAgICAqLwogICAgZGlmZjogYWJzdHJhY3QsCgogICAgLyoqDQogICAgICogUmV0dXJucyBzdGFydCBvZiBgdW5pdGAgZm9yIHRoZSBnaXZlbiBgdGltZXN0YW1wYC4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdGltZXN0YW1wIC0gdGhlIGlucHV0IHRpbWVzdGFtcA0KICAgICAqIEBwYXJhbSB7VW5pdH0gdW5pdCAtIHRoZSB1bml0IGFzIHN0cmluZw0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbd2Vla2RheV0gLSB0aGUgSVNPIGRheSBvZiB0aGUgd2VlayB3aXRoIDEgYmVpbmcgTW9uZGF5DQogICAgICogYW5kIDcgYmVpbmcgU3VuZGF5IChvbmx5IG5lZWRlZCBpZiBwYXJhbSAqdW5pdCogaXMgYGlzb1dlZWtgKS4NCiAgICAgKiBAZnVuY3Rpb24NCiAgICAgKi8KICAgIHN0YXJ0T2Y6IGFic3RyYWN0LAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgZW5kIG9mIGB1bml0YCBmb3IgdGhlIGdpdmVuIGB0aW1lc3RhbXBgLg0KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aW1lc3RhbXAgLSB0aGUgaW5wdXQgdGltZXN0YW1wDQogICAgICogQHBhcmFtIHtVbml0fSB1bml0IC0gdGhlIHVuaXQgYXMgc3RyaW5nDQogICAgICogQGZ1bmN0aW9uDQogICAgICovCiAgICBlbmRPZjogYWJzdHJhY3QsCiAgICAvLyBERVBSRUNBVElPTlMKCiAgICAvKioNCiAgICAgKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSBmb3Igc2NhbGUuZ2V0VmFsdWVGb3JQaXhlbCgpLA0KICAgICAqIHRoaXMgbWV0aG9kIHNob3VsZCBiZSBvdmVycmlkZGVuIG9ubHkgYnkgdGhlIG1vbWVudCBhZGFwdGVyLg0KICAgICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi44LjANCiAgICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9jcmVhdGU6IGZ1bmN0aW9uIF9jcmVhdGUodmFsdWUpIHsKICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQogIH0pOwoKICBEYXRlQWRhcHRlci5vdmVycmlkZSA9IGZ1bmN0aW9uIChtZW1iZXJzKSB7CiAgICBoZWxwZXJzJDEuZXh0ZW5kKERhdGVBZGFwdGVyLnByb3RvdHlwZSwgbWVtYmVycyk7CiAgfTsKCiAgdmFyIF9kYXRlID0gRGF0ZUFkYXB0ZXI7CiAgdmFyIGNvcmVfYWRhcHRlcnMgPSB7CiAgICBfZGF0ZTogX2RhdGUKICB9OwogIC8qKg0KICAgKiBOYW1lc3BhY2UgdG8gaG9sZCBzdGF0aWMgdGljayBnZW5lcmF0aW9uIGZ1bmN0aW9ucw0KICAgKiBAbmFtZXNwYWNlIENoYXJ0LlRpY2tzDQogICAqLwoKICB2YXIgY29yZV90aWNrcyA9IHsKICAgIC8qKg0KICAgICAqIE5hbWVzcGFjZSB0byBob2xkIGZvcm1hdHRlcnMgZm9yIGRpZmZlcmVudCB0eXBlcyBvZiB0aWNrcw0KICAgICAqIEBuYW1lc3BhY2UgQ2hhcnQuVGlja3MuZm9ybWF0dGVycw0KICAgICAqLwogICAgZm9ybWF0dGVyczogewogICAgICAvKioNCiAgICAgICAqIEZvcm1hdHRlciBmb3IgdmFsdWUgbGFiZWxzDQogICAgICAgKiBAbWV0aG9kIENoYXJ0LlRpY2tzLmZvcm1hdHRlcnMudmFsdWVzDQogICAgICAgKiBAcGFyYW0gdmFsdWUgdGhlIHZhbHVlIHRvIGRpc3BsYXkNCiAgICAgICAqIEByZXR1cm4ge3N0cmluZ3xzdHJpbmdbXX0gdGhlIGxhYmVsIHRvIGRpc3BsYXkNCiAgICAgICAqLwogICAgICB2YWx1ZXM6IGZ1bmN0aW9uIHZhbHVlcyh2YWx1ZSkgewogICAgICAgIHJldHVybiBoZWxwZXJzJDEuaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZSA6ICcnICsgdmFsdWU7CiAgICAgIH0sCgogICAgICAvKioNCiAgICAgICAqIEZvcm1hdHRlciBmb3IgbGluZWFyIG51bWVyaWMgdGlja3MNCiAgICAgICAqIEBtZXRob2QgQ2hhcnQuVGlja3MuZm9ybWF0dGVycy5saW5lYXINCiAgICAgICAqIEBwYXJhbSB0aWNrVmFsdWUge251bWJlcn0gdGhlIHZhbHVlIHRvIGJlIGZvcm1hdHRlZA0KICAgICAgICogQHBhcmFtIGluZGV4IHtudW1iZXJ9IHRoZSBwb3NpdGlvbiBvZiB0aGUgdGlja1ZhbHVlIHBhcmFtZXRlciBpbiB0aGUgdGlja3MgYXJyYXkNCiAgICAgICAqIEBwYXJhbSB0aWNrcyB7bnVtYmVyW119IHRoZSBsaXN0IG9mIHRpY2tzIGJlaW5nIGNvbnZlcnRlZA0KICAgICAgICogQHJldHVybiB7c3RyaW5nfSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIHRpY2tWYWx1ZSBwYXJhbWV0ZXINCiAgICAgICAqLwogICAgICBsaW5lYXI6IGZ1bmN0aW9uIGxpbmVhcih0aWNrVmFsdWUsIGluZGV4LCB0aWNrcykgewogICAgICAgIC8vIElmIHdlIGhhdmUgbG90cyBvZiB0aWNrcywgZG9uJ3QgdXNlIHRoZSBvbmVzCiAgICAgICAgdmFyIGRlbHRhID0gdGlja3MubGVuZ3RoID4gMyA/IHRpY2tzWzJdIC0gdGlja3NbMV0gOiB0aWNrc1sxXSAtIHRpY2tzWzBdOyAvLyBJZiB3ZSBoYXZlIGEgbnVtYmVyIGxpa2UgMi41IGFzIHRoZSBkZWx0YSwgZmlndXJlIG91dCBob3cgbWFueSBkZWNpbWFsIHBsYWNlcyB3ZSBuZWVkCgogICAgICAgIGlmIChNYXRoLmFicyhkZWx0YSkgPiAxKSB7CiAgICAgICAgICBpZiAodGlja1ZhbHVlICE9PSBNYXRoLmZsb29yKHRpY2tWYWx1ZSkpIHsKICAgICAgICAgICAgLy8gbm90IGFuIGludGVnZXIKICAgICAgICAgICAgZGVsdGEgPSB0aWNrVmFsdWUgLSBNYXRoLmZsb29yKHRpY2tWYWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgbG9nRGVsdGEgPSBoZWxwZXJzJDEubG9nMTAoTWF0aC5hYnMoZGVsdGEpKTsKICAgICAgICB2YXIgdGlja1N0cmluZyA9ICcnOwoKICAgICAgICBpZiAodGlja1ZhbHVlICE9PSAwKSB7CiAgICAgICAgICB2YXIgbWF4VGljayA9IE1hdGgubWF4KE1hdGguYWJzKHRpY2tzWzBdKSwgTWF0aC5hYnModGlja3NbdGlja3MubGVuZ3RoIC0gMV0pKTsKCiAgICAgICAgICBpZiAobWF4VGljayA8IDFlLTQpIHsKICAgICAgICAgICAgLy8gYWxsIHRpY2tzIGFyZSBzbWFsbCBudW1iZXJzOyB1c2Ugc2NpZW50aWZpYyBub3RhdGlvbgogICAgICAgICAgICB2YXIgbG9nVGljayA9IGhlbHBlcnMkMS5sb2cxMChNYXRoLmFicyh0aWNrVmFsdWUpKTsKICAgICAgICAgICAgdmFyIG51bUV4cG9uZW50aWFsID0gTWF0aC5mbG9vcihsb2dUaWNrKSAtIE1hdGguZmxvb3IobG9nRGVsdGEpOwogICAgICAgICAgICBudW1FeHBvbmVudGlhbCA9IE1hdGgubWF4KE1hdGgubWluKG51bUV4cG9uZW50aWFsLCAyMCksIDApOwogICAgICAgICAgICB0aWNrU3RyaW5nID0gdGlja1ZhbHVlLnRvRXhwb25lbnRpYWwobnVtRXhwb25lbnRpYWwpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG51bURlY2ltYWwgPSAtMSAqIE1hdGguZmxvb3IobG9nRGVsdGEpOwogICAgICAgICAgICBudW1EZWNpbWFsID0gTWF0aC5tYXgoTWF0aC5taW4obnVtRGVjaW1hbCwgMjApLCAwKTsgLy8gdG9GaXhlZCBoYXMgYSBtYXggb2YgMjAgZGVjaW1hbCBwbGFjZXMKCiAgICAgICAgICAgIHRpY2tTdHJpbmcgPSB0aWNrVmFsdWUudG9GaXhlZChudW1EZWNpbWFsKTsKICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGlja1N0cmluZyA9ICcwJzsgLy8gbmV2ZXIgc2hvdyBkZWNpbWFsIHBsYWNlcyBmb3IgMAogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRpY2tTdHJpbmc7CiAgICAgIH0sCiAgICAgIGxvZ2FyaXRobWljOiBmdW5jdGlvbiBsb2dhcml0aG1pYyh0aWNrVmFsdWUsIGluZGV4LCB0aWNrcykgewogICAgICAgIHZhciByZW1haW4gPSB0aWNrVmFsdWUgLyBNYXRoLnBvdygxMCwgTWF0aC5mbG9vcihoZWxwZXJzJDEubG9nMTAodGlja1ZhbHVlKSkpOwoKICAgICAgICBpZiAodGlja1ZhbHVlID09PSAwKSB7CiAgICAgICAgICByZXR1cm4gJzAnOwogICAgICAgIH0gZWxzZSBpZiAocmVtYWluID09PSAxIHx8IHJlbWFpbiA9PT0gMiB8fCByZW1haW4gPT09IDUgfHwgaW5kZXggPT09IDAgfHwgaW5kZXggPT09IHRpY2tzLmxlbmd0aCAtIDEpIHsKICAgICAgICAgIHJldHVybiB0aWNrVmFsdWUudG9FeHBvbmVudGlhbCgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CiAgICB9CiAgfTsKICB2YXIgaXNBcnJheSA9IGhlbHBlcnMkMS5pc0FycmF5OwogIHZhciBpc051bGxPclVuZGVmID0gaGVscGVycyQxLmlzTnVsbE9yVW5kZWY7CiAgdmFyIHZhbHVlT3JEZWZhdWx0JGEgPSBoZWxwZXJzJDEudmFsdWVPckRlZmF1bHQ7CiAgdmFyIHZhbHVlQXRJbmRleE9yRGVmYXVsdCA9IGhlbHBlcnMkMS52YWx1ZUF0SW5kZXhPckRlZmF1bHQ7CgogIGNvcmVfZGVmYXVsdHMuX3NldCgnc2NhbGUnLCB7CiAgICBkaXNwbGF5OiB0cnVlLAogICAgcG9zaXRpb246ICdsZWZ0JywKICAgIG9mZnNldDogZmFsc2UsCiAgICAvLyBncmlkIGxpbmUgc2V0dGluZ3MKICAgIGdyaWRMaW5lczogewogICAgICBkaXNwbGF5OiB0cnVlLAogICAgICBjb2xvcjogJ3JnYmEoMCwwLDAsMC4xKScsCiAgICAgIGxpbmVXaWR0aDogMSwKICAgICAgZHJhd0JvcmRlcjogdHJ1ZSwKICAgICAgZHJhd09uQ2hhcnRBcmVhOiB0cnVlLAogICAgICBkcmF3VGlja3M6IHRydWUsCiAgICAgIHRpY2tNYXJrTGVuZ3RoOiAxMCwKICAgICAgemVyb0xpbmVXaWR0aDogMSwKICAgICAgemVyb0xpbmVDb2xvcjogJ3JnYmEoMCwwLDAsMC4yNSknLAogICAgICB6ZXJvTGluZUJvcmRlckRhc2g6IFtdLAogICAgICB6ZXJvTGluZUJvcmRlckRhc2hPZmZzZXQ6IDAuMCwKICAgICAgb2Zmc2V0R3JpZExpbmVzOiBmYWxzZSwKICAgICAgYm9yZGVyRGFzaDogW10sCiAgICAgIGJvcmRlckRhc2hPZmZzZXQ6IDAuMAogICAgfSwKICAgIC8vIHNjYWxlIGxhYmVsCiAgICBzY2FsZUxhYmVsOiB7CiAgICAgIC8vIGRpc3BsYXkgcHJvcGVydHkKICAgICAgZGlzcGxheTogZmFsc2UsCiAgICAgIC8vIGFjdHVhbCBsYWJlbAogICAgICBsYWJlbFN0cmluZzogJycsCiAgICAgIC8vIHRvcC9ib3R0b20gcGFkZGluZwogICAgICBwYWRkaW5nOiB7CiAgICAgICAgdG9wOiA0LAogICAgICAgIGJvdHRvbTogNAogICAgICB9CiAgICB9LAogICAgLy8gbGFiZWwgc2V0dGluZ3MKICAgIHRpY2tzOiB7CiAgICAgIGJlZ2luQXRaZXJvOiBmYWxzZSwKICAgICAgbWluUm90YXRpb246IDAsCiAgICAgIG1heFJvdGF0aW9uOiA1MCwKICAgICAgbWlycm9yOiBmYWxzZSwKICAgICAgcGFkZGluZzogMCwKICAgICAgcmV2ZXJzZTogZmFsc2UsCiAgICAgIGRpc3BsYXk6IHRydWUsCiAgICAgIGF1dG9Ta2lwOiB0cnVlLAogICAgICBhdXRvU2tpcFBhZGRpbmc6IDAsCiAgICAgIGxhYmVsT2Zmc2V0OiAwLAogICAgICAvLyBXZSBwYXNzIHRocm91Z2ggYXJyYXlzIHRvIGJlIHJlbmRlcmVkIGFzIG11bHRpbGluZSBsYWJlbHMsIHdlIGNvbnZlcnQgT3RoZXJzIHRvIHN0cmluZ3MgaGVyZS4KICAgICAgY2FsbGJhY2s6IGNvcmVfdGlja3MuZm9ybWF0dGVycy52YWx1ZXMsCiAgICAgIG1pbm9yOiB7fSwKICAgICAgbWFqb3I6IHt9CiAgICB9CiAgfSk7CiAgLyoqIFJldHVybnMgYSBuZXcgYXJyYXkgY29udGFpbmluZyBudW1JdGVtcyBmcm9tIGFyciAqLwoKCiAgZnVuY3Rpb24gc2FtcGxlKGFyciwgbnVtSXRlbXMpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBpbmNyZW1lbnQgPSBhcnIubGVuZ3RoIC8gbnVtSXRlbXM7CiAgICB2YXIgaSA9IDA7CiAgICB2YXIgbGVuID0gYXJyLmxlbmd0aDsKCiAgICBmb3IgKDsgaSA8IGxlbjsgaSArPSBpbmNyZW1lbnQpIHsKICAgICAgcmVzdWx0LnB1c2goYXJyW01hdGguZmxvb3IoaSldKTsKICAgIH0KCiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgZnVuY3Rpb24gZ2V0UGl4ZWxGb3JHcmlkTGluZShzY2FsZSwgaW5kZXgsIG9mZnNldEdyaWRMaW5lcykgewogICAgdmFyIGxlbmd0aCA9IHNjYWxlLmdldFRpY2tzKCkubGVuZ3RoOwogICAgdmFyIHZhbGlkSW5kZXggPSBNYXRoLm1pbihpbmRleCwgbGVuZ3RoIC0gMSk7CiAgICB2YXIgbGluZVZhbHVlID0gc2NhbGUuZ2V0UGl4ZWxGb3JUaWNrKHZhbGlkSW5kZXgpOwogICAgdmFyIHN0YXJ0ID0gc2NhbGUuX3N0YXJ0UGl4ZWw7CiAgICB2YXIgZW5kID0gc2NhbGUuX2VuZFBpeGVsOwogICAgdmFyIGVwc2lsb24gPSAxZS02OyAvLyAxZS02IGlzIG1hcmdpbiBpbiBwaXhlbHMgZm9yIGFjY3VtdWxhdGVkIGVycm9yLgoKICAgIHZhciBvZmZzZXQ7CgogICAgaWYgKG9mZnNldEdyaWRMaW5lcykgewogICAgICBpZiAobGVuZ3RoID09PSAxKSB7CiAgICAgICAgb2Zmc2V0ID0gTWF0aC5tYXgobGluZVZhbHVlIC0gc3RhcnQsIGVuZCAtIGxpbmVWYWx1ZSk7CiAgICAgIH0gZWxzZSBpZiAoaW5kZXggPT09IDApIHsKICAgICAgICBvZmZzZXQgPSAoc2NhbGUuZ2V0UGl4ZWxGb3JUaWNrKDEpIC0gbGluZVZhbHVlKSAvIDI7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb2Zmc2V0ID0gKGxpbmVWYWx1ZSAtIHNjYWxlLmdldFBpeGVsRm9yVGljayh2YWxpZEluZGV4IC0gMSkpIC8gMjsKICAgICAgfQoKICAgICAgbGluZVZhbHVlICs9IHZhbGlkSW5kZXggPCBpbmRleCA/IG9mZnNldCA6IC1vZmZzZXQ7IC8vIFJldHVybiB1bmRlZmluZWQgaWYgdGhlIHBpeGVsIGlzIG91dCBvZiB0aGUgcmFuZ2UKCiAgICAgIGlmIChsaW5lVmFsdWUgPCBzdGFydCAtIGVwc2lsb24gfHwgbGluZVZhbHVlID4gZW5kICsgZXBzaWxvbikgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBsaW5lVmFsdWU7CiAgfQoKICBmdW5jdGlvbiBnYXJiYWdlQ29sbGVjdChjYWNoZXMsIGxlbmd0aCkgewogICAgaGVscGVycyQxLmVhY2goY2FjaGVzLCBmdW5jdGlvbiAoY2FjaGUpIHsKICAgICAgdmFyIGdjID0gY2FjaGUuZ2M7CiAgICAgIHZhciBnY0xlbiA9IGdjLmxlbmd0aCAvIDI7CiAgICAgIHZhciBpOwoKICAgICAgaWYgKGdjTGVuID4gbGVuZ3RoKSB7CiAgICAgICAgZm9yIChpID0gMDsgaSA8IGdjTGVuOyArK2kpIHsKICAgICAgICAgIGRlbGV0ZSBjYWNoZS5kYXRhW2djW2ldXTsKICAgICAgICB9CgogICAgICAgIGdjLnNwbGljZSgwLCBnY0xlbik7CiAgICAgIH0KICAgIH0pOwogIH0KICAvKioNCiAgICogUmV0dXJucyB7d2lkdGgsIGhlaWdodCwgb2Zmc2V0fSBvYmplY3RzIGZvciB0aGUgZmlyc3QsIGxhc3QsIHdpZGVzdCwgaGlnaGVzdCB0aWNrDQogICAqIGxhYmVscyB3aGVyZSBvZmZzZXQgaW5kaWNhdGVzIHRoZSBhbmNob3IgcG9pbnQgb2Zmc2V0IGZyb20gdGhlIHRvcCBpbiBwaXhlbHMuDQogICAqLwoKCiAgZnVuY3Rpb24gY29tcHV0ZUxhYmVsU2l6ZXMoY3R4LCB0aWNrRm9udHMsIHRpY2tzLCBjYWNoZXMpIHsKICAgIHZhciBsZW5ndGggPSB0aWNrcy5sZW5ndGg7CiAgICB2YXIgd2lkdGhzID0gW107CiAgICB2YXIgaGVpZ2h0cyA9IFtdOwogICAgdmFyIG9mZnNldHMgPSBbXTsKICAgIHZhciB3aWRlc3RMYWJlbFNpemUgPSAwOwogICAgdmFyIGhpZ2hlc3RMYWJlbFNpemUgPSAwOwogICAgdmFyIGksIGosIGpsZW4sIGxhYmVsLCB0aWNrRm9udCwgZm9udFN0cmluZywgY2FjaGUsIGxpbmVIZWlnaHQsIHdpZHRoLCBoZWlnaHQsIG5lc3RlZExhYmVsLCB3aWRlc3QsIGhpZ2hlc3Q7CgogICAgZm9yIChpID0gMDsgaSA8IGxlbmd0aDsgKytpKSB7CiAgICAgIGxhYmVsID0gdGlja3NbaV0ubGFiZWw7CiAgICAgIHRpY2tGb250ID0gdGlja3NbaV0ubWFqb3IgPyB0aWNrRm9udHMubWFqb3IgOiB0aWNrRm9udHMubWlub3I7CiAgICAgIGN0eC5mb250ID0gZm9udFN0cmluZyA9IHRpY2tGb250LnN0cmluZzsKICAgICAgY2FjaGUgPSBjYWNoZXNbZm9udFN0cmluZ10gPSBjYWNoZXNbZm9udFN0cmluZ10gfHwgewogICAgICAgIGRhdGE6IHt9LAogICAgICAgIGdjOiBbXQogICAgICB9OwogICAgICBsaW5lSGVpZ2h0ID0gdGlja0ZvbnQubGluZUhlaWdodDsKICAgICAgd2lkdGggPSBoZWlnaHQgPSAwOyAvLyBVbmRlZmluZWQgbGFiZWxzIGFuZCBhcnJheXMgc2hvdWxkIG5vdCBiZSBtZWFzdXJlZAoKICAgICAgaWYgKCFpc051bGxPclVuZGVmKGxhYmVsKSAmJiAhaXNBcnJheShsYWJlbCkpIHsKICAgICAgICB3aWR0aCA9IGhlbHBlcnMkMS5tZWFzdXJlVGV4dChjdHgsIGNhY2hlLmRhdGEsIGNhY2hlLmdjLCB3aWR0aCwgbGFiZWwpOwogICAgICAgIGhlaWdodCA9IGxpbmVIZWlnaHQ7CiAgICAgIH0gZWxzZSBpZiAoaXNBcnJheShsYWJlbCkpIHsKICAgICAgICAvLyBpZiBpdCBpcyBhbiBhcnJheSBsZXQncyBtZWFzdXJlIGVhY2ggZWxlbWVudAogICAgICAgIGZvciAoaiA9IDAsIGpsZW4gPSBsYWJlbC5sZW5ndGg7IGogPCBqbGVuOyArK2opIHsKICAgICAgICAgIG5lc3RlZExhYmVsID0gbGFiZWxbal07IC8vIFVuZGVmaW5lZCBsYWJlbHMgYW5kIGFycmF5cyBzaG91bGQgbm90IGJlIG1lYXN1cmVkCgogICAgICAgICAgaWYgKCFpc051bGxPclVuZGVmKG5lc3RlZExhYmVsKSAmJiAhaXNBcnJheShuZXN0ZWRMYWJlbCkpIHsKICAgICAgICAgICAgd2lkdGggPSBoZWxwZXJzJDEubWVhc3VyZVRleHQoY3R4LCBjYWNoZS5kYXRhLCBjYWNoZS5nYywgd2lkdGgsIG5lc3RlZExhYmVsKTsKICAgICAgICAgICAgaGVpZ2h0ICs9IGxpbmVIZWlnaHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICB3aWR0aHMucHVzaCh3aWR0aCk7CiAgICAgIGhlaWdodHMucHVzaChoZWlnaHQpOwogICAgICBvZmZzZXRzLnB1c2gobGluZUhlaWdodCAvIDIpOwogICAgICB3aWRlc3RMYWJlbFNpemUgPSBNYXRoLm1heCh3aWR0aCwgd2lkZXN0TGFiZWxTaXplKTsKICAgICAgaGlnaGVzdExhYmVsU2l6ZSA9IE1hdGgubWF4KGhlaWdodCwgaGlnaGVzdExhYmVsU2l6ZSk7CiAgICB9CgogICAgZ2FyYmFnZUNvbGxlY3QoY2FjaGVzLCBsZW5ndGgpOwogICAgd2lkZXN0ID0gd2lkdGhzLmluZGV4T2Yod2lkZXN0TGFiZWxTaXplKTsKICAgIGhpZ2hlc3QgPSBoZWlnaHRzLmluZGV4T2YoaGlnaGVzdExhYmVsU2l6ZSk7CgogICAgZnVuY3Rpb24gdmFsdWVBdChpZHgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB3aWR0aDogd2lkdGhzW2lkeF0gfHwgMCwKICAgICAgICBoZWlnaHQ6IGhlaWdodHNbaWR4XSB8fCAwLAogICAgICAgIG9mZnNldDogb2Zmc2V0c1tpZHhdIHx8IDAKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICBmaXJzdDogdmFsdWVBdCgwKSwKICAgICAgbGFzdDogdmFsdWVBdChsZW5ndGggLSAxKSwKICAgICAgd2lkZXN0OiB2YWx1ZUF0KHdpZGVzdCksCiAgICAgIGhpZ2hlc3Q6IHZhbHVlQXQoaGlnaGVzdCkKICAgIH07CiAgfQoKICBmdW5jdGlvbiBnZXRUaWNrTWFya0xlbmd0aChvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9ucy5kcmF3VGlja3MgPyBvcHRpb25zLnRpY2tNYXJrTGVuZ3RoIDogMDsKICB9CgogIGZ1bmN0aW9uIGdldFNjYWxlTGFiZWxIZWlnaHQob3B0aW9ucykgewogICAgdmFyIGZvbnQsIHBhZGRpbmc7CgogICAgaWYgKCFvcHRpb25zLmRpc3BsYXkpIHsKICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgZm9udCA9IGhlbHBlcnMkMS5vcHRpb25zLl9wYXJzZUZvbnQob3B0aW9ucyk7CiAgICBwYWRkaW5nID0gaGVscGVycyQxLm9wdGlvbnMudG9QYWRkaW5nKG9wdGlvbnMucGFkZGluZyk7CiAgICByZXR1cm4gZm9udC5saW5lSGVpZ2h0ICsgcGFkZGluZy5oZWlnaHQ7CiAgfQoKICBmdW5jdGlvbiBwYXJzZUZvbnRPcHRpb25zKG9wdGlvbnMsIG5lc3RlZE9wdHMpIHsKICAgIHJldHVybiBoZWxwZXJzJDEuZXh0ZW5kKGhlbHBlcnMkMS5vcHRpb25zLl9wYXJzZUZvbnQoewogICAgICBmb250RmFtaWx5OiB2YWx1ZU9yRGVmYXVsdCRhKG5lc3RlZE9wdHMuZm9udEZhbWlseSwgb3B0aW9ucy5mb250RmFtaWx5KSwKICAgICAgZm9udFNpemU6IHZhbHVlT3JEZWZhdWx0JGEobmVzdGVkT3B0cy5mb250U2l6ZSwgb3B0aW9ucy5mb250U2l6ZSksCiAgICAgIGZvbnRTdHlsZTogdmFsdWVPckRlZmF1bHQkYShuZXN0ZWRPcHRzLmZvbnRTdHlsZSwgb3B0aW9ucy5mb250U3R5bGUpLAogICAgICBsaW5lSGVpZ2h0OiB2YWx1ZU9yRGVmYXVsdCRhKG5lc3RlZE9wdHMubGluZUhlaWdodCwgb3B0aW9ucy5saW5lSGVpZ2h0KQogICAgfSksIHsKICAgICAgY29sb3I6IGhlbHBlcnMkMS5vcHRpb25zLnJlc29sdmUoW25lc3RlZE9wdHMuZm9udENvbG9yLCBvcHRpb25zLmZvbnRDb2xvciwgY29yZV9kZWZhdWx0cy5nbG9iYWwuZGVmYXVsdEZvbnRDb2xvcl0pCiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlVGlja0ZvbnRPcHRpb25zKG9wdGlvbnMpIHsKICAgIHZhciBtaW5vciA9IHBhcnNlRm9udE9wdGlvbnMob3B0aW9ucywgb3B0aW9ucy5taW5vcik7CiAgICB2YXIgbWFqb3IgPSBvcHRpb25zLm1ham9yLmVuYWJsZWQgPyBwYXJzZUZvbnRPcHRpb25zKG9wdGlvbnMsIG9wdGlvbnMubWFqb3IpIDogbWlub3I7CiAgICByZXR1cm4gewogICAgICBtaW5vcjogbWlub3IsCiAgICAgIG1ham9yOiBtYWpvcgogICAgfTsKICB9CgogIGZ1bmN0aW9uIG5vblNraXBwZWQodGlja3NUb0ZpbHRlcikgewogICAgdmFyIGZpbHRlcmVkID0gW107CiAgICB2YXIgaXRlbSwgaW5kZXgsIGxlbjsKCiAgICBmb3IgKGluZGV4ID0gMCwgbGVuID0gdGlja3NUb0ZpbHRlci5sZW5ndGg7IGluZGV4IDwgbGVuOyArK2luZGV4KSB7CiAgICAgIGl0ZW0gPSB0aWNrc1RvRmlsdGVyW2luZGV4XTsKCiAgICAgIGlmICh0eXBlb2YgaXRlbS5faW5kZXggIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgZmlsdGVyZWQucHVzaChpdGVtKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmaWx0ZXJlZDsKICB9CgogIGZ1bmN0aW9uIGdldEV2ZW5TcGFjaW5nKGFycikgewogICAgdmFyIGxlbiA9IGFyci5sZW5ndGg7CiAgICB2YXIgaSwgZGlmZjsKCiAgICBpZiAobGVuIDwgMikgewogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgZm9yIChkaWZmID0gYXJyWzBdLCBpID0gMTsgaSA8IGxlbjsgKytpKSB7CiAgICAgIGlmIChhcnJbaV0gLSBhcnJbaSAtIDFdICE9PSBkaWZmKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIGRpZmY7CiAgfQoKICBmdW5jdGlvbiBjYWxjdWxhdGVTcGFjaW5nKG1ham9ySW5kaWNlcywgdGlja3MsIGF4aXNMZW5ndGgsIHRpY2tzTGltaXQpIHsKICAgIHZhciBldmVuTWFqb3JTcGFjaW5nID0gZ2V0RXZlblNwYWNpbmcobWFqb3JJbmRpY2VzKTsKICAgIHZhciBzcGFjaW5nID0gKHRpY2tzLmxlbmd0aCAtIDEpIC8gdGlja3NMaW1pdDsKICAgIHZhciBmYWN0b3JzLCBmYWN0b3IsIGksIGlsZW47IC8vIElmIHRoZSBtYWpvciB0aWNrcyBhcmUgZXZlbmx5IHNwYWNlZCBhcGFydCwgcGxhY2UgdGhlIG1pbm9yIHRpY2tzCiAgICAvLyBzbyB0aGF0IHRoZXkgZGl2aWRlIHRoZSBtYWpvciB0aWNrcyBpbnRvIGV2ZW4gY2h1bmtzCgogICAgaWYgKCFldmVuTWFqb3JTcGFjaW5nKSB7CiAgICAgIHJldHVybiBNYXRoLm1heChzcGFjaW5nLCAxKTsKICAgIH0KCiAgICBmYWN0b3JzID0gaGVscGVycyQxLm1hdGguX2ZhY3Rvcml6ZShldmVuTWFqb3JTcGFjaW5nKTsKCiAgICBmb3IgKGkgPSAwLCBpbGVuID0gZmFjdG9ycy5sZW5ndGggLSAxOyBpIDwgaWxlbjsgaSsrKSB7CiAgICAgIGZhY3RvciA9IGZhY3RvcnNbaV07CgogICAgICBpZiAoZmFjdG9yID4gc3BhY2luZykgewogICAgICAgIHJldHVybiBmYWN0b3I7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gTWF0aC5tYXgoc3BhY2luZywgMSk7CiAgfQoKICBmdW5jdGlvbiBnZXRNYWpvckluZGljZXModGlja3MpIHsKICAgIHZhciByZXN1bHQgPSBbXTsKICAgIHZhciBpLCBpbGVuOwoKICAgIGZvciAoaSA9IDAsIGlsZW4gPSB0aWNrcy5sZW5ndGg7IGkgPCBpbGVuOyBpKyspIHsKICAgICAgaWYgKHRpY2tzW2ldLm1ham9yKSB7CiAgICAgICAgcmVzdWx0LnB1c2goaSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gcmVzdWx0OwogIH0KCiAgZnVuY3Rpb24gc2tpcE1ham9ycyh0aWNrcywgbWFqb3JJbmRpY2VzLCBzcGFjaW5nKSB7CiAgICB2YXIgY291bnQgPSAwOwogICAgdmFyIG5leHQgPSBtYWpvckluZGljZXNbMF07CiAgICB2YXIgaSwgdGljazsKICAgIHNwYWNpbmcgPSBNYXRoLmNlaWwoc3BhY2luZyk7CgogICAgZm9yIChpID0gMDsgaSA8IHRpY2tzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHRpY2sgPSB0aWNrc1tpXTsKCiAgICAgIGlmIChpID09PSBuZXh0KSB7CiAgICAgICAgdGljay5faW5kZXggPSBpOwogICAgICAgIGNvdW50Kys7CiAgICAgICAgbmV4dCA9IG1ham9ySW5kaWNlc1tjb3VudCAqIHNwYWNpbmddOwogICAgICB9IGVsc2UgewogICAgICAgIGRlbGV0ZSB0aWNrLmxhYmVsOwogICAgICB9CiAgICB9CiAgfQoKICBmdW5jdGlvbiBza2lwKHRpY2tzLCBzcGFjaW5nLCBtYWpvclN0YXJ0LCBtYWpvckVuZCkgewogICAgdmFyIHN0YXJ0ID0gdmFsdWVPckRlZmF1bHQkYShtYWpvclN0YXJ0LCAwKTsKICAgIHZhciBlbmQgPSBNYXRoLm1pbih2YWx1ZU9yRGVmYXVsdCRhKG1ham9yRW5kLCB0aWNrcy5sZW5ndGgpLCB0aWNrcy5sZW5ndGgpOwogICAgdmFyIGNvdW50ID0gMDsKICAgIHZhciBsZW5ndGgsIGksIHRpY2ssIG5leHQ7CiAgICBzcGFjaW5nID0gTWF0aC5jZWlsKHNwYWNpbmcpOwoKICAgIGlmIChtYWpvckVuZCkgewogICAgICBsZW5ndGggPSBtYWpvckVuZCAtIG1ham9yU3RhcnQ7CiAgICAgIHNwYWNpbmcgPSBsZW5ndGggLyBNYXRoLmZsb29yKGxlbmd0aCAvIHNwYWNpbmcpOwogICAgfQoKICAgIG5leHQgPSBzdGFydDsKCiAgICB3aGlsZSAobmV4dCA8IDApIHsKICAgICAgY291bnQrKzsKICAgICAgbmV4dCA9IE1hdGgucm91bmQoc3RhcnQgKyBjb3VudCAqIHNwYWNpbmcpOwogICAgfQoKICAgIGZvciAoaSA9IE1hdGgubWF4KHN0YXJ0LCAwKTsgaSA8IGVuZDsgaSsrKSB7CiAgICAgIHRpY2sgPSB0aWNrc1tpXTsKCiAgICAgIGlmIChpID09PSBuZXh0KSB7CiAgICAgICAgdGljay5faW5kZXggPSBpOwogICAgICAgIGNvdW50Kys7CiAgICAgICAgbmV4dCA9IE1hdGgucm91bmQoc3RhcnQgKyBjb3VudCAqIHNwYWNpbmcpOwogICAgICB9IGVsc2UgewogICAgICAgIGRlbGV0ZSB0aWNrLmxhYmVsOwogICAgICB9CiAgICB9CiAgfQoKICB2YXIgU2NhbGUgPSBjb3JlX2VsZW1lbnQuZXh0ZW5kKHsKICAgIHplcm9MaW5lSW5kZXg6IDAsCgogICAgLyoqDQogICAgICogR2V0IHRoZSBwYWRkaW5nIG5lZWRlZCBmb3IgdGhlIHNjYWxlDQogICAgICogQG1ldGhvZCBnZXRQYWRkaW5nDQogICAgICogQHByaXZhdGUNCiAgICAgKiBAcmV0dXJucyB7UGFkZGluZ30gdGhlIG5lY2Vzc2FyeSBwYWRkaW5nDQogICAgICovCiAgICBnZXRQYWRkaW5nOiBmdW5jdGlvbiBnZXRQYWRkaW5nKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICByZXR1cm4gewogICAgICAgIGxlZnQ6IG1lLnBhZGRpbmdMZWZ0IHx8IDAsCiAgICAgICAgdG9wOiBtZS5wYWRkaW5nVG9wIHx8IDAsCiAgICAgICAgcmlnaHQ6IG1lLnBhZGRpbmdSaWdodCB8fCAwLAogICAgICAgIGJvdHRvbTogbWUucGFkZGluZ0JvdHRvbSB8fCAwCiAgICAgIH07CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgdGhlIHNjYWxlIHRpY2sgb2JqZWN0cyAoe2xhYmVsLCBtYWpvcn0pDQogICAgICogQHNpbmNlIDIuNw0KICAgICAqLwogICAgZ2V0VGlja3M6IGZ1bmN0aW9uIGdldFRpY2tzKCkgewogICAgICByZXR1cm4gdGhpcy5fdGlja3M7CiAgICB9LAoKICAgIC8qKg0KICAgICogQHByaXZhdGUNCiAgICAqLwogICAgX2dldExhYmVsczogZnVuY3Rpb24gX2dldExhYmVscygpIHsKICAgICAgdmFyIGRhdGEgPSB0aGlzLmNoYXJ0LmRhdGE7CiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMubGFiZWxzIHx8ICh0aGlzLmlzSG9yaXpvbnRhbCgpID8gZGF0YS54TGFiZWxzIDogZGF0YS55TGFiZWxzKSB8fCBkYXRhLmxhYmVscyB8fCBbXTsKICAgIH0sCiAgICAvLyBUaGVzZSBtZXRob2RzIGFyZSBvcmRlcmVkIGJ5IGxpZmVjeWxlLiBVdGlsaXRpZXMgdGhlbiBmb2xsb3cuCiAgICAvLyBBbnkgZnVuY3Rpb24gZGVmaW5lZCBoZXJlIGlzIGluaGVyaXRlZCBieSBhbGwgc2NhbGUgdHlwZXMuCiAgICAvLyBBbnkgZnVuY3Rpb24gY2FuIGJlIGV4dGVuZGVkIGJ5IHRoZSBzY2FsZSB0eXBlCgogICAgLyoqDQogICAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIG5vdCBhdmFpbGFibGUgYW55bW9yZQ0KICAgICAqIEBmdW5jdGlvbiBDaGFydC5TY2FsZS5tZXJnZVRpY2tzT3B0aW9ucw0KICAgICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi44LjANCiAgICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAgICovCiAgICBtZXJnZVRpY2tzT3B0aW9uczogZnVuY3Rpb24gbWVyZ2VUaWNrc09wdGlvbnMoKSB7Ly8gbm9vcAogICAgfSwKICAgIGJlZm9yZVVwZGF0ZTogZnVuY3Rpb24gYmVmb3JlVXBkYXRlKCkgewogICAgICBoZWxwZXJzJDEuY2FsbGJhY2sodGhpcy5vcHRpb25zLmJlZm9yZVVwZGF0ZSwgW3RoaXNdKTsKICAgIH0sCgogICAgLyoqDQogICAgICogQHBhcmFtIHtudW1iZXJ9IG1heFdpZHRoIC0gdGhlIG1heCB3aWR0aCBpbiBwaXhlbHMNCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWF4SGVpZ2h0IC0gdGhlIG1heCBoZWlnaHQgaW4gcGl4ZWxzDQogICAgICogQHBhcmFtIHtvYmplY3R9IG1hcmdpbnMgLSB0aGUgc3BhY2UgYmV0d2VlbiB0aGUgZWRnZSBvZiB0aGUgb3RoZXIgc2NhbGVzIGFuZCBlZGdlIG9mIHRoZSBjaGFydA0KICAgICAqICAgVGhpcyBzcGFjZSBjb21lcyBmcm9tIHR3byBzb3VyY2VzOg0KICAgICAqICAgICAtIHBhZGRpbmcgLSBzcGFjZSB0aGF0J3MgcmVxdWlyZWQgdG8gc2hvdyB0aGUgbGFiZWxzIGF0IHRoZSBlZGdlcyBvZiB0aGUgc2NhbGUNCiAgICAgKiAgICAgLSB0aGlja25lc3Mgb2Ygc2NhbGVzIG9yIGxlZ2VuZHMgaW4gYW5vdGhlciBvcmllbnRhdGlvbg0KICAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUobWF4V2lkdGgsIG1heEhlaWdodCwgbWFyZ2lucykgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgdGlja09wdHMgPSBtZS5vcHRpb25zLnRpY2tzOwogICAgICB2YXIgc2FtcGxlU2l6ZSA9IHRpY2tPcHRzLnNhbXBsZVNpemU7CiAgICAgIHZhciBpLCBpbGVuLCBsYWJlbHMsIHRpY2tzLCBzYW1wbGluZ0VuYWJsZWQ7IC8vIFVwZGF0ZSBMaWZlY3ljbGUgLSBQcm9iYWJseSBkb24ndCB3YW50IHRvIGV2ZXIgZXh0ZW5kIG9yIG92ZXJ3cml0ZSB0aGlzIGZ1bmN0aW9uIDspCgogICAgICBtZS5iZWZvcmVVcGRhdGUoKTsgLy8gQWJzb3JiIHRoZSBtYXN0ZXIgbWVhc3VyZW1lbnRzCgogICAgICBtZS5tYXhXaWR0aCA9IG1heFdpZHRoOwogICAgICBtZS5tYXhIZWlnaHQgPSBtYXhIZWlnaHQ7CiAgICAgIG1lLm1hcmdpbnMgPSBoZWxwZXJzJDEuZXh0ZW5kKHsKICAgICAgICBsZWZ0OiAwLAogICAgICAgIHJpZ2h0OiAwLAogICAgICAgIHRvcDogMCwKICAgICAgICBib3R0b206IDAKICAgICAgfSwgbWFyZ2lucyk7CiAgICAgIG1lLl90aWNrcyA9IG51bGw7CiAgICAgIG1lLnRpY2tzID0gbnVsbDsKICAgICAgbWUuX2xhYmVsU2l6ZXMgPSBudWxsOwogICAgICBtZS5fbWF4TGFiZWxMaW5lcyA9IDA7CiAgICAgIG1lLmxvbmdlc3RMYWJlbFdpZHRoID0gMDsKICAgICAgbWUubG9uZ2VzdFRleHRDYWNoZSA9IG1lLmxvbmdlc3RUZXh0Q2FjaGUgfHwge307CiAgICAgIG1lLl9ncmlkTGluZUl0ZW1zID0gbnVsbDsKICAgICAgbWUuX2xhYmVsSXRlbXMgPSBudWxsOyAvLyBEaW1lbnNpb25zCgogICAgICBtZS5iZWZvcmVTZXREaW1lbnNpb25zKCk7CiAgICAgIG1lLnNldERpbWVuc2lvbnMoKTsKICAgICAgbWUuYWZ0ZXJTZXREaW1lbnNpb25zKCk7IC8vIERhdGEgbWluL21heAoKICAgICAgbWUuYmVmb3JlRGF0YUxpbWl0cygpOwogICAgICBtZS5kZXRlcm1pbmVEYXRhTGltaXRzKCk7CiAgICAgIG1lLmFmdGVyRGF0YUxpbWl0cygpOyAvLyBUaWNrcyAtIGB0aGlzLnRpY2tzYCBpcyBub3cgREVQUkVDQVRFRCEKICAgICAgLy8gSW50ZXJuYWwgdGlja3MgYXJlIG5vdyBzdG9yZWQgYXMgb2JqZWN0cyBpbiB0aGUgUFJJVkFURSBgdGhpcy5fdGlja3NgIG1lbWJlcgogICAgICAvLyBhbmQgbXVzdCBub3QgYmUgYWNjZXNzZWQgZGlyZWN0bHkgZnJvbSBvdXRzaWRlIHRoaXMgY2xhc3MuIGB0aGlzLnRpY2tzYCBiZWluZwogICAgICAvLyBhcm91bmQgZm9yIGxvbmcgdGltZSBhbmQgbm90IG1hcmtlZCBhcyBwcml2YXRlLCB3ZSBjYW4ndCBjaGFuZ2UgaXRzIHN0cnVjdHVyZQogICAgICAvLyB3aXRob3V0IHVuZXhwZWN0ZWQgYnJlYWtpbmcgY2hhbmdlcy4gSWYgeW91IG5lZWQgdG8gYWNjZXNzIHRoZSBzY2FsZSB0aWNrcywKICAgICAgLy8gdXNlIHNjYWxlLmdldFRpY2tzKCkgaW5zdGVhZC4KCiAgICAgIG1lLmJlZm9yZUJ1aWxkVGlja3MoKTsgLy8gTmV3IGltcGxlbWVudGF0aW9ucyBzaG91bGQgcmV0dXJuIGFuIGFycmF5IG9mIG9iamVjdHMgYnV0IGZvciBCQUNLV0FSRCBDT01QQVQsCiAgICAgIC8vIHdlIHN0aWxsIHN1cHBvcnQgbm8gcmV0dXJuIChgdGhpcy50aWNrc2AgaW50ZXJuYWxseSBzZXQgYnkgY2FsbGluZyB0aGlzIG1ldGhvZCkuCgogICAgICB0aWNrcyA9IG1lLmJ1aWxkVGlja3MoKSB8fCBbXTsgLy8gQWxsb3cgbW9kaWZpY2F0aW9uIG9mIHRpY2tzIGluIGNhbGxiYWNrLgoKICAgICAgdGlja3MgPSBtZS5hZnRlckJ1aWxkVGlja3ModGlja3MpIHx8IHRpY2tzOyAvLyBFbnN1cmUgdGlja3MgY29udGFpbnMgdGlja3MgaW4gbmV3IHRpY2sgZm9ybWF0CgogICAgICBpZiAoKCF0aWNrcyB8fCAhdGlja3MubGVuZ3RoKSAmJiBtZS50aWNrcykgewogICAgICAgIHRpY2tzID0gW107CgogICAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBtZS50aWNrcy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICAgIHRpY2tzLnB1c2goewogICAgICAgICAgICB2YWx1ZTogbWUudGlja3NbaV0sCiAgICAgICAgICAgIG1ham9yOiBmYWxzZQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBtZS5fdGlja3MgPSB0aWNrczsgLy8gQ29tcHV0ZSB0aWNrIHJvdGF0aW9uIGFuZCBmaXQgdXNpbmcgYSBzYW1wbGVkIHN1YnNldCBvZiBsYWJlbHMKICAgICAgLy8gV2UgZ2VuZXJhbGx5IGRvbid0IG5lZWQgdG8gY29tcHV0ZSB0aGUgc2l6ZSBvZiBldmVyeSBzaW5nbGUgbGFiZWwgZm9yIGRldGVybWluaW5nIHNjYWxlIHNpemUKCiAgICAgIHNhbXBsaW5nRW5hYmxlZCA9IHNhbXBsZVNpemUgPCB0aWNrcy5sZW5ndGg7CiAgICAgIGxhYmVscyA9IG1lLl9jb252ZXJ0VGlja3NUb0xhYmVscyhzYW1wbGluZ0VuYWJsZWQgPyBzYW1wbGUodGlja3MsIHNhbXBsZVNpemUpIDogdGlja3MpOyAvLyBfY29uZmlndXJlIGlzIGNhbGxlZCB0d2ljZSwgb25jZSBoZXJlLCBvbmNlIGZyb20gY29yZS5jb250cm9sbGVyLnVwZGF0ZUxheW91dC4KICAgICAgLy8gSGVyZSB3ZSBoYXZlbid0IGJlZW4gcG9zaXRpb25lZCB5ZXQsIGJ1dCBkaW1lbnNpb25zIGFyZSBjb3JyZWN0LgogICAgICAvLyBWYXJpYWJsZXMgc2V0IGluIF9jb25maWd1cmUgYXJlIG5lZWRlZCBmb3IgY2FsY3VsYXRlVGlja1JvdGF0aW9uLCBhbmQKICAgICAgLy8gaXQncyBvayB0aGF0IGNvb3JkaW5hdGVzIGFyZSBub3QgY29ycmVjdCB0aGVyZSwgb25seSBkaW1lbnNpb25zIG1hdHRlci4KCiAgICAgIG1lLl9jb25maWd1cmUoKTsgLy8gVGljayBSb3RhdGlvbgoKCiAgICAgIG1lLmJlZm9yZUNhbGN1bGF0ZVRpY2tSb3RhdGlvbigpOwogICAgICBtZS5jYWxjdWxhdGVUaWNrUm90YXRpb24oKTsKICAgICAgbWUuYWZ0ZXJDYWxjdWxhdGVUaWNrUm90YXRpb24oKTsKICAgICAgbWUuYmVmb3JlRml0KCk7CiAgICAgIG1lLmZpdCgpOwogICAgICBtZS5hZnRlckZpdCgpOyAvLyBBdXRvLXNraXAKCiAgICAgIG1lLl90aWNrc1RvRHJhdyA9IHRpY2tPcHRzLmRpc3BsYXkgJiYgKHRpY2tPcHRzLmF1dG9Ta2lwIHx8IHRpY2tPcHRzLnNvdXJjZSA9PT0gJ2F1dG8nKSA/IG1lLl9hdXRvU2tpcCh0aWNrcykgOiB0aWNrczsKCiAgICAgIGlmIChzYW1wbGluZ0VuYWJsZWQpIHsKICAgICAgICAvLyBHZW5lcmF0ZSBsYWJlbHMgdXNpbmcgYWxsIG5vbi1za2lwcGVkIHRpY2tzCiAgICAgICAgbGFiZWxzID0gbWUuX2NvbnZlcnRUaWNrc1RvTGFiZWxzKG1lLl90aWNrc1RvRHJhdyk7CiAgICAgIH0KCiAgICAgIG1lLnRpY2tzID0gbGFiZWxzOyAvLyBCQUNLV0FSRCBDT01QQVRJQklMSVRZCiAgICAgIC8vIElNUE9SVEFOVDogYWZ0ZXIgdGhpcyBwb2ludCwgd2UgY29uc2lkZXIgdGhhdCBgdGhpcy50aWNrc2Agd2lsbCBORVZFUiBjaGFuZ2UhCgogICAgICBtZS5hZnRlclVwZGF0ZSgpOyAvLyBUT0RPKHYzKTogcmVtb3ZlIG1pblNpemUgYXMgYSBwdWJsaWMgcHJvcGVydHkgYW5kIHJldHVybiB2YWx1ZSBmcm9tIGFsbCBsYXlvdXQgYm94ZXMuIEl0IGlzIHVudXNlZAogICAgICAvLyBtYWtlIG1heFdpZHRoIGFuZCBtYXhIZWlnaHQgcHJpdmF0ZQoKICAgICAgcmV0dXJuIG1lLm1pblNpemU7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbiBfY29uZmlndXJlKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgcmV2ZXJzZVBpeGVscyA9IG1lLm9wdGlvbnMudGlja3MucmV2ZXJzZTsKICAgICAgdmFyIHN0YXJ0UGl4ZWwsIGVuZFBpeGVsOwoKICAgICAgaWYgKG1lLmlzSG9yaXpvbnRhbCgpKSB7CiAgICAgICAgc3RhcnRQaXhlbCA9IG1lLmxlZnQ7CiAgICAgICAgZW5kUGl4ZWwgPSBtZS5yaWdodDsKICAgICAgfSBlbHNlIHsKICAgICAgICBzdGFydFBpeGVsID0gbWUudG9wOwogICAgICAgIGVuZFBpeGVsID0gbWUuYm90dG9tOyAvLyBieSBkZWZhdWx0IHZlcnRpY2FsIHNjYWxlcyBhcmUgZnJvbSBib3R0b20gdG8gdG9wLCBzbyBwaXhlbHMgYXJlIHJldmVyc2VkCgogICAgICAgIHJldmVyc2VQaXhlbHMgPSAhcmV2ZXJzZVBpeGVsczsKICAgICAgfQoKICAgICAgbWUuX3N0YXJ0UGl4ZWwgPSBzdGFydFBpeGVsOwogICAgICBtZS5fZW5kUGl4ZWwgPSBlbmRQaXhlbDsKICAgICAgbWUuX3JldmVyc2VQaXhlbHMgPSByZXZlcnNlUGl4ZWxzOwogICAgICBtZS5fbGVuZ3RoID0gZW5kUGl4ZWwgLSBzdGFydFBpeGVsOwogICAgfSwKICAgIGFmdGVyVXBkYXRlOiBmdW5jdGlvbiBhZnRlclVwZGF0ZSgpIHsKICAgICAgaGVscGVycyQxLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5hZnRlclVwZGF0ZSwgW3RoaXNdKTsKICAgIH0sCiAgICAvLwogICAgYmVmb3JlU2V0RGltZW5zaW9uczogZnVuY3Rpb24gYmVmb3JlU2V0RGltZW5zaW9ucygpIHsKICAgICAgaGVscGVycyQxLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5iZWZvcmVTZXREaW1lbnNpb25zLCBbdGhpc10pOwogICAgfSwKICAgIHNldERpbWVuc2lvbnM6IGZ1bmN0aW9uIHNldERpbWVuc2lvbnMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7IC8vIFNldCB0aGUgdW5jb25zdHJhaW5lZCBkaW1lbnNpb24gYmVmb3JlIGxhYmVsIHJvdGF0aW9uCgogICAgICBpZiAobWUuaXNIb3Jpem9udGFsKCkpIHsKICAgICAgICAvLyBSZXNldCBwb3NpdGlvbiBiZWZvcmUgY2FsY3VsYXRpbmcgcm90YXRpb24KICAgICAgICBtZS53aWR0aCA9IG1lLm1heFdpZHRoOwogICAgICAgIG1lLmxlZnQgPSAwOwogICAgICAgIG1lLnJpZ2h0ID0gbWUud2lkdGg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWUuaGVpZ2h0ID0gbWUubWF4SGVpZ2h0OyAvLyBSZXNldCBwb3NpdGlvbiBiZWZvcmUgY2FsY3VsYXRpbmcgcm90YXRpb24KCiAgICAgICAgbWUudG9wID0gMDsKICAgICAgICBtZS5ib3R0b20gPSBtZS5oZWlnaHQ7CiAgICAgIH0gLy8gUmVzZXQgcGFkZGluZwoKCiAgICAgIG1lLnBhZGRpbmdMZWZ0ID0gMDsKICAgICAgbWUucGFkZGluZ1RvcCA9IDA7CiAgICAgIG1lLnBhZGRpbmdSaWdodCA9IDA7CiAgICAgIG1lLnBhZGRpbmdCb3R0b20gPSAwOwogICAgfSwKICAgIGFmdGVyU2V0RGltZW5zaW9uczogZnVuY3Rpb24gYWZ0ZXJTZXREaW1lbnNpb25zKCkgewogICAgICBoZWxwZXJzJDEuY2FsbGJhY2sodGhpcy5vcHRpb25zLmFmdGVyU2V0RGltZW5zaW9ucywgW3RoaXNdKTsKICAgIH0sCiAgICAvLyBEYXRhIGxpbWl0cwogICAgYmVmb3JlRGF0YUxpbWl0czogZnVuY3Rpb24gYmVmb3JlRGF0YUxpbWl0cygpIHsKICAgICAgaGVscGVycyQxLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5iZWZvcmVEYXRhTGltaXRzLCBbdGhpc10pOwogICAgfSwKICAgIGRldGVybWluZURhdGFMaW1pdHM6IGhlbHBlcnMkMS5ub29wLAogICAgYWZ0ZXJEYXRhTGltaXRzOiBmdW5jdGlvbiBhZnRlckRhdGFMaW1pdHMoKSB7CiAgICAgIGhlbHBlcnMkMS5jYWxsYmFjayh0aGlzLm9wdGlvbnMuYWZ0ZXJEYXRhTGltaXRzLCBbdGhpc10pOwogICAgfSwKICAgIC8vCiAgICBiZWZvcmVCdWlsZFRpY2tzOiBmdW5jdGlvbiBiZWZvcmVCdWlsZFRpY2tzKCkgewogICAgICBoZWxwZXJzJDEuY2FsbGJhY2sodGhpcy5vcHRpb25zLmJlZm9yZUJ1aWxkVGlja3MsIFt0aGlzXSk7CiAgICB9LAogICAgYnVpbGRUaWNrczogaGVscGVycyQxLm5vb3AsCiAgICBhZnRlckJ1aWxkVGlja3M6IGZ1bmN0aW9uIGFmdGVyQnVpbGRUaWNrcyh0aWNrcykgewogICAgICB2YXIgbWUgPSB0aGlzOyAvLyB0aWNrcyBpcyBlbXB0eSBmb3Igb2xkIGF4aXMgaW1wbGVtZW50YXRpb25zIGhlcmUKCiAgICAgIGlmIChpc0FycmF5KHRpY2tzKSAmJiB0aWNrcy5sZW5ndGgpIHsKICAgICAgICByZXR1cm4gaGVscGVycyQxLmNhbGxiYWNrKG1lLm9wdGlvbnMuYWZ0ZXJCdWlsZFRpY2tzLCBbbWUsIHRpY2tzXSk7CiAgICAgIH0gLy8gU3VwcG9ydCBvbGQgaW1wbGVtZW50YXRpb25zICh0aGF0IG1vZGlmaWVkIGB0aGlzLnRpY2tzYCBkaXJlY3RseSBpbiBidWlsZFRpY2tzKQoKCiAgICAgIG1lLnRpY2tzID0gaGVscGVycyQxLmNhbGxiYWNrKG1lLm9wdGlvbnMuYWZ0ZXJCdWlsZFRpY2tzLCBbbWUsIG1lLnRpY2tzXSkgfHwgbWUudGlja3M7CiAgICAgIHJldHVybiB0aWNrczsKICAgIH0sCiAgICBiZWZvcmVUaWNrVG9MYWJlbENvbnZlcnNpb246IGZ1bmN0aW9uIGJlZm9yZVRpY2tUb0xhYmVsQ29udmVyc2lvbigpIHsKICAgICAgaGVscGVycyQxLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5iZWZvcmVUaWNrVG9MYWJlbENvbnZlcnNpb24sIFt0aGlzXSk7CiAgICB9LAogICAgY29udmVydFRpY2tzVG9MYWJlbHM6IGZ1bmN0aW9uIGNvbnZlcnRUaWNrc1RvTGFiZWxzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOyAvLyBDb252ZXJ0IHRpY2tzIHRvIHN0cmluZ3MKCiAgICAgIHZhciB0aWNrT3B0cyA9IG1lLm9wdGlvbnMudGlja3M7CiAgICAgIG1lLnRpY2tzID0gbWUudGlja3MubWFwKHRpY2tPcHRzLnVzZXJDYWxsYmFjayB8fCB0aWNrT3B0cy5jYWxsYmFjaywgdGhpcyk7CiAgICB9LAogICAgYWZ0ZXJUaWNrVG9MYWJlbENvbnZlcnNpb246IGZ1bmN0aW9uIGFmdGVyVGlja1RvTGFiZWxDb252ZXJzaW9uKCkgewogICAgICBoZWxwZXJzJDEuY2FsbGJhY2sodGhpcy5vcHRpb25zLmFmdGVyVGlja1RvTGFiZWxDb252ZXJzaW9uLCBbdGhpc10pOwogICAgfSwKICAgIC8vCiAgICBiZWZvcmVDYWxjdWxhdGVUaWNrUm90YXRpb246IGZ1bmN0aW9uIGJlZm9yZUNhbGN1bGF0ZVRpY2tSb3RhdGlvbigpIHsKICAgICAgaGVscGVycyQxLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5iZWZvcmVDYWxjdWxhdGVUaWNrUm90YXRpb24sIFt0aGlzXSk7CiAgICB9LAogICAgY2FsY3VsYXRlVGlja1JvdGF0aW9uOiBmdW5jdGlvbiBjYWxjdWxhdGVUaWNrUm90YXRpb24oKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBvcHRpb25zID0gbWUub3B0aW9uczsKICAgICAgdmFyIHRpY2tPcHRzID0gb3B0aW9ucy50aWNrczsKICAgICAgdmFyIG51bVRpY2tzID0gbWUuZ2V0VGlja3MoKS5sZW5ndGg7CiAgICAgIHZhciBtaW5Sb3RhdGlvbiA9IHRpY2tPcHRzLm1pblJvdGF0aW9uIHx8IDA7CiAgICAgIHZhciBtYXhSb3RhdGlvbiA9IHRpY2tPcHRzLm1heFJvdGF0aW9uOwogICAgICB2YXIgbGFiZWxSb3RhdGlvbiA9IG1pblJvdGF0aW9uOwogICAgICB2YXIgbGFiZWxTaXplcywgbWF4TGFiZWxXaWR0aCwgbWF4TGFiZWxIZWlnaHQsIG1heFdpZHRoLCB0aWNrV2lkdGgsIG1heEhlaWdodCwgbWF4TGFiZWxEaWFnb25hbDsKCiAgICAgIGlmICghbWUuX2lzVmlzaWJsZSgpIHx8ICF0aWNrT3B0cy5kaXNwbGF5IHx8IG1pblJvdGF0aW9uID49IG1heFJvdGF0aW9uIHx8IG51bVRpY2tzIDw9IDEgfHwgIW1lLmlzSG9yaXpvbnRhbCgpKSB7CiAgICAgICAgbWUubGFiZWxSb3RhdGlvbiA9IG1pblJvdGF0aW9uOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgbGFiZWxTaXplcyA9IG1lLl9nZXRMYWJlbFNpemVzKCk7CiAgICAgIG1heExhYmVsV2lkdGggPSBsYWJlbFNpemVzLndpZGVzdC53aWR0aDsKICAgICAgbWF4TGFiZWxIZWlnaHQgPSBsYWJlbFNpemVzLmhpZ2hlc3QuaGVpZ2h0IC0gbGFiZWxTaXplcy5oaWdoZXN0Lm9mZnNldDsgLy8gRXN0aW1hdGUgdGhlIHdpZHRoIG9mIGVhY2ggZ3JpZCBiYXNlZCBvbiB0aGUgY2FudmFzIHdpZHRoLCB0aGUgbWF4aW11bQogICAgICAvLyBsYWJlbCB3aWR0aCBhbmQgdGhlIG51bWJlciBvZiB0aWNrIGludGVydmFscwoKICAgICAgbWF4V2lkdGggPSBNYXRoLm1pbihtZS5tYXhXaWR0aCwgbWUuY2hhcnQud2lkdGggLSBtYXhMYWJlbFdpZHRoKTsKICAgICAgdGlja1dpZHRoID0gb3B0aW9ucy5vZmZzZXQgPyBtZS5tYXhXaWR0aCAvIG51bVRpY2tzIDogbWF4V2lkdGggLyAobnVtVGlja3MgLSAxKTsgLy8gQWxsb3cgMyBwaXhlbHMgeDIgcGFkZGluZyBlaXRoZXIgc2lkZSBmb3IgbGFiZWwgcmVhZGFiaWxpdHkKCiAgICAgIGlmIChtYXhMYWJlbFdpZHRoICsgNiA+IHRpY2tXaWR0aCkgewogICAgICAgIHRpY2tXaWR0aCA9IG1heFdpZHRoIC8gKG51bVRpY2tzIC0gKG9wdGlvbnMub2Zmc2V0ID8gMC41IDogMSkpOwogICAgICAgIG1heEhlaWdodCA9IG1lLm1heEhlaWdodCAtIGdldFRpY2tNYXJrTGVuZ3RoKG9wdGlvbnMuZ3JpZExpbmVzKSAtIHRpY2tPcHRzLnBhZGRpbmcgLSBnZXRTY2FsZUxhYmVsSGVpZ2h0KG9wdGlvbnMuc2NhbGVMYWJlbCk7CiAgICAgICAgbWF4TGFiZWxEaWFnb25hbCA9IE1hdGguc3FydChtYXhMYWJlbFdpZHRoICogbWF4TGFiZWxXaWR0aCArIG1heExhYmVsSGVpZ2h0ICogbWF4TGFiZWxIZWlnaHQpOwogICAgICAgIGxhYmVsUm90YXRpb24gPSBoZWxwZXJzJDEudG9EZWdyZWVzKE1hdGgubWluKE1hdGguYXNpbihNYXRoLm1pbigobGFiZWxTaXplcy5oaWdoZXN0LmhlaWdodCArIDYpIC8gdGlja1dpZHRoLCAxKSksIE1hdGguYXNpbihNYXRoLm1pbihtYXhIZWlnaHQgLyBtYXhMYWJlbERpYWdvbmFsLCAxKSkgLSBNYXRoLmFzaW4obWF4TGFiZWxIZWlnaHQgLyBtYXhMYWJlbERpYWdvbmFsKSkpOwogICAgICAgIGxhYmVsUm90YXRpb24gPSBNYXRoLm1heChtaW5Sb3RhdGlvbiwgTWF0aC5taW4obWF4Um90YXRpb24sIGxhYmVsUm90YXRpb24pKTsKICAgICAgfQoKICAgICAgbWUubGFiZWxSb3RhdGlvbiA9IGxhYmVsUm90YXRpb247CiAgICB9LAogICAgYWZ0ZXJDYWxjdWxhdGVUaWNrUm90YXRpb246IGZ1bmN0aW9uIGFmdGVyQ2FsY3VsYXRlVGlja1JvdGF0aW9uKCkgewogICAgICBoZWxwZXJzJDEuY2FsbGJhY2sodGhpcy5vcHRpb25zLmFmdGVyQ2FsY3VsYXRlVGlja1JvdGF0aW9uLCBbdGhpc10pOwogICAgfSwKICAgIC8vCiAgICBiZWZvcmVGaXQ6IGZ1bmN0aW9uIGJlZm9yZUZpdCgpIHsKICAgICAgaGVscGVycyQxLmNhbGxiYWNrKHRoaXMub3B0aW9ucy5iZWZvcmVGaXQsIFt0aGlzXSk7CiAgICB9LAogICAgZml0OiBmdW5jdGlvbiBmaXQoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7IC8vIFJlc2V0CgogICAgICB2YXIgbWluU2l6ZSA9IG1lLm1pblNpemUgPSB7CiAgICAgICAgd2lkdGg6IDAsCiAgICAgICAgaGVpZ2h0OiAwCiAgICAgIH07CiAgICAgIHZhciBjaGFydCA9IG1lLmNoYXJ0OwogICAgICB2YXIgb3B0cyA9IG1lLm9wdGlvbnM7CiAgICAgIHZhciB0aWNrT3B0cyA9IG9wdHMudGlja3M7CiAgICAgIHZhciBzY2FsZUxhYmVsT3B0cyA9IG9wdHMuc2NhbGVMYWJlbDsKICAgICAgdmFyIGdyaWRMaW5lT3B0cyA9IG9wdHMuZ3JpZExpbmVzOwoKICAgICAgdmFyIGRpc3BsYXkgPSBtZS5faXNWaXNpYmxlKCk7CgogICAgICB2YXIgaXNCb3R0b20gPSBvcHRzLnBvc2l0aW9uID09PSAnYm90dG9tJzsKICAgICAgdmFyIGlzSG9yaXpvbnRhbCA9IG1lLmlzSG9yaXpvbnRhbCgpOyAvLyBXaWR0aAoKICAgICAgaWYgKGlzSG9yaXpvbnRhbCkgewogICAgICAgIG1pblNpemUud2lkdGggPSBtZS5tYXhXaWR0aDsKICAgICAgfSBlbHNlIGlmIChkaXNwbGF5KSB7CiAgICAgICAgbWluU2l6ZS53aWR0aCA9IGdldFRpY2tNYXJrTGVuZ3RoKGdyaWRMaW5lT3B0cykgKyBnZXRTY2FsZUxhYmVsSGVpZ2h0KHNjYWxlTGFiZWxPcHRzKTsKICAgICAgfSAvLyBoZWlnaHQKCgogICAgICBpZiAoIWlzSG9yaXpvbnRhbCkgewogICAgICAgIG1pblNpemUuaGVpZ2h0ID0gbWUubWF4SGVpZ2h0OyAvLyBmaWxsIGFsbCB0aGUgaGVpZ2h0CiAgICAgIH0gZWxzZSBpZiAoZGlzcGxheSkgewogICAgICAgIG1pblNpemUuaGVpZ2h0ID0gZ2V0VGlja01hcmtMZW5ndGgoZ3JpZExpbmVPcHRzKSArIGdldFNjYWxlTGFiZWxIZWlnaHQoc2NhbGVMYWJlbE9wdHMpOwogICAgICB9IC8vIERvbid0IGJvdGhlciBmaXR0aW5nIHRoZSB0aWNrcyBpZiB3ZSBhcmUgbm90IHNob3dpbmcgdGhlIGxhYmVscwoKCiAgICAgIGlmICh0aWNrT3B0cy5kaXNwbGF5ICYmIGRpc3BsYXkpIHsKICAgICAgICB2YXIgdGlja0ZvbnRzID0gcGFyc2VUaWNrRm9udE9wdGlvbnModGlja09wdHMpOwoKICAgICAgICB2YXIgbGFiZWxTaXplcyA9IG1lLl9nZXRMYWJlbFNpemVzKCk7CgogICAgICAgIHZhciBmaXJzdExhYmVsU2l6ZSA9IGxhYmVsU2l6ZXMuZmlyc3Q7CiAgICAgICAgdmFyIGxhc3RMYWJlbFNpemUgPSBsYWJlbFNpemVzLmxhc3Q7CiAgICAgICAgdmFyIHdpZGVzdExhYmVsU2l6ZSA9IGxhYmVsU2l6ZXMud2lkZXN0OwogICAgICAgIHZhciBoaWdoZXN0TGFiZWxTaXplID0gbGFiZWxTaXplcy5oaWdoZXN0OwogICAgICAgIHZhciBsaW5lU3BhY2UgPSB0aWNrRm9udHMubWlub3IubGluZUhlaWdodCAqIDAuNDsKICAgICAgICB2YXIgdGlja1BhZGRpbmcgPSB0aWNrT3B0cy5wYWRkaW5nOwoKICAgICAgICBpZiAoaXNIb3Jpem9udGFsKSB7CiAgICAgICAgICAvLyBBIGhvcml6b250YWwgYXhpcyBpcyBtb3JlIGNvbnN0cmFpbmVkIGJ5IHRoZSBoZWlnaHQuCiAgICAgICAgICB2YXIgaXNSb3RhdGVkID0gbWUubGFiZWxSb3RhdGlvbiAhPT0gMDsKICAgICAgICAgIHZhciBhbmdsZVJhZGlhbnMgPSBoZWxwZXJzJDEudG9SYWRpYW5zKG1lLmxhYmVsUm90YXRpb24pOwogICAgICAgICAgdmFyIGNvc1JvdGF0aW9uID0gTWF0aC5jb3MoYW5nbGVSYWRpYW5zKTsKICAgICAgICAgIHZhciBzaW5Sb3RhdGlvbiA9IE1hdGguc2luKGFuZ2xlUmFkaWFucyk7CiAgICAgICAgICB2YXIgbGFiZWxIZWlnaHQgPSBzaW5Sb3RhdGlvbiAqIHdpZGVzdExhYmVsU2l6ZS53aWR0aCArIGNvc1JvdGF0aW9uICogKGhpZ2hlc3RMYWJlbFNpemUuaGVpZ2h0IC0gKGlzUm90YXRlZCA/IGhpZ2hlc3RMYWJlbFNpemUub2Zmc2V0IDogMCkpICsgKGlzUm90YXRlZCA/IDAgOiBsaW5lU3BhY2UpOyAvLyBwYWRkaW5nCgogICAgICAgICAgbWluU2l6ZS5oZWlnaHQgPSBNYXRoLm1pbihtZS5tYXhIZWlnaHQsIG1pblNpemUuaGVpZ2h0ICsgbGFiZWxIZWlnaHQgKyB0aWNrUGFkZGluZyk7CiAgICAgICAgICB2YXIgb2Zmc2V0TGVmdCA9IG1lLmdldFBpeGVsRm9yVGljaygwKSAtIG1lLmxlZnQ7CiAgICAgICAgICB2YXIgb2Zmc2V0UmlnaHQgPSBtZS5yaWdodCAtIG1lLmdldFBpeGVsRm9yVGljayhtZS5nZXRUaWNrcygpLmxlbmd0aCAtIDEpOwogICAgICAgICAgdmFyIHBhZGRpbmdMZWZ0LCBwYWRkaW5nUmlnaHQ7IC8vIEVuc3VyZSB0aGF0IG91ciB0aWNrcyBhcmUgYWx3YXlzIGluc2lkZSB0aGUgY2FudmFzLiBXaGVuIHJvdGF0ZWQsIHRpY2tzIGFyZSByaWdodCBhbGlnbmVkCiAgICAgICAgICAvLyB3aGljaCBtZWFucyB0aGF0IHRoZSByaWdodCBwYWRkaW5nIGlzIGRvbWluYXRlZCBieSB0aGUgZm9udCBoZWlnaHQKCiAgICAgICAgICBpZiAoaXNSb3RhdGVkKSB7CiAgICAgICAgICAgIHBhZGRpbmdMZWZ0ID0gaXNCb3R0b20gPyBjb3NSb3RhdGlvbiAqIGZpcnN0TGFiZWxTaXplLndpZHRoICsgc2luUm90YXRpb24gKiBmaXJzdExhYmVsU2l6ZS5vZmZzZXQgOiBzaW5Sb3RhdGlvbiAqIChmaXJzdExhYmVsU2l6ZS5oZWlnaHQgLSBmaXJzdExhYmVsU2l6ZS5vZmZzZXQpOwogICAgICAgICAgICBwYWRkaW5nUmlnaHQgPSBpc0JvdHRvbSA/IHNpblJvdGF0aW9uICogKGxhc3RMYWJlbFNpemUuaGVpZ2h0IC0gbGFzdExhYmVsU2l6ZS5vZmZzZXQpIDogY29zUm90YXRpb24gKiBsYXN0TGFiZWxTaXplLndpZHRoICsgc2luUm90YXRpb24gKiBsYXN0TGFiZWxTaXplLm9mZnNldDsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHBhZGRpbmdMZWZ0ID0gZmlyc3RMYWJlbFNpemUud2lkdGggLyAyOwogICAgICAgICAgICBwYWRkaW5nUmlnaHQgPSBsYXN0TGFiZWxTaXplLndpZHRoIC8gMjsKICAgICAgICAgIH0gLy8gQWRqdXN0IHBhZGRpbmcgdGFraW5nIGludG8gYWNjb3VudCBjaGFuZ2VzIGluIG9mZnNldHMKICAgICAgICAgIC8vIGFuZCBhZGQgMyBweCB0byBtb3ZlIGF3YXkgZnJvbSBjYW52YXMgZWRnZXMKCgogICAgICAgICAgbWUucGFkZGluZ0xlZnQgPSBNYXRoLm1heCgocGFkZGluZ0xlZnQgLSBvZmZzZXRMZWZ0KSAqIG1lLndpZHRoIC8gKG1lLndpZHRoIC0gb2Zmc2V0TGVmdCksIDApICsgMzsKICAgICAgICAgIG1lLnBhZGRpbmdSaWdodCA9IE1hdGgubWF4KChwYWRkaW5nUmlnaHQgLSBvZmZzZXRSaWdodCkgKiBtZS53aWR0aCAvIChtZS53aWR0aCAtIG9mZnNldFJpZ2h0KSwgMCkgKyAzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyBBIHZlcnRpY2FsIGF4aXMgaXMgbW9yZSBjb25zdHJhaW5lZCBieSB0aGUgd2lkdGguIExhYmVscyBhcmUgdGhlCiAgICAgICAgICAvLyBkb21pbmFudCBmYWN0b3IgaGVyZSwgc28gZ2V0IHRoYXQgbGVuZ3RoIGZpcnN0IGFuZCBhY2NvdW50IGZvciBwYWRkaW5nCiAgICAgICAgICB2YXIgbGFiZWxXaWR0aCA9IHRpY2tPcHRzLm1pcnJvciA/IDAgOiAvLyB1c2UgbGluZVNwYWNlIGZvciBjb25zaXN0ZW5jeSB3aXRoIGhvcml6b250YWwgYXhpcwogICAgICAgICAgLy8gdGlja1BhZGRpbmcgaXMgbm90IGltcGxlbWVudGVkIGZvciBob3Jpem9udGFsCiAgICAgICAgICB3aWRlc3RMYWJlbFNpemUud2lkdGggKyB0aWNrUGFkZGluZyArIGxpbmVTcGFjZTsKICAgICAgICAgIG1pblNpemUud2lkdGggPSBNYXRoLm1pbihtZS5tYXhXaWR0aCwgbWluU2l6ZS53aWR0aCArIGxhYmVsV2lkdGgpOwogICAgICAgICAgbWUucGFkZGluZ1RvcCA9IGZpcnN0TGFiZWxTaXplLmhlaWdodCAvIDI7CiAgICAgICAgICBtZS5wYWRkaW5nQm90dG9tID0gbGFzdExhYmVsU2l6ZS5oZWlnaHQgLyAyOwogICAgICAgIH0KICAgICAgfQoKICAgICAgbWUuaGFuZGxlTWFyZ2lucygpOwoKICAgICAgaWYgKGlzSG9yaXpvbnRhbCkgewogICAgICAgIG1lLndpZHRoID0gbWUuX2xlbmd0aCA9IGNoYXJ0LndpZHRoIC0gbWUubWFyZ2lucy5sZWZ0IC0gbWUubWFyZ2lucy5yaWdodDsKICAgICAgICBtZS5oZWlnaHQgPSBtaW5TaXplLmhlaWdodDsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZS53aWR0aCA9IG1pblNpemUud2lkdGg7CiAgICAgICAgbWUuaGVpZ2h0ID0gbWUuX2xlbmd0aCA9IGNoYXJ0LmhlaWdodCAtIG1lLm1hcmdpbnMudG9wIC0gbWUubWFyZ2lucy5ib3R0b207CiAgICAgIH0KICAgIH0sCgogICAgLyoqDQogICAgICogSGFuZGxlIG1hcmdpbnMgYW5kIHBhZGRpbmcgaW50ZXJhY3Rpb25zDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIGhhbmRsZU1hcmdpbnM6IGZ1bmN0aW9uIGhhbmRsZU1hcmdpbnMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CgogICAgICBpZiAobWUubWFyZ2lucykgewogICAgICAgIG1lLm1hcmdpbnMubGVmdCA9IE1hdGgubWF4KG1lLnBhZGRpbmdMZWZ0LCBtZS5tYXJnaW5zLmxlZnQpOwogICAgICAgIG1lLm1hcmdpbnMudG9wID0gTWF0aC5tYXgobWUucGFkZGluZ1RvcCwgbWUubWFyZ2lucy50b3ApOwogICAgICAgIG1lLm1hcmdpbnMucmlnaHQgPSBNYXRoLm1heChtZS5wYWRkaW5nUmlnaHQsIG1lLm1hcmdpbnMucmlnaHQpOwogICAgICAgIG1lLm1hcmdpbnMuYm90dG9tID0gTWF0aC5tYXgobWUucGFkZGluZ0JvdHRvbSwgbWUubWFyZ2lucy5ib3R0b20pOwogICAgICB9CiAgICB9LAogICAgYWZ0ZXJGaXQ6IGZ1bmN0aW9uIGFmdGVyRml0KCkgewogICAgICBoZWxwZXJzJDEuY2FsbGJhY2sodGhpcy5vcHRpb25zLmFmdGVyRml0LCBbdGhpc10pOwogICAgfSwKICAgIC8vIFNoYXJlZCBNZXRob2RzCiAgICBpc0hvcml6b250YWw6IGZ1bmN0aW9uIGlzSG9yaXpvbnRhbCgpIHsKICAgICAgdmFyIHBvcyA9IHRoaXMub3B0aW9ucy5wb3NpdGlvbjsKICAgICAgcmV0dXJuIHBvcyA9PT0gJ3RvcCcgfHwgcG9zID09PSAnYm90dG9tJzsKICAgIH0sCiAgICBpc0Z1bGxXaWR0aDogZnVuY3Rpb24gaXNGdWxsV2lkdGgoKSB7CiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMuZnVsbFdpZHRoOwogICAgfSwKICAgIC8vIEdldCB0aGUgY29ycmVjdCB2YWx1ZS4gTmFOIGJhZCBpbnB1dHMsIElmIHRoZSB2YWx1ZSB0eXBlIGlzIG9iamVjdCBnZXQgdGhlIHggb3IgeSBiYXNlZCBvbiB3aGV0aGVyIHdlIGFyZSBob3Jpem9udGFsIG9yIG5vdAogICAgZ2V0UmlnaHRWYWx1ZTogZnVuY3Rpb24gZ2V0UmlnaHRWYWx1ZShyYXdWYWx1ZSkgewogICAgICAvLyBOdWxsIGFuZCB1bmRlZmluZWQgdmFsdWVzIGZpcnN0CiAgICAgIGlmIChpc051bGxPclVuZGVmKHJhd1ZhbHVlKSkgewogICAgICAgIHJldHVybiBOYU47CiAgICAgIH0gLy8gaXNOYU4ob2JqZWN0KSByZXR1cm5zIHRydWUsIHNvIG1ha2Ugc3VyZSBOYU4gaXMgY2hlY2tpbmcgZm9yIGEgbnVtYmVyOyBEaXNjYXJkIEluZmluaXRlIHZhbHVlcwoKCiAgICAgIGlmICgodHlwZW9mIHJhd1ZhbHVlID09PSAnbnVtYmVyJyB8fCByYXdWYWx1ZSBpbnN0YW5jZW9mIE51bWJlcikgJiYgIWlzRmluaXRlKHJhd1ZhbHVlKSkgewogICAgICAgIHJldHVybiBOYU47CiAgICAgIH0gLy8gSWYgaXQgaXMgaW4gZmFjdCBhbiBvYmplY3QsIGRpdmUgaW4gb25lIG1vcmUgbGV2ZWwKCgogICAgICBpZiAocmF3VmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5pc0hvcml6b250YWwoKSkgewogICAgICAgICAgaWYgKHJhd1ZhbHVlLnggIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRSaWdodFZhbHVlKHJhd1ZhbHVlLngpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAocmF3VmFsdWUueSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICByZXR1cm4gdGhpcy5nZXRSaWdodFZhbHVlKHJhd1ZhbHVlLnkpOwogICAgICAgIH0KICAgICAgfSAvLyBWYWx1ZSBpcyBnb29kLCByZXR1cm4gaXQKCgogICAgICByZXR1cm4gcmF3VmFsdWU7CiAgICB9LAogICAgX2NvbnZlcnRUaWNrc1RvTGFiZWxzOiBmdW5jdGlvbiBfY29udmVydFRpY2tzVG9MYWJlbHModGlja3MpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGxhYmVscywgaSwgaWxlbjsKICAgICAgbWUudGlja3MgPSB0aWNrcy5tYXAoZnVuY3Rpb24gKHRpY2spIHsKICAgICAgICByZXR1cm4gdGljay52YWx1ZTsKICAgICAgfSk7CiAgICAgIG1lLmJlZm9yZVRpY2tUb0xhYmVsQ29udmVyc2lvbigpOyAvLyBOZXcgaW1wbGVtZW50YXRpb25zIHNob3VsZCByZXR1cm4gdGhlIGZvcm1hdHRlZCB0aWNrIGxhYmVscyBidXQgZm9yIEJBQ0tXQVJECiAgICAgIC8vIENPTVBBVCwgd2Ugc3RpbGwgc3VwcG9ydCBubyByZXR1cm4gKGB0aGlzLnRpY2tzYCBpbnRlcm5hbGx5IGNoYW5nZWQgYnkgY2FsbGluZwogICAgICAvLyB0aGlzIG1ldGhvZCBhbmQgc3VwcG9zZWQgdG8gY29udGFpbiBvbmx5IHN0cmluZyB2YWx1ZXMpLgoKICAgICAgbGFiZWxzID0gbWUuY29udmVydFRpY2tzVG9MYWJlbHModGlja3MpIHx8IG1lLnRpY2tzOwogICAgICBtZS5hZnRlclRpY2tUb0xhYmVsQ29udmVyc2lvbigpOyAvLyBCQUNLV0FSRCBDT01QQVQ6IHN5bmNocm9uaXplIGBfdGlja3NgIHdpdGggbGFiZWxzIChzbyBwb3RlbnRpYWxseSBgdGhpcy50aWNrc2ApCgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gdGlja3MubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgdGlja3NbaV0ubGFiZWwgPSBsYWJlbHNbaV07CiAgICAgIH0KCiAgICAgIHJldHVybiBsYWJlbHM7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZ2V0TGFiZWxTaXplczogZnVuY3Rpb24gX2dldExhYmVsU2l6ZXMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBsYWJlbFNpemVzID0gbWUuX2xhYmVsU2l6ZXM7CgogICAgICBpZiAoIWxhYmVsU2l6ZXMpIHsKICAgICAgICBtZS5fbGFiZWxTaXplcyA9IGxhYmVsU2l6ZXMgPSBjb21wdXRlTGFiZWxTaXplcyhtZS5jdHgsIHBhcnNlVGlja0ZvbnRPcHRpb25zKG1lLm9wdGlvbnMudGlja3MpLCBtZS5nZXRUaWNrcygpLCBtZS5sb25nZXN0VGV4dENhY2hlKTsKICAgICAgICBtZS5sb25nZXN0TGFiZWxXaWR0aCA9IGxhYmVsU2l6ZXMud2lkZXN0LndpZHRoOwogICAgICB9CgogICAgICByZXR1cm4gbGFiZWxTaXplczsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9wYXJzZVZhbHVlOiBmdW5jdGlvbiBfcGFyc2VWYWx1ZSh2YWx1ZSkgewogICAgICB2YXIgc3RhcnQsIGVuZCwgbWluLCBtYXg7CgogICAgICBpZiAoaXNBcnJheSh2YWx1ZSkpIHsKICAgICAgICBzdGFydCA9ICt0aGlzLmdldFJpZ2h0VmFsdWUodmFsdWVbMF0pOwogICAgICAgIGVuZCA9ICt0aGlzLmdldFJpZ2h0VmFsdWUodmFsdWVbMV0pOwogICAgICAgIG1pbiA9IE1hdGgubWluKHN0YXJ0LCBlbmQpOwogICAgICAgIG1heCA9IE1hdGgubWF4KHN0YXJ0LCBlbmQpOwogICAgICB9IGVsc2UgewogICAgICAgIHZhbHVlID0gK3RoaXMuZ2V0UmlnaHRWYWx1ZSh2YWx1ZSk7CiAgICAgICAgc3RhcnQgPSB1bmRlZmluZWQ7CiAgICAgICAgZW5kID0gdmFsdWU7CiAgICAgICAgbWluID0gdmFsdWU7CiAgICAgICAgbWF4ID0gdmFsdWU7CiAgICAgIH0KCiAgICAgIHJldHVybiB7CiAgICAgICAgbWluOiBtaW4sCiAgICAgICAgbWF4OiBtYXgsCiAgICAgICAgc3RhcnQ6IHN0YXJ0LAogICAgICAgIGVuZDogZW5kCiAgICAgIH07CiAgICB9LAoKICAgIC8qKg0KICAgICogQHByaXZhdGUNCiAgICAqLwogICAgX2dldFNjYWxlTGFiZWw6IGZ1bmN0aW9uIF9nZXRTY2FsZUxhYmVsKHJhd1ZhbHVlKSB7CiAgICAgIHZhciB2ID0gdGhpcy5fcGFyc2VWYWx1ZShyYXdWYWx1ZSk7CgogICAgICBpZiAodi5zdGFydCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmV0dXJuICdbJyArIHYuc3RhcnQgKyAnLCAnICsgdi5lbmQgKyAnXSc7CiAgICAgIH0KCiAgICAgIHJldHVybiArdGhpcy5nZXRSaWdodFZhbHVlKHJhd1ZhbHVlKTsKICAgIH0sCgogICAgLyoqDQogICAgICogVXNlZCB0byBnZXQgdGhlIHZhbHVlIHRvIGRpc3BsYXkgaW4gdGhlIHRvb2x0aXAgZm9yIHRoZSBkYXRhIGF0IHRoZSBnaXZlbiBpbmRleA0KICAgICAqIEBwYXJhbSBpbmRleA0KICAgICAqIEBwYXJhbSBkYXRhc2V0SW5kZXgNCiAgICAgKi8KICAgIGdldExhYmVsRm9ySW5kZXg6IGhlbHBlcnMkMS5ub29wLAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgdGhlIGxvY2F0aW9uIG9mIHRoZSBnaXZlbiBkYXRhIHBvaW50LiBWYWx1ZSBjYW4gZWl0aGVyIGJlIGFuIGluZGV4IG9yIGEgbnVtZXJpY2FsIHZhbHVlDQogICAgICogVGhlIGNvb3JkaW5hdGUgKDAsIDApIGlzIGF0IHRoZSB1cHBlci1sZWZ0IGNvcm5lciBvZiB0aGUgY2FudmFzDQogICAgICogQHBhcmFtIHZhbHVlDQogICAgICogQHBhcmFtIGluZGV4DQogICAgICogQHBhcmFtIGRhdGFzZXRJbmRleA0KICAgICAqLwogICAgZ2V0UGl4ZWxGb3JWYWx1ZTogaGVscGVycyQxLm5vb3AsCgogICAgLyoqDQogICAgICogVXNlZCB0byBnZXQgdGhlIGRhdGEgdmFsdWUgZnJvbSBhIGdpdmVuIHBpeGVsLiBUaGlzIGlzIHRoZSBpbnZlcnNlIG9mIGdldFBpeGVsRm9yVmFsdWUNCiAgICAgKiBUaGUgY29vcmRpbmF0ZSAoMCwgMCkgaXMgYXQgdGhlIHVwcGVyLWxlZnQgY29ybmVyIG9mIHRoZSBjYW52YXMNCiAgICAgKiBAcGFyYW0gcGl4ZWwNCiAgICAgKi8KICAgIGdldFZhbHVlRm9yUGl4ZWw6IGhlbHBlcnMkMS5ub29wLAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgdGhlIGxvY2F0aW9uIG9mIHRoZSB0aWNrIGF0IHRoZSBnaXZlbiBpbmRleA0KICAgICAqIFRoZSBjb29yZGluYXRlICgwLCAwKSBpcyBhdCB0aGUgdXBwZXItbGVmdCBjb3JuZXIgb2YgdGhlIGNhbnZhcw0KICAgICAqLwogICAgZ2V0UGl4ZWxGb3JUaWNrOiBmdW5jdGlvbiBnZXRQaXhlbEZvclRpY2soaW5kZXgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9mZnNldCA9IG1lLm9wdGlvbnMub2Zmc2V0OwogICAgICB2YXIgbnVtVGlja3MgPSBtZS5fdGlja3MubGVuZ3RoOwogICAgICB2YXIgdGlja1dpZHRoID0gMSAvIE1hdGgubWF4KG51bVRpY2tzIC0gKG9mZnNldCA/IDAgOiAxKSwgMSk7CiAgICAgIHJldHVybiBpbmRleCA8IDAgfHwgaW5kZXggPiBudW1UaWNrcyAtIDEgPyBudWxsIDogbWUuZ2V0UGl4ZWxGb3JEZWNpbWFsKGluZGV4ICogdGlja1dpZHRoICsgKG9mZnNldCA/IHRpY2tXaWR0aCAvIDIgOiAwKSk7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFV0aWxpdHkgZm9yIGdldHRpbmcgdGhlIHBpeGVsIGxvY2F0aW9uIG9mIGEgcGVyY2VudGFnZSBvZiBzY2FsZQ0KICAgICAqIFRoZSBjb29yZGluYXRlICgwLCAwKSBpcyBhdCB0aGUgdXBwZXItbGVmdCBjb3JuZXIgb2YgdGhlIGNhbnZhcw0KICAgICAqLwogICAgZ2V0UGl4ZWxGb3JEZWNpbWFsOiBmdW5jdGlvbiBnZXRQaXhlbEZvckRlY2ltYWwoZGVjaW1hbCkgewogICAgICB2YXIgbWUgPSB0aGlzOwoKICAgICAgaWYgKG1lLl9yZXZlcnNlUGl4ZWxzKSB7CiAgICAgICAgZGVjaW1hbCA9IDEgLSBkZWNpbWFsOwogICAgICB9CgogICAgICByZXR1cm4gbWUuX3N0YXJ0UGl4ZWwgKyBkZWNpbWFsICogbWUuX2xlbmd0aDsKICAgIH0sCiAgICBnZXREZWNpbWFsRm9yUGl4ZWw6IGZ1bmN0aW9uIGdldERlY2ltYWxGb3JQaXhlbChwaXhlbCkgewogICAgICB2YXIgZGVjaW1hbCA9IChwaXhlbCAtIHRoaXMuX3N0YXJ0UGl4ZWwpIC8gdGhpcy5fbGVuZ3RoOwogICAgICByZXR1cm4gdGhpcy5fcmV2ZXJzZVBpeGVscyA/IDEgLSBkZWNpbWFsIDogZGVjaW1hbDsKICAgIH0sCgogICAgLyoqDQogICAgICogUmV0dXJucyB0aGUgcGl4ZWwgZm9yIHRoZSBtaW5pbXVtIGNoYXJ0IHZhbHVlDQogICAgICogVGhlIGNvb3JkaW5hdGUgKDAsIDApIGlzIGF0IHRoZSB1cHBlci1sZWZ0IGNvcm5lciBvZiB0aGUgY2FudmFzDQogICAgICovCiAgICBnZXRCYXNlUGl4ZWw6IGZ1bmN0aW9uIGdldEJhc2VQaXhlbCgpIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0UGl4ZWxGb3JWYWx1ZSh0aGlzLmdldEJhc2VWYWx1ZSgpKTsKICAgIH0sCiAgICBnZXRCYXNlVmFsdWU6IGZ1bmN0aW9uIGdldEJhc2VWYWx1ZSgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG1pbiA9IG1lLm1pbjsKICAgICAgdmFyIG1heCA9IG1lLm1heDsKICAgICAgcmV0dXJuIG1lLmJlZ2luQXRaZXJvID8gMCA6IG1pbiA8IDAgJiYgbWF4IDwgMCA/IG1heCA6IG1pbiA+IDAgJiYgbWF4ID4gMCA/IG1pbiA6IDA7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFJldHVybnMgYSBzdWJzZXQgb2YgdGlja3MgdG8gYmUgcGxvdHRlZCB0byBhdm9pZCBvdmVybGFwcGluZyBsYWJlbHMuDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9hdXRvU2tpcDogZnVuY3Rpb24gX2F1dG9Ta2lwKHRpY2tzKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciB0aWNrT3B0cyA9IG1lLm9wdGlvbnMudGlja3M7CiAgICAgIHZhciBheGlzTGVuZ3RoID0gbWUuX2xlbmd0aDsKICAgICAgdmFyIHRpY2tzTGltaXQgPSB0aWNrT3B0cy5tYXhUaWNrc0xpbWl0IHx8IGF4aXNMZW5ndGggLyBtZS5fdGlja1NpemUoKSArIDE7CiAgICAgIHZhciBtYWpvckluZGljZXMgPSB0aWNrT3B0cy5tYWpvci5lbmFibGVkID8gZ2V0TWFqb3JJbmRpY2VzKHRpY2tzKSA6IFtdOwogICAgICB2YXIgbnVtTWFqb3JJbmRpY2VzID0gbWFqb3JJbmRpY2VzLmxlbmd0aDsKICAgICAgdmFyIGZpcnN0ID0gbWFqb3JJbmRpY2VzWzBdOwogICAgICB2YXIgbGFzdCA9IG1ham9ySW5kaWNlc1tudW1NYWpvckluZGljZXMgLSAxXTsKICAgICAgdmFyIGksIGlsZW4sIHNwYWNpbmcsIGF2Z01ham9yU3BhY2luZzsgLy8gSWYgdGhlcmUgYXJlIHRvbyBtYW55IG1ham9yIHRpY2tzIHRvIGRpc3BsYXkgdGhlbSBhbGwKCiAgICAgIGlmIChudW1NYWpvckluZGljZXMgPiB0aWNrc0xpbWl0KSB7CiAgICAgICAgc2tpcE1ham9ycyh0aWNrcywgbWFqb3JJbmRpY2VzLCBudW1NYWpvckluZGljZXMgLyB0aWNrc0xpbWl0KTsKICAgICAgICByZXR1cm4gbm9uU2tpcHBlZCh0aWNrcyk7CiAgICAgIH0KCiAgICAgIHNwYWNpbmcgPSBjYWxjdWxhdGVTcGFjaW5nKG1ham9ySW5kaWNlcywgdGlja3MsIGF4aXNMZW5ndGgsIHRpY2tzTGltaXQpOwoKICAgICAgaWYgKG51bU1ham9ySW5kaWNlcyA+IDApIHsKICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gbnVtTWFqb3JJbmRpY2VzIC0gMTsgaSA8IGlsZW47IGkrKykgewogICAgICAgICAgc2tpcCh0aWNrcywgc3BhY2luZywgbWFqb3JJbmRpY2VzW2ldLCBtYWpvckluZGljZXNbaSArIDFdKTsKICAgICAgICB9CgogICAgICAgIGF2Z01ham9yU3BhY2luZyA9IG51bU1ham9ySW5kaWNlcyA+IDEgPyAobGFzdCAtIGZpcnN0KSAvIChudW1NYWpvckluZGljZXMgLSAxKSA6IG51bGw7CiAgICAgICAgc2tpcCh0aWNrcywgc3BhY2luZywgaGVscGVycyQxLmlzTnVsbE9yVW5kZWYoYXZnTWFqb3JTcGFjaW5nKSA/IDAgOiBmaXJzdCAtIGF2Z01ham9yU3BhY2luZywgZmlyc3QpOwogICAgICAgIHNraXAodGlja3MsIHNwYWNpbmcsIGxhc3QsIGhlbHBlcnMkMS5pc051bGxPclVuZGVmKGF2Z01ham9yU3BhY2luZykgPyB0aWNrcy5sZW5ndGggOiBsYXN0ICsgYXZnTWFqb3JTcGFjaW5nKTsKICAgICAgICByZXR1cm4gbm9uU2tpcHBlZCh0aWNrcyk7CiAgICAgIH0KCiAgICAgIHNraXAodGlja3MsIHNwYWNpbmcpOwogICAgICByZXR1cm4gbm9uU2tpcHBlZCh0aWNrcyk7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfdGlja1NpemU6IGZ1bmN0aW9uIF90aWNrU2l6ZSgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9wdGlvblRpY2tzID0gbWUub3B0aW9ucy50aWNrczsgLy8gQ2FsY3VsYXRlIHNwYWNlIG5lZWRlZCBieSBsYWJlbCBpbiBheGlzIGRpcmVjdGlvbi4KCiAgICAgIHZhciByb3QgPSBoZWxwZXJzJDEudG9SYWRpYW5zKG1lLmxhYmVsUm90YXRpb24pOwogICAgICB2YXIgY29zID0gTWF0aC5hYnMoTWF0aC5jb3Mocm90KSk7CiAgICAgIHZhciBzaW4gPSBNYXRoLmFicyhNYXRoLnNpbihyb3QpKTsKCiAgICAgIHZhciBsYWJlbFNpemVzID0gbWUuX2dldExhYmVsU2l6ZXMoKTsKCiAgICAgIHZhciBwYWRkaW5nID0gb3B0aW9uVGlja3MuYXV0b1NraXBQYWRkaW5nIHx8IDA7CiAgICAgIHZhciB3ID0gbGFiZWxTaXplcyA/IGxhYmVsU2l6ZXMud2lkZXN0LndpZHRoICsgcGFkZGluZyA6IDA7CiAgICAgIHZhciBoID0gbGFiZWxTaXplcyA/IGxhYmVsU2l6ZXMuaGlnaGVzdC5oZWlnaHQgKyBwYWRkaW5nIDogMDsgLy8gQ2FsY3VsYXRlIHNwYWNlIG5lZWRlZCBmb3IgMSB0aWNrIGluIGF4aXMgZGlyZWN0aW9uLgoKICAgICAgcmV0dXJuIG1lLmlzSG9yaXpvbnRhbCgpID8gaCAqIGNvcyA+IHcgKiBzaW4gPyB3IC8gY29zIDogaCAvIHNpbiA6IGggKiBzaW4gPCB3ICogY29zID8gaCAvIGNvcyA6IHcgLyBzaW47CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfaXNWaXNpYmxlOiBmdW5jdGlvbiBfaXNWaXNpYmxlKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgY2hhcnQgPSBtZS5jaGFydDsKICAgICAgdmFyIGRpc3BsYXkgPSBtZS5vcHRpb25zLmRpc3BsYXk7CiAgICAgIHZhciBpLCBpbGVuLCBtZXRhOwoKICAgICAgaWYgKGRpc3BsYXkgIT09ICdhdXRvJykgewogICAgICAgIHJldHVybiAhIWRpc3BsYXk7CiAgICAgIH0gLy8gV2hlbiAnYXV0bycsIHRoZSBzY2FsZSBpcyB2aXNpYmxlIGlmIGF0IGxlYXN0IG9uZSBhc3NvY2lhdGVkIGRhdGFzZXQgaXMgdmlzaWJsZS4KCgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gY2hhcnQuZGF0YS5kYXRhc2V0cy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBpZiAoY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShpKSkgewogICAgICAgICAgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGkpOwoKICAgICAgICAgIGlmIChtZXRhLnhBeGlzSUQgPT09IG1lLmlkIHx8IG1ldGEueUF4aXNJRCA9PT0gbWUuaWQpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gZmFsc2U7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfY29tcHV0ZUdyaWRMaW5lSXRlbXM6IGZ1bmN0aW9uIF9jb21wdXRlR3JpZExpbmVJdGVtcyhjaGFydEFyZWEpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CiAgICAgIHZhciBvcHRpb25zID0gbWUub3B0aW9uczsKICAgICAgdmFyIGdyaWRMaW5lcyA9IG9wdGlvbnMuZ3JpZExpbmVzOwogICAgICB2YXIgcG9zaXRpb24gPSBvcHRpb25zLnBvc2l0aW9uOwogICAgICB2YXIgb2Zmc2V0R3JpZExpbmVzID0gZ3JpZExpbmVzLm9mZnNldEdyaWRMaW5lczsKICAgICAgdmFyIGlzSG9yaXpvbnRhbCA9IG1lLmlzSG9yaXpvbnRhbCgpOwogICAgICB2YXIgdGlja3MgPSBtZS5fdGlja3NUb0RyYXc7CiAgICAgIHZhciB0aWNrc0xlbmd0aCA9IHRpY2tzLmxlbmd0aCArIChvZmZzZXRHcmlkTGluZXMgPyAxIDogMCk7CiAgICAgIHZhciB0bCA9IGdldFRpY2tNYXJrTGVuZ3RoKGdyaWRMaW5lcyk7CiAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICB2YXIgYXhpc1dpZHRoID0gZ3JpZExpbmVzLmRyYXdCb3JkZXIgPyB2YWx1ZUF0SW5kZXhPckRlZmF1bHQoZ3JpZExpbmVzLmxpbmVXaWR0aCwgMCwgMCkgOiAwOwogICAgICB2YXIgYXhpc0hhbGZXaWR0aCA9IGF4aXNXaWR0aCAvIDI7CiAgICAgIHZhciBhbGlnblBpeGVsID0gaGVscGVycyQxLl9hbGlnblBpeGVsOwoKICAgICAgdmFyIGFsaWduQm9yZGVyVmFsdWUgPSBmdW5jdGlvbiBhbGlnbkJvcmRlclZhbHVlKHBpeGVsKSB7CiAgICAgICAgcmV0dXJuIGFsaWduUGl4ZWwoY2hhcnQsIHBpeGVsLCBheGlzV2lkdGgpOwogICAgICB9OwoKICAgICAgdmFyIGJvcmRlclZhbHVlLCBpLCB0aWNrLCBsaW5lVmFsdWUsIGFsaWduZWRMaW5lVmFsdWU7CiAgICAgIHZhciB0eDEsIHR5MSwgdHgyLCB0eTIsIHgxLCB5MSwgeDIsIHkyLCBsaW5lV2lkdGgsIGxpbmVDb2xvciwgYm9yZGVyRGFzaCwgYm9yZGVyRGFzaE9mZnNldDsKCiAgICAgIGlmIChwb3NpdGlvbiA9PT0gJ3RvcCcpIHsKICAgICAgICBib3JkZXJWYWx1ZSA9IGFsaWduQm9yZGVyVmFsdWUobWUuYm90dG9tKTsKICAgICAgICB0eTEgPSBtZS5ib3R0b20gLSB0bDsKICAgICAgICB0eTIgPSBib3JkZXJWYWx1ZSAtIGF4aXNIYWxmV2lkdGg7CiAgICAgICAgeTEgPSBhbGlnbkJvcmRlclZhbHVlKGNoYXJ0QXJlYS50b3ApICsgYXhpc0hhbGZXaWR0aDsKICAgICAgICB5MiA9IGNoYXJ0QXJlYS5ib3R0b207CiAgICAgIH0gZWxzZSBpZiAocG9zaXRpb24gPT09ICdib3R0b20nKSB7CiAgICAgICAgYm9yZGVyVmFsdWUgPSBhbGlnbkJvcmRlclZhbHVlKG1lLnRvcCk7CiAgICAgICAgeTEgPSBjaGFydEFyZWEudG9wOwogICAgICAgIHkyID0gYWxpZ25Cb3JkZXJWYWx1ZShjaGFydEFyZWEuYm90dG9tKSAtIGF4aXNIYWxmV2lkdGg7CiAgICAgICAgdHkxID0gYm9yZGVyVmFsdWUgKyBheGlzSGFsZldpZHRoOwogICAgICAgIHR5MiA9IG1lLnRvcCArIHRsOwogICAgICB9IGVsc2UgaWYgKHBvc2l0aW9uID09PSAnbGVmdCcpIHsKICAgICAgICBib3JkZXJWYWx1ZSA9IGFsaWduQm9yZGVyVmFsdWUobWUucmlnaHQpOwogICAgICAgIHR4MSA9IG1lLnJpZ2h0IC0gdGw7CiAgICAgICAgdHgyID0gYm9yZGVyVmFsdWUgLSBheGlzSGFsZldpZHRoOwogICAgICAgIHgxID0gYWxpZ25Cb3JkZXJWYWx1ZShjaGFydEFyZWEubGVmdCkgKyBheGlzSGFsZldpZHRoOwogICAgICAgIHgyID0gY2hhcnRBcmVhLnJpZ2h0OwogICAgICB9IGVsc2UgewogICAgICAgIGJvcmRlclZhbHVlID0gYWxpZ25Cb3JkZXJWYWx1ZShtZS5sZWZ0KTsKICAgICAgICB4MSA9IGNoYXJ0QXJlYS5sZWZ0OwogICAgICAgIHgyID0gYWxpZ25Cb3JkZXJWYWx1ZShjaGFydEFyZWEucmlnaHQpIC0gYXhpc0hhbGZXaWR0aDsKICAgICAgICB0eDEgPSBib3JkZXJWYWx1ZSArIGF4aXNIYWxmV2lkdGg7CiAgICAgICAgdHgyID0gbWUubGVmdCArIHRsOwogICAgICB9CgogICAgICBmb3IgKGkgPSAwOyBpIDwgdGlja3NMZW5ndGg7ICsraSkgewogICAgICAgIHRpY2sgPSB0aWNrc1tpXSB8fCB7fTsgLy8gYXV0b3NraXBwZXIgc2tpcHBlZCB0aGlzIHRpY2sgKCM0NjM1KQoKICAgICAgICBpZiAoaXNOdWxsT3JVbmRlZih0aWNrLmxhYmVsKSAmJiBpIDwgdGlja3MubGVuZ3RoKSB7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CgogICAgICAgIGlmIChpID09PSBtZS56ZXJvTGluZUluZGV4ICYmIG9wdGlvbnMub2Zmc2V0ID09PSBvZmZzZXRHcmlkTGluZXMpIHsKICAgICAgICAgIC8vIERyYXcgdGhlIGZpcnN0IGluZGV4IHNwZWNpYWxseQogICAgICAgICAgbGluZVdpZHRoID0gZ3JpZExpbmVzLnplcm9MaW5lV2lkdGg7CiAgICAgICAgICBsaW5lQ29sb3IgPSBncmlkTGluZXMuemVyb0xpbmVDb2xvcjsKICAgICAgICAgIGJvcmRlckRhc2ggPSBncmlkTGluZXMuemVyb0xpbmVCb3JkZXJEYXNoIHx8IFtdOwogICAgICAgICAgYm9yZGVyRGFzaE9mZnNldCA9IGdyaWRMaW5lcy56ZXJvTGluZUJvcmRlckRhc2hPZmZzZXQgfHwgMC4wOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsaW5lV2lkdGggPSB2YWx1ZUF0SW5kZXhPckRlZmF1bHQoZ3JpZExpbmVzLmxpbmVXaWR0aCwgaSwgMSk7CiAgICAgICAgICBsaW5lQ29sb3IgPSB2YWx1ZUF0SW5kZXhPckRlZmF1bHQoZ3JpZExpbmVzLmNvbG9yLCBpLCAncmdiYSgwLDAsMCwwLjEpJyk7CiAgICAgICAgICBib3JkZXJEYXNoID0gZ3JpZExpbmVzLmJvcmRlckRhc2ggfHwgW107CiAgICAgICAgICBib3JkZXJEYXNoT2Zmc2V0ID0gZ3JpZExpbmVzLmJvcmRlckRhc2hPZmZzZXQgfHwgMC4wOwogICAgICAgIH0KCiAgICAgICAgbGluZVZhbHVlID0gZ2V0UGl4ZWxGb3JHcmlkTGluZShtZSwgdGljay5faW5kZXggfHwgaSwgb2Zmc2V0R3JpZExpbmVzKTsgLy8gU2tpcCBpZiB0aGUgcGl4ZWwgaXMgb3V0IG9mIHRoZSByYW5nZQoKICAgICAgICBpZiAobGluZVZhbHVlID09PSB1bmRlZmluZWQpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgYWxpZ25lZExpbmVWYWx1ZSA9IGFsaWduUGl4ZWwoY2hhcnQsIGxpbmVWYWx1ZSwgbGluZVdpZHRoKTsKCiAgICAgICAgaWYgKGlzSG9yaXpvbnRhbCkgewogICAgICAgICAgdHgxID0gdHgyID0geDEgPSB4MiA9IGFsaWduZWRMaW5lVmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHR5MSA9IHR5MiA9IHkxID0geTIgPSBhbGlnbmVkTGluZVZhbHVlOwogICAgICAgIH0KCiAgICAgICAgaXRlbXMucHVzaCh7CiAgICAgICAgICB0eDE6IHR4MSwKICAgICAgICAgIHR5MTogdHkxLAogICAgICAgICAgdHgyOiB0eDIsCiAgICAgICAgICB0eTI6IHR5MiwKICAgICAgICAgIHgxOiB4MSwKICAgICAgICAgIHkxOiB5MSwKICAgICAgICAgIHgyOiB4MiwKICAgICAgICAgIHkyOiB5MiwKICAgICAgICAgIHdpZHRoOiBsaW5lV2lkdGgsCiAgICAgICAgICBjb2xvcjogbGluZUNvbG9yLAogICAgICAgICAgYm9yZGVyRGFzaDogYm9yZGVyRGFzaCwKICAgICAgICAgIGJvcmRlckRhc2hPZmZzZXQ6IGJvcmRlckRhc2hPZmZzZXQKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgaXRlbXMudGlja3NMZW5ndGggPSB0aWNrc0xlbmd0aDsKICAgICAgaXRlbXMuYm9yZGVyVmFsdWUgPSBib3JkZXJWYWx1ZTsKICAgICAgcmV0dXJuIGl0ZW1zOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2NvbXB1dGVMYWJlbEl0ZW1zOiBmdW5jdGlvbiBfY29tcHV0ZUxhYmVsSXRlbXMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBvcHRpb25zID0gbWUub3B0aW9uczsKICAgICAgdmFyIG9wdGlvblRpY2tzID0gb3B0aW9ucy50aWNrczsKICAgICAgdmFyIHBvc2l0aW9uID0gb3B0aW9ucy5wb3NpdGlvbjsKICAgICAgdmFyIGlzTWlycm9yZWQgPSBvcHRpb25UaWNrcy5taXJyb3I7CiAgICAgIHZhciBpc0hvcml6b250YWwgPSBtZS5pc0hvcml6b250YWwoKTsKICAgICAgdmFyIHRpY2tzID0gbWUuX3RpY2tzVG9EcmF3OwogICAgICB2YXIgZm9udHMgPSBwYXJzZVRpY2tGb250T3B0aW9ucyhvcHRpb25UaWNrcyk7CiAgICAgIHZhciB0aWNrUGFkZGluZyA9IG9wdGlvblRpY2tzLnBhZGRpbmc7CiAgICAgIHZhciB0bCA9IGdldFRpY2tNYXJrTGVuZ3RoKG9wdGlvbnMuZ3JpZExpbmVzKTsKICAgICAgdmFyIHJvdGF0aW9uID0gLWhlbHBlcnMkMS50b1JhZGlhbnMobWUubGFiZWxSb3RhdGlvbik7CiAgICAgIHZhciBpdGVtcyA9IFtdOwogICAgICB2YXIgaSwgaWxlbiwgdGljaywgbGFiZWwsIHgsIHksIHRleHRBbGlnbiwgcGl4ZWwsIGZvbnQsIGxpbmVIZWlnaHQsIGxpbmVDb3VudCwgdGV4dE9mZnNldDsKCiAgICAgIGlmIChwb3NpdGlvbiA9PT0gJ3RvcCcpIHsKICAgICAgICB5ID0gbWUuYm90dG9tIC0gdGwgLSB0aWNrUGFkZGluZzsKICAgICAgICB0ZXh0QWxpZ24gPSAhcm90YXRpb24gPyAnY2VudGVyJyA6ICdsZWZ0JzsKICAgICAgfSBlbHNlIGlmIChwb3NpdGlvbiA9PT0gJ2JvdHRvbScpIHsKICAgICAgICB5ID0gbWUudG9wICsgdGwgKyB0aWNrUGFkZGluZzsKICAgICAgICB0ZXh0QWxpZ24gPSAhcm90YXRpb24gPyAnY2VudGVyJyA6ICdyaWdodCc7CiAgICAgIH0gZWxzZSBpZiAocG9zaXRpb24gPT09ICdsZWZ0JykgewogICAgICAgIHggPSBtZS5yaWdodCAtIChpc01pcnJvcmVkID8gMCA6IHRsKSAtIHRpY2tQYWRkaW5nOwogICAgICAgIHRleHRBbGlnbiA9IGlzTWlycm9yZWQgPyAnbGVmdCcgOiAncmlnaHQnOwogICAgICB9IGVsc2UgewogICAgICAgIHggPSBtZS5sZWZ0ICsgKGlzTWlycm9yZWQgPyAwIDogdGwpICsgdGlja1BhZGRpbmc7CiAgICAgICAgdGV4dEFsaWduID0gaXNNaXJyb3JlZCA/ICdyaWdodCcgOiAnbGVmdCc7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSB0aWNrcy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICB0aWNrID0gdGlja3NbaV07CiAgICAgICAgbGFiZWwgPSB0aWNrLmxhYmVsOyAvLyBhdXRvc2tpcHBlciBza2lwcGVkIHRoaXMgdGljayAoIzQ2MzUpCgogICAgICAgIGlmIChpc051bGxPclVuZGVmKGxhYmVsKSkgewogICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBwaXhlbCA9IG1lLmdldFBpeGVsRm9yVGljayh0aWNrLl9pbmRleCB8fCBpKSArIG9wdGlvblRpY2tzLmxhYmVsT2Zmc2V0OwogICAgICAgIGZvbnQgPSB0aWNrLm1ham9yID8gZm9udHMubWFqb3IgOiBmb250cy5taW5vcjsKICAgICAgICBsaW5lSGVpZ2h0ID0gZm9udC5saW5lSGVpZ2h0OwogICAgICAgIGxpbmVDb3VudCA9IGlzQXJyYXkobGFiZWwpID8gbGFiZWwubGVuZ3RoIDogMTsKCiAgICAgICAgaWYgKGlzSG9yaXpvbnRhbCkgewogICAgICAgICAgeCA9IHBpeGVsOwogICAgICAgICAgdGV4dE9mZnNldCA9IHBvc2l0aW9uID09PSAndG9wJyA/ICgoIXJvdGF0aW9uID8gMC41IDogMSkgLSBsaW5lQ291bnQpICogbGluZUhlaWdodCA6ICghcm90YXRpb24gPyAwLjUgOiAwKSAqIGxpbmVIZWlnaHQ7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHkgPSBwaXhlbDsKICAgICAgICAgIHRleHRPZmZzZXQgPSAoMSAtIGxpbmVDb3VudCkgKiBsaW5lSGVpZ2h0IC8gMjsKICAgICAgICB9CgogICAgICAgIGl0ZW1zLnB1c2goewogICAgICAgICAgeDogeCwKICAgICAgICAgIHk6IHksCiAgICAgICAgICByb3RhdGlvbjogcm90YXRpb24sCiAgICAgICAgICBsYWJlbDogbGFiZWwsCiAgICAgICAgICBmb250OiBmb250LAogICAgICAgICAgdGV4dE9mZnNldDogdGV4dE9mZnNldCwKICAgICAgICAgIHRleHRBbGlnbjogdGV4dEFsaWduCiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBpdGVtczsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9kcmF3R3JpZDogZnVuY3Rpb24gX2RyYXdHcmlkKGNoYXJ0QXJlYSkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgZ3JpZExpbmVzID0gbWUub3B0aW9ucy5ncmlkTGluZXM7CgogICAgICBpZiAoIWdyaWRMaW5lcy5kaXNwbGF5KSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB2YXIgY3R4ID0gbWUuY3R4OwogICAgICB2YXIgY2hhcnQgPSBtZS5jaGFydDsKICAgICAgdmFyIGFsaWduUGl4ZWwgPSBoZWxwZXJzJDEuX2FsaWduUGl4ZWw7CiAgICAgIHZhciBheGlzV2lkdGggPSBncmlkTGluZXMuZHJhd0JvcmRlciA/IHZhbHVlQXRJbmRleE9yRGVmYXVsdChncmlkTGluZXMubGluZVdpZHRoLCAwLCAwKSA6IDA7CgogICAgICB2YXIgaXRlbXMgPSBtZS5fZ3JpZExpbmVJdGVtcyB8fCAobWUuX2dyaWRMaW5lSXRlbXMgPSBtZS5fY29tcHV0ZUdyaWRMaW5lSXRlbXMoY2hhcnRBcmVhKSk7CgogICAgICB2YXIgd2lkdGgsIGNvbG9yLCBpLCBpbGVuLCBpdGVtOwoKICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGl0ZW1zLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewogICAgICAgIGl0ZW0gPSBpdGVtc1tpXTsKICAgICAgICB3aWR0aCA9IGl0ZW0ud2lkdGg7CiAgICAgICAgY29sb3IgPSBpdGVtLmNvbG9yOwoKICAgICAgICBpZiAod2lkdGggJiYgY29sb3IpIHsKICAgICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgICBjdHgubGluZVdpZHRoID0gd2lkdGg7CiAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBjb2xvcjsKCiAgICAgICAgICBpZiAoY3R4LnNldExpbmVEYXNoKSB7CiAgICAgICAgICAgIGN0eC5zZXRMaW5lRGFzaChpdGVtLmJvcmRlckRhc2gpOwogICAgICAgICAgICBjdHgubGluZURhc2hPZmZzZXQgPSBpdGVtLmJvcmRlckRhc2hPZmZzZXQ7CiAgICAgICAgICB9CgogICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwoKICAgICAgICAgIGlmIChncmlkTGluZXMuZHJhd1RpY2tzKSB7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oaXRlbS50eDEsIGl0ZW0udHkxKTsKICAgICAgICAgICAgY3R4LmxpbmVUbyhpdGVtLnR4MiwgaXRlbS50eTIpOwogICAgICAgICAgfQoKICAgICAgICAgIGlmIChncmlkTGluZXMuZHJhd09uQ2hhcnRBcmVhKSB7CiAgICAgICAgICAgIGN0eC5tb3ZlVG8oaXRlbS54MSwgaXRlbS55MSk7CiAgICAgICAgICAgIGN0eC5saW5lVG8oaXRlbS54MiwgaXRlbS55Mik7CiAgICAgICAgICB9CgogICAgICAgICAgY3R4LnN0cm9rZSgpOwogICAgICAgICAgY3R4LnJlc3RvcmUoKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChheGlzV2lkdGgpIHsKICAgICAgICAvLyBEcmF3IHRoZSBsaW5lIGF0IHRoZSBlZGdlIG9mIHRoZSBheGlzCiAgICAgICAgdmFyIGZpcnN0TGluZVdpZHRoID0gYXhpc1dpZHRoOwogICAgICAgIHZhciBsYXN0TGluZVdpZHRoID0gdmFsdWVBdEluZGV4T3JEZWZhdWx0KGdyaWRMaW5lcy5saW5lV2lkdGgsIGl0ZW1zLnRpY2tzTGVuZ3RoIC0gMSwgMSk7CiAgICAgICAgdmFyIGJvcmRlclZhbHVlID0gaXRlbXMuYm9yZGVyVmFsdWU7CiAgICAgICAgdmFyIHgxLCB4MiwgeTEsIHkyOwoKICAgICAgICBpZiAobWUuaXNIb3Jpem9udGFsKCkpIHsKICAgICAgICAgIHgxID0gYWxpZ25QaXhlbChjaGFydCwgbWUubGVmdCwgZmlyc3RMaW5lV2lkdGgpIC0gZmlyc3RMaW5lV2lkdGggLyAyOwogICAgICAgICAgeDIgPSBhbGlnblBpeGVsKGNoYXJ0LCBtZS5yaWdodCwgbGFzdExpbmVXaWR0aCkgKyBsYXN0TGluZVdpZHRoIC8gMjsKICAgICAgICAgIHkxID0geTIgPSBib3JkZXJWYWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgeTEgPSBhbGlnblBpeGVsKGNoYXJ0LCBtZS50b3AsIGZpcnN0TGluZVdpZHRoKSAtIGZpcnN0TGluZVdpZHRoIC8gMjsKICAgICAgICAgIHkyID0gYWxpZ25QaXhlbChjaGFydCwgbWUuYm90dG9tLCBsYXN0TGluZVdpZHRoKSArIGxhc3RMaW5lV2lkdGggLyAyOwogICAgICAgICAgeDEgPSB4MiA9IGJvcmRlclZhbHVlOwogICAgICAgIH0KCiAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGF4aXNXaWR0aDsKICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSB2YWx1ZUF0SW5kZXhPckRlZmF1bHQoZ3JpZExpbmVzLmNvbG9yLCAwKTsKICAgICAgICBjdHguYmVnaW5QYXRoKCk7CiAgICAgICAgY3R4Lm1vdmVUbyh4MSwgeTEpOwogICAgICAgIGN0eC5saW5lVG8oeDIsIHkyKTsKICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgIH0KICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9kcmF3TGFiZWxzOiBmdW5jdGlvbiBfZHJhd0xhYmVscygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9wdGlvblRpY2tzID0gbWUub3B0aW9ucy50aWNrczsKCiAgICAgIGlmICghb3B0aW9uVGlja3MuZGlzcGxheSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIGN0eCA9IG1lLmN0eDsKCiAgICAgIHZhciBpdGVtcyA9IG1lLl9sYWJlbEl0ZW1zIHx8IChtZS5fbGFiZWxJdGVtcyA9IG1lLl9jb21wdXRlTGFiZWxJdGVtcygpKTsKCiAgICAgIHZhciBpLCBqLCBpbGVuLCBqbGVuLCBpdGVtLCB0aWNrRm9udCwgbGFiZWwsIHk7CgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gaXRlbXMubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgaXRlbSA9IGl0ZW1zW2ldOwogICAgICAgIHRpY2tGb250ID0gaXRlbS5mb250OyAvLyBNYWtlIHN1cmUgd2UgZHJhdyB0ZXh0IGluIHRoZSBjb3JyZWN0IGNvbG9yIGFuZCBmb250CgogICAgICAgIGN0eC5zYXZlKCk7CiAgICAgICAgY3R4LnRyYW5zbGF0ZShpdGVtLngsIGl0ZW0ueSk7CiAgICAgICAgY3R4LnJvdGF0ZShpdGVtLnJvdGF0aW9uKTsKICAgICAgICBjdHguZm9udCA9IHRpY2tGb250LnN0cmluZzsKICAgICAgICBjdHguZmlsbFN0eWxlID0gdGlja0ZvbnQuY29sb3I7CiAgICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICdtaWRkbGUnOwogICAgICAgIGN0eC50ZXh0QWxpZ24gPSBpdGVtLnRleHRBbGlnbjsKICAgICAgICBsYWJlbCA9IGl0ZW0ubGFiZWw7CiAgICAgICAgeSA9IGl0ZW0udGV4dE9mZnNldDsKCiAgICAgICAgaWYgKGlzQXJyYXkobGFiZWwpKSB7CiAgICAgICAgICBmb3IgKGogPSAwLCBqbGVuID0gbGFiZWwubGVuZ3RoOyBqIDwgamxlbjsgKytqKSB7CiAgICAgICAgICAgIC8vIFdlIGp1c3QgbWFrZSBzdXJlIHRoZSBtdWx0aWxpbmUgZWxlbWVudCBpcyBhIHN0cmluZyBoZXJlLi4KICAgICAgICAgICAgY3R4LmZpbGxUZXh0KCcnICsgbGFiZWxbal0sIDAsIHkpOwogICAgICAgICAgICB5ICs9IHRpY2tGb250LmxpbmVIZWlnaHQ7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGN0eC5maWxsVGV4dChsYWJlbCwgMCwgeSk7CiAgICAgICAgfQoKICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZHJhd1RpdGxlOiBmdW5jdGlvbiBfZHJhd1RpdGxlKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgY3R4ID0gbWUuY3R4OwogICAgICB2YXIgb3B0aW9ucyA9IG1lLm9wdGlvbnM7CiAgICAgIHZhciBzY2FsZUxhYmVsID0gb3B0aW9ucy5zY2FsZUxhYmVsOwoKICAgICAgaWYgKCFzY2FsZUxhYmVsLmRpc3BsYXkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBzY2FsZUxhYmVsRm9udENvbG9yID0gdmFsdWVPckRlZmF1bHQkYShzY2FsZUxhYmVsLmZvbnRDb2xvciwgY29yZV9kZWZhdWx0cy5nbG9iYWwuZGVmYXVsdEZvbnRDb2xvcik7CgogICAgICB2YXIgc2NhbGVMYWJlbEZvbnQgPSBoZWxwZXJzJDEub3B0aW9ucy5fcGFyc2VGb250KHNjYWxlTGFiZWwpOwoKICAgICAgdmFyIHNjYWxlTGFiZWxQYWRkaW5nID0gaGVscGVycyQxLm9wdGlvbnMudG9QYWRkaW5nKHNjYWxlTGFiZWwucGFkZGluZyk7CiAgICAgIHZhciBoYWxmTGluZUhlaWdodCA9IHNjYWxlTGFiZWxGb250LmxpbmVIZWlnaHQgLyAyOwogICAgICB2YXIgcG9zaXRpb24gPSBvcHRpb25zLnBvc2l0aW9uOwogICAgICB2YXIgcm90YXRpb24gPSAwOwogICAgICB2YXIgc2NhbGVMYWJlbFgsIHNjYWxlTGFiZWxZOwoKICAgICAgaWYgKG1lLmlzSG9yaXpvbnRhbCgpKSB7CiAgICAgICAgc2NhbGVMYWJlbFggPSBtZS5sZWZ0ICsgbWUud2lkdGggLyAyOyAvLyBtaWRwb2ludCBvZiB0aGUgd2lkdGgKCiAgICAgICAgc2NhbGVMYWJlbFkgPSBwb3NpdGlvbiA9PT0gJ2JvdHRvbScgPyBtZS5ib3R0b20gLSBoYWxmTGluZUhlaWdodCAtIHNjYWxlTGFiZWxQYWRkaW5nLmJvdHRvbSA6IG1lLnRvcCArIGhhbGZMaW5lSGVpZ2h0ICsgc2NhbGVMYWJlbFBhZGRpbmcudG9wOwogICAgICB9IGVsc2UgewogICAgICAgIHZhciBpc0xlZnQgPSBwb3NpdGlvbiA9PT0gJ2xlZnQnOwogICAgICAgIHNjYWxlTGFiZWxYID0gaXNMZWZ0ID8gbWUubGVmdCArIGhhbGZMaW5lSGVpZ2h0ICsgc2NhbGVMYWJlbFBhZGRpbmcudG9wIDogbWUucmlnaHQgLSBoYWxmTGluZUhlaWdodCAtIHNjYWxlTGFiZWxQYWRkaW5nLnRvcDsKICAgICAgICBzY2FsZUxhYmVsWSA9IG1lLnRvcCArIG1lLmhlaWdodCAvIDI7CiAgICAgICAgcm90YXRpb24gPSBpc0xlZnQgPyAtMC41ICogTWF0aC5QSSA6IDAuNSAqIE1hdGguUEk7CiAgICAgIH0KCiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC50cmFuc2xhdGUoc2NhbGVMYWJlbFgsIHNjYWxlTGFiZWxZKTsKICAgICAgY3R4LnJvdGF0ZShyb3RhdGlvbik7CiAgICAgIGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsKICAgICAgY3R4LnRleHRCYXNlbGluZSA9ICdtaWRkbGUnOwogICAgICBjdHguZmlsbFN0eWxlID0gc2NhbGVMYWJlbEZvbnRDb2xvcjsgLy8gcmVuZGVyIGluIGNvcnJlY3QgY29sb3VyCgogICAgICBjdHguZm9udCA9IHNjYWxlTGFiZWxGb250LnN0cmluZzsKICAgICAgY3R4LmZpbGxUZXh0KHNjYWxlTGFiZWwubGFiZWxTdHJpbmcsIDAsIDApOwogICAgICBjdHgucmVzdG9yZSgpOwogICAgfSwKICAgIGRyYXc6IGZ1bmN0aW9uIGRyYXcoY2hhcnRBcmVhKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CgogICAgICBpZiAoIW1lLl9pc1Zpc2libGUoKSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgbWUuX2RyYXdHcmlkKGNoYXJ0QXJlYSk7CgogICAgICBtZS5fZHJhd1RpdGxlKCk7CgogICAgICBtZS5fZHJhd0xhYmVscygpOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2xheWVyczogZnVuY3Rpb24gX2xheWVycygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9wdHMgPSBtZS5vcHRpb25zOwogICAgICB2YXIgdHogPSBvcHRzLnRpY2tzICYmIG9wdHMudGlja3MueiB8fCAwOwogICAgICB2YXIgZ3ogPSBvcHRzLmdyaWRMaW5lcyAmJiBvcHRzLmdyaWRMaW5lcy56IHx8IDA7CgogICAgICBpZiAoIW1lLl9pc1Zpc2libGUoKSB8fCB0eiA9PT0gZ3ogfHwgbWUuZHJhdyAhPT0gbWUuX2RyYXcpIHsKICAgICAgICAvLyBiYWNrd2FyZCBjb21wYXRpYmlsaXR5OiBkcmF3IGhhcyBiZWVuIG92ZXJyaWRkZW4gYnkgY3VzdG9tIHNjYWxlCiAgICAgICAgcmV0dXJuIFt7CiAgICAgICAgICB6OiB0eiwKICAgICAgICAgIGRyYXc6IGZ1bmN0aW9uIGRyYXcoKSB7CiAgICAgICAgICAgIG1lLmRyYXcuYXBwbHkobWUsIGFyZ3VtZW50cyk7CiAgICAgICAgICB9CiAgICAgICAgfV07CiAgICAgIH0KCiAgICAgIHJldHVybiBbewogICAgICAgIHo6IGd6LAogICAgICAgIGRyYXc6IGZ1bmN0aW9uIGRyYXcoKSB7CiAgICAgICAgICBtZS5fZHJhd0dyaWQuYXBwbHkobWUsIGFyZ3VtZW50cyk7CgogICAgICAgICAgbWUuX2RyYXdUaXRsZS5hcHBseShtZSwgYXJndW1lbnRzKTsKICAgICAgICB9CiAgICAgIH0sIHsKICAgICAgICB6OiB0eiwKICAgICAgICBkcmF3OiBmdW5jdGlvbiBkcmF3KCkgewogICAgICAgICAgbWUuX2RyYXdMYWJlbHMuYXBwbHkobWUsIGFyZ3VtZW50cyk7CiAgICAgICAgfQogICAgICB9XTsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9nZXRNYXRjaGluZ1Zpc2libGVNZXRhczogZnVuY3Rpb24gX2dldE1hdGNoaW5nVmlzaWJsZU1ldGFzKHR5cGUpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGlzSG9yaXpvbnRhbCA9IG1lLmlzSG9yaXpvbnRhbCgpOwogICAgICByZXR1cm4gbWUuY2hhcnQuX2dldFNvcnRlZFZpc2libGVEYXRhc2V0TWV0YXMoKS5maWx0ZXIoZnVuY3Rpb24gKG1ldGEpIHsKICAgICAgICByZXR1cm4gKCF0eXBlIHx8IG1ldGEudHlwZSA9PT0gdHlwZSkgJiYgKGlzSG9yaXpvbnRhbCA/IG1ldGEueEF4aXNJRCA9PT0gbWUuaWQgOiBtZXRhLnlBeGlzSUQgPT09IG1lLmlkKTsKICAgICAgfSk7CiAgICB9CiAgfSk7CiAgU2NhbGUucHJvdG90eXBlLl9kcmF3ID0gU2NhbGUucHJvdG90eXBlLmRyYXc7CiAgdmFyIGNvcmVfc2NhbGUgPSBTY2FsZTsKICB2YXIgaXNOdWxsT3JVbmRlZiQxID0gaGVscGVycyQxLmlzTnVsbE9yVW5kZWY7CiAgdmFyIGRlZmF1bHRDb25maWcgPSB7CiAgICBwb3NpdGlvbjogJ2JvdHRvbScKICB9OwogIHZhciBzY2FsZV9jYXRlZ29yeSA9IGNvcmVfc2NhbGUuZXh0ZW5kKHsKICAgIGRldGVybWluZURhdGFMaW1pdHM6IGZ1bmN0aW9uIGRldGVybWluZURhdGFMaW1pdHMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CgogICAgICB2YXIgbGFiZWxzID0gbWUuX2dldExhYmVscygpOwoKICAgICAgdmFyIHRpY2tzT3B0cyA9IG1lLm9wdGlvbnMudGlja3M7CiAgICAgIHZhciBtaW4gPSB0aWNrc09wdHMubWluOwogICAgICB2YXIgbWF4ID0gdGlja3NPcHRzLm1heDsKICAgICAgdmFyIG1pbkluZGV4ID0gMDsKICAgICAgdmFyIG1heEluZGV4ID0gbGFiZWxzLmxlbmd0aCAtIDE7CiAgICAgIHZhciBmaW5kSW5kZXg7CgogICAgICBpZiAobWluICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAvLyB1c2VyIHNwZWNpZmllZCBtaW4gdmFsdWUKICAgICAgICBmaW5kSW5kZXggPSBsYWJlbHMuaW5kZXhPZihtaW4pOwoKICAgICAgICBpZiAoZmluZEluZGV4ID49IDApIHsKICAgICAgICAgIG1pbkluZGV4ID0gZmluZEluZGV4OwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKG1heCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgLy8gdXNlciBzcGVjaWZpZWQgbWF4IHZhbHVlCiAgICAgICAgZmluZEluZGV4ID0gbGFiZWxzLmluZGV4T2YobWF4KTsKCiAgICAgICAgaWYgKGZpbmRJbmRleCA+PSAwKSB7CiAgICAgICAgICBtYXhJbmRleCA9IGZpbmRJbmRleDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG1lLm1pbkluZGV4ID0gbWluSW5kZXg7CiAgICAgIG1lLm1heEluZGV4ID0gbWF4SW5kZXg7CiAgICAgIG1lLm1pbiA9IGxhYmVsc1ttaW5JbmRleF07CiAgICAgIG1lLm1heCA9IGxhYmVsc1ttYXhJbmRleF07CiAgICB9LAogICAgYnVpbGRUaWNrczogZnVuY3Rpb24gYnVpbGRUaWNrcygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKCiAgICAgIHZhciBsYWJlbHMgPSBtZS5fZ2V0TGFiZWxzKCk7CgogICAgICB2YXIgbWluSW5kZXggPSBtZS5taW5JbmRleDsKICAgICAgdmFyIG1heEluZGV4ID0gbWUubWF4SW5kZXg7IC8vIElmIHdlIGFyZSB2aWV3aW5nIHNvbWUgc3Vic2V0IG9mIGxhYmVscywgc2xpY2UgdGhlIG9yaWdpbmFsIGFycmF5CgogICAgICBtZS50aWNrcyA9IG1pbkluZGV4ID09PSAwICYmIG1heEluZGV4ID09PSBsYWJlbHMubGVuZ3RoIC0gMSA/IGxhYmVscyA6IGxhYmVscy5zbGljZShtaW5JbmRleCwgbWF4SW5kZXggKyAxKTsKICAgIH0sCiAgICBnZXRMYWJlbEZvckluZGV4OiBmdW5jdGlvbiBnZXRMYWJlbEZvckluZGV4KGluZGV4LCBkYXRhc2V0SW5kZXgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CgogICAgICBpZiAoY2hhcnQuZ2V0RGF0YXNldE1ldGEoZGF0YXNldEluZGV4KS5jb250cm9sbGVyLl9nZXRWYWx1ZVNjYWxlSWQoKSA9PT0gbWUuaWQpIHsKICAgICAgICByZXR1cm4gbWUuZ2V0UmlnaHRWYWx1ZShjaGFydC5kYXRhLmRhdGFzZXRzW2RhdGFzZXRJbmRleF0uZGF0YVtpbmRleF0pOwogICAgICB9CgogICAgICByZXR1cm4gbWUuX2dldExhYmVscygpW2luZGV4XTsKICAgIH0sCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbiBfY29uZmlndXJlKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgb2Zmc2V0ID0gbWUub3B0aW9ucy5vZmZzZXQ7CiAgICAgIHZhciB0aWNrcyA9IG1lLnRpY2tzOwoKICAgICAgY29yZV9zY2FsZS5wcm90b3R5cGUuX2NvbmZpZ3VyZS5jYWxsKG1lKTsKCiAgICAgIGlmICghbWUuaXNIb3Jpem9udGFsKCkpIHsKICAgICAgICAvLyBGb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgdmVydGljYWwgY2F0ZWdvcnkgc2NhbGUgcmV2ZXJzZSBpcyBpbnZlcnRlZC4KICAgICAgICBtZS5fcmV2ZXJzZVBpeGVscyA9ICFtZS5fcmV2ZXJzZVBpeGVsczsKICAgICAgfQoKICAgICAgaWYgKCF0aWNrcykgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgbWUuX3N0YXJ0VmFsdWUgPSBtZS5taW5JbmRleCAtIChvZmZzZXQgPyAwLjUgOiAwKTsKICAgICAgbWUuX3ZhbHVlUmFuZ2UgPSBNYXRoLm1heCh0aWNrcy5sZW5ndGggLSAob2Zmc2V0ID8gMCA6IDEpLCAxKTsKICAgIH0sCiAgICAvLyBVc2VkIHRvIGdldCBkYXRhIHZhbHVlIGxvY2F0aW9ucy4gIFZhbHVlIGNhbiBlaXRoZXIgYmUgYW4gaW5kZXggb3IgYSBudW1lcmljYWwgdmFsdWUKICAgIGdldFBpeGVsRm9yVmFsdWU6IGZ1bmN0aW9uIGdldFBpeGVsRm9yVmFsdWUodmFsdWUsIGluZGV4LCBkYXRhc2V0SW5kZXgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIHZhbHVlQ2F0ZWdvcnksIGxhYmVscywgaWR4OwoKICAgICAgaWYgKCFpc051bGxPclVuZGVmJDEoaW5kZXgpICYmICFpc051bGxPclVuZGVmJDEoZGF0YXNldEluZGV4KSkgewogICAgICAgIHZhbHVlID0gbWUuY2hhcnQuZGF0YS5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLmRhdGFbaW5kZXhdOwogICAgICB9IC8vIElmIHZhbHVlIGlzIGEgZGF0YSBvYmplY3QsIHRoZW4gaW5kZXggaXMgdGhlIGluZGV4IGluIHRoZSBkYXRhIGFycmF5LAogICAgICAvLyBub3QgdGhlIGluZGV4IG9mIHRoZSBzY2FsZS4gV2UgbmVlZCB0byBjaGFuZ2UgdGhhdC4KCgogICAgICBpZiAoIWlzTnVsbE9yVW5kZWYkMSh2YWx1ZSkpIHsKICAgICAgICB2YWx1ZUNhdGVnb3J5ID0gbWUuaXNIb3Jpem9udGFsKCkgPyB2YWx1ZS54IDogdmFsdWUueTsKICAgICAgfQoKICAgICAgaWYgKHZhbHVlQ2F0ZWdvcnkgIT09IHVuZGVmaW5lZCB8fCB2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIGlzTmFOKGluZGV4KSkgewogICAgICAgIGxhYmVscyA9IG1lLl9nZXRMYWJlbHMoKTsKICAgICAgICB2YWx1ZSA9IGhlbHBlcnMkMS52YWx1ZU9yRGVmYXVsdCh2YWx1ZUNhdGVnb3J5LCB2YWx1ZSk7CiAgICAgICAgaWR4ID0gbGFiZWxzLmluZGV4T2YodmFsdWUpOwogICAgICAgIGluZGV4ID0gaWR4ICE9PSAtMSA/IGlkeCA6IGluZGV4OwoKICAgICAgICBpZiAoaXNOYU4oaW5kZXgpKSB7CiAgICAgICAgICBpbmRleCA9IHZhbHVlOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG1lLmdldFBpeGVsRm9yRGVjaW1hbCgoaW5kZXggLSBtZS5fc3RhcnRWYWx1ZSkgLyBtZS5fdmFsdWVSYW5nZSk7CiAgICB9LAogICAgZ2V0UGl4ZWxGb3JUaWNrOiBmdW5jdGlvbiBnZXRQaXhlbEZvclRpY2soaW5kZXgpIHsKICAgICAgdmFyIHRpY2tzID0gdGhpcy50aWNrczsKICAgICAgcmV0dXJuIGluZGV4IDwgMCB8fCBpbmRleCA+IHRpY2tzLmxlbmd0aCAtIDEgPyBudWxsIDogdGhpcy5nZXRQaXhlbEZvclZhbHVlKHRpY2tzW2luZGV4XSwgaW5kZXggKyB0aGlzLm1pbkluZGV4KTsKICAgIH0sCiAgICBnZXRWYWx1ZUZvclBpeGVsOiBmdW5jdGlvbiBnZXRWYWx1ZUZvclBpeGVsKHBpeGVsKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciB2YWx1ZSA9IE1hdGgucm91bmQobWUuX3N0YXJ0VmFsdWUgKyBtZS5nZXREZWNpbWFsRm9yUGl4ZWwocGl4ZWwpICogbWUuX3ZhbHVlUmFuZ2UpOwogICAgICByZXR1cm4gTWF0aC5taW4oTWF0aC5tYXgodmFsdWUsIDApLCBtZS50aWNrcy5sZW5ndGggLSAxKTsKICAgIH0sCiAgICBnZXRCYXNlUGl4ZWw6IGZ1bmN0aW9uIGdldEJhc2VQaXhlbCgpIHsKICAgICAgcmV0dXJuIHRoaXMuYm90dG9tOwogICAgfQogIH0pOyAvLyBJTlRFUk5BTDogc3RhdGljIGRlZmF1bHQgb3B0aW9ucywgcmVnaXN0ZXJlZCBpbiBzcmMvaW5kZXguanMKCiAgdmFyIF9kZWZhdWx0cyA9IGRlZmF1bHRDb25maWc7CiAgc2NhbGVfY2F0ZWdvcnkuX2RlZmF1bHRzID0gX2RlZmF1bHRzOwogIHZhciBub29wID0gaGVscGVycyQxLm5vb3A7CiAgdmFyIGlzTnVsbE9yVW5kZWYkMiA9IGhlbHBlcnMkMS5pc051bGxPclVuZGVmOwogIC8qKg0KICAgKiBHZW5lcmF0ZSBhIHNldCBvZiBsaW5lYXIgdGlja3MNCiAgICogQHBhcmFtIGdlbmVyYXRpb25PcHRpb25zIHRoZSBvcHRpb25zIHVzZWQgdG8gZ2VuZXJhdGUgdGhlIHRpY2tzDQogICAqIEBwYXJhbSBkYXRhUmFuZ2UgdGhlIHJhbmdlIG9mIHRoZSBkYXRhDQogICAqIEByZXR1cm5zIHtudW1iZXJbXX0gYXJyYXkgb2YgdGljayB2YWx1ZXMNCiAgICovCgogIGZ1bmN0aW9uIGdlbmVyYXRlVGlja3MoZ2VuZXJhdGlvbk9wdGlvbnMsIGRhdGFSYW5nZSkgewogICAgdmFyIHRpY2tzID0gW107IC8vIFRvIGdldCBhICJuaWNlIiB2YWx1ZSBmb3IgdGhlIHRpY2sgc3BhY2luZywgd2Ugd2lsbCB1c2UgdGhlIGFwcHJvcHJpYXRlbHkgbmFtZWQKICAgIC8vICJuaWNlIG51bWJlciIgYWxnb3JpdGhtLiBTZWUgaHR0cHM6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvODUwNjg4MS9uaWNlLWxhYmVsLWFsZ29yaXRobS1mb3ItY2hhcnRzLXdpdGgtbWluaW11bS10aWNrcwogICAgLy8gZm9yIGRldGFpbHMuCgogICAgdmFyIE1JTl9TUEFDSU5HID0gMWUtMTQ7CiAgICB2YXIgc3RlcFNpemUgPSBnZW5lcmF0aW9uT3B0aW9ucy5zdGVwU2l6ZTsKICAgIHZhciB1bml0ID0gc3RlcFNpemUgfHwgMTsKICAgIHZhciBtYXhOdW1TcGFjZXMgPSBnZW5lcmF0aW9uT3B0aW9ucy5tYXhUaWNrcyAtIDE7CiAgICB2YXIgbWluID0gZ2VuZXJhdGlvbk9wdGlvbnMubWluOwogICAgdmFyIG1heCA9IGdlbmVyYXRpb25PcHRpb25zLm1heDsKICAgIHZhciBwcmVjaXNpb24gPSBnZW5lcmF0aW9uT3B0aW9ucy5wcmVjaXNpb247CiAgICB2YXIgcm1pbiA9IGRhdGFSYW5nZS5taW47CiAgICB2YXIgcm1heCA9IGRhdGFSYW5nZS5tYXg7CiAgICB2YXIgc3BhY2luZyA9IGhlbHBlcnMkMS5uaWNlTnVtKChybWF4IC0gcm1pbikgLyBtYXhOdW1TcGFjZXMgLyB1bml0KSAqIHVuaXQ7CiAgICB2YXIgZmFjdG9yLCBuaWNlTWluLCBuaWNlTWF4LCBudW1TcGFjZXM7IC8vIEJleW9uZCBNSU5fU1BBQ0lORyBmbG9hdGluZyBwb2ludCBudW1iZXJzIGJlaW5nIHRvIGxvc2UgcHJlY2lzaW9uCiAgICAvLyBzdWNoIHRoYXQgd2UgY2FuJ3QgZG8gdGhlIG1hdGggbmVjZXNzYXJ5IHRvIGdlbmVyYXRlIHRpY2tzCgogICAgaWYgKHNwYWNpbmcgPCBNSU5fU1BBQ0lORyAmJiBpc051bGxPclVuZGVmJDIobWluKSAmJiBpc051bGxPclVuZGVmJDIobWF4KSkgewogICAgICByZXR1cm4gW3JtaW4sIHJtYXhdOwogICAgfQoKICAgIG51bVNwYWNlcyA9IE1hdGguY2VpbChybWF4IC8gc3BhY2luZykgLSBNYXRoLmZsb29yKHJtaW4gLyBzcGFjaW5nKTsKCiAgICBpZiAobnVtU3BhY2VzID4gbWF4TnVtU3BhY2VzKSB7CiAgICAgIC8vIElmIHRoZSBjYWxjdWxhdGVkIG51bSBvZiBzcGFjZXMgZXhjZWVkcyBtYXhOdW1TcGFjZXMsIHJlY2FsY3VsYXRlIGl0CiAgICAgIHNwYWNpbmcgPSBoZWxwZXJzJDEubmljZU51bShudW1TcGFjZXMgKiBzcGFjaW5nIC8gbWF4TnVtU3BhY2VzIC8gdW5pdCkgKiB1bml0OwogICAgfQoKICAgIGlmIChzdGVwU2l6ZSB8fCBpc051bGxPclVuZGVmJDIocHJlY2lzaW9uKSkgewogICAgICAvLyBJZiBhIHByZWNpc2lvbiBpcyBub3Qgc3BlY2lmaWVkLCBjYWxjdWxhdGUgZmFjdG9yIGJhc2VkIG9uIHNwYWNpbmcKICAgICAgZmFjdG9yID0gTWF0aC5wb3coMTAsIGhlbHBlcnMkMS5fZGVjaW1hbFBsYWNlcyhzcGFjaW5nKSk7CiAgICB9IGVsc2UgewogICAgICAvLyBJZiB0aGUgdXNlciBzcGVjaWZpZWQgYSBwcmVjaXNpb24sIHJvdW5kIHRvIHRoYXQgbnVtYmVyIG9mIGRlY2ltYWwgcGxhY2VzCiAgICAgIGZhY3RvciA9IE1hdGgucG93KDEwLCBwcmVjaXNpb24pOwogICAgICBzcGFjaW5nID0gTWF0aC5jZWlsKHNwYWNpbmcgKiBmYWN0b3IpIC8gZmFjdG9yOwogICAgfQoKICAgIG5pY2VNaW4gPSBNYXRoLmZsb29yKHJtaW4gLyBzcGFjaW5nKSAqIHNwYWNpbmc7CiAgICBuaWNlTWF4ID0gTWF0aC5jZWlsKHJtYXggLyBzcGFjaW5nKSAqIHNwYWNpbmc7IC8vIElmIG1pbiwgbWF4IGFuZCBzdGVwU2l6ZSBpcyBzZXQgYW5kIHRoZXkgbWFrZSBhbiBldmVubHkgc3BhY2VkIHNjYWxlIHVzZSBpdC4KCiAgICBpZiAoc3RlcFNpemUpIHsKICAgICAgLy8gSWYgdmVyeSBjbG9zZSB0byBvdXIgd2hvbGUgbnVtYmVyLCB1c2UgaXQuCiAgICAgIGlmICghaXNOdWxsT3JVbmRlZiQyKG1pbikgJiYgaGVscGVycyQxLmFsbW9zdFdob2xlKG1pbiAvIHNwYWNpbmcsIHNwYWNpbmcgLyAxMDAwKSkgewogICAgICAgIG5pY2VNaW4gPSBtaW47CiAgICAgIH0KCiAgICAgIGlmICghaXNOdWxsT3JVbmRlZiQyKG1heCkgJiYgaGVscGVycyQxLmFsbW9zdFdob2xlKG1heCAvIHNwYWNpbmcsIHNwYWNpbmcgLyAxMDAwKSkgewogICAgICAgIG5pY2VNYXggPSBtYXg7CiAgICAgIH0KICAgIH0KCiAgICBudW1TcGFjZXMgPSAobmljZU1heCAtIG5pY2VNaW4pIC8gc3BhY2luZzsgLy8gSWYgdmVyeSBjbG9zZSB0byBvdXIgcm91bmRlZCB2YWx1ZSwgdXNlIGl0LgoKICAgIGlmIChoZWxwZXJzJDEuYWxtb3N0RXF1YWxzKG51bVNwYWNlcywgTWF0aC5yb3VuZChudW1TcGFjZXMpLCBzcGFjaW5nIC8gMTAwMCkpIHsKICAgICAgbnVtU3BhY2VzID0gTWF0aC5yb3VuZChudW1TcGFjZXMpOwogICAgfSBlbHNlIHsKICAgICAgbnVtU3BhY2VzID0gTWF0aC5jZWlsKG51bVNwYWNlcyk7CiAgICB9CgogICAgbmljZU1pbiA9IE1hdGgucm91bmQobmljZU1pbiAqIGZhY3RvcikgLyBmYWN0b3I7CiAgICBuaWNlTWF4ID0gTWF0aC5yb3VuZChuaWNlTWF4ICogZmFjdG9yKSAvIGZhY3RvcjsKICAgIHRpY2tzLnB1c2goaXNOdWxsT3JVbmRlZiQyKG1pbikgPyBuaWNlTWluIDogbWluKTsKCiAgICBmb3IgKHZhciBqID0gMTsgaiA8IG51bVNwYWNlczsgKytqKSB7CiAgICAgIHRpY2tzLnB1c2goTWF0aC5yb3VuZCgobmljZU1pbiArIGogKiBzcGFjaW5nKSAqIGZhY3RvcikgLyBmYWN0b3IpOwogICAgfQoKICAgIHRpY2tzLnB1c2goaXNOdWxsT3JVbmRlZiQyKG1heCkgPyBuaWNlTWF4IDogbWF4KTsKICAgIHJldHVybiB0aWNrczsKICB9CgogIHZhciBzY2FsZV9saW5lYXJiYXNlID0gY29yZV9zY2FsZS5leHRlbmQoewogICAgZ2V0UmlnaHRWYWx1ZTogZnVuY3Rpb24gZ2V0UmlnaHRWYWx1ZSh2YWx1ZSkgewogICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiArdmFsdWU7CiAgICAgIH0KCiAgICAgIHJldHVybiBjb3JlX3NjYWxlLnByb3RvdHlwZS5nZXRSaWdodFZhbHVlLmNhbGwodGhpcywgdmFsdWUpOwogICAgfSwKICAgIGhhbmRsZVRpY2tSYW5nZU9wdGlvbnM6IGZ1bmN0aW9uIGhhbmRsZVRpY2tSYW5nZU9wdGlvbnMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBvcHRzID0gbWUub3B0aW9uczsKICAgICAgdmFyIHRpY2tPcHRzID0gb3B0cy50aWNrczsgLy8gSWYgd2UgYXJlIGZvcmNpbmcgaXQgdG8gYmVnaW4gYXQgMCwgYnV0IDAgd2lsbCBhbHJlYWR5IGJlIHJlbmRlcmVkIG9uIHRoZSBjaGFydCwKICAgICAgLy8gZG8gbm90aGluZyBzaW5jZSB0aGF0IHdvdWxkIG1ha2UgdGhlIGNoYXJ0IHdlaXJkLiBJZiB0aGUgdXNlciByZWFsbHkgd2FudHMgYSB3ZWlyZCBjaGFydAogICAgICAvLyBheGlzLCB0aGV5IGNhbiBtYW51YWxseSBvdmVycmlkZSBpdAoKICAgICAgaWYgKHRpY2tPcHRzLmJlZ2luQXRaZXJvKSB7CiAgICAgICAgdmFyIG1pblNpZ24gPSBoZWxwZXJzJDEuc2lnbihtZS5taW4pOwogICAgICAgIHZhciBtYXhTaWduID0gaGVscGVycyQxLnNpZ24obWUubWF4KTsKCiAgICAgICAgaWYgKG1pblNpZ24gPCAwICYmIG1heFNpZ24gPCAwKSB7CiAgICAgICAgICAvLyBtb3ZlIHRoZSB0b3AgdXAgdG8gMAogICAgICAgICAgbWUubWF4ID0gMDsKICAgICAgICB9IGVsc2UgaWYgKG1pblNpZ24gPiAwICYmIG1heFNpZ24gPiAwKSB7CiAgICAgICAgICAvLyBtb3ZlIHRoZSBib3R0b20gZG93biB0byAwCiAgICAgICAgICBtZS5taW4gPSAwOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdmFyIHNldE1pbiA9IHRpY2tPcHRzLm1pbiAhPT0gdW5kZWZpbmVkIHx8IHRpY2tPcHRzLnN1Z2dlc3RlZE1pbiAhPT0gdW5kZWZpbmVkOwogICAgICB2YXIgc2V0TWF4ID0gdGlja09wdHMubWF4ICE9PSB1bmRlZmluZWQgfHwgdGlja09wdHMuc3VnZ2VzdGVkTWF4ICE9PSB1bmRlZmluZWQ7CgogICAgICBpZiAodGlja09wdHMubWluICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBtZS5taW4gPSB0aWNrT3B0cy5taW47CiAgICAgIH0gZWxzZSBpZiAodGlja09wdHMuc3VnZ2VzdGVkTWluICE9PSB1bmRlZmluZWQpIHsKICAgICAgICBpZiAobWUubWluID09PSBudWxsKSB7CiAgICAgICAgICBtZS5taW4gPSB0aWNrT3B0cy5zdWdnZXN0ZWRNaW47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1lLm1pbiA9IE1hdGgubWluKG1lLm1pbiwgdGlja09wdHMuc3VnZ2VzdGVkTWluKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICh0aWNrT3B0cy5tYXggIT09IHVuZGVmaW5lZCkgewogICAgICAgIG1lLm1heCA9IHRpY2tPcHRzLm1heDsKICAgICAgfSBlbHNlIGlmICh0aWNrT3B0cy5zdWdnZXN0ZWRNYXggIT09IHVuZGVmaW5lZCkgewogICAgICAgIGlmIChtZS5tYXggPT09IG51bGwpIHsKICAgICAgICAgIG1lLm1heCA9IHRpY2tPcHRzLnN1Z2dlc3RlZE1heDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgbWUubWF4ID0gTWF0aC5tYXgobWUubWF4LCB0aWNrT3B0cy5zdWdnZXN0ZWRNYXgpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHNldE1pbiAhPT0gc2V0TWF4KSB7CiAgICAgICAgLy8gV2Ugc2V0IHRoZSBtaW4gb3IgdGhlIG1heCBidXQgbm90IGJvdGguCiAgICAgICAgLy8gU28gZW5zdXJlIHRoYXQgb3VyIHJhbmdlIGlzIGdvb2QKICAgICAgICAvLyBJbnZlcnRlZCBvciAwIGxlbmd0aCByYW5nZSBjYW4gaGFwcGVuIHdoZW4KICAgICAgICAvLyB0aWNrcy5taW4gaXMgc2V0LCBhbmQgbm8gZGF0YXNldHMgYXJlIHZpc2libGUKICAgICAgICBpZiAobWUubWluID49IG1lLm1heCkgewogICAgICAgICAgaWYgKHNldE1pbikgewogICAgICAgICAgICBtZS5tYXggPSBtZS5taW4gKyAxOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgbWUubWluID0gbWUubWF4IC0gMTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChtZS5taW4gPT09IG1lLm1heCkgewogICAgICAgIG1lLm1heCsrOwoKICAgICAgICBpZiAoIXRpY2tPcHRzLmJlZ2luQXRaZXJvKSB7CiAgICAgICAgICBtZS5taW4tLTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBnZXRUaWNrTGltaXQ6IGZ1bmN0aW9uIGdldFRpY2tMaW1pdCgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIHRpY2tPcHRzID0gbWUub3B0aW9ucy50aWNrczsKICAgICAgdmFyIHN0ZXBTaXplID0gdGlja09wdHMuc3RlcFNpemU7CiAgICAgIHZhciBtYXhUaWNrc0xpbWl0ID0gdGlja09wdHMubWF4VGlja3NMaW1pdDsKICAgICAgdmFyIG1heFRpY2tzOwoKICAgICAgaWYgKHN0ZXBTaXplKSB7CiAgICAgICAgbWF4VGlja3MgPSBNYXRoLmNlaWwobWUubWF4IC8gc3RlcFNpemUpIC0gTWF0aC5mbG9vcihtZS5taW4gLyBzdGVwU2l6ZSkgKyAxOwogICAgICB9IGVsc2UgewogICAgICAgIG1heFRpY2tzID0gbWUuX2NvbXB1dGVUaWNrTGltaXQoKTsKICAgICAgICBtYXhUaWNrc0xpbWl0ID0gbWF4VGlja3NMaW1pdCB8fCAxMTsKICAgICAgfQoKICAgICAgaWYgKG1heFRpY2tzTGltaXQpIHsKICAgICAgICBtYXhUaWNrcyA9IE1hdGgubWluKG1heFRpY2tzTGltaXQsIG1heFRpY2tzKTsKICAgICAgfQoKICAgICAgcmV0dXJuIG1heFRpY2tzOwogICAgfSwKICAgIF9jb21wdXRlVGlja0xpbWl0OiBmdW5jdGlvbiBfY29tcHV0ZVRpY2tMaW1pdCgpIHsKICAgICAgcmV0dXJuIE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgIH0sCiAgICBoYW5kbGVEaXJlY3Rpb25hbENoYW5nZXM6IG5vb3AsCiAgICBidWlsZFRpY2tzOiBmdW5jdGlvbiBidWlsZFRpY2tzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgb3B0cyA9IG1lLm9wdGlvbnM7CiAgICAgIHZhciB0aWNrT3B0cyA9IG9wdHMudGlja3M7IC8vIEZpZ3VyZSBvdXQgd2hhdCB0aGUgbWF4IG51bWJlciBvZiB0aWNrcyB3ZSBjYW4gc3VwcG9ydCBpdCBpcyBiYXNlZCBvbiB0aGUgc2l6ZSBvZgogICAgICAvLyB0aGUgYXhpcyBhcmVhLiBGb3Igbm93LCB3ZSBzYXkgdGhhdCB0aGUgbWluaW11bSB0aWNrIHNwYWNpbmcgaW4gcGl4ZWxzIG11c3QgYmUgNDAKICAgICAgLy8gV2UgYWxzbyBsaW1pdCB0aGUgbWF4aW11bSBudW1iZXIgb2YgdGlja3MgdG8gMTEgd2hpY2ggZ2l2ZXMgYSBuaWNlIDEwIHNxdWFyZXMgb24KICAgICAgLy8gdGhlIGdyYXBoLiBNYWtlIHN1cmUgd2UgYWx3YXlzIGhhdmUgYXQgbGVhc3QgMiB0aWNrcwoKICAgICAgdmFyIG1heFRpY2tzID0gbWUuZ2V0VGlja0xpbWl0KCk7CiAgICAgIG1heFRpY2tzID0gTWF0aC5tYXgoMiwgbWF4VGlja3MpOwogICAgICB2YXIgbnVtZXJpY0dlbmVyYXRvck9wdGlvbnMgPSB7CiAgICAgICAgbWF4VGlja3M6IG1heFRpY2tzLAogICAgICAgIG1pbjogdGlja09wdHMubWluLAogICAgICAgIG1heDogdGlja09wdHMubWF4LAogICAgICAgIHByZWNpc2lvbjogdGlja09wdHMucHJlY2lzaW9uLAogICAgICAgIHN0ZXBTaXplOiBoZWxwZXJzJDEudmFsdWVPckRlZmF1bHQodGlja09wdHMuZml4ZWRTdGVwU2l6ZSwgdGlja09wdHMuc3RlcFNpemUpCiAgICAgIH07CiAgICAgIHZhciB0aWNrcyA9IG1lLnRpY2tzID0gZ2VuZXJhdGVUaWNrcyhudW1lcmljR2VuZXJhdG9yT3B0aW9ucywgbWUpOwogICAgICBtZS5oYW5kbGVEaXJlY3Rpb25hbENoYW5nZXMoKTsgLy8gQXQgdGhpcyBwb2ludCwgd2UgbmVlZCB0byB1cGRhdGUgb3VyIG1heCBhbmQgbWluIGdpdmVuIHRoZSB0aWNrIHZhbHVlcyBzaW5jZSB3ZSBoYXZlIGV4cGFuZGVkIHRoZQogICAgICAvLyByYW5nZSBvZiB0aGUgc2NhbGUKCiAgICAgIG1lLm1heCA9IGhlbHBlcnMkMS5tYXgodGlja3MpOwogICAgICBtZS5taW4gPSBoZWxwZXJzJDEubWluKHRpY2tzKTsKCiAgICAgIGlmICh0aWNrT3B0cy5yZXZlcnNlKSB7CiAgICAgICAgdGlja3MucmV2ZXJzZSgpOwogICAgICAgIG1lLnN0YXJ0ID0gbWUubWF4OwogICAgICAgIG1lLmVuZCA9IG1lLm1pbjsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZS5zdGFydCA9IG1lLm1pbjsKICAgICAgICBtZS5lbmQgPSBtZS5tYXg7CiAgICAgIH0KICAgIH0sCiAgICBjb252ZXJ0VGlja3NUb0xhYmVsczogZnVuY3Rpb24gY29udmVydFRpY2tzVG9MYWJlbHMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIG1lLnRpY2tzQXNOdW1iZXJzID0gbWUudGlja3Muc2xpY2UoKTsKICAgICAgbWUuemVyb0xpbmVJbmRleCA9IG1lLnRpY2tzLmluZGV4T2YoMCk7CiAgICAgIGNvcmVfc2NhbGUucHJvdG90eXBlLmNvbnZlcnRUaWNrc1RvTGFiZWxzLmNhbGwobWUpOwogICAgfSwKICAgIF9jb25maWd1cmU6IGZ1bmN0aW9uIF9jb25maWd1cmUoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciB0aWNrcyA9IG1lLmdldFRpY2tzKCk7CiAgICAgIHZhciBzdGFydCA9IG1lLm1pbjsKICAgICAgdmFyIGVuZCA9IG1lLm1heDsKICAgICAgdmFyIG9mZnNldDsKCiAgICAgIGNvcmVfc2NhbGUucHJvdG90eXBlLl9jb25maWd1cmUuY2FsbChtZSk7CgogICAgICBpZiAobWUub3B0aW9ucy5vZmZzZXQgJiYgdGlja3MubGVuZ3RoKSB7CiAgICAgICAgb2Zmc2V0ID0gKGVuZCAtIHN0YXJ0KSAvIE1hdGgubWF4KHRpY2tzLmxlbmd0aCAtIDEsIDEpIC8gMjsKICAgICAgICBzdGFydCAtPSBvZmZzZXQ7CiAgICAgICAgZW5kICs9IG9mZnNldDsKICAgICAgfQoKICAgICAgbWUuX3N0YXJ0VmFsdWUgPSBzdGFydDsKICAgICAgbWUuX2VuZFZhbHVlID0gZW5kOwogICAgICBtZS5fdmFsdWVSYW5nZSA9IGVuZCAtIHN0YXJ0OwogICAgfQogIH0pOwogIHZhciBkZWZhdWx0Q29uZmlnJDEgPSB7CiAgICBwb3NpdGlvbjogJ2xlZnQnLAogICAgdGlja3M6IHsKICAgICAgY2FsbGJhY2s6IGNvcmVfdGlja3MuZm9ybWF0dGVycy5saW5lYXIKICAgIH0KICB9OwogIHZhciBERUZBVUxUX01JTiA9IDA7CiAgdmFyIERFRkFVTFRfTUFYID0gMTsKCiAgZnVuY3Rpb24gZ2V0T3JDcmVhdGVTdGFjayhzdGFja3MsIHN0YWNrZWQsIG1ldGEpIHsKICAgIHZhciBrZXkgPSBbbWV0YS50eXBlLCAvLyB3ZSBoYXZlIGEgc2VwYXJhdGUgc3RhY2sgZm9yIHN0YWNrPXVuZGVmaW5lZCBkYXRhc2V0cyB3aGVuIHRoZSBvcHRzLnN0YWNrZWQgaXMgdW5kZWZpbmVkCiAgICBzdGFja2VkID09PSB1bmRlZmluZWQgJiYgbWV0YS5zdGFjayA9PT0gdW5kZWZpbmVkID8gbWV0YS5pbmRleCA6ICcnLCBtZXRhLnN0YWNrXS5qb2luKCcuJyk7CgogICAgaWYgKHN0YWNrc1trZXldID09PSB1bmRlZmluZWQpIHsKICAgICAgc3RhY2tzW2tleV0gPSB7CiAgICAgICAgcG9zOiBbXSwKICAgICAgICBuZWc6IFtdCiAgICAgIH07CiAgICB9CgogICAgcmV0dXJuIHN0YWNrc1trZXldOwogIH0KCiAgZnVuY3Rpb24gc3RhY2tEYXRhKHNjYWxlLCBzdGFja3MsIG1ldGEsIGRhdGEpIHsKICAgIHZhciBvcHRzID0gc2NhbGUub3B0aW9uczsKICAgIHZhciBzdGFja2VkID0gb3B0cy5zdGFja2VkOwogICAgdmFyIHN0YWNrID0gZ2V0T3JDcmVhdGVTdGFjayhzdGFja3MsIHN0YWNrZWQsIG1ldGEpOwogICAgdmFyIHBvcyA9IHN0YWNrLnBvczsKICAgIHZhciBuZWcgPSBzdGFjay5uZWc7CiAgICB2YXIgaWxlbiA9IGRhdGEubGVuZ3RoOwogICAgdmFyIGksIHZhbHVlOwoKICAgIGZvciAoaSA9IDA7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgdmFsdWUgPSBzY2FsZS5fcGFyc2VWYWx1ZShkYXRhW2ldKTsKCiAgICAgIGlmIChpc05hTih2YWx1ZS5taW4pIHx8IGlzTmFOKHZhbHVlLm1heCkgfHwgbWV0YS5kYXRhW2ldLmhpZGRlbikgewogICAgICAgIGNvbnRpbnVlOwogICAgICB9CgogICAgICBwb3NbaV0gPSBwb3NbaV0gfHwgMDsKICAgICAgbmVnW2ldID0gbmVnW2ldIHx8IDA7CgogICAgICBpZiAob3B0cy5yZWxhdGl2ZVBvaW50cykgewogICAgICAgIHBvc1tpXSA9IDEwMDsKICAgICAgfSBlbHNlIGlmICh2YWx1ZS5taW4gPCAwIHx8IHZhbHVlLm1heCA8IDApIHsKICAgICAgICBuZWdbaV0gKz0gdmFsdWUubWluOwogICAgICB9IGVsc2UgewogICAgICAgIHBvc1tpXSArPSB2YWx1ZS5tYXg7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIHVwZGF0ZU1pbk1heChzY2FsZSwgbWV0YSwgZGF0YSkgewogICAgdmFyIGlsZW4gPSBkYXRhLmxlbmd0aDsKICAgIHZhciBpLCB2YWx1ZTsKCiAgICBmb3IgKGkgPSAwOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgIHZhbHVlID0gc2NhbGUuX3BhcnNlVmFsdWUoZGF0YVtpXSk7CgogICAgICBpZiAoaXNOYU4odmFsdWUubWluKSB8fCBpc05hTih2YWx1ZS5tYXgpIHx8IG1ldGEuZGF0YVtpXS5oaWRkZW4pIHsKICAgICAgICBjb250aW51ZTsKICAgICAgfQoKICAgICAgc2NhbGUubWluID0gTWF0aC5taW4oc2NhbGUubWluLCB2YWx1ZS5taW4pOwogICAgICBzY2FsZS5tYXggPSBNYXRoLm1heChzY2FsZS5tYXgsIHZhbHVlLm1heCk7CiAgICB9CiAgfQoKICB2YXIgc2NhbGVfbGluZWFyID0gc2NhbGVfbGluZWFyYmFzZS5leHRlbmQoewogICAgZGV0ZXJtaW5lRGF0YUxpbWl0czogZnVuY3Rpb24gZGV0ZXJtaW5lRGF0YUxpbWl0cygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9wdHMgPSBtZS5vcHRpb25zOwogICAgICB2YXIgY2hhcnQgPSBtZS5jaGFydDsKICAgICAgdmFyIGRhdGFzZXRzID0gY2hhcnQuZGF0YS5kYXRhc2V0czsKCiAgICAgIHZhciBtZXRhc2V0cyA9IG1lLl9nZXRNYXRjaGluZ1Zpc2libGVNZXRhcygpOwoKICAgICAgdmFyIGhhc1N0YWNrcyA9IG9wdHMuc3RhY2tlZDsKICAgICAgdmFyIHN0YWNrcyA9IHt9OwogICAgICB2YXIgaWxlbiA9IG1ldGFzZXRzLmxlbmd0aDsKICAgICAgdmFyIGksIG1ldGEsIGRhdGEsIHZhbHVlczsKICAgICAgbWUubWluID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICBtZS5tYXggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CgogICAgICBpZiAoaGFzU3RhY2tzID09PSB1bmRlZmluZWQpIHsKICAgICAgICBmb3IgKGkgPSAwOyAhaGFzU3RhY2tzICYmIGkgPCBpbGVuOyArK2kpIHsKICAgICAgICAgIG1ldGEgPSBtZXRhc2V0c1tpXTsKICAgICAgICAgIGhhc1N0YWNrcyA9IG1ldGEuc3RhY2sgIT09IHVuZGVmaW5lZDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDA7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBtZXRhID0gbWV0YXNldHNbaV07CiAgICAgICAgZGF0YSA9IGRhdGFzZXRzW21ldGEuaW5kZXhdLmRhdGE7CgogICAgICAgIGlmIChoYXNTdGFja3MpIHsKICAgICAgICAgIHN0YWNrRGF0YShtZSwgc3RhY2tzLCBtZXRhLCBkYXRhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdXBkYXRlTWluTWF4KG1lLCBtZXRhLCBkYXRhKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGhlbHBlcnMkMS5lYWNoKHN0YWNrcywgZnVuY3Rpb24gKHN0YWNrVmFsdWVzKSB7CiAgICAgICAgdmFsdWVzID0gc3RhY2tWYWx1ZXMucG9zLmNvbmNhdChzdGFja1ZhbHVlcy5uZWcpOwogICAgICAgIG1lLm1pbiA9IE1hdGgubWluKG1lLm1pbiwgaGVscGVycyQxLm1pbih2YWx1ZXMpKTsKICAgICAgICBtZS5tYXggPSBNYXRoLm1heChtZS5tYXgsIGhlbHBlcnMkMS5tYXgodmFsdWVzKSk7CiAgICAgIH0pOwogICAgICBtZS5taW4gPSBoZWxwZXJzJDEuaXNGaW5pdGUobWUubWluKSAmJiAhaXNOYU4obWUubWluKSA/IG1lLm1pbiA6IERFRkFVTFRfTUlOOwogICAgICBtZS5tYXggPSBoZWxwZXJzJDEuaXNGaW5pdGUobWUubWF4KSAmJiAhaXNOYU4obWUubWF4KSA/IG1lLm1heCA6IERFRkFVTFRfTUFYOyAvLyBDb21tb24gYmFzZSBpbXBsZW1lbnRhdGlvbiB0byBoYW5kbGUgdGlja3MubWluLCB0aWNrcy5tYXgsIHRpY2tzLmJlZ2luQXRaZXJvCgogICAgICBtZS5oYW5kbGVUaWNrUmFuZ2VPcHRpb25zKCk7CiAgICB9LAogICAgLy8gUmV0dXJucyB0aGUgbWF4aW11bSBudW1iZXIgb2YgdGlja3MgYmFzZWQgb24gdGhlIHNjYWxlIGRpbWVuc2lvbgogICAgX2NvbXB1dGVUaWNrTGltaXQ6IGZ1bmN0aW9uIF9jb21wdXRlVGlja0xpbWl0KCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgdGlja0ZvbnQ7CgogICAgICBpZiAobWUuaXNIb3Jpem9udGFsKCkpIHsKICAgICAgICByZXR1cm4gTWF0aC5jZWlsKG1lLndpZHRoIC8gNDApOwogICAgICB9CgogICAgICB0aWNrRm9udCA9IGhlbHBlcnMkMS5vcHRpb25zLl9wYXJzZUZvbnQobWUub3B0aW9ucy50aWNrcyk7CiAgICAgIHJldHVybiBNYXRoLmNlaWwobWUuaGVpZ2h0IC8gdGlja0ZvbnQubGluZUhlaWdodCk7CiAgICB9LAogICAgLy8gQ2FsbGVkIGFmdGVyIHRoZSB0aWNrcyBhcmUgYnVpbHQuIFdlIG5lZWQKICAgIGhhbmRsZURpcmVjdGlvbmFsQ2hhbmdlczogZnVuY3Rpb24gaGFuZGxlRGlyZWN0aW9uYWxDaGFuZ2VzKCkgewogICAgICBpZiAoIXRoaXMuaXNIb3Jpem9udGFsKCkpIHsKICAgICAgICAvLyBXZSBhcmUgaW4gYSB2ZXJ0aWNhbCBvcmllbnRhdGlvbi4gVGhlIHRvcCB2YWx1ZSBpcyB0aGUgaGlnaGVzdC4gU28gcmV2ZXJzZSB0aGUgYXJyYXkKICAgICAgICB0aGlzLnRpY2tzLnJldmVyc2UoKTsKICAgICAgfQogICAgfSwKICAgIGdldExhYmVsRm9ySW5kZXg6IGZ1bmN0aW9uIGdldExhYmVsRm9ySW5kZXgoaW5kZXgsIGRhdGFzZXRJbmRleCkgewogICAgICByZXR1cm4gdGhpcy5fZ2V0U2NhbGVMYWJlbCh0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHNbZGF0YXNldEluZGV4XS5kYXRhW2luZGV4XSk7CiAgICB9LAogICAgLy8gVXRpbHMKICAgIGdldFBpeGVsRm9yVmFsdWU6IGZ1bmN0aW9uIGdldFBpeGVsRm9yVmFsdWUodmFsdWUpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgcmV0dXJuIG1lLmdldFBpeGVsRm9yRGVjaW1hbCgoK21lLmdldFJpZ2h0VmFsdWUodmFsdWUpIC0gbWUuX3N0YXJ0VmFsdWUpIC8gbWUuX3ZhbHVlUmFuZ2UpOwogICAgfSwKICAgIGdldFZhbHVlRm9yUGl4ZWw6IGZ1bmN0aW9uIGdldFZhbHVlRm9yUGl4ZWwocGl4ZWwpIHsKICAgICAgcmV0dXJuIHRoaXMuX3N0YXJ0VmFsdWUgKyB0aGlzLmdldERlY2ltYWxGb3JQaXhlbChwaXhlbCkgKiB0aGlzLl92YWx1ZVJhbmdlOwogICAgfSwKICAgIGdldFBpeGVsRm9yVGljazogZnVuY3Rpb24gZ2V0UGl4ZWxGb3JUaWNrKGluZGV4KSB7CiAgICAgIHZhciB0aWNrcyA9IHRoaXMudGlja3NBc051bWJlcnM7CgogICAgICBpZiAoaW5kZXggPCAwIHx8IGluZGV4ID4gdGlja3MubGVuZ3RoIC0gMSkgewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5nZXRQaXhlbEZvclZhbHVlKHRpY2tzW2luZGV4XSk7CiAgICB9CiAgfSk7IC8vIElOVEVSTkFMOiBzdGF0aWMgZGVmYXVsdCBvcHRpb25zLCByZWdpc3RlcmVkIGluIHNyYy9pbmRleC5qcwoKICB2YXIgX2RlZmF1bHRzJDEgPSBkZWZhdWx0Q29uZmlnJDE7CiAgc2NhbGVfbGluZWFyLl9kZWZhdWx0cyA9IF9kZWZhdWx0cyQxOwogIHZhciB2YWx1ZU9yRGVmYXVsdCRiID0gaGVscGVycyQxLnZhbHVlT3JEZWZhdWx0OwogIHZhciBsb2cxMCA9IGhlbHBlcnMkMS5tYXRoLmxvZzEwOwogIC8qKg0KICAgKiBHZW5lcmF0ZSBhIHNldCBvZiBsb2dhcml0aG1pYyB0aWNrcw0KICAgKiBAcGFyYW0gZ2VuZXJhdGlvbk9wdGlvbnMgdGhlIG9wdGlvbnMgdXNlZCB0byBnZW5lcmF0ZSB0aGUgdGlja3MNCiAgICogQHBhcmFtIGRhdGFSYW5nZSB0aGUgcmFuZ2Ugb2YgdGhlIGRhdGENCiAgICogQHJldHVybnMge251bWJlcltdfSBhcnJheSBvZiB0aWNrIHZhbHVlcw0KICAgKi8KCiAgZnVuY3Rpb24gZ2VuZXJhdGVUaWNrcyQxKGdlbmVyYXRpb25PcHRpb25zLCBkYXRhUmFuZ2UpIHsKICAgIHZhciB0aWNrcyA9IFtdOwogICAgdmFyIHRpY2tWYWwgPSB2YWx1ZU9yRGVmYXVsdCRiKGdlbmVyYXRpb25PcHRpb25zLm1pbiwgTWF0aC5wb3coMTAsIE1hdGguZmxvb3IobG9nMTAoZGF0YVJhbmdlLm1pbikpKSk7CiAgICB2YXIgZW5kRXhwID0gTWF0aC5mbG9vcihsb2cxMChkYXRhUmFuZ2UubWF4KSk7CiAgICB2YXIgZW5kU2lnbmlmaWNhbmQgPSBNYXRoLmNlaWwoZGF0YVJhbmdlLm1heCAvIE1hdGgucG93KDEwLCBlbmRFeHApKTsKICAgIHZhciBleHAsIHNpZ25pZmljYW5kOwoKICAgIGlmICh0aWNrVmFsID09PSAwKSB7CiAgICAgIGV4cCA9IE1hdGguZmxvb3IobG9nMTAoZGF0YVJhbmdlLm1pbk5vdFplcm8pKTsKICAgICAgc2lnbmlmaWNhbmQgPSBNYXRoLmZsb29yKGRhdGFSYW5nZS5taW5Ob3RaZXJvIC8gTWF0aC5wb3coMTAsIGV4cCkpOwogICAgICB0aWNrcy5wdXNoKHRpY2tWYWwpOwogICAgICB0aWNrVmFsID0gc2lnbmlmaWNhbmQgKiBNYXRoLnBvdygxMCwgZXhwKTsKICAgIH0gZWxzZSB7CiAgICAgIGV4cCA9IE1hdGguZmxvb3IobG9nMTAodGlja1ZhbCkpOwogICAgICBzaWduaWZpY2FuZCA9IE1hdGguZmxvb3IodGlja1ZhbCAvIE1hdGgucG93KDEwLCBleHApKTsKICAgIH0KCiAgICB2YXIgcHJlY2lzaW9uID0gZXhwIDwgMCA/IE1hdGgucG93KDEwLCBNYXRoLmFicyhleHApKSA6IDE7CgogICAgZG8gewogICAgICB0aWNrcy5wdXNoKHRpY2tWYWwpOwogICAgICArK3NpZ25pZmljYW5kOwoKICAgICAgaWYgKHNpZ25pZmljYW5kID09PSAxMCkgewogICAgICAgIHNpZ25pZmljYW5kID0gMTsKICAgICAgICArK2V4cDsKICAgICAgICBwcmVjaXNpb24gPSBleHAgPj0gMCA/IDEgOiBwcmVjaXNpb247CiAgICAgIH0KCiAgICAgIHRpY2tWYWwgPSBNYXRoLnJvdW5kKHNpZ25pZmljYW5kICogTWF0aC5wb3coMTAsIGV4cCkgKiBwcmVjaXNpb24pIC8gcHJlY2lzaW9uOwogICAgfSB3aGlsZSAoZXhwIDwgZW5kRXhwIHx8IGV4cCA9PT0gZW5kRXhwICYmIHNpZ25pZmljYW5kIDwgZW5kU2lnbmlmaWNhbmQpOwoKICAgIHZhciBsYXN0VGljayA9IHZhbHVlT3JEZWZhdWx0JGIoZ2VuZXJhdGlvbk9wdGlvbnMubWF4LCB0aWNrVmFsKTsKICAgIHRpY2tzLnB1c2gobGFzdFRpY2spOwogICAgcmV0dXJuIHRpY2tzOwogIH0KCiAgdmFyIGRlZmF1bHRDb25maWckMiA9IHsKICAgIHBvc2l0aW9uOiAnbGVmdCcsCiAgICAvLyBsYWJlbCBzZXR0aW5ncwogICAgdGlja3M6IHsKICAgICAgY2FsbGJhY2s6IGNvcmVfdGlja3MuZm9ybWF0dGVycy5sb2dhcml0aG1pYwogICAgfQogIH07IC8vIFRPRE8odjMpOiBjaGFuZ2UgdGhpcyB0byBwb3NpdGl2ZU9yRGVmYXVsdAoKICBmdW5jdGlvbiBub25OZWdhdGl2ZU9yRGVmYXVsdCh2YWx1ZSwgZGVmYXVsdFZhbHVlKSB7CiAgICByZXR1cm4gaGVscGVycyQxLmlzRmluaXRlKHZhbHVlKSAmJiB2YWx1ZSA+PSAwID8gdmFsdWUgOiBkZWZhdWx0VmFsdWU7CiAgfQoKICB2YXIgc2NhbGVfbG9nYXJpdGhtaWMgPSBjb3JlX3NjYWxlLmV4dGVuZCh7CiAgICBkZXRlcm1pbmVEYXRhTGltaXRzOiBmdW5jdGlvbiBkZXRlcm1pbmVEYXRhTGltaXRzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgb3B0cyA9IG1lLm9wdGlvbnM7CiAgICAgIHZhciBjaGFydCA9IG1lLmNoYXJ0OwogICAgICB2YXIgZGF0YXNldHMgPSBjaGFydC5kYXRhLmRhdGFzZXRzOwogICAgICB2YXIgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7CgogICAgICBmdW5jdGlvbiBJRE1hdGNoZXMobWV0YSkgewogICAgICAgIHJldHVybiBpc0hvcml6b250YWwgPyBtZXRhLnhBeGlzSUQgPT09IG1lLmlkIDogbWV0YS55QXhpc0lEID09PSBtZS5pZDsKICAgICAgfQoKICAgICAgdmFyIGRhdGFzZXRJbmRleCwgbWV0YSwgdmFsdWUsIGRhdGEsIGksIGlsZW47IC8vIENhbGN1bGF0ZSBSYW5nZQoKICAgICAgbWUubWluID0gTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZOwogICAgICBtZS5tYXggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgIG1lLm1pbk5vdFplcm8gPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgIHZhciBoYXNTdGFja3MgPSBvcHRzLnN0YWNrZWQ7CgogICAgICBpZiAoaGFzU3RhY2tzID09PSB1bmRlZmluZWQpIHsKICAgICAgICBmb3IgKGRhdGFzZXRJbmRleCA9IDA7IGRhdGFzZXRJbmRleCA8IGRhdGFzZXRzLmxlbmd0aDsgZGF0YXNldEluZGV4KyspIHsKICAgICAgICAgIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpOwoKICAgICAgICAgIGlmIChjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGRhdGFzZXRJbmRleCkgJiYgSURNYXRjaGVzKG1ldGEpICYmIG1ldGEuc3RhY2sgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBoYXNTdGFja3MgPSB0cnVlOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChvcHRzLnN0YWNrZWQgfHwgaGFzU3RhY2tzKSB7CiAgICAgICAgdmFyIHZhbHVlc1BlclN0YWNrID0ge307CgogICAgICAgIGZvciAoZGF0YXNldEluZGV4ID0gMDsgZGF0YXNldEluZGV4IDwgZGF0YXNldHMubGVuZ3RoOyBkYXRhc2V0SW5kZXgrKykgewogICAgICAgICAgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCk7CiAgICAgICAgICB2YXIga2V5ID0gW21ldGEudHlwZSwgLy8gd2UgaGF2ZSBhIHNlcGFyYXRlIHN0YWNrIGZvciBzdGFjaz11bmRlZmluZWQgZGF0YXNldHMgd2hlbiB0aGUgb3B0cy5zdGFja2VkIGlzIHVuZGVmaW5lZAogICAgICAgICAgb3B0cy5zdGFja2VkID09PSB1bmRlZmluZWQgJiYgbWV0YS5zdGFjayA9PT0gdW5kZWZpbmVkID8gZGF0YXNldEluZGV4IDogJycsIG1ldGEuc3RhY2tdLmpvaW4oJy4nKTsKCiAgICAgICAgICBpZiAoY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShkYXRhc2V0SW5kZXgpICYmIElETWF0Y2hlcyhtZXRhKSkgewogICAgICAgICAgICBpZiAodmFsdWVzUGVyU3RhY2tba2V5XSA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgdmFsdWVzUGVyU3RhY2tba2V5XSA9IFtdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBkYXRhID0gZGF0YXNldHNbZGF0YXNldEluZGV4XS5kYXRhOwoKICAgICAgICAgICAgZm9yIChpID0gMCwgaWxlbiA9IGRhdGEubGVuZ3RoOyBpIDwgaWxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgdmFyIHZhbHVlcyA9IHZhbHVlc1BlclN0YWNrW2tleV07CiAgICAgICAgICAgICAgdmFsdWUgPSBtZS5fcGFyc2VWYWx1ZShkYXRhW2ldKTsgLy8gaW52YWxpZCwgaGlkZGVuIGFuZCBuZWdhdGl2ZSB2YWx1ZXMgYXJlIGlnbm9yZWQKCiAgICAgICAgICAgICAgaWYgKGlzTmFOKHZhbHVlLm1pbikgfHwgaXNOYU4odmFsdWUubWF4KSB8fCBtZXRhLmRhdGFbaV0uaGlkZGVuIHx8IHZhbHVlLm1pbiA8IDAgfHwgdmFsdWUubWF4IDwgMCkgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB2YWx1ZXNbaV0gPSB2YWx1ZXNbaV0gfHwgMDsKICAgICAgICAgICAgICB2YWx1ZXNbaV0gKz0gdmFsdWUubWF4OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBoZWxwZXJzJDEuZWFjaCh2YWx1ZXNQZXJTdGFjaywgZnVuY3Rpb24gKHZhbHVlc0ZvclR5cGUpIHsKICAgICAgICAgIGlmICh2YWx1ZXNGb3JUeXBlLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgdmFyIG1pblZhbCA9IGhlbHBlcnMkMS5taW4odmFsdWVzRm9yVHlwZSk7CiAgICAgICAgICAgIHZhciBtYXhWYWwgPSBoZWxwZXJzJDEubWF4KHZhbHVlc0ZvclR5cGUpOwogICAgICAgICAgICBtZS5taW4gPSBNYXRoLm1pbihtZS5taW4sIG1pblZhbCk7CiAgICAgICAgICAgIG1lLm1heCA9IE1hdGgubWF4KG1lLm1heCwgbWF4VmFsKTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKGRhdGFzZXRJbmRleCA9IDA7IGRhdGFzZXRJbmRleCA8IGRhdGFzZXRzLmxlbmd0aDsgZGF0YXNldEluZGV4KyspIHsKICAgICAgICAgIG1ldGEgPSBjaGFydC5nZXREYXRhc2V0TWV0YShkYXRhc2V0SW5kZXgpOwoKICAgICAgICAgIGlmIChjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGRhdGFzZXRJbmRleCkgJiYgSURNYXRjaGVzKG1ldGEpKSB7CiAgICAgICAgICAgIGRhdGEgPSBkYXRhc2V0c1tkYXRhc2V0SW5kZXhdLmRhdGE7CgogICAgICAgICAgICBmb3IgKGkgPSAwLCBpbGVuID0gZGF0YS5sZW5ndGg7IGkgPCBpbGVuOyBpKyspIHsKICAgICAgICAgICAgICB2YWx1ZSA9IG1lLl9wYXJzZVZhbHVlKGRhdGFbaV0pOyAvLyBpbnZhbGlkLCBoaWRkZW4gYW5kIG5lZ2F0aXZlIHZhbHVlcyBhcmUgaWdub3JlZAoKICAgICAgICAgICAgICBpZiAoaXNOYU4odmFsdWUubWluKSB8fCBpc05hTih2YWx1ZS5tYXgpIHx8IG1ldGEuZGF0YVtpXS5oaWRkZW4gfHwgdmFsdWUubWluIDwgMCB8fCB2YWx1ZS5tYXggPCAwKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIG1lLm1pbiA9IE1hdGgubWluKHZhbHVlLm1pbiwgbWUubWluKTsKICAgICAgICAgICAgICBtZS5tYXggPSBNYXRoLm1heCh2YWx1ZS5tYXgsIG1lLm1heCk7CgogICAgICAgICAgICAgIGlmICh2YWx1ZS5taW4gIT09IDApIHsKICAgICAgICAgICAgICAgIG1lLm1pbk5vdFplcm8gPSBNYXRoLm1pbih2YWx1ZS5taW4sIG1lLm1pbk5vdFplcm8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgbWUubWluID0gaGVscGVycyQxLmlzRmluaXRlKG1lLm1pbikgPyBtZS5taW4gOiBudWxsOwogICAgICBtZS5tYXggPSBoZWxwZXJzJDEuaXNGaW5pdGUobWUubWF4KSA/IG1lLm1heCA6IG51bGw7CiAgICAgIG1lLm1pbk5vdFplcm8gPSBoZWxwZXJzJDEuaXNGaW5pdGUobWUubWluTm90WmVybykgPyBtZS5taW5Ob3RaZXJvIDogbnVsbDsgLy8gQ29tbW9uIGJhc2UgaW1wbGVtZW50YXRpb24gdG8gaGFuZGxlIHRpY2tzLm1pbiwgdGlja3MubWF4CgogICAgICB0aGlzLmhhbmRsZVRpY2tSYW5nZU9wdGlvbnMoKTsKICAgIH0sCiAgICBoYW5kbGVUaWNrUmFuZ2VPcHRpb25zOiBmdW5jdGlvbiBoYW5kbGVUaWNrUmFuZ2VPcHRpb25zKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgdGlja09wdHMgPSBtZS5vcHRpb25zLnRpY2tzOwogICAgICB2YXIgREVGQVVMVF9NSU4gPSAxOwogICAgICB2YXIgREVGQVVMVF9NQVggPSAxMDsKICAgICAgbWUubWluID0gbm9uTmVnYXRpdmVPckRlZmF1bHQodGlja09wdHMubWluLCBtZS5taW4pOwogICAgICBtZS5tYXggPSBub25OZWdhdGl2ZU9yRGVmYXVsdCh0aWNrT3B0cy5tYXgsIG1lLm1heCk7CgogICAgICBpZiAobWUubWluID09PSBtZS5tYXgpIHsKICAgICAgICBpZiAobWUubWluICE9PSAwICYmIG1lLm1pbiAhPT0gbnVsbCkgewogICAgICAgICAgbWUubWluID0gTWF0aC5wb3coMTAsIE1hdGguZmxvb3IobG9nMTAobWUubWluKSkgLSAxKTsKICAgICAgICAgIG1lLm1heCA9IE1hdGgucG93KDEwLCBNYXRoLmZsb29yKGxvZzEwKG1lLm1heCkpICsgMSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1lLm1pbiA9IERFRkFVTFRfTUlOOwogICAgICAgICAgbWUubWF4ID0gREVGQVVMVF9NQVg7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAobWUubWluID09PSBudWxsKSB7CiAgICAgICAgbWUubWluID0gTWF0aC5wb3coMTAsIE1hdGguZmxvb3IobG9nMTAobWUubWF4KSkgLSAxKTsKICAgICAgfQoKICAgICAgaWYgKG1lLm1heCA9PT0gbnVsbCkgewogICAgICAgIG1lLm1heCA9IG1lLm1pbiAhPT0gMCA/IE1hdGgucG93KDEwLCBNYXRoLmZsb29yKGxvZzEwKG1lLm1pbikpICsgMSkgOiBERUZBVUxUX01BWDsKICAgICAgfQoKICAgICAgaWYgKG1lLm1pbk5vdFplcm8gPT09IG51bGwpIHsKICAgICAgICBpZiAobWUubWluID4gMCkgewogICAgICAgICAgbWUubWluTm90WmVybyA9IG1lLm1pbjsKICAgICAgICB9IGVsc2UgaWYgKG1lLm1heCA8IDEpIHsKICAgICAgICAgIG1lLm1pbk5vdFplcm8gPSBNYXRoLnBvdygxMCwgTWF0aC5mbG9vcihsb2cxMChtZS5tYXgpKSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG1lLm1pbk5vdFplcm8gPSBERUZBVUxUX01JTjsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICBidWlsZFRpY2tzOiBmdW5jdGlvbiBidWlsZFRpY2tzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgdGlja09wdHMgPSBtZS5vcHRpb25zLnRpY2tzOwogICAgICB2YXIgcmV2ZXJzZSA9ICFtZS5pc0hvcml6b250YWwoKTsKICAgICAgdmFyIGdlbmVyYXRpb25PcHRpb25zID0gewogICAgICAgIG1pbjogbm9uTmVnYXRpdmVPckRlZmF1bHQodGlja09wdHMubWluKSwKICAgICAgICBtYXg6IG5vbk5lZ2F0aXZlT3JEZWZhdWx0KHRpY2tPcHRzLm1heCkKICAgICAgfTsKICAgICAgdmFyIHRpY2tzID0gbWUudGlja3MgPSBnZW5lcmF0ZVRpY2tzJDEoZ2VuZXJhdGlvbk9wdGlvbnMsIG1lKTsgLy8gQXQgdGhpcyBwb2ludCwgd2UgbmVlZCB0byB1cGRhdGUgb3VyIG1heCBhbmQgbWluIGdpdmVuIHRoZSB0aWNrIHZhbHVlcyBzaW5jZSB3ZSBoYXZlIGV4cGFuZGVkIHRoZQogICAgICAvLyByYW5nZSBvZiB0aGUgc2NhbGUKCiAgICAgIG1lLm1heCA9IGhlbHBlcnMkMS5tYXgodGlja3MpOwogICAgICBtZS5taW4gPSBoZWxwZXJzJDEubWluKHRpY2tzKTsKCiAgICAgIGlmICh0aWNrT3B0cy5yZXZlcnNlKSB7CiAgICAgICAgcmV2ZXJzZSA9ICFyZXZlcnNlOwogICAgICAgIG1lLnN0YXJ0ID0gbWUubWF4OwogICAgICAgIG1lLmVuZCA9IG1lLm1pbjsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZS5zdGFydCA9IG1lLm1pbjsKICAgICAgICBtZS5lbmQgPSBtZS5tYXg7CiAgICAgIH0KCiAgICAgIGlmIChyZXZlcnNlKSB7CiAgICAgICAgdGlja3MucmV2ZXJzZSgpOwogICAgICB9CiAgICB9LAogICAgY29udmVydFRpY2tzVG9MYWJlbHM6IGZ1bmN0aW9uIGNvbnZlcnRUaWNrc1RvTGFiZWxzKCkgewogICAgICB0aGlzLnRpY2tWYWx1ZXMgPSB0aGlzLnRpY2tzLnNsaWNlKCk7CiAgICAgIGNvcmVfc2NhbGUucHJvdG90eXBlLmNvbnZlcnRUaWNrc1RvTGFiZWxzLmNhbGwodGhpcyk7CiAgICB9LAogICAgLy8gR2V0IHRoZSBjb3JyZWN0IHRvb2x0aXAgbGFiZWwKICAgIGdldExhYmVsRm9ySW5kZXg6IGZ1bmN0aW9uIGdldExhYmVsRm9ySW5kZXgoaW5kZXgsIGRhdGFzZXRJbmRleCkgewogICAgICByZXR1cm4gdGhpcy5fZ2V0U2NhbGVMYWJlbCh0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHNbZGF0YXNldEluZGV4XS5kYXRhW2luZGV4XSk7CiAgICB9LAogICAgZ2V0UGl4ZWxGb3JUaWNrOiBmdW5jdGlvbiBnZXRQaXhlbEZvclRpY2soaW5kZXgpIHsKICAgICAgdmFyIHRpY2tzID0gdGhpcy50aWNrVmFsdWVzOwoKICAgICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+IHRpY2tzLmxlbmd0aCAtIDEpIHsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuZ2V0UGl4ZWxGb3JWYWx1ZSh0aWNrc1tpbmRleF0pOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBSZXR1cm5zIHRoZSB2YWx1ZSBvZiB0aGUgZmlyc3QgdGljay4NCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgbWluaW11bSBub3QgemVybyB2YWx1ZS4NCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBmaXJzdCB0aWNrIHZhbHVlLg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZ2V0Rmlyc3RUaWNrVmFsdWU6IGZ1bmN0aW9uIF9nZXRGaXJzdFRpY2tWYWx1ZSh2YWx1ZSkgewogICAgICB2YXIgZXhwID0gTWF0aC5mbG9vcihsb2cxMCh2YWx1ZSkpOwogICAgICB2YXIgc2lnbmlmaWNhbmQgPSBNYXRoLmZsb29yKHZhbHVlIC8gTWF0aC5wb3coMTAsIGV4cCkpOwogICAgICByZXR1cm4gc2lnbmlmaWNhbmQgKiBNYXRoLnBvdygxMCwgZXhwKTsKICAgIH0sCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbiBfY29uZmlndXJlKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgc3RhcnQgPSBtZS5taW47CiAgICAgIHZhciBvZmZzZXQgPSAwOwoKICAgICAgY29yZV9zY2FsZS5wcm90b3R5cGUuX2NvbmZpZ3VyZS5jYWxsKG1lKTsKCiAgICAgIGlmIChzdGFydCA9PT0gMCkgewogICAgICAgIHN0YXJ0ID0gbWUuX2dldEZpcnN0VGlja1ZhbHVlKG1lLm1pbk5vdFplcm8pOwogICAgICAgIG9mZnNldCA9IHZhbHVlT3JEZWZhdWx0JGIobWUub3B0aW9ucy50aWNrcy5mb250U2l6ZSwgY29yZV9kZWZhdWx0cy5nbG9iYWwuZGVmYXVsdEZvbnRTaXplKSAvIG1lLl9sZW5ndGg7CiAgICAgIH0KCiAgICAgIG1lLl9zdGFydFZhbHVlID0gbG9nMTAoc3RhcnQpOwogICAgICBtZS5fdmFsdWVPZmZzZXQgPSBvZmZzZXQ7CiAgICAgIG1lLl92YWx1ZVJhbmdlID0gKGxvZzEwKG1lLm1heCkgLSBsb2cxMChzdGFydCkpIC8gKDEgLSBvZmZzZXQpOwogICAgfSwKICAgIGdldFBpeGVsRm9yVmFsdWU6IGZ1bmN0aW9uIGdldFBpeGVsRm9yVmFsdWUodmFsdWUpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGRlY2ltYWwgPSAwOwogICAgICB2YWx1ZSA9ICttZS5nZXRSaWdodFZhbHVlKHZhbHVlKTsKCiAgICAgIGlmICh2YWx1ZSA+IG1lLm1pbiAmJiB2YWx1ZSA+IDApIHsKICAgICAgICBkZWNpbWFsID0gKGxvZzEwKHZhbHVlKSAtIG1lLl9zdGFydFZhbHVlKSAvIG1lLl92YWx1ZVJhbmdlICsgbWUuX3ZhbHVlT2Zmc2V0OwogICAgICB9CgogICAgICByZXR1cm4gbWUuZ2V0UGl4ZWxGb3JEZWNpbWFsKGRlY2ltYWwpOwogICAgfSwKICAgIGdldFZhbHVlRm9yUGl4ZWw6IGZ1bmN0aW9uIGdldFZhbHVlRm9yUGl4ZWwocGl4ZWwpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGRlY2ltYWwgPSBtZS5nZXREZWNpbWFsRm9yUGl4ZWwocGl4ZWwpOwogICAgICByZXR1cm4gZGVjaW1hbCA9PT0gMCAmJiBtZS5taW4gPT09IDAgPyAwIDogTWF0aC5wb3coMTAsIG1lLl9zdGFydFZhbHVlICsgKGRlY2ltYWwgLSBtZS5fdmFsdWVPZmZzZXQpICogbWUuX3ZhbHVlUmFuZ2UpOwogICAgfQogIH0pOyAvLyBJTlRFUk5BTDogc3RhdGljIGRlZmF1bHQgb3B0aW9ucywgcmVnaXN0ZXJlZCBpbiBzcmMvaW5kZXguanMKCiAgdmFyIF9kZWZhdWx0cyQyID0gZGVmYXVsdENvbmZpZyQyOwogIHNjYWxlX2xvZ2FyaXRobWljLl9kZWZhdWx0cyA9IF9kZWZhdWx0cyQyOwogIHZhciB2YWx1ZU9yRGVmYXVsdCRjID0gaGVscGVycyQxLnZhbHVlT3JEZWZhdWx0OwogIHZhciB2YWx1ZUF0SW5kZXhPckRlZmF1bHQkMSA9IGhlbHBlcnMkMS52YWx1ZUF0SW5kZXhPckRlZmF1bHQ7CiAgdmFyIHJlc29sdmUkNCA9IGhlbHBlcnMkMS5vcHRpb25zLnJlc29sdmU7CiAgdmFyIGRlZmF1bHRDb25maWckMyA9IHsKICAgIGRpc3BsYXk6IHRydWUsCiAgICAvLyBCb29sZWFuIC0gV2hldGhlciB0byBhbmltYXRlIHNjYWxpbmcgdGhlIGNoYXJ0IGZyb20gdGhlIGNlbnRyZQogICAgYW5pbWF0ZTogdHJ1ZSwKICAgIHBvc2l0aW9uOiAnY2hhcnRBcmVhJywKICAgIGFuZ2xlTGluZXM6IHsKICAgICAgZGlzcGxheTogdHJ1ZSwKICAgICAgY29sb3I6ICdyZ2JhKDAsMCwwLDAuMSknLAogICAgICBsaW5lV2lkdGg6IDEsCiAgICAgIGJvcmRlckRhc2g6IFtdLAogICAgICBib3JkZXJEYXNoT2Zmc2V0OiAwLjAKICAgIH0sCiAgICBncmlkTGluZXM6IHsKICAgICAgY2lyY3VsYXI6IGZhbHNlCiAgICB9LAogICAgLy8gbGFiZWwgc2V0dGluZ3MKICAgIHRpY2tzOiB7CiAgICAgIC8vIEJvb2xlYW4gLSBTaG93IGEgYmFja2Ryb3AgdG8gdGhlIHNjYWxlIGxhYmVsCiAgICAgIHNob3dMYWJlbEJhY2tkcm9wOiB0cnVlLAogICAgICAvLyBTdHJpbmcgLSBUaGUgY29sb3VyIG9mIHRoZSBsYWJlbCBiYWNrZHJvcAogICAgICBiYWNrZHJvcENvbG9yOiAncmdiYSgyNTUsMjU1LDI1NSwwLjc1KScsCiAgICAgIC8vIE51bWJlciAtIFRoZSBiYWNrZHJvcCBwYWRkaW5nIGFib3ZlICYgYmVsb3cgdGhlIGxhYmVsIGluIHBpeGVscwogICAgICBiYWNrZHJvcFBhZGRpbmdZOiAyLAogICAgICAvLyBOdW1iZXIgLSBUaGUgYmFja2Ryb3AgcGFkZGluZyB0byB0aGUgc2lkZSBvZiB0aGUgbGFiZWwgaW4gcGl4ZWxzCiAgICAgIGJhY2tkcm9wUGFkZGluZ1g6IDIsCiAgICAgIGNhbGxiYWNrOiBjb3JlX3RpY2tzLmZvcm1hdHRlcnMubGluZWFyCiAgICB9LAogICAgcG9pbnRMYWJlbHM6IHsKICAgICAgLy8gQm9vbGVhbiAtIGlmIHRydWUsIHNob3cgcG9pbnQgbGFiZWxzCiAgICAgIGRpc3BsYXk6IHRydWUsCiAgICAgIC8vIE51bWJlciAtIFBvaW50IGxhYmVsIGZvbnQgc2l6ZSBpbiBwaXhlbHMKICAgICAgZm9udFNpemU6IDEwLAogICAgICAvLyBGdW5jdGlvbiAtIFVzZWQgdG8gY29udmVydCBwb2ludCBsYWJlbHMKICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uIGNhbGxiYWNrKGxhYmVsKSB7CiAgICAgICAgcmV0dXJuIGxhYmVsOwogICAgICB9CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gZ2V0VGlja0JhY2tkcm9wSGVpZ2h0KG9wdHMpIHsKICAgIHZhciB0aWNrT3B0cyA9IG9wdHMudGlja3M7CgogICAgaWYgKHRpY2tPcHRzLmRpc3BsYXkgJiYgb3B0cy5kaXNwbGF5KSB7CiAgICAgIHJldHVybiB2YWx1ZU9yRGVmYXVsdCRjKHRpY2tPcHRzLmZvbnRTaXplLCBjb3JlX2RlZmF1bHRzLmdsb2JhbC5kZWZhdWx0Rm9udFNpemUpICsgdGlja09wdHMuYmFja2Ryb3BQYWRkaW5nWSAqIDI7CiAgICB9CgogICAgcmV0dXJuIDA7CiAgfQoKICBmdW5jdGlvbiBtZWFzdXJlTGFiZWxTaXplKGN0eCwgbGluZUhlaWdodCwgbGFiZWwpIHsKICAgIGlmIChoZWxwZXJzJDEuaXNBcnJheShsYWJlbCkpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICB3OiBoZWxwZXJzJDEubG9uZ2VzdFRleHQoY3R4LCBjdHguZm9udCwgbGFiZWwpLAogICAgICAgIGg6IGxhYmVsLmxlbmd0aCAqIGxpbmVIZWlnaHQKICAgICAgfTsKICAgIH0KCiAgICByZXR1cm4gewogICAgICB3OiBjdHgubWVhc3VyZVRleHQobGFiZWwpLndpZHRoLAogICAgICBoOiBsaW5lSGVpZ2h0CiAgICB9OwogIH0KCiAgZnVuY3Rpb24gZGV0ZXJtaW5lTGltaXRzKGFuZ2xlLCBwb3MsIHNpemUsIG1pbiwgbWF4KSB7CiAgICBpZiAoYW5nbGUgPT09IG1pbiB8fCBhbmdsZSA9PT0gbWF4KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgc3RhcnQ6IHBvcyAtIHNpemUgLyAyLAogICAgICAgIGVuZDogcG9zICsgc2l6ZSAvIDIKICAgICAgfTsKICAgIH0gZWxzZSBpZiAoYW5nbGUgPCBtaW4gfHwgYW5nbGUgPiBtYXgpIHsKICAgICAgcmV0dXJuIHsKICAgICAgICBzdGFydDogcG9zIC0gc2l6ZSwKICAgICAgICBlbmQ6IHBvcwogICAgICB9OwogICAgfQoKICAgIHJldHVybiB7CiAgICAgIHN0YXJ0OiBwb3MsCiAgICAgIGVuZDogcG9zICsgc2l6ZQogICAgfTsKICB9CiAgLyoqDQogICAqIEhlbHBlciBmdW5jdGlvbiB0byBmaXQgYSByYWRpYWwgbGluZWFyIHNjYWxlIHdpdGggcG9pbnQgbGFiZWxzDQogICAqLwoKCiAgZnVuY3Rpb24gZml0V2l0aFBvaW50TGFiZWxzKHNjYWxlKSB7CiAgICAvLyBSaWdodCwgdGhpcyBpcyByZWFsbHkgY29uZnVzaW5nIGFuZCB0aGVyZSBpcyBhIGxvdCBvZiBtYXRocyBnb2luZyBvbiBoZXJlCiAgICAvLyBUaGUgZ2lzdCBvZiB0aGUgcHJvYmxlbSBpcyBoZXJlOiBodHRwczovL2dpc3QuZ2l0aHViLmNvbS9ubm5pY2svNjk2Y2M5YzU1ZjRiMGJlYjhmZTkKICAgIC8vCiAgICAvLyBSZWFjdGlvbjogaHR0cHM6Ly9kbC5kcm9wYm94dXNlcmNvbnRlbnQuY29tL3UvMzQ2MDEzNjMvdG9vbXVjaHNjaWVuY2UuZ2lmCiAgICAvLwogICAgLy8gU29sdXRpb246CiAgICAvLwogICAgLy8gV2UgYXNzdW1lIHRoZSByYWRpdXMgb2YgdGhlIHBvbHlnb24gaXMgaGFsZiB0aGUgc2l6ZSBvZiB0aGUgY2FudmFzIGF0IGZpcnN0CiAgICAvLyBhdCBlYWNoIGluZGV4IHdlIGNoZWNrIGlmIHRoZSB0ZXh0IG92ZXJsYXBzLgogICAgLy8KICAgIC8vIFdoZXJlIGl0IGRvZXMsIHdlIHN0b3JlIHRoYXQgYW5nbGUgYW5kIHRoYXQgaW5kZXguCiAgICAvLwogICAgLy8gQWZ0ZXIgZmluZGluZyB0aGUgbGFyZ2VzdCBpbmRleCBhbmQgYW5nbGUgd2UgY2FsY3VsYXRlIGhvdyBtdWNoIHdlIG5lZWQgdG8gcmVtb3ZlCiAgICAvLyBmcm9tIHRoZSBzaGFwZSByYWRpdXMgdG8gbW92ZSB0aGUgcG9pbnQgaW53YXJkcyBieSB0aGF0IHguCiAgICAvLwogICAgLy8gV2UgYXZlcmFnZSB0aGUgbGVmdCBhbmQgcmlnaHQgZGlzdGFuY2VzIHRvIGdldCB0aGUgbWF4aW11bSBzaGFwZSByYWRpdXMgdGhhdCBjYW4gZml0IGluIHRoZSBib3gKICAgIC8vIGFsb25nIHdpdGggbGFiZWxzLgogICAgLy8KICAgIC8vIE9uY2Ugd2UgaGF2ZSB0aGF0LCB3ZSBjYW4gZmluZCB0aGUgY2VudHJlIHBvaW50IGZvciB0aGUgY2hhcnQsIGJ5IHRha2luZyB0aGUgeCB0ZXh0IHByb3RydXNpb24KICAgIC8vIG9uIGVhY2ggc2lkZSwgcmVtb3ZpbmcgdGhhdCBmcm9tIHRoZSBzaXplLCBoYWx2aW5nIGl0IGFuZCBhZGRpbmcgdGhlIGxlZnQgeCBwcm90cnVzaW9uIHdpZHRoLgogICAgLy8KICAgIC8vIFRoaXMgd2lsbCBtZWFuIHdlIGhhdmUgYSBzaGFwZSBmaXR0ZWQgdG8gdGhlIGNhbnZhcywgYXMgbGFyZ2UgYXMgaXQgY2FuIGJlIHdpdGggdGhlIGxhYmVscwogICAgLy8gYW5kIHBvc2l0aW9uIGl0IGluIHRoZSBtb3N0IHNwYWNlIGVmZmljaWVudCBtYW5uZXIKICAgIC8vCiAgICAvLyBodHRwczovL2RsLmRyb3Bib3h1c2VyY29udGVudC5jb20vdS8zNDYwMTM2My95ZWFoc2NpZW5jZS5naWYKICAgIHZhciBwbEZvbnQgPSBoZWxwZXJzJDEub3B0aW9ucy5fcGFyc2VGb250KHNjYWxlLm9wdGlvbnMucG9pbnRMYWJlbHMpOyAvLyBHZXQgbWF4aW11bSByYWRpdXMgb2YgdGhlIHBvbHlnb24uIEVpdGhlciBoYWxmIHRoZSBoZWlnaHQgKG1pbnVzIHRoZSB0ZXh0IHdpZHRoKSBvciBoYWxmIHRoZSB3aWR0aC4KICAgIC8vIFVzZSB0aGlzIHRvIGNhbGN1bGF0ZSB0aGUgb2Zmc2V0ICsgY2hhbmdlLiAtIE1ha2Ugc3VyZSBML1IgcHJvdHJ1c2lvbiBpcyBhdCBsZWFzdCAwIHRvIHN0b3AgaXNzdWVzIHdpdGggY2VudHJlIHBvaW50cwoKCiAgICB2YXIgZnVydGhlc3RMaW1pdHMgPSB7CiAgICAgIGw6IDAsCiAgICAgIHI6IHNjYWxlLndpZHRoLAogICAgICB0OiAwLAogICAgICBiOiBzY2FsZS5oZWlnaHQgLSBzY2FsZS5wYWRkaW5nVG9wCiAgICB9OwogICAgdmFyIGZ1cnRoZXN0QW5nbGVzID0ge307CiAgICB2YXIgaSwgdGV4dFNpemUsIHBvaW50UG9zaXRpb247CiAgICBzY2FsZS5jdHguZm9udCA9IHBsRm9udC5zdHJpbmc7CiAgICBzY2FsZS5fcG9pbnRMYWJlbFNpemVzID0gW107CiAgICB2YXIgdmFsdWVDb3VudCA9IHNjYWxlLmNoYXJ0LmRhdGEubGFiZWxzLmxlbmd0aDsKCiAgICBmb3IgKGkgPSAwOyBpIDwgdmFsdWVDb3VudDsgaSsrKSB7CiAgICAgIHBvaW50UG9zaXRpb24gPSBzY2FsZS5nZXRQb2ludFBvc2l0aW9uKGksIHNjYWxlLmRyYXdpbmdBcmVhICsgNSk7CiAgICAgIHRleHRTaXplID0gbWVhc3VyZUxhYmVsU2l6ZShzY2FsZS5jdHgsIHBsRm9udC5saW5lSGVpZ2h0LCBzY2FsZS5wb2ludExhYmVsc1tpXSk7CiAgICAgIHNjYWxlLl9wb2ludExhYmVsU2l6ZXNbaV0gPSB0ZXh0U2l6ZTsgLy8gQWRkIHF1YXJ0ZXIgY2lyY2xlIHRvIG1ha2UgZGVncmVlIDAgbWVhbiB0b3Agb2YgY2lyY2xlCgogICAgICB2YXIgYW5nbGVSYWRpYW5zID0gc2NhbGUuZ2V0SW5kZXhBbmdsZShpKTsKICAgICAgdmFyIGFuZ2xlID0gaGVscGVycyQxLnRvRGVncmVlcyhhbmdsZVJhZGlhbnMpICUgMzYwOwogICAgICB2YXIgaExpbWl0cyA9IGRldGVybWluZUxpbWl0cyhhbmdsZSwgcG9pbnRQb3NpdGlvbi54LCB0ZXh0U2l6ZS53LCAwLCAxODApOwogICAgICB2YXIgdkxpbWl0cyA9IGRldGVybWluZUxpbWl0cyhhbmdsZSwgcG9pbnRQb3NpdGlvbi55LCB0ZXh0U2l6ZS5oLCA5MCwgMjcwKTsKCiAgICAgIGlmIChoTGltaXRzLnN0YXJ0IDwgZnVydGhlc3RMaW1pdHMubCkgewogICAgICAgIGZ1cnRoZXN0TGltaXRzLmwgPSBoTGltaXRzLnN0YXJ0OwogICAgICAgIGZ1cnRoZXN0QW5nbGVzLmwgPSBhbmdsZVJhZGlhbnM7CiAgICAgIH0KCiAgICAgIGlmIChoTGltaXRzLmVuZCA+IGZ1cnRoZXN0TGltaXRzLnIpIHsKICAgICAgICBmdXJ0aGVzdExpbWl0cy5yID0gaExpbWl0cy5lbmQ7CiAgICAgICAgZnVydGhlc3RBbmdsZXMuciA9IGFuZ2xlUmFkaWFuczsKICAgICAgfQoKICAgICAgaWYgKHZMaW1pdHMuc3RhcnQgPCBmdXJ0aGVzdExpbWl0cy50KSB7CiAgICAgICAgZnVydGhlc3RMaW1pdHMudCA9IHZMaW1pdHMuc3RhcnQ7CiAgICAgICAgZnVydGhlc3RBbmdsZXMudCA9IGFuZ2xlUmFkaWFuczsKICAgICAgfQoKICAgICAgaWYgKHZMaW1pdHMuZW5kID4gZnVydGhlc3RMaW1pdHMuYikgewogICAgICAgIGZ1cnRoZXN0TGltaXRzLmIgPSB2TGltaXRzLmVuZDsKICAgICAgICBmdXJ0aGVzdEFuZ2xlcy5iID0gYW5nbGVSYWRpYW5zOwogICAgICB9CiAgICB9CgogICAgc2NhbGUuc2V0UmVkdWN0aW9ucyhzY2FsZS5kcmF3aW5nQXJlYSwgZnVydGhlc3RMaW1pdHMsIGZ1cnRoZXN0QW5nbGVzKTsKICB9CgogIGZ1bmN0aW9uIGdldFRleHRBbGlnbkZvckFuZ2xlKGFuZ2xlKSB7CiAgICBpZiAoYW5nbGUgPT09IDAgfHwgYW5nbGUgPT09IDE4MCkgewogICAgICByZXR1cm4gJ2NlbnRlcic7CiAgICB9IGVsc2UgaWYgKGFuZ2xlIDwgMTgwKSB7CiAgICAgIHJldHVybiAnbGVmdCc7CiAgICB9CgogICAgcmV0dXJuICdyaWdodCc7CiAgfQoKICBmdW5jdGlvbiBmaWxsVGV4dChjdHgsIHRleHQsIHBvc2l0aW9uLCBsaW5lSGVpZ2h0KSB7CiAgICB2YXIgeSA9IHBvc2l0aW9uLnkgKyBsaW5lSGVpZ2h0IC8gMjsKICAgIHZhciBpLCBpbGVuOwoKICAgIGlmIChoZWxwZXJzJDEuaXNBcnJheSh0ZXh0KSkgewogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gdGV4dC5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBjdHguZmlsbFRleHQodGV4dFtpXSwgcG9zaXRpb24ueCwgeSk7CiAgICAgICAgeSArPSBsaW5lSGVpZ2h0OwogICAgICB9CiAgICB9IGVsc2UgewogICAgICBjdHguZmlsbFRleHQodGV4dCwgcG9zaXRpb24ueCwgeSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhZGp1c3RQb2ludFBvc2l0aW9uRm9yTGFiZWxIZWlnaHQoYW5nbGUsIHRleHRTaXplLCBwb3NpdGlvbikgewogICAgaWYgKGFuZ2xlID09PSA5MCB8fCBhbmdsZSA9PT0gMjcwKSB7CiAgICAgIHBvc2l0aW9uLnkgLT0gdGV4dFNpemUuaCAvIDI7CiAgICB9IGVsc2UgaWYgKGFuZ2xlID4gMjcwIHx8IGFuZ2xlIDwgOTApIHsKICAgICAgcG9zaXRpb24ueSAtPSB0ZXh0U2l6ZS5oOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZHJhd1BvaW50TGFiZWxzKHNjYWxlKSB7CiAgICB2YXIgY3R4ID0gc2NhbGUuY3R4OwogICAgdmFyIG9wdHMgPSBzY2FsZS5vcHRpb25zOwogICAgdmFyIHBvaW50TGFiZWxPcHRzID0gb3B0cy5wb2ludExhYmVsczsKICAgIHZhciB0aWNrQmFja2Ryb3BIZWlnaHQgPSBnZXRUaWNrQmFja2Ryb3BIZWlnaHQob3B0cyk7CiAgICB2YXIgb3V0ZXJEaXN0YW5jZSA9IHNjYWxlLmdldERpc3RhbmNlRnJvbUNlbnRlckZvclZhbHVlKG9wdHMudGlja3MucmV2ZXJzZSA/IHNjYWxlLm1pbiA6IHNjYWxlLm1heCk7CgogICAgdmFyIHBsRm9udCA9IGhlbHBlcnMkMS5vcHRpb25zLl9wYXJzZUZvbnQocG9pbnRMYWJlbE9wdHMpOwoKICAgIGN0eC5zYXZlKCk7CiAgICBjdHguZm9udCA9IHBsRm9udC5zdHJpbmc7CiAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CgogICAgZm9yICh2YXIgaSA9IHNjYWxlLmNoYXJ0LmRhdGEubGFiZWxzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICAgIC8vIEV4dHJhIHBpeGVscyBvdXQgZm9yIHNvbWUgbGFiZWwgc3BhY2luZwogICAgICB2YXIgZXh0cmEgPSBpID09PSAwID8gdGlja0JhY2tkcm9wSGVpZ2h0IC8gMiA6IDA7CiAgICAgIHZhciBwb2ludExhYmVsUG9zaXRpb24gPSBzY2FsZS5nZXRQb2ludFBvc2l0aW9uKGksIG91dGVyRGlzdGFuY2UgKyBleHRyYSArIDUpOyAvLyBLZWVwIHRoaXMgaW4gbG9vcCBzaW5jZSB3ZSBtYXkgc3VwcG9ydCBhcnJheSBwcm9wZXJ0aWVzIGhlcmUKCiAgICAgIHZhciBwb2ludExhYmVsRm9udENvbG9yID0gdmFsdWVBdEluZGV4T3JEZWZhdWx0JDEocG9pbnRMYWJlbE9wdHMuZm9udENvbG9yLCBpLCBjb3JlX2RlZmF1bHRzLmdsb2JhbC5kZWZhdWx0Rm9udENvbG9yKTsKICAgICAgY3R4LmZpbGxTdHlsZSA9IHBvaW50TGFiZWxGb250Q29sb3I7CiAgICAgIHZhciBhbmdsZVJhZGlhbnMgPSBzY2FsZS5nZXRJbmRleEFuZ2xlKGkpOwogICAgICB2YXIgYW5nbGUgPSBoZWxwZXJzJDEudG9EZWdyZWVzKGFuZ2xlUmFkaWFucyk7CiAgICAgIGN0eC50ZXh0QWxpZ24gPSBnZXRUZXh0QWxpZ25Gb3JBbmdsZShhbmdsZSk7CiAgICAgIGFkanVzdFBvaW50UG9zaXRpb25Gb3JMYWJlbEhlaWdodChhbmdsZSwgc2NhbGUuX3BvaW50TGFiZWxTaXplc1tpXSwgcG9pbnRMYWJlbFBvc2l0aW9uKTsKICAgICAgZmlsbFRleHQoY3R4LCBzY2FsZS5wb2ludExhYmVsc1tpXSwgcG9pbnRMYWJlbFBvc2l0aW9uLCBwbEZvbnQubGluZUhlaWdodCk7CiAgICB9CgogICAgY3R4LnJlc3RvcmUoKTsKICB9CgogIGZ1bmN0aW9uIGRyYXdSYWRpdXNMaW5lKHNjYWxlLCBncmlkTGluZU9wdHMsIHJhZGl1cywgaW5kZXgpIHsKICAgIHZhciBjdHggPSBzY2FsZS5jdHg7CiAgICB2YXIgY2lyY3VsYXIgPSBncmlkTGluZU9wdHMuY2lyY3VsYXI7CiAgICB2YXIgdmFsdWVDb3VudCA9IHNjYWxlLmNoYXJ0LmRhdGEubGFiZWxzLmxlbmd0aDsKICAgIHZhciBsaW5lQ29sb3IgPSB2YWx1ZUF0SW5kZXhPckRlZmF1bHQkMShncmlkTGluZU9wdHMuY29sb3IsIGluZGV4IC0gMSk7CiAgICB2YXIgbGluZVdpZHRoID0gdmFsdWVBdEluZGV4T3JEZWZhdWx0JDEoZ3JpZExpbmVPcHRzLmxpbmVXaWR0aCwgaW5kZXggLSAxKTsKICAgIHZhciBwb2ludFBvc2l0aW9uOwoKICAgIGlmICghY2lyY3VsYXIgJiYgIXZhbHVlQ291bnQgfHwgIWxpbmVDb2xvciB8fCAhbGluZVdpZHRoKSB7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBjdHguc2F2ZSgpOwogICAgY3R4LnN0cm9rZVN0eWxlID0gbGluZUNvbG9yOwogICAgY3R4LmxpbmVXaWR0aCA9IGxpbmVXaWR0aDsKCiAgICBpZiAoY3R4LnNldExpbmVEYXNoKSB7CiAgICAgIGN0eC5zZXRMaW5lRGFzaChncmlkTGluZU9wdHMuYm9yZGVyRGFzaCB8fCBbXSk7CiAgICAgIGN0eC5saW5lRGFzaE9mZnNldCA9IGdyaWRMaW5lT3B0cy5ib3JkZXJEYXNoT2Zmc2V0IHx8IDAuMDsKICAgIH0KCiAgICBjdHguYmVnaW5QYXRoKCk7CgogICAgaWYgKGNpcmN1bGFyKSB7CiAgICAgIC8vIERyYXcgY2lyY3VsYXIgYXJjcyBiZXR3ZWVuIHRoZSBwb2ludHMKICAgICAgY3R4LmFyYyhzY2FsZS54Q2VudGVyLCBzY2FsZS55Q2VudGVyLCByYWRpdXMsIDAsIE1hdGguUEkgKiAyKTsKICAgIH0gZWxzZSB7CiAgICAgIC8vIERyYXcgc3RyYWlnaHQgbGluZXMgY29ubmVjdGluZyBlYWNoIGluZGV4CiAgICAgIHBvaW50UG9zaXRpb24gPSBzY2FsZS5nZXRQb2ludFBvc2l0aW9uKDAsIHJhZGl1cyk7CiAgICAgIGN0eC5tb3ZlVG8ocG9pbnRQb3NpdGlvbi54LCBwb2ludFBvc2l0aW9uLnkpOwoKICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCB2YWx1ZUNvdW50OyBpKyspIHsKICAgICAgICBwb2ludFBvc2l0aW9uID0gc2NhbGUuZ2V0UG9pbnRQb3NpdGlvbihpLCByYWRpdXMpOwogICAgICAgIGN0eC5saW5lVG8ocG9pbnRQb3NpdGlvbi54LCBwb2ludFBvc2l0aW9uLnkpOwogICAgICB9CiAgICB9CgogICAgY3R4LmNsb3NlUGF0aCgpOwogICAgY3R4LnN0cm9rZSgpOwogICAgY3R4LnJlc3RvcmUoKTsKICB9CgogIGZ1bmN0aW9uIG51bWJlck9yWmVybyhwYXJhbSkgewogICAgcmV0dXJuIGhlbHBlcnMkMS5pc051bWJlcihwYXJhbSkgPyBwYXJhbSA6IDA7CiAgfQoKICB2YXIgc2NhbGVfcmFkaWFsTGluZWFyID0gc2NhbGVfbGluZWFyYmFzZS5leHRlbmQoewogICAgc2V0RGltZW5zaW9uczogZnVuY3Rpb24gc2V0RGltZW5zaW9ucygpIHsKICAgICAgdmFyIG1lID0gdGhpczsgLy8gU2V0IHRoZSB1bmNvbnN0cmFpbmVkIGRpbWVuc2lvbiBiZWZvcmUgbGFiZWwgcm90YXRpb24KCiAgICAgIG1lLndpZHRoID0gbWUubWF4V2lkdGg7CiAgICAgIG1lLmhlaWdodCA9IG1lLm1heEhlaWdodDsKICAgICAgbWUucGFkZGluZ1RvcCA9IGdldFRpY2tCYWNrZHJvcEhlaWdodChtZS5vcHRpb25zKSAvIDI7CiAgICAgIG1lLnhDZW50ZXIgPSBNYXRoLmZsb29yKG1lLndpZHRoIC8gMik7CiAgICAgIG1lLnlDZW50ZXIgPSBNYXRoLmZsb29yKChtZS5oZWlnaHQgLSBtZS5wYWRkaW5nVG9wKSAvIDIpOwogICAgICBtZS5kcmF3aW5nQXJlYSA9IE1hdGgubWluKG1lLmhlaWdodCAtIG1lLnBhZGRpbmdUb3AsIG1lLndpZHRoKSAvIDI7CiAgICB9LAogICAgZGV0ZXJtaW5lRGF0YUxpbWl0czogZnVuY3Rpb24gZGV0ZXJtaW5lRGF0YUxpbWl0cygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGNoYXJ0ID0gbWUuY2hhcnQ7CiAgICAgIHZhciBtaW4gPSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgIHZhciBtYXggPSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFk7CiAgICAgIGhlbHBlcnMkMS5lYWNoKGNoYXJ0LmRhdGEuZGF0YXNldHMsIGZ1bmN0aW9uIChkYXRhc2V0LCBkYXRhc2V0SW5kZXgpIHsKICAgICAgICBpZiAoY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShkYXRhc2V0SW5kZXgpKSB7CiAgICAgICAgICB2YXIgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCk7CiAgICAgICAgICBoZWxwZXJzJDEuZWFjaChkYXRhc2V0LmRhdGEsIGZ1bmN0aW9uIChyYXdWYWx1ZSwgaW5kZXgpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gK21lLmdldFJpZ2h0VmFsdWUocmF3VmFsdWUpOwoKICAgICAgICAgICAgaWYgKGlzTmFOKHZhbHVlKSB8fCBtZXRhLmRhdGFbaW5kZXhdLmhpZGRlbikgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgbWluID0gTWF0aC5taW4odmFsdWUsIG1pbik7CiAgICAgICAgICAgIG1heCA9IE1hdGgubWF4KHZhbHVlLCBtYXgpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgbWUubWluID0gbWluID09PSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkgPyAwIDogbWluOwogICAgICBtZS5tYXggPSBtYXggPT09IE51bWJlci5ORUdBVElWRV9JTkZJTklUWSA/IDAgOiBtYXg7IC8vIENvbW1vbiBiYXNlIGltcGxlbWVudGF0aW9uIHRvIGhhbmRsZSB0aWNrcy5taW4sIHRpY2tzLm1heCwgdGlja3MuYmVnaW5BdFplcm8KCiAgICAgIG1lLmhhbmRsZVRpY2tSYW5nZU9wdGlvbnMoKTsKICAgIH0sCiAgICAvLyBSZXR1cm5zIHRoZSBtYXhpbXVtIG51bWJlciBvZiB0aWNrcyBiYXNlZCBvbiB0aGUgc2NhbGUgZGltZW5zaW9uCiAgICBfY29tcHV0ZVRpY2tMaW1pdDogZnVuY3Rpb24gX2NvbXB1dGVUaWNrTGltaXQoKSB7CiAgICAgIHJldHVybiBNYXRoLmNlaWwodGhpcy5kcmF3aW5nQXJlYSAvIGdldFRpY2tCYWNrZHJvcEhlaWdodCh0aGlzLm9wdGlvbnMpKTsKICAgIH0sCiAgICBjb252ZXJ0VGlja3NUb0xhYmVsczogZnVuY3Rpb24gY29udmVydFRpY2tzVG9MYWJlbHMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHNjYWxlX2xpbmVhcmJhc2UucHJvdG90eXBlLmNvbnZlcnRUaWNrc1RvTGFiZWxzLmNhbGwobWUpOyAvLyBQb2ludCBsYWJlbHMKCiAgICAgIG1lLnBvaW50TGFiZWxzID0gbWUuY2hhcnQuZGF0YS5sYWJlbHMubWFwKGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbGFiZWwgPSBoZWxwZXJzJDEuY2FsbGJhY2sobWUub3B0aW9ucy5wb2ludExhYmVscy5jYWxsYmFjaywgYXJndW1lbnRzLCBtZSk7CiAgICAgICAgcmV0dXJuIGxhYmVsIHx8IGxhYmVsID09PSAwID8gbGFiZWwgOiAnJzsKICAgICAgfSk7CiAgICB9LAogICAgZ2V0TGFiZWxGb3JJbmRleDogZnVuY3Rpb24gZ2V0TGFiZWxGb3JJbmRleChpbmRleCwgZGF0YXNldEluZGV4KSB7CiAgICAgIHJldHVybiArdGhpcy5nZXRSaWdodFZhbHVlKHRoaXMuY2hhcnQuZGF0YS5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLmRhdGFbaW5kZXhdKTsKICAgIH0sCiAgICBmaXQ6IGZ1bmN0aW9uIGZpdCgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9wdHMgPSBtZS5vcHRpb25zOwoKICAgICAgaWYgKG9wdHMuZGlzcGxheSAmJiBvcHRzLnBvaW50TGFiZWxzLmRpc3BsYXkpIHsKICAgICAgICBmaXRXaXRoUG9pbnRMYWJlbHMobWUpOwogICAgICB9IGVsc2UgewogICAgICAgIG1lLnNldENlbnRlclBvaW50KDAsIDAsIDAsIDApOwogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIFNldCByYWRpdXMgcmVkdWN0aW9ucyBhbmQgZGV0ZXJtaW5lIG5ldyByYWRpdXMgYW5kIGNlbnRlciBwb2ludA0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBzZXRSZWR1Y3Rpb25zOiBmdW5jdGlvbiBzZXRSZWR1Y3Rpb25zKGxhcmdlc3RQb3NzaWJsZVJhZGl1cywgZnVydGhlc3RMaW1pdHMsIGZ1cnRoZXN0QW5nbGVzKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciByYWRpdXNSZWR1Y3Rpb25MZWZ0ID0gZnVydGhlc3RMaW1pdHMubCAvIE1hdGguc2luKGZ1cnRoZXN0QW5nbGVzLmwpOwogICAgICB2YXIgcmFkaXVzUmVkdWN0aW9uUmlnaHQgPSBNYXRoLm1heChmdXJ0aGVzdExpbWl0cy5yIC0gbWUud2lkdGgsIDApIC8gTWF0aC5zaW4oZnVydGhlc3RBbmdsZXMucik7CiAgICAgIHZhciByYWRpdXNSZWR1Y3Rpb25Ub3AgPSAtZnVydGhlc3RMaW1pdHMudCAvIE1hdGguY29zKGZ1cnRoZXN0QW5nbGVzLnQpOwogICAgICB2YXIgcmFkaXVzUmVkdWN0aW9uQm90dG9tID0gLU1hdGgubWF4KGZ1cnRoZXN0TGltaXRzLmIgLSAobWUuaGVpZ2h0IC0gbWUucGFkZGluZ1RvcCksIDApIC8gTWF0aC5jb3MoZnVydGhlc3RBbmdsZXMuYik7CiAgICAgIHJhZGl1c1JlZHVjdGlvbkxlZnQgPSBudW1iZXJPclplcm8ocmFkaXVzUmVkdWN0aW9uTGVmdCk7CiAgICAgIHJhZGl1c1JlZHVjdGlvblJpZ2h0ID0gbnVtYmVyT3JaZXJvKHJhZGl1c1JlZHVjdGlvblJpZ2h0KTsKICAgICAgcmFkaXVzUmVkdWN0aW9uVG9wID0gbnVtYmVyT3JaZXJvKHJhZGl1c1JlZHVjdGlvblRvcCk7CiAgICAgIHJhZGl1c1JlZHVjdGlvbkJvdHRvbSA9IG51bWJlck9yWmVybyhyYWRpdXNSZWR1Y3Rpb25Cb3R0b20pOwogICAgICBtZS5kcmF3aW5nQXJlYSA9IE1hdGgubWluKE1hdGguZmxvb3IobGFyZ2VzdFBvc3NpYmxlUmFkaXVzIC0gKHJhZGl1c1JlZHVjdGlvbkxlZnQgKyByYWRpdXNSZWR1Y3Rpb25SaWdodCkgLyAyKSwgTWF0aC5mbG9vcihsYXJnZXN0UG9zc2libGVSYWRpdXMgLSAocmFkaXVzUmVkdWN0aW9uVG9wICsgcmFkaXVzUmVkdWN0aW9uQm90dG9tKSAvIDIpKTsKICAgICAgbWUuc2V0Q2VudGVyUG9pbnQocmFkaXVzUmVkdWN0aW9uTGVmdCwgcmFkaXVzUmVkdWN0aW9uUmlnaHQsIHJhZGl1c1JlZHVjdGlvblRvcCwgcmFkaXVzUmVkdWN0aW9uQm90dG9tKTsKICAgIH0sCiAgICBzZXRDZW50ZXJQb2ludDogZnVuY3Rpb24gc2V0Q2VudGVyUG9pbnQobGVmdE1vdmVtZW50LCByaWdodE1vdmVtZW50LCB0b3BNb3ZlbWVudCwgYm90dG9tTW92ZW1lbnQpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG1heFJpZ2h0ID0gbWUud2lkdGggLSByaWdodE1vdmVtZW50IC0gbWUuZHJhd2luZ0FyZWE7CiAgICAgIHZhciBtYXhMZWZ0ID0gbGVmdE1vdmVtZW50ICsgbWUuZHJhd2luZ0FyZWE7CiAgICAgIHZhciBtYXhUb3AgPSB0b3BNb3ZlbWVudCArIG1lLmRyYXdpbmdBcmVhOwogICAgICB2YXIgbWF4Qm90dG9tID0gbWUuaGVpZ2h0IC0gbWUucGFkZGluZ1RvcCAtIGJvdHRvbU1vdmVtZW50IC0gbWUuZHJhd2luZ0FyZWE7CiAgICAgIG1lLnhDZW50ZXIgPSBNYXRoLmZsb29yKChtYXhMZWZ0ICsgbWF4UmlnaHQpIC8gMiArIG1lLmxlZnQpOwogICAgICBtZS55Q2VudGVyID0gTWF0aC5mbG9vcigobWF4VG9wICsgbWF4Qm90dG9tKSAvIDIgKyBtZS50b3AgKyBtZS5wYWRkaW5nVG9wKTsKICAgIH0sCiAgICBnZXRJbmRleEFuZ2xlOiBmdW5jdGlvbiBnZXRJbmRleEFuZ2xlKGluZGV4KSB7CiAgICAgIHZhciBjaGFydCA9IHRoaXMuY2hhcnQ7CiAgICAgIHZhciBhbmdsZU11bHRpcGxpZXIgPSAzNjAgLyBjaGFydC5kYXRhLmxhYmVscy5sZW5ndGg7CiAgICAgIHZhciBvcHRpb25zID0gY2hhcnQub3B0aW9ucyB8fCB7fTsKICAgICAgdmFyIHN0YXJ0QW5nbGUgPSBvcHRpb25zLnN0YXJ0QW5nbGUgfHwgMDsgLy8gU3RhcnQgZnJvbSB0aGUgdG9wIGluc3RlYWQgb2YgcmlnaHQsIHNvIHJlbW92ZSBhIHF1YXJ0ZXIgb2YgdGhlIGNpcmNsZQoKICAgICAgdmFyIGFuZ2xlID0gKGluZGV4ICogYW5nbGVNdWx0aXBsaWVyICsgc3RhcnRBbmdsZSkgJSAzNjA7CiAgICAgIHJldHVybiAoYW5nbGUgPCAwID8gYW5nbGUgKyAzNjAgOiBhbmdsZSkgKiBNYXRoLlBJICogMiAvIDM2MDsKICAgIH0sCiAgICBnZXREaXN0YW5jZUZyb21DZW50ZXJGb3JWYWx1ZTogZnVuY3Rpb24gZ2V0RGlzdGFuY2VGcm9tQ2VudGVyRm9yVmFsdWUodmFsdWUpIHsKICAgICAgdmFyIG1lID0gdGhpczsKCiAgICAgIGlmIChoZWxwZXJzJDEuaXNOdWxsT3JVbmRlZih2YWx1ZSkpIHsKICAgICAgICByZXR1cm4gTmFOOwogICAgICB9IC8vIFRha2UgaW50byBhY2NvdW50IGhhbGYgZm9udCBzaXplICsgdGhlIHlQYWRkaW5nIG9mIHRoZSB0b3AgdmFsdWUKCgogICAgICB2YXIgc2NhbGluZ0ZhY3RvciA9IG1lLmRyYXdpbmdBcmVhIC8gKG1lLm1heCAtIG1lLm1pbik7CgogICAgICBpZiAobWUub3B0aW9ucy50aWNrcy5yZXZlcnNlKSB7CiAgICAgICAgcmV0dXJuIChtZS5tYXggLSB2YWx1ZSkgKiBzY2FsaW5nRmFjdG9yOwogICAgICB9CgogICAgICByZXR1cm4gKHZhbHVlIC0gbWUubWluKSAqIHNjYWxpbmdGYWN0b3I7CiAgICB9LAogICAgZ2V0UG9pbnRQb3NpdGlvbjogZnVuY3Rpb24gZ2V0UG9pbnRQb3NpdGlvbihpbmRleCwgZGlzdGFuY2VGcm9tQ2VudGVyKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciB0aGlzQW5nbGUgPSBtZS5nZXRJbmRleEFuZ2xlKGluZGV4KSAtIE1hdGguUEkgLyAyOwogICAgICByZXR1cm4gewogICAgICAgIHg6IE1hdGguY29zKHRoaXNBbmdsZSkgKiBkaXN0YW5jZUZyb21DZW50ZXIgKyBtZS54Q2VudGVyLAogICAgICAgIHk6IE1hdGguc2luKHRoaXNBbmdsZSkgKiBkaXN0YW5jZUZyb21DZW50ZXIgKyBtZS55Q2VudGVyCiAgICAgIH07CiAgICB9LAogICAgZ2V0UG9pbnRQb3NpdGlvbkZvclZhbHVlOiBmdW5jdGlvbiBnZXRQb2ludFBvc2l0aW9uRm9yVmFsdWUoaW5kZXgsIHZhbHVlKSB7CiAgICAgIHJldHVybiB0aGlzLmdldFBvaW50UG9zaXRpb24oaW5kZXgsIHRoaXMuZ2V0RGlzdGFuY2VGcm9tQ2VudGVyRm9yVmFsdWUodmFsdWUpKTsKICAgIH0sCiAgICBnZXRCYXNlUG9zaXRpb246IGZ1bmN0aW9uIGdldEJhc2VQb3NpdGlvbihpbmRleCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgbWluID0gbWUubWluOwogICAgICB2YXIgbWF4ID0gbWUubWF4OwogICAgICByZXR1cm4gbWUuZ2V0UG9pbnRQb3NpdGlvbkZvclZhbHVlKGluZGV4IHx8IDAsIG1lLmJlZ2luQXRaZXJvID8gMCA6IG1pbiA8IDAgJiYgbWF4IDwgMCA/IG1heCA6IG1pbiA+IDAgJiYgbWF4ID4gMCA/IG1pbiA6IDApOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2RyYXdHcmlkOiBmdW5jdGlvbiBfZHJhd0dyaWQoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBjdHggPSBtZS5jdHg7CiAgICAgIHZhciBvcHRzID0gbWUub3B0aW9uczsKICAgICAgdmFyIGdyaWRMaW5lT3B0cyA9IG9wdHMuZ3JpZExpbmVzOwogICAgICB2YXIgYW5nbGVMaW5lT3B0cyA9IG9wdHMuYW5nbGVMaW5lczsKICAgICAgdmFyIGxpbmVXaWR0aCA9IHZhbHVlT3JEZWZhdWx0JGMoYW5nbGVMaW5lT3B0cy5saW5lV2lkdGgsIGdyaWRMaW5lT3B0cy5saW5lV2lkdGgpOwogICAgICB2YXIgbGluZUNvbG9yID0gdmFsdWVPckRlZmF1bHQkYyhhbmdsZUxpbmVPcHRzLmNvbG9yLCBncmlkTGluZU9wdHMuY29sb3IpOwogICAgICB2YXIgaSwgb2Zmc2V0LCBwb3NpdGlvbjsKCiAgICAgIGlmIChvcHRzLnBvaW50TGFiZWxzLmRpc3BsYXkpIHsKICAgICAgICBkcmF3UG9pbnRMYWJlbHMobWUpOwogICAgICB9CgogICAgICBpZiAoZ3JpZExpbmVPcHRzLmRpc3BsYXkpIHsKICAgICAgICBoZWxwZXJzJDEuZWFjaChtZS50aWNrcywgZnVuY3Rpb24gKGxhYmVsLCBpbmRleCkgewogICAgICAgICAgaWYgKGluZGV4ICE9PSAwKSB7CiAgICAgICAgICAgIG9mZnNldCA9IG1lLmdldERpc3RhbmNlRnJvbUNlbnRlckZvclZhbHVlKG1lLnRpY2tzQXNOdW1iZXJzW2luZGV4XSk7CiAgICAgICAgICAgIGRyYXdSYWRpdXNMaW5lKG1lLCBncmlkTGluZU9wdHMsIG9mZnNldCwgaW5kZXgpOwogICAgICAgICAgfQogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAoYW5nbGVMaW5lT3B0cy5kaXNwbGF5ICYmIGxpbmVXaWR0aCAmJiBsaW5lQ29sb3IpIHsKICAgICAgICBjdHguc2F2ZSgpOwogICAgICAgIGN0eC5saW5lV2lkdGggPSBsaW5lV2lkdGg7CiAgICAgICAgY3R4LnN0cm9rZVN0eWxlID0gbGluZUNvbG9yOwoKICAgICAgICBpZiAoY3R4LnNldExpbmVEYXNoKSB7CiAgICAgICAgICBjdHguc2V0TGluZURhc2gocmVzb2x2ZSQ0KFthbmdsZUxpbmVPcHRzLmJvcmRlckRhc2gsIGdyaWRMaW5lT3B0cy5ib3JkZXJEYXNoLCBbXV0pKTsKICAgICAgICAgIGN0eC5saW5lRGFzaE9mZnNldCA9IHJlc29sdmUkNChbYW5nbGVMaW5lT3B0cy5ib3JkZXJEYXNoT2Zmc2V0LCBncmlkTGluZU9wdHMuYm9yZGVyRGFzaE9mZnNldCwgMC4wXSk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKGkgPSBtZS5jaGFydC5kYXRhLmxhYmVscy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgICAgb2Zmc2V0ID0gbWUuZ2V0RGlzdGFuY2VGcm9tQ2VudGVyRm9yVmFsdWUob3B0cy50aWNrcy5yZXZlcnNlID8gbWUubWluIDogbWUubWF4KTsKICAgICAgICAgIHBvc2l0aW9uID0gbWUuZ2V0UG9pbnRQb3NpdGlvbihpLCBvZmZzZXQpOwogICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgY3R4Lm1vdmVUbyhtZS54Q2VudGVyLCBtZS55Q2VudGVyKTsKICAgICAgICAgIGN0eC5saW5lVG8ocG9zaXRpb24ueCwgcG9zaXRpb24ueSk7CiAgICAgICAgICBjdHguc3Ryb2tlKCk7CiAgICAgICAgfQoKICAgICAgICBjdHgucmVzdG9yZSgpOwogICAgICB9CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZHJhd0xhYmVsczogZnVuY3Rpb24gX2RyYXdMYWJlbHMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBjdHggPSBtZS5jdHg7CiAgICAgIHZhciBvcHRzID0gbWUub3B0aW9uczsKICAgICAgdmFyIHRpY2tPcHRzID0gb3B0cy50aWNrczsKCiAgICAgIGlmICghdGlja09wdHMuZGlzcGxheSkgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHN0YXJ0QW5nbGUgPSBtZS5nZXRJbmRleEFuZ2xlKDApOwoKICAgICAgdmFyIHRpY2tGb250ID0gaGVscGVycyQxLm9wdGlvbnMuX3BhcnNlRm9udCh0aWNrT3B0cyk7CgogICAgICB2YXIgdGlja0ZvbnRDb2xvciA9IHZhbHVlT3JEZWZhdWx0JGModGlja09wdHMuZm9udENvbG9yLCBjb3JlX2RlZmF1bHRzLmdsb2JhbC5kZWZhdWx0Rm9udENvbG9yKTsKICAgICAgdmFyIG9mZnNldCwgd2lkdGg7CiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC5mb250ID0gdGlja0ZvbnQuc3RyaW5nOwogICAgICBjdHgudHJhbnNsYXRlKG1lLnhDZW50ZXIsIG1lLnlDZW50ZXIpOwogICAgICBjdHgucm90YXRlKHN0YXJ0QW5nbGUpOwogICAgICBjdHgudGV4dEFsaWduID0gJ2NlbnRlcic7CiAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAnbWlkZGxlJzsKICAgICAgaGVscGVycyQxLmVhY2gobWUudGlja3MsIGZ1bmN0aW9uIChsYWJlbCwgaW5kZXgpIHsKICAgICAgICBpZiAoaW5kZXggPT09IDAgJiYgIXRpY2tPcHRzLnJldmVyc2UpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIG9mZnNldCA9IG1lLmdldERpc3RhbmNlRnJvbUNlbnRlckZvclZhbHVlKG1lLnRpY2tzQXNOdW1iZXJzW2luZGV4XSk7CgogICAgICAgIGlmICh0aWNrT3B0cy5zaG93TGFiZWxCYWNrZHJvcCkgewogICAgICAgICAgd2lkdGggPSBjdHgubWVhc3VyZVRleHQobGFiZWwpLndpZHRoOwogICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IHRpY2tPcHRzLmJhY2tkcm9wQ29sb3I7CiAgICAgICAgICBjdHguZmlsbFJlY3QoLXdpZHRoIC8gMiAtIHRpY2tPcHRzLmJhY2tkcm9wUGFkZGluZ1gsIC1vZmZzZXQgLSB0aWNrRm9udC5zaXplIC8gMiAtIHRpY2tPcHRzLmJhY2tkcm9wUGFkZGluZ1ksIHdpZHRoICsgdGlja09wdHMuYmFja2Ryb3BQYWRkaW5nWCAqIDIsIHRpY2tGb250LnNpemUgKyB0aWNrT3B0cy5iYWNrZHJvcFBhZGRpbmdZICogMik7CiAgICAgICAgfQoKICAgICAgICBjdHguZmlsbFN0eWxlID0gdGlja0ZvbnRDb2xvcjsKICAgICAgICBjdHguZmlsbFRleHQobGFiZWwsIDAsIC1vZmZzZXQpOwogICAgICB9KTsKICAgICAgY3R4LnJlc3RvcmUoKTsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9kcmF3VGl0bGU6IGhlbHBlcnMkMS5ub29wCiAgfSk7IC8vIElOVEVSTkFMOiBzdGF0aWMgZGVmYXVsdCBvcHRpb25zLCByZWdpc3RlcmVkIGluIHNyYy9pbmRleC5qcwoKICB2YXIgX2RlZmF1bHRzJDMgPSBkZWZhdWx0Q29uZmlnJDM7CiAgc2NhbGVfcmFkaWFsTGluZWFyLl9kZWZhdWx0cyA9IF9kZWZhdWx0cyQzOwogIHZhciBkZXByZWNhdGVkJDEgPSBoZWxwZXJzJDEuX2RlcHJlY2F0ZWQ7CiAgdmFyIHJlc29sdmUkNSA9IGhlbHBlcnMkMS5vcHRpb25zLnJlc29sdmU7CiAgdmFyIHZhbHVlT3JEZWZhdWx0JGQgPSBoZWxwZXJzJDEudmFsdWVPckRlZmF1bHQ7IC8vIEludGVnZXIgY29uc3RhbnRzIGFyZSBmcm9tIHRoZSBFUzYgc3BlYy4KCiAgdmFyIE1JTl9JTlRFR0VSID0gTnVtYmVyLk1JTl9TQUZFX0lOVEVHRVIgfHwgLTkwMDcxOTkyNTQ3NDA5OTE7CiAgdmFyIE1BWF9JTlRFR0VSID0gTnVtYmVyLk1BWF9TQUZFX0lOVEVHRVIgfHwgOTAwNzE5OTI1NDc0MDk5MTsKICB2YXIgSU5URVJWQUxTID0gewogICAgbWlsbGlzZWNvbmQ6IHsKICAgICAgY29tbW9uOiB0cnVlLAogICAgICBzaXplOiAxLAogICAgICBzdGVwczogMTAwMAogICAgfSwKICAgIHNlY29uZDogewogICAgICBjb21tb246IHRydWUsCiAgICAgIHNpemU6IDEwMDAsCiAgICAgIHN0ZXBzOiA2MAogICAgfSwKICAgIG1pbnV0ZTogewogICAgICBjb21tb246IHRydWUsCiAgICAgIHNpemU6IDYwMDAwLAogICAgICBzdGVwczogNjAKICAgIH0sCiAgICBob3VyOiB7CiAgICAgIGNvbW1vbjogdHJ1ZSwKICAgICAgc2l6ZTogMzYwMDAwMCwKICAgICAgc3RlcHM6IDI0CiAgICB9LAogICAgZGF5OiB7CiAgICAgIGNvbW1vbjogdHJ1ZSwKICAgICAgc2l6ZTogODY0MDAwMDAsCiAgICAgIHN0ZXBzOiAzMAogICAgfSwKICAgIHdlZWs6IHsKICAgICAgY29tbW9uOiBmYWxzZSwKICAgICAgc2l6ZTogNjA0ODAwMDAwLAogICAgICBzdGVwczogNAogICAgfSwKICAgIG1vbnRoOiB7CiAgICAgIGNvbW1vbjogdHJ1ZSwKICAgICAgc2l6ZTogMi42MjhlOSwKICAgICAgc3RlcHM6IDEyCiAgICB9LAogICAgcXVhcnRlcjogewogICAgICBjb21tb246IGZhbHNlLAogICAgICBzaXplOiA3Ljg4NGU5LAogICAgICBzdGVwczogNAogICAgfSwKICAgIHllYXI6IHsKICAgICAgY29tbW9uOiB0cnVlLAogICAgICBzaXplOiAzLjE1NGUxMAogICAgfQogIH07CiAgdmFyIFVOSVRTID0gT2JqZWN0LmtleXMoSU5URVJWQUxTKTsKCiAgZnVuY3Rpb24gc29ydGVyKGEsIGIpIHsKICAgIHJldHVybiBhIC0gYjsKICB9CgogIGZ1bmN0aW9uIGFycmF5VW5pcXVlKGl0ZW1zKSB7CiAgICB2YXIgaGFzaCA9IHt9OwogICAgdmFyIG91dCA9IFtdOwogICAgdmFyIGksIGlsZW4sIGl0ZW07CgogICAgZm9yIChpID0gMCwgaWxlbiA9IGl0ZW1zLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewogICAgICBpdGVtID0gaXRlbXNbaV07CgogICAgICBpZiAoIWhhc2hbaXRlbV0pIHsKICAgICAgICBoYXNoW2l0ZW1dID0gdHJ1ZTsKICAgICAgICBvdXQucHVzaChpdGVtKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBvdXQ7CiAgfQoKICBmdW5jdGlvbiBnZXRNaW4ob3B0aW9ucykgewogICAgcmV0dXJuIGhlbHBlcnMkMS52YWx1ZU9yRGVmYXVsdChvcHRpb25zLnRpbWUubWluLCBvcHRpb25zLnRpY2tzLm1pbik7CiAgfQoKICBmdW5jdGlvbiBnZXRNYXgob3B0aW9ucykgewogICAgcmV0dXJuIGhlbHBlcnMkMS52YWx1ZU9yRGVmYXVsdChvcHRpb25zLnRpbWUubWF4LCBvcHRpb25zLnRpY2tzLm1heCk7CiAgfQogIC8qKg0KICAgKiBSZXR1cm5zIGFuIGFycmF5IG9mIHt0aW1lLCBwb3N9IG9iamVjdHMgdXNlZCB0byBpbnRlcnBvbGF0ZSBhIHNwZWNpZmljIGB0aW1lYCBvciBwb3NpdGlvbg0KICAgKiAoYHBvc2ApIG9uIHRoZSBzY2FsZSwgYnkgc2VhcmNoaW5nIGVudHJpZXMgYmVmb3JlIGFuZCBhZnRlciB0aGUgcmVxdWVzdGVkIHZhbHVlLiBgcG9zYCBpcw0KICAgKiBhIGRlY2ltYWwgYmV0d2VlbiAwIGFuZCAxOiAwIGJlaW5nIHRoZSBzdGFydCBvZiB0aGUgc2NhbGUgKGxlZnQgb3IgdG9wKSBhbmQgMSB0aGUgb3RoZXINCiAgICogZXh0cmVtaXR5IChsZWZ0ICsgd2lkdGggb3IgdG9wICsgaGVpZ2h0KS4gTm90ZSB0aGF0IGl0IHdvdWxkIGJlIG1vcmUgb3B0aW1pemVkIHRvIGRpcmVjdGx5DQogICAqIHN0b3JlIHByZS1jb21wdXRlZCBwaXhlbHMsIGJ1dCB0aGUgc2NhbGUgZGltZW5zaW9ucyBhcmUgbm90IGd1YXJhbnRlZWQgYXQgdGhlIHRpbWUgd2UgbmVlZA0KICAgKiB0byBjcmVhdGUgdGhlIGxvb2t1cCB0YWJsZS4gVGhlIHRhYmxlIEFMV0FZUyBjb250YWlucyBhdCBsZWFzdCB0d28gaXRlbXM6IG1pbiBhbmQgbWF4Lg0KICAgKg0KICAgKiBAcGFyYW0ge251bWJlcltdfSB0aW1lc3RhbXBzIC0gdGltZXN0YW1wcyBzb3J0ZWQgZnJvbSBsb3dlc3QgdG8gaGlnaGVzdC4NCiAgICogQHBhcmFtIHtzdHJpbmd9IGRpc3RyaWJ1dGlvbiAtIElmICdsaW5lYXInLCB0aW1lc3RhbXBzIHdpbGwgYmUgc3ByZWFkIGxpbmVhcmx5IGFsb25nIHRoZSBtaW4NCiAgICogYW5kIG1heCByYW5nZSwgc28gYmFzaWNhbGx5LCB0aGUgdGFibGUgd2lsbCBjb250YWlucyBvbmx5IHR3byBpdGVtczoge21pbiwgMH0gYW5kIHttYXgsIDF9Lg0KICAgKiBJZiAnc2VyaWVzJywgdGltZXN0YW1wcyB3aWxsIGJlIHBvc2l0aW9uZWQgYXQgdGhlIHNhbWUgZGlzdGFuY2UgZnJvbSBlYWNoIG90aGVyLiBJbiB0aGlzDQogICAqIGNhc2UsIG9ubHkgdGltZXN0YW1wcyB0aGF0IGJyZWFrIHRoZSB0aW1lIGxpbmVhcml0eSBhcmUgcmVnaXN0ZXJlZCwgbWVhbmluZyB0aGF0IGluIHRoZQ0KICAgKiBiZXN0IGNhc2UsIGFsbCB0aW1lc3RhbXBzIGFyZSBsaW5lYXIsIHRoZSB0YWJsZSBjb250YWlucyBvbmx5IG1pbiBhbmQgbWF4Lg0KICAgKi8KCgogIGZ1bmN0aW9uIGJ1aWxkTG9va3VwVGFibGUodGltZXN0YW1wcywgbWluLCBtYXgsIGRpc3RyaWJ1dGlvbikgewogICAgaWYgKGRpc3RyaWJ1dGlvbiA9PT0gJ2xpbmVhcicgfHwgIXRpbWVzdGFtcHMubGVuZ3RoKSB7CiAgICAgIHJldHVybiBbewogICAgICAgIHRpbWU6IG1pbiwKICAgICAgICBwb3M6IDAKICAgICAgfSwgewogICAgICAgIHRpbWU6IG1heCwKICAgICAgICBwb3M6IDEKICAgICAgfV07CiAgICB9CgogICAgdmFyIHRhYmxlID0gW107CiAgICB2YXIgaXRlbXMgPSBbbWluXTsKICAgIHZhciBpLCBpbGVuLCBwcmV2LCBjdXJyLCBuZXh0OwoKICAgIGZvciAoaSA9IDAsIGlsZW4gPSB0aW1lc3RhbXBzLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewogICAgICBjdXJyID0gdGltZXN0YW1wc1tpXTsKCiAgICAgIGlmIChjdXJyID4gbWluICYmIGN1cnIgPCBtYXgpIHsKICAgICAgICBpdGVtcy5wdXNoKGN1cnIpOwogICAgICB9CiAgICB9CgogICAgaXRlbXMucHVzaChtYXgpOwoKICAgIGZvciAoaSA9IDAsIGlsZW4gPSBpdGVtcy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgbmV4dCA9IGl0ZW1zW2kgKyAxXTsKICAgICAgcHJldiA9IGl0ZW1zW2kgLSAxXTsKICAgICAgY3VyciA9IGl0ZW1zW2ldOyAvLyBvbmx5IGFkZCBwb2ludHMgdGhhdCBicmVha3MgdGhlIHNjYWxlIGxpbmVhcml0eQoKICAgICAgaWYgKHByZXYgPT09IHVuZGVmaW5lZCB8fCBuZXh0ID09PSB1bmRlZmluZWQgfHwgTWF0aC5yb3VuZCgobmV4dCArIHByZXYpIC8gMikgIT09IGN1cnIpIHsKICAgICAgICB0YWJsZS5wdXNoKHsKICAgICAgICAgIHRpbWU6IGN1cnIsCiAgICAgICAgICBwb3M6IGkgLyAoaWxlbiAtIDEpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGFibGU7CiAgfSAvLyBAc2VlIGFkYXB0ZWQgZnJvbSBodHRwczovL3d3dy5hbnVqZ2FraGFyLmNvbS8yMDE0LzAzLzAxL2JpbmFyeS1zZWFyY2gtaW4tamF2YXNjcmlwdC8KCgogIGZ1bmN0aW9uIGxvb2t1cCh0YWJsZSwga2V5LCB2YWx1ZSkgewogICAgdmFyIGxvID0gMDsKICAgIHZhciBoaSA9IHRhYmxlLmxlbmd0aCAtIDE7CiAgICB2YXIgbWlkLCBpMCwgaTE7CgogICAgd2hpbGUgKGxvID49IDAgJiYgbG8gPD0gaGkpIHsKICAgICAgbWlkID0gbG8gKyBoaSA+PiAxOwogICAgICBpMCA9IHRhYmxlW21pZCAtIDFdIHx8IG51bGw7CiAgICAgIGkxID0gdGFibGVbbWlkXTsKCiAgICAgIGlmICghaTApIHsKICAgICAgICAvLyBnaXZlbiB2YWx1ZSBpcyBvdXRzaWRlIHRhYmxlIChiZWZvcmUgZmlyc3QgaXRlbSkKICAgICAgICByZXR1cm4gewogICAgICAgICAgbG86IG51bGwsCiAgICAgICAgICBoaTogaTEKICAgICAgICB9OwogICAgICB9IGVsc2UgaWYgKGkxW2tleV0gPCB2YWx1ZSkgewogICAgICAgIGxvID0gbWlkICsgMTsKICAgICAgfSBlbHNlIGlmIChpMFtrZXldID4gdmFsdWUpIHsKICAgICAgICBoaSA9IG1pZCAtIDE7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgIGxvOiBpMCwKICAgICAgICAgIGhpOiBpMQogICAgICAgIH07CiAgICAgIH0KICAgIH0gLy8gZ2l2ZW4gdmFsdWUgaXMgb3V0c2lkZSB0YWJsZSAoYWZ0ZXIgbGFzdCBpdGVtKQoKCiAgICByZXR1cm4gewogICAgICBsbzogaTEsCiAgICAgIGhpOiBudWxsCiAgICB9OwogIH0KICAvKioNCiAgICogTGluZWFybHkgaW50ZXJwb2xhdGVzIHRoZSBnaXZlbiBzb3VyY2UgYHZhbHVlYCB1c2luZyB0aGUgdGFibGUgaXRlbXMgYHNrZXlgIHZhbHVlcyBhbmQNCiAgICogcmV0dXJucyB0aGUgYXNzb2NpYXRlZCBgdGtleWAgdmFsdWUuIEZvciBleGFtcGxlLCBpbnRlcnBvbGF0ZSh0YWJsZSwgJ3RpbWUnLCA0MiwgJ3BvcycpDQogICAqIHJldHVybnMgdGhlIHBvc2l0aW9uIGZvciBhIHRpbWVzdGFtcCBlcXVhbCB0byA0Mi4gSWYgdmFsdWUgaXMgb3V0IG9mIGJvdW5kcywgdmFsdWVzIGF0DQogICAqIGluZGV4IFswLCAxXSBvciBbbiAtIDEsIG5dIGFyZSB1c2VkIGZvciB0aGUgaW50ZXJwb2xhdGlvbi4NCiAgICovCgoKICBmdW5jdGlvbiBpbnRlcnBvbGF0ZSQxKHRhYmxlLCBza2V5LCBzdmFsLCB0a2V5KSB7CiAgICB2YXIgcmFuZ2UgPSBsb29rdXAodGFibGUsIHNrZXksIHN2YWwpOyAvLyBOb3RlOiB0aGUgbG9va3VwIHRhYmxlIEFMV0FZUyBjb250YWlucyBhdCBsZWFzdCAyIGl0ZW1zIChtaW4gYW5kIG1heCkKCiAgICB2YXIgcHJldiA9ICFyYW5nZS5sbyA/IHRhYmxlWzBdIDogIXJhbmdlLmhpID8gdGFibGVbdGFibGUubGVuZ3RoIC0gMl0gOiByYW5nZS5sbzsKICAgIHZhciBuZXh0ID0gIXJhbmdlLmxvID8gdGFibGVbMV0gOiAhcmFuZ2UuaGkgPyB0YWJsZVt0YWJsZS5sZW5ndGggLSAxXSA6IHJhbmdlLmhpOwogICAgdmFyIHNwYW4gPSBuZXh0W3NrZXldIC0gcHJldltza2V5XTsKICAgIHZhciByYXRpbyA9IHNwYW4gPyAoc3ZhbCAtIHByZXZbc2tleV0pIC8gc3BhbiA6IDA7CiAgICB2YXIgb2Zmc2V0ID0gKG5leHRbdGtleV0gLSBwcmV2W3RrZXldKSAqIHJhdGlvOwogICAgcmV0dXJuIHByZXZbdGtleV0gKyBvZmZzZXQ7CiAgfQoKICBmdW5jdGlvbiB0b1RpbWVzdGFtcChzY2FsZSwgaW5wdXQpIHsKICAgIHZhciBhZGFwdGVyID0gc2NhbGUuX2FkYXB0ZXI7CiAgICB2YXIgb3B0aW9ucyA9IHNjYWxlLm9wdGlvbnMudGltZTsKICAgIHZhciBwYXJzZXIgPSBvcHRpb25zLnBhcnNlcjsKICAgIHZhciBmb3JtYXQgPSBwYXJzZXIgfHwgb3B0aW9ucy5mb3JtYXQ7CiAgICB2YXIgdmFsdWUgPSBpbnB1dDsKCiAgICBpZiAodHlwZW9mIHBhcnNlciA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB2YWx1ZSA9IHBhcnNlcih2YWx1ZSk7CiAgICB9IC8vIE9ubHkgcGFyc2UgaWYgaXRzIG5vdCBhIHRpbWVzdGFtcCBhbHJlYWR5CgoKICAgIGlmICghaGVscGVycyQxLmlzRmluaXRlKHZhbHVlKSkgewogICAgICB2YWx1ZSA9IHR5cGVvZiBmb3JtYXQgPT09ICdzdHJpbmcnID8gYWRhcHRlci5wYXJzZSh2YWx1ZSwgZm9ybWF0KSA6IGFkYXB0ZXIucGFyc2UodmFsdWUpOwogICAgfQoKICAgIGlmICh2YWx1ZSAhPT0gbnVsbCkgewogICAgICByZXR1cm4gK3ZhbHVlOwogICAgfSAvLyBMYWJlbHMgYXJlIGluIGFuIGluY29tcGF0aWJsZSBmb3JtYXQgYW5kIG5vIGBwYXJzZXJgIGhhcyBiZWVuIHByb3ZpZGVkLgogICAgLy8gVGhlIHVzZXIgbWlnaHQgc3RpbGwgdXNlIHRoZSBkZXByZWNhdGVkIGBmb3JtYXRgIG9wdGlvbiBmb3IgcGFyc2luZy4KCgogICAgaWYgKCFwYXJzZXIgJiYgdHlwZW9mIGZvcm1hdCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB2YWx1ZSA9IGZvcm1hdChpbnB1dCk7IC8vIGBmb3JtYXRgIGNvdWxkIHJldHVybiBzb21ldGhpbmcgZWxzZSB0aGFuIGEgdGltZXN0YW1wLCBpZiBzbywgcGFyc2UgaXQKCiAgICAgIGlmICghaGVscGVycyQxLmlzRmluaXRlKHZhbHVlKSkgewogICAgICAgIHZhbHVlID0gYWRhcHRlci5wYXJzZSh2YWx1ZSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdmFsdWU7CiAgfQoKICBmdW5jdGlvbiBwYXJzZShzY2FsZSwgaW5wdXQpIHsKICAgIGlmIChoZWxwZXJzJDEuaXNOdWxsT3JVbmRlZihpbnB1dCkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgdmFyIG9wdGlvbnMgPSBzY2FsZS5vcHRpb25zLnRpbWU7CiAgICB2YXIgdmFsdWUgPSB0b1RpbWVzdGFtcChzY2FsZSwgc2NhbGUuZ2V0UmlnaHRWYWx1ZShpbnB1dCkpOwoKICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICByZXR1cm4gdmFsdWU7CiAgICB9CgogICAgaWYgKG9wdGlvbnMucm91bmQpIHsKICAgICAgdmFsdWUgPSArc2NhbGUuX2FkYXB0ZXIuc3RhcnRPZih2YWx1ZSwgb3B0aW9ucy5yb3VuZCk7CiAgICB9CgogICAgcmV0dXJuIHZhbHVlOwogIH0KICAvKioNCiAgICogRmlndXJlcyBvdXQgd2hhdCB1bml0IHJlc3VsdHMgaW4gYW4gYXBwcm9wcmlhdGUgbnVtYmVyIG9mIGF1dG8tZ2VuZXJhdGVkIHRpY2tzDQogICAqLwoKCiAgZnVuY3Rpb24gZGV0ZXJtaW5lVW5pdEZvckF1dG9UaWNrcyhtaW5Vbml0LCBtaW4sIG1heCwgY2FwYWNpdHkpIHsKICAgIHZhciBpbGVuID0gVU5JVFMubGVuZ3RoOwogICAgdmFyIGksIGludGVydmFsLCBmYWN0b3I7CgogICAgZm9yIChpID0gVU5JVFMuaW5kZXhPZihtaW5Vbml0KTsgaSA8IGlsZW4gLSAxOyArK2kpIHsKICAgICAgaW50ZXJ2YWwgPSBJTlRFUlZBTFNbVU5JVFNbaV1dOwogICAgICBmYWN0b3IgPSBpbnRlcnZhbC5zdGVwcyA/IGludGVydmFsLnN0ZXBzIDogTUFYX0lOVEVHRVI7CgogICAgICBpZiAoaW50ZXJ2YWwuY29tbW9uICYmIE1hdGguY2VpbCgobWF4IC0gbWluKSAvIChmYWN0b3IgKiBpbnRlcnZhbC5zaXplKSkgPD0gY2FwYWNpdHkpIHsKICAgICAgICByZXR1cm4gVU5JVFNbaV07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gVU5JVFNbaWxlbiAtIDFdOwogIH0KICAvKioNCiAgICogRmlndXJlcyBvdXQgd2hhdCB1bml0IHRvIGZvcm1hdCBhIHNldCBvZiB0aWNrcyB3aXRoDQogICAqLwoKCiAgZnVuY3Rpb24gZGV0ZXJtaW5lVW5pdEZvckZvcm1hdHRpbmcoc2NhbGUsIG51bVRpY2tzLCBtaW5Vbml0LCBtaW4sIG1heCkgewogICAgdmFyIGksIHVuaXQ7CgogICAgZm9yIChpID0gVU5JVFMubGVuZ3RoIC0gMTsgaSA+PSBVTklUUy5pbmRleE9mKG1pblVuaXQpOyBpLS0pIHsKICAgICAgdW5pdCA9IFVOSVRTW2ldOwoKICAgICAgaWYgKElOVEVSVkFMU1t1bml0XS5jb21tb24gJiYgc2NhbGUuX2FkYXB0ZXIuZGlmZihtYXgsIG1pbiwgdW5pdCkgPj0gbnVtVGlja3MgLSAxKSB7CiAgICAgICAgcmV0dXJuIHVuaXQ7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gVU5JVFNbbWluVW5pdCA/IFVOSVRTLmluZGV4T2YobWluVW5pdCkgOiAwXTsKICB9CgogIGZ1bmN0aW9uIGRldGVybWluZU1ham9yVW5pdCh1bml0KSB7CiAgICBmb3IgKHZhciBpID0gVU5JVFMuaW5kZXhPZih1bml0KSArIDEsIGlsZW4gPSBVTklUUy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgaWYgKElOVEVSVkFMU1tVTklUU1tpXV0uY29tbW9uKSB7CiAgICAgICAgcmV0dXJuIFVOSVRTW2ldOwogICAgICB9CiAgICB9CiAgfQogIC8qKg0KICAgKiBHZW5lcmF0ZXMgYSBtYXhpbXVtIG9mIGBjYXBhY2l0eWAgdGltZXN0YW1wcyBiZXR3ZWVuIG1pbiBhbmQgbWF4LCByb3VuZGVkIHRvIHRoZQ0KICAgKiBgbWlub3JgIHVuaXQgdXNpbmcgdGhlIGdpdmVuIHNjYWxlIHRpbWUgYG9wdGlvbnNgLg0KICAgKiBJbXBvcnRhbnQ6IHRoaXMgbWV0aG9kIGNhbiByZXR1cm4gdGlja3Mgb3V0c2lkZSB0aGUgbWluIGFuZCBtYXggcmFuZ2UsIGl0J3MgdGhlDQogICAqIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBjYWxsaW5nIGNvZGUgdG8gY2xhbXAgdmFsdWVzIGlmIG5lZWRlZC4NCiAgICovCgoKICBmdW5jdGlvbiBnZW5lcmF0ZShzY2FsZSwgbWluLCBtYXgsIGNhcGFjaXR5KSB7CiAgICB2YXIgYWRhcHRlciA9IHNjYWxlLl9hZGFwdGVyOwogICAgdmFyIG9wdGlvbnMgPSBzY2FsZS5vcHRpb25zOwogICAgdmFyIHRpbWVPcHRzID0gb3B0aW9ucy50aW1lOwogICAgdmFyIG1pbm9yID0gdGltZU9wdHMudW5pdCB8fCBkZXRlcm1pbmVVbml0Rm9yQXV0b1RpY2tzKHRpbWVPcHRzLm1pblVuaXQsIG1pbiwgbWF4LCBjYXBhY2l0eSk7CiAgICB2YXIgc3RlcFNpemUgPSByZXNvbHZlJDUoW3RpbWVPcHRzLnN0ZXBTaXplLCB0aW1lT3B0cy51bml0U3RlcFNpemUsIDFdKTsKICAgIHZhciB3ZWVrZGF5ID0gbWlub3IgPT09ICd3ZWVrJyA/IHRpbWVPcHRzLmlzb1dlZWtkYXkgOiBmYWxzZTsKICAgIHZhciBmaXJzdCA9IG1pbjsKICAgIHZhciB0aWNrcyA9IFtdOwogICAgdmFyIHRpbWU7IC8vIEZvciAnd2VlaycgdW5pdCwgaGFuZGxlIHRoZSBmaXJzdCBkYXkgb2Ygd2VlayBvcHRpb24KCiAgICBpZiAod2Vla2RheSkgewogICAgICBmaXJzdCA9ICthZGFwdGVyLnN0YXJ0T2YoZmlyc3QsICdpc29XZWVrJywgd2Vla2RheSk7CiAgICB9IC8vIEFsaWduIGZpcnN0IHRpY2tzIG9uIHVuaXQKCgogICAgZmlyc3QgPSArYWRhcHRlci5zdGFydE9mKGZpcnN0LCB3ZWVrZGF5ID8gJ2RheScgOiBtaW5vcik7IC8vIFByZXZlbnQgYnJvd3NlciBmcm9tIGZyZWV6aW5nIGluIGNhc2UgdXNlciBvcHRpb25zIHJlcXVlc3QgbWlsbGlvbnMgb2YgbWlsbGlzZWNvbmRzCgogICAgaWYgKGFkYXB0ZXIuZGlmZihtYXgsIG1pbiwgbWlub3IpID4gMTAwMDAwICogc3RlcFNpemUpIHsKICAgICAgdGhyb3cgbWluICsgJyBhbmQgJyArIG1heCArICcgYXJlIHRvbyBmYXIgYXBhcnQgd2l0aCBzdGVwU2l6ZSBvZiAnICsgc3RlcFNpemUgKyAnICcgKyBtaW5vcjsKICAgIH0KCiAgICBmb3IgKHRpbWUgPSBmaXJzdDsgdGltZSA8IG1heDsgdGltZSA9ICthZGFwdGVyLmFkZCh0aW1lLCBzdGVwU2l6ZSwgbWlub3IpKSB7CiAgICAgIHRpY2tzLnB1c2godGltZSk7CiAgICB9CgogICAgaWYgKHRpbWUgPT09IG1heCB8fCBvcHRpb25zLmJvdW5kcyA9PT0gJ3RpY2tzJykgewogICAgICB0aWNrcy5wdXNoKHRpbWUpOwogICAgfQoKICAgIHJldHVybiB0aWNrczsKICB9CiAgLyoqDQogICAqIFJldHVybnMgdGhlIHN0YXJ0IGFuZCBlbmQgb2Zmc2V0cyBmcm9tIGVkZ2VzIGluIHRoZSBmb3JtIG9mIHtzdGFydCwgZW5kfQ0KICAgKiB3aGVyZSBlYWNoIHZhbHVlIGlzIGEgcmVsYXRpdmUgd2lkdGggdG8gdGhlIHNjYWxlIGFuZCByYW5nZXMgYmV0d2VlbiAwIGFuZCAxLg0KICAgKiBUaGV5IGFkZCBleHRyYSBtYXJnaW5zIG9uIHRoZSBib3RoIHNpZGVzIGJ5IHNjYWxpbmcgZG93biB0aGUgb3JpZ2luYWwgc2NhbGUuDQogICAqIE9mZnNldHMgYXJlIGFkZGVkIHdoZW4gdGhlIGBvZmZzZXRgIG9wdGlvbiBpcyB0cnVlLg0KICAgKi8KCgogIGZ1bmN0aW9uIGNvbXB1dGVPZmZzZXRzKHRhYmxlLCB0aWNrcywgbWluLCBtYXgsIG9wdGlvbnMpIHsKICAgIHZhciBzdGFydCA9IDA7CiAgICB2YXIgZW5kID0gMDsKICAgIHZhciBmaXJzdCwgbGFzdDsKCiAgICBpZiAob3B0aW9ucy5vZmZzZXQgJiYgdGlja3MubGVuZ3RoKSB7CiAgICAgIGZpcnN0ID0gaW50ZXJwb2xhdGUkMSh0YWJsZSwgJ3RpbWUnLCB0aWNrc1swXSwgJ3BvcycpOwoKICAgICAgaWYgKHRpY2tzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHN0YXJ0ID0gMSAtIGZpcnN0OwogICAgICB9IGVsc2UgewogICAgICAgIHN0YXJ0ID0gKGludGVycG9sYXRlJDEodGFibGUsICd0aW1lJywgdGlja3NbMV0sICdwb3MnKSAtIGZpcnN0KSAvIDI7CiAgICAgIH0KCiAgICAgIGxhc3QgPSBpbnRlcnBvbGF0ZSQxKHRhYmxlLCAndGltZScsIHRpY2tzW3RpY2tzLmxlbmd0aCAtIDFdLCAncG9zJyk7CgogICAgICBpZiAodGlja3MubGVuZ3RoID09PSAxKSB7CiAgICAgICAgZW5kID0gbGFzdDsKICAgICAgfSBlbHNlIHsKICAgICAgICBlbmQgPSAobGFzdCAtIGludGVycG9sYXRlJDEodGFibGUsICd0aW1lJywgdGlja3NbdGlja3MubGVuZ3RoIC0gMl0sICdwb3MnKSkgLyAyOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHsKICAgICAgc3RhcnQ6IHN0YXJ0LAogICAgICBlbmQ6IGVuZCwKICAgICAgZmFjdG9yOiAxIC8gKHN0YXJ0ICsgMSArIGVuZCkKICAgIH07CiAgfQoKICBmdW5jdGlvbiBzZXRNYWpvclRpY2tzKHNjYWxlLCB0aWNrcywgbWFwLCBtYWpvclVuaXQpIHsKICAgIHZhciBhZGFwdGVyID0gc2NhbGUuX2FkYXB0ZXI7CiAgICB2YXIgZmlyc3QgPSArYWRhcHRlci5zdGFydE9mKHRpY2tzWzBdLnZhbHVlLCBtYWpvclVuaXQpOwogICAgdmFyIGxhc3QgPSB0aWNrc1t0aWNrcy5sZW5ndGggLSAxXS52YWx1ZTsKICAgIHZhciBtYWpvciwgaW5kZXg7CgogICAgZm9yIChtYWpvciA9IGZpcnN0OyBtYWpvciA8PSBsYXN0OyBtYWpvciA9ICthZGFwdGVyLmFkZChtYWpvciwgMSwgbWFqb3JVbml0KSkgewogICAgICBpbmRleCA9IG1hcFttYWpvcl07CgogICAgICBpZiAoaW5kZXggPj0gMCkgewogICAgICAgIHRpY2tzW2luZGV4XS5tYWpvciA9IHRydWU7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGlja3M7CiAgfQoKICBmdW5jdGlvbiB0aWNrc0Zyb21UaW1lc3RhbXBzKHNjYWxlLCB2YWx1ZXMsIG1ham9yVW5pdCkgewogICAgdmFyIHRpY2tzID0gW107CiAgICB2YXIgbWFwID0ge307CiAgICB2YXIgaWxlbiA9IHZhbHVlcy5sZW5ndGg7CiAgICB2YXIgaSwgdmFsdWU7CgogICAgZm9yIChpID0gMDsgaSA8IGlsZW47ICsraSkgewogICAgICB2YWx1ZSA9IHZhbHVlc1tpXTsKICAgICAgbWFwW3ZhbHVlXSA9IGk7CiAgICAgIHRpY2tzLnB1c2goewogICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICBtYWpvcjogZmFsc2UKICAgICAgfSk7CiAgICB9IC8vIFdlIHNldCB0aGUgbWFqb3IgdGlja3Mgc2VwYXJhdGVseSBmcm9tIHRoZSBhYm92ZSBsb29wIGJlY2F1c2UgY2FsbGluZyBzdGFydE9mIGZvciBldmVyeSB0aWNrCiAgICAvLyBpcyBleHBlbnNpdmUgd2hlbiB0aGVyZSBpcyBhIGxhcmdlIG51bWJlciBvZiB0aWNrcwoKCiAgICByZXR1cm4gaWxlbiA9PT0gMCB8fCAhbWFqb3JVbml0ID8gdGlja3MgOiBzZXRNYWpvclRpY2tzKHNjYWxlLCB0aWNrcywgbWFwLCBtYWpvclVuaXQpOwogIH0KCiAgdmFyIGRlZmF1bHRDb25maWckNCA9IHsKICAgIHBvc2l0aW9uOiAnYm90dG9tJywKCiAgICAvKioNCiAgICAgKiBEYXRhIGRpc3RyaWJ1dGlvbiBhbG9uZyB0aGUgc2NhbGU6DQogICAgICogLSAnbGluZWFyJzogZGF0YSBhcmUgc3ByZWFkIGFjY29yZGluZyB0byB0aGVpciB0aW1lIChkaXN0YW5jZXMgY2FuIHZhcnkpLA0KICAgICAqIC0gJ3Nlcmllcyc6IGRhdGEgYXJlIHNwcmVhZCBhdCB0aGUgc2FtZSBkaXN0YW5jZSBmcm9tIGVhY2ggb3RoZXIuDQogICAgICogQHNlZSBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9wdWxsLzQ1MDcNCiAgICAgKiBAc2luY2UgMi43LjANCiAgICAgKi8KICAgIGRpc3RyaWJ1dGlvbjogJ2xpbmVhcicsCgogICAgLyoqDQogICAgICogU2NhbGUgYm91bmRhcnkgc3RyYXRlZ3kgKGJ5cGFzc2VkIGJ5IG1pbi9tYXggdGltZSBvcHRpb25zKQ0KICAgICAqIC0gYGRhdGFgOiBtYWtlIHN1cmUgZGF0YSBhcmUgZnVsbHkgdmlzaWJsZSwgdGlja3Mgb3V0c2lkZSBhcmUgcmVtb3ZlZA0KICAgICAqIC0gYHRpY2tzYDogbWFrZSBzdXJlIHRpY2tzIGFyZSBmdWxseSB2aXNpYmxlLCBkYXRhIG91dHNpZGUgYXJlIHRydW5jYXRlZA0KICAgICAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2NoYXJ0anMvQ2hhcnQuanMvcHVsbC80NTU2DQogICAgICogQHNpbmNlIDIuNy4wDQogICAgICovCiAgICBib3VuZHM6ICdkYXRhJywKICAgIGFkYXB0ZXJzOiB7fSwKICAgIHRpbWU6IHsKICAgICAgcGFyc2VyOiBmYWxzZSwKICAgICAgLy8gZmFsc2UgPT0gYSBwYXR0ZXJuIHN0cmluZyBmcm9tIGh0dHBzOi8vbW9tZW50anMuY29tL2RvY3MvIy9wYXJzaW5nL3N0cmluZy1mb3JtYXQvIG9yIGEgY3VzdG9tIGNhbGxiYWNrIHRoYXQgY29udmVydHMgaXRzIGFyZ3VtZW50IHRvIGEgbW9tZW50CiAgICAgIHVuaXQ6IGZhbHNlLAogICAgICAvLyBmYWxzZSA9PSBhdXRvbWF0aWMgb3Igb3ZlcnJpZGUgd2l0aCB3ZWVrLCBtb250aCwgeWVhciwgZXRjLgogICAgICByb3VuZDogZmFsc2UsCiAgICAgIC8vIG5vbmUsIG9yIG92ZXJyaWRlIHdpdGggd2VlaywgbW9udGgsIHllYXIsIGV0Yy4KICAgICAgZGlzcGxheUZvcm1hdDogZmFsc2UsCiAgICAgIC8vIERFUFJFQ0FURUQKICAgICAgaXNvV2Vla2RheTogZmFsc2UsCiAgICAgIC8vIG92ZXJyaWRlIHdlZWsgc3RhcnQgZGF5IC0gc2VlIGh0dHBzOi8vbW9tZW50anMuY29tL2RvY3MvIy9nZXQtc2V0L2lzby13ZWVrZGF5LwogICAgICBtaW5Vbml0OiAnbWlsbGlzZWNvbmQnLAogICAgICBkaXNwbGF5Rm9ybWF0czoge30KICAgIH0sCiAgICB0aWNrczogewogICAgICBhdXRvU2tpcDogZmFsc2UsCgogICAgICAvKioNCiAgICAgICAqIFRpY2tzIGdlbmVyYXRpb24gaW5wdXQgdmFsdWVzOg0KICAgICAgICogLSAnYXV0byc6IGdlbmVyYXRlcyAib3B0aW1hbCIgdGlja3MgYmFzZWQgb24gc2NhbGUgc2l6ZSBhbmQgdGltZSBvcHRpb25zLg0KICAgICAgICogLSAnZGF0YSc6IGdlbmVyYXRlcyB0aWNrcyBmcm9tIGRhdGEgKGluY2x1ZGluZyBsYWJlbHMgZnJvbSBkYXRhIHt0fHh8eX0gb2JqZWN0cykuDQogICAgICAgKiAtICdsYWJlbHMnOiBnZW5lcmF0ZXMgdGlja3MgZnJvbSB1c2VyIGdpdmVuIGBkYXRhLmxhYmVsc2AgdmFsdWVzIE9OTFkuDQogICAgICAgKiBAc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL3B1bGwvNDUwNw0KICAgICAgICogQHNpbmNlIDIuNy4wDQogICAgICAgKi8KICAgICAgc291cmNlOiAnYXV0bycsCiAgICAgIG1ham9yOiB7CiAgICAgICAgZW5hYmxlZDogZmFsc2UKICAgICAgfQogICAgfQogIH07CiAgdmFyIHNjYWxlX3RpbWUgPSBjb3JlX3NjYWxlLmV4dGVuZCh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiBpbml0aWFsaXplKCkgewogICAgICB0aGlzLm1lcmdlVGlja3NPcHRpb25zKCk7CiAgICAgIGNvcmVfc2NhbGUucHJvdG90eXBlLmluaXRpYWxpemUuY2FsbCh0aGlzKTsKICAgIH0sCiAgICB1cGRhdGU6IGZ1bmN0aW9uIHVwZGF0ZSgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9wdGlvbnMgPSBtZS5vcHRpb25zOwogICAgICB2YXIgdGltZSA9IG9wdGlvbnMudGltZSB8fCAob3B0aW9ucy50aW1lID0ge30pOwogICAgICB2YXIgYWRhcHRlciA9IG1lLl9hZGFwdGVyID0gbmV3IGNvcmVfYWRhcHRlcnMuX2RhdGUob3B0aW9ucy5hZGFwdGVycy5kYXRlKTsgLy8gREVQUkVDQVRJT05TOiBvdXRwdXQgYSBtZXNzYWdlIG9ubHkgb25lIHRpbWUgcGVyIHVwZGF0ZQoKICAgICAgZGVwcmVjYXRlZCQxKCd0aW1lIHNjYWxlJywgdGltZS5mb3JtYXQsICd0aW1lLmZvcm1hdCcsICd0aW1lLnBhcnNlcicpOwogICAgICBkZXByZWNhdGVkJDEoJ3RpbWUgc2NhbGUnLCB0aW1lLm1pbiwgJ3RpbWUubWluJywgJ3RpY2tzLm1pbicpOwogICAgICBkZXByZWNhdGVkJDEoJ3RpbWUgc2NhbGUnLCB0aW1lLm1heCwgJ3RpbWUubWF4JywgJ3RpY2tzLm1heCcpOyAvLyBCYWNrd2FyZCBjb21wYXRpYmlsaXR5OiBiZWZvcmUgaW50cm9kdWNpbmcgYWRhcHRlciwgYGRpc3BsYXlGb3JtYXRzYCB3YXMKICAgICAgLy8gc3VwcG9zZWQgdG8gY29udGFpbiAqYWxsKiB1bml0L3N0cmluZyBwYWlycyBidXQgdGhpcyBjYW4ndCBiZSByZXNvbHZlZAogICAgICAvLyB3aGVuIGxvYWRpbmcgdGhlIHNjYWxlIChhZGFwdGVycyBhcmUgbG9hZGVkIGFmdGVyd2FyZCksIHNvIGxldCdzIHBvcHVsYXRlCiAgICAgIC8vIG1pc3NpbmcgZm9ybWF0cyBvbiB1cGRhdGUKCiAgICAgIGhlbHBlcnMkMS5tZXJnZUlmKHRpbWUuZGlzcGxheUZvcm1hdHMsIGFkYXB0ZXIuZm9ybWF0cygpKTsKICAgICAgcmV0dXJuIGNvcmVfc2NhbGUucHJvdG90eXBlLnVwZGF0ZS5hcHBseShtZSwgYXJndW1lbnRzKTsKICAgIH0sCgogICAgLyoqDQogICAgICogQWxsb3dzIGRhdGEgdG8gYmUgcmVmZXJlbmNlZCB2aWEgJ3QnIGF0dHJpYnV0ZQ0KICAgICAqLwogICAgZ2V0UmlnaHRWYWx1ZTogZnVuY3Rpb24gZ2V0UmlnaHRWYWx1ZShyYXdWYWx1ZSkgewogICAgICBpZiAocmF3VmFsdWUgJiYgcmF3VmFsdWUudCAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgcmF3VmFsdWUgPSByYXdWYWx1ZS50OwogICAgICB9CgogICAgICByZXR1cm4gY29yZV9zY2FsZS5wcm90b3R5cGUuZ2V0UmlnaHRWYWx1ZS5jYWxsKHRoaXMsIHJhd1ZhbHVlKTsKICAgIH0sCiAgICBkZXRlcm1pbmVEYXRhTGltaXRzOiBmdW5jdGlvbiBkZXRlcm1pbmVEYXRhTGltaXRzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgY2hhcnQgPSBtZS5jaGFydDsKICAgICAgdmFyIGFkYXB0ZXIgPSBtZS5fYWRhcHRlcjsKICAgICAgdmFyIG9wdGlvbnMgPSBtZS5vcHRpb25zOwogICAgICB2YXIgdW5pdCA9IG9wdGlvbnMudGltZS51bml0IHx8ICdkYXknOwogICAgICB2YXIgbWluID0gTUFYX0lOVEVHRVI7CiAgICAgIHZhciBtYXggPSBNSU5fSU5URUdFUjsKICAgICAgdmFyIHRpbWVzdGFtcHMgPSBbXTsKICAgICAgdmFyIGRhdGFzZXRzID0gW107CiAgICAgIHZhciBsYWJlbHMgPSBbXTsKICAgICAgdmFyIGksIGosIGlsZW4sIGpsZW4sIGRhdGEsIHRpbWVzdGFtcCwgbGFiZWxzQWRkZWQ7CgogICAgICB2YXIgZGF0YUxhYmVscyA9IG1lLl9nZXRMYWJlbHMoKTsKCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSBkYXRhTGFiZWxzLmxlbmd0aDsgaSA8IGlsZW47ICsraSkgewogICAgICAgIGxhYmVscy5wdXNoKHBhcnNlKG1lLCBkYXRhTGFiZWxzW2ldKSk7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSAoY2hhcnQuZGF0YS5kYXRhc2V0cyB8fCBbXSkubGVuZ3RoOyBpIDwgaWxlbjsgKytpKSB7CiAgICAgICAgaWYgKGNoYXJ0LmlzRGF0YXNldFZpc2libGUoaSkpIHsKICAgICAgICAgIGRhdGEgPSBjaGFydC5kYXRhLmRhdGFzZXRzW2ldLmRhdGE7IC8vIExldCdzIGNvbnNpZGVyIHRoYXQgYWxsIGRhdGEgaGF2ZSB0aGUgc2FtZSBmb3JtYXQuCgogICAgICAgICAgaWYgKGhlbHBlcnMkMS5pc09iamVjdChkYXRhWzBdKSkgewogICAgICAgICAgICBkYXRhc2V0c1tpXSA9IFtdOwoKICAgICAgICAgICAgZm9yIChqID0gMCwgamxlbiA9IGRhdGEubGVuZ3RoOyBqIDwgamxlbjsgKytqKSB7CiAgICAgICAgICAgICAgdGltZXN0YW1wID0gcGFyc2UobWUsIGRhdGFbal0pOwogICAgICAgICAgICAgIHRpbWVzdGFtcHMucHVzaCh0aW1lc3RhbXApOwogICAgICAgICAgICAgIGRhdGFzZXRzW2ldW2pdID0gdGltZXN0YW1wOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkYXRhc2V0c1tpXSA9IGxhYmVscy5zbGljZSgwKTsKCiAgICAgICAgICAgIGlmICghbGFiZWxzQWRkZWQpIHsKICAgICAgICAgICAgICB0aW1lc3RhbXBzID0gdGltZXN0YW1wcy5jb25jYXQobGFiZWxzKTsKICAgICAgICAgICAgICBsYWJlbHNBZGRlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgZGF0YXNldHNbaV0gPSBbXTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmIChsYWJlbHMubGVuZ3RoKSB7CiAgICAgICAgbWluID0gTWF0aC5taW4obWluLCBsYWJlbHNbMF0pOwogICAgICAgIG1heCA9IE1hdGgubWF4KG1heCwgbGFiZWxzW2xhYmVscy5sZW5ndGggLSAxXSk7CiAgICAgIH0KCiAgICAgIGlmICh0aW1lc3RhbXBzLmxlbmd0aCkgewogICAgICAgIHRpbWVzdGFtcHMgPSBpbGVuID4gMSA/IGFycmF5VW5pcXVlKHRpbWVzdGFtcHMpLnNvcnQoc29ydGVyKSA6IHRpbWVzdGFtcHMuc29ydChzb3J0ZXIpOwogICAgICAgIG1pbiA9IE1hdGgubWluKG1pbiwgdGltZXN0YW1wc1swXSk7CiAgICAgICAgbWF4ID0gTWF0aC5tYXgobWF4LCB0aW1lc3RhbXBzW3RpbWVzdGFtcHMubGVuZ3RoIC0gMV0pOwogICAgICB9CgogICAgICBtaW4gPSBwYXJzZShtZSwgZ2V0TWluKG9wdGlvbnMpKSB8fCBtaW47CiAgICAgIG1heCA9IHBhcnNlKG1lLCBnZXRNYXgob3B0aW9ucykpIHx8IG1heDsgLy8gSW4gY2FzZSB0aGVyZSBpcyBubyB2YWxpZCBtaW4vbWF4LCBzZXQgbGltaXRzIGJhc2VkIG9uIHVuaXQgdGltZSBvcHRpb24KCiAgICAgIG1pbiA9IG1pbiA9PT0gTUFYX0lOVEVHRVIgPyArYWRhcHRlci5zdGFydE9mKERhdGUubm93KCksIHVuaXQpIDogbWluOwogICAgICBtYXggPSBtYXggPT09IE1JTl9JTlRFR0VSID8gK2FkYXB0ZXIuZW5kT2YoRGF0ZS5ub3coKSwgdW5pdCkgKyAxIDogbWF4OyAvLyBNYWtlIHN1cmUgdGhhdCBtYXggaXMgc3RyaWN0bHkgaGlnaGVyIHRoYW4gbWluIChyZXF1aXJlZCBieSB0aGUgbG9va3VwIHRhYmxlKQoKICAgICAgbWUubWluID0gTWF0aC5taW4obWluLCBtYXgpOwogICAgICBtZS5tYXggPSBNYXRoLm1heChtaW4gKyAxLCBtYXgpOyAvLyBQUklWQVRFCgogICAgICBtZS5fdGFibGUgPSBbXTsKICAgICAgbWUuX3RpbWVzdGFtcHMgPSB7CiAgICAgICAgZGF0YTogdGltZXN0YW1wcywKICAgICAgICBkYXRhc2V0czogZGF0YXNldHMsCiAgICAgICAgbGFiZWxzOiBsYWJlbHMKICAgICAgfTsKICAgIH0sCiAgICBidWlsZFRpY2tzOiBmdW5jdGlvbiBidWlsZFRpY2tzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgbWluID0gbWUubWluOwogICAgICB2YXIgbWF4ID0gbWUubWF4OwogICAgICB2YXIgb3B0aW9ucyA9IG1lLm9wdGlvbnM7CiAgICAgIHZhciB0aWNrT3B0cyA9IG9wdGlvbnMudGlja3M7CiAgICAgIHZhciB0aW1lT3B0cyA9IG9wdGlvbnMudGltZTsKICAgICAgdmFyIHRpbWVzdGFtcHMgPSBtZS5fdGltZXN0YW1wczsKICAgICAgdmFyIHRpY2tzID0gW107CiAgICAgIHZhciBjYXBhY2l0eSA9IG1lLmdldExhYmVsQ2FwYWNpdHkobWluKTsKICAgICAgdmFyIHNvdXJjZSA9IHRpY2tPcHRzLnNvdXJjZTsKICAgICAgdmFyIGRpc3RyaWJ1dGlvbiA9IG9wdGlvbnMuZGlzdHJpYnV0aW9uOwogICAgICB2YXIgaSwgaWxlbiwgdGltZXN0YW1wOwoKICAgICAgaWYgKHNvdXJjZSA9PT0gJ2RhdGEnIHx8IHNvdXJjZSA9PT0gJ2F1dG8nICYmIGRpc3RyaWJ1dGlvbiA9PT0gJ3NlcmllcycpIHsKICAgICAgICB0aW1lc3RhbXBzID0gdGltZXN0YW1wcy5kYXRhOwogICAgICB9IGVsc2UgaWYgKHNvdXJjZSA9PT0gJ2xhYmVscycpIHsKICAgICAgICB0aW1lc3RhbXBzID0gdGltZXN0YW1wcy5sYWJlbHM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGltZXN0YW1wcyA9IGdlbmVyYXRlKG1lLCBtaW4sIG1heCwgY2FwYWNpdHkpOwogICAgICB9CgogICAgICBpZiAob3B0aW9ucy5ib3VuZHMgPT09ICd0aWNrcycgJiYgdGltZXN0YW1wcy5sZW5ndGgpIHsKICAgICAgICBtaW4gPSB0aW1lc3RhbXBzWzBdOwogICAgICAgIG1heCA9IHRpbWVzdGFtcHNbdGltZXN0YW1wcy5sZW5ndGggLSAxXTsKICAgICAgfSAvLyBFbmZvcmNlIGxpbWl0cyB3aXRoIHVzZXIgbWluL21heCBvcHRpb25zCgoKICAgICAgbWluID0gcGFyc2UobWUsIGdldE1pbihvcHRpb25zKSkgfHwgbWluOwogICAgICBtYXggPSBwYXJzZShtZSwgZ2V0TWF4KG9wdGlvbnMpKSB8fCBtYXg7IC8vIFJlbW92ZSB0aWNrcyBvdXRzaWRlIHRoZSBtaW4vbWF4IHJhbmdlCgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gdGltZXN0YW1wcy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICB0aW1lc3RhbXAgPSB0aW1lc3RhbXBzW2ldOwoKICAgICAgICBpZiAodGltZXN0YW1wID49IG1pbiAmJiB0aW1lc3RhbXAgPD0gbWF4KSB7CiAgICAgICAgICB0aWNrcy5wdXNoKHRpbWVzdGFtcCk7CiAgICAgICAgfQogICAgICB9CgogICAgICBtZS5taW4gPSBtaW47CiAgICAgIG1lLm1heCA9IG1heDsgLy8gUFJJVkFURQogICAgICAvLyBkZXRlcm1pbmVVbml0Rm9yRm9ybWF0dGluZyByZWxpZXMgb24gdGhlIG51bWJlciBvZiB0aWNrcyBzbyB3ZSBkb24ndCB1c2UgaXQgd2hlbgogICAgICAvLyBhdXRvU2tpcCBpcyBlbmFibGVkIGJlY2F1c2Ugd2UgZG9uJ3QgeWV0IGtub3cgd2hhdCB0aGUgZmluYWwgbnVtYmVyIG9mIHRpY2tzIHdpbGwgYmUKCiAgICAgIG1lLl91bml0ID0gdGltZU9wdHMudW5pdCB8fCAodGlja09wdHMuYXV0b1NraXAgPyBkZXRlcm1pbmVVbml0Rm9yQXV0b1RpY2tzKHRpbWVPcHRzLm1pblVuaXQsIG1lLm1pbiwgbWUubWF4LCBjYXBhY2l0eSkgOiBkZXRlcm1pbmVVbml0Rm9yRm9ybWF0dGluZyhtZSwgdGlja3MubGVuZ3RoLCB0aW1lT3B0cy5taW5Vbml0LCBtZS5taW4sIG1lLm1heCkpOwogICAgICBtZS5fbWFqb3JVbml0ID0gIXRpY2tPcHRzLm1ham9yLmVuYWJsZWQgfHwgbWUuX3VuaXQgPT09ICd5ZWFyJyA/IHVuZGVmaW5lZCA6IGRldGVybWluZU1ham9yVW5pdChtZS5fdW5pdCk7CiAgICAgIG1lLl90YWJsZSA9IGJ1aWxkTG9va3VwVGFibGUobWUuX3RpbWVzdGFtcHMuZGF0YSwgbWluLCBtYXgsIGRpc3RyaWJ1dGlvbik7CiAgICAgIG1lLl9vZmZzZXRzID0gY29tcHV0ZU9mZnNldHMobWUuX3RhYmxlLCB0aWNrcywgbWluLCBtYXgsIG9wdGlvbnMpOwoKICAgICAgaWYgKHRpY2tPcHRzLnJldmVyc2UpIHsKICAgICAgICB0aWNrcy5yZXZlcnNlKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiB0aWNrc0Zyb21UaW1lc3RhbXBzKG1lLCB0aWNrcywgbWUuX21ham9yVW5pdCk7CiAgICB9LAogICAgZ2V0TGFiZWxGb3JJbmRleDogZnVuY3Rpb24gZ2V0TGFiZWxGb3JJbmRleChpbmRleCwgZGF0YXNldEluZGV4KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBhZGFwdGVyID0gbWUuX2FkYXB0ZXI7CiAgICAgIHZhciBkYXRhID0gbWUuY2hhcnQuZGF0YTsKICAgICAgdmFyIHRpbWVPcHRzID0gbWUub3B0aW9ucy50aW1lOwogICAgICB2YXIgbGFiZWwgPSBkYXRhLmxhYmVscyAmJiBpbmRleCA8IGRhdGEubGFiZWxzLmxlbmd0aCA/IGRhdGEubGFiZWxzW2luZGV4XSA6ICcnOwogICAgICB2YXIgdmFsdWUgPSBkYXRhLmRhdGFzZXRzW2RhdGFzZXRJbmRleF0uZGF0YVtpbmRleF07CgogICAgICBpZiAoaGVscGVycyQxLmlzT2JqZWN0KHZhbHVlKSkgewogICAgICAgIGxhYmVsID0gbWUuZ2V0UmlnaHRWYWx1ZSh2YWx1ZSk7CiAgICAgIH0KCiAgICAgIGlmICh0aW1lT3B0cy50b29sdGlwRm9ybWF0KSB7CiAgICAgICAgcmV0dXJuIGFkYXB0ZXIuZm9ybWF0KHRvVGltZXN0YW1wKG1lLCBsYWJlbCksIHRpbWVPcHRzLnRvb2x0aXBGb3JtYXQpOwogICAgICB9CgogICAgICBpZiAodHlwZW9mIGxhYmVsID09PSAnc3RyaW5nJykgewogICAgICAgIHJldHVybiBsYWJlbDsKICAgICAgfQoKICAgICAgcmV0dXJuIGFkYXB0ZXIuZm9ybWF0KHRvVGltZXN0YW1wKG1lLCBsYWJlbCksIHRpbWVPcHRzLmRpc3BsYXlGb3JtYXRzLmRhdGV0aW1lKTsKICAgIH0sCgogICAgLyoqDQogICAgICogRnVuY3Rpb24gdG8gZm9ybWF0IGFuIGluZGl2aWR1YWwgdGljayBtYXJrDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIHRpY2tGb3JtYXRGdW5jdGlvbjogZnVuY3Rpb24gdGlja0Zvcm1hdEZ1bmN0aW9uKHRpbWUsIGluZGV4LCB0aWNrcywgZm9ybWF0KSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBhZGFwdGVyID0gbWUuX2FkYXB0ZXI7CiAgICAgIHZhciBvcHRpb25zID0gbWUub3B0aW9uczsKICAgICAgdmFyIGZvcm1hdHMgPSBvcHRpb25zLnRpbWUuZGlzcGxheUZvcm1hdHM7CiAgICAgIHZhciBtaW5vckZvcm1hdCA9IGZvcm1hdHNbbWUuX3VuaXRdOwogICAgICB2YXIgbWFqb3JVbml0ID0gbWUuX21ham9yVW5pdDsKICAgICAgdmFyIG1ham9yRm9ybWF0ID0gZm9ybWF0c1ttYWpvclVuaXRdOwogICAgICB2YXIgdGljayA9IHRpY2tzW2luZGV4XTsKICAgICAgdmFyIHRpY2tPcHRzID0gb3B0aW9ucy50aWNrczsKICAgICAgdmFyIG1ham9yID0gbWFqb3JVbml0ICYmIG1ham9yRm9ybWF0ICYmIHRpY2sgJiYgdGljay5tYWpvcjsKICAgICAgdmFyIGxhYmVsID0gYWRhcHRlci5mb3JtYXQodGltZSwgZm9ybWF0ID8gZm9ybWF0IDogbWFqb3IgPyBtYWpvckZvcm1hdCA6IG1pbm9yRm9ybWF0KTsKICAgICAgdmFyIG5lc3RlZFRpY2tPcHRzID0gbWFqb3IgPyB0aWNrT3B0cy5tYWpvciA6IHRpY2tPcHRzLm1pbm9yOwogICAgICB2YXIgZm9ybWF0dGVyID0gcmVzb2x2ZSQ1KFtuZXN0ZWRUaWNrT3B0cy5jYWxsYmFjaywgbmVzdGVkVGlja09wdHMudXNlckNhbGxiYWNrLCB0aWNrT3B0cy5jYWxsYmFjaywgdGlja09wdHMudXNlckNhbGxiYWNrXSk7CiAgICAgIHJldHVybiBmb3JtYXR0ZXIgPyBmb3JtYXR0ZXIobGFiZWwsIGluZGV4LCB0aWNrcykgOiBsYWJlbDsKICAgIH0sCiAgICBjb252ZXJ0VGlja3NUb0xhYmVsczogZnVuY3Rpb24gY29udmVydFRpY2tzVG9MYWJlbHModGlja3MpIHsKICAgICAgdmFyIGxhYmVscyA9IFtdOwogICAgICB2YXIgaSwgaWxlbjsKCiAgICAgIGZvciAoaSA9IDAsIGlsZW4gPSB0aWNrcy5sZW5ndGg7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgICBsYWJlbHMucHVzaCh0aGlzLnRpY2tGb3JtYXRGdW5jdGlvbih0aWNrc1tpXS52YWx1ZSwgaSwgdGlja3MpKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGxhYmVsczsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIGdldFBpeGVsRm9yT2Zmc2V0OiBmdW5jdGlvbiBnZXRQaXhlbEZvck9mZnNldCh0aW1lKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBvZmZzZXRzID0gbWUuX29mZnNldHM7CiAgICAgIHZhciBwb3MgPSBpbnRlcnBvbGF0ZSQxKG1lLl90YWJsZSwgJ3RpbWUnLCB0aW1lLCAncG9zJyk7CiAgICAgIHJldHVybiBtZS5nZXRQaXhlbEZvckRlY2ltYWwoKG9mZnNldHMuc3RhcnQgKyBwb3MpICogb2Zmc2V0cy5mYWN0b3IpOwogICAgfSwKICAgIGdldFBpeGVsRm9yVmFsdWU6IGZ1bmN0aW9uIGdldFBpeGVsRm9yVmFsdWUodmFsdWUsIGluZGV4LCBkYXRhc2V0SW5kZXgpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIHRpbWUgPSBudWxsOwoKICAgICAgaWYgKGluZGV4ICE9PSB1bmRlZmluZWQgJiYgZGF0YXNldEluZGV4ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICB0aW1lID0gbWUuX3RpbWVzdGFtcHMuZGF0YXNldHNbZGF0YXNldEluZGV4XVtpbmRleF07CiAgICAgIH0KCiAgICAgIGlmICh0aW1lID09PSBudWxsKSB7CiAgICAgICAgdGltZSA9IHBhcnNlKG1lLCB2YWx1ZSk7CiAgICAgIH0KCiAgICAgIGlmICh0aW1lICE9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIG1lLmdldFBpeGVsRm9yT2Zmc2V0KHRpbWUpOwogICAgICB9CiAgICB9LAogICAgZ2V0UGl4ZWxGb3JUaWNrOiBmdW5jdGlvbiBnZXRQaXhlbEZvclRpY2soaW5kZXgpIHsKICAgICAgdmFyIHRpY2tzID0gdGhpcy5nZXRUaWNrcygpOwogICAgICByZXR1cm4gaW5kZXggPj0gMCAmJiBpbmRleCA8IHRpY2tzLmxlbmd0aCA/IHRoaXMuZ2V0UGl4ZWxGb3JPZmZzZXQodGlja3NbaW5kZXhdLnZhbHVlKSA6IG51bGw7CiAgICB9LAogICAgZ2V0VmFsdWVGb3JQaXhlbDogZnVuY3Rpb24gZ2V0VmFsdWVGb3JQaXhlbChwaXhlbCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgb2Zmc2V0cyA9IG1lLl9vZmZzZXRzOwogICAgICB2YXIgcG9zID0gbWUuZ2V0RGVjaW1hbEZvclBpeGVsKHBpeGVsKSAvIG9mZnNldHMuZmFjdG9yIC0gb2Zmc2V0cy5lbmQ7CiAgICAgIHZhciB0aW1lID0gaW50ZXJwb2xhdGUkMShtZS5fdGFibGUsICdwb3MnLCBwb3MsICd0aW1lJyk7IC8vIERFUFJFQ0FUSU9OLCB3ZSBzaG91bGQgcmV0dXJuIHRpbWUgZGlyZWN0bHkKCiAgICAgIHJldHVybiBtZS5fYWRhcHRlci5fY3JlYXRlKHRpbWUpOwogICAgfSwKCiAgICAvKioNCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2dldExhYmVsU2l6ZTogZnVuY3Rpb24gX2dldExhYmVsU2l6ZShsYWJlbCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgdGlja3NPcHRzID0gbWUub3B0aW9ucy50aWNrczsKICAgICAgdmFyIHRpY2tMYWJlbFdpZHRoID0gbWUuY3R4Lm1lYXN1cmVUZXh0KGxhYmVsKS53aWR0aDsKICAgICAgdmFyIGFuZ2xlID0gaGVscGVycyQxLnRvUmFkaWFucyhtZS5pc0hvcml6b250YWwoKSA/IHRpY2tzT3B0cy5tYXhSb3RhdGlvbiA6IHRpY2tzT3B0cy5taW5Sb3RhdGlvbik7CiAgICAgIHZhciBjb3NSb3RhdGlvbiA9IE1hdGguY29zKGFuZ2xlKTsKICAgICAgdmFyIHNpblJvdGF0aW9uID0gTWF0aC5zaW4oYW5nbGUpOwogICAgICB2YXIgdGlja0ZvbnRTaXplID0gdmFsdWVPckRlZmF1bHQkZCh0aWNrc09wdHMuZm9udFNpemUsIGNvcmVfZGVmYXVsdHMuZ2xvYmFsLmRlZmF1bHRGb250U2l6ZSk7CiAgICAgIHJldHVybiB7CiAgICAgICAgdzogdGlja0xhYmVsV2lkdGggKiBjb3NSb3RhdGlvbiArIHRpY2tGb250U2l6ZSAqIHNpblJvdGF0aW9uLAogICAgICAgIGg6IHRpY2tMYWJlbFdpZHRoICogc2luUm90YXRpb24gKyB0aWNrRm9udFNpemUgKiBjb3NSb3RhdGlvbgogICAgICB9OwogICAgfSwKCiAgICAvKioNCiAgICAgKiBDcnVkZSBhcHByb3hpbWF0aW9uIG9mIHdoYXQgdGhlIGxhYmVsIHdpZHRoIG1pZ2h0IGJlDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIGdldExhYmVsV2lkdGg6IGZ1bmN0aW9uIGdldExhYmVsV2lkdGgobGFiZWwpIHsKICAgICAgcmV0dXJuIHRoaXMuX2dldExhYmVsU2l6ZShsYWJlbCkudzsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIGdldExhYmVsQ2FwYWNpdHk6IGZ1bmN0aW9uIGdldExhYmVsQ2FwYWNpdHkoZXhhbXBsZVRpbWUpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIHRpbWVPcHRzID0gbWUub3B0aW9ucy50aW1lOwogICAgICB2YXIgZGlzcGxheUZvcm1hdHMgPSB0aW1lT3B0cy5kaXNwbGF5Rm9ybWF0czsgLy8gcGljayB0aGUgbG9uZ2VzdCBmb3JtYXQgKG1pbGxpc2Vjb25kcykgZm9yIGd1ZXN0aW1hdGlvbgoKICAgICAgdmFyIGZvcm1hdCA9IGRpc3BsYXlGb3JtYXRzW3RpbWVPcHRzLnVuaXRdIHx8IGRpc3BsYXlGb3JtYXRzLm1pbGxpc2Vjb25kOwogICAgICB2YXIgZXhhbXBsZUxhYmVsID0gbWUudGlja0Zvcm1hdEZ1bmN0aW9uKGV4YW1wbGVUaW1lLCAwLCB0aWNrc0Zyb21UaW1lc3RhbXBzKG1lLCBbZXhhbXBsZVRpbWVdLCBtZS5fbWFqb3JVbml0KSwgZm9ybWF0KTsKCiAgICAgIHZhciBzaXplID0gbWUuX2dldExhYmVsU2l6ZShleGFtcGxlTGFiZWwpOwoKICAgICAgdmFyIGNhcGFjaXR5ID0gTWF0aC5mbG9vcihtZS5pc0hvcml6b250YWwoKSA/IG1lLndpZHRoIC8gc2l6ZS53IDogbWUuaGVpZ2h0IC8gc2l6ZS5oKTsKCiAgICAgIGlmIChtZS5vcHRpb25zLm9mZnNldCkgewogICAgICAgIGNhcGFjaXR5LS07CiAgICAgIH0KCiAgICAgIHJldHVybiBjYXBhY2l0eSA+IDAgPyBjYXBhY2l0eSA6IDE7CiAgICB9CiAgfSk7IC8vIElOVEVSTkFMOiBzdGF0aWMgZGVmYXVsdCBvcHRpb25zLCByZWdpc3RlcmVkIGluIHNyYy9pbmRleC5qcwoKICB2YXIgX2RlZmF1bHRzJDQgPSBkZWZhdWx0Q29uZmlnJDQ7CiAgc2NhbGVfdGltZS5fZGVmYXVsdHMgPSBfZGVmYXVsdHMkNDsKICB2YXIgc2NhbGVzID0gewogICAgY2F0ZWdvcnk6IHNjYWxlX2NhdGVnb3J5LAogICAgbGluZWFyOiBzY2FsZV9saW5lYXIsCiAgICBsb2dhcml0aG1pYzogc2NhbGVfbG9nYXJpdGhtaWMsCiAgICByYWRpYWxMaW5lYXI6IHNjYWxlX3JhZGlhbExpbmVhciwKICAgIHRpbWU6IHNjYWxlX3RpbWUKICB9OwogIHZhciBGT1JNQVRTID0gewogICAgZGF0ZXRpbWU6ICdNTU0gRCwgWVlZWSwgaDptbTpzcyBhJywKICAgIG1pbGxpc2Vjb25kOiAnaDptbTpzcy5TU1MgYScsCiAgICBzZWNvbmQ6ICdoOm1tOnNzIGEnLAogICAgbWludXRlOiAnaDptbSBhJywKICAgIGhvdXI6ICdoQScsCiAgICBkYXk6ICdNTU0gRCcsCiAgICB3ZWVrOiAnbGwnLAogICAgbW9udGg6ICdNTU0gWVlZWScsCiAgICBxdWFydGVyOiAnW1FdUSAtIFlZWVknLAogICAgeWVhcjogJ1lZWVknCiAgfTsKCiAgY29yZV9hZGFwdGVycy5fZGF0ZS5vdmVycmlkZSh0eXBlb2YgbW9tZW50ID09PSAnZnVuY3Rpb24nID8gewogICAgX2lkOiAnbW9tZW50JywKICAgIC8vIERFQlVHIE9OTFkKICAgIGZvcm1hdHM6IGZ1bmN0aW9uIGZvcm1hdHMoKSB7CiAgICAgIHJldHVybiBGT1JNQVRTOwogICAgfSwKICAgIHBhcnNlOiBmdW5jdGlvbiBwYXJzZSh2YWx1ZSwgZm9ybWF0KSB7CiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBmb3JtYXQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgdmFsdWUgPSBtb21lbnQodmFsdWUsIGZvcm1hdCk7CiAgICAgIH0gZWxzZSBpZiAoISh2YWx1ZSBpbnN0YW5jZW9mIG1vbWVudCkpIHsKICAgICAgICB2YWx1ZSA9IG1vbWVudCh2YWx1ZSk7CiAgICAgIH0KCiAgICAgIHJldHVybiB2YWx1ZS5pc1ZhbGlkKCkgPyB2YWx1ZS52YWx1ZU9mKCkgOiBudWxsOwogICAgfSwKICAgIGZvcm1hdDogZnVuY3Rpb24gZm9ybWF0KHRpbWUsIF9mb3JtYXQpIHsKICAgICAgcmV0dXJuIG1vbWVudCh0aW1lKS5mb3JtYXQoX2Zvcm1hdCk7CiAgICB9LAogICAgYWRkOiBmdW5jdGlvbiBhZGQodGltZSwgYW1vdW50LCB1bml0KSB7CiAgICAgIHJldHVybiBtb21lbnQodGltZSkuYWRkKGFtb3VudCwgdW5pdCkudmFsdWVPZigpOwogICAgfSwKICAgIGRpZmY6IGZ1bmN0aW9uIGRpZmYobWF4LCBtaW4sIHVuaXQpIHsKICAgICAgcmV0dXJuIG1vbWVudChtYXgpLmRpZmYobW9tZW50KG1pbiksIHVuaXQpOwogICAgfSwKICAgIHN0YXJ0T2Y6IGZ1bmN0aW9uIHN0YXJ0T2YodGltZSwgdW5pdCwgd2Vla2RheSkgewogICAgICB0aW1lID0gbW9tZW50KHRpbWUpOwoKICAgICAgaWYgKHVuaXQgPT09ICdpc29XZWVrJykgewogICAgICAgIHJldHVybiB0aW1lLmlzb1dlZWtkYXkod2Vla2RheSkudmFsdWVPZigpOwogICAgICB9CgogICAgICByZXR1cm4gdGltZS5zdGFydE9mKHVuaXQpLnZhbHVlT2YoKTsKICAgIH0sCiAgICBlbmRPZjogZnVuY3Rpb24gZW5kT2YodGltZSwgdW5pdCkgewogICAgICByZXR1cm4gbW9tZW50KHRpbWUpLmVuZE9mKHVuaXQpLnZhbHVlT2YoKTsKICAgIH0sCiAgICAvLyBERVBSRUNBVElPTlMKCiAgICAvKioNCiAgICAgKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSB3aXRoIHNjYWxlLmdldFZhbHVlRm9yUGl4ZWwoKS4NCiAgICAgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuOC4wDQogICAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfY3JlYXRlOiBmdW5jdGlvbiBfY3JlYXRlKHRpbWUpIHsKICAgICAgcmV0dXJuIG1vbWVudCh0aW1lKTsKICAgIH0KICB9IDoge30pOwoKICBjb3JlX2RlZmF1bHRzLl9zZXQoJ2dsb2JhbCcsIHsKICAgIHBsdWdpbnM6IHsKICAgICAgZmlsbGVyOiB7CiAgICAgICAgcHJvcGFnYXRlOiB0cnVlCiAgICAgIH0KICAgIH0KICB9KTsKCiAgdmFyIG1hcHBlcnMgPSB7CiAgICBkYXRhc2V0OiBmdW5jdGlvbiBkYXRhc2V0KHNvdXJjZSkgewogICAgICB2YXIgaW5kZXggPSBzb3VyY2UuZmlsbDsKICAgICAgdmFyIGNoYXJ0ID0gc291cmNlLmNoYXJ0OwogICAgICB2YXIgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGluZGV4KTsKICAgICAgdmFyIHZpc2libGUgPSBtZXRhICYmIGNoYXJ0LmlzRGF0YXNldFZpc2libGUoaW5kZXgpOwogICAgICB2YXIgcG9pbnRzID0gdmlzaWJsZSAmJiBtZXRhLmRhdGFzZXQuX2NoaWxkcmVuIHx8IFtdOwogICAgICB2YXIgbGVuZ3RoID0gcG9pbnRzLmxlbmd0aCB8fCAwOwogICAgICByZXR1cm4gIWxlbmd0aCA/IG51bGwgOiBmdW5jdGlvbiAocG9pbnQsIGkpIHsKICAgICAgICByZXR1cm4gaSA8IGxlbmd0aCAmJiBwb2ludHNbaV0uX3ZpZXcgfHwgbnVsbDsKICAgICAgfTsKICAgIH0sCiAgICBib3VuZGFyeTogZnVuY3Rpb24gYm91bmRhcnkoc291cmNlKSB7CiAgICAgIHZhciBib3VuZGFyeSA9IHNvdXJjZS5ib3VuZGFyeTsKICAgICAgdmFyIHggPSBib3VuZGFyeSA/IGJvdW5kYXJ5LnggOiBudWxsOwogICAgICB2YXIgeSA9IGJvdW5kYXJ5ID8gYm91bmRhcnkueSA6IG51bGw7CgogICAgICBpZiAoaGVscGVycyQxLmlzQXJyYXkoYm91bmRhcnkpKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChwb2ludCwgaSkgewogICAgICAgICAgcmV0dXJuIGJvdW5kYXJ5W2ldOwogICAgICAgIH07CiAgICAgIH0KCiAgICAgIHJldHVybiBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgeDogeCA9PT0gbnVsbCA/IHBvaW50LnggOiB4LAogICAgICAgICAgeTogeSA9PT0gbnVsbCA/IHBvaW50LnkgOiB5CiAgICAgICAgfTsKICAgICAgfTsKICAgIH0KICB9OyAvLyBAdG9kbyBpZiAoZmlsbFswXSA9PT0gJyMnKQoKICBmdW5jdGlvbiBkZWNvZGVGaWxsKGVsLCBpbmRleCwgY291bnQpIHsKICAgIHZhciBtb2RlbCA9IGVsLl9tb2RlbCB8fCB7fTsKICAgIHZhciBmaWxsID0gbW9kZWwuZmlsbDsKICAgIHZhciB0YXJnZXQ7CgogICAgaWYgKGZpbGwgPT09IHVuZGVmaW5lZCkgewogICAgICBmaWxsID0gISFtb2RlbC5iYWNrZ3JvdW5kQ29sb3I7CiAgICB9CgogICAgaWYgKGZpbGwgPT09IGZhbHNlIHx8IGZpbGwgPT09IG51bGwpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmIChmaWxsID09PSB0cnVlKSB7CiAgICAgIHJldHVybiAnb3JpZ2luJzsKICAgIH0KCiAgICB0YXJnZXQgPSBwYXJzZUZsb2F0KGZpbGwsIDEwKTsKCiAgICBpZiAoaXNGaW5pdGUodGFyZ2V0KSAmJiBNYXRoLmZsb29yKHRhcmdldCkgPT09IHRhcmdldCkgewogICAgICBpZiAoZmlsbFswXSA9PT0gJy0nIHx8IGZpbGxbMF0gPT09ICcrJykgewogICAgICAgIHRhcmdldCA9IGluZGV4ICsgdGFyZ2V0OwogICAgICB9CgogICAgICBpZiAodGFyZ2V0ID09PSBpbmRleCB8fCB0YXJnZXQgPCAwIHx8IHRhcmdldCA+PSBjb3VudCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRhcmdldDsKICAgIH0KCiAgICBzd2l0Y2ggKGZpbGwpIHsKICAgICAgLy8gY29tcGF0aWJpbGl0eQogICAgICBjYXNlICdib3R0b20nOgogICAgICAgIHJldHVybiAnc3RhcnQnOwoKICAgICAgY2FzZSAndG9wJzoKICAgICAgICByZXR1cm4gJ2VuZCc7CgogICAgICBjYXNlICd6ZXJvJzoKICAgICAgICByZXR1cm4gJ29yaWdpbic7CiAgICAgIC8vIHN1cHBvcnRlZCBib3VuZGFyaWVzCgogICAgICBjYXNlICdvcmlnaW4nOgogICAgICBjYXNlICdzdGFydCc6CiAgICAgIGNhc2UgJ2VuZCc6CiAgICAgICAgcmV0dXJuIGZpbGw7CiAgICAgIC8vIGludmFsaWQgZmlsbCB2YWx1ZXMKCiAgICAgIGRlZmF1bHQ6CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0KCiAgZnVuY3Rpb24gY29tcHV0ZUxpbmVhckJvdW5kYXJ5KHNvdXJjZSkgewogICAgdmFyIG1vZGVsID0gc291cmNlLmVsLl9tb2RlbCB8fCB7fTsKICAgIHZhciBzY2FsZSA9IHNvdXJjZS5lbC5fc2NhbGUgfHwge307CiAgICB2YXIgZmlsbCA9IHNvdXJjZS5maWxsOwogICAgdmFyIHRhcmdldCA9IG51bGw7CiAgICB2YXIgaG9yaXpvbnRhbDsKCiAgICBpZiAoaXNGaW5pdGUoZmlsbCkpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9IC8vIEJhY2t3YXJkIGNvbXBhdGliaWxpdHk6IHVudGlsIHYzLCB3ZSBzdGlsbCBuZWVkIHRvIHN1cHBvcnQgYm91bmRhcnkgdmFsdWVzIHNldCBvbgogICAgLy8gdGhlIG1vZGVsIChzY2FsZVRvcCwgc2NhbGVCb3R0b20gYW5kIHNjYWxlWmVybykgYmVjYXVzZSBzb21lIGV4dGVybmFsIHBsdWdpbnMgYW5kCiAgICAvLyBjb250cm9sbGVycyBtaWdodCBzdGlsbCB1c2UgaXQgKGUuZy4gdGhlIFNtaXRoIGNoYXJ0KS4KCgogICAgaWYgKGZpbGwgPT09ICdzdGFydCcpIHsKICAgICAgdGFyZ2V0ID0gbW9kZWwuc2NhbGVCb3R0b20gPT09IHVuZGVmaW5lZCA/IHNjYWxlLmJvdHRvbSA6IG1vZGVsLnNjYWxlQm90dG9tOwogICAgfSBlbHNlIGlmIChmaWxsID09PSAnZW5kJykgewogICAgICB0YXJnZXQgPSBtb2RlbC5zY2FsZVRvcCA9PT0gdW5kZWZpbmVkID8gc2NhbGUudG9wIDogbW9kZWwuc2NhbGVUb3A7CiAgICB9IGVsc2UgaWYgKG1vZGVsLnNjYWxlWmVybyAhPT0gdW5kZWZpbmVkKSB7CiAgICAgIHRhcmdldCA9IG1vZGVsLnNjYWxlWmVybzsKICAgIH0gZWxzZSBpZiAoc2NhbGUuZ2V0QmFzZVBpeGVsKSB7CiAgICAgIHRhcmdldCA9IHNjYWxlLmdldEJhc2VQaXhlbCgpOwogICAgfQoKICAgIGlmICh0YXJnZXQgIT09IHVuZGVmaW5lZCAmJiB0YXJnZXQgIT09IG51bGwpIHsKICAgICAgaWYgKHRhcmdldC54ICE9PSB1bmRlZmluZWQgJiYgdGFyZ2V0LnkgIT09IHVuZGVmaW5lZCkgewogICAgICAgIHJldHVybiB0YXJnZXQ7CiAgICAgIH0KCiAgICAgIGlmIChoZWxwZXJzJDEuaXNGaW5pdGUodGFyZ2V0KSkgewogICAgICAgIGhvcml6b250YWwgPSBzY2FsZS5pc0hvcml6b250YWwoKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgeDogaG9yaXpvbnRhbCA/IHRhcmdldCA6IG51bGwsCiAgICAgICAgICB5OiBob3Jpem9udGFsID8gbnVsbCA6IHRhcmdldAogICAgICAgIH07CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gbnVsbDsKICB9CgogIGZ1bmN0aW9uIGNvbXB1dGVDaXJjdWxhckJvdW5kYXJ5KHNvdXJjZSkgewogICAgdmFyIHNjYWxlID0gc291cmNlLmVsLl9zY2FsZTsKICAgIHZhciBvcHRpb25zID0gc2NhbGUub3B0aW9uczsKICAgIHZhciBsZW5ndGggPSBzY2FsZS5jaGFydC5kYXRhLmxhYmVscy5sZW5ndGg7CiAgICB2YXIgZmlsbCA9IHNvdXJjZS5maWxsOwogICAgdmFyIHRhcmdldCA9IFtdOwogICAgdmFyIHN0YXJ0LCBlbmQsIGNlbnRlciwgaSwgcG9pbnQ7CgogICAgaWYgKCFsZW5ndGgpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgc3RhcnQgPSBvcHRpb25zLnRpY2tzLnJldmVyc2UgPyBzY2FsZS5tYXggOiBzY2FsZS5taW47CiAgICBlbmQgPSBvcHRpb25zLnRpY2tzLnJldmVyc2UgPyBzY2FsZS5taW4gOiBzY2FsZS5tYXg7CiAgICBjZW50ZXIgPSBzY2FsZS5nZXRQb2ludFBvc2l0aW9uRm9yVmFsdWUoMCwgc3RhcnQpOwoKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7ICsraSkgewogICAgICBwb2ludCA9IGZpbGwgPT09ICdzdGFydCcgfHwgZmlsbCA9PT0gJ2VuZCcgPyBzY2FsZS5nZXRQb2ludFBvc2l0aW9uRm9yVmFsdWUoaSwgZmlsbCA9PT0gJ3N0YXJ0JyA/IHN0YXJ0IDogZW5kKSA6IHNjYWxlLmdldEJhc2VQb3NpdGlvbihpKTsKCiAgICAgIGlmIChvcHRpb25zLmdyaWRMaW5lcy5jaXJjdWxhcikgewogICAgICAgIHBvaW50LmN4ID0gY2VudGVyLng7CiAgICAgICAgcG9pbnQuY3kgPSBjZW50ZXIueTsKICAgICAgICBwb2ludC5hbmdsZSA9IHNjYWxlLmdldEluZGV4QW5nbGUoaSkgLSBNYXRoLlBJIC8gMjsKICAgICAgfQoKICAgICAgdGFyZ2V0LnB1c2gocG9pbnQpOwogICAgfQoKICAgIHJldHVybiB0YXJnZXQ7CiAgfQoKICBmdW5jdGlvbiBjb21wdXRlQm91bmRhcnkoc291cmNlKSB7CiAgICB2YXIgc2NhbGUgPSBzb3VyY2UuZWwuX3NjYWxlIHx8IHt9OwoKICAgIGlmIChzY2FsZS5nZXRQb2ludFBvc2l0aW9uRm9yVmFsdWUpIHsKICAgICAgcmV0dXJuIGNvbXB1dGVDaXJjdWxhckJvdW5kYXJ5KHNvdXJjZSk7CiAgICB9CgogICAgcmV0dXJuIGNvbXB1dGVMaW5lYXJCb3VuZGFyeShzb3VyY2UpOwogIH0KCiAgZnVuY3Rpb24gcmVzb2x2ZVRhcmdldChzb3VyY2VzLCBpbmRleCwgcHJvcGFnYXRlKSB7CiAgICB2YXIgc291cmNlID0gc291cmNlc1tpbmRleF07CiAgICB2YXIgZmlsbCA9IHNvdXJjZS5maWxsOwogICAgdmFyIHZpc2l0ZWQgPSBbaW5kZXhdOwogICAgdmFyIHRhcmdldDsKCiAgICBpZiAoIXByb3BhZ2F0ZSkgewogICAgICByZXR1cm4gZmlsbDsKICAgIH0KCiAgICB3aGlsZSAoZmlsbCAhPT0gZmFsc2UgJiYgdmlzaXRlZC5pbmRleE9mKGZpbGwpID09PSAtMSkgewogICAgICBpZiAoIWlzRmluaXRlKGZpbGwpKSB7CiAgICAgICAgcmV0dXJuIGZpbGw7CiAgICAgIH0KCiAgICAgIHRhcmdldCA9IHNvdXJjZXNbZmlsbF07CgogICAgICBpZiAoIXRhcmdldCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQoKICAgICAgaWYgKHRhcmdldC52aXNpYmxlKSB7CiAgICAgICAgcmV0dXJuIGZpbGw7CiAgICAgIH0KCiAgICAgIHZpc2l0ZWQucHVzaChmaWxsKTsKICAgICAgZmlsbCA9IHRhcmdldC5maWxsOwogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZU1hcHBlcihzb3VyY2UpIHsKICAgIHZhciBmaWxsID0gc291cmNlLmZpbGw7CiAgICB2YXIgdHlwZSA9ICdkYXRhc2V0JzsKCiAgICBpZiAoZmlsbCA9PT0gZmFsc2UpIHsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgaWYgKCFpc0Zpbml0ZShmaWxsKSkgewogICAgICB0eXBlID0gJ2JvdW5kYXJ5JzsKICAgIH0KCiAgICByZXR1cm4gbWFwcGVyc1t0eXBlXShzb3VyY2UpOwogIH0KCiAgZnVuY3Rpb24gaXNEcmF3YWJsZShwb2ludCkgewogICAgcmV0dXJuIHBvaW50ICYmICFwb2ludC5za2lwOwogIH0KCiAgZnVuY3Rpb24gZHJhd0FyZWEoY3R4LCBjdXJ2ZTAsIGN1cnZlMSwgbGVuMCwgbGVuMSkgewogICAgdmFyIGksIGN4LCBjeSwgcjsKCiAgICBpZiAoIWxlbjAgfHwgIWxlbjEpIHsKICAgICAgcmV0dXJuOwogICAgfSAvLyBidWlsZGluZyBmaXJzdCBhcmVhIGN1cnZlIChub3JtYWwpCgoKICAgIGN0eC5tb3ZlVG8oY3VydmUwWzBdLngsIGN1cnZlMFswXS55KTsKCiAgICBmb3IgKGkgPSAxOyBpIDwgbGVuMDsgKytpKSB7CiAgICAgIGhlbHBlcnMkMS5jYW52YXMubGluZVRvKGN0eCwgY3VydmUwW2kgLSAxXSwgY3VydmUwW2ldKTsKICAgIH0KCiAgICBpZiAoY3VydmUxWzBdLmFuZ2xlICE9PSB1bmRlZmluZWQpIHsKICAgICAgY3ggPSBjdXJ2ZTFbMF0uY3g7CiAgICAgIGN5ID0gY3VydmUxWzBdLmN5OwogICAgICByID0gTWF0aC5zcXJ0KE1hdGgucG93KGN1cnZlMVswXS54IC0gY3gsIDIpICsgTWF0aC5wb3coY3VydmUxWzBdLnkgLSBjeSwgMikpOwoKICAgICAgZm9yIChpID0gbGVuMSAtIDE7IGkgPiAwOyAtLWkpIHsKICAgICAgICBjdHguYXJjKGN4LCBjeSwgciwgY3VydmUxW2ldLmFuZ2xlLCBjdXJ2ZTFbaSAtIDFdLmFuZ2xlLCB0cnVlKTsKICAgICAgfQoKICAgICAgcmV0dXJuOwogICAgfSAvLyBqb2luaW5nIHRoZSB0d28gYXJlYSBjdXJ2ZXMKCgogICAgY3R4LmxpbmVUbyhjdXJ2ZTFbbGVuMSAtIDFdLngsIGN1cnZlMVtsZW4xIC0gMV0ueSk7IC8vIGJ1aWxkaW5nIG9wcG9zaXRlIGFyZWEgY3VydmUgKHJldmVyc2UpCgogICAgZm9yIChpID0gbGVuMSAtIDE7IGkgPiAwOyAtLWkpIHsKICAgICAgaGVscGVycyQxLmNhbnZhcy5saW5lVG8oY3R4LCBjdXJ2ZTFbaV0sIGN1cnZlMVtpIC0gMV0sIHRydWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gZG9GaWxsKGN0eCwgcG9pbnRzLCBtYXBwZXIsIHZpZXcsIGNvbG9yLCBsb29wKSB7CiAgICB2YXIgY291bnQgPSBwb2ludHMubGVuZ3RoOwogICAgdmFyIHNwYW4gPSB2aWV3LnNwYW5HYXBzOwogICAgdmFyIGN1cnZlMCA9IFtdOwogICAgdmFyIGN1cnZlMSA9IFtdOwogICAgdmFyIGxlbjAgPSAwOwogICAgdmFyIGxlbjEgPSAwOwogICAgdmFyIGksIGlsZW4sIGluZGV4LCBwMCwgcDEsIGQwLCBkMSwgbG9vcE9mZnNldDsKICAgIGN0eC5iZWdpblBhdGgoKTsKCiAgICBmb3IgKGkgPSAwLCBpbGVuID0gY291bnQ7IGkgPCBpbGVuOyArK2kpIHsKICAgICAgaW5kZXggPSBpICUgY291bnQ7CiAgICAgIHAwID0gcG9pbnRzW2luZGV4XS5fdmlldzsKICAgICAgcDEgPSBtYXBwZXIocDAsIGluZGV4LCB2aWV3KTsKICAgICAgZDAgPSBpc0RyYXdhYmxlKHAwKTsKICAgICAgZDEgPSBpc0RyYXdhYmxlKHAxKTsKCiAgICAgIGlmIChsb29wICYmIGxvb3BPZmZzZXQgPT09IHVuZGVmaW5lZCAmJiBkMCkgewogICAgICAgIGxvb3BPZmZzZXQgPSBpICsgMTsKICAgICAgICBpbGVuID0gY291bnQgKyBsb29wT2Zmc2V0OwogICAgICB9CgogICAgICBpZiAoZDAgJiYgZDEpIHsKICAgICAgICBsZW4wID0gY3VydmUwLnB1c2gocDApOwogICAgICAgIGxlbjEgPSBjdXJ2ZTEucHVzaChwMSk7CiAgICAgIH0gZWxzZSBpZiAobGVuMCAmJiBsZW4xKSB7CiAgICAgICAgaWYgKCFzcGFuKSB7CiAgICAgICAgICBkcmF3QXJlYShjdHgsIGN1cnZlMCwgY3VydmUxLCBsZW4wLCBsZW4xKTsKICAgICAgICAgIGxlbjAgPSBsZW4xID0gMDsKICAgICAgICAgIGN1cnZlMCA9IFtdOwogICAgICAgICAgY3VydmUxID0gW107CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChkMCkgewogICAgICAgICAgICBjdXJ2ZTAucHVzaChwMCk7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKGQxKSB7CiAgICAgICAgICAgIGN1cnZlMS5wdXNoKHAxKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KCiAgICBkcmF3QXJlYShjdHgsIGN1cnZlMCwgY3VydmUxLCBsZW4wLCBsZW4xKTsKICAgIGN0eC5jbG9zZVBhdGgoKTsKICAgIGN0eC5maWxsU3R5bGUgPSBjb2xvcjsKICAgIGN0eC5maWxsKCk7CiAgfQoKICB2YXIgcGx1Z2luX2ZpbGxlciA9IHsKICAgIGlkOiAnZmlsbGVyJywKICAgIGFmdGVyRGF0YXNldHNVcGRhdGU6IGZ1bmN0aW9uIGFmdGVyRGF0YXNldHNVcGRhdGUoY2hhcnQsIG9wdGlvbnMpIHsKICAgICAgdmFyIGNvdW50ID0gKGNoYXJ0LmRhdGEuZGF0YXNldHMgfHwgW10pLmxlbmd0aDsKICAgICAgdmFyIHByb3BhZ2F0ZSA9IG9wdGlvbnMucHJvcGFnYXRlOwogICAgICB2YXIgc291cmNlcyA9IFtdOwogICAgICB2YXIgbWV0YSwgaSwgZWwsIHNvdXJjZTsKCiAgICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudDsgKytpKSB7CiAgICAgICAgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGkpOwogICAgICAgIGVsID0gbWV0YS5kYXRhc2V0OwogICAgICAgIHNvdXJjZSA9IG51bGw7CgogICAgICAgIGlmIChlbCAmJiBlbC5fbW9kZWwgJiYgZWwgaW5zdGFuY2VvZiBlbGVtZW50cy5MaW5lKSB7CiAgICAgICAgICBzb3VyY2UgPSB7CiAgICAgICAgICAgIHZpc2libGU6IGNoYXJ0LmlzRGF0YXNldFZpc2libGUoaSksCiAgICAgICAgICAgIGZpbGw6IGRlY29kZUZpbGwoZWwsIGksIGNvdW50KSwKICAgICAgICAgICAgY2hhcnQ6IGNoYXJ0LAogICAgICAgICAgICBlbDogZWwKICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBtZXRhLiRmaWxsZXIgPSBzb3VyY2U7CiAgICAgICAgc291cmNlcy5wdXNoKHNvdXJjZSk7CiAgICAgIH0KCiAgICAgIGZvciAoaSA9IDA7IGkgPCBjb3VudDsgKytpKSB7CiAgICAgICAgc291cmNlID0gc291cmNlc1tpXTsKCiAgICAgICAgaWYgKCFzb3VyY2UpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgc291cmNlLmZpbGwgPSByZXNvbHZlVGFyZ2V0KHNvdXJjZXMsIGksIHByb3BhZ2F0ZSk7CiAgICAgICAgc291cmNlLmJvdW5kYXJ5ID0gY29tcHV0ZUJvdW5kYXJ5KHNvdXJjZSk7CiAgICAgICAgc291cmNlLm1hcHBlciA9IGNyZWF0ZU1hcHBlcihzb3VyY2UpOwogICAgICB9CiAgICB9LAogICAgYmVmb3JlRGF0YXNldHNEcmF3OiBmdW5jdGlvbiBiZWZvcmVEYXRhc2V0c0RyYXcoY2hhcnQpIHsKICAgICAgdmFyIG1ldGFzZXRzID0gY2hhcnQuX2dldFNvcnRlZFZpc2libGVEYXRhc2V0TWV0YXMoKTsKCiAgICAgIHZhciBjdHggPSBjaGFydC5jdHg7CiAgICAgIHZhciBtZXRhLCBpLCBlbCwgdmlldywgcG9pbnRzLCBtYXBwZXIsIGNvbG9yOwoKICAgICAgZm9yIChpID0gbWV0YXNldHMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIHsKICAgICAgICBtZXRhID0gbWV0YXNldHNbaV0uJGZpbGxlcjsKCiAgICAgICAgaWYgKCFtZXRhIHx8ICFtZXRhLnZpc2libGUpIHsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgZWwgPSBtZXRhLmVsOwogICAgICAgIHZpZXcgPSBlbC5fdmlldzsKICAgICAgICBwb2ludHMgPSBlbC5fY2hpbGRyZW4gfHwgW107CiAgICAgICAgbWFwcGVyID0gbWV0YS5tYXBwZXI7CiAgICAgICAgY29sb3IgPSB2aWV3LmJhY2tncm91bmRDb2xvciB8fCBjb3JlX2RlZmF1bHRzLmdsb2JhbC5kZWZhdWx0Q29sb3I7CgogICAgICAgIGlmIChtYXBwZXIgJiYgY29sb3IgJiYgcG9pbnRzLmxlbmd0aCkgewogICAgICAgICAgaGVscGVycyQxLmNhbnZhcy5jbGlwQXJlYShjdHgsIGNoYXJ0LmNoYXJ0QXJlYSk7CiAgICAgICAgICBkb0ZpbGwoY3R4LCBwb2ludHMsIG1hcHBlciwgdmlldywgY29sb3IsIGVsLl9sb29wKTsKICAgICAgICAgIGhlbHBlcnMkMS5jYW52YXMudW5jbGlwQXJlYShjdHgpOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CiAgdmFyIGdldFJ0bEhlbHBlciQxID0gaGVscGVycyQxLnJ0bC5nZXRSdGxBZGFwdGVyOwogIHZhciBub29wJDEgPSBoZWxwZXJzJDEubm9vcDsKICB2YXIgdmFsdWVPckRlZmF1bHQkZSA9IGhlbHBlcnMkMS52YWx1ZU9yRGVmYXVsdDsKCiAgY29yZV9kZWZhdWx0cy5fc2V0KCdnbG9iYWwnLCB7CiAgICBsZWdlbmQ6IHsKICAgICAgZGlzcGxheTogdHJ1ZSwKICAgICAgcG9zaXRpb246ICd0b3AnLAogICAgICBhbGlnbjogJ2NlbnRlcicsCiAgICAgIGZ1bGxXaWR0aDogdHJ1ZSwKICAgICAgcmV2ZXJzZTogZmFsc2UsCiAgICAgIHdlaWdodDogMTAwMCwKICAgICAgLy8gYSBjYWxsYmFjayB0aGF0IHdpbGwgaGFuZGxlCiAgICAgIG9uQ2xpY2s6IGZ1bmN0aW9uIG9uQ2xpY2soZSwgbGVnZW5kSXRlbSkgewogICAgICAgIHZhciBpbmRleCA9IGxlZ2VuZEl0ZW0uZGF0YXNldEluZGV4OwogICAgICAgIHZhciBjaSA9IHRoaXMuY2hhcnQ7CiAgICAgICAgdmFyIG1ldGEgPSBjaS5nZXREYXRhc2V0TWV0YShpbmRleCk7IC8vIFNlZSBjb250cm9sbGVyLmlzRGF0YXNldFZpc2libGUgY29tbWVudAoKICAgICAgICBtZXRhLmhpZGRlbiA9IG1ldGEuaGlkZGVuID09PSBudWxsID8gIWNpLmRhdGEuZGF0YXNldHNbaW5kZXhdLmhpZGRlbiA6IG51bGw7IC8vIFdlIGhpZCBhIGRhdGFzZXQgLi4uIHJlcmVuZGVyIHRoZSBjaGFydAoKICAgICAgICBjaS51cGRhdGUoKTsKICAgICAgfSwKICAgICAgb25Ib3ZlcjogbnVsbCwKICAgICAgb25MZWF2ZTogbnVsbCwKICAgICAgbGFiZWxzOiB7CiAgICAgICAgYm94V2lkdGg6IDQwLAogICAgICAgIHBhZGRpbmc6IDEwLAogICAgICAgIC8vIEdlbmVyYXRlcyBsYWJlbHMgc2hvd24gaW4gdGhlIGxlZ2VuZAogICAgICAgIC8vIFZhbGlkIHByb3BlcnRpZXMgdG8gcmV0dXJuOgogICAgICAgIC8vIHRleHQgOiB0ZXh0IHRvIGRpc3BsYXkKICAgICAgICAvLyBmaWxsU3R5bGUgOiBmaWxsIG9mIGNvbG91cmVkIGJveAogICAgICAgIC8vIHN0cm9rZVN0eWxlOiBzdHJva2Ugb2YgY29sb3VyZWQgYm94CiAgICAgICAgLy8gaGlkZGVuIDogaWYgdGhpcyBsZWdlbmQgaXRlbSByZWZlcnMgdG8gYSBoaWRkZW4gaXRlbQogICAgICAgIC8vIGxpbmVDYXAgOiBjYXAgc3R5bGUgZm9yIGxpbmUKICAgICAgICAvLyBsaW5lRGFzaAogICAgICAgIC8vIGxpbmVEYXNoT2Zmc2V0IDoKICAgICAgICAvLyBsaW5lSm9pbiA6CiAgICAgICAgLy8gbGluZVdpZHRoIDoKICAgICAgICBnZW5lcmF0ZUxhYmVsczogZnVuY3Rpb24gZ2VuZXJhdGVMYWJlbHMoY2hhcnQpIHsKICAgICAgICAgIHZhciBkYXRhc2V0cyA9IGNoYXJ0LmRhdGEuZGF0YXNldHM7CiAgICAgICAgICB2YXIgb3B0aW9ucyA9IGNoYXJ0Lm9wdGlvbnMubGVnZW5kIHx8IHt9OwogICAgICAgICAgdmFyIHVzZVBvaW50U3R5bGUgPSBvcHRpb25zLmxhYmVscyAmJiBvcHRpb25zLmxhYmVscy51c2VQb2ludFN0eWxlOwogICAgICAgICAgcmV0dXJuIGNoYXJ0Ll9nZXRTb3J0ZWREYXRhc2V0TWV0YXMoKS5tYXAoZnVuY3Rpb24gKG1ldGEpIHsKICAgICAgICAgICAgdmFyIHN0eWxlID0gbWV0YS5jb250cm9sbGVyLmdldFN0eWxlKHVzZVBvaW50U3R5bGUgPyAwIDogdW5kZWZpbmVkKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICB0ZXh0OiBkYXRhc2V0c1ttZXRhLmluZGV4XS5sYWJlbCwKICAgICAgICAgICAgICBmaWxsU3R5bGU6IHN0eWxlLmJhY2tncm91bmRDb2xvciwKICAgICAgICAgICAgICBoaWRkZW46ICFjaGFydC5pc0RhdGFzZXRWaXNpYmxlKG1ldGEuaW5kZXgpLAogICAgICAgICAgICAgIGxpbmVDYXA6IHN0eWxlLmJvcmRlckNhcFN0eWxlLAogICAgICAgICAgICAgIGxpbmVEYXNoOiBzdHlsZS5ib3JkZXJEYXNoLAogICAgICAgICAgICAgIGxpbmVEYXNoT2Zmc2V0OiBzdHlsZS5ib3JkZXJEYXNoT2Zmc2V0LAogICAgICAgICAgICAgIGxpbmVKb2luOiBzdHlsZS5ib3JkZXJKb2luU3R5bGUsCiAgICAgICAgICAgICAgbGluZVdpZHRoOiBzdHlsZS5ib3JkZXJXaWR0aCwKICAgICAgICAgICAgICBzdHJva2VTdHlsZTogc3R5bGUuYm9yZGVyQ29sb3IsCiAgICAgICAgICAgICAgcG9pbnRTdHlsZTogc3R5bGUucG9pbnRTdHlsZSwKICAgICAgICAgICAgICByb3RhdGlvbjogc3R5bGUucm90YXRpb24sCiAgICAgICAgICAgICAgLy8gQmVsb3cgaXMgZXh0cmEgZGF0YSB1c2VkIGZvciB0b2dnbGluZyB0aGUgZGF0YXNldHMKICAgICAgICAgICAgICBkYXRhc2V0SW5kZXg6IG1ldGEuaW5kZXgKICAgICAgICAgICAgfTsKICAgICAgICAgIH0sIHRoaXMpOwogICAgICAgIH0KICAgICAgfQogICAgfSwKICAgIGxlZ2VuZENhbGxiYWNrOiBmdW5jdGlvbiBsZWdlbmRDYWxsYmFjayhjaGFydCkgewogICAgICB2YXIgbGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3VsJyk7CiAgICAgIHZhciBkYXRhc2V0cyA9IGNoYXJ0LmRhdGEuZGF0YXNldHM7CiAgICAgIHZhciBpLCBpbGVuLCBsaXN0SXRlbSwgbGlzdEl0ZW1TcGFuOwogICAgICBsaXN0LnNldEF0dHJpYnV0ZSgnY2xhc3MnLCBjaGFydC5pZCArICctbGVnZW5kJyk7CgogICAgICBmb3IgKGkgPSAwLCBpbGVuID0gZGF0YXNldHMubGVuZ3RoOyBpIDwgaWxlbjsgaSsrKSB7CiAgICAgICAgbGlzdEl0ZW0gPSBsaXN0LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJykpOwogICAgICAgIGxpc3RJdGVtU3BhbiA9IGxpc3RJdGVtLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKSk7CiAgICAgICAgbGlzdEl0ZW1TcGFuLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGRhdGFzZXRzW2ldLmJhY2tncm91bmRDb2xvcjsKCiAgICAgICAgaWYgKGRhdGFzZXRzW2ldLmxhYmVsKSB7CiAgICAgICAgICBsaXN0SXRlbS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShkYXRhc2V0c1tpXS5sYWJlbCkpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIGxpc3Qub3V0ZXJIVE1MOwogICAgfQogIH0pOwogIC8qKg0KICAgKiBIZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IHRoZSBib3ggd2lkdGggYmFzZWQgb24gdGhlIHVzZVBvaW50U3R5bGUgb3B0aW9uDQogICAqIEBwYXJhbSB7b2JqZWN0fSBsYWJlbG9wdHMgLSB0aGUgbGFiZWwgb3B0aW9ucyBvbiB0aGUgbGVnZW5kDQogICAqIEBwYXJhbSB7bnVtYmVyfSBmb250U2l6ZSAtIHRoZSBsYWJlbCBmb250IHNpemUNCiAgICogQHJldHVybiB7bnVtYmVyfSB3aWR0aCBvZiB0aGUgY29sb3IgYm94IGFyZWENCiAgICovCgoKICBmdW5jdGlvbiBnZXRCb3hXaWR0aChsYWJlbE9wdHMsIGZvbnRTaXplKSB7CiAgICByZXR1cm4gbGFiZWxPcHRzLnVzZVBvaW50U3R5bGUgJiYgbGFiZWxPcHRzLmJveFdpZHRoID4gZm9udFNpemUgPyBmb250U2l6ZSA6IGxhYmVsT3B0cy5ib3hXaWR0aDsKICB9CiAgLyoqDQogICAqIElNUE9SVEFOVDogdGhpcyBjbGFzcyBpcyBleHBvc2VkIHB1YmxpY2x5IGFzIENoYXJ0LkxlZ2VuZCwgYmFja3dhcmQgY29tcGF0aWJpbGl0eSByZXF1aXJlZCENCiAgICovCgoKICB2YXIgTGVnZW5kID0gY29yZV9lbGVtZW50LmV4dGVuZCh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiBpbml0aWFsaXplKGNvbmZpZykgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICBoZWxwZXJzJDEuZXh0ZW5kKG1lLCBjb25maWcpOyAvLyBDb250YWlucyBoaXQgYm94ZXMgZm9yIGVhY2ggZGF0YXNldCAoaW4gZGF0YXNldCBvcmRlcikKCiAgICAgIG1lLmxlZ2VuZEhpdEJveGVzID0gW107CiAgICAgIC8qKg0KICAgICAgCSAqIEBwcml2YXRlDQogICAgICAJICovCgogICAgICBtZS5faG92ZXJlZEl0ZW0gPSBudWxsOyAvLyBBcmUgd2UgaW4gZG91Z2hudXQgbW9kZSB3aGljaCBoYXMgYSBkaWZmZXJlbnQgZGF0YSB0eXBlCgogICAgICBtZS5kb3VnaG51dE1vZGUgPSBmYWxzZTsKICAgIH0sCiAgICAvLyBUaGVzZSBtZXRob2RzIGFyZSBvcmRlcmVkIGJ5IGxpZmVjeWNsZS4gVXRpbGl0aWVzIHRoZW4gZm9sbG93LgogICAgLy8gQW55IGZ1bmN0aW9uIGRlZmluZWQgaGVyZSBpcyBpbmhlcml0ZWQgYnkgYWxsIGxlZ2VuZCB0eXBlcy4KICAgIC8vIEFueSBmdW5jdGlvbiBjYW4gYmUgZXh0ZW5kZWQgYnkgdGhlIGxlZ2VuZCB0eXBlCiAgICBiZWZvcmVVcGRhdGU6IG5vb3AkMSwKICAgIHVwZGF0ZTogZnVuY3Rpb24gdXBkYXRlKG1heFdpZHRoLCBtYXhIZWlnaHQsIG1hcmdpbnMpIHsKICAgICAgdmFyIG1lID0gdGhpczsgLy8gVXBkYXRlIExpZmVjeWNsZSAtIFByb2JhYmx5IGRvbid0IHdhbnQgdG8gZXZlciBleHRlbmQgb3Igb3ZlcndyaXRlIHRoaXMgZnVuY3Rpb24gOykKCiAgICAgIG1lLmJlZm9yZVVwZGF0ZSgpOyAvLyBBYnNvcmIgdGhlIG1hc3RlciBtZWFzdXJlbWVudHMKCiAgICAgIG1lLm1heFdpZHRoID0gbWF4V2lkdGg7CiAgICAgIG1lLm1heEhlaWdodCA9IG1heEhlaWdodDsKICAgICAgbWUubWFyZ2lucyA9IG1hcmdpbnM7IC8vIERpbWVuc2lvbnMKCiAgICAgIG1lLmJlZm9yZVNldERpbWVuc2lvbnMoKTsKICAgICAgbWUuc2V0RGltZW5zaW9ucygpOwogICAgICBtZS5hZnRlclNldERpbWVuc2lvbnMoKTsgLy8gTGFiZWxzCgogICAgICBtZS5iZWZvcmVCdWlsZExhYmVscygpOwogICAgICBtZS5idWlsZExhYmVscygpOwogICAgICBtZS5hZnRlckJ1aWxkTGFiZWxzKCk7IC8vIEZpdAoKICAgICAgbWUuYmVmb3JlRml0KCk7CiAgICAgIG1lLmZpdCgpOwogICAgICBtZS5hZnRlckZpdCgpOyAvLwoKICAgICAgbWUuYWZ0ZXJVcGRhdGUoKTsKICAgICAgcmV0dXJuIG1lLm1pblNpemU7CiAgICB9LAogICAgYWZ0ZXJVcGRhdGU6IG5vb3AkMSwKICAgIC8vCiAgICBiZWZvcmVTZXREaW1lbnNpb25zOiBub29wJDEsCiAgICBzZXREaW1lbnNpb25zOiBmdW5jdGlvbiBzZXREaW1lbnNpb25zKCkgewogICAgICB2YXIgbWUgPSB0aGlzOyAvLyBTZXQgdGhlIHVuY29uc3RyYWluZWQgZGltZW5zaW9uIGJlZm9yZSBsYWJlbCByb3RhdGlvbgoKICAgICAgaWYgKG1lLmlzSG9yaXpvbnRhbCgpKSB7CiAgICAgICAgLy8gUmVzZXQgcG9zaXRpb24gYmVmb3JlIGNhbGN1bGF0aW5nIHJvdGF0aW9uCiAgICAgICAgbWUud2lkdGggPSBtZS5tYXhXaWR0aDsKICAgICAgICBtZS5sZWZ0ID0gMDsKICAgICAgICBtZS5yaWdodCA9IG1lLndpZHRoOwogICAgICB9IGVsc2UgewogICAgICAgIG1lLmhlaWdodCA9IG1lLm1heEhlaWdodDsgLy8gUmVzZXQgcG9zaXRpb24gYmVmb3JlIGNhbGN1bGF0aW5nIHJvdGF0aW9uCgogICAgICAgIG1lLnRvcCA9IDA7CiAgICAgICAgbWUuYm90dG9tID0gbWUuaGVpZ2h0OwogICAgICB9IC8vIFJlc2V0IHBhZGRpbmcKCgogICAgICBtZS5wYWRkaW5nTGVmdCA9IDA7CiAgICAgIG1lLnBhZGRpbmdUb3AgPSAwOwogICAgICBtZS5wYWRkaW5nUmlnaHQgPSAwOwogICAgICBtZS5wYWRkaW5nQm90dG9tID0gMDsgLy8gUmVzZXQgbWluU2l6ZQoKICAgICAgbWUubWluU2l6ZSA9IHsKICAgICAgICB3aWR0aDogMCwKICAgICAgICBoZWlnaHQ6IDAKICAgICAgfTsKICAgIH0sCiAgICBhZnRlclNldERpbWVuc2lvbnM6IG5vb3AkMSwKICAgIC8vCiAgICBiZWZvcmVCdWlsZExhYmVsczogbm9vcCQxLAogICAgYnVpbGRMYWJlbHM6IGZ1bmN0aW9uIGJ1aWxkTGFiZWxzKCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgbGFiZWxPcHRzID0gbWUub3B0aW9ucy5sYWJlbHMgfHwge307CiAgICAgIHZhciBsZWdlbmRJdGVtcyA9IGhlbHBlcnMkMS5jYWxsYmFjayhsYWJlbE9wdHMuZ2VuZXJhdGVMYWJlbHMsIFttZS5jaGFydF0sIG1lKSB8fCBbXTsKCiAgICAgIGlmIChsYWJlbE9wdHMuZmlsdGVyKSB7CiAgICAgICAgbGVnZW5kSXRlbXMgPSBsZWdlbmRJdGVtcy5maWx0ZXIoZnVuY3Rpb24gKGl0ZW0pIHsKICAgICAgICAgIHJldHVybiBsYWJlbE9wdHMuZmlsdGVyKGl0ZW0sIG1lLmNoYXJ0LmRhdGEpOwogICAgICAgIH0pOwogICAgICB9CgogICAgICBpZiAobWUub3B0aW9ucy5yZXZlcnNlKSB7CiAgICAgICAgbGVnZW5kSXRlbXMucmV2ZXJzZSgpOwogICAgICB9CgogICAgICBtZS5sZWdlbmRJdGVtcyA9IGxlZ2VuZEl0ZW1zOwogICAgfSwKICAgIGFmdGVyQnVpbGRMYWJlbHM6IG5vb3AkMSwKICAgIC8vCiAgICBiZWZvcmVGaXQ6IG5vb3AkMSwKICAgIGZpdDogZnVuY3Rpb24gZml0KCkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgb3B0cyA9IG1lLm9wdGlvbnM7CiAgICAgIHZhciBsYWJlbE9wdHMgPSBvcHRzLmxhYmVsczsKICAgICAgdmFyIGRpc3BsYXkgPSBvcHRzLmRpc3BsYXk7CiAgICAgIHZhciBjdHggPSBtZS5jdHg7CgogICAgICB2YXIgbGFiZWxGb250ID0gaGVscGVycyQxLm9wdGlvbnMuX3BhcnNlRm9udChsYWJlbE9wdHMpOwoKICAgICAgdmFyIGZvbnRTaXplID0gbGFiZWxGb250LnNpemU7IC8vIFJlc2V0IGhpdCBib3hlcwoKICAgICAgdmFyIGhpdGJveGVzID0gbWUubGVnZW5kSGl0Qm94ZXMgPSBbXTsKICAgICAgdmFyIG1pblNpemUgPSBtZS5taW5TaXplOwogICAgICB2YXIgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7CgogICAgICBpZiAoaXNIb3Jpem9udGFsKSB7CiAgICAgICAgbWluU2l6ZS53aWR0aCA9IG1lLm1heFdpZHRoOyAvLyBmaWxsIGFsbCB0aGUgd2lkdGgKCiAgICAgICAgbWluU2l6ZS5oZWlnaHQgPSBkaXNwbGF5ID8gMTAgOiAwOwogICAgICB9IGVsc2UgewogICAgICAgIG1pblNpemUud2lkdGggPSBkaXNwbGF5ID8gMTAgOiAwOwogICAgICAgIG1pblNpemUuaGVpZ2h0ID0gbWUubWF4SGVpZ2h0OyAvLyBmaWxsIGFsbCB0aGUgaGVpZ2h0CiAgICAgIH0gLy8gSW5jcmVhc2Ugc2l6ZXMgaGVyZQoKCiAgICAgIGlmICghZGlzcGxheSkgewogICAgICAgIG1lLndpZHRoID0gbWluU2l6ZS53aWR0aCA9IG1lLmhlaWdodCA9IG1pblNpemUuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGN0eC5mb250ID0gbGFiZWxGb250LnN0cmluZzsKCiAgICAgIGlmIChpc0hvcml6b250YWwpIHsKICAgICAgICAvLyBMYWJlbHMKICAgICAgICAvLyBXaWR0aCBvZiBlYWNoIGxpbmUgb2YgbGVnZW5kIGJveGVzLiBMYWJlbHMgd3JhcCBvbnRvIG11bHRpcGxlIGxpbmVzIHdoZW4gdGhlcmUgYXJlIHRvbyBtYW55IHRvIGZpdCBvbiBvbmUKICAgICAgICB2YXIgbGluZVdpZHRocyA9IG1lLmxpbmVXaWR0aHMgPSBbMF07CiAgICAgICAgdmFyIHRvdGFsSGVpZ2h0ID0gMDsKICAgICAgICBjdHgudGV4dEFsaWduID0gJ2xlZnQnOwogICAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAnbWlkZGxlJzsKICAgICAgICBoZWxwZXJzJDEuZWFjaChtZS5sZWdlbmRJdGVtcywgZnVuY3Rpb24gKGxlZ2VuZEl0ZW0sIGkpIHsKICAgICAgICAgIHZhciBib3hXaWR0aCA9IGdldEJveFdpZHRoKGxhYmVsT3B0cywgZm9udFNpemUpOwogICAgICAgICAgdmFyIHdpZHRoID0gYm94V2lkdGggKyBmb250U2l6ZSAvIDIgKyBjdHgubWVhc3VyZVRleHQobGVnZW5kSXRlbS50ZXh0KS53aWR0aDsKCiAgICAgICAgICBpZiAoaSA9PT0gMCB8fCBsaW5lV2lkdGhzW2xpbmVXaWR0aHMubGVuZ3RoIC0gMV0gKyB3aWR0aCArIDIgKiBsYWJlbE9wdHMucGFkZGluZyA+IG1pblNpemUud2lkdGgpIHsKICAgICAgICAgICAgdG90YWxIZWlnaHQgKz0gZm9udFNpemUgKyBsYWJlbE9wdHMucGFkZGluZzsKICAgICAgICAgICAgbGluZVdpZHRoc1tsaW5lV2lkdGhzLmxlbmd0aCAtIChpID4gMCA/IDAgOiAxKV0gPSAwOwogICAgICAgICAgfSAvLyBTdG9yZSB0aGUgaGl0Ym94IHdpZHRoIGFuZCBoZWlnaHQgaGVyZS4gRmluYWwgcG9zaXRpb24gd2lsbCBiZSB1cGRhdGVkIGluIGBkcmF3YAoKCiAgICAgICAgICBoaXRib3hlc1tpXSA9IHsKICAgICAgICAgICAgbGVmdDogMCwKICAgICAgICAgICAgdG9wOiAwLAogICAgICAgICAgICB3aWR0aDogd2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogZm9udFNpemUKICAgICAgICAgIH07CiAgICAgICAgICBsaW5lV2lkdGhzW2xpbmVXaWR0aHMubGVuZ3RoIC0gMV0gKz0gd2lkdGggKyBsYWJlbE9wdHMucGFkZGluZzsKICAgICAgICB9KTsKICAgICAgICBtaW5TaXplLmhlaWdodCArPSB0b3RhbEhlaWdodDsKICAgICAgfSBlbHNlIHsKICAgICAgICB2YXIgdlBhZGRpbmcgPSBsYWJlbE9wdHMucGFkZGluZzsKICAgICAgICB2YXIgY29sdW1uV2lkdGhzID0gbWUuY29sdW1uV2lkdGhzID0gW107CiAgICAgICAgdmFyIGNvbHVtbkhlaWdodHMgPSBtZS5jb2x1bW5IZWlnaHRzID0gW107CiAgICAgICAgdmFyIHRvdGFsV2lkdGggPSBsYWJlbE9wdHMucGFkZGluZzsKICAgICAgICB2YXIgY3VycmVudENvbFdpZHRoID0gMDsKICAgICAgICB2YXIgY3VycmVudENvbEhlaWdodCA9IDA7CiAgICAgICAgaGVscGVycyQxLmVhY2gobWUubGVnZW5kSXRlbXMsIGZ1bmN0aW9uIChsZWdlbmRJdGVtLCBpKSB7CiAgICAgICAgICB2YXIgYm94V2lkdGggPSBnZXRCb3hXaWR0aChsYWJlbE9wdHMsIGZvbnRTaXplKTsKICAgICAgICAgIHZhciBpdGVtV2lkdGggPSBib3hXaWR0aCArIGZvbnRTaXplIC8gMiArIGN0eC5tZWFzdXJlVGV4dChsZWdlbmRJdGVtLnRleHQpLndpZHRoOyAvLyBJZiB0b28gdGFsbCwgZ28gdG8gbmV3IGNvbHVtbgoKICAgICAgICAgIGlmIChpID4gMCAmJiBjdXJyZW50Q29sSGVpZ2h0ICsgZm9udFNpemUgKyAyICogdlBhZGRpbmcgPiBtaW5TaXplLmhlaWdodCkgewogICAgICAgICAgICB0b3RhbFdpZHRoICs9IGN1cnJlbnRDb2xXaWR0aCArIGxhYmVsT3B0cy5wYWRkaW5nOwogICAgICAgICAgICBjb2x1bW5XaWR0aHMucHVzaChjdXJyZW50Q29sV2lkdGgpOyAvLyBwcmV2aW91cyBjb2x1bW4gd2lkdGgKCiAgICAgICAgICAgIGNvbHVtbkhlaWdodHMucHVzaChjdXJyZW50Q29sSGVpZ2h0KTsKICAgICAgICAgICAgY3VycmVudENvbFdpZHRoID0gMDsKICAgICAgICAgICAgY3VycmVudENvbEhlaWdodCA9IDA7CiAgICAgICAgICB9IC8vIEdldCBtYXggd2lkdGgKCgogICAgICAgICAgY3VycmVudENvbFdpZHRoID0gTWF0aC5tYXgoY3VycmVudENvbFdpZHRoLCBpdGVtV2lkdGgpOwogICAgICAgICAgY3VycmVudENvbEhlaWdodCArPSBmb250U2l6ZSArIHZQYWRkaW5nOyAvLyBTdG9yZSB0aGUgaGl0Ym94IHdpZHRoIGFuZCBoZWlnaHQgaGVyZS4gRmluYWwgcG9zaXRpb24gd2lsbCBiZSB1cGRhdGVkIGluIGBkcmF3YAoKICAgICAgICAgIGhpdGJveGVzW2ldID0gewogICAgICAgICAgICBsZWZ0OiAwLAogICAgICAgICAgICB0b3A6IDAsCiAgICAgICAgICAgIHdpZHRoOiBpdGVtV2lkdGgsCiAgICAgICAgICAgIGhlaWdodDogZm9udFNpemUKICAgICAgICAgIH07CiAgICAgICAgfSk7CiAgICAgICAgdG90YWxXaWR0aCArPSBjdXJyZW50Q29sV2lkdGg7CiAgICAgICAgY29sdW1uV2lkdGhzLnB1c2goY3VycmVudENvbFdpZHRoKTsKICAgICAgICBjb2x1bW5IZWlnaHRzLnB1c2goY3VycmVudENvbEhlaWdodCk7CiAgICAgICAgbWluU2l6ZS53aWR0aCArPSB0b3RhbFdpZHRoOwogICAgICB9CgogICAgICBtZS53aWR0aCA9IG1pblNpemUud2lkdGg7CiAgICAgIG1lLmhlaWdodCA9IG1pblNpemUuaGVpZ2h0OwogICAgfSwKICAgIGFmdGVyRml0OiBub29wJDEsCiAgICAvLyBTaGFyZWQgTWV0aG9kcwogICAgaXNIb3Jpem9udGFsOiBmdW5jdGlvbiBpc0hvcml6b250YWwoKSB7CiAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMucG9zaXRpb24gPT09ICd0b3AnIHx8IHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gJ2JvdHRvbSc7CiAgICB9LAogICAgLy8gQWN0dWFsbHkgZHJhdyB0aGUgbGVnZW5kIG9uIHRoZSBjYW52YXMKICAgIGRyYXc6IGZ1bmN0aW9uIGRyYXcoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBvcHRzID0gbWUub3B0aW9uczsKICAgICAgdmFyIGxhYmVsT3B0cyA9IG9wdHMubGFiZWxzOwogICAgICB2YXIgZ2xvYmFsRGVmYXVsdHMgPSBjb3JlX2RlZmF1bHRzLmdsb2JhbDsKICAgICAgdmFyIGRlZmF1bHRDb2xvciA9IGdsb2JhbERlZmF1bHRzLmRlZmF1bHRDb2xvcjsKICAgICAgdmFyIGxpbmVEZWZhdWx0ID0gZ2xvYmFsRGVmYXVsdHMuZWxlbWVudHMubGluZTsKICAgICAgdmFyIGxlZ2VuZEhlaWdodCA9IG1lLmhlaWdodDsKICAgICAgdmFyIGNvbHVtbkhlaWdodHMgPSBtZS5jb2x1bW5IZWlnaHRzOwogICAgICB2YXIgbGVnZW5kV2lkdGggPSBtZS53aWR0aDsKICAgICAgdmFyIGxpbmVXaWR0aHMgPSBtZS5saW5lV2lkdGhzOwoKICAgICAgaWYgKCFvcHRzLmRpc3BsYXkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBydGxIZWxwZXIgPSBnZXRSdGxIZWxwZXIkMShvcHRzLnJ0bCwgbWUubGVmdCwgbWUubWluU2l6ZS53aWR0aCk7CiAgICAgIHZhciBjdHggPSBtZS5jdHg7CiAgICAgIHZhciBmb250Q29sb3IgPSB2YWx1ZU9yRGVmYXVsdCRlKGxhYmVsT3B0cy5mb250Q29sb3IsIGdsb2JhbERlZmF1bHRzLmRlZmF1bHRGb250Q29sb3IpOwoKICAgICAgdmFyIGxhYmVsRm9udCA9IGhlbHBlcnMkMS5vcHRpb25zLl9wYXJzZUZvbnQobGFiZWxPcHRzKTsKCiAgICAgIHZhciBmb250U2l6ZSA9IGxhYmVsRm9udC5zaXplOwogICAgICB2YXIgY3Vyc29yOyAvLyBDYW52YXMgc2V0dXAKCiAgICAgIGN0eC50ZXh0QWxpZ24gPSBydGxIZWxwZXIudGV4dEFsaWduKCdsZWZ0Jyk7CiAgICAgIGN0eC50ZXh0QmFzZWxpbmUgPSAnbWlkZGxlJzsKICAgICAgY3R4LmxpbmVXaWR0aCA9IDAuNTsKICAgICAgY3R4LnN0cm9rZVN0eWxlID0gZm9udENvbG9yOyAvLyBmb3Igc3RyaWtldGhyb3VnaCBlZmZlY3QKCiAgICAgIGN0eC5maWxsU3R5bGUgPSBmb250Q29sb3I7IC8vIHJlbmRlciBpbiBjb3JyZWN0IGNvbG91cgoKICAgICAgY3R4LmZvbnQgPSBsYWJlbEZvbnQuc3RyaW5nOwogICAgICB2YXIgYm94V2lkdGggPSBnZXRCb3hXaWR0aChsYWJlbE9wdHMsIGZvbnRTaXplKTsKICAgICAgdmFyIGhpdGJveGVzID0gbWUubGVnZW5kSGl0Qm94ZXM7IC8vIGN1cnJlbnQgcG9zaXRpb24KCiAgICAgIHZhciBkcmF3TGVnZW5kQm94ID0gZnVuY3Rpb24gZHJhd0xlZ2VuZEJveCh4LCB5LCBsZWdlbmRJdGVtKSB7CiAgICAgICAgaWYgKGlzTmFOKGJveFdpZHRoKSB8fCBib3hXaWR0aCA8PSAwKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfSAvLyBTZXQgdGhlIGN0eCBmb3IgdGhlIGJveAoKCiAgICAgICAgY3R4LnNhdmUoKTsKICAgICAgICB2YXIgbGluZVdpZHRoID0gdmFsdWVPckRlZmF1bHQkZShsZWdlbmRJdGVtLmxpbmVXaWR0aCwgbGluZURlZmF1bHQuYm9yZGVyV2lkdGgpOwogICAgICAgIGN0eC5maWxsU3R5bGUgPSB2YWx1ZU9yRGVmYXVsdCRlKGxlZ2VuZEl0ZW0uZmlsbFN0eWxlLCBkZWZhdWx0Q29sb3IpOwogICAgICAgIGN0eC5saW5lQ2FwID0gdmFsdWVPckRlZmF1bHQkZShsZWdlbmRJdGVtLmxpbmVDYXAsIGxpbmVEZWZhdWx0LmJvcmRlckNhcFN0eWxlKTsKICAgICAgICBjdHgubGluZURhc2hPZmZzZXQgPSB2YWx1ZU9yRGVmYXVsdCRlKGxlZ2VuZEl0ZW0ubGluZURhc2hPZmZzZXQsIGxpbmVEZWZhdWx0LmJvcmRlckRhc2hPZmZzZXQpOwogICAgICAgIGN0eC5saW5lSm9pbiA9IHZhbHVlT3JEZWZhdWx0JGUobGVnZW5kSXRlbS5saW5lSm9pbiwgbGluZURlZmF1bHQuYm9yZGVySm9pblN0eWxlKTsKICAgICAgICBjdHgubGluZVdpZHRoID0gbGluZVdpZHRoOwogICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IHZhbHVlT3JEZWZhdWx0JGUobGVnZW5kSXRlbS5zdHJva2VTdHlsZSwgZGVmYXVsdENvbG9yKTsKCiAgICAgICAgaWYgKGN0eC5zZXRMaW5lRGFzaCkgewogICAgICAgICAgLy8gSUUgOSBhbmQgMTAgZG8gbm90IHN1cHBvcnQgbGluZSBkYXNoCiAgICAgICAgICBjdHguc2V0TGluZURhc2godmFsdWVPckRlZmF1bHQkZShsZWdlbmRJdGVtLmxpbmVEYXNoLCBsaW5lRGVmYXVsdC5ib3JkZXJEYXNoKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAobGFiZWxPcHRzICYmIGxhYmVsT3B0cy51c2VQb2ludFN0eWxlKSB7CiAgICAgICAgICAvLyBSZWNhbGN1bGF0ZSB4IGFuZCB5IGZvciBkcmF3UG9pbnQoKSBiZWNhdXNlIGl0cyBleHBlY3RpbmcKICAgICAgICAgIC8vIHggYW5kIHkgdG8gYmUgY2VudGVyIG9mIGZpZ3VyZSAoaW5zdGVhZCBvZiB0b3AgbGVmdCkKICAgICAgICAgIHZhciByYWRpdXMgPSBib3hXaWR0aCAqIE1hdGguU1FSVDIgLyAyOwogICAgICAgICAgdmFyIGNlbnRlclggPSBydGxIZWxwZXIueFBsdXMoeCwgYm94V2lkdGggLyAyKTsKICAgICAgICAgIHZhciBjZW50ZXJZID0geSArIGZvbnRTaXplIC8gMjsgLy8gRHJhdyBwb2ludFN0eWxlIGFzIGxlZ2VuZCBzeW1ib2wKCiAgICAgICAgICBoZWxwZXJzJDEuY2FudmFzLmRyYXdQb2ludChjdHgsIGxlZ2VuZEl0ZW0ucG9pbnRTdHlsZSwgcmFkaXVzLCBjZW50ZXJYLCBjZW50ZXJZLCBsZWdlbmRJdGVtLnJvdGF0aW9uKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gRHJhdyBib3ggYXMgbGVnZW5kIHN5bWJvbAogICAgICAgICAgY3R4LmZpbGxSZWN0KHJ0bEhlbHBlci5sZWZ0Rm9yTHRyKHgsIGJveFdpZHRoKSwgeSwgYm94V2lkdGgsIGZvbnRTaXplKTsKCiAgICAgICAgICBpZiAobGluZVdpZHRoICE9PSAwKSB7CiAgICAgICAgICAgIGN0eC5zdHJva2VSZWN0KHJ0bEhlbHBlci5sZWZ0Rm9yTHRyKHgsIGJveFdpZHRoKSwgeSwgYm94V2lkdGgsIGZvbnRTaXplKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICAgIH07CgogICAgICB2YXIgZmlsbFRleHQgPSBmdW5jdGlvbiBmaWxsVGV4dCh4LCB5LCBsZWdlbmRJdGVtLCB0ZXh0V2lkdGgpIHsKICAgICAgICB2YXIgaGFsZkZvbnRTaXplID0gZm9udFNpemUgLyAyOwogICAgICAgIHZhciB4TGVmdCA9IHJ0bEhlbHBlci54UGx1cyh4LCBib3hXaWR0aCArIGhhbGZGb250U2l6ZSk7CiAgICAgICAgdmFyIHlNaWRkbGUgPSB5ICsgaGFsZkZvbnRTaXplOwogICAgICAgIGN0eC5maWxsVGV4dChsZWdlbmRJdGVtLnRleHQsIHhMZWZ0LCB5TWlkZGxlKTsKCiAgICAgICAgaWYgKGxlZ2VuZEl0ZW0uaGlkZGVuKSB7CiAgICAgICAgICAvLyBTdHJpa2V0aHJvdWdoIHRoZSB0ZXh0IGlmIGhpZGRlbgogICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOwogICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDI7CiAgICAgICAgICBjdHgubW92ZVRvKHhMZWZ0LCB5TWlkZGxlKTsKICAgICAgICAgIGN0eC5saW5lVG8ocnRsSGVscGVyLnhQbHVzKHhMZWZ0LCB0ZXh0V2lkdGgpLCB5TWlkZGxlKTsKICAgICAgICAgIGN0eC5zdHJva2UoKTsKICAgICAgICB9CiAgICAgIH07CgogICAgICB2YXIgYWxpZ25tZW50T2Zmc2V0ID0gZnVuY3Rpb24gYWxpZ25tZW50T2Zmc2V0KGRpbWVuc2lvbiwgYmxvY2tTaXplKSB7CiAgICAgICAgc3dpdGNoIChvcHRzLmFsaWduKSB7CiAgICAgICAgICBjYXNlICdzdGFydCc6CiAgICAgICAgICAgIHJldHVybiBsYWJlbE9wdHMucGFkZGluZzsKCiAgICAgICAgICBjYXNlICdlbmQnOgogICAgICAgICAgICByZXR1cm4gZGltZW5zaW9uIC0gYmxvY2tTaXplOwoKICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIC8vIGNlbnRlcgogICAgICAgICAgICByZXR1cm4gKGRpbWVuc2lvbiAtIGJsb2NrU2l6ZSArIGxhYmVsT3B0cy5wYWRkaW5nKSAvIDI7CiAgICAgICAgfQogICAgICB9OyAvLyBIb3Jpem9udGFsCgoKICAgICAgdmFyIGlzSG9yaXpvbnRhbCA9IG1lLmlzSG9yaXpvbnRhbCgpOwoKICAgICAgaWYgKGlzSG9yaXpvbnRhbCkgewogICAgICAgIGN1cnNvciA9IHsKICAgICAgICAgIHg6IG1lLmxlZnQgKyBhbGlnbm1lbnRPZmZzZXQobGVnZW5kV2lkdGgsIGxpbmVXaWR0aHNbMF0pLAogICAgICAgICAgeTogbWUudG9wICsgbGFiZWxPcHRzLnBhZGRpbmcsCiAgICAgICAgICBsaW5lOiAwCiAgICAgICAgfTsKICAgICAgfSBlbHNlIHsKICAgICAgICBjdXJzb3IgPSB7CiAgICAgICAgICB4OiBtZS5sZWZ0ICsgbGFiZWxPcHRzLnBhZGRpbmcsCiAgICAgICAgICB5OiBtZS50b3AgKyBhbGlnbm1lbnRPZmZzZXQobGVnZW5kSGVpZ2h0LCBjb2x1bW5IZWlnaHRzWzBdKSwKICAgICAgICAgIGxpbmU6IDAKICAgICAgICB9OwogICAgICB9CgogICAgICBoZWxwZXJzJDEucnRsLm92ZXJyaWRlVGV4dERpcmVjdGlvbihtZS5jdHgsIG9wdHMudGV4dERpcmVjdGlvbik7CiAgICAgIHZhciBpdGVtSGVpZ2h0ID0gZm9udFNpemUgKyBsYWJlbE9wdHMucGFkZGluZzsKICAgICAgaGVscGVycyQxLmVhY2gobWUubGVnZW5kSXRlbXMsIGZ1bmN0aW9uIChsZWdlbmRJdGVtLCBpKSB7CiAgICAgICAgdmFyIHRleHRXaWR0aCA9IGN0eC5tZWFzdXJlVGV4dChsZWdlbmRJdGVtLnRleHQpLndpZHRoOwogICAgICAgIHZhciB3aWR0aCA9IGJveFdpZHRoICsgZm9udFNpemUgLyAyICsgdGV4dFdpZHRoOwogICAgICAgIHZhciB4ID0gY3Vyc29yLng7CiAgICAgICAgdmFyIHkgPSBjdXJzb3IueTsKICAgICAgICBydGxIZWxwZXIuc2V0V2lkdGgobWUubWluU2l6ZS53aWR0aCk7IC8vIFVzZSAobWUubGVmdCArIG1lLm1pblNpemUud2lkdGgpIGFuZCAobWUudG9wICsgbWUubWluU2l6ZS5oZWlnaHQpCiAgICAgICAgLy8gaW5zdGVhZCBvZiBtZS5yaWdodCBhbmQgbWUuYm90dG9tIGJlY2F1c2UgbWUud2lkdGggYW5kIG1lLmhlaWdodAogICAgICAgIC8vIG1heSBoYXZlIGJlZW4gY2hhbmdlZCBzaW5jZSBtZS5taW5TaXplIHdhcyBjYWxjdWxhdGVkCgogICAgICAgIGlmIChpc0hvcml6b250YWwpIHsKICAgICAgICAgIGlmIChpID4gMCAmJiB4ICsgd2lkdGggKyBsYWJlbE9wdHMucGFkZGluZyA+IG1lLmxlZnQgKyBtZS5taW5TaXplLndpZHRoKSB7CiAgICAgICAgICAgIHkgPSBjdXJzb3IueSArPSBpdGVtSGVpZ2h0OwogICAgICAgICAgICBjdXJzb3IubGluZSsrOwogICAgICAgICAgICB4ID0gY3Vyc29yLnggPSBtZS5sZWZ0ICsgYWxpZ25tZW50T2Zmc2V0KGxlZ2VuZFdpZHRoLCBsaW5lV2lkdGhzW2N1cnNvci5saW5lXSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChpID4gMCAmJiB5ICsgaXRlbUhlaWdodCA+IG1lLnRvcCArIG1lLm1pblNpemUuaGVpZ2h0KSB7CiAgICAgICAgICB4ID0gY3Vyc29yLnggPSB4ICsgbWUuY29sdW1uV2lkdGhzW2N1cnNvci5saW5lXSArIGxhYmVsT3B0cy5wYWRkaW5nOwogICAgICAgICAgY3Vyc29yLmxpbmUrKzsKICAgICAgICAgIHkgPSBjdXJzb3IueSA9IG1lLnRvcCArIGFsaWdubWVudE9mZnNldChsZWdlbmRIZWlnaHQsIGNvbHVtbkhlaWdodHNbY3Vyc29yLmxpbmVdKTsKICAgICAgICB9CgogICAgICAgIHZhciByZWFsWCA9IHJ0bEhlbHBlci54KHgpOwogICAgICAgIGRyYXdMZWdlbmRCb3gocmVhbFgsIHksIGxlZ2VuZEl0ZW0pOwogICAgICAgIGhpdGJveGVzW2ldLmxlZnQgPSBydGxIZWxwZXIubGVmdEZvckx0cihyZWFsWCwgaGl0Ym94ZXNbaV0ud2lkdGgpOwogICAgICAgIGhpdGJveGVzW2ldLnRvcCA9IHk7IC8vIEZpbGwgdGhlIGFjdHVhbCBsYWJlbAoKICAgICAgICBmaWxsVGV4dChyZWFsWCwgeSwgbGVnZW5kSXRlbSwgdGV4dFdpZHRoKTsKCiAgICAgICAgaWYgKGlzSG9yaXpvbnRhbCkgewogICAgICAgICAgY3Vyc29yLnggKz0gd2lkdGggKyBsYWJlbE9wdHMucGFkZGluZzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3Vyc29yLnkgKz0gaXRlbUhlaWdodDsKICAgICAgICB9CiAgICAgIH0pOwogICAgICBoZWxwZXJzJDEucnRsLnJlc3RvcmVUZXh0RGlyZWN0aW9uKG1lLmN0eCwgb3B0cy50ZXh0RGlyZWN0aW9uKTsKICAgIH0sCgogICAgLyoqDQogICAgICogQHByaXZhdGUNCiAgICAgKi8KICAgIF9nZXRMZWdlbmRJdGVtQXQ6IGZ1bmN0aW9uIF9nZXRMZWdlbmRJdGVtQXQoeCwgeSkgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICB2YXIgaSwgaGl0Qm94LCBsaDsKCiAgICAgIGlmICh4ID49IG1lLmxlZnQgJiYgeCA8PSBtZS5yaWdodCAmJiB5ID49IG1lLnRvcCAmJiB5IDw9IG1lLmJvdHRvbSkgewogICAgICAgIC8vIFNlZSBpZiB3ZSBhcmUgdG91Y2hpbmcgb25lIG9mIHRoZSBkYXRhc2V0IGJveGVzCiAgICAgICAgbGggPSBtZS5sZWdlbmRIaXRCb3hlczsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGxoLmxlbmd0aDsgKytpKSB7CiAgICAgICAgICBoaXRCb3ggPSBsaFtpXTsKCiAgICAgICAgICBpZiAoeCA+PSBoaXRCb3gubGVmdCAmJiB4IDw9IGhpdEJveC5sZWZ0ICsgaGl0Qm94LndpZHRoICYmIHkgPj0gaGl0Qm94LnRvcCAmJiB5IDw9IGhpdEJveC50b3AgKyBoaXRCb3guaGVpZ2h0KSB7CiAgICAgICAgICAgIC8vIFRvdWNoaW5nIGFuIGVsZW1lbnQKICAgICAgICAgICAgcmV0dXJuIG1lLmxlZ2VuZEl0ZW1zW2ldOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIC8qKg0KICAgICAqIEhhbmRsZSBhbiBldmVudA0KICAgICAqIEBwcml2YXRlDQogICAgICogQHBhcmFtIHtJRXZlbnR9IGV2ZW50IC0gVGhlIGV2ZW50IHRvIGhhbmRsZQ0KICAgICAqLwogICAgaGFuZGxlRXZlbnQ6IGZ1bmN0aW9uIGhhbmRsZUV2ZW50KGUpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIG9wdHMgPSBtZS5vcHRpb25zOwogICAgICB2YXIgdHlwZSA9IGUudHlwZSA9PT0gJ21vdXNldXAnID8gJ2NsaWNrJyA6IGUudHlwZTsKICAgICAgdmFyIGhvdmVyZWRJdGVtOwoKICAgICAgaWYgKHR5cGUgPT09ICdtb3VzZW1vdmUnKSB7CiAgICAgICAgaWYgKCFvcHRzLm9uSG92ZXIgJiYgIW9wdHMub25MZWF2ZSkgewogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnY2xpY2snKSB7CiAgICAgICAgaWYgKCFvcHRzLm9uQ2xpY2spIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9IC8vIENoYXJ0IGV2ZW50IGFscmVhZHkgaGFzIHJlbGF0aXZlIHBvc2l0aW9uIGluIGl0CgoKICAgICAgaG92ZXJlZEl0ZW0gPSBtZS5fZ2V0TGVnZW5kSXRlbUF0KGUueCwgZS55KTsKCiAgICAgIGlmICh0eXBlID09PSAnY2xpY2snKSB7CiAgICAgICAgaWYgKGhvdmVyZWRJdGVtICYmIG9wdHMub25DbGljaykgewogICAgICAgICAgLy8gdXNlIGUubmF0aXZlIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eQogICAgICAgICAgb3B0cy5vbkNsaWNrLmNhbGwobWUsIGUubmF0aXZlLCBob3ZlcmVkSXRlbSk7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGlmIChvcHRzLm9uTGVhdmUgJiYgaG92ZXJlZEl0ZW0gIT09IG1lLl9ob3ZlcmVkSXRlbSkgewogICAgICAgICAgaWYgKG1lLl9ob3ZlcmVkSXRlbSkgewogICAgICAgICAgICBvcHRzLm9uTGVhdmUuY2FsbChtZSwgZS5uYXRpdmUsIG1lLl9ob3ZlcmVkSXRlbSk7CiAgICAgICAgICB9CgogICAgICAgICAgbWUuX2hvdmVyZWRJdGVtID0gaG92ZXJlZEl0ZW07CiAgICAgICAgfQoKICAgICAgICBpZiAob3B0cy5vbkhvdmVyICYmIGhvdmVyZWRJdGVtKSB7CiAgICAgICAgICAvLyB1c2UgZS5uYXRpdmUgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5CiAgICAgICAgICBvcHRzLm9uSG92ZXIuY2FsbChtZSwgZS5uYXRpdmUsIGhvdmVyZWRJdGVtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9KTsKCiAgZnVuY3Rpb24gY3JlYXRlTmV3TGVnZW5kQW5kQXR0YWNoKGNoYXJ0LCBsZWdlbmRPcHRzKSB7CiAgICB2YXIgbGVnZW5kID0gbmV3IExlZ2VuZCh7CiAgICAgIGN0eDogY2hhcnQuY3R4LAogICAgICBvcHRpb25zOiBsZWdlbmRPcHRzLAogICAgICBjaGFydDogY2hhcnQKICAgIH0pOwogICAgY29yZV9sYXlvdXRzLmNvbmZpZ3VyZShjaGFydCwgbGVnZW5kLCBsZWdlbmRPcHRzKTsKICAgIGNvcmVfbGF5b3V0cy5hZGRCb3goY2hhcnQsIGxlZ2VuZCk7CiAgICBjaGFydC5sZWdlbmQgPSBsZWdlbmQ7CiAgfQoKICB2YXIgcGx1Z2luX2xlZ2VuZCA9IHsKICAgIGlkOiAnbGVnZW5kJywKCiAgICAvKioNCiAgICAgKiBCYWNrd2FyZCBjb21wYXRpYmlsaXR5OiBzaW5jZSAyLjEuNSwgdGhlIGxlZ2VuZCBpcyByZWdpc3RlcmVkIGFzIGEgcGx1Z2luLCBtYWtpbmcNCiAgICAgKiBDaGFydC5MZWdlbmQgb2Jzb2xldGUuIFRvIGF2b2lkIGEgYnJlYWtpbmcgY2hhbmdlLCB3ZSBleHBvcnQgdGhlIExlZ2VuZCBhcyBwYXJ0IG9mDQogICAgICogdGhlIHBsdWdpbiwgd2hpY2ggb25lIHdpbGwgYmUgcmUtZXhwb3NlZCBpbiB0aGUgY2hhcnQuanMgZmlsZS4NCiAgICAgKiBodHRwczovL2dpdGh1Yi5jb20vY2hhcnRqcy9DaGFydC5qcy9wdWxsLzI2NDANCiAgICAgKiBAcHJpdmF0ZQ0KICAgICAqLwogICAgX2VsZW1lbnQ6IExlZ2VuZCwKICAgIGJlZm9yZUluaXQ6IGZ1bmN0aW9uIGJlZm9yZUluaXQoY2hhcnQpIHsKICAgICAgdmFyIGxlZ2VuZE9wdHMgPSBjaGFydC5vcHRpb25zLmxlZ2VuZDsKCiAgICAgIGlmIChsZWdlbmRPcHRzKSB7CiAgICAgICAgY3JlYXRlTmV3TGVnZW5kQW5kQXR0YWNoKGNoYXJ0LCBsZWdlbmRPcHRzKTsKICAgICAgfQogICAgfSwKICAgIGJlZm9yZVVwZGF0ZTogZnVuY3Rpb24gYmVmb3JlVXBkYXRlKGNoYXJ0KSB7CiAgICAgIHZhciBsZWdlbmRPcHRzID0gY2hhcnQub3B0aW9ucy5sZWdlbmQ7CiAgICAgIHZhciBsZWdlbmQgPSBjaGFydC5sZWdlbmQ7CgogICAgICBpZiAobGVnZW5kT3B0cykgewogICAgICAgIGhlbHBlcnMkMS5tZXJnZUlmKGxlZ2VuZE9wdHMsIGNvcmVfZGVmYXVsdHMuZ2xvYmFsLmxlZ2VuZCk7CgogICAgICAgIGlmIChsZWdlbmQpIHsKICAgICAgICAgIGNvcmVfbGF5b3V0cy5jb25maWd1cmUoY2hhcnQsIGxlZ2VuZCwgbGVnZW5kT3B0cyk7CiAgICAgICAgICBsZWdlbmQub3B0aW9ucyA9IGxlZ2VuZE9wdHM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNyZWF0ZU5ld0xlZ2VuZEFuZEF0dGFjaChjaGFydCwgbGVnZW5kT3B0cyk7CiAgICAgICAgfQogICAgICB9IGVsc2UgaWYgKGxlZ2VuZCkgewogICAgICAgIGNvcmVfbGF5b3V0cy5yZW1vdmVCb3goY2hhcnQsIGxlZ2VuZCk7CiAgICAgICAgZGVsZXRlIGNoYXJ0LmxlZ2VuZDsKICAgICAgfQogICAgfSwKICAgIGFmdGVyRXZlbnQ6IGZ1bmN0aW9uIGFmdGVyRXZlbnQoY2hhcnQsIGUpIHsKICAgICAgdmFyIGxlZ2VuZCA9IGNoYXJ0LmxlZ2VuZDsKCiAgICAgIGlmIChsZWdlbmQpIHsKICAgICAgICBsZWdlbmQuaGFuZGxlRXZlbnQoZSk7CiAgICAgIH0KICAgIH0KICB9OwogIHZhciBub29wJDIgPSBoZWxwZXJzJDEubm9vcDsKCiAgY29yZV9kZWZhdWx0cy5fc2V0KCdnbG9iYWwnLCB7CiAgICB0aXRsZTogewogICAgICBkaXNwbGF5OiBmYWxzZSwKICAgICAgZm9udFN0eWxlOiAnYm9sZCcsCiAgICAgIGZ1bGxXaWR0aDogdHJ1ZSwKICAgICAgcGFkZGluZzogMTAsCiAgICAgIHBvc2l0aW9uOiAndG9wJywKICAgICAgdGV4dDogJycsCiAgICAgIHdlaWdodDogMjAwMCAvLyBieSBkZWZhdWx0IGdyZWF0ZXIgdGhhbiBsZWdlbmQgKDEwMDApIHRvIGJlIGFib3ZlCgogICAgfQogIH0pOwogIC8qKg0KICAgKiBJTVBPUlRBTlQ6IHRoaXMgY2xhc3MgaXMgZXhwb3NlZCBwdWJsaWNseSBhcyBDaGFydC5MZWdlbmQsIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgcmVxdWlyZWQhDQogICAqLwoKCiAgdmFyIFRpdGxlID0gY29yZV9lbGVtZW50LmV4dGVuZCh7CiAgICBpbml0aWFsaXplOiBmdW5jdGlvbiBpbml0aWFsaXplKGNvbmZpZykgewogICAgICB2YXIgbWUgPSB0aGlzOwogICAgICBoZWxwZXJzJDEuZXh0ZW5kKG1lLCBjb25maWcpOyAvLyBDb250YWlucyBoaXQgYm94ZXMgZm9yIGVhY2ggZGF0YXNldCAoaW4gZGF0YXNldCBvcmRlcikKCiAgICAgIG1lLmxlZ2VuZEhpdEJveGVzID0gW107CiAgICB9LAogICAgLy8gVGhlc2UgbWV0aG9kcyBhcmUgb3JkZXJlZCBieSBsaWZlY3ljbGUuIFV0aWxpdGllcyB0aGVuIGZvbGxvdy4KICAgIGJlZm9yZVVwZGF0ZTogbm9vcCQyLAogICAgdXBkYXRlOiBmdW5jdGlvbiB1cGRhdGUobWF4V2lkdGgsIG1heEhlaWdodCwgbWFyZ2lucykgewogICAgICB2YXIgbWUgPSB0aGlzOyAvLyBVcGRhdGUgTGlmZWN5Y2xlIC0gUHJvYmFibHkgZG9uJ3Qgd2FudCB0byBldmVyIGV4dGVuZCBvciBvdmVyd3JpdGUgdGhpcyBmdW5jdGlvbiA7KQoKICAgICAgbWUuYmVmb3JlVXBkYXRlKCk7IC8vIEFic29yYiB0aGUgbWFzdGVyIG1lYXN1cmVtZW50cwoKICAgICAgbWUubWF4V2lkdGggPSBtYXhXaWR0aDsKICAgICAgbWUubWF4SGVpZ2h0ID0gbWF4SGVpZ2h0OwogICAgICBtZS5tYXJnaW5zID0gbWFyZ2luczsgLy8gRGltZW5zaW9ucwoKICAgICAgbWUuYmVmb3JlU2V0RGltZW5zaW9ucygpOwogICAgICBtZS5zZXREaW1lbnNpb25zKCk7CiAgICAgIG1lLmFmdGVyU2V0RGltZW5zaW9ucygpOyAvLyBMYWJlbHMKCiAgICAgIG1lLmJlZm9yZUJ1aWxkTGFiZWxzKCk7CiAgICAgIG1lLmJ1aWxkTGFiZWxzKCk7CiAgICAgIG1lLmFmdGVyQnVpbGRMYWJlbHMoKTsgLy8gRml0CgogICAgICBtZS5iZWZvcmVGaXQoKTsKICAgICAgbWUuZml0KCk7CiAgICAgIG1lLmFmdGVyRml0KCk7IC8vCgogICAgICBtZS5hZnRlclVwZGF0ZSgpOwogICAgICByZXR1cm4gbWUubWluU2l6ZTsKICAgIH0sCiAgICBhZnRlclVwZGF0ZTogbm9vcCQyLAogICAgLy8KICAgIGJlZm9yZVNldERpbWVuc2lvbnM6IG5vb3AkMiwKICAgIHNldERpbWVuc2lvbnM6IGZ1bmN0aW9uIHNldERpbWVuc2lvbnMoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7IC8vIFNldCB0aGUgdW5jb25zdHJhaW5lZCBkaW1lbnNpb24gYmVmb3JlIGxhYmVsIHJvdGF0aW9uCgogICAgICBpZiAobWUuaXNIb3Jpem9udGFsKCkpIHsKICAgICAgICAvLyBSZXNldCBwb3NpdGlvbiBiZWZvcmUgY2FsY3VsYXRpbmcgcm90YXRpb24KICAgICAgICBtZS53aWR0aCA9IG1lLm1heFdpZHRoOwogICAgICAgIG1lLmxlZnQgPSAwOwogICAgICAgIG1lLnJpZ2h0ID0gbWUud2lkdGg7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWUuaGVpZ2h0ID0gbWUubWF4SGVpZ2h0OyAvLyBSZXNldCBwb3NpdGlvbiBiZWZvcmUgY2FsY3VsYXRpbmcgcm90YXRpb24KCiAgICAgICAgbWUudG9wID0gMDsKICAgICAgICBtZS5ib3R0b20gPSBtZS5oZWlnaHQ7CiAgICAgIH0gLy8gUmVzZXQgcGFkZGluZwoKCiAgICAgIG1lLnBhZGRpbmdMZWZ0ID0gMDsKICAgICAgbWUucGFkZGluZ1RvcCA9IDA7CiAgICAgIG1lLnBhZGRpbmdSaWdodCA9IDA7CiAgICAgIG1lLnBhZGRpbmdCb3R0b20gPSAwOyAvLyBSZXNldCBtaW5TaXplCgogICAgICBtZS5taW5TaXplID0gewogICAgICAgIHdpZHRoOiAwLAogICAgICAgIGhlaWdodDogMAogICAgICB9OwogICAgfSwKICAgIGFmdGVyU2V0RGltZW5zaW9uczogbm9vcCQyLAogICAgLy8KICAgIGJlZm9yZUJ1aWxkTGFiZWxzOiBub29wJDIsCiAgICBidWlsZExhYmVsczogbm9vcCQyLAogICAgYWZ0ZXJCdWlsZExhYmVsczogbm9vcCQyLAogICAgLy8KICAgIGJlZm9yZUZpdDogbm9vcCQyLAogICAgZml0OiBmdW5jdGlvbiBmaXQoKSB7CiAgICAgIHZhciBtZSA9IHRoaXM7CiAgICAgIHZhciBvcHRzID0gbWUub3B0aW9uczsKICAgICAgdmFyIG1pblNpemUgPSBtZS5taW5TaXplID0ge307CiAgICAgIHZhciBpc0hvcml6b250YWwgPSBtZS5pc0hvcml6b250YWwoKTsKICAgICAgdmFyIGxpbmVDb3VudCwgdGV4dFNpemU7CgogICAgICBpZiAoIW9wdHMuZGlzcGxheSkgewogICAgICAgIG1lLndpZHRoID0gbWluU2l6ZS53aWR0aCA9IG1lLmhlaWdodCA9IG1pblNpemUuaGVpZ2h0ID0gMDsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIGxpbmVDb3VudCA9IGhlbHBlcnMkMS5pc0FycmF5KG9wdHMudGV4dCkgPyBvcHRzLnRleHQubGVuZ3RoIDogMTsKICAgICAgdGV4dFNpemUgPSBsaW5lQ291bnQgKiBoZWxwZXJzJDEub3B0aW9ucy5fcGFyc2VGb250KG9wdHMpLmxpbmVIZWlnaHQgKyBvcHRzLnBhZGRpbmcgKiAyOwogICAgICBtZS53aWR0aCA9IG1pblNpemUud2lkdGggPSBpc0hvcml6b250YWwgPyBtZS5tYXhXaWR0aCA6IHRleHRTaXplOwogICAgICBtZS5oZWlnaHQgPSBtaW5TaXplLmhlaWdodCA9IGlzSG9yaXpvbnRhbCA/IHRleHRTaXplIDogbWUubWF4SGVpZ2h0OwogICAgfSwKICAgIGFmdGVyRml0OiBub29wJDIsCiAgICAvLyBTaGFyZWQgTWV0aG9kcwogICAgaXNIb3Jpem9udGFsOiBmdW5jdGlvbiBpc0hvcml6b250YWwoKSB7CiAgICAgIHZhciBwb3MgPSB0aGlzLm9wdGlvbnMucG9zaXRpb247CiAgICAgIHJldHVybiBwb3MgPT09ICd0b3AnIHx8IHBvcyA9PT0gJ2JvdHRvbSc7CiAgICB9LAogICAgLy8gQWN0dWFsbHkgZHJhdyB0aGUgdGl0bGUgYmxvY2sgb24gdGhlIGNhbnZhcwogICAgZHJhdzogZnVuY3Rpb24gZHJhdygpIHsKICAgICAgdmFyIG1lID0gdGhpczsKICAgICAgdmFyIGN0eCA9IG1lLmN0eDsKICAgICAgdmFyIG9wdHMgPSBtZS5vcHRpb25zOwoKICAgICAgaWYgKCFvcHRzLmRpc3BsYXkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBmb250T3B0cyA9IGhlbHBlcnMkMS5vcHRpb25zLl9wYXJzZUZvbnQob3B0cyk7CgogICAgICB2YXIgbGluZUhlaWdodCA9IGZvbnRPcHRzLmxpbmVIZWlnaHQ7CiAgICAgIHZhciBvZmZzZXQgPSBsaW5lSGVpZ2h0IC8gMiArIG9wdHMucGFkZGluZzsKICAgICAgdmFyIHJvdGF0aW9uID0gMDsKICAgICAgdmFyIHRvcCA9IG1lLnRvcDsKICAgICAgdmFyIGxlZnQgPSBtZS5sZWZ0OwogICAgICB2YXIgYm90dG9tID0gbWUuYm90dG9tOwogICAgICB2YXIgcmlnaHQgPSBtZS5yaWdodDsKICAgICAgdmFyIG1heFdpZHRoLCB0aXRsZVgsIHRpdGxlWTsKICAgICAgY3R4LmZpbGxTdHlsZSA9IGhlbHBlcnMkMS52YWx1ZU9yRGVmYXVsdChvcHRzLmZvbnRDb2xvciwgY29yZV9kZWZhdWx0cy5nbG9iYWwuZGVmYXVsdEZvbnRDb2xvcik7IC8vIHJlbmRlciBpbiBjb3JyZWN0IGNvbG91cgoKICAgICAgY3R4LmZvbnQgPSBmb250T3B0cy5zdHJpbmc7IC8vIEhvcml6b250YWwKCiAgICAgIGlmIChtZS5pc0hvcml6b250YWwoKSkgewogICAgICAgIHRpdGxlWCA9IGxlZnQgKyAocmlnaHQgLSBsZWZ0KSAvIDI7IC8vIG1pZHBvaW50IG9mIHRoZSB3aWR0aAoKICAgICAgICB0aXRsZVkgPSB0b3AgKyBvZmZzZXQ7CiAgICAgICAgbWF4V2lkdGggPSByaWdodCAtIGxlZnQ7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGl0bGVYID0gb3B0cy5wb3NpdGlvbiA9PT0gJ2xlZnQnID8gbGVmdCArIG9mZnNldCA6IHJpZ2h0IC0gb2Zmc2V0OwogICAgICAgIHRpdGxlWSA9IHRvcCArIChib3R0b20gLSB0b3ApIC8gMjsKICAgICAgICBtYXhXaWR0aCA9IGJvdHRvbSAtIHRvcDsKICAgICAgICByb3RhdGlvbiA9IE1hdGguUEkgKiAob3B0cy5wb3NpdGlvbiA9PT0gJ2xlZnQnID8gLTAuNSA6IDAuNSk7CiAgICAgIH0KCiAgICAgIGN0eC5zYXZlKCk7CiAgICAgIGN0eC50cmFuc2xhdGUodGl0bGVYLCB0aXRsZVkpOwogICAgICBjdHgucm90YXRlKHJvdGF0aW9uKTsKICAgICAgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOwogICAgICBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7CiAgICAgIHZhciB0ZXh0ID0gb3B0cy50ZXh0OwoKICAgICAgaWYgKGhlbHBlcnMkMS5pc0FycmF5KHRleHQpKSB7CiAgICAgICAgdmFyIHkgPSAwOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRleHQubGVuZ3RoOyArK2kpIHsKICAgICAgICAgIGN0eC5maWxsVGV4dCh0ZXh0W2ldLCAwLCB5LCBtYXhXaWR0aCk7CiAgICAgICAgICB5ICs9IGxpbmVIZWlnaHQ7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGN0eC5maWxsVGV4dCh0ZXh0LCAwLCAwLCBtYXhXaWR0aCk7CiAgICAgIH0KCiAgICAgIGN0eC5yZXN0b3JlKCk7CiAgICB9CiAgfSk7CgogIGZ1bmN0aW9uIGNyZWF0ZU5ld1RpdGxlQmxvY2tBbmRBdHRhY2goY2hhcnQsIHRpdGxlT3B0cykgewogICAgdmFyIHRpdGxlID0gbmV3IFRpdGxlKHsKICAgICAgY3R4OiBjaGFydC5jdHgsCiAgICAgIG9wdGlvbnM6IHRpdGxlT3B0cywKICAgICAgY2hhcnQ6IGNoYXJ0CiAgICB9KTsKICAgIGNvcmVfbGF5b3V0cy5jb25maWd1cmUoY2hhcnQsIHRpdGxlLCB0aXRsZU9wdHMpOwogICAgY29yZV9sYXlvdXRzLmFkZEJveChjaGFydCwgdGl0bGUpOwogICAgY2hhcnQudGl0bGVCbG9jayA9IHRpdGxlOwogIH0KCiAgdmFyIHBsdWdpbl90aXRsZSA9IHsKICAgIGlkOiAndGl0bGUnLAoKICAgIC8qKg0KICAgICAqIEJhY2t3YXJkIGNvbXBhdGliaWxpdHk6IHNpbmNlIDIuMS41LCB0aGUgdGl0bGUgaXMgcmVnaXN0ZXJlZCBhcyBhIHBsdWdpbiwgbWFraW5nDQogICAgICogQ2hhcnQuVGl0bGUgb2Jzb2xldGUuIFRvIGF2b2lkIGEgYnJlYWtpbmcgY2hhbmdlLCB3ZSBleHBvcnQgdGhlIFRpdGxlIGFzIHBhcnQgb2YNCiAgICAgKiB0aGUgcGx1Z2luLCB3aGljaCBvbmUgd2lsbCBiZSByZS1leHBvc2VkIGluIHRoZSBjaGFydC5qcyBmaWxlLg0KICAgICAqIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFydGpzL0NoYXJ0LmpzL3B1bGwvMjY0MA0KICAgICAqIEBwcml2YXRlDQogICAgICovCiAgICBfZWxlbWVudDogVGl0bGUsCiAgICBiZWZvcmVJbml0OiBmdW5jdGlvbiBiZWZvcmVJbml0KGNoYXJ0KSB7CiAgICAgIHZhciB0aXRsZU9wdHMgPSBjaGFydC5vcHRpb25zLnRpdGxlOwoKICAgICAgaWYgKHRpdGxlT3B0cykgewogICAgICAgIGNyZWF0ZU5ld1RpdGxlQmxvY2tBbmRBdHRhY2goY2hhcnQsIHRpdGxlT3B0cyk7CiAgICAgIH0KICAgIH0sCiAgICBiZWZvcmVVcGRhdGU6IGZ1bmN0aW9uIGJlZm9yZVVwZGF0ZShjaGFydCkgewogICAgICB2YXIgdGl0bGVPcHRzID0gY2hhcnQub3B0aW9ucy50aXRsZTsKICAgICAgdmFyIHRpdGxlQmxvY2sgPSBjaGFydC50aXRsZUJsb2NrOwoKICAgICAgaWYgKHRpdGxlT3B0cykgewogICAgICAgIGhlbHBlcnMkMS5tZXJnZUlmKHRpdGxlT3B0cywgY29yZV9kZWZhdWx0cy5nbG9iYWwudGl0bGUpOwoKICAgICAgICBpZiAodGl0bGVCbG9jaykgewogICAgICAgICAgY29yZV9sYXlvdXRzLmNvbmZpZ3VyZShjaGFydCwgdGl0bGVCbG9jaywgdGl0bGVPcHRzKTsKICAgICAgICAgIHRpdGxlQmxvY2sub3B0aW9ucyA9IHRpdGxlT3B0czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY3JlYXRlTmV3VGl0bGVCbG9ja0FuZEF0dGFjaChjaGFydCwgdGl0bGVPcHRzKTsKICAgICAgICB9CiAgICAgIH0gZWxzZSBpZiAodGl0bGVCbG9jaykgewogICAgICAgIGNvcmVfbGF5b3V0cy5yZW1vdmVCb3goY2hhcnQsIHRpdGxlQmxvY2spOwogICAgICAgIGRlbGV0ZSBjaGFydC50aXRsZUJsb2NrOwogICAgICB9CiAgICB9CiAgfTsKICB2YXIgcGx1Z2lucyA9IHt9OwogIHZhciBmaWxsZXIgPSBwbHVnaW5fZmlsbGVyOwogIHZhciBsZWdlbmQgPSBwbHVnaW5fbGVnZW5kOwogIHZhciB0aXRsZSA9IHBsdWdpbl90aXRsZTsKICBwbHVnaW5zLmZpbGxlciA9IGZpbGxlcjsKICBwbHVnaW5zLmxlZ2VuZCA9IGxlZ2VuZDsKICBwbHVnaW5zLnRpdGxlID0gdGl0bGU7CiAgLyoqDQogICAqIEBuYW1lc3BhY2UgQ2hhcnQNCiAgICovCgogIGNvcmVfY29udHJvbGxlci5oZWxwZXJzID0gaGVscGVycyQxOyAvLyBAdG9kbyBkaXNwYXRjaCB0aGVzZSBoZWxwZXJzIGludG8gYXBwcm9wcmlhdGVkIGhlbHBlcnMvaGVscGVycy4qIGZpbGUgYW5kIHdyaXRlIHVuaXQgdGVzdHMhCgogIGNvcmVfaGVscGVycygpOwogIGNvcmVfY29udHJvbGxlci5fYWRhcHRlcnMgPSBjb3JlX2FkYXB0ZXJzOwogIGNvcmVfY29udHJvbGxlci5BbmltYXRpb24gPSBjb3JlX2FuaW1hdGlvbjsKICBjb3JlX2NvbnRyb2xsZXIuYW5pbWF0aW9uU2VydmljZSA9IGNvcmVfYW5pbWF0aW9uczsKICBjb3JlX2NvbnRyb2xsZXIuY29udHJvbGxlcnMgPSBjb250cm9sbGVyczsKICBjb3JlX2NvbnRyb2xsZXIuRGF0YXNldENvbnRyb2xsZXIgPSBjb3JlX2RhdGFzZXRDb250cm9sbGVyOwogIGNvcmVfY29udHJvbGxlci5kZWZhdWx0cyA9IGNvcmVfZGVmYXVsdHM7CiAgY29yZV9jb250cm9sbGVyLkVsZW1lbnQgPSBjb3JlX2VsZW1lbnQ7CiAgY29yZV9jb250cm9sbGVyLmVsZW1lbnRzID0gZWxlbWVudHM7CiAgY29yZV9jb250cm9sbGVyLkludGVyYWN0aW9uID0gY29yZV9pbnRlcmFjdGlvbjsKICBjb3JlX2NvbnRyb2xsZXIubGF5b3V0cyA9IGNvcmVfbGF5b3V0czsKICBjb3JlX2NvbnRyb2xsZXIucGxhdGZvcm0gPSBwbGF0Zm9ybTsKICBjb3JlX2NvbnRyb2xsZXIucGx1Z2lucyA9IGNvcmVfcGx1Z2luczsKICBjb3JlX2NvbnRyb2xsZXIuU2NhbGUgPSBjb3JlX3NjYWxlOwogIGNvcmVfY29udHJvbGxlci5zY2FsZVNlcnZpY2UgPSBjb3JlX3NjYWxlU2VydmljZTsKICBjb3JlX2NvbnRyb2xsZXIuVGlja3MgPSBjb3JlX3RpY2tzOwogIGNvcmVfY29udHJvbGxlci5Ub29sdGlwID0gY29yZV90b29sdGlwOyAvLyBSZWdpc3RlciBidWlsdC1pbiBzY2FsZXMKCiAgY29yZV9jb250cm9sbGVyLmhlbHBlcnMuZWFjaChzY2FsZXMsIGZ1bmN0aW9uIChzY2FsZSwgdHlwZSkgewogICAgY29yZV9jb250cm9sbGVyLnNjYWxlU2VydmljZS5yZWdpc3RlclNjYWxlVHlwZSh0eXBlLCBzY2FsZSwgc2NhbGUuX2RlZmF1bHRzKTsKICB9KTsgLy8gTG9hZCB0byByZWdpc3RlciBidWlsdC1pbiBhZGFwdGVycyAoYXMgc2lkZSBlZmZlY3RzKQogIC8vIExvYWRpbmcgYnVpbHQtaW4gcGx1Z2lucwoKICBmb3IgKHZhciBrIGluIHBsdWdpbnMpIHsKICAgIGlmIChwbHVnaW5zLmhhc093blByb3BlcnR5KGspKSB7CiAgICAgIGNvcmVfY29udHJvbGxlci5wbHVnaW5zLnJlZ2lzdGVyKHBsdWdpbnNba10pOwogICAgfQogIH0KCiAgY29yZV9jb250cm9sbGVyLnBsYXRmb3JtLmluaXRpYWxpemUoKTsKICB2YXIgc3JjID0gY29yZV9jb250cm9sbGVyOwoKICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgIHdpbmRvdy5DaGFydCA9IGNvcmVfY29udHJvbGxlcjsKICB9IC8vIERFUFJFQ0FUSU9OUwoKICAvKioNCiAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIG5vdCBhdmFpbGFibGUgYW55bW9yZQ0KICAgKiBAbmFtZXNwYWNlIENoYXJ0LkNoYXJ0DQogICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi44LjANCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCgogIGNvcmVfY29udHJvbGxlci5DaGFydCA9IGNvcmVfY29udHJvbGxlcjsKICAvKioNCiAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIG5vdCBhdmFpbGFibGUgYW55bW9yZQ0KICAgKiBAbmFtZXNwYWNlIENoYXJ0LkxlZ2VuZA0KICAgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuMS41DQogICAqIEB0b2RvIHJlbW92ZSBhdCB2ZXJzaW9uIDMNCiAgICogQHByaXZhdGUNCiAgICovCgogIGNvcmVfY29udHJvbGxlci5MZWdlbmQgPSBwbHVnaW5zLmxlZ2VuZC5fZWxlbWVudDsKICAvKioNCiAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIG5vdCBhdmFpbGFibGUgYW55bW9yZQ0KICAgKiBAbmFtZXNwYWNlIENoYXJ0LlRpdGxlDQogICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi4xLjUNCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCiAgY29yZV9jb250cm9sbGVyLlRpdGxlID0gcGx1Z2lucy50aXRsZS5fZWxlbWVudDsKICAvKioNCiAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIHVzZSBDaGFydC5wbHVnaW5zIGluc3RlYWQNCiAgICogQG5hbWVzcGFjZSBDaGFydC5wbHVnaW5TZXJ2aWNlDQogICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi4xLjUNCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCiAgY29yZV9jb250cm9sbGVyLnBsdWdpblNlcnZpY2UgPSBjb3JlX2NvbnRyb2xsZXIucGx1Z2luczsKICAvKioNCiAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIGluaGVyaXRpbmcgZnJvbSBDaGFydC5QbHVnaW5nQmFzZSBoYXMgbm8NCiAgICogZWZmZWN0LCBpbnN0ZWFkIHNpbXBseSBjcmVhdGUvcmVnaXN0ZXIgcGx1Z2lucyB2aWEgcGxhaW4gSmF2YVNjcmlwdCBvYmplY3RzLg0KICAgKiBAaW50ZXJmYWNlIENoYXJ0LlBsdWdpbkJhc2UNCiAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjUuMA0KICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAqIEBwcml2YXRlDQogICAqLwoKICBjb3JlX2NvbnRyb2xsZXIuUGx1Z2luQmFzZSA9IGNvcmVfY29udHJvbGxlci5FbGVtZW50LmV4dGVuZCh7fSk7CiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQ2hhcnQuaGVscGVycy5jYW52YXMgaW5zdGVhZC4NCiAgICogQG5hbWVzcGFjZSBDaGFydC5jYW52YXNIZWxwZXJzDQogICAqIEBkZXByZWNhdGVkIHNpbmNlIHZlcnNpb24gMi42LjANCiAgICogQHRvZG8gcmVtb3ZlIGF0IHZlcnNpb24gMw0KICAgKiBAcHJpdmF0ZQ0KICAgKi8KCiAgY29yZV9jb250cm9sbGVyLmNhbnZhc0hlbHBlcnMgPSBjb3JlX2NvbnRyb2xsZXIuaGVscGVycy5jYW52YXM7CiAgLyoqDQogICAqIFByb3ZpZGVkIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5LCB1c2UgQ2hhcnQubGF5b3V0cyBpbnN0ZWFkLg0KICAgKiBAbmFtZXNwYWNlIENoYXJ0LmxheW91dFNlcnZpY2UNCiAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjcuMw0KICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAqIEBwcml2YXRlDQogICAqLwoKICBjb3JlX2NvbnRyb2xsZXIubGF5b3V0U2VydmljZSA9IGNvcmVfY29udHJvbGxlci5sYXlvdXRzOwogIC8qKg0KICAgKiBQcm92aWRlZCBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSwgbm90IGF2YWlsYWJsZSBhbnltb3JlLg0KICAgKiBAbmFtZXNwYWNlIENoYXJ0LkxpbmVhclNjYWxlQmFzZQ0KICAgKiBAZGVwcmVjYXRlZCBzaW5jZSB2ZXJzaW9uIDIuOA0KICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAqIEBwcml2YXRlDQogICAqLwoKICBjb3JlX2NvbnRyb2xsZXIuTGluZWFyU2NhbGVCYXNlID0gc2NhbGVfbGluZWFyYmFzZTsKICAvKioNCiAgICogUHJvdmlkZWQgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHksIGluc3RlYWQgd2Ugc2hvdWxkIGNyZWF0ZSBhIG5ldyBDaGFydA0KICAgKiBieSBzZXR0aW5nIHRoZSB0eXBlIGluIHRoZSBjb25maWcgKGBuZXcgQ2hhcnQoaWQsIHt0eXBlOiAne2NoYXJ0LXR5cGV9J31gKS4NCiAgICogQGRlcHJlY2F0ZWQgc2luY2UgdmVyc2lvbiAyLjguMA0KICAgKiBAdG9kbyByZW1vdmUgYXQgdmVyc2lvbiAzDQogICAqLwoKICBjb3JlX2NvbnRyb2xsZXIuaGVscGVycy5lYWNoKFsnQmFyJywgJ0J1YmJsZScsICdEb3VnaG51dCcsICdMaW5lJywgJ1BvbGFyQXJlYScsICdSYWRhcicsICdTY2F0dGVyJ10sIGZ1bmN0aW9uIChrbGFzcykgewogICAgY29yZV9jb250cm9sbGVyW2tsYXNzXSA9IGZ1bmN0aW9uIChjdHgsIGNmZykgewogICAgICByZXR1cm4gbmV3IGNvcmVfY29udHJvbGxlcihjdHgsIGNvcmVfY29udHJvbGxlci5oZWxwZXJzLm1lcmdlKGNmZyB8fCB7fSwgewogICAgICAgIHR5cGU6IGtsYXNzLmNoYXJBdCgwKS50b0xvd2VyQ2FzZSgpICsga2xhc3Muc2xpY2UoMSkKICAgICAgfSkpOwogICAgfTsKICB9KTsKICByZXR1cm4gc3JjOwp9KTs="},null]}